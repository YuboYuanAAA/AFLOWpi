

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>prep &mdash; AFLOWpi  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="AFLOWpi  documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> AFLOWpi
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plot.html">plot module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prep.html">prep module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pseudo.html">pseudo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../retr.html">retr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run.html">run module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scfuj.html">scfuj module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AFLOWpi</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>prep</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for prep</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">numpy</span>


<span class="k">def</span> <span class="nf">_gen_nosym_kgrid</span><span class="p">(</span><span class="n">nk1</span><span class="p">,</span><span class="n">nk2</span><span class="p">,</span><span class="n">nk3</span><span class="p">,</span><span class="n">sk1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sk2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sk3</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">as_string</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">shift1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">nk1</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">sk1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">shift2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">nk2</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">sk2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">shift3</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">nk3</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">sk3</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">kdist1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">nk1</span>
    <span class="n">kdist2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">nk2</span>
    <span class="n">kdist3</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">nk3</span>

    <span class="n">tot</span> <span class="o">=</span> <span class="n">nk1</span><span class="o">*</span><span class="n">nk2</span><span class="o">*</span><span class="n">nk3</span>
    <span class="n">nk_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tot</span>
<span class="c1">#    if shift_gamma==True:</span>
<span class="c1">#        shift1-=0.5</span>
<span class="c1">#        shift2-=0.5</span>
<span class="c1">#        shift3-=0.5</span>
    <span class="k">if</span> <span class="n">as_string</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk3</span><span class="p">):</span>
                    <span class="n">nk_str</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%8.8f</span><span class="s1"> </span><span class="si">%8.8f</span><span class="s1"> </span><span class="si">%8.8f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">kdist1</span><span class="o">+</span><span class="n">shift1</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">kdist2</span><span class="o">+</span><span class="n">shift2</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">kdist3</span><span class="o">+</span><span class="n">shift3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nk_str</span><span class="o">=</span><span class="p">[]</span><span class="c1">#numpy.zeros([tot,3])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk3</span><span class="p">):</span>
                    <span class="n">nk_str</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">kdist1</span><span class="o">+</span><span class="n">shift1</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">kdist2</span><span class="o">+</span><span class="n">shift2</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">kdist3</span><span class="o">+</span><span class="n">shift3</span><span class="p">])</span>
    <span class="n">nk_str</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nk_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nk_str</span>









<span class="kn">import</span> <span class="nn">AFLOWpi</span>

<span class="k">def</span> <span class="nf">_get_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">step_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">last</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">step_type</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_WORKFLOW_&#39;</span><span class="p">]</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>


    <span class="k">try</span><span class="p">:</span>

        <span class="n">chain_index</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>


        <span class="n">occ_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">current_step_type</span><span class="o">=</span><span class="n">workflow</span><span class="p">[</span><span class="n">chain_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">chain_index</span><span class="p">)):</span>

            <span class="k">if</span> <span class="n">workflow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">step_type</span><span class="p">:</span>


                <span class="n">occ_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">occ_list</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">occ_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">e</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
        


<span class="kn">import</span> <span class="nn">numpy</span>





<span class="k">def</span> <span class="nf">_return_ID</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">step_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">straight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_get_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">step_type</span><span class="o">=</span><span class="n">step_type</span><span class="p">,</span><span class="n">last</span><span class="o">=</span><span class="n">last</span><span class="p">)</span>
    
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">prefix_first</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>



    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]):</span>



        <span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">splits</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">chain_ind_list</span><span class="o">=</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">straight</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">step_ID</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">prefix_first</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chain_ind_list</span><span class="p">]</span>
<span class="c1">#                print step_type,step_ID</span>
                <span class="k">return</span> <span class="n">step_ID</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step_ID</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">prefix_first</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chain_ind_list</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#                print step_type,step_ID</span>
                <span class="k">return</span> <span class="n">step_ID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">straight</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">step_ID</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">prefix_first</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>
<span class="c1">#                print step_type,step_ID</span>
                <span class="k">return</span> <span class="n">step_ID</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step_ID</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">prefix_first</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="c1">#                print step_type,step_ID</span>
                <span class="k">return</span> <span class="n">step_ID</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">__main__</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">glob</span> 
<span class="kn">import</span> <span class="nn">sys</span> 
<span class="kn">import</span> <span class="nn">re</span>


<span class="k">def</span> <span class="nf">_add_subset_to_daemon_log_list</span><span class="p">(</span><span class="n">addition_list</span><span class="p">,</span><span class="n">log_name</span><span class="p">):</span>
    <span class="k">if</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;daemon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submit_log_append</span><span class="p">(</span><span class="n">addition_list</span><span class="p">,</span><span class="n">log_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_one_test_build</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">build_command</span><span class="p">,</span><span class="n">subset_name</span><span class="o">=</span><span class="s1">&#39;SUBSET&#39;</span><span class="p">,</span><span class="n">merge_oneCalc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">keep_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clean_input</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span>

    <span class="n">intoInit</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;PROJECT&#39;</span><span class="p">:</span><span class="n">subset_name</span><span class="p">,</span><span class="s1">&#39;SET&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;workdir&#39;</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;config&#39;</span><span class="p">:</span><span class="n">config</span><span class="p">}</span>
    <span class="n">fake_session_keys</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="o">**</span><span class="n">intoInit</span><span class="p">)</span>

    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;input_strings=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">build_command</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">merge_oneCalc</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">varied_calcs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">calcFromFile</span><span class="p">(</span><span class="n">fake_session_keys</span><span class="p">,</span><span class="n">input_strings</span><span class="p">,</span><span class="n">reffile</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">],</span><span class="n">workdir</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">keep_name</span><span class="o">=</span><span class="n">keep_name</span><span class="p">,</span><span class="n">clean_input</span><span class="o">=</span><span class="n">clean_input</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">varied_calcs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">calcFromFile</span><span class="p">(</span><span class="n">fake_session_keys</span><span class="p">,</span><span class="n">input_strings</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">keep_name</span><span class="o">=</span><span class="n">keep_name</span><span class="p">,</span><span class="n">clean_input</span><span class="o">=</span><span class="n">clean_input</span><span class="p">)</span>
    

    <span class="k">return</span> <span class="n">varied_calcs</span>
<span class="c1">###############################################################################################################</span>

<span class="c1">###############################################################################################################</span>

<div class="viewcode-block" id="prep_split_step"><a class="viewcode-back" href="../prep.html#prep.prep_split_step">[docs]</a><span class="k">def</span> <span class="nf">prep_split_step</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">subset_creator</span><span class="p">,</span><span class="n">subset_tasks</span><span class="o">=</span><span class="p">[],</span><span class="n">mult_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">substep_name</span><span class="o">=</span><span class="s1">&#39;SUBSET&#39;</span><span class="p">,</span><span class="n">keep_file_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">clean_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">check_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fault_tolerant</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>



<span class="c1">#####################################################################</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_skeletonRun</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">check_function</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">check_function</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">check_function</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

		<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__splitCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

		<span class="n">execString</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;if oneCalc[&#39;__execCounter__&#39;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span>
		<span class="n">execString</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">     oneCalc,ID = AFLOWpi.prep.construct_and_run(__submitNodeName__,oneCalc,ID,build_command=&quot;&quot;&quot;</span><span class="si">%s</span><span class="s1">&quot;&quot;&quot;,subset_tasks=</span><span class="si">%s</span><span class="s1">,mult_jobs=</span><span class="si">%s</span><span class="s1">,subset_name=&#39;</span><span class="si">%s</span><span class="s1">&#39;,keep_file_names=</span><span class="si">%s</span><span class="s1">,clean_input=</span><span class="si">%s</span><span class="s1">,check_function=</span><span class="si">%s</span><span class="s1">,fault_tolerant=</span><span class="si">%s</span><span class="s1">)</span>

<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subset_creator</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">subset_tasks</span><span class="p">),</span><span class="n">mult_jobs</span><span class="p">,</span><span class="n">substep_name</span><span class="p">,</span><span class="n">keep_file_names</span><span class="p">,</span><span class="n">clean_input</span><span class="p">,</span><span class="n">check_function</span><span class="p">,</span><span class="n">fault_tolerant</span><span class="p">)</span>  
<span class="c1">#&#39;&#39;&#39; % (subset_creator,exit_command,repr(subset_tasks),mult_jobs)  </span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span> <span class="n">execString</span><span class="p">)</span>
<span class="c1">#####################################################################                </span>

        
        <span class="k">return</span> <span class="n">calcs</span></div>

<span class="c1">#####################################################################################################################</span>




<span class="c1">########################################################################################################################################################################################################################################</span>

<div class="viewcode-block" id="construct_and_run"><a class="viewcode-back" href="../prep.html#prep.construct_and_run">[docs]</a><span class="k">def</span> <span class="nf">construct_and_run</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">build_command</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">subset_tasks</span><span class="o">=</span><span class="p">[],</span><span class="n">fault_tolerant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">subset_name</span><span class="o">=</span><span class="s1">&#39;SUBSET&#39;</span><span class="p">,</span><span class="n">keep_file_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">clean_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">check_function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>



        <span class="n">sub_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">subset_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sub_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">sub_path</span><span class="p">)</span>
                              
	<span class="sd">&#39;&#39;&#39;this is a check to see if we&#39;re restarting when mult_jobs==True&#39;&#39;&#39;</span>
	<span class="n">checkBool</span><span class="o">=</span><span class="kc">False</span>
	<span class="k">if</span> <span class="s1">&#39;__CRAWL_CHECK__&#39;</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__CRAWL_CHECK__&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ID</span><span class="p">:</span>
                <span class="n">checkBool</span><span class="o">=</span><span class="kc">True</span>


	<span class="n">chain_index</span><span class="o">=</span><span class="mi">1</span>
	<span class="k">try</span><span class="p">:</span>

            <span class="n">chain_index</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>
            <span class="c1">#		AFLOWpi.prep._passGlobalVar(&#39;__TEMP__INDEX__COUNTER__&#39;,oneCalc[&#39;__TEMP__INDEX__COUNTER__&#39;])</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_passGlobalVar</span><span class="p">(</span><span class="s1">&#39;__TEMP__INDEX__COUNTER__&#39;</span><span class="p">,</span><span class="n">chain_index</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
	
	<span class="n">chain_logname</span><span class="o">=</span><span class="s1">&#39;step_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="mi">1</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">chain_logname</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;CHECKBOOL:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">checkBool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checkBool</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">check_function</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">complete_function</span><span class="o">=</span><span class="s1">&#39;True&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">complete_function</span><span class="o">=</span><span class="n">check_function</span>
            <span class="c1">#block this prep from being run again.</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__CRAWL_CHECK__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ID</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="n">outFile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span><span class="p">)</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">         completeBool=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">	 if completeBool:</span>
<span class="s1">	    workdir = &#39;../../&#39;</span>
<span class="s1">	    mainOneCalc = AFLOWpi.prep._loadOneCalc(workdir,&#39;</span><span class="si">%s</span><span class="s1">&#39;)</span>
<span class="s1">            AFLOWpi.prep._swap_walltime_logs(&#39;</span><span class="si">%s</span><span class="s1">&#39;,mainOneCalc,oneCalc,ID)</span>
<span class="s1">	    AFLOWpi.run._submitJob(&#39;</span><span class="si">%s</span><span class="s1">&#39;,mainOneCalc,__submitNodeName__,forceOneJob=True)</span>

<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">complete_function</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
<span class="c1">################################################################################################################</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">subset_name</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">newConfigPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">subset_name</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;CONFIG.config&#39;</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">])</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span> <span class="s1">&#39;work_dir&#39;</span><span class="p">,</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span> 

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;job_template&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">qsub_temp_ref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">subset_name</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;CLUSTER.ref&#39;</span><span class="p">)</span>
                        <span class="n">qsubSub</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;cd .*</span><span class="si">%s</span><span class="se">\n</span><span class="s1">python .*</span><span class="si">%s</span><span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>

                        <span class="n">qsubSub_reg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">qsubSub</span><span class="p">)</span>

                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">qsub_pre_trans</span><span class="p">:</span>
                            <span class="n">qsub_string</span> <span class="o">=</span> <span class="n">qsub_pre_trans</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                        <span class="n">qsub_string</span> <span class="o">=</span> <span class="n">qsubSub_reg</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">qsub_string</span><span class="p">)</span>

                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">qsub_temp_ref</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">qsub_post_trans</span><span class="p">:</span>
                            <span class="n">qsub_post_trans</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">qsub_string</span><span class="p">)</span>

                        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;job_template&#39;</span><span class="p">,</span><span class="n">qsub_temp_ref</span><span class="p">)</span> 
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newConfigPath</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileWrite</span><span class="p">:</span>    
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fileWrite</span><span class="p">)</span>

<span class="c1">################################################################################################################</span>
            <span class="n">calc_subset</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_one_test_build</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">build_command</span><span class="p">,</span><span class="n">subset_name</span><span class="o">=</span><span class="n">subset_name</span><span class="p">,</span><span class="n">keep_name</span><span class="o">=</span><span class="n">keep_file_names</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">newConfigPath</span><span class="p">,</span><span class="n">clean_input</span><span class="o">=</span><span class="n">clean_input</span><span class="p">)</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">runAfterAllDone</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="n">fault_tolerant</span><span class="p">)</span>


            <span class="sd">&#39;&#39;&#39;if we are submitting the grid calc jobs separately or one big job&#39;&#39;&#39;</span>



            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">subset_tasks</span><span class="p">:</span>                
                <span class="n">exec</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ID_sub</span><span class="p">,</span><span class="n">oneCalc_sub</span> <span class="ow">in</span> <span class="n">calc_subset</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">set_complete_string</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;oneCalc[&#39;__status__&#39;][&#39;Complete&#39;]=False</span>
<span class="s1">AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc_sub</span><span class="p">,</span><span class="n">ID_sub</span><span class="p">,</span><span class="s1">&#39;LOCK&#39;</span><span class="p">,</span><span class="n">set_complete_string</span><span class="p">)</span> 

                <span class="n">set_complete_string</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;oneCalc[&#39;__status__&#39;][&#39;Complete&#39;]=True</span>
<span class="s1">AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc_sub</span><span class="p">,</span><span class="n">ID_sub</span><span class="p">,</span><span class="s1">&#39;SUBMITNEXT&#39;</span><span class="p">,</span><span class="n">set_complete_string</span><span class="p">)</span> 

            <span class="sd">&#39;&#39;&#39;submit in reverse order because calcs later in the orderedDict are more likely&#39;&#39;&#39;</span>
            <span class="sd">&#39;&#39;&#39;to be larger cells than those at the beginning&#39;&#39;&#39;</span>		
 <span class="c1">#           invert_bool=True</span>
            <span class="sd">&#39;&#39;&#39;if we&#39;re almost at the end of the walltime don&#39;t try to submit&#39;&#39;&#39;</span>
            <span class="n">walltime</span><span class="p">,</span><span class="n">startScript</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>
                <span class="n">subset_logs</span><span class="o">=</span><span class="s1">&#39;../../</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/AFLOWpi/calclogs/</span><span class="si">%s</span><span class="s1">.log&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">bn</span><span class="p">,</span><span class="n">subset_name</span><span class="p">,</span><span class="n">chain_logname</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_add_subset_to_daemon_log_list</span><span class="p">([</span><span class="n">subset_logs</span><span class="p">],</span><span class="s1">&#39;../AFLOWpi/submission_daemon/log_list.log&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                

            <span class="c1">#keep track of time in main script as it loops in case</span>
            <span class="c1">#we are running serial jobs and the walltime runs out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subset_config</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">subset_name</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;CONFIG.config&#39;</span><span class="p">)</span>
            <span class="n">calc_subset</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">loadlogs</span><span class="p">(</span><span class="n">subset_name</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">chain_logname</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">subset_config</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">calc_subset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">walltime</span><span class="p">,</span><span class="n">startScript</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1">#exit if all calcs are done (needed for local mode)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">calc_subset</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">oneCalc_sub</span><span class="o">=</span><span class="n">v</span>
                    <span class="n">ID_sub</span><span class="o">=</span><span class="n">k</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_checkSuccessCompletion</span><span class="p">(</span><span class="n">oneCalc_sub</span><span class="p">,</span><span class="n">ID_sub</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="n">fault_tolerant</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="c1">#################################################################################################</span>
        <span class="k">for</span> <span class="n">ID_new</span><span class="p">,</span><span class="n">oneCalc_new</span> <span class="ow">in</span> <span class="n">calc_subset</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">calc_subset</span><span class="p">[</span><span class="n">ID_new</span><span class="p">][</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc_new</span><span class="p">,</span><span class="n">ID_new</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>
                <span class="k">pass</span>
<span class="c1">#################################################################################################            </span>
        <span class="k">if</span> <span class="n">mult_jobs</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">oneJobBool</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">sajO</span><span class="o">=</span><span class="kc">True</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oneJobBool</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">sajO</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_return_to_main_pipeline</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
                <span class="n">last</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ID_new</span><span class="p">,</span><span class="n">oneCalc_new</span> <span class="ow">in</span> <span class="n">calc_subset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="n">last</span><span class="o">-=</span><span class="mi">1</span> 
                    <span class="k">if</span> <span class="n">last</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1">#to make sure this doesn&#39;t try to run again</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

                        <span class="n">oneJobBool</span><span class="o">=</span><span class="kc">True</span>
                        <span class="n">sajO</span><span class="o">=</span><span class="kc">False</span>

                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">ID_new</span><span class="p">,</span><span class="n">oneCalc_new</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="n">oneJobBool</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="n">sajO</span><span class="p">)</span>

                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                    

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        
            
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span></div>


<span class="k">def</span> <span class="nf">_return_to_main_pipeline</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Overwrite the ID.qsub files in the subset when mult_jobs==False so if it hits the walltime limit</span>
<span class="sd">    in the subset job it returns to the main pipeline when it restarts.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">main_qsub_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.qsub&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">main_qsub_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">main_qsub_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">main_qsub_file_obj</span><span class="p">:</span>
            <span class="n">main_qsub_file_str</span><span class="o">=</span><span class="n">main_qsub_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">new_ID</span><span class="p">,</span><span class="n">new_oneCalc</span> <span class="ow">in</span> <span class="n">calc_subset</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">subset_qsub_file</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.qsub&#39;</span><span class="o">%</span><span class="n">new_ID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subset_qsub_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">subset_qsub_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">subset_qsub_file_obj</span><span class="p">:</span>
                <span class="n">subset_qsub_file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">main_qsub_file_str</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">_swap_walltime_logs</span><span class="p">(</span><span class="n">main_ID</span><span class="p">,</span><span class="n">main_oneCalc</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Overwrites the walltime log of the main pipeline job that submitted the subset so the timer is</span>
<span class="sd">    correct when the subset calcs return to the main pipeline.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">subset_walltime_log</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_readWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_writeWalltimeLog</span><span class="p">(</span><span class="n">main_oneCalc</span><span class="p">,</span><span class="n">main_ID</span><span class="p">,</span><span class="n">subset_walltime_log</span><span class="p">)</span>
    <span class="c1">#move files to local scratch if it&#39;s being used for the main pipeline </span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_to_local_scratch</span><span class="p">(</span><span class="n">main_oneCalc</span><span class="p">,</span><span class="n">main_ID</span><span class="p">)</span>    


        

<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>



<span class="n">numpy</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">edgeitems</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                   
<div class="viewcode-block" id="isotropy"><a class="viewcode-back" href="../prep.html#prep.isotropy">[docs]</a><span class="k">class</span> <span class="nc">isotropy</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_str</span><span class="p">,</span><span class="n">accuracy</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_str</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
                <span class="n">input_str</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                

        <span class="bp">self</span><span class="o">.</span><span class="n">input</span>     <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_removeComments</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span>  <span class="o">=</span> <span class="n">accuracy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iso_input</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe_basis</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_labels</span><span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_pos</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iso_basis</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe_pos</span>    <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span>    <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span>    <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span>    <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span><span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span><span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>    <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes_flip</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_isotropy_output</span><span class="p">(</span><span class="n">qe_output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sg_num</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_sg_num</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ibrav</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ibrav_from_sg_number</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cif</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cif</span><span class="p">()</span>
<span class="c1">#        self.iso_basis = &#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iso_pr_car</span><span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span>      <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="c1">#        if output==False:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iso_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_iso_basis</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iso_pr_car</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_iso_cart</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__convert_to_ibrav_matrix</span><span class="p">()</span>
            

            <span class="bp">self</span><span class="o">.</span><span class="n">qe</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">pass</span>
<span class="c1">#        self.a</span>
<span class="c1">#        self.b</span>
<span class="c1">#        self.c</span>
<span class="c1">#        self.iso_co_car=</span>

<span class="c1">#        raise SystemExit</span>


<div class="viewcode-block" id="isotropy.get_cif"><a class="viewcode-back" href="../prep.html#prep.isotropy.get_cif">[docs]</a>    <span class="k">def</span> <span class="nf">get_cif</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;# CIF file.*</span><span class="se">\n</span><span class="s1">(?:.*</span><span class="se">\n</span><span class="s1">)*&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">__generate_isotropy_input_from_qe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
<span class="c1">#            cell_matrix = AFLOWpi.retr.getCellMatrixFromOutput(self.input,string=False)*0.529177249</span>
            <span class="n">cm_string</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="s1">&#39;content&#39;</span><span class="p">)</span> 

            <span class="n">alatSearch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(?:CELL_PARAMETERS)\s*.*alat[\D]*([0-9.]*)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">alatSearch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">alat</span><span class="o">=</span><span class="mf">1.0</span>


            <span class="n">cell_matrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellStringToMatrix</span><span class="p">(</span><span class="n">cm_string</span><span class="p">)</span>

            <span class="n">cell_matrix</span><span class="o">*=</span> <span class="n">alat</span><span class="o">*</span><span class="mf">0.529177249</span>
            <span class="n">cm_string</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellMatrixToString</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">)</span>

            <span class="n">pos_with_labs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">atomic_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="s1">&#39;content&#39;</span><span class="p">)</span> 
            <span class="n">labels</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pos_with_labs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">split_pos</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">positions</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="c1">#            print positions</span>
<span class="c1">#            print cm_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell_matrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">getCellMatrixFromInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">*</span><span class="mf">0.529177249</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="n">matrix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPosLabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orig_pos</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="n">matrix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
            <span class="n">cm_string</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellMatrixToString</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">free2abc</span><span class="p">(</span><span class="n">cell_matrix</span><span class="p">,</span><span class="n">cosine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bohr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">pos_labels</span><span class="o">=</span><span class="n">labels</span>
        <span class="n">num_atoms</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>


        <span class="n">label_index</span><span class="o">=</span><span class="nb">dict</span><span class="p">([[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spec</span><span class="p">)])</span>
<span class="c1">#        print labels</span>
        <span class="n">in_list</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">centering</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">,]:</span>
            <span class="n">isotropy_input_str</span><span class="o">=</span><span class="s1">&#39;input file for isotropy generated from pwscf input by AFLOWpi</span><span class="se">\n</span><span class="s1">&#39;</span>    
            <span class="n">isotropy_input_str</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span>
            <span class="n">isotropy_input_str</span><span class="o">+=</span><span class="s1">&#39;1</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">isotropy_input_str</span><span class="o">+=</span><span class="n">cm_string</span>
            <span class="n">isotropy_input_str</span><span class="o">+=</span><span class="s1">&#39;2</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">isotropy_input_str</span><span class="o">+=</span><span class="n">centering</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">isotropy_input_str</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">num_atoms</span>
            <span class="n">isotropy_input_str</span><span class="o">+=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#            isotropy_input_str+=&#39; &#39;.join([str(label_index[j]) for j in labels])+&#39;\n&#39;</span>
            <span class="n">isotropy_input_str</span><span class="o">+=</span><span class="n">positions</span>
<span class="c1">#            print isotropy_input_str</span>
            <span class="n">in_list</span><span class="p">[</span><span class="n">centering</span><span class="p">]</span><span class="o">=</span><span class="n">isotropy_input_str</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iso_input</span> <span class="o">=</span> <span class="n">isotropy_input_str</span>

        <span class="k">return</span> <span class="n">in_list</span>

    <span class="k">def</span> <span class="nf">__get_isotropy_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">qe_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">centering</span><span class="o">=</span><span class="s1">&#39;P&#39;</span>

        <span class="n">in_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__generate_isotropy_input_from_qe_data</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">qe_output</span><span class="p">)</span>
        <span class="n">ISODATA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;ISOTROPY&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">putenv</span><span class="p">(</span><span class="s1">&#39;ISODATA&#39;</span><span class="p">,</span><span class="n">ISODATA</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> 

        <span class="k">for</span> <span class="n">centering</span><span class="p">,</span><span class="n">in_str</span> <span class="ow">in</span> <span class="n">in_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>


            <span class="n">findsym_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ISODATA</span><span class="p">,</span><span class="s1">&#39;findsym&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">find_sym_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">findsym_path</span><span class="p">,</span><span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,)</span>

                <span class="n">output</span> <span class="o">=</span> <span class="n">find_sym_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">in_str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">=</span><span class="n">output</span>
<span class="c1">#                print output</span>



            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">find_sym_process</span><span class="o">.</span><span class="n">returncode</span>

            <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">__get_sg_num</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sg_info</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Space Group\s*([0-9]*)\s*([\w-]*)\s*([\w-]*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sg_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__get_iso_cart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">search</span> <span class="o">=</span> <span class="s1">&#39;Lattice vectors in cartesian coordinates:\s*</span><span class="se">\n</span><span class="s1">(.*</span><span class="se">\n</span><span class="s1">.*</span><span class="se">\n</span><span class="s1">.*)</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">std_prim_basis_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">search</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iso_pr_car</span>    <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellStringToMatrix</span><span class="p">(</span><span class="n">std_prim_basis_str</span><span class="p">)</span><span class="c1">#*</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iso_pr_car</span>
            


    <span class="k">def</span> <span class="nf">__get_iso_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">modifier</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="n">return_which</span><span class="o">=</span><span class="s1">&#39;modifier&#39;</span><span class="p">,)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="c1">#        if modifier==&#39;angstrom&#39;:</span>

<span class="c1">#        else:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;_cell_length_a\s*([0-9-.]*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;_cell_length_b\s*([0-9-.]*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;_cell_length_c\s*([0-9-.]*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;_cell_angle_alpha\s*([0-9-.]*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;_cell_angle_beta\s*([0-9-.]*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;_cell_angle_gamma\s*([0-9-.]*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Origin at\s*([0-9-.]*)\s*([0-9-.]*)\s*([0-9-.]*)&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">origin</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span>


        <span class="n">std_prim_basis_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Vectors a,b,c:\s*</span><span class="se">\n</span><span class="s1">(.*</span><span class="se">\n</span><span class="s1">.*</span><span class="se">\n</span><span class="s1">.*)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iso_conv</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellStringToMatrix</span><span class="p">(</span><span class="n">std_prim_basis_str</span><span class="p">)</span>






        <span class="n">input_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;CELL_PARAMETERS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="p">:</span>
            <span class="n">prim_in</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">getCellMatrixFromInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prim_in</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellStringToMatrix</span><span class="p">(</span><span class="n">prim_in</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">][</span><span class="s2">&quot;__content__&quot;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">prim_in</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">getCellMatrixFromInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prim_in</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellStringToMatrix</span><span class="p">(</span><span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span>

        


        <span class="bp">self</span><span class="o">.</span><span class="n">iso_basis</span><span class="o">=</span><span class="n">prim_in</span>



        <span class="n">a</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span><span class="p">,],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span><span class="p">,],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span><span class="p">,],])</span>

<span class="c1">#        print self.iso_basis</span>
<span class="c1">#        print a</span>
        <span class="n">a</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">iso_conv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iso_basis</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibrav</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>

<span class="c1">#        print self.iso_basis.dot(self.iso_conv)</span>
        
        <span class="n">prim_abc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Lattice parameters, a,b,c,alpha,beta,gamma.*</span><span class="se">\n</span><span class="s1">(.*)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">prim_abc</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">prim_abc</span><span class="p">)</span>
<span class="c1">#        print prim_abc</span>

<span class="c1">#        self.iso_conv[0]*=prim_abc[0]</span>
<span class="c1">#        self.iso_conv[1]*=prim_abc[1]</span>
<span class="c1">#        self.iso_conv[2]*=prim_abc[2]</span>

<span class="c1">#        print a.dot(prim_in)</span>
        
<span class="c1">#        self.iso_conv[0]/=self.conv_a</span>
<span class="c1">#        self.iso_conv[1]/=self.conv_b</span>
<span class="c1">#        self.iso_conv[2]/=self.conv_c</span>

<span class="c1">#        print self.iso_basis</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">axes_flip</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iso_conv</span><span class="p">)</span>

<span class="c1">#        self.axes_flip[0]*=self.conv_a</span>
<span class="c1">#        self.axes_flip[1]*=self.conv_b</span>
<span class="c1">#        self.axes_flip[2]*=self.conv_c</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">axes_flip</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_flip</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1">#        raise SystemExit</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iso_basis</span>

    <span class="k">def</span> <span class="nf">__convert_to_ibrav_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#passing the wrong basis vectors but it&#39;s okay since ibrav=ibrav_num overrides it</span>
        <span class="c1">#        print self.ibrav</span>


        







        



        
 <span class="c1">#       self.qe_basis = AFLOWpi.retr._conv2PrimVec(self.iso_basis,ibrav=self.ibrav)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe_basis</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">abc2free</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span><span class="p">,</span><span class="n">ibrav</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ibrav</span><span class="p">,</span><span class="n">returnString</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    


        <span class="n">conv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qe_basis</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iso_basis</span><span class="p">)</span>
<span class="c1">#        self.qe_basis[:,0]/=self.conv_a</span>
<span class="c1">#        self.qe_basis[:,1]/=self.conv_b</span>
<span class="c1">#        self.qe_basis[:,2]/=self.conv_c</span>


        <span class="k">return</span> <span class="n">conv</span>



<div class="viewcode-block" id="isotropy.convert"><a class="viewcode-back" href="../prep.html#prep.isotropy.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ibrav</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">input_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">qe_pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_pos</span><span class="p">)</span>








        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibrav</span><span class="o">==</span><span class="mi">12</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibrav</span><span class="o">==</span><span class="mi">13</span><span class="p">:</span>
<span class="c1">#            print self.conv_alpha,self.conv_beta</span>
            
<span class="c1">#            print self.qe_basis</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">!=</span><span class="mf">90.0</span><span class="p">:</span>


                 <span class="n">temp_angle</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span> <span class="o">=</span> <span class="n">temp_angle</span>
                 <span class="n">temp_len</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span>     <span class="o">=</span> <span class="n">temp_len</span>

            <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">!=</span><span class="mf">90.0</span><span class="p">:</span>


                 <span class="n">temp_angle</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span> <span class="o">=</span> <span class="n">temp_angle</span>
                 <span class="n">temp_len</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span>     <span class="o">=</span> <span class="n">temp_len</span>



        <span class="n">conv_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_flip</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span><span class="p">,])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="c1">#        print self.conv_a,self.conv_b,self.conv_c</span>
<span class="c1">#        print self.axes_flip</span>
<span class="c1">#        self.conv_a,self.conv_b,self.conv_c = numpy.abs(conv_len)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orig_pos</span>  <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iso_basis</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qe_basis</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe_pos</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_pos</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">trans</span><span class="p">))</span>
        
        


        <span class="c1"># if self.ibrav==12 or self.ibrav==13:            </span>
        <span class="c1">#     if numpy.around(self.conv_beta,decimals=3)!=90.0:</span>
        <span class="c1">#         self.qe_pos  = self.qe_pos[:,[0,2,1]]</span>

        <span class="c1">#     elif numpy.around(self.conv_alpha,decimals=3)!=90.0:</span>
        <span class="c1">#         self.qe_pos   = self.qe_pos[:,[2,1,0]]</span>


            

<span class="c1">#            self.orig_pos[i]-=self.origin</span>
            
<span class="c1">#            pos_copy = copy.deepcopy(self.orig_pos[i])</span>
<span class="c1">#            pos_copy-=self.origin</span>
<span class="c1">#            print pos_copy</span>
<span class="c1">#            pre_trans = numpy.matrix(pos_copy)</span>
<span class="c1">#            print pre_trans</span>
<span class="c1">#            self.qe_pos[i] = self.conv.dot(pos_copy.T).T</span>
<span class="c1">#            self.qe_pos[i] = pos_copy.dot(self.conv)</span>
<span class="c1">#            pos_copy-=self.origin</span>
<span class="c1">#            first = pos_copy.dot(numpy.linalg.inv(self.iso_basis))</span>
            

        <span class="n">qe_pos_str</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinMatrixLabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_labels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">qe_pos</span><span class="p">)</span>
                                         
        <span class="n">modifier</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="n">return_which</span><span class="o">=</span><span class="s1">&#39;modifier&#39;</span><span class="p">,)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">prim_qe_cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iso_pr_car</span>
<span class="c1">#        conv_iso = numpy.linalg.inv(self.iso_basis).dot(self.iso_pr_car)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            

        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span><span class="c1">#*0.529177249</span>
 <span class="c1">#       if self.ibrav in [8,9,10,11,12,13,14]:</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span><span class="c1">#*0.529177249</span>
<span class="c1">#        if self.ibrav in [4,6,7,8,9,10,11,12,13,14]:</span>
            <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span><span class="c1">#*0.529177249</span>
<span class="c1">#        if self.ibrav in [12,13,14]:            </span>
            <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;cosAB&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="c1">#        if self.ibrav in [5]:            </span>
<span class="c1">#            input_dict[&#39;&amp;system&#39;][&#39;cosBC&#39;]=numpy.cos(self.conv_gamma/180.0*numpy.pi)</span>
<span class="c1">#        if self.ibrav in [14]:                        </span>
            <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;cosAC&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;cosBC&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="c1">#        input_dict[&#39;&amp;system&#39;][&#39;&#39;]=self.conv_a</span>
<span class="c1">#        input_dict[&#39;&amp;system&#39;][&#39;A&#39;]=self.conv_a</span>

        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ibrav&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ibrav</span>

<span class="c1">#</span>


        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">qe_pos_str</span>

<span class="c1">#[&#39;__content__&#39;]=qe_pos_str</span>
<span class="c1">#        input_dict[&#39;CELL_PARAMETERS&#39;][&#39;__content__&#39;]=qe_cm_string</span>
        <span class="n">qe_convention_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>
<span class="c1">#        print qe_convention_input</span>
<span class="c1">#        print qe_convention_input</span>
        <span class="k">if</span> <span class="n">ibrav</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
<span class="c1">#            print qe_convention_input</span>
            <span class="n">qe_convention_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_transformInput</span><span class="p">(</span><span class="n">qe_convention_input</span><span class="p">)</span>
<span class="c1">#            print qe_convention_input </span>
            <span class="k">return</span> <span class="n">qe_convention_input</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">qe_convention_input</span></div>




    <span class="k">def</span> <span class="nf">__ibrav_from_sg_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">195</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">201</span><span class="p">,</span><span class="mi">205</span><span class="p">,</span><span class="mi">207</span><span class="p">,</span><span class="mi">208</span><span class="p">,</span><span class="mi">212</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">215</span><span class="p">,</span><span class="mi">218</span><span class="p">,</span><span class="mi">221</span><span class="p">,</span><span class="mi">222</span><span class="p">,</span><span class="mi">223</span><span class="p">,</span><span class="mi">224</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">196</span><span class="p">,</span><span class="mi">202</span><span class="p">,</span><span class="mi">203</span><span class="p">,</span><span class="mi">209</span><span class="p">,</span><span class="mi">210</span><span class="p">,</span><span class="mi">216</span><span class="p">,</span><span class="mi">219</span><span class="p">,</span><span class="mi">225</span><span class="p">,</span><span class="mi">226</span><span class="p">,</span><span class="mi">227</span><span class="p">,</span><span class="mi">228</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">197</span><span class="p">,</span><span class="mi">199</span><span class="p">,</span><span class="mi">204</span><span class="p">,</span><span class="mi">206</span><span class="p">,</span><span class="mi">211</span><span class="p">,</span><span class="mi">214</span><span class="p">,</span><span class="mi">217</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mi">229</span><span class="p">,</span><span class="mi">230</span><span class="p">,]:</span>
            <span class="k">return</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">168</span><span class="p">,</span><span class="mi">169</span><span class="p">,</span><span class="mi">170</span><span class="p">,</span><span class="mi">171</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">173</span><span class="p">,</span><span class="mi">174</span><span class="p">,</span><span class="mi">175</span><span class="p">,</span><span class="mi">176</span><span class="p">,</span><span class="mi">177</span><span class="p">,</span><span class="mi">178</span><span class="p">,</span><span class="mi">179</span><span class="p">,</span>
                     <span class="mi">180</span><span class="p">,</span><span class="mi">181</span><span class="p">,</span><span class="mi">182</span><span class="p">,</span><span class="mi">183</span><span class="p">,</span><span class="mi">184</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mi">187</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">189</span><span class="p">,</span><span class="mi">190</span><span class="p">,</span><span class="mi">191</span><span class="p">,</span>
                     <span class="mi">192</span><span class="p">,</span><span class="mi">193</span><span class="p">,</span><span class="mi">194</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">4</span>


        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">143</span><span class="p">,</span><span class="mi">144</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mi">149</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">152</span><span class="p">,</span><span class="mi">153</span><span class="p">,</span><span class="mi">154</span><span class="p">,</span>
                     <span class="mi">156</span><span class="p">,</span><span class="mi">157</span><span class="p">,</span><span class="mi">158</span><span class="p">,</span><span class="mi">159</span><span class="p">,</span><span class="mi">162</span><span class="p">,</span><span class="mi">163</span><span class="p">,</span><span class="mi">164</span><span class="p">,</span><span class="mi">165</span><span class="p">,]:</span>
            <span class="k">return</span> <span class="mi">4</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">146</span><span class="p">,</span><span class="mi">148</span><span class="p">,</span><span class="mi">155</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">161</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">167</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">4</span>
                     
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">75</span><span class="p">,</span><span class="mi">76</span><span class="p">,</span><span class="mi">77</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mi">81</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">84</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">86</span><span class="p">,</span><span class="mi">89</span><span class="p">,</span><span class="mi">91</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mi">93</span><span class="p">,</span><span class="mi">94</span><span class="p">,</span>
                     <span class="mi">95</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span>
                     <span class="mi">113</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mi">125</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span>
                     <span class="mi">128</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">134</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">136</span><span class="p">,</span><span class="mi">137</span><span class="p">,</span><span class="mi">138</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">6</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">79</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span>
                     <span class="mi">120</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">141</span><span class="p">,</span><span class="mi">142</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">7</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span>
                     <span class="mi">48</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">62</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">38</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">68</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">9</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">69</span><span class="p">,</span><span class="mi">70</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">71</span><span class="p">,</span><span class="mi">72</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">11</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">12</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">15</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">13</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">14</span>






        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;SG num not found:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sgn</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>





<div class="viewcode-block" id="isotropy.cif2qe"><a class="viewcode-back" href="../prep.html#prep.isotropy.cif2qe">[docs]</a>    <span class="k">def</span> <span class="nf">cif2qe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>


        <span class="n">input_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

        <span class="c1">############################################################</span>
        <span class="c1">############################################################</span>
        <span class="k">def</span> <span class="nf">process_shift</span><span class="p">(</span><span class="n">symops</span><span class="p">):</span>
            <span class="n">re_shift</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[+-]*\d\/\d&#39;</span><span class="p">)</span>
            <span class="n">addition</span> <span class="o">=</span> <span class="n">re_shift</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">symops</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">sign</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">minus</span> <span class="o">=</span> <span class="n">addition</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">sign</span><span class="o">=-</span><span class="mf">1.0</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">numer</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">addition</span><span class="p">[</span><span class="n">addition</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">denom</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">addition</span><span class="p">[</span><span class="n">addition</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

            
            <span class="k">return</span> <span class="n">sign</span><span class="o">*</span><span class="n">numer</span><span class="o">/</span><span class="n">denom</span>
        <span class="c1">############################################################</span>
        <span class="c1">############################################################</span>


        <span class="n">convert</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">abc2free</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span><span class="p">,</span><span class="n">ibrav</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ibrav</span><span class="p">,</span><span class="n">returnString</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ins</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cif</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">re_symops</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;_space_group_symop_operation_xyz\s*\n((?:\s*\d+.*\n)+)\s*&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

        <span class="n">symops</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re_symops</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">ins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span> <span class="p">)]</span>

        <span class="n">re_sym_ops_remove_numbering</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\d+\s+(.*)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symops</span><span class="p">)):</span>
            <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">re_sym_ops_remove_numbering</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">symops_aux</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symops</span><span class="p">)):</span>
            <span class="n">sym_aux_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sym_aux_temp</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">symops_aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym_aux_temp</span><span class="p">)</span>

        <span class="n">symops</span><span class="o">=</span><span class="n">symops_aux</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="n">operations</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">symops</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">operations</span><span class="p">[:,]</span><span class="o">=</span><span class="n">ident</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">symops</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symops</span><span class="p">)):</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ident</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ident</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">operations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ident</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>

            <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*=-</span><span class="mf">1.0</span>
            <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">operations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*=-</span><span class="mf">1.0</span>
            <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">operations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*=-</span><span class="mf">1.0</span>

            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">shift</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">process_shift</span><span class="p">(</span><span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">shift</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">process_shift</span><span class="p">(</span><span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">shift</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">process_shift</span><span class="p">(</span><span class="n">symops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>


        <span class="n">re_atom_pos</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(_atom_site_label.*\n(?:(?:[a-z_\s])*\n))((?:.*\n)*)&#39;</span><span class="p">)</span>
        <span class="n">atom_pos</span><span class="o">=</span><span class="n">re_atom_pos</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">ins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">loop_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">atom_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">spec_lab</span> <span class="o">=</span>  <span class="n">loop_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_atom_site_label&#39;</span><span class="p">)</span>

        <span class="n">x_loc</span> <span class="o">=</span>  <span class="n">loop_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_atom_site_fract_x&#39;</span><span class="p">)</span>
        <span class="n">y_loc</span> <span class="o">=</span>  <span class="n">loop_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_atom_site_fract_y&#39;</span><span class="p">)</span>
        <span class="n">z_loc</span> <span class="o">=</span>  <span class="n">loop_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_atom_site_fract_z&#39;</span><span class="p">)</span>


        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">atom_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pos_array</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>


        <span class="n">labels</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)):</span>
            <span class="n">pos_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x_loc</span><span class="p">])</span>
            <span class="n">pos_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">y_loc</span><span class="p">])</span>
            <span class="n">pos_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">z_loc</span><span class="p">])</span>

            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">spec_lab</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>


        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span>
        <span class="n">all_eq_pos</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pos_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">operations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">pos_copy</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pos_array</span><span class="p">)</span>
            <span class="n">temp_pos</span>   <span class="o">=</span> <span class="n">pos_copy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">operations</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">temp_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="n">shift</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">temp_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">shift</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">temp_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">+=</span><span class="n">shift</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">all_eq_pos</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">pos_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pos_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">temp_pos</span>

            
        <span class="n">all_eq_pos</span><span class="o">%=</span><span class="mf">1.0</span>


        <span class="n">all_eq_pos</span><span class="o">=</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">getA</span><span class="p">())</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">all_eq_pos</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">%</span><span class="mf">1.0</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">all_eq_pos</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">void</span><span class="p">,</span>  <span class="n">all_eq_pos</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">all_eq_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">labels_arr</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">labels_arr</span><span class="o">=</span><span class="n">labels_arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">all_eq_pos</span><span class="o">=</span><span class="n">all_eq_pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">spec_sort</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">labels_arr</span><span class="p">)</span>
        <span class="n">labels_arr</span><span class="o">=</span><span class="n">labels_arr</span><span class="p">[</span><span class="n">spec_sort</span><span class="p">]</span>
        <span class="n">all_eq_pos</span><span class="o">=</span><span class="n">all_eq_pos</span><span class="p">[</span><span class="n">spec_sort</span><span class="p">]</span>




        <span class="n">atm_pos_str</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">all_eq_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">atm_pos_str</span><span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%3.3s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">labels_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">% 9.9f</span><span class="s1"> </span><span class="si">% 9.9f</span><span class="s1"> </span><span class="si">% 9.9f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="nb">tuple</span><span class="p">(</span><span class="n">all_eq_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>



        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ibrav&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ibrav</span>

        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_a</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_b</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_c</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;cosAB&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_gamma</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;cosAC&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_beta</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;cosBC&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_alpha</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>




        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">atm_pos_str</span>

        <span class="n">qe_convention_input</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>

        <span class="n">qe_convention_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_transformInput</span><span class="p">(</span><span class="n">qe_convention_input</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qe_convention_input</span></div></div>
        <span class="c1">#        from scipy.spatial import Delaunay as CH</span>

<span class="c1">#         def inside_prim_lat(labels,points,conv,prim):</span>
             
<span class="c1">#             labs,ss = AFLOWpi.retr._expandBoundaries(labels,points,2,2,2)</span>
<span class="c1">#             ss=ss*2.0-1.0</span>
<span class="c1">#  #           prim+=shift</span>
<span class="c1">#             prim_hull = numpy.zeros((8,3),dtype=numpy.float64)</span>
<span class="c1"># #            prim_hull[0] =</span>
<span class="c1">#             prim_hull[1] = prim[0]</span>
<span class="c1">#             prim_hull[2] = prim[1]</span>
<span class="c1">#             prim_hull[3] = prim[2]</span>
<span class="c1">#             prim_hull[4] = prim[0]+prim[1]</span>
<span class="c1">#             prim_hull[5] = prim[0]+prim[1]+prim[2]</span>
<span class="c1">#             prim_hull[6] = prim[0]+prim[2]</span>
<span class="c1">#             prim_hull[7] = prim[1]+prim[2]</span>
            

<span class="c1">#             hull=CH(prim_hull)</span>
<span class="c1">#             print  hull.find_simplex(ss)</span>
<span class="c1">#             in_hull_mask= hull.find_simplex(ss)&gt;=0</span>
<span class="c1">#             return labs[in_hull_mask],ss[in_hull_mask]%1.0</span>


<span class="c1">#        labels_arr,all_eq_pos= inside_prim_lat(labels_arr,all_eq_pos,ident,convert)</span>
        

<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">__main__</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">time</span>

<div class="viewcode-block" id="tight_binding"><a class="viewcode-back" href="../prep.html#prep.tight_binding">[docs]</a><span class="k">class</span> <span class="nc">tight_binding</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">calcs</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">proj_thr</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span><span class="n">kp_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">proj_sh</span><span class="o">=</span><span class="mf">5.5</span><span class="p">,</span><span class="n">cond_bands_proj</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="o">=</span><span class="n">calcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">tb_plotter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cond_bands</span><span class="o">=</span><span class="n">cond_bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresh</span><span class="o">=</span><span class="n">proj_thr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="o">=</span><span class="n">proj_sh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cond_bands_proj</span><span class="o">=</span><span class="n">cond_bands_proj</span>

        <span class="n">tb_plotter</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">tb_plotter</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;oneCalc,ID=AFLOWpi.prep._modifyNamelistPW(oneCalc,ID,&#39;&amp;control&#39;,&#39;calculation&#39;,&#39;&quot;scf&quot;&#39;)&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;AFLOWpi.scfuj._get_ham_xml(oneCalc,ID)&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">command</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;if oneCalc[&quot;__execCounter__&quot;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">     oneCalc,ID=AFLOWpi.prep._run_tb_ham_prep(__submitNodeName__,oneCalc,ID,unoccupied_bands=</span><span class="si">%s</span><span class="s1">,paw=False,kp_factor=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">     oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">     AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_bands</span><span class="p">,</span><span class="n">kp_factor</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>

        <span class="n">command</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;AFLOWpi.prep._rename_projectability(oneCalc,ID)&#39;&#39;&#39;</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">+=</span><span class="mi">1</span>




<div class="viewcode-block" id="tight_binding.optical"><a class="viewcode-back" href="../prep.html#prep.tight_binding.optical">[docs]</a>    <span class="k">def</span> <span class="nf">optical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">en_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">5.05</span><span class="p">],</span><span class="n">de</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="n">ne</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">en_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">en_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">de</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">False</span>

        <span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;AFLOWpi.scfuj.want_epsilon_prep(oneCalc,ID,en_range=</span><span class="si">%s</span><span class="s1">,ne=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">en_range</span><span class="p">,</span><span class="n">ne</span><span class="p">)</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>		

        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;if oneCalc[&quot;__execCounter__&quot;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">     oneCalc,ID = AFLOWpi.scfuj._run_want_epsilon(__submitNodeName__,oneCalc,ID,ne=</span><span class="si">%s</span><span class="s1">,en_range=</span><span class="si">%s</span><span class="s1">,compute_ham=</span><span class="si">%s</span><span class="s1">,proj_thr=</span><span class="si">%s</span><span class="s1">,proj_sh=</span><span class="si">%s</span><span class="s1">,proj_nbnd=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">     oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">     AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span><span class="n">ne</span><span class="p">,</span><span class="n">en_range</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">thresh</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_bands_proj</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Calculate optical with PAO-TB Hamiltonian&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>





<div class="viewcode-block" id="tight_binding.transport"><a class="viewcode-back" href="../prep.html#prep.tight_binding.transport">[docs]</a>    <span class="k">def</span> <span class="nf">transport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="p">[</span><span class="mi">300</span><span class="p">,],</span><span class="n">en_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">5.05</span><span class="p">,</span><span class="mf">5.05</span><span class="p">],</span><span class="n">de</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.scfuj.prep_transport and AFLOWpi.scfuj.run_transport </span>
<span class="sd">		in the high level user interface. Adds a new step to the workflow.</span>
<span class="sd">		</span>
<span class="sd">		</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the _calcs_container object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      epsilon (bool): if True episilon tensor will be computed </span>
<span class="sd">		      temperature (list): list of temperature(s) at which to calculate transport properties</span>

<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>		
                <span class="n">ne</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">en_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">en_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">de</span>
		<span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;AFLOWpi.scfuj.transport_prep(oneCalc,ID)&#39;</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>		


		<span class="k">for</span> <span class="n">temp_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">False</span>

                        <span class="n">command</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;if oneCalc[&quot;__execCounter__&quot;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">     oneCalc,ID = AFLOWpi.scfuj.run_transport(__submitNodeName__,oneCalc,ID,temperature=</span><span class="si">%s</span><span class="s1">,run_scf=</span><span class="si">%s</span><span class="s1">,run_transport_prep=</span><span class="si">%s</span><span class="s1">,epsilon=</span><span class="si">%s</span><span class="s1">,run_bands=</span><span class="si">%s</span><span class="s1">,en_range=</span><span class="si">%s</span><span class="s1">,ne=</span><span class="si">%s</span><span class="s1">,compute_ham=</span><span class="si">%s</span><span class="s1">,proj_thr=</span><span class="si">%s</span><span class="s1">,proj_sh=</span><span class="si">%s</span><span class="s1">,proj_nbnd=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">     oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">     AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span><span class="n">temperature</span><span class="p">[</span><span class="n">temp_index</span><span class="p">],</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">en_range</span><span class="p">),</span><span class="n">ne</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">thresh</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_bands_proj</span><span class="p">)</span>

                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">+=</span><span class="mi">1</span>

			<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Transport Properties at </span><span class="si">%s</span><span class="s1">K&#39;</span> <span class="o">%</span> <span class="n">temperature</span><span class="p">[</span><span class="n">temp_index</span><span class="p">]</span>
<span class="c1">#			print &#39;\nADDING TB STEP : %s&#39;% (calc_type)</span>
			<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING TB STEP: &#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
			<span class="c1">## no temperature parameter for WanT bands so only run </span>
			<span class="c1">## it once if run_bands=True in the input the method.</span>




<div class="viewcode-block" id="tight_binding.dos"><a class="viewcode-back" href="../prep.html#prep.tight_binding.dos">[docs]</a>    <span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">5.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">],</span><span class="n">k_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">projected</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fermi_surface</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">ne</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">dos_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dos_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">de</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi.scfuj.want_dos_prep(oneCalc,ID)&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">False</span>


        <span class="n">command</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;if oneCalc[&quot;__execCounter__&quot;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">     oneCalc,ID = AFLOWpi.prep._run_want_dos(__submitNodeName__,oneCalc,ID,dos_range=</span><span class="si">%s</span><span class="s1">,k_grid=</span><span class="si">%s</span><span class="s1">,project=</span><span class="si">%s</span><span class="s1">,num_e=</span><span class="si">%s</span><span class="s1">,cond_bands=</span><span class="si">%s</span><span class="s1">,fermi_surface=</span><span class="si">%s</span><span class="s1">,compute_ham=</span><span class="si">%s</span><span class="s1">,proj_thr=</span><span class="si">%s</span><span class="s1">,proj_sh=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">     oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">     AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span><span class="n">dos_range</span><span class="p">,</span><span class="n">k_grid</span><span class="p">,</span><span class="n">projected</span><span class="p">,</span><span class="n">ne</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_bands_proj</span><span class="p">,</span><span class="n">fermi_surface</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">thresh</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Calculate DOS with PAO-TB Hamiltonian&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">projected</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Calculate PDOS with PAO-TB Hamiltonian&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fermi_surface</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Generate Fermi Surface data with PAO-TB Hamiltonian&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="tight_binding.bands"><a class="viewcode-back" href="../prep.html#prep.tight_binding.bands">[docs]</a>    <span class="k">def</span> <span class="nf">bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nk</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">nbnd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">eShift</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="o">=</span><span class="kc">False</span>

	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi.scfuj.want_bands_prep(oneCalc,ID)&#39;</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;if oneCalc[&quot;__execCounter__&quot;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">     oneCalc,ID = AFLOWpi.prep._run_want_bands(__submitNodeName__,oneCalc,ID,num_points=</span><span class="si">%s</span><span class="s1">,cond_bands=</span><span class="si">%s</span><span class="s1">,compute_ham=</span><span class="si">%s</span><span class="s1">,proj_thr=</span><span class="si">%s</span><span class="s1">,proj_sh=</span><span class="si">%s</span><span class="s1">,)</span>
<span class="s1">     oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">     AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span><span class="n">nk</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_bands_proj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">do_ham</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">thresh</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">,)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Calculate bands with PAO-TB Hamiltonian&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="tight_binding.effmass"><a class="viewcode-back" href="../prep.html#prep.tight_binding.effmass">[docs]</a>    <span class="k">def</span> <span class="nf">effmass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="p">[</span><span class="mf">300.0</span><span class="p">,</span><span class="mf">300.0</span><span class="p">],</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_bands</span><span class="o">!=</span><span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;CANNOT DO EFFECTIVE MASS WITHOUT CONDUCTION BANDS. SKIPPING EFFECTIVE MASS CALC&#39;</span>
            <span class="k">return</span>

	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi.scfuj.want_eff_mass_prep(oneCalc,ID)&#39;</span><span class="p">)</span>

        <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Calculate Effective Mass with PAO-TB Hamiltonian&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span>


<span class="c1">#if oneCalc[&quot;__execCounter__&quot;]&lt;%s</span>
<span class="c1">#     oneCalc[&quot;__execCounter__&quot;]+=1</span>
<span class="c1">#     AFLOWpi.prep._saveOneCalc(oneCalc,ID)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;if oneCalc[&quot;__execCounter__&quot;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">     oneCalc,ID = AFLOWpi.prep._run_want_eff_mass(__submitNodeName__,oneCalc,ID,temperature=</span><span class="si">%s</span><span class="s1">,step=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">     oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">     AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span><span class="n">temperature</span><span class="p">,</span><span class="n">step</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToAll_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_counter</span><span class="o">+=</span><span class="mi">1</span></div></div>
	






<span class="k">def</span> <span class="nf">_form_TB_dir</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">from_ls</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">from_ls</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ext_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.save&#39;</span><span class="p">])</span>
<span class="c1">#        AFLOWpi.prep._from_local_scratch(oneCalc,ID,ext_list=[&#39;.save/atom_proj.dat&#39;],#%oneCalc[&#39;_AFLOWPI_PREFIX_&#39;]],</span>
<span class="c1">#                                         glob=True,first_node_only=True)</span>
<span class="c1">#        AFLOWpi.prep._from_local_scratch(oneCalc,ID,ext_list=[&#39;.save/data-file.xml&#39;],#%oneCalc[&#39;_AFLOWPI_PREFIX_&#39;]],</span>
<span class="c1">#                                         glob=True,first_node_only=True)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.save&#39;</span><span class="p">)</span>
        <span class="n">TB_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_TB.save&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">TB_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">TB_dir</span><span class="p">)</span>
        <span class="n">data_file_dft</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span><span class="s1">&#39;data-file.xml&#39;</span><span class="p">)</span>
        <span class="n">atomic_proj_dat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span><span class="s1">&#39;atomic_proj.dat&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data_file_dft</span><span class="p">,</span><span class="n">TB_dir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">atomic_proj_dat</span><span class="p">,</span><span class="n">TB_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">e</span>


<span class="k">def</span> <span class="nf">_run_want_bands</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">num_points</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">compute_ham</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">proj_thr</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span><span class="n">proj_sh</span><span class="o">=</span><span class="mf">5.5</span><span class="p">):</span>
    <span class="n">nscf_ID</span><span class="o">=</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_nscf&#39;</span>

    <span class="n">Efermi</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getEfermi</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">,</span><span class="n">directID</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">eShift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">Efermi</span><span class="p">)</span><span class="o">+</span><span class="mf">10.0</span>
    
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="n">want_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">WanT_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">,</span><span class="n">eShift</span><span class="o">=</span><span class="n">proj_sh</span><span class="p">,</span><span class="n">num_points</span><span class="o">=</span><span class="n">num_points</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="n">cond_bands</span><span class="p">,</span><span class="n">compute_ham</span><span class="o">=</span><span class="n">compute_ham</span><span class="p">,</span><span class="n">proj_thr</span><span class="o">=</span><span class="n">proj_thr</span><span class="p">)</span>



    <span class="k">for</span> <span class="n">want_ID</span><span class="p">,</span><span class="n">want_calc</span> <span class="ow">in</span> <span class="n">want_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">want_calc</span><span class="p">,</span><span class="n">want_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./want_bands.x&#39;</span><span class="p">,)</span>

    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_clean_want_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

<span class="k">def</span> <span class="nf">_rename_projectability</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
<span class="c1">#    nspin = int(AFLOWpi.scfuj.chkSpinCalc(oneCalc,ID))</span>
<span class="c1">#    if nspin==2:</span>
        <span class="n">proj_up</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;projectability_dn.txt&#39;</span><span class="p">)</span>
        <span class="n">proj_dn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;projectability_up.txt&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proj_dn</span><span class="p">,</span><span class="n">proj_dn_new</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">proj_dn_new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_projectability_dn.txt&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">proj_up_new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_projectability_up.txt&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proj_up</span><span class="p">,</span><span class="n">proj_up_new</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;projectability.txt&#39;</span><span class="p">)</span>
        <span class="n">proj_new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_projectability.txt&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span><span class="n">proj_new</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">def</span> <span class="nf">_run_want_eff_mass</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">800</span><span class="p">],</span><span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">nscf_ID</span><span class="o">=</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_nscf&#39;</span>

    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>



    <span class="k">if</span> <span class="s1">&#39;__effmass_counter__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#if an old effective mass data file exists delete it before we start</span>
        <span class="n">effmass_datafile_by_temp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_WanT_effmass.dat&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">effmass_datafile_by_temp</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">effmass_datafile_by_temp</span><span class="p">)</span>
        <span class="c1">#set counter to zero</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__effmass_counter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="n">cell_params</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getCellParams</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="n">k_grid</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">getMPGrid</span><span class="p">(</span><span class="n">cell_params</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">k_grid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">10.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k_grid</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">k_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>

    <span class="n">Efermi</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getEfermi</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">,</span><span class="n">directID</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">eShift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">Efermi</span><span class="p">)</span><span class="o">+</span><span class="mf">10.0</span>

    <span class="n">step_holder</span><span class="o">=</span><span class="n">step</span>
    <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">step_holder</span><span class="p">))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
    <span class="n">temps</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">step</span><span class="p">)</span>

    <span class="c1">#some constants</span>
    <span class="n">h_bar</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">1.05457180</span><span class="o">*</span><span class="mf">10.0</span><span class="o">**-</span><span class="mf">34.0</span><span class="p">)</span>
    <span class="n">k_b</span>   <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">1.38064852</span><span class="o">*</span><span class="mf">10.0</span><span class="o">**-</span><span class="mf">23.0</span><span class="p">)</span>
    <span class="n">m_e</span>   <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">9.10938356</span><span class="o">*</span><span class="mf">10.0</span><span class="o">**-</span><span class="mf">31.0</span><span class="p">)</span>

    <span class="n">sf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k_b</span><span class="o">*</span><span class="n">m_e</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">h_bar</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)),(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span><span class="c1">#*numpy.power((1.0/cm2m),2.0)</span>


    <span class="k">for</span> <span class="n">temp_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temps</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">temp_step</span><span class="o">&lt;</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__effmass_counter__&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="n">want_dos_calc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">WanT_dos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">k_grid</span><span class="o">=</span><span class="n">k_grid</span><span class="p">,</span><span class="n">pdos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">boltzmann</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">eShift</span><span class="o">=</span><span class="n">eShift</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="n">temps</span><span class="p">[</span><span class="n">temp_step</span><span class="p">])</span>
        <span class="n">this_temp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%8.4f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">temps</span><span class="p">[</span><span class="n">temp_step</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">want_dos_ID</span><span class="p">,</span><span class="n">want_dos</span> <span class="ow">in</span> <span class="n">want_dos_calc</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">want_dos</span><span class="p">,</span><span class="n">want_dos_ID</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./effmass.x&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">effmass_datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.dat&#39;</span><span class="o">%</span><span class="n">want_dos_ID</span><span class="p">)</span>
            <span class="n">effmass_datafile_by_temp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_WanT_effmass.dat&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">effmass_datafile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">emdfo</span><span class="p">:</span>
                <span class="n">data_by_line</span> <span class="o">=</span> <span class="n">emdfo</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>



            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">effmass_datafile_by_temp</span><span class="p">,</span><span class="s1">&#39;a+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">emdfo</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">data_line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_by_line</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">temp_step</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">data_line</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">temp_as_str</span> <span class="o">=</span> <span class="s1">&#39;Temperature &#39;</span><span class="o">+</span><span class="n">data_by_line</span><span class="p">[</span><span class="n">data_line</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">data_line</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>

                                <span class="n">emass</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">data_by_line</span><span class="p">[</span><span class="n">data_line</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="n">e</span>
                                <span class="k">continue</span>
                            <span class="n">line_write</span> <span class="o">=</span> <span class="n">this_temp</span> <span class="o">+</span> <span class="n">data_by_line</span><span class="p">[</span><span class="n">data_line</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="c1">#+&#39; %s\n&#39;%(N_s)</span>
                            <span class="n">emdfo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line_write</span><span class="p">)</span>

        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__effmass_counter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">temp_step</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__effmass_counter__&#39;</span><span class="p">]</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

<span class="k">def</span> <span class="nf">_run_want_dos</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span><span class="n">k_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">project</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">num_e</span><span class="o">=</span><span class="mi">2001</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fermi_surface</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">compute_ham</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">proj_thr</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span><span class="n">proj_sh</span><span class="o">=</span><span class="mf">5.5</span><span class="p">):</span>
    <span class="n">nscf_ID</span><span class="o">=</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_nscf&#39;</span>

    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="n">Efermi</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getEfermi</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">,</span><span class="n">directID</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#    eShift=float(Efermi)+10.0</span>

    <span class="n">want_dos_calc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">WanT_dos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">energy_range</span><span class="o">=</span><span class="n">dos_range</span><span class="p">,</span><span class="n">k_grid</span><span class="o">=</span><span class="n">k_grid</span><span class="p">,</span><span class="n">pdos</span><span class="o">=</span><span class="n">project</span><span class="p">,</span><span class="n">boltzmann</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">num_e</span><span class="o">=</span><span class="n">num_e</span><span class="p">,</span><span class="n">eShift</span><span class="o">=</span><span class="n">proj_sh</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="n">cond_bands</span><span class="p">,</span><span class="n">fermi_surface</span><span class="o">=</span><span class="n">fermi_surface</span><span class="p">,</span><span class="n">compute_ham</span><span class="o">=</span><span class="n">compute_ham</span><span class="p">,</span><span class="n">proj_thr</span><span class="o">=</span><span class="n">proj_thr</span><span class="p">,)</span>


    <span class="k">for</span> <span class="n">want_dos_ID</span><span class="p">,</span><span class="n">want_dos</span> <span class="ow">in</span> <span class="n">want_dos_calc</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">want_dos</span><span class="p">,</span><span class="n">want_dos_ID</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./want_dos.x&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">project</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">spin_state</span> <span class="o">=</span> <span class="n">want_dos_ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">spin_state</span><span class="o">==</span><span class="s1">&#39;down&#39;</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_convert_tb_pdos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>    
            <span class="k">if</span> <span class="n">spin_state</span><span class="o">==</span><span class="s1">&#39;up&#39;</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_convert_tb_pdos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_convert_tb_pdos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">want_dos_calc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_combine_pol_pdos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>


<span class="k">def</span> <span class="nf">_convert_tb_pdos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    
        <span class="n">want_pdos_ext_glob</span> <span class="o">=</span> <span class="s1">&#39;_WanT_dos-*.dat&#39;</span>
        

        <span class="c1">#change the TB pdos file names so that they can be read by sumpdos</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spin_postfix</span><span class="o">=</span><span class="s1">&#39;_down&#39;</span>
            <span class="n">dat_postfix</span> <span class="o">=</span><span class="s1">&#39;_dn&#39;</span>
        <span class="k">elif</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">spin_postfix</span><span class="o">=</span><span class="s1">&#39;_up&#39;</span>
            <span class="n">dat_postfix</span> <span class="o">=</span><span class="s1">&#39;_up&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spin_postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="n">dat_postfix</span> <span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="n">rename_info_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;state #\s*(\d*): atom\s*(\d+)\s*\(\s*(\S*)\s*\).*wfc\s*(\d+)\s*\(l=(\d+).*\)\n&#39;</span><span class="p">)</span>
        <span class="c1">#first check the QE projwfc.x output for the orbital</span>
        <span class="c1">#and species label for each state #</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">qe_pdos_out_str</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getOutputString</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_pdos&#39;</span><span class="p">)</span>
            <span class="n">state_info_list</span> <span class="o">=</span> <span class="n">rename_info_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qe_pdos_out_str</span><span class="p">)</span>
            <span class="c1">#if it found the info on the states by their numbers</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state_info_list</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state_info_list</span><span class="p">)):</span>
                    <span class="n">state_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">atom_num</span>  <span class="o">=</span> <span class="n">state_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">atom_spec</span> <span class="o">=</span> <span class="n">state_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">wfc_num</span>   <span class="o">=</span> <span class="n">state_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">orb_l</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="c1">#translate atomic number &quot;l&quot; to orbital name (i.e. s,p,d,f)</span>
                    <span class="n">orb_type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">]</span>
             
                    <span class="c1">#the orig file name from WanT output</span>
                    <span class="n">orig_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_TB_WanT</span><span class="si">%s</span><span class="s1">_dos-</span><span class="si">%04d</span><span class="s1">.dat&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">dat_postfix</span><span class="p">,</span><span class="n">state_num</span><span class="p">)</span>

                    <span class="n">orig_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">orig_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">orig_path</span> <span class="p">):</span>
                        <span class="n">orig_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_TB_WanT</span><span class="si">%s</span><span class="s1">_dos-</span><span class="si">%04d</span><span class="s1">.dat&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">dat_postfix</span><span class="p">,</span><span class="n">state_num</span><span class="p">)</span>
                        <span class="n">orig_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">orig_name</span><span class="p">)</span>
                    <span class="c1">#the renamed filename</span>
                    <span class="n">rename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_TB</span><span class="si">%s</span><span class="s1">.pdos_atm#</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)_wfc#</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">spin_postfix</span><span class="p">,</span><span class="n">atom_num</span><span class="p">,</span><span class="n">atom_spec</span><span class="p">,</span><span class="n">wfc_num</span><span class="p">,</span><span class="n">orb_type</span><span class="p">[</span><span class="n">orb_l</span><span class="p">])</span>
                    <span class="n">rename_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">rename</span><span class="p">)</span>
                    <span class="c1">#finally we rename it</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">orig_path</span><span class="p">,</span> <span class="n">rename_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_combine_pol_pdos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="n">glob_ID</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_return_ID</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">step_type</span><span class="o">=</span><span class="s1">&#39;PAO-TB&#39;</span><span class="p">,</span><span class="n">last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">straight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">glob_ID</span> <span class="o">+=</span><span class="s1">&#39;_TB&#39;</span>

    <span class="n">glob_ID_up</span><span class="o">=</span><span class="n">glob_ID</span><span class="o">+</span><span class="s1">&#39;_up&#39;</span>
    <span class="n">glob_ID_dn</span><span class="o">=</span><span class="n">glob_ID</span><span class="o">+</span><span class="s1">&#39;_down&#39;</span>

    <span class="n">subdir</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>

    <span class="n">pdos_files_up</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pdos_atm*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">glob_ID_up</span><span class="p">)))</span>
    <span class="n">pdos_files_dn</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pdos_atm*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">glob_ID_dn</span><span class="p">)))</span>
                             
    <span class="k">for</span> <span class="n">pdos_file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdos_files_up</span><span class="p">)):</span>
        <span class="n">output_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">pdos_file_up</span> <span class="o">=</span> <span class="n">pdos_files_up</span><span class="p">[</span><span class="n">pdos_file</span><span class="p">]</span>
        <span class="n">pdos_file_dn</span> <span class="o">=</span> <span class="n">pdos_files_dn</span><span class="p">[</span><span class="n">pdos_file</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdos_file_up</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdfuo</span><span class="p">:</span>
            <span class="n">pdos_string_up</span> <span class="o">=</span> <span class="n">pdfuo</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdos_file_dn</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdfdo</span><span class="p">:</span>
            <span class="n">pdos_string_dn</span> <span class="o">=</span> <span class="n">pdfdo</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdos_string_up</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">entry_up</span> <span class="o">=</span> <span class="n">pdos_string_up</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">entry_dn</span> <span class="o">=</span> <span class="n">pdos_string_dn</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">energy</span> <span class="o">=</span> <span class="n">entry_up</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">val_up</span> <span class="o">=</span> <span class="n">entry_up</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">val_dn</span> <span class="o">=</span> <span class="n">entry_dn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
                <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">energy</span><span class="p">,</span><span class="n">val_up</span><span class="p">,</span><span class="n">val_dn</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>



        <span class="n">output_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_list</span><span class="p">)</span>

        <span class="n">input_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdos_file_up</span><span class="p">)</span>
        <span class="n">input_file_name_split</span> <span class="o">=</span> <span class="n">input_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_file_name</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_TB.&#39;</span><span class="o">+</span><span class="n">input_file_name_split</span>
        <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">output_file_name</span><span class="p">)</span>        

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdfco</span><span class="p">:</span>
            <span class="n">pdfco</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_str</span><span class="p">)</span>


<div class="viewcode-block" id="tb_plotter"><a class="viewcode-back" href="../prep.html#prep.tb_plotter">[docs]</a><span class="k">class</span> <span class="nc">tb_plotter</span><span class="p">:</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	Class for adding common plotting functions from AFLOWpi.plot module to the high level user </span>
<span class="sd">	interface. </span>

<span class="sd">	&#39;&#39;&#39;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">calcs</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="o">=</span><span class="n">calcs</span>

<div class="viewcode-block" id="tb_plotter.opdos"><a class="viewcode-back" href="../prep.html#prep.tb_plotter.opdos">[docs]</a>	<span class="k">def</span> <span class="nf">opdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">opdos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="n">yLim</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="n">runlocal</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="n">postfix</span><span class="p">,</span><span class="n">tight_binding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Plot Orbital Projected DOS of PAO-TB Representation&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="tb_plotter.transport"><a class="viewcode-back" href="../prep.html#prep.tb_plotter.transport">[docs]</a>	<span class="k">def</span> <span class="nf">transport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">x_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.plot.epsilon in the high level user interface.</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the plotter object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      nm (bool): whether to plot in nanometers for spectrum or eV for energy</span>
<span class="sd">		      runlocal (bool): a flag to choose whether or not to run the wrapped function now</span>
<span class="sd">	                                or write it to the _ID.py to run during the workflow</span>
<span class="sd">		</span>
<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">transport_plots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="n">runlocal</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="n">postfix</span><span class="p">,</span><span class="n">x_range</span><span class="o">=</span><span class="n">x_range</span><span class="p">)</span>
		
		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Plot Optical and Transport properties&#39;</span>
		<span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="tb_plotter.optical"><a class="viewcode-back" href="../prep.html#prep.tb_plotter.optical">[docs]</a>	<span class="k">def</span> <span class="nf">optical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">x_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.plot.epsilon in the high level user interface.</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the plotter object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      nm (bool): whether to plot in nanometers for spectrum or eV for energy</span>
<span class="sd">		      runlocal (bool): a flag to choose whether or not to run the wrapped function now</span>
<span class="sd">	                                or write it to the _ID.py to run during the workflow</span>
<span class="sd">		</span>
<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>


		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">optical_plots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="n">runlocal</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="n">postfix</span><span class="p">,</span><span class="n">x_range</span><span class="o">=</span><span class="n">x_range</span><span class="p">)</span>
		
		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Plot Optical  properties&#39;</span>
		<span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>



<div class="viewcode-block" id="tb_plotter.bands"><a class="viewcode-back" href="../prep.html#prep.tb_plotter.bands">[docs]</a>	<span class="k">def</span> <span class="nf">bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">DOSPlot</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="n">yLim</span><span class="p">,</span><span class="n">DOSPlot</span><span class="o">=</span><span class="n">DOSPlot</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="n">runlocal</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="n">postfix</span><span class="p">,</span><span class="n">tight_banding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Plot Electronic Band Structure of PAO-TB Representation&#39;</span>
            <span class="k">if</span> <span class="n">DOSPlot</span><span class="o">==</span><span class="s1">&#39;DOS&#39;</span><span class="p">:</span>
                    <span class="n">calc_type</span><span class="o">+=</span><span class="s1">&#39; with Density of States&#39;</span>
            <span class="k">if</span> <span class="n">DOSPlot</span><span class="o">==</span><span class="s1">&#39;APDOS&#39;</span><span class="p">:</span>
                    <span class="n">calc_type</span><span class="o">+=</span><span class="s1">&#39; with APDOS&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="tb_plotter.dos"><a class="viewcode-back" href="../prep.html#prep.tb_plotter.dos">[docs]</a>	<span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="k">pass</span></div></div>


<span class="k">def</span> <span class="nf">_run_tb_ham_prep</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">unoccupied_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">paw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">kp_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
	<span class="n">execPrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
	<span class="n">execPostfix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">oneCalcID</span> <span class="o">=</span> <span class="n">ID</span>


        <span class="k">def</span> <span class="nf">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.out&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">errorList</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;from (.*) : error #.*\n&#39;</span><span class="p">,</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errorList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>        
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2">.out -- ABORTING ACBN0 LOOP&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2">.out -- ABORTING ACBN0 LOOP&quot;</span><span class="o">%</span><span class="n">ID</span>                    
                <span class="k">raise</span> <span class="ne">SystemExit</span>



        <span class="k">if</span> <span class="s1">&#39;__runList__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>

            
	<span class="k">if</span> <span class="n">config</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;forced config </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>

	<span class="k">else</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;espresso&#39;</span>


        <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
	<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span>

        <span class="k">if</span> <span class="s1">&#39;scf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">npool</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_get_pool_num</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>        

                <span class="k">if</span> <span class="n">npool</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;npool[s]*\s*(?:\d*)&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">execPostfixPrime</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;npool[s]*\s*(?:\d*)&#39;</span><span class="p">,</span><span class="s1">&#39;npool </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">npool</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">execPostfixPrime</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="c1">##################################################################################################################</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>


            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            
<span class="c1">#            nscf_calc,nscf_ID= AFLOWpi.scfuj.nscf_nosym_noinv(oneCalc,ID,kpFactor=1.50,unoccupied_states=unoccupied_bands)	</span>
            <span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">nscf_nosym_noinv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">kpFactor</span><span class="o">=</span><span class="n">kp_factor</span><span class="p">,</span><span class="n">unoccupied_states</span><span class="o">=</span><span class="n">unoccupied_bands</span><span class="p">)</span>	



        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;if we are restarting from a job killed from going walltime </span>
<span class="sd">            try to load ID_nscf and if we can&#39;t then just make a new one&#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nscf_ID</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_nscf&#39;</span> <span class="o">%</span> <span class="n">ID</span>
                <span class="n">nscf_calc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">nscf_ID</span><span class="p">)</span>                
                <span class="sd">&#39;&#39;&#39;we have to make sure nscf step has the correct walltime and start time if it&#39;s a restart&#39;&#39;&#39;</span>
                <span class="n">nscf_calc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">nscf_nosym_noinv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">kpFactor</span><span class="o">=</span><span class="mf">1.50</span><span class="p">,</span><span class="n">unoccupied_states</span><span class="o">=</span><span class="n">unoccupied_bands</span><span class="p">)</span>	

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



<span class="c1">##################################################################################################################</span>
        <span class="k">if</span> <span class="s1">&#39;nscf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>


            <span class="k">try</span><span class="p">:</span>
                <span class="n">npool</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_get_pool_num</span><span class="p">(</span><span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">)</span>        

                <span class="k">if</span> <span class="n">npool</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;npool\s*(?:\d+)&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">execPostfixPrime</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;npool\s*(?:\d+)&#39;</span><span class="p">,</span><span class="s1">&#39;npool </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">npool</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">execPostfixPrime</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_writeEfermi</span><span class="p">(</span><span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">)</span>


            <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">nscf_ID</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nscf&#39;</span><span class="p">)</span>
	
<span class="c1">##################################################################################################################</span>
        <span class="n">pdos_calc</span><span class="p">,</span><span class="n">pdos_ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">projwfc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">paw</span><span class="o">=</span><span class="n">paw</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;northo&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">):</span>
            <span class="n">execPostfix</span><span class="o">+=</span><span class="s1">&#39; -northo 1&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;pdos&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>
            <span class="n">pdosPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;engine_dir&#39;</span><span class="p">),</span><span class="s1">&#39;projwfc.x&#39;</span><span class="p">)</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">pdos_calc</span><span class="p">,</span><span class="n">pdos_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="s1">&#39;projwfc.x&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="n">pdosPath</span><span class="p">)</span>
<span class="c1">#############</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pdos&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">pdos_ID</span><span class="p">)</span>



	<span class="n">eFermi</span><span class="o">=</span><span class="mf">0.0</span>


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_form_TB_dir</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
	<span class="n">eFermi</span><span class="o">=</span><span class="mf">10.0</span>

        <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">nscf_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span>





        <span class="c1">#        match1 = float(re.findall(r&#39;number of electrons\s*=\s*([0-9.])&#39;,outfile)[-1])/2.0</span>



        <span class="c1"># AFLOWpi.prep._run_want_dos(__submitNodeName__,oneCalc,ID,dos_range=[-1,1],project=False,num_e=2000,cond_bands=False,fermi_surface=False)        </span>
        
        <span class="c1"># dos_out = os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;%s_WanT_dos.dat&#39;%ID)</span>

        <span class="c1"># with open(dos_out,&#39;r&#39;) as ifo:</span>
        <span class="c1">#         outfile=ifo.readlines()</span>


        <span class="c1"># en_list=[]</span>
        <span class="c1"># va_list=[]</span>
        <span class="c1"># thresh = 0.00005</span>
        <span class="c1"># for i in range(len(outfile)):</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         en,val =  map(float,outfile[i].split())</span>
        <span class="c1">#         en_list.append(en)</span>
        <span class="c1">#         va_list.append(val)</span>
        <span class="c1">#     except:</span>
        <span class="c1">#         pass</span>
        <span class="c1"># homo=0.0</span>
        <span class="c1"># for i in range(len(en_list)):</span>
        <span class="c1">#     if en_list[i]&lt;1.0 and en_list[i]&gt;-1.0:</span>
        <span class="c1">#         if va_list[i]&gt;thresh:</span>
        <span class="c1">#             homo = en_list[i]</span>


        <span class="n">dos_fermi</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_WanT_dos.efermi&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dos_fermi</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifo</span><span class="p">:</span>
                <span class="n">ifo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>




<span class="k">def</span> <span class="nf">_clean_want_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">want_stdout_path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">_WanT_bands.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">want_stdout_path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">_WanT_bands_up.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">want_stdout_path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_obj</span><span class="p">:</span>
        <span class="n">in_string</span> <span class="o">=</span> <span class="n">in_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span>

    <span class="n">plot_bool</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">path_name</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">path_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">path_split</span><span class="p">:</span>
        <span class="n">path_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span>  <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]):</span>

            <span class="n">plot_bool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_bool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">gg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;  Number of kpts in each segment</span><span class="se">\n</span><span class="s2">((?:.*:\W+(?:\d*)</span><span class="se">\n</span><span class="s2">)*)&quot;</span><span class="p">,</span><span class="n">in_string</span><span class="p">)</span>
<span class="c1">#    num = [int(x) for x in re.findall(&#39;line.*:\W+(\d+)&#39;,gg[0])]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;line\s*\d+:\s*(\d+)\s*</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">in_string</span><span class="p">)]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">include</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1">#print path_name</span>
    <span class="n">output_path_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)):</span>
        <span class="n">total</span><span class="o">+=</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_bool</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">output_path_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">path_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_path_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">path_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_path_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">path_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">include</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_bool</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">include</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="nb">print</span> <span class="n">include</span>
    <span class="c1">#    print print_out</span>
    <span class="n">output_path_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">path_name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> 
    
    <span class="n">want_bands_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_bands_want.dat&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">want_bands_data_path</span><span class="p">):</span>
        <span class="n">data_file_list</span><span class="o">=</span><span class="p">[</span><span class="n">want_bands_data_path</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">want_bands_data_path_up</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_bands_want_up.dat&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">want_bands_data_path_dn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_bands_want_down.dat&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">data_file_list</span><span class="o">=</span><span class="p">[</span><span class="n">want_bands_data_path_up</span><span class="p">,</span><span class="n">want_bands_data_path_dn</span><span class="p">,]</span>



    <span class="n">ret_data</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">want_bands_data_path</span> <span class="ow">in</span> <span class="n">data_file_list</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">want_bands_data_path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_obj</span><span class="p">:</span>
            <span class="n">bands_dat</span> <span class="o">=</span> <span class="n">in_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">split_bands</span> <span class="o">=</span> <span class="n">bands_dat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">split_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">per_band</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">split_bands</span><span class="p">:</span>
        <span class="c1">#    print len(i.strip())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">per_band</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">split_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_band</span><span class="p">)</span>
                <span class="n">per_band</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">per_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


        <span class="n">final_data</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split_data</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split_data</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">include</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">final_data</span><span class="o">+=</span> <span class="n">split_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">final_data</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            
        <span class="n">ret_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_data</span><span class="p">)</span>
        <span class="n">want_bands_data_path_new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">want_bands_data_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_cleaned.dat&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">want_bands_data_path_new</span>
<span class="c1">#        want_bands_data_path_new=want_bands_data_path</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">want_bands_data_path_new</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_obj</span><span class="p">:</span>
            <span class="n">in_file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_data</span><span class="p">)</span>

<span class="c1">#    return ret_data</span>

<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">logging</span> 
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">AFLOWpi.qe</span>
<span class="kn">import</span> <span class="nn">__main__</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">AFLOWpi.plot</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">filecmp</span>


<span class="c1">#########################################################################################################################</span>
<span class="c1">#########################################################################################################################</span>
<span class="c1">##LOCKING WRAPPERS</span>
<span class="c1">#########################################################################################################################</span>
<span class="c1">######################################################################################################################### </span>

<span class="k">def</span> <span class="nf">_check_lock</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	A function that is wrapped on another function to check if the script </span>
<span class="sd">	has already run through to prevent certain functions in the &lt;ID&gt;.py </span>
<span class="sd">	from running again after a restart or a loop like scfuj.</span>

<span class="sd">	Arguments:</span>
<span class="sd">	      func (func): needed for the wrapper</span>
<span class="sd">	      oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd"> 	      ID (str): ID string for the particular calculation and step</span>
<span class="sd">	      *args: additional arguments </span>

<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      **kwargs: additional keyword arguments</span>

<span class="sd">	Returns:</span>
<span class="sd">	      Returns either False or the calculation dictionary and its ID hash</span>

<span class="sd">	&#39;&#39;&#39;</span>

	<span class="k">if</span> <span class="s1">&#39;override_lock&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
		
		<span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span><span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">new_ID</span><span class="o">=</span><span class="n">ID</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.qsub&#39;</span> <span class="o">%</span> <span class="n">new_ID</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span><span class="o">=</span><span class="n">oneCalc</span>
            <span class="n">f</span><span class="o">=</span><span class="n">ID</span>
            <span class="n">new_calcs</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">output_calcs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>

        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>



<div class="viewcode-block" id="newstepWrapper"><a class="viewcode-back" href="../prep.html#prep.newstepWrapper">[docs]</a><span class="k">def</span> <span class="nf">newstepWrapper</span><span class="p">(</span><span class="n">pre</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A function that wraps another function that is to be run before the </span>
<span class="sd">    a certain function runs. Its use must be in the form:</span>
<span class="sd">    </span>
<span class="sd">    @newstepwrapper(func)</span>
<span class="sd">    def being_wrapped(oneCalc,ID,*args,**kwargs)</span>

<span class="sd">    where func is the function that is to be run before and being_wrapped</span>
<span class="sd">    is the function being wrapped. oneCalc and ID must be the first two </span>
<span class="sd">    arguments in the function being wrapped. additional arguments and </span>
<span class="sd">    keyword arguments can follow.</span>
<span class="sd">       </span>
<span class="sd">    Arguments:</span>
<span class="sd">          pre (func): function object that is to be wrapped before another function runs</span>

<span class="sd">    Returns:</span>
<span class="sd">          the returned values of function being wrapped or the execution of the function</span>
<span class="sd">          is skipped entirely.</span>
<span class="sd">	</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">args</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>

			<span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span> <span class="o">=</span> <span class="n">pre</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

			<span class="k">if</span> <span class="kc">False</span><span class="o">==</span><span class="n">new_oneCalc</span> <span class="ow">and</span> <span class="kc">False</span><span class="o">==</span><span class="n">new_ID</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>

				<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">new_oneCalc</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">pass</span>

		<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		
		<span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">call</span>
    <span class="k">return</span> <span class="n">decorate</span></div>


<span class="k">def</span> <span class="nf">_lock_transform</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	To be used with AFLOWpi.prep.newstepWrapper to stop a function from being run in the </span>
<span class="sd">	_&lt;ID&gt;.py python scripts generated by AFLOWpi to prohibit the wrapped function </span>
<span class="sd">	from running if it has already run.</span>

<span class="sd">	Arguments:</span>
<span class="sd">             oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">             ID (str): ID string for the particular calculation and step</span>

<span class="sd">	  </span>
<span class="sd">	Returns:</span>
<span class="sd">             oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">             ID (str): ID string for the particular calculation and step</span>
<span class="sd">	     </span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="sd">&#39;&#39;&#39;make sure it only goes through this once&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">subdir</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;set prev to current ID so that we can check if we have already transformed&#39;&#39;&#39;</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
        
        <span class="sd">&#39;&#39;&#39;update status of the calc after it&#39;s transformed&#39;&#39;&#39;</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;Start&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;Complete&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;Restart&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;Error&quot;</span><span class="p">:</span><span class="s1">&#39;None&#39;</span><span class="p">})</span>

        <span class="sd">&quot;&quot;&quot;save it so if it&#39;s loaded by a scipt it&#39;ll have the correct vals&quot;&quot;&quot;</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>




<span class="c1">#########################################################################################################################</span>
<span class="c1">#########################################################################################################################</span>
<span class="c1">##QE INPUT CLEANING</span>
<span class="c1">#########################################################################################################################</span>
<span class="c1">######################################################################################################################### </span>

<span class="k">def</span> <span class="nf">_resolveEqualities</span><span class="p">(</span><span class="n">inputString</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Takes an input string that may or may not have text patterns of the form:</span>

<span class="sd">    ===EQN===</span>

<span class="sd">    where EQN is some syntactically correct simple equations like 5+3. _AFLOWpi keywords</span>
<span class="sd">    can be used in the reference input. An example of this could be in to generate a set </span>
<span class="sd">    of calculations used to make an energy map of one layer of a layered material sliding</span>
<span class="sd">    across the other one might make their QE ATOMIC_POSITIONS card in their reference </span>
<span class="sd">    input like so:</span>

<span class="sd">    ATOMIC_POSTIONS {crystal}</span>
<span class="sd">    _AFLOWPI_A_ ===0.00+_AFLOWPI_XSHIFT_===  ===0.00+_AFLOWPI_YSHIFT_===  0.00</span>
<span class="sd">    _AFLOWPI_A_ ===0.50+_AFLOWPI_XSHIFT_===  ===0.50+_AFLOWPI_YSHIFT_===  0.00</span>
<span class="sd">    _AFLOWPI_A_ ===0.00+_AFLOWPI_XSHIFT_===  ===0.00+_AFLOWPI_YSHIFT_===  0.00</span>
<span class="sd">    _AFLOWPI_A_ ===0.50+_AFLOWPI_XSHIFT_===  ===0.50+_AFLOWPI_YSHIFT_===  0.00</span>
<span class="sd">    _AFLOWPI_A_ 0.00                     0.00                     0.75</span>
<span class="sd">    _AFLOWPI_A_ 0.00                     0.50                     0.75</span>
<span class="sd">    _AFLOWPI_A_ 0.50                     0.00                     0.75</span>
<span class="sd">    _AFLOWPI_A_ 0.50                     0.50                     0.75</span>

<span class="sd">    With their user script containing a range of values for _AFLOWPI_XSHIFT_ and _AFLOWPI_YSHIFT_.	</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          inputString (str): a string of text</span>

<span class="sd">    Returns:</span>
<span class="sd">          a string of text that has the equations (i.e. ===EQN===) replaced with values</span>

<span class="sd">    &#39;&#39;&#39;</span>


    <span class="c1">#search for the pattern</span>
    <span class="n">equalities</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">ur&#39;===[^,\n]*===&#39;</span><span class="p">,</span><span class="n">inputString</span><span class="p">)</span>
    <span class="n">allvars</span><span class="o">=</span><span class="p">{}</span>
    <span class="c1">#get a all the variables and their values into a dictionary</span>

    <span class="n">origEquality</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">equalities</span><span class="p">)</span>
    <span class="n">equalDict</span><span class="o">=</span><span class="p">{}</span>


    <span class="k">for</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">equalities</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">evalResult</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">replacement</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">replacementEval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">evalResult</span><span class="p">)</span>
            <span class="n">equalDict</span><span class="p">[</span><span class="n">replacement</span><span class="p">]</span><span class="o">=</span><span class="n">replacementEval</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">orig</span><span class="p">,</span><span class="n">replacement</span> <span class="ow">in</span> <span class="n">equalDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inputString</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span><span class="n">replacement</span><span class="p">,</span><span class="n">inputString</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">inputString</span>



<span class="k">def</span> <span class="nf">_removeComments</span><span class="p">(</span><span class="n">inputString</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Removes any text from a string that follows either a # or ! on to the end of</span>
<span class="sd">    that line.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          inputString (str): input string with ! or # as comment characters</span>


<span class="sd">    Returns:</span>
<span class="sd">          the same string with the comments removed</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">inputString</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;!.*\n&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">inputString</span><span class="p">)</span>
    <span class="n">inputString</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;#.*\n&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">inputString</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inputString</span>

<div class="viewcode-block" id="remove_blank_lines"><a class="viewcode-back" href="../prep.html#prep.remove_blank_lines">[docs]</a><span class="k">def</span> <span class="nf">remove_blank_lines</span><span class="p">(</span><span class="n">inp_str</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Removes whitespace lines of text</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          inp_str (str): input string of text</span>

<span class="sd">    Returns:</span>
<span class="sd">          the same string with blank lines removed</span>

<span class="sd">    &#39;&#39;&#39;</span>
	
    <span class="n">out_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">inp_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">out_str</span><span class="o">+=</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">return</span> <span class="n">out_str</span></div>



<span class="k">def</span> <span class="nf">_cleanInputStringSCF</span><span class="p">(</span><span class="n">inputString</span><span class="p">,</span><span class="n">convert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	Sanitizes QE input files by removing whitespace, commented out text, or any other</span>
<span class="sd">	unnecessary characters.</span>
<span class="sd">    </span>
<span class="sd">	Arguments:</span>
<span class="sd">	      inputString (str): a string of a QE input file</span>

<span class="sd">	Returns:</span>
<span class="sd">	      a string of the sanitized QE input file</span>

<span class="sd">	&#39;&#39;&#39;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entering _cleanInputString&#39;</span><span class="p">)</span>

        <span class="n">removeBlank</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_removeComments</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>

	<span class="n">inputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">remove_blank_lines</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
        <span class="n">splitInput</span> <span class="o">=</span> <span class="n">inputString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>         

        <span class="k">for</span> <span class="n">lineNum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)):</span> 
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;\s*&amp;control\s*&#39;</span><span class="p">,</span><span class="n">splitInput</span><span class="p">[</span><span class="n">lineNum</span><span class="p">]))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
               <span class="n">splitInput</span><span class="p">[</span><span class="n">lineNum</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
           <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">splitLines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">splitInput</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">oneLine</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>            
            <span class="k">except</span><span class="p">:</span>
                <span class="n">oneLine</span><span class="o">=</span><span class="n">lines</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oneLine</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">splitLines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oneLine</span><span class="p">)</span>

        <span class="n">inputString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitLines</span><span class="p">)</span>
        
        <span class="n">atomicSpecRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;ATOMIC_SPECIES\s*\n((?:(?:\s*[A-Za-z0-9]+)\s+(?:[0-9.]+)\s+(?:.+)\n*)+)(?=(?:[A-Z_\s]+\n)|)&#39;</span><span class="p">,(</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">))</span>

	<span class="n">speciesSortList</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">try</span><span class="p">:</span>
            <span class="n">speciesArr</span> <span class="o">=</span> <span class="n">atomicSpecRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
            <span class="n">speciesArr</span> <span class="o">=</span> <span class="n">speciesArr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">splitSpecies</span> <span class="o">=</span> <span class="n">speciesArr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
	<span class="k">except</span><span class="p">:</span>
            <span class="n">splitSpecies</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                                                                                                                                                                         
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitSpecies</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">item</span><span class="o">!=</span><span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;!&#39;</span><span class="p">:</span>

                    <span class="n">speciesSplit</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39; &#39;</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
                    
                    <span class="k">if</span> <span class="n">speciesSplit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">speciesSortList</span><span class="p">:</span>
                        <span class="n">speciesSortList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speciesSplit</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        
        <span class="n">testDictString</span><span class="o">=</span><span class="s1">&#39;ATOMIC_SPECIES</span><span class="se">\n</span><span class="s1">&#39;</span>        

	<span class="k">for</span> <span class="n">speciesSplit</span> <span class="ow">in</span> <span class="n">speciesSortList</span><span class="p">:</span>
		<span class="n">testDictString</span><span class="o">+=</span><span class="n">speciesSplit</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">testDictString</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cleanedInputString</span> <span class="o">=</span> <span class="n">atomicSpecRegex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;</span><span class="si">%s</span><span class="s1">\n&#39;</span> <span class="o">%</span> <span class="n">testDictString</span><span class="p">,</span><span class="n">inputString</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
           <span class="n">cleanedInputString</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;ntyp\s*=\s*\d+&#39;</span><span class="p">,</span><span class="s1">&#39;ntyp = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">speciesSortList</span><span class="p">),</span><span class="n">cleanedInputString</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">atomicPosRegex</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">atomic_positions</span><span class="p">(</span><span class="n">cleanedInputString</span><span class="p">,</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="s1">&#39;regex&#39;</span><span class="p">)</span>

        <span class="n">pos</span><span class="p">,</span><span class="n">flag</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">atomic_positions</span><span class="p">(</span><span class="n">cleanedInputString</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">posList</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">atomic_positions</span><span class="p">(</span><span class="n">cleanedInputString</span><span class="p">)</span>
            <span class="n">posList</span><span class="p">,</span><span class="n">flag</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">posList</span><span class="p">)</span>
            <span class="n">posList</span><span class="o">=</span><span class="n">posList</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">posList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">posList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">posList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">posList</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">posList</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">posList</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>

        <span class="n">posListNew</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">posListNewString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">posList</span><span class="p">)</span>
        <span class="n">posListNewString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">attachPosFlags</span><span class="p">(</span><span class="n">posListNewString</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span>
        <span class="n">nat</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">posList</span><span class="p">)</span>

        

        <span class="n">cleanedInputString</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;nat\s*=\s*\d+&#39;</span><span class="p">,</span><span class="s1">&#39;nat = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nat</span><span class="p">,</span><span class="n">cleanedInputString</span><span class="p">)</span>


        <span class="n">cellParamRegex</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">atomic_positions</span><span class="p">(</span><span class="n">cleanedInputString</span><span class="p">,</span><span class="s1">&#39;modifier&#39;</span><span class="p">,</span><span class="s1">&#39;regex&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellParamRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">inputString</span><span class="p">)):</span>
            <span class="n">paramUnits</span><span class="o">=</span><span class="n">cellParamRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">inputString</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">paramUnits</span> <span class="o">=</span> <span class="n">paramUnits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            

        <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">cleanedInputString</span><span class="p">)</span>
        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">posListNewString</span> 
        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">paramUnits</span>
        <span class="n">cleanedInputString</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)</span>
        
	<span class="k">if</span> <span class="n">convert</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
		<span class="n">cleanedInputString</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_transformInput</span><span class="p">(</span><span class="n">cleanedInputString</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting _cleanInputString&#39;</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">cleanedInputString</span>







<span class="k">def</span> <span class="nf">_parseRef</span><span class="p">(</span><span class="n">refFile</span><span class="p">,</span><span class="n">dictFlag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	Parses the input reference file and extract all of the information</span>
<span class="sd">	it then organizes it in a standard way and is used to create a </span>
<span class="sd">	unique hash checksum for the fortran namelist input. This is so spacing</span>
<span class="sd">	and order of namelist input data will not affect the checksum of each</span>
<span class="sd">	unique calculation input file</span>

<span class="sd">	Arguments:</span>
<span class="sd"> 	      refFile (str): a string of the input reference file</span>

<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      dictFlag (bool): whether you want to have a string of the cleaned up text or a </span>
<span class="sd">   	                 tokenized dictionary of it.</span>
<span class="sd">	</span>

<span class="sd">	Returns: </span>
<span class="sd">    	      Dictionary or String</span>
<span class="sd">	</span>
<span class="sd">        &#39;&#39;&#39;</span>


        <span class="n">refFile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_removeComments</span><span class="p">(</span><span class="n">refFile</span><span class="p">)</span>

	<span class="n">refFile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">remove_blank_lines</span><span class="p">(</span><span class="n">refFile</span><span class="p">)</span>
        <span class="n">refFileSplit</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">refFile</span><span class="p">)</span>

        <span class="n">refFileSplit</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_orderSplitInput</span><span class="p">(</span><span class="n">refFileSplit</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">]</span>
        <span class="n">refFile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">refFileSplit</span><span class="p">)</span>
        <span class="n">refFileSplit</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">refFile</span><span class="p">)</span>

	<span class="c1">######################</span>
	<span class="c1">####ATOMIC SPECIES####</span>
	<span class="c1">######################</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">speciesArr</span><span class="o">=</span><span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
                <span class="n">splitSpecies</span> <span class="o">=</span> <span class="n">speciesArr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">speciesSortList</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitSpecies</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">speciesSplit</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                    <span class="n">speciesSortList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speciesSplit</span><span class="p">)</span>
                    <span class="n">speciesSortList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">speciesSortList</span><span class="p">)</span>
                    <span class="n">speciesSplit</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">speciesSortList</span><span class="p">)</span>
                    <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">speciesSplit</span>
        
               
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

	<span class="c1">######################</span>
	<span class="c1">###ATOMIC POSITIONS###</span>
	<span class="c1">######################</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">splitAtomicPos</span><span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
            <span class="n">splitAtomicPos</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitAtomicPos</span><span class="p">))</span>
            <span class="n">atomPosSortList</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitAtomicPos</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">atomSplit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="n">formattedAtomPos</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%3.3s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">atomSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%16.14f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">atomSplit</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">atomSplit</span><span class="p">))])</span>

                            
                            <span class="n">atomPosSortList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formattedAtomPos</span><span class="p">)</span>

            <span class="n">flagsSplit</span><span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>

            <span class="n">atomPosSortList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atomPosSortList</span><span class="p">)</span>
            <span class="n">positionSplit</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atomPosSortList</span><span class="p">)</span>
            <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positionSplit</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">refFile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">refFileSplit</span><span class="p">)</span>

	<span class="c1">###################</span>
	<span class="c1">####CELL PARAMS####</span>
	<span class="c1">###################</span>

        <span class="n">refFileSplit</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">refFile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;celldm&#39;</span><span class="p">,</span><span class="n">item</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">celldm</span> <span class="o">=</span> <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
                <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%14.12f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">celldm</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">kpointString</span> <span class="o">=</span> <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
        <span class="n">kpointMod</span> <span class="o">=</span> <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span>


        <span class="n">kpointSplit</span> <span class="o">=</span>  <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kpointString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">kpointSplitFixed</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kpointSplit</span><span class="p">:</span>
            <span class="n">splitX</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">splitX</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">splitX</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">splitX</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.16f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">splitX</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">kpointSplitFixed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitX</span><span class="p">))</span>

        <span class="n">kpointString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kpointSplitFixed</span><span class="p">))</span>

        <span class="n">refFileSplit</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpointString</span>

        
        
        <span class="n">refFile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">refFileSplit</span><span class="p">)</span>


        <span class="sd">&#39;&#39;&#39;sorting each of the namelists&#39;&#39;&#39;</span>
        <span class="n">refFileSplit</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">refFile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">namelist</span><span class="p">,</span><span class="n">items</span> <span class="ow">in</span> <span class="n">refFileSplit</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="s1">&#39;&amp;&#39;</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">:</span>
                <span class="n">refFileSplit</span><span class="p">[</span><span class="n">namelist</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        
        <span class="n">refFile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">refFileSplit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">refFile</span>

        <span class="c1">#######################################################################################################</span>
        <span class="c1">####TO BE COMPLETED TO BE COMPLETED TO BE COMPLETED TO BE COMPLETED TO BE COMPLETED TO BE COMPLETED ###</span>
        <span class="c1">#######################################################################################################</span>

	<span class="c1">###################</span>
	<span class="c1">###OCCUPATIONS#####</span>
	<span class="c1">###################</span>
	<span class="n">OCCNLRegex</span>      <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(OCCUPATIONS\s*\n)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
	<span class="n">OCCRegex</span>     <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(?:OCCUPATIONS\s*\n)((?:[A-Za-z0-9|\s|.]+\n*)+)(?=(?:[A-Z|_|\s]+\n)|)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
	<span class="n">OCCSortList</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>

			<span class="n">inputStr</span><span class="o">+=</span><span class="n">OCCNLRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">refFile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="k">pass</span>
	
		<span class="k">try</span><span class="p">:</span>
			<span class="n">OCCArr</span> <span class="o">=</span> <span class="n">OCCRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">refFile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

			<span class="n">splitOCC</span> <span class="o">=</span> <span class="n">OCCArr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitOCC</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">item</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
				<span class="n">atomSplit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
				<span class="n">formattedOCC</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">atomSplit</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atomSplit</span><span class="p">))])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
				<span class="n">OCCSortList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formattedOCC</span><span class="p">)</span>
		<span class="n">OCCSortList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">OCCSortList</span><span class="p">)</span>
		<span class="n">testDictString</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
		<span class="k">for</span> <span class="n">formattedOCC</span> <span class="ow">in</span> <span class="n">OCCSortList</span><span class="p">:</span>
			<span class="n">inputStr</span><span class="o">+=</span><span class="n">formattedOCC</span>
			<span class="n">testDictString</span><span class="o">+=</span><span class="n">formattedOCC</span>
		<span class="n">inDict</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CELLPARAM_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">testDictString</span>
			
	<span class="k">except</span><span class="p">:</span>
		<span class="k">pass</span>


	<span class="c1">###################</span>
	<span class="c1">####CONSTRAINTS####</span>
	<span class="c1">###################</span>
        <span class="n">CONSTNLRegex</span>      <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(CONSTRAINTS\s*\n)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
	<span class="n">CONSTRegex</span>     <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;(?:CONSTRAINTS\s*\n)((?:[a-z0-9\s.&#39;_]+\n*)+)(?=(?:[A-Z_\s]+\n)|)&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
	<span class="n">CONSTSortList</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>

			<span class="n">inputStr</span><span class="o">+=</span><span class="n">CONSTNLRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">refFile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="k">pass</span>
	
		<span class="k">try</span><span class="p">:</span>
			<span class="n">CONSTArr</span> <span class="o">=</span> <span class="n">CONSTRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">refFile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

			<span class="n">splitCONST</span> <span class="o">=</span> <span class="n">CONSTArr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitCONST</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">item</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
				
				<span class="n">atomSplit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
				
				<span class="n">formattedCONST</span> <span class="o">=</span> <span class="n">atomSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">atomSplit</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">atomSplit</span><span class="p">))])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
				<span class="n">CONSTSortList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formattedCONST</span><span class="p">)</span>
		<span class="n">CONSTSortList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">CONSTSortList</span><span class="p">)</span>
		<span class="n">testDictString</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
		<span class="k">for</span> <span class="n">formattedCONST</span> <span class="ow">in</span> <span class="n">CONSTSortList</span><span class="p">:</span>
			<span class="n">inputStr</span><span class="o">+=</span><span class="n">formattedCONST</span>
			<span class="n">testDictString</span><span class="o">+=</span><span class="n">formattedCONST</span>
		<span class="n">inDict</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONSTRAINTS_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">testDictString</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="c1">###################</span>
	<span class="c1">###ATOMIC FORCES###</span>
	<span class="c1">###################</span>

	<span class="n">atomicForNLRegex</span>      <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(ATOMIC_FORCES\s*\n)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
	<span class="n">atomicForRegex</span>     <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(?:ATOMIC_FORCES\s*\n)((?:[A-Za-z0-9]+\s+(?:(?:[0-9|.]+)\s*)</span><span class="si">{3}</span><span class="s1">\n*)+)(?=(?:[A-Z|_|\s]+\n)|)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
	<span class="n">atomForSortList</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>

			<span class="n">inputStr</span><span class="o">+=</span><span class="n">atomicForNLRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">refFile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="k">pass</span>
	
		<span class="k">try</span><span class="p">:</span>
			<span class="n">atomicForArr</span> <span class="o">=</span> <span class="n">atomicForRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">refFile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

			<span class="n">splitAtomicFor</span> <span class="o">=</span> <span class="n">atomicForArr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitAtomicFor</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">item</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
				<span class="n">atomSplit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
				<span class="n">formattedAtomFor</span> <span class="o">=</span> <span class="n">atomSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">atomSplit</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">atomSplit</span><span class="p">))])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
				<span class="n">atomForSortList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formattedAtomFor</span><span class="p">)</span>
		<span class="n">atomForSortList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atomForSortList</span><span class="p">)</span>
		<span class="n">testDictString</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
		<span class="k">for</span> <span class="n">formattedAtomFor</span> <span class="ow">in</span> <span class="n">atomForSortList</span><span class="p">:</span>
			<span class="n">inputStr</span><span class="o">+=</span><span class="n">formattedAtomFor</span>
			<span class="n">testDictString</span><span class="o">+=</span><span class="n">formattedAtomFor</span>
		<span class="n">inDict</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUTFORCES_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">testDictString</span>
	<span class="k">except</span><span class="p">:</span>
		<span class="k">pass</span>





        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _parseRef&#39;</span><span class="p">)</span>	
	<span class="k">if</span> <span class="ow">not</span> <span class="n">dictFlag</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">inputStr</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">inDict</span>

        <span class="c1">#######################################################################################################</span>
        <span class="c1">####TO BE COMPLETED TO BE COMPLETED TO BE COMPLETED TO BE COMPLETED TO BE COMPLETED TO BE COMPLETED ###</span>
        <span class="c1">#######################################################################################################</span>


<span class="k">def</span> <span class="nf">_transformParamsInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Transforms the various styles of defining the lattice vectors into celldm form so AFLOWpi</span>
<span class="sd">    has a standard format to work with.</span>

<span class="sd">	</span>
<span class="sd">    Arguments:</span>
<span class="sd">          inputString (str): a string of a QE input</span>

<span class="sd">    Returns:</span>
<span class="sd">          a string of a QE input that has its lattice vectors in celldm style</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
    <span class="n">BohrToAngstrom</span> <span class="o">=</span> <span class="mf">0.529177249</span>

    <span class="n">CELL_PARAM_FLAG</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;CELL_PARAMETERS&#39;</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cellParamMatrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellStringToMatrix</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">])</span>
        <span class="n">cellParamRegex</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="s1">&#39;regex&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellParamRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">inputString</span><span class="p">)):</span>

            <span class="n">paramUnits</span> <span class="o">=</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">paramUnits</span> <span class="o">=</span> <span class="n">paramUnits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">paramUnits</span><span class="o">==</span><span class="s1">&#39;angstrom&#39;</span><span class="p">:</span>
                <span class="n">cellParamMatrix</span><span class="o">*=</span><span class="mi">1</span><span class="o">/</span><span class="mf">0.529177249</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">paramUnits</span><span class="o">==</span><span class="s1">&#39;angstrom&#39;</span><span class="p">:</span>
                    <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mf">0.529177249</span>
                <span class="k">elif</span> <span class="s1">&#39;celldm(1)&#39;</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">mult</span><span class="o">=</span><span class="mf">1.0</span>
                <span class="n">cellParamMatrix</span><span class="o">*=</span><span class="n">mult</span>

	    <span class="c1"># if AFLOWpi.prep._ConfigSectionMap(&#39;prep&#39;,&#39;cell_convention&#39;).upper()==&#39;AFLOW&#39;:</span>
	    <span class="c1"># 	    ibrav_aflow = int(AFLOWpi.retr.getIbravFromVectors(cellParamMatrix))</span>
	    <span class="c1"># 	    if ibrav_aflow==5:</span>
	    <span class="c1"># 		    angle=numpy.arccos(cellParamMatrix[0].dot(cellParamMatrix[1]))*180.0/numpy.pi</span>
	    <span class="c1"># 	    else:</span>
	    <span class="c1"># 		    angle=None</span>

	    <span class="c1"># 	    to_conv = AFLOWpi.retr.aflow_primitive_to_aflow_conventional_transform(ibrav_aflow)</span>
	    <span class="c1"># 	    to_prim = AFLOWpi.retr.qe_conventional_to_qe_primitive_transform(ibrav_aflow)</span>
	    <span class="c1"># 	    conv = to_prim.dot(to_conv)</span>

	    <span class="c1"># 	    cellParamMatrix = conv.dot(cellParamMatrix)</span>



	    <span class="c1"># 	    pos    = AFLOWpi.retr._getPositions(inputString,matrix=True)</span>
	    <span class="c1"># 	    labels = AFLOWpi.retr._getPosLabels(inputString)</span>
	    <span class="c1"># 	    for one_position in range(len(pos)):</span>
	    <span class="c1"># 		    trans_pos = conv.dot(pos[one_position].T).T</span>
	    <span class="c1"># 		    pos[one_position]=trans_pos</span>
	    <span class="c1"># 	    pos    = AFLOWpi.retr._joinMatrixLabels(labels,pos)</span>
	    <span class="c1"># 	    inputDict[&#39;ATOMIC_POSITIONS&#39;][&#39;__content__&#39;]=pos</span>

            <span class="n">ibravDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_free2celldm</span><span class="p">(</span><span class="n">cellParamMatrix</span><span class="p">)</span>
	    <span class="n">ibravDict_prime</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getCelldm2freeDict</span><span class="p">(</span><span class="n">ibravDict</span><span class="p">)</span>
	    <span class="n">new_prim_mat</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">celldm2free</span><span class="p">(</span><span class="o">**</span><span class="n">ibravDict_prime</span><span class="p">)</span> 
	    <span class="n">new_prim_mat</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellStringToMatrix</span><span class="p">(</span><span class="n">new_prim_mat</span><span class="p">)</span>
	    <span class="n">orig</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_prim2ConvVec</span><span class="p">(</span><span class="n">cellParamMatrix</span><span class="p">)</span>        
	    <span class="n">new</span>  <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_prim2ConvVec</span><span class="p">(</span><span class="n">new_prim_mat</span><span class="p">)</span>        
	    <span class="n">slam</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
            <span class="n">ibravDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_free2celldm</span><span class="p">(</span><span class="n">cellParamMatrix</span><span class="p">)</span>
	    
	    
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">ibravDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">:</span>
                    <span class="n">scaled</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">BohrToAngstrom</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">BohrToAngstrom</span><span class="p">)</span>
                    <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>

            <span class="n">inputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">inputString</span>    


    <span class="k">elif</span> <span class="s1">&#39;A&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
        <span class="n">paramDict</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">A</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
        <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;ibrav&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ibrav&#39;</span><span class="p">])</span>
        <span class="n">inputDictCopy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;cosAB&#39;</span><span class="p">,</span><span class="s1">&#39;cosAC&#39;</span><span class="p">,</span><span class="s1">&#39;cosBC&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">del</span> <span class="n">inputDictCopy</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">param</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                    
        <span class="n">tempDict</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;COSAB&#39;</span><span class="p">,</span><span class="s1">&#39;COSAC&#39;</span><span class="p">,</span><span class="s1">&#39;COSBC&#39;</span><span class="p">]:</span>

                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">paramFloat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">param</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>

		    <span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;COSAB&#39;</span><span class="p">:</span>
                        <span class="n">paramName</span><span class="o">=</span><span class="s1">&#39;celldm(4)&#39;</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;COSAC&#39;</span><span class="p">:</span>
                        <span class="n">paramName</span><span class="o">=</span><span class="s1">&#39;celldm(5)&#39;</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;COSBC&#39;</span><span class="p">:</span>
                        <span class="n">paramName</span><span class="o">=</span><span class="s1">&#39;celldm(6)&#39;</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;A&#39;</span><span class="p">:</span>
                        <span class="n">paramName</span><span class="o">=</span><span class="s1">&#39;celldm(1)&#39;</span>
                        <span class="n">paramFloat</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">paramFloat</span><span class="o">/</span><span class="mf">0.529177249</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">:</span>
                        <span class="n">paramName</span><span class="o">=</span><span class="s1">&#39;celldm(2)&#39;</span>
                        <span class="n">paramFloat</span><span class="o">/=</span><span class="n">A</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">:</span>
                        <span class="n">paramName</span><span class="o">=</span><span class="s1">&#39;celldm(3)&#39;</span>
                        <span class="n">paramFloat</span><span class="o">/=</span><span class="n">A</span>
                    
                    <span class="n">tempDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">paramName</span><span class="p">:</span><span class="n">paramFloat</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">tempDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">inputDictCopy</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>


        <span class="n">inputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDictCopy</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">inputString</span>    


    <span class="k">elif</span> <span class="s1">&#39;celldm(1)&#39;</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>        
        <span class="k">return</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_transformPositionsInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Transforms the various styles of defining the atomic positions into crystal </span>
<span class="sd">    fractional coordinates form so AFLOWpi has a standard format to work with.</span>

<span class="sd">	</span>
<span class="sd">    Arguments:</span>
<span class="sd">          inputString (str): a string of a QE input</span>

<span class="sd">    Returns:</span>
<span class="sd">          inputString (str): a string of a QE input that has its atomic positions in crystal fractional coordinates</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cellParamMatrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">getCellMatrixFromInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>


    <span class="n">splitInput</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">labels</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPosLabels</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
        <span class="n">positionMatrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPositions</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
        <span class="n">pos</span><span class="p">,</span><span class="n">flags</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">atomic_positions</span><span class="p">(</span><span class="n">inputString</span><span class="p">))</span>

        <span class="n">paramUnits</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span>
        <span class="n">cellParamMatrix</span><span class="o">/=</span><span class="nb">float</span><span class="p">(</span><span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">paramUnits</span><span class="o">==</span><span class="s1">&#39;</span><span class="si">{angstrom}</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="n">positionMatrix</span><span class="o">/=</span><span class="mf">0.52917721092</span>
	    <span class="n">positionMatrix</span><span class="o">/=</span><span class="nb">float</span><span class="p">(</span><span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">])</span>
            <span class="n">symMatrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_convertFractional</span><span class="p">(</span><span class="n">positionMatrix</span><span class="p">,</span><span class="n">cellParamMatrix</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">paramUnits</span><span class="o">==</span><span class="s1">&#39;</span><span class="si">{bohr}</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="n">positionMatrix</span><span class="o">/=</span><span class="nb">float</span><span class="p">(</span><span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">])</span>
            <span class="n">symMatrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_convertFractional</span><span class="p">(</span><span class="n">positionMatrix</span><span class="p">,</span><span class="n">cellParamMatrix</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">paramUnits</span><span class="o">==</span><span class="s1">&#39;</span><span class="si">{crystal}</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">paramUnits</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>

            <span class="n">symMatrix</span> <span class="o">=</span> <span class="n">positionMatrix</span>
        <span class="k">elif</span> <span class="n">paramUnits</span><span class="o">==</span><span class="s1">&#39;alat&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">symMatrix</span> <span class="o">=</span> <span class="n">positionMatrix</span>

        <span class="n">outputString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symMatrix</span><span class="o">.</span><span class="n">getA</span><span class="p">())):</span>

            <span class="n">posLineStr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%20.14f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">16</span><span class="p">))))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">symMatrix</span><span class="o">.</span><span class="n">getA</span><span class="p">()[</span><span class="n">entry</span><span class="p">]])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">outputString</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%4s</span><span class="s1"> </span><span class="si">%8s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span><span class="n">posLineStr</span><span class="p">)</span>
        
        <span class="n">outputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">attachPosFlags</span><span class="p">(</span><span class="n">outputString</span><span class="p">,</span><span class="n">flags</span><span class="p">)</span>

        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span> <span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputString</span>
        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span> <span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{crystal}</span><span class="s1">&#39;</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">inputString</span>

    <span class="n">returnString</span> <span class="o">=</span>   <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">returnString</span>


<span class="k">def</span> <span class="nf">_transformInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Standardizes the input format of the QE input files so AFLOWpi only has to account</span>
<span class="sd">    for one standard input type for atomic positions and lattice parameters.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          inputString (str): a string of a QE input file</span>

<span class="sd">    Returns:</span>
<span class="sd">          inputString (str): a string of a QE input file</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#convert to QE convention</span>
    <span class="n">input_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;CELL_PARAMETERS&#39;</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
	    <span class="n">isotropy_obj</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">isotropy</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
	    <span class="n">inputString</span> <span class="o">=</span> <span class="n">isotropy_obj</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">ibrav</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	    

    <span class="k">try</span><span class="p">:</span>
	    <span class="n">positionMatrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPositions</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
	    <span class="n">labels</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPosLabels</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
	    <span class="n">pos</span><span class="p">,</span><span class="n">flag</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">atomic_positions</span><span class="p">(</span><span class="n">inputString</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
	    <span class="nb">print</span> <span class="n">e</span>
    

    

    <span class="n">inputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_transformParamsInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
    <span class="n">inputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_transformPositionsInput</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span> 




    <span class="k">return</span> <span class="n">inputString</span>


<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">##QE ATOMIC_SPECIES LISTS</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">##################################################################################################################### </span>





<span class="k">def</span> <span class="nf">_getAMass</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Get the atomic mass for the specific atomic species in input</span>
<span class="sd">	</span>
<span class="sd">	Arguments:</span>
<span class="sd">	      atom (str): Atomic Species you want the mass of</span>

<span class="sd">	Returns:</span>
<span class="sd">	      Mass of the atom&#39;s species</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entering getAMass&#39;</span><span class="p">)</span>	
	<span class="n">mass</span> <span class="o">=</span> <span class="p">{</span>
        
	<span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.008</span><span class="p">,</span> <span class="s1">&#39;Hydrogen&#39;</span><span class="p">),</span>
	<span class="s2">&quot;He&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">4.003</span><span class="p">,</span> <span class="s1">&#39;Helium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Li&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">6.938</span><span class="p">,</span> <span class="s1">&#39;Lithium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Be&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">9.012</span><span class="p">,</span> <span class="s1">&#39;Beryllium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">10.806</span><span class="p">,</span> <span class="s1">&#39;Boron&#39;</span><span class="p">),</span>
	<span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">12.010</span><span class="p">,</span> <span class="s1">&#39;Carbon&#39;</span><span class="p">),</span>
	<span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">14.006</span><span class="p">,</span> <span class="s1">&#39;Nitrogen&#39;</span><span class="p">),</span>
	<span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">15.999</span><span class="p">,</span> <span class="s1">&#39;Oxygen&#39;</span><span class="p">),</span>
	<span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">18.998</span><span class="p">,</span> <span class="s1">&#39;Fluorine&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ne&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">20.180</span><span class="p">,</span> <span class="s1">&#39;Neon&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Na&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">22.990</span><span class="p">,</span> <span class="s1">&#39;Sodium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Mg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">24.304</span><span class="p">,</span> <span class="s1">&#39;Magnesium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Al&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">26.982</span><span class="p">,</span> <span class="s1">&#39;Aluminium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Si&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">28.084</span><span class="p">,</span> <span class="s1">&#39;Silicon&#39;</span><span class="p">),</span>
	<span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">30.974</span><span class="p">,</span> <span class="s1">&#39;Phosphorus&#39;</span><span class="p">),</span>
	<span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">32.059</span><span class="p">,</span> <span class="s1">&#39;Sulfur&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Cl&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">35.446</span><span class="p">,</span> <span class="s1">&#39;Chlorine&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">39.948</span><span class="p">,</span> <span class="s1">&#39;Argon&#39;</span><span class="p">),</span>
	<span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">39.098</span><span class="p">,</span> <span class="s1">&#39;Potassium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ca&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">40.078</span><span class="p">,</span> <span class="s1">&#39;Calcium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Sc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">44.955</span><span class="p">,</span> <span class="s1">&#39;Scandium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ti&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">47.867</span><span class="p">,</span> <span class="s1">&#39;Titanium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">50.941</span><span class="p">,</span> <span class="s1">&#39;Vanadium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Cr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">51.996</span><span class="p">,</span> <span class="s1">&#39;Chromium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Mn&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">54.938</span><span class="p">,</span> <span class="s1">&#39;Manganese&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Fe&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">55.845</span><span class="p">,</span> <span class="s1">&#39;Iron&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Co&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">58.933</span><span class="p">,</span> <span class="s1">&#39;Cobalt&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ni&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">58.693</span><span class="p">,</span> <span class="s1">&#39;Nickel&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Cu&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">63.546</span><span class="p">,</span> <span class="s1">&#39;Copper&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Zn&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">65.380</span><span class="p">,</span> <span class="s1">&#39;Zinc&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ga&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">69.723</span><span class="p">,</span> <span class="s1">&#39;Gallium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ge&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">72.630</span><span class="p">,</span> <span class="s1">&#39;Germanium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;As&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">74.922</span><span class="p">,</span> <span class="s1">&#39;Arsenic&#39;</span><span class="p">),</span>
	<span class="s2">&quot;As&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">74.922</span><span class="p">,</span> <span class="s1">&#39;Arsenic&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Se&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">78.971</span><span class="p">,</span> <span class="s1">&#39;Selenium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Br&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">79.901</span><span class="p">,</span> <span class="s1">&#39;Bromine&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Kr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">83.798</span><span class="p">,</span> <span class="s1">&#39;Krypton&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Rb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">85.468</span><span class="p">,</span> <span class="s1">&#39;Rubidium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Sr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">87.620</span><span class="p">,</span> <span class="s1">&#39;Strontium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">88.906</span><span class="p">,</span> <span class="s1">&#39;Yttrium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Zr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">91.224</span><span class="p">,</span> <span class="s1">&#39;Zirconium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Nb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">92.906</span><span class="p">,</span> <span class="s1">&#39;Niobium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Mo&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">95.950</span><span class="p">,</span> <span class="s1">&#39;Molybdenum&#39;</span><span class="p">),</span>
        <span class="s2">&quot;Tc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">98.0</span><span class="p">,</span> <span class="s1">&#39;Tecnetium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ru&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">101.070</span><span class="p">,</span><span class="s1">&#39; Ruthenium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Rh&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">102.906</span><span class="p">,</span> <span class="s1">&#39;Rhodium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Pd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">106.420</span><span class="p">,</span> <span class="s1">&#39;Palladium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ag&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">107.868</span><span class="p">,</span> <span class="s1">&#39;Silver&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Cd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">112.414</span><span class="p">,</span> <span class="s1">&#39;Cadmium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;In&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">114.818</span><span class="p">,</span> <span class="s1">&#39;Indium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Sn&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">118.710</span><span class="p">,</span> <span class="s1">&#39;Tin&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Sb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">121.760</span><span class="p">,</span> <span class="s1">&#39;Antimony&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Te&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">127.600</span><span class="p">,</span> <span class="s1">&#39;Tellurium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">126.904</span><span class="p">,</span> <span class="s1">&#39;Iodine&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Xe&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">131.293</span><span class="p">,</span> <span class="s1">&#39;Xenon&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Cs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">132.905</span><span class="p">,</span> <span class="s1">&#39;Cesium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ba&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">137.327</span><span class="p">,</span> <span class="s1">&#39;Barium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;La&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">138.905</span><span class="p">,</span> <span class="s1">&#39;Lanthanum&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ce&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">140.116</span><span class="p">,</span> <span class="s1">&#39;Cerium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Pr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">140.908</span><span class="p">,</span> <span class="s1">&#39;Praseodymium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Nd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">144.242</span><span class="p">,</span> <span class="s1">&#39;Neodymium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Sm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">150.360</span><span class="p">,</span> <span class="s1">&#39;Samarium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Eu&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">151.964</span><span class="p">,</span> <span class="s1">&#39;Europium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Gd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">157.250</span><span class="p">,</span> <span class="s1">&#39;Gadolinium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Tb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">158.925</span><span class="p">,</span> <span class="s1">&#39;Terbium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Dy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">162.500</span><span class="p">,</span> <span class="s1">&#39;Dysprosium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ho&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">164.930</span><span class="p">,</span> <span class="s1">&#39;Holmium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Er&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">167.259</span><span class="p">,</span> <span class="s1">&#39;Erbium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Tm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">168.934</span><span class="p">,</span> <span class="s1">&#39;Thulium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Yb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">173.054</span><span class="p">,</span> <span class="s1">&#39;Ytterbium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Lu&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">174.967</span><span class="p">,</span> <span class="s1">&#39;Lutetium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Hf&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">178.490</span><span class="p">,</span> <span class="s1">&#39;Hafnium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">180.947</span><span class="p">,</span> <span class="s1">&#39;Tantalum&#39;</span><span class="p">),</span>
	<span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">183.840</span><span class="p">,</span> <span class="s1">&#39;Tungsten&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Re&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">186.207</span><span class="p">,</span> <span class="s1">&#39;Rhenium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Os&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">190.230</span><span class="p">,</span> <span class="s1">&#39;Osmium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Ir&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">192.217</span><span class="p">,</span> <span class="s1">&#39;Iridium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Pt&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">195.084</span><span class="p">,</span> <span class="s1">&#39;Platinum&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Au&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">196.966</span><span class="p">,</span> <span class="s1">&#39;Gold&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Hg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">200.592</span><span class="p">,</span> <span class="s1">&#39;Mercury&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Tl&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">204.382</span><span class="p">,</span> <span class="s1">&#39;Thallium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Pb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">207.200</span><span class="p">,</span> <span class="s1">&#39;Lead&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Bi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">208.980</span><span class="p">,</span> <span class="s1">&#39;Bismuth&#39;</span><span class="p">),</span>
        <span class="s2">&quot;Po&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">209</span><span class="p">,</span> <span class="s1">&#39;Polonium&#39;</span><span class="p">),</span>
        <span class="s2">&quot;At&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">210</span><span class="p">,</span> <span class="s1">&#39;Astatine&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Th&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">232.038</span><span class="p">,</span> <span class="s1">&#39;Thorium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Pa&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">231.036</span><span class="p">,</span> <span class="s1">&#39;Protactinium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">238.029</span><span class="p">,</span> <span class="s1">&#39;Uranium&#39;</span><span class="p">),</span>
	<span class="s2">&quot;Am&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">243.000</span><span class="p">,</span> <span class="s1">&#39;Americium&#39;</span><span class="p">),</span>
        <span class="s2">&quot;!&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.000</span><span class="p">,</span> <span class="s1">&#39;VACANT&#39;</span><span class="p">),}</span>


	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting getAMass&#39;</span><span class="p">)</span>
        <span class="n">atomMass</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atomMass</span> <span class="o">=</span> <span class="n">mass</span><span class="p">[</span><span class="n">atom</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">atomMass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_getPseudofilename</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span><span class="n">pseudodir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span><span class="s1">&#39;PSEUDOs&#39;</span><span class="p">)):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Gets the pseudopotential filename for the specific atomic species in input.</span>
<span class="sd">	It will check in the AFLOWpi config file used when itiating the session for </span>
<span class="sd">	a pseudodir path.</span>

<span class="sd">	Species names must be in the form of the element&#39;s symbol possibly followed by integers</span>
<span class="sd">	(i.e) &quot;O1&quot;,&quot;Co6&quot;, or &quot;Sn165&quot; (Note that QE needs to be modified to accept species labels</span>
<span class="sd">	longer than 3 characters. Instructions on how are in the engine_mods directory.)</span>
<span class="sd">	</span>
<span class="sd">	Arguments:</span>
<span class="sd">	      atom (str): a string designating the atomic species you want the pseudofile name for</span>
<span class="sd">	</span>
<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      pseudodir (str): the path of the directory containing pseudofiles</span>

<span class="sd">	Returns:</span>
<span class="sd">	      pseudofilename (str): name of the pseudopotential file in for </span>
<span class="sd">	                            that species in the pseudodir specified</span>
<span class="sd">	      </span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entering getPseudofilename&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">pseudodir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
	        <span class="n">pseudodir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;pseudo_dir&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>



        <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="s1">&#39;!&#39;</span><span class="p">:</span>
            <span class="n">atom0</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="n">atom1</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="n">atom0</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">species</span><span class="o">=</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">atom0</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">atom0</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="o">+</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">atom1</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">atom1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
            <span class="n">regexFromConfig</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;pseudo_regex&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">regexFromConfig</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">regexFromConfig</span><span class="o">=</span><span class="s2">&quot;re.compile(r&#39;^&#39;+species+&#39;[._-]&#39;, re.I)&quot;</span>
            <span class="n">rex1</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">regexFromConfig</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">rex1</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                            <span class="n">pseudofilename</span> <span class="o">=</span> <span class="n">l</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting getPseudofilename&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">pseudofilename</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Missing Pseudopotential File&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting getPseudofilename&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>







<span class="c1">#########################################################################################################################</span>
<span class="c1">#########################################################################################################################</span>
<span class="c1">## step preparation</span>
<span class="c1">#########################################################################################################################</span>
<span class="c1">######################################################################################################################### </span>

            
<div class="viewcode-block" id="writeToScript"><a class="viewcode-back" href="../prep.html#prep.writeToScript">[docs]</a><span class="k">def</span> <span class="nf">writeToScript</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span><span class="n">calcs</span><span class="p">,</span><span class="n">from_step</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates calls on several functions to set up everything that is needed for a new step in the workflow.</span>
<span class="sd">    The mechanics of the _ID.py are written to it here. </span>

<span class="sd">    Arguments:</span>
<span class="sd">	  calcs (dict): dictionary of dictionaries of calculations</span>
<span class="sd">          executable (str): &lt;DEFUNCT OPTION: HERE FOR LEGACY SUPPORT&gt; </span>
<span class="sd">	  *args: &lt;DEFUNCT OPTION: HERE FOR LEGACY SUPPORT&gt;</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  **kwargs: &lt;DEFUNCT OPTION: HERE FOR LEGACY SUPPORT&gt;</span>

<span class="sd">    Returns:</span>
<span class="sd">          A set of calculations for a new step in the workflow</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_calcs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_writeToScript</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">from_step</span><span class="o">=</span><span class="n">from_step</span><span class="p">)</span>
    
        <span class="n">new_oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;Start&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;Complete&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;Restart&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;Error&quot;</span><span class="p">:</span><span class="s1">&#39;None&#39;</span><span class="p">})</span>    
	
	
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>              
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_qsubGen</span><span class="p">(</span><span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">)</span>     
            <span class="n">new_oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_</span><span class="si">%s%s</span><span class="s1">.qsub&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_ID</span><span class="p">,</span><span class="n">extension</span><span class="p">)</span> 

        <span class="n">new_calcs</span><span class="p">[</span><span class="n">new_ID</span><span class="p">]</span><span class="o">=</span><span class="n">new_oneCalc</span>
	<span class="n">step_index</span><span class="o">=</span><span class="n">new_oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>
    

    <span class="k">return</span> <span class="n">new_calcs</span></div>




<span class="k">def</span> <span class="nf">_fillTemplate</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fills in the blocks of each calculation&#39;s _ID.py with mechanism for starting the next step in the chain</span>
<span class="sd">    </span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">	  ID (str): ID string for the particular calculation and step</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _fillTemplate&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;../&quot;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;LOG.log&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOGGING&#39;</span><span class="p">,</span><span class="s2">&quot;import logging&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOGGING&#39;</span><span class="p">,</span><span class="s2">&quot;import logging&quot;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOGGING&#39;</span><span class="p">,</span><span class="s2">&quot;logfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">logfile</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOGGING&#39;</span><span class="p">,</span><span class="s2">&quot;logging.basicConfig(filename=logfile,format=&#39;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&#39;, datefmt=&#39;%m/</span><span class="si">%d</span><span class="s2">/%Y %I:%M:%S %p&#39;,level=AFLOWpi.prep._getLoglevel())</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s2">&quot;ID=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s2">&quot;ID=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s2">&quot;import AFLOWpi&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s2">&quot;import AFLOWpi&quot;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s2">&quot;import time&quot;</span><span class="p">)</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s1">&#39;__CLOCK__=time.time()&#39;</span><span class="p">)</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s2">&quot;import os&quot;</span><span class="p">)</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s2">&quot;import inspect&quot;</span><span class="p">)</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s2">&quot;os.chdir(os.path.dirname(os.path.abspath(inspect.stack()[0][1])))&quot;</span><span class="p">)</span>

            <span class="n">clusterType</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RESTART&#39;</span><span class="p">,</span><span class="s2">&quot;oneCalc = AFLOWpi.run._setStartTime(oneCalc,ID,__CLOCK__)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clusterType</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>


<span class="c1">#################################################################################################################</span>
<span class="c1">#################################################################################################################</span>
<span class="c1">#### NOT FINISHED ##NOT FINISHED ##NOT FINISHED ##NOT FINISHED ##NOT FINISHED ##NOT FINISHED ##NOT FINISHED  ####</span>
<span class="c1">#################################################################################################################</span>
<span class="c1">#################################################################################################################</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s2">&quot;from multiprocessing import os,Process&quot;</span><span class="p">)</span>


                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s2">&quot;import signal&quot;</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RESTART&#39;</span><span class="p">,</span><span class="s2">&quot;signal.signal(signal.SIGUSR1,AFLOWpi.run._exitClean)&quot;</span><span class="p">)</span>       
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RESTART&#39;</span><span class="p">,</span><span class="s2">&quot;signal.signal(signal.SIGTERM,AFLOWpi.run._recordDeath)&quot;</span><span class="p">)</span>       

<span class="c1">#################################################################################################################</span>
<span class="c1">#################################################################################################################</span>
<span class="c1">#### NOT FINISHED ##NOT FINISHED ##NOT FINISHED ##NOT FINISHED ##NOT FINISHED ##NOT FINISHED ##NOT FINISHED  ####</span>
<span class="c1">#################################################################################################################</span>
<span class="c1">#################################################################################################################</span>
        <span class="sd">&#39;&#39;&#39;switch over to local config file in AFLOWpi folder of calc tree&#39;&#39;&#39;</span>
        <span class="n">configFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;CONFIG.config&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CONFIGFILE&#39;</span><span class="p">,</span><span class="s2">&quot;configFile&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CONFIGFILE&#39;</span><span class="p">,</span><span class="s2">&quot;configFile=&#39;../AFLOWpi/CONFIG.config&#39;&quot;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CONFIGFILE&#39;</span><span class="p">,</span><span class="s2">&quot;AFLOWpi.prep._forceGlobalConfigFile(configFile)&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;__submitNodeName__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">global</span> <span class="n">__submitNodeName__</span>
                <span class="n">__submitNodeName__</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CONFIGFILE&#39;</span><span class="p">,</span><span class="s2">&quot;__submitNodeName__ = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">__submitNodeName__</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CONFIGFILE&#39;</span><span class="p">,</span><span class="s2">&quot;__submitNodeName__ = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">__submitNodeName__</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CONFIGFILE&#39;</span><span class="p">,</span><span class="s2">&quot;AFLOWpi.prep._forceSubmitNodeIP(__submitNodeName__)&quot;</span><span class="p">)</span>


            <span class="n">index</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
		<span class="n">index</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>


	    <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;../&quot;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;calclogs&#39;</span><span class="p">,</span><span class="s1">&#39;calclog_</span><span class="si">%.02d</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">_findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="s2">&quot;AFLOWpi.prep._updatelogs(ID,oneCalc,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="c1">#make sure the restart mode is reset before exiting to the next step</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;oneCalc,ID=AFLOWpi.prep._modifyNamelistPW(oneCalc,ID,&#39;&amp;control&#39;,&#39;restart_mode&#39;,&#39;&quot;from_scratch&quot;&#39;)&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;AFLOWpi.prep._updatelogs(ID,oneCalc,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>


        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _fillTemplate&#39;</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_getNextOneCalcVarName</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ##############</span>
<span class="sd">    ###OBSOLETE###</span>
<span class="sd">    ##############</span>
<span class="sd">    Gives increased the ID of one calculation an increase of one in its postfix </span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">	  ID (str): ID string for the particular calculation and step</span>

<span class="sd">    Returns:</span>
<span class="sd">          the identical calculation object that was inputted and its ID that has had its ID modified</span>

<span class="sd">    &#39;&#39;&#39;</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _getNextOneCalcVarName&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.py&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scriptFile</span><span class="p">:</span>
            <span class="n">scriptFileString</span> <span class="o">=</span> <span class="n">scriptFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">varList</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;oneCalc&#39;</span><span class="p">,</span><span class="n">scriptFileString</span><span class="p">))</span>    

    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;oneCalc&#39;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _getNextOneCalcVarName&#39;</span><span class="p">)</span>

    <span class="n">nextIDName</span> <span class="o">=</span> <span class="s1">&#39;ID_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varList</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nextCalcName</span> <span class="o">=</span> <span class="s1">&#39;oneCalc_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varList</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nextIDName</span><span class="p">,</span><span class="n">nextCalcName</span>



<span class="k">def</span> <span class="nf">_writeTemplate</span><span class="p">(</span><span class="n">finp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Writes the blocks of the skeleton _ID.py to file for one calculation.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          finp (str): filepath for skeleton _ID.py file to go</span>
<span class="sd">	 </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">fileName</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">#####AFLOWpi EXECUTABLE#######</span>

<span class="s1">#IMPORT_BLOCK</span>

<span class="s1">#END_IMPORT_BLOCK</span>
<span class="s1">#CONFIGFILE_BLOCK</span>

<span class="s1">#END_CONFIGFILE_BLOCK</span>
<span class="s1">#LOGGING_BLOCK</span>

<span class="s1">#END_LOGGING_BLOCK</span>
<span class="s1">#ONECALC_BLOCK</span>

<span class="s1">#END_ONECALC_BLOCK</span>
<span class="s1">#LOADCALC_BLOCK</span>

<span class="s1">#END_LOADCALC_BLOCK</span>
<span class="s1">#ID_BLOCK</span>

<span class="s1">#END_ID_BLOCK</span>
<span class="s1">#RESTART_BLOCK</span>

<span class="s1">#END_RESTART_BLOCK</span>
<span class="s1">#PREPROCESSING_BLOCK</span>

<span class="s1">#END_PREPROCESSING_BLOCK</span>

<span class="s1">#LOCK_BLOCK</span>

<span class="s1">#END_LOCK_BLOCK</span>
<span class="s1">#RUN_BLOCK</span>

<span class="s1">#END_RUN_BLOCK</span>
<span class="s1">#POSTPROCESSING_BLOCK</span>

<span class="s1">#END_POSTPROCESSING_BLOCK</span>
<span class="s1">#PLOT_BLOCK</span>

<span class="s1">#END_PLOT_BLOCK</span>
<span class="s1">#CALCTRANSFORM_BLOCK</span>

<span class="s1">#END_CALCTRANSFORM_BLOCK</span>
<span class="s1">#SUBMITNEXT_BLOCK</span>

<span class="s1">#END_SUBMITNEXT_BLOCK</span>
<span class="s1">#BATCH_BLOCK</span>

<span class="s1">#END_BATCH_BLOCK</span>
<span class="s1">#CLEANUP_BLOCK</span>

<span class="s1">#END_CLEANUP_BLOCK&#39;&#39;&#39;</span><span class="p">)</span>



    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
           
<span class="c1">####################################################################################################################</span>


<span class="k">def</span> <span class="nf">_temp_executable</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">from_step</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates the _ID.py for a single calculation for a given step.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">	  ID (str): ID string for the particular calculation and step</span>
<span class="sd">	  </span>
<span class="sd">    Keyword Argument</span>
<span class="sd">	  ext (str): an optional postfix to the ID&#39;s to all calculations in the set for a given step</span>

<span class="sd">    Returns:</span>
<span class="sd">         The one calculation for the new set, its ID, the old calculation, and its ID</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="k">pass</span>
    <span class="k">except</span><span class="p">:</span>
	    <span class="k">pass</span>
    

    <span class="n">temp_calcs</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
    <span class="n">new_calcs</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>



    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ENTERING _temp_executable&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>

            <span class="n">f</span><span class="o">=</span><span class="n">ID</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">temp_calcs</span>

            <span class="n">subdir</span> <span class="o">=</span> <span class="n">temp_calcs</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>


            <span class="sd">&quot;&quot;&quot;generate a dummy .py file for use later when scf has run and we have info to generate hash&quot;&quot;&quot;</span>

	    <span class="k">if</span> <span class="n">from_step</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
		    <span class="n">extension</span><span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%.02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>
	    <span class="k">else</span><span class="p">:</span>
		    <span class="n">extension</span><span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%.02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">from_step</span>


            <span class="n">temp_hash</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">extension</span><span class="p">)</span>
		    
            <span class="n">finp_temp</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">.py&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">temp_hash</span><span class="p">)</span>
            <span class="n">finp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">finp_temp</span><span class="p">)</span>
            



	    
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_writeTemplate</span><span class="p">(</span><span class="n">finp</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;EXITING _temp_executable&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">new_calcs</span><span class="p">,</span><span class="n">temp_hash</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

<span class="c1">####################################################################################################################</span>



<span class="k">def</span> <span class="nf">_removeFromBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">removal</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Searches for a regular expression pattern inside a specific block of a each calculation&#39;s _ID.py and </span>
<span class="sd">    removes the command from the block.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">	  ID (str): ID string for the particular calculation and step</span>
<span class="sd">	  block (str): string of the block in the _ID.py that the addition is to be added to</span>
<span class="sd">	                for that step of workflow</span>
<span class="sd">	  removal (str): a regular expression to find and delete a pattern of text in a single block</span>
<span class="sd">	                  of each calculation&#39;s _ID.py for a given step</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _removeFromBlock&#39;</span><span class="p">)</span>
    <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>    
    <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>

    <span class="n">removal</span> <span class="o">=</span> <span class="n">removal</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;\)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;\(&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">fileName</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
            <span class="n">inputFileText</span> <span class="o">=</span> <span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">isolatedString</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%s</span><span class="s1">_BLOCK&#39;</span> <span class="o">%</span> <span class="n">block</span><span class="p">,</span><span class="n">inputFileText</span><span class="p">)</span>
        <span class="n">isolatedStringEnd</span> <span class="o">=</span> <span class="n">isolatedString</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">isolatedStringBeginning</span> <span class="o">=</span> <span class="n">isolatedString</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">isolatedStringEmpty</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#END_</span><span class="si">%s</span><span class="s1">_BLOCK&#39;</span> <span class="o">%</span> <span class="n">block</span><span class="p">,</span><span class="n">isolatedStringEnd</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">isolatedString</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#END_</span><span class="si">%s</span><span class="s1">_BLOCK&#39;</span> <span class="o">%</span> <span class="n">block</span><span class="p">,</span><span class="n">isolatedStringEnd</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="n">remainingText</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">removal</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">isolatedString</span><span class="p">)</span>
	    <span class="n">newBlockText</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;#</span><span class="si">%s</span><span class="s1">_BLOCK</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">#END_</span><span class="si">%s</span><span class="s1">_BLOCK&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">remainingText</span><span class="p">,</span><span class="n">block</span><span class="p">)</span>
	    <span class="n">new_IDPY</span><span class="o">=</span><span class="n">isolatedStringBeginning</span><span class="o">+</span><span class="n">newBlockText</span><span class="o">+</span><span class="n">isolatedStringEmpty</span>

	    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">fileName</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outputfile</span><span class="p">:</span>
		<span class="n">outputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_IDPY</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
	    <span class="k">pass</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _removeFromBlock&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="addToBlockWrapper"><a class="viewcode-back" href="../prep.html#prep.addToBlockWrapper">[docs]</a><span class="k">def</span> <span class="nf">addToBlockWrapper</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">addition</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	Wraps AFLOWpi.prep._addToBlock for use inside _calcs_container methods</span>

<span class="sd">	Arguments:</span>
<span class="sd">              oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">	      ID (str): ID string for the particular calculation and step</span>
<span class="sd">	      block (str): string of the block in the _ID.py that the addition is to be added to</span>
<span class="sd">	                    for that step of workflow</span>
<span class="sd">	      addition (str): a string containing code to be written to the specific block</span>
<span class="sd">	                       in the _ID.py for each calculation</span>

<span class="sd">        Returns:</span>
<span class="sd">              None</span>
<span class="sd">	</span>
<span class="sd">	&#39;&#39;&#39;</span>

	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">addition</span><span class="p">)</span></div>

<div class="viewcode-block" id="addToAll_"><a class="viewcode-back" href="../prep.html#prep.addToAll_">[docs]</a><span class="k">def</span> <span class="nf">addToAll_</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">addition</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Adds text to a particular command block in the _ID.py for all calculations</span>
<span class="sd">    in the set.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations </span>
<span class="sd">      </span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">          block (str): the name of the command block that text will be added to</span>
<span class="sd">	  addition (str): the text to be added to the block</span>
<span class="sd">	  </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">block</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">addition</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">addition</span><span class="p">)</span>    



<span class="k">def</span> <span class="nf">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">addition</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Writes the code to a single calculation&#39;s _ID.py</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">	  ID (str): ID string for the particular calculation and step</span>
<span class="sd">	  block (str): string of the block in the _ID.py that the addition is to be added to</span>
<span class="sd">	                for that step of workflow</span>
<span class="sd">	  addition (str): a string containing code to be written to the specific block</span>
<span class="sd">	                   in the _ID.py for each calculation</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>
 
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _addToBlock&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;not writing to tree because build=False flag included in AFLOWpi.maketree&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>    
        <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">fileName</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputFileText</span> <span class="o">=</span> <span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">insert</span> <span class="o">=</span>  <span class="n">addition</span>

                <span class="n">newText</span> <span class="o">=</span> <span class="s1">r&#39;</span><span class="si">%s</span><span class="s1">\n#END_</span><span class="si">%s</span><span class="s1">_BLOCK&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">insert</span><span class="p">,</span><span class="n">block</span><span class="p">)</span>
                <span class="n">newinputfile</span>  <span class="o">=</span>  <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;#END_&#39;</span><span class="o">+</span><span class="n">block</span><span class="o">+</span><span class="s1">&#39;_BLOCK&#39;</span><span class="p">,</span><span class="n">newText</span><span class="p">,</span> <span class="n">inputFileText</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfileObj</span><span class="p">:</span>
                <span class="n">outfileObj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newinputfile</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _addToBlock&#39;</span><span class="p">)</span>    
    <span class="c1">##########################################################################################################################</span>

<span class="k">def</span> <span class="nf">_writeLoggingBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">logfile</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	###############</span>
<span class="sd">	###OBSOLETE###</span>
<span class="sd">	###############</span>
<span class="sd">	Writes the mechism to start the logging at runtime in the _ID.py</span>

<span class="sd">	Arguments:</span>
<span class="sd">     	      oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd"> 	      ID (str): ID string for the particular calculation and step</span>
<span class="sd">	      logfile (str): string of the path of the logfile within the directory tree for that set of calculations</span>

<span class="sd">	Returns:</span>
<span class="sd">	      None</span>

<span class="sd">	&#39;&#39;&#39;</span>
	     
	<span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOGGING&#39;</span><span class="p">,</span><span class="s1">&#39;import logging&#39;</span><span class="p">)</span>
	<span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOGGING&#39;</span><span class="p">,</span><span class="s1">&#39;logfile=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">logfile</span><span class="p">)</span>
	<span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOGGING&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;logging.basicConfig(filename=logfile,format=&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;, datefmt=&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y %I:%M:%S %p&#39;,level=AFLOWpi.prep._getLoglevel())&#39;&#39;&#39;</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_writeToScript</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">from_step</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Generates calls on several functions to set up everything that is </span>
<span class="sd">        needed for a new step in the workflow. AFLOWpi.prep.writeToScript loops</span>
<span class="sd">	over the calculation set and calls this function to do the work on</span>
<span class="sd">	each calculation in the set.</span>

<span class="sd">	Arguments:</span>
<span class="sd">     	      oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd"> 	      ID (str): ID string for the particular calculation and step</span>
<span class="sd">	      executable (str): &lt;DEFUNCT OPTION: HERE FOR LEGACY SUPPORT&gt; </span>
<span class="sd">	      *args: &lt;DEFUNCT OPTION: HERE FOR LEGACY SUPPORT&gt;</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">	      **kwargs: &lt;DEFUNCT OPTION: HERE FOR LEGACY SUPPORT&gt;</span>

<span class="sd">        Returns:</span>
<span class="sd">	      A single calculation dictionary for a new step and its ID.</span>
<span class="sd">	      </span>
<span class="sd">	&quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _writeToScript&#39;</span><span class="p">)</span>

        <span class="n">oneCalcCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;LOG.log&#39;</span><span class="p">))</span>
	
	<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_temp_executable</span><span class="p">(</span><span class="n">oneCalcCopy</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">from_step</span><span class="o">=</span><span class="n">from_step</span><span class="p">)</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">nextIDName</span><span class="p">,</span><span class="n">nextCalcName</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getNextOneCalcVarName</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">prev_ID</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%.02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">from_step</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">prev_ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">)):</span>
                <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

	    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">from_step</span>

            <span class="n">force_one_job</span><span class="o">=</span><span class="kc">False</span>
	    <span class="k">try</span><span class="p">:</span>
		    <span class="k">if</span> <span class="n">new_job</span><span class="p">:</span>
			    <span class="n">force_one_job</span><span class="o">=</span><span class="kc">False</span>
		    <span class="k">else</span><span class="p">:</span>
			    <span class="n">force_one_job</span><span class="o">=</span><span class="kc">True</span>
	    <span class="k">except</span><span class="p">:</span>
		    <span class="n">new_job</span><span class="o">=</span><span class="kc">False</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">,</span><span class="s1">&#39;LOCK&#39;</span><span class="p">,</span><span class="s2">&quot;oneCalc,ID = AFLOWpi.prep._lock_transform(oneCalc,ID)&quot;</span><span class="p">)</span>


	    <span class="c1">##ADD COMPLETION FLAGS AT BEGINNIGN AND END OF SCRIPT</span>
	    <span class="n">set_complete_string</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;oneCalc[&#39;__status__&#39;][&#39;Complete&#39;]=False</span>
<span class="s1">AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">,</span><span class="s1">&#39;LOCK&#39;</span><span class="p">,</span><span class="n">set_complete_string</span><span class="p">)</span> 
	    <span class="n">set_complete_string</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;oneCalc[&#39;__status__&#39;][&#39;Complete&#39;]=True</span>
<span class="s1">AFLOWpi.prep._saveOneCalc(oneCalc,ID)&#39;&#39;&#39;</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">,</span><span class="s1">&#39;SUBMITNEXT&#39;</span><span class="p">,</span><span class="n">set_complete_string</span><span class="p">)</span> 




	    <span class="k">if</span> <span class="n">new_ID</span><span class="o">!=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c1">#add one to the index counter for the next step</span>
    	        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">prev_ID</span><span class="p">,</span><span class="s1">&#39;SUBMITNEXT&#39;</span><span class="p">,</span><span class="s2">&quot;globals()[&#39;__TEMP__INDEX__COUNTER__&#39;]+=1&quot;</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">prev_ID</span><span class="p">,</span><span class="s1">&#39;SUBMITNEXT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;AFLOWpi.run._submitJob(&quot;</span><span class="si">%s</span><span class="s1">&quot;,oneCalc,__submitNodeName__,forceOneJob=</span><span class="si">%s</span><span class="s1">)&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_ID</span><span class="p">,</span><span class="n">force_one_job</span><span class="p">))</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">prev_ID</span><span class="p">,</span><span class="s1">&#39;SUBMITNEXT&#39;</span><span class="p">,</span><span class="s2">&quot;globals()[&#39;__TEMP__INDEX__COUNTER__&#39;]-=1&quot;</span><span class="p">)</span>

                <span class="c1">#remove the copyback from the previous step</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_removeFromBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">prev_ID</span><span class="p">,</span><span class="s1">&#39;CLEANUP&#39;</span><span class="p">,</span><span class="s2">&quot;AFLOWpi.prep._from_local_scratch(oneCalc,ID)&quot;</span><span class="p">)</span>


            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_fillTemplate</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;at a global start timer for figuring out runtime of pw.x&#39;&#39;&#39;</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">,</span><span class="s1">&#39;LOADCALC&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;oneCalc = AFLOWpi.prep._loadOneCalc(&#39;./&#39;,&#39;</span><span class="si">%s</span><span class="s1">&#39;)&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">ID</span><span class="p">)</span>

            <span class="n">tryLoadStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">try:</span>
<span class="s1">    oneCalc = AFLOWpi.prep._loadOneCalc(&#39;./&#39;,&#39;</span><span class="si">%s</span><span class="s1">&#39;)</span>
<span class="s1">except:</span>
<span class="s1">    pass</span>

<span class="s1">oneCalc[&#39;__chain_index__&#39;]=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_ID</span><span class="p">,</span><span class="n">from_step</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">,</span><span class="s1">&#39;LOADCALC&#39;</span><span class="p">,</span><span class="n">tryLoadStr</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s1">&#39;globals()[&quot;__TEMP__INDEX__COUNTER__&quot;]=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">from_step</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            


	<span class="c1">#add the copyback to this step</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">new_ID</span><span class="p">,</span><span class="s1">&#39;CLEANUP&#39;</span><span class="p">,</span><span class="s2">&quot;AFLOWpi.prep._from_local_scratch(oneCalc,ID)&quot;</span><span class="p">)</span>


        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">new_ID</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _writeToScript&#39;</span><span class="p">)</span>            
        
        <span class="n">new_oneCalc</span><span class="p">[</span><span class="s1">&#39;__calcVarName__&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">nextCalcName</span>
        <span class="n">new_oneCalc</span><span class="p">[</span><span class="s1">&#39;__IDVarName__&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">nextIDName</span>
        <span class="n">new_oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">new_oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">new_oneCalc</span><span class="p">,</span><span class="n">new_ID</span>



<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## merge from multiple calcs</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>

	


<span class="k">def</span> <span class="nf">_loadCalcsFromOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Loads the entire calc set from one of the calculations at runtime. Used when all jobs in </span>
<span class="sd">    a set are needed to perform a task (i.e plotting data from all calculations in the set)</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd"> 	  ID (str): ID string for the particular calculation and step    </span>

<span class="sd">    Returns:</span>
<span class="sd">          The dictionary of dictionaries representing the calculation set that oneCalc </span>
<span class="sd">	  is a part of</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">PROJECT</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;PROJECT&#39;</span><span class="p">]</span>
    <span class="n">SET</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;SET&#39;</span><span class="p">]</span> 
    
    <span class="n">CONFIG</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;CONFIG.config&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="c1">#THIS NEEDS TO BE BETTER!!!!!</span>
        <span class="n">logname</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="o">+</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;_\d+&#39;</span><span class="p">,</span><span class="n">ID</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logname</span><span class="o">=</span><span class="s1">&#39;step_01&#39;</span>

    <span class="n">calcs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">loadlogs</span><span class="p">(</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">,</span><span class="n">logname</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">calcs</span>

<span class="k">def</span> <span class="nf">_checkSuccessCompletion</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Allows one of the calculations to check the status of the other calculations</span>
<span class="sd">    and returns True if all calculations in the set have completed.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd"> 	  ID (str): ID string for the particular calculation and step    </span>
<span class="sd">    </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          faultTolerant (bool): a flag to choose if we return True if some of the</span>
<span class="sd">                                 calculations ran but did not complete successfully</span>
<span class="sd">	                     </span>

<span class="sd">    Returns:</span>
<span class="sd">          True if all calculations in the set are complete and False if not.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">calcs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_loadCalcsFromOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>



    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;status of </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> is: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">],</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Complete&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Complete&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">faultTolerant</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39;if a calc failed for some reason ignore the fact that it didn&#39;t complete&#39;&#39;&#39;</span>
                <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;None&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39;if fault tolerance is false then return false if any of the calcs did not complete&#39;&#39;&#39;</span>
                <span class="k">return</span> <span class="kc">False</span>


    <span class="sd">&#39;&#39;&#39;if all calcs are completed for this step return True&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="kc">True</span>



<div class="viewcode-block" id="runAfterAllDone"><a class="viewcode-back" href="../prep.html#prep.runAfterAllDone">[docs]</a><span class="k">def</span> <span class="nf">runAfterAllDone</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;   </span>
<span class="sd">    Adds a command to the BATCH command block at the end of each calculation&#39;s _ID.py </span>
<span class="sd">    for all calculations in the set. Used to execute a command over all calculations</span>
<span class="sd">    in particular step have completed.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  command (str): the text to be added to the BATCH block</span>
<span class="sd">          faultTolerant (bool): a flag to choose if we return True if some of the</span>
<span class="sd">                                 calculations ran but did not complete successful          </span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">completionBool</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;if AFLOWpi.prep._checkSuccessCompletion(oneCalc,ID,faultTolerant=</span><span class="si">%s</span><span class="s1">):&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">faultTolerant</span>
    <span class="n">addition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import copy</span>
<span class="s2">AFLOWpi.prep._saveOneCalc(oneCalc,ID)</span>


<span class="si">%s</span><span class="s2"></span>
<span class="s2">         try:</span>
<span class="s2">            calcs = AFLOWpi.prep._loadCalcsFromOneCalc(oneCalc,ID)</span>
<span class="s2">         except Exception,e:</span>
<span class="s2">            AFLOWpi.run._fancy_error_log(e)</span>



<span class="s2">         </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">else: </span>
<span class="s2">         pass</span>

<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">completionBool</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;BATCH&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">addition</span><span class="p">)</span></div>
    


<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## hashing</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">##################################################################################################################### </span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="k">def</span> <span class="nf">_hash64String</span><span class="p">(</span><span class="n">hashString</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Takes a string and returns a 16 character long CRC64 hash checksum of it.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          hashString (str): the string you want a hash checksum of</span>


<span class="sd">    Returns:</span>
<span class="sd">          hashed_str (str): a 16 character long CRC64 hash of the inputted string</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">hashString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_parseRef</span><span class="p">(</span><span class="n">hashString</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_crc64digest</span><span class="p">(</span><span class="n">hashString</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_crc64digest</span><span class="p">(</span><span class="n">aString</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the CRC64 hash checksum of the inputted string.</span>

<span class="sd">    From W. H. Press, S. A. Teukolsky, W. T. Vetterling, and </span>
<span class="sd">    B. P. Flannery, &quot;Numerical recipes in C</span>

<span class="sd">    Arguments:</span>
<span class="sd">          aString (str): a string</span>

<span class="sd">    Returns:</span>
<span class="sd">          hashed_str (str): a 16 character long CRC64 hash of the inputted string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CRCTableh</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
    <span class="n">CRCTablel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
    <span class="k">def</span> <span class="nf">_inittables</span><span class="p">(</span><span class="n">CRCTableh</span><span class="p">,</span> <span class="n">CRCTablel</span><span class="p">,</span> <span class="n">POLY64REVh</span><span class="p">,</span> <span class="n">BIT_TOGGLE</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
                    <span class="n">partl</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">parth</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                            <span class="n">rflag</span> <span class="o">=</span> <span class="n">partl</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="n">L</span>
                            <span class="n">partl</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="n">L</span>
                            <span class="k">if</span> <span class="n">parth</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">partl</span> <span class="o">^=</span> <span class="n">BIT_TOGLE</span>
                            <span class="n">parth</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="n">L</span>
                            <span class="k">if</span> <span class="n">rflag</span><span class="p">:</span>
                                    <span class="n">parth</span> <span class="o">^=</span> <span class="n">POLY64REVh</span>
                    <span class="n">CRCTableh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parth</span>
                    <span class="n">CRCTablel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">partl</span>
    <span class="c1"># first 32 bits of generator polynomial for CRC64 (the 32 lower bits are</span>
    <span class="c1"># assumed to be zero) and bit-toggle mask used in _inittables</span>
    <span class="n">POLY64REVh</span> <span class="o">=</span> <span class="mh">0xd8000000</span><span class="n">L</span>
    <span class="n">BIT_TOGGLE</span> <span class="o">=</span> <span class="mi">1</span><span class="n">L</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="n">L</span>
    <span class="c1"># run the function to prepare the tables</span>
    <span class="n">_inittables</span><span class="p">(</span><span class="n">CRCTableh</span><span class="p">,</span> <span class="n">CRCTablel</span><span class="p">,</span> <span class="n">POLY64REVh</span><span class="p">,</span> <span class="n">BIT_TOGGLE</span><span class="p">)</span>
    <span class="c1"># remove all names we don&#39;t need any more, including the function</span>
    <span class="k">del</span> <span class="n">_inittables</span><span class="p">,</span> <span class="n">POLY64REVh</span><span class="p">,</span> <span class="n">BIT_TOGGLE</span>
    <span class="c1"># this module exposes the following two functions: crc64, crc64digest</span>
    <span class="k">def</span> <span class="nf">crc64</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="p">(</span><span class="n">crch</span><span class="p">,</span> <span class="n">crcl</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)):</span>
                    <span class="n">shr</span> <span class="o">=</span> <span class="p">(</span><span class="n">crch</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span>
                    <span class="n">temp1h</span> <span class="o">=</span> <span class="n">crch</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="n">L</span>
                    <span class="n">temp1l</span> <span class="o">=</span> <span class="p">(</span><span class="n">crcl</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="n">L</span><span class="p">)</span> <span class="o">|</span> <span class="n">shr</span>
                    <span class="n">tableindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">crcl</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="n">byte</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> 
                    <span class="n">crch</span> <span class="o">=</span> <span class="n">temp1h</span> <span class="o">^</span> <span class="n">CRCTableh</span><span class="p">[</span><span class="n">tableindex</span><span class="p">]</span>
                    <span class="n">crcl</span> <span class="o">=</span> <span class="n">temp1l</span> <span class="o">^</span> <span class="n">CRCTablel</span><span class="p">[</span><span class="n">tableindex</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">crch</span><span class="p">,</span> <span class="n">crcl</span>


    <span class="n">checksum</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%08X%08X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crc64</span><span class="p">(</span><span class="n">aString</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">checksum</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<div class="viewcode-block" id="cleanCalcs"><a class="viewcode-back" href="../prep.html#prep.cleanCalcs">[docs]</a><span class="k">def</span> <span class="nf">cleanCalcs</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wrapper function for AFLOWpi.prep._cleanCalcs</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations     </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  runlocal (bool): a flag to choose whether or not to run the wrapped function now</span>
<span class="sd">	                    or write it to the _ID.py to run during the workflow   </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">runlocal</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cleanCalcs</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CLEANUP&#39;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi.prep._cleanCalcs(ID,oneCalc)&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_cleanCalcs</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Removes all files from the directory tree with a &quot;_&quot; prefix.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">fileList</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/_*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fileList</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>


<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## calc transforms</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>


<div class="viewcode-block" id="bands"><a class="viewcode-back" href="../prep.html#prep.bands">[docs]</a><span class="k">def</span> <span class="nf">bands</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">dk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">n_conduction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	Wrapper function to write the function AFLOWpi.prep._oneBands to the _ID.py</span>

<span class="sd">	Arguments:</span>
<span class="sd">	      calcs (dict): a dictionary of dicionaries representing the set of calculations </span>

<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      dk (float): distance between points for Electronic Band Structure calculation</span>
<span class="sd">	      nk (int): approximate number of k points to be calculated along the path</span>
<span class="sd">		  	      </span>
<span class="sd">	Returns:</span>
<span class="sd">	      The identical &quot;calcs&quot; input variable</span>

<span class="sd">	&#39;&#39;&#39;</span>

	<span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;AFLOWpi.prep._oneBands(oneCalc,ID,dk=</span><span class="si">%s</span><span class="s1">,nk=</span><span class="si">%s</span><span class="s1">,n_conduction=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span><span class="n">nk</span><span class="p">,</span><span class="n">n_conduction</span><span class="p">)</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">calcs</span></div>



<span class="nd">@newstepWrapper</span><span class="p">(</span><span class="n">_check_lock</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_oneBands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">dk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">configFile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">n_conduction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Add the ncsf with the electronic band structure path k points input to each </span>
<span class="sd">	subdir and update the master dictionary.</span>

<span class="sd">	Arguments:</span>
<span class="sd">     	      oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd"> 	      ID (str): ID string for the particular calculation and step</span>

<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      dk (float): the density in the Brillouin zone of the k point sampling along the </span>
<span class="sd">                           entirety of the path between high symmetry points.</span>
<span class="sd">	      nk (int): the approximate number of sampling points in the Brillouin Zone along</span>
<span class="sd"> 	                 the entirety of the path between high symmetry points. Points are chosen </span>
<span class="sd">		         so that they are equidistant along the entirety of the path. The actual </span>
<span class="sd">		         number of points will be slightly different than the inputted value of nk.</span>
<span class="sd">		         nk!=None will override any value for dk.</span>


<span class="sd">	Returns:</span>
<span class="sd">	      A calculation that has been transformed from scf to nscf with k point sampling</span>
<span class="sd">	      along the high symmetry path in the Brillouin Zone</span>

<span class="sd">	&quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _oneBands&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>                
                <span class="sd">&#39;&#39;&#39;we need nscf and not bands because we need output for HOMO&#39;&#39;&#39;</span>
                <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not exist. Can not make bands calculations. Exiting&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>
                    <span class="k">raise</span> <span class="ne">SystemExit</span>


        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="sd">&#39;&#39;&#39;checks to see if &quot;crystal_b&quot; has already been substituted for &quot;automatic&quot;&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prevID_str</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">prev_calc</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">prev_calc</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c1">#                    match1 = re.findall(r&#39;Kohn-Sham states\s*=\s*([0-9]*)&#39;,outfile)[-1]</span>
		    <span class="n">match1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;number of electrons\s*=\s*([.0-9]*)&#39;</span><span class="p">,</span><span class="n">outfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>
		    <span class="n">nbnd</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_num_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>

		    <span class="k">if</span> <span class="n">n_conduction</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
			    <span class="n">nbnd</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_num_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
		    <span class="k">else</span><span class="p">:</span>
			    <span class="n">nbnd</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_num_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">mult</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">n_conduction</span>


                    <span class="n">prevID_str</span><span class="o">=</span><span class="n">prev_calc</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="nb">print</span> <span class="n">e</span>
			<span class="k">pass</span>

            <span class="n">bandsKRegex</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">k_points</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="s1">&#39;regex&#39;</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;sets dk to generic value if no option for dk or nk is used&#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">nk</span><span class="o">==</span><span class="kc">None</span> <span class="ow">and</span> <span class="n">dk</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">dk</span><span class="o">=</span><span class="mf">0.1</span>
                <span class="sd">&#39;&#39;&#39;if dk isn&#39;t set but nk is..set dk small and average out later with nk&#39;&#39;&#39;</span>
            <span class="k">elif</span> <span class="n">dk</span><span class="o">==</span><span class="kc">None</span> <span class="ow">and</span> <span class="n">nk</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">dk</span><span class="o">=</span><span class="mf">0.001</span>


            <span class="n">path</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">prevID_str</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">nk</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">total</span><span class="o">=</span><span class="mi">0</span>
		<span class="n">splitPath</span><span class="o">=</span><span class="p">[]</span>
                <span class="sd">&#39;&#39;&#39;scale the k points in the path list so they&#39;re as close to nk as possible&#39;&#39;&#39;</span>
		<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
				<span class="n">xsplit</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
				<span class="n">letter</span> <span class="o">=</span> <span class="n">xsplit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="n">num</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsplit</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="c1">#				coords = xsplit[:3]</span>
				<span class="n">total</span> <span class="o">+=</span> <span class="n">num</span>
				<span class="k">if</span> <span class="n">num</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
					<span class="n">total</span><span class="o">+=</span><span class="mi">1</span>
<span class="c1">#				splitPath.append([coords,num,letter])</span>
			
<span class="c1">#			except Exception,e:</span>
<span class="c1">#				print e</span>
<span class="c1">#				pass</span>
<span class="c1">#			[x.split()[0],int(x.split()[1])] for x in  </span>

<span class="c1">#                splitPath =  [[x.split()[0],int(x.split()[1])] for x in  path.split(&#39;\n&#39;)[1:] if len(x)!=0]</span>
<span class="c1">#                total =  [int(x.split()[1]) for x in  path.split(&#39;\n&#39;)[1:] if len(x)!=0]</span>

<span class="c1">#                for entries in range(len(total)):</span>
 <span class="c1">#                   if total[entries]==0:</span>
  <span class="c1">#                      total[entries]+=1</span>

<span class="c1">#                total=sum(total)</span>
                <span class="n">scaleFactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span><span class="o">/</span><span class="n">total</span>

		<span class="n">path</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="n">dk</span><span class="o">/</span><span class="n">scaleFactor</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">prevID_str</span><span class="p">)</span>
		<span class="nb">print</span> <span class="n">path</span>
		

            <span class="n">inputSplit</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>


            <span class="n">inputSplit</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;nscf&#39;&quot;</span>
            <span class="n">inputSplit</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;noinv&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;.true.&quot;</span>
            <span class="n">inputSplit</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;nosym&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;.true.&quot;</span>
	    <span class="k">try</span><span class="p">:</span>
		    <span class="n">inputSplit</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;nbnd&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nbnd</span>
	    <span class="k">except</span><span class="p">:</span>
		    <span class="k">pass</span>

            <span class="n">inputSplit</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{crystal_b}</span><span class="s1">&#39;</span>
            <span class="n">inputSplit</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">path</span>

	    
            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputSplit</span><span class="p">)</span>

            <span class="n">calc_label</span> <span class="o">=</span> <span class="n">ID</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_inputfile</span><span class="p">:</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>


            <span class="n">inputSplit</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputSplit</span><span class="p">)</span>

<span class="c1">###############################################################################################################</span>
	    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>


        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>
            

	<span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
<span class="c1">####################################################################################################################</span>
<span class="kn">import</span> <span class="nn">math</span>

<div class="viewcode-block" id="bandsAflow"><a class="viewcode-back" href="../prep.html#prep.bandsAflow">[docs]</a><span class="k">def</span> <span class="nf">bandsAflow</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span> <span class="n">LAT</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Query aflow for band structure path and generate the path for band structure calculation</span>

<span class="sd">	Arguments:</span>
<span class="sd">	      dk (float):  distance between k points along path in Brillouin Zone</span>
<span class="sd">	      LAT (int): bravais lattice number from Quantum Espresso convention</span>

<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      None</span>

<span class="sd">	Returns:</span>
<span class="sd">	     info (str): some information</span>
<span class="sd">	     nks (str): number of k points in path</span>
<span class="sd">	     stringk (str): kpoint path string</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1">#logging.info(&#39;Running aqe&#39;)</span>
	<span class="n">COMMAND</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./aqe&#39;</span><span class="p">,</span> <span class="s1">&#39;--bzd&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">LAT</span><span class="p">)]</span>
	<span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
	<span class="n">fromaqe</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>	

<span class="c1"># we use aqe --qe --bzd LAT</span>
<span class="c1"># e.g. ./aqe --bzd RHL1</span>
<span class="c1">#RHL1 (rhombohedral alpha&lt;90) G-L-B1 B-Z-G-X Q-F-P1-Z L-P</span>
<span class="c1">#20   ! 20 grids </span>
<span class="c1">#Line-mode</span>
<span class="c1">#reciprocal</span>
<span class="c1">#   0.000   0.000   0.000    ! \Gamma</span>
<span class="c1">#   0.500   0.000   0.000    ! L</span>
<span class="c1">#</span>
<span class="c1">#   0.500   0.000   0.000    ! L</span>
<span class="c1">#   0.500  0.5  -0.5  ! B_1</span>
<span class="c1">#</span>
<span class="c1">#   0.5  0.500  0.5  ! B</span>
<span class="c1">#   0.500   0.500   0.500    ! Z</span>
<span class="c1">#</span>
<span class="c1">#   0.500   0.500   0.500    ! Z</span>
<span class="c1">#   0.000   0.000   0.000    ! \Gamma</span>
<span class="c1">#</span>
<span class="c1">#   0.000   0.000   0.000    ! \Gamma</span>
<span class="c1">#   0.5  0.000  -0.5  ! X</span>
<span class="c1">#</span>
<span class="c1">#   0.5  0.5  0.000   ! Q</span>
<span class="c1">#   0.500   0.500   0.000    ! F</span>
<span class="c1">#</span>
<span class="c1">#   0.500   0.500   0.000    ! F</span>
<span class="c1">#   0.5  0.5  0.5  ! P_1</span>
<span class="c1">#</span>
<span class="c1">#   0.5  0.5  0.5  ! P_1</span>
<span class="c1">#   0.500   0.500   0.500    ! Z</span>
<span class="c1">#</span>
<span class="c1">#   0.500   0.000   0.000    ! L</span>
<span class="c1">#   0.5  0.5  0.5  ! P</span>
	
	<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">fromaqe</span><span class="p">)</span>
	<span class="n">kkk</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\s&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">:]:</span>
		<span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
			<span class="n">label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;</span><span class="se">\\</span><span class="s1">|_|amma&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">kk</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">kk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="k">pass</span>
			<span class="n">kkk</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">label</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kk</span><span class="p">)})</span>
	
	<span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">stringk</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
	<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;\w-\w&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
			<span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

	<span class="n">nk</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">piece</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
		<span class="n">ks</span> <span class="o">=</span> <span class="n">kkk</span><span class="p">[</span><span class="n">piece</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">piece</span><span class="p">:</span>
			<span class="n">ke</span> <span class="o">=</span> <span class="n">kkk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
			<span class="n">km</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="n">km</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">ke</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
			<span class="n">nk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">km</span><span class="p">)</span><span class="o">/</span><span class="n">dk</span><span class="p">))</span>
			<span class="n">ks</span> <span class="o">=</span> <span class="n">ke</span>

	
	<span class="n">jc</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="k">for</span> <span class="n">piece</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">piece</span><span class="p">:</span>
			<span class="n">t1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">% 05.3f</span><span class="s1"> </span><span class="si">% 05.3f</span><span class="s1"> </span><span class="si">% 05.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kkk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">t2</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%3d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nk</span><span class="p">[</span><span class="n">jc</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">t2</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%3d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mi">0</span>
			<span class="n">t3</span> <span class="o">=</span> <span class="s1">&#39; !&#39;</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
			<span class="n">stringk</span> <span class="o">+=</span> <span class="n">t1</span><span class="o">+</span><span class="n">t2</span><span class="o">+</span><span class="n">t3</span>
			<span class="n">jc</span> <span class="o">+=</span> <span class="mi">1</span>
	<span class="n">nks</span> <span class="o">=</span> <span class="n">jc</span> <span class="o">-</span> <span class="mi">1</span>	

		
	<span class="k">return</span> <span class="n">info</span><span class="p">,</span> <span class="n">nks</span><span class="p">,</span> <span class="n">stringk</span></div>


<div class="viewcode-block" id="maketree"><a class="viewcode-back" href="../prep.html#prep.maketree">[docs]</a><span class="k">def</span> <span class="nf">maketree</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span> <span class="n">pseudodir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Make the directoy tree and place in the input file there</span>
<span class="sd">	</span>
<span class="sd">	Arguments:</span>
<span class="sd">	      calcs (dict): - Dictionary of dictionaries of calculations</span>

<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      pseudodir (str): path of pseudopotential files directory </span>
<span class="sd">              workdir (str): a string of the workdir path that be used to override what is in the </span>
<span class="sd">	         	   config file used when initating the AFLOWpi session</span>



<span class="sd">        Returns:</span>
<span class="sd">	      None</span>

<span class="sd">	&quot;&quot;&quot;</span>




        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entering makeAFLOWpitree&#39;</span><span class="p">)</span>
        <span class="n">megahashStr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">megahashStr</span><span class="o">+=</span><span class="n">ID</span>
            <span class="n">__MASTER__KEY__</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_crc64digest</span><span class="p">(</span><span class="n">megahashStr</span><span class="p">)</span>


        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pseudodir</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">pseudodir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;pseudo_dir&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                    <span class="n">pseudodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">pseudodir</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">pseudodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="n">pseudodir</span><span class="p">))</span>

            <span class="n">configFileName</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>

            <span class="n">topdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">topdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])))</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">printFlag</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
                <span class="n">printFlag</span><span class="o">=</span><span class="mi">0</span>
                <span class="nb">print</span> <span class="s2">&quot;Writing input files to directory tree&quot;</span>



        <span class="n">counter</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># create the subdir under topdir</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">ddir</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>

                    <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ddir</span><span class="p">),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;LOG.log&#39;</span><span class="p">))</span> 

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ddir</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">ddir</span><span class="p">)</span>


                    <span class="sd">&quot;&quot;&quot;Get name of logfile for this calc&quot;&quot;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 

<span class="c1">#        if build==False:</span>
<span class="c1">#            global __DONOTBUILD__</span>
<span class="c1">#            __DONOTBUILD__= True</span>
            
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>

                        <span class="n">ddir</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;_AFLOWPI_FOLDER_&quot;</span><span class="p">]</span>

                        <span class="sd">&quot;&quot;&quot;place the input file in the dir&quot;&quot;&quot;</span>
                        <span class="n">finp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ddir</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
			<span class="n">orig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ddir</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;.orig&#39;</span><span class="p">)</span>

                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="sd">&quot;&quot;&quot;generate initial SCF executable in folder&quot;&quot;&quot;</span>
			<span class="n">CONFIG_FILE</span> <span class="o">=</span> <span class="s1">&#39;../AFLOWpi/CONFIG.config&#39;</span>
			<span class="n">calcs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONFIG_FILE</span>

                        <span class="n">calcs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ddir</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">finp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ddir</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 

                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;not writing to tree because build=False flag included in AFLOWpi.maketree&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>

			    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_writeTemplate</span><span class="p">(</span><span class="n">finp</span><span class="p">)</span>
			    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_fillTemplate</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>


                    <span class="n">configFile</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">clusterType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;UGE&#39;</span><span class="p">]:</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_qsubGen</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


                <span class="c1"># copy the pseudo file</span>
                <span class="k">if</span> <span class="n">pseudodir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">r&#39;_AFLOWPI_[A-Z]\d*PSEUDO_&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
                                    <span class="k">try</span><span class="p">:</span>
                                                <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
                                                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copy_pseudos&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                                                    <span class="n">pseudodir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;pseudo_dir&#39;</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                                                        <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
                                                        <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                                                        <span class="n">pseudodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">pseudodir</span><span class="p">)</span>


                                                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">,</span><span class="n">m</span><span class="p">)):</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">,</span><span class="n">m</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">m</span><span class="p">))</span>
                                                        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                                                            <span class="k">try</span><span class="p">:</span>
                                                                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">m</span><span class="p">))</span>
                                                                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">,</span><span class="n">m</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">m</span><span class="p">))</span>
                                                            <span class="k">except</span><span class="p">:</span>
                                                                <span class="nb">print</span> <span class="n">m</span>
                                                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                                                            <span class="nb">print</span> <span class="n">e</span>
                                                    <span class="k">else</span><span class="p">:</span>
                                                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Count not find </span><span class="si">%s</span><span class="s1"> check if your pseudodir in config is properly set&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">,</span><span class="n">m</span><span class="p">))</span>
                                                    
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="k">if</span> <span class="n">printFlag</span><span class="p">:</span>
							    <span class="k">pass</span>

                                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ddir</span><span class="p">,</span><span class="n">m</span><span class="p">)):</span>
                                                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ddir</span><span class="p">)</span> 
                                    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="nb">print</span> <span class="n">e</span>
                                        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="nb">print</span> <span class="n">e</span>
                                        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>	

                                    
        <span class="sd">&#39;&#39;&#39;saving the first set of calcs so they can be loaded by the script when the first calcs start&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
<span class="c1">#            oneCalc_file_path = os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;_%s.oneCalc&#39;%ID)</span>
<span class="c1">#            if not os.path.exists(oneCalc_file_name):</span>
<span class="c1">#		    AFLOWpi.prep._saveOneCalc(oneCalc,ID)</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;ONECALC&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;oneCalc = AFLOWpi.prep._loadOneCalc(&#39;./&#39;,&#39;</span><span class="si">%s</span><span class="s1">&#39;)&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">ID</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;ONECALC&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;oneCalc = AFLOWpi.prep._loadOneCalc(&#39;./&#39;,&#39;</span><span class="si">%s</span><span class="s1">&#39;)&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">ID</span><span class="p">)</span>
                

	<span class="n">index</span><span class="o">=</span><span class="mi">1</span>
	
	<span class="n">updatelogs</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;step_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">index</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting makeAFLOWpitree&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="totree"><a class="viewcode-back" href="../prep.html#prep.totree">[docs]</a><span class="k">def</span> <span class="nf">totree</span><span class="p">(</span><span class="n">tobecopied</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Populate all the subdirectories for the calculation with the file in input</span>

<span class="sd">	Arguments:</span>
<span class="sd">	      tobecopied (str): filepath to be copied to the AFLOWpi directory tree</span>
<span class="sd"> 	      calcs (dict): Dictionary of dictionaries of calculations</span>
<span class="sd"> </span>
<span class="sd">        Keyword Arguments:</span>
<span class="sd">	      rename (bool): option to rename the file/directory being moves into the AFLOWpi</span>
<span class="sd">	                  directory tree</span>
<span class="sd">	      symlink (bool): whether to copy the data to the AFLOWpi directory tree or </span>
<span class="sd">	                   to use symbolic links</span>

<span class="sd">        Returns:</span>
<span class="sd">	      None</span>
<span class="sd">		</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Entering totree&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">topdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">())][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>
            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            
	<span class="n">printBool</span><span class="o">=</span><span class="mi">1</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
		<span class="n">printBool</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">actualFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tobecopied</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
	<span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

		<span class="n">a</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">rename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">actualFile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">symlink</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">tobecopied</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">printBool</span><span class="p">:</span>
			    <span class="k">pass</span>

                    <span class="k">try</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tobecopied</span><span class="p">):</span> 
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">actualFile</span><span class="p">)):</span>
                                    <span class="k">try</span><span class="p">:</span>
					    <span class="k">if</span> <span class="ow">not</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">tobecopied</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">actualFile</span><span class="p">)):</span>
						    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tobecopied</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> 
					
					    <span class="k">else</span><span class="p">:</span>
						    <span class="k">if</span> <span class="n">printBool</span><span class="p">:</span>
							    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Identical copy of </span><span class="si">%s</span><span class="s1"> Exists in </span><span class="si">%s</span><span class="s1">, not copying to this subdirectory of tree&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">actualFile</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>
				    <span class="k">except</span><span class="p">:</span>
					    <span class="k">pass</span>
                                <span class="k">else</span><span class="p">:</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tobecopied</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> 
					<span class="k">except</span><span class="p">:</span>
						<span class="k">pass</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>

				    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="n">tobecopied</span><span class="o">+</span><span class="s2">&quot; does not exist in AFLOWpi Directory&quot;</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">tobecopied</span><span class="o">+</span><span class="s2">&quot; does not exist in AFLOWpi Directory&quot;</span><span class="p">)</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exiting totree&quot;</span><span class="p">)</span></div>



<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## CALCLOGS</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>


<div class="viewcode-block" id="updatelogs"><a class="viewcode-back" href="../prep.html#prep.updatelogs">[docs]</a><span class="k">def</span> <span class="nf">updatelogs</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">logname</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">logname</span><span class="o">==</span><span class="s1">&#39;LOG&#39;</span> <span class="ow">or</span> <span class="n">logname</span><span class="o">==</span><span class="s1">&#39;AFLOWKEYS&#39;</span> <span class="ow">or</span> <span class="n">logname</span><span class="o">==</span><span class="s1">&#39;summary&#39;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;calc log name cannot be the same as master log file i.e. LOG,AFLOWKEYS, or summary&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;calc log name cannot be the same as master log file i.e LOG,AFLOWKEYS, or summary&#39;</span>
        <span class="k">return</span>



    <span class="sd">&#39;&#39;&#39;find calclogdir and if it doesn&#39;t exist create it (it should exist)&#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">baseDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">))</span>

        <span class="n">calcLogDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span><span class="s1">&#39;calclogs&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">calcLogDir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">calcLogDir</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="sd">&#39;&#39;&#39;write the location of each of the _ID.oneCalc files for all the calcs&#39;&#39;&#39;</span>
    <span class="n">log_file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">calcLogDir</span><span class="p">,</span><span class="n">logname</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file_name</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">testLogFile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">dname</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s2">&quot;PROJECT&quot;</span><span class="p">],</span><span class="n">oneCalc</span><span class="p">[</span><span class="s2">&quot;SET&quot;</span><span class="p">],</span><span class="n">oneCalc</span><span class="p">[</span><span class="s2">&quot;_AFLOWPI_INDEX_&quot;</span><span class="p">])</span>
            <span class="n">testLogFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;../../&quot;</span><span class="p">,</span><span class="n">dname</span><span class="p">,</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.oneCalc&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;daemon&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
	    <span class="n">list_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span><span class="s1">&#39;submission_daemon&#39;</span><span class="p">,</span><span class="s1">&#39;log_list.log&#39;</span><span class="p">)</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submit_log_append</span><span class="p">([</span><span class="n">log_file_name</span><span class="p">],</span><span class="n">logname</span><span class="o">=</span><span class="n">list_log</span><span class="p">)</span>        </div>


<div class="viewcode-block" id="loadlogs"><a class="viewcode-back" href="../prep.html#prep.loadlogs">[docs]</a><span class="k">def</span> <span class="nf">loadlogs</span><span class="p">(</span><span class="n">PROJECT</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">SET</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">logname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">suppress_warning</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
         <span class="n">configFile</span><span class="o">=</span><span class="n">config</span>
         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;configuration file: </span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
             <span class="nb">print</span> <span class="s1">&#39;configuration file: </span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">config</span>
             <span class="k">raise</span> <span class="ne">SystemExit</span>


         <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         put configFile global into the namespace as it would be if we did AFLOWpi.prep.init</span>
<span class="sd">         &#39;&#39;&#39;</span>
         <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>        

         <span class="n">workdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;work_dir&#39;</span><span class="p">)</span>



         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
             <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
             <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
             <span class="n">workdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>

         <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         FIX THSI         FIX THIS         FIX THIS         FIX THIS         FIX THIS</span>
<span class="sd">         &quot;&quot;&quot;</span>
         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
             <span class="n">execDIR</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">__file__</span><span class="p">))</span>
             <span class="n">config</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">execDIR</span><span class="p">,</span><span class="n">config</span><span class="p">))</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="k">pass</span>

<span class="c1">#	 if not os.path.exists(config):</span>
<span class="c1">#		 print &quot;config %s does not exist. Exiting&quot;</span>
<span class="c1">#		 raise SystemExit</span>

         <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
         <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         FIX THSI         FIX THIS         FIX THIS         FIX THIS         FIX THIS</span>
<span class="sd">         &quot;&quot;&quot;</span>
         <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;calclogs&#39;</span><span class="p">,</span><span class="n">logname</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span>

         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
             <span class="sd">&quot;&quot;&quot;in case we have split files with .dat,.bak,and .dir&quot;&quot;&quot;</span>
             <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;calclogs&#39;</span><span class="p">,</span><span class="n">logname</span><span class="o">+</span><span class="s1">&#39;.dat&#39;</span><span class="p">))</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                 <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;calclogs&#39;</span><span class="p">,</span><span class="n">logname</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span><span class="p">))</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saved calc log: </span><span class="si">%s</span><span class="s1"> does not exist. Check the workdir parameter in your config file as well as project and set of these calcs.&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                     <span class="nb">print</span> <span class="s1">&#39;saved calc log: </span><span class="si">%s</span><span class="s1"> does not exist. Check the workdir parameter in your config file  as well as project and set of these calcs.&#39;</span> <span class="o">%</span> <span class="n">filename</span>
                     <span class="k">raise</span> <span class="ne">SystemExit</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;calclogs&#39;</span><span class="p">,</span><span class="n">logname</span><span class="p">)</span>


         <span class="n">calcs</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_load_log_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

         <span class="k">return</span> <span class="n">calcs</span></div>


<span class="k">def</span> <span class="nf">_load_log_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
         <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         pull logs from the file</span>
<span class="sd">         &#39;&#39;&#39;</span>
	 <span class="k">try</span><span class="p">:</span>
		 <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">logLocFile</span><span class="p">:</span>
			 <span class="n">logLocString</span> <span class="o">=</span> <span class="n">logLocFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
	 <span class="k">except</span><span class="p">:</span>
		 <span class="k">return</span> <span class="p">{}</span>
	 <span class="n">bn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
         <span class="n">logFiles</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bn</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">logLocString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
	 
         <span class="n">returnCalcs</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
         <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logFiles</span><span class="p">:</span>
             <span class="n">ID</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">log</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]</span>
	     
             <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">log</span><span class="p">))</span>
             <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">             try to load the log from each folder but if it doesn&#39;t exist</span>
<span class="sd">             or none of the ID.oneCalc files exist return a blank string</span>
<span class="sd">             &#39;&#39;&#39;</span>
             <span class="k">try</span><span class="p">:</span>
		     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">oneCalcPickleFile</span><span class="p">:</span>
			     <span class="n">oneCalc</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">oneCalcPickleFile</span><span class="p">)</span>    

		     <span class="n">returnCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span>
             <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                 <span class="k">pass</span>

         <span class="k">try</span><span class="p">:</span>
             <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">             set the global counter number to what it was when the calcs saved so we don&#39;t</span>
<span class="sd">             overwrite the previous steps when the counter starts from 1 again</span>
<span class="sd">             &#39;&#39;&#39;</span>

             <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">             when the calc logs are loaded it&#39;s assumed that the previous steps have been </span>
<span class="sd">             completed so it assumes we&#39;re starting from this step and sets the step loaded&#39;s </span>
<span class="sd">             ID in the _&lt;prefix&gt;.Walltime to stepsasjobs=&#39;true&#39; so that the timing works</span>
<span class="sd">             correctly for the restart in the case of stepsasjobs=&#39;false&#39; in the config</span>
<span class="sd">             &#39;&#39;&#39;</span>

             <span class="n">returnCalcs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">returnCalcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">]))</span>
             <span class="k">return</span> <span class="n">returnCalcs</span>
         <span class="k">except</span><span class="p">:</span>
             <span class="k">return</span> <span class="n">returnCalcs</span>


<span class="k">def</span> <span class="nf">_updatecalclogs</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">inc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Save the log for aflowkeys</span>

<span class="sd">	Arguments:</span>
<span class="sd">	       aflowkeys (dict): keys from aflow</span>
<span class="sd">	       calcs (dict): Dictionary of dictionaries of calculations</span>
<span class="sd">	 Keyword Arguments:</span>
<span class="sd">    	       inc (bool): choose to increment the logs or not (True,False)</span>
<span class="sd">	&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">,</span><span class="n">fc</span><span class="p">)):</span>
            <span class="n">inc</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">,</span><span class="n">fa</span><span class="p">)):</span>
            <span class="n">inc</span><span class="o">=</span><span class="kc">False</span>


	<span class="n">baseDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">())][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>
 	<span class="n">AFLOWpidir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">())][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">))</span>
	
	<span class="n">fc</span> <span class="o">=</span> <span class="s1">&#39;CALCSMASTER.log&#39;</span>
	
	<span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
		<span class="n">inccalc</span> <span class="o">=</span> <span class="p">[]</span>


		<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fc</span><span class="o">+</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
				<span class="n">inccalc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">:]))</span>



		<span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">inccalc</span><span class="p">):</span>
			<span class="n">mc</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">mc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">inccalc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

		<span class="n">fou</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">mc</span><span class="p">)</span>
		<span class="n">A</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">,</span> <span class="n">fc</span><span class="p">)</span>
		<span class="n">B</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">,</span> <span class="n">fou</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>
		<span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
		<span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
		<span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">,</span><span class="n">fc</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
		<span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
		<span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>








<span class="kn">import</span> <span class="nn">socket</span>


<span class="k">def</span> <span class="nf">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.oneCalc&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">oneCalcPickleFile</span><span class="p">:</span>
			<span class="n">oldOneCalc</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">oneCalcPickleFile</span><span class="p">)</span>    

<span class="k">def</span> <span class="nf">_loadOneCalc</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>

	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.oneCalc&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">oneCalcPickleFile</span><span class="p">:</span>
		<span class="n">oldOneCalc</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">oneCalcPickleFile</span><span class="p">)</span>    
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFileObj</span><span class="p">:</span>
                <span class="n">inputFileString</span> <span class="o">=</span> <span class="n">inputFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            
	    <span class="n">oldOneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">oldOneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">inputFileString</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oldOneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">oldOneCalc</span>
	



<span class="k">def</span> <span class="nf">_updatelogs</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering AFLOWpi.prep._updatelogs&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get index of this calc we&#39;re saving in the chain so we can</span>
<span class="sd">    restart with it if we do loadlogs in another script.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="n">index</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
	    <span class="n">index</span> <span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;step_(\d*)_*&#39;</span><span class="p">,</span><span class="n">ID</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save this calc just in case it&#39;s the last in the current chain and we want to restart from it</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>



<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## LOCAL SCRATCH</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>

<span class="k">def</span> <span class="nf">_scp_wrapper</span><span class="p">(</span><span class="n">from_path</span><span class="p">,</span><span class="n">to_path</span><span class="p">,</span><span class="n">node</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>

         <span class="sd">&#39;&#39;&#39;try rsync first and fallback to scp&#39;&#39;&#39;</span>
	 <span class="n">command</span><span class="o">=</span><span class="s2">&quot;ssh -o StrictHostKeyChecking=no </span><span class="si">%s</span><span class="s2"> &#39;rsync -ru  </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">/ &gt; /dev/null&#39; &gt; /dev/null&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">from_path</span><span class="p">,</span><span class="n">to_path</span><span class="p">)</span>
	 
	 <span class="k">if</span> <span class="n">node</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
		 <span class="n">command</span><span class="o">=</span><span class="s1">&#39;cp -r  </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">from_path</span><span class="p">,</span><span class="n">to_path</span><span class="p">)</span>    
	 
	 <span class="k">try</span><span class="p">:</span>
		 <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		 <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
		 <span class="n">end</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
	 <span class="k">except</span><span class="p">:</span>
		 <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;rsync failed. trying scp.&#39;</span><span class="p">)</span>
		 <span class="n">command</span><span class="o">=</span><span class="s2">&quot;ssh -o StrictHostKeyChecking=no </span><span class="si">%s</span><span class="s2"> &#39;cp -r </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">/ &gt; /dev/null&#39; &gt; /dev/null&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">from_path</span><span class="p">,</span><span class="n">to_path</span><span class="p">)</span> 
		 <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
	    <span class="k">pass</span>

    <span class="n">diff</span><span class="o">=</span><span class="n">end</span><span class="o">-</span><span class="n">start</span>
    <span class="n">size</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="n">rate</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">try</span><span class="p">:</span>
	    
	    <span class="n">size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">from_path</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
	    <span class="k">if</span> <span class="n">size</span><span class="o">&lt;</span><span class="mf">0.000001</span><span class="p">:</span>
		    <span class="k">try</span><span class="p">:</span>
			    <span class="n">size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">to_path</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
		    <span class="k">except</span><span class="p">:</span>
			    <span class="k">pass</span>

    <span class="k">except</span><span class="p">:</span>
	 <span class="n">size</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">try</span><span class="p">:</span>
	 <span class="n">rate</span><span class="o">=</span><span class="n">size</span><span class="o">/</span><span class="n">diff</span>
    <span class="k">except</span><span class="p">:</span>
	 <span class="n">rate</span><span class="o">=</span><span class="mf">0.0</span>        


<span class="k">def</span> <span class="nf">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ext_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.paw&#39;</span><span class="p">,</span><span class="s1">&#39;.save&#39;</span><span class="p">,</span><span class="s1">&#39;.wfc&#39;</span><span class="p">,</span><span class="s1">&#39;.hub&#39;</span><span class="p">,</span><span class="s1">&#39;.mix&#39;</span><span class="p">,</span><span class="s1">&#39;.occup&#39;</span><span class="p">,</span><span class="s1">&#39;.update&#39;</span><span class="p">,</span><span class="s1">&#39;.bfgs&#39;</span><span class="p">,</span><span class="s1">&#39;.restart&#39;</span><span class="p">,</span><span class="s1">&#39;.restart_k&#39;</span><span class="p">,</span><span class="s1">&#39;.restart_scf&#39;</span><span class="p">,</span><span class="s1">&#39;.ewfcp&#39;</span><span class="p">,</span><span class="s1">&#39;.ewfc&#39;</span><span class="p">,</span><span class="s1">&#39;.ewfcm&#39;</span><span class="p">],</span><span class="n">glob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">first_node_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;local_scratch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>      
        <span class="n">orig_list</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ext_list</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
		    <span class="n">temp_dir</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TMPDIR&#39;</span><span class="p">]</span>
	    <span class="k">except</span><span class="p">:</span>
		    <span class="k">return</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_NODEFILE&#39;</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">nf</span><span class="p">:</span>
                <span class="n">nf_string</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">nf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nf_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">nf_list</span><span class="p">)</span>

            <span class="n">work_dir</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_prefixFromInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>            

            <span class="n">ext_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ext_list</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc_by_node</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nf_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">num_procs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">proc_by_node</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_list</span><span class="p">)):</span>
                <span class="n">proc_pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_procs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proc_by_node</span><span class="p">)):</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">orig_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.paw&quot;</span><span class="p">,</span><span class="s1">&#39;.save&#39;</span><span class="p">,</span><span class="s1">&#39;.occup&#39;</span><span class="p">,</span><span class="s1">&#39;.update&#39;</span><span class="p">,</span><span class="s1">&#39;.bgfs&#39;</span><span class="p">]:</span>
					<span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]))</span>
					
				<span class="k">elif</span> <span class="n">orig_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.restart&#39;</span><span class="p">,</span><span class="s1">&#39;.restart_k&#39;</span><span class="p">,</span><span class="s1">&#39;.igk&#39;</span><span class="p">,</span><span class="s1">&#39;.restart_scf&#39;</span><span class="p">]:</span>
					<span class="k">if</span> <span class="n">proc</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
						<span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">],</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

				<span class="k">else</span><span class="p">:</span>
					<span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">],</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1">#add this transfer proc to the pool</span>
			<span class="sd">&quot;&quot;&quot;assuming the first file is in the folder we&#39;re executing this from&quot;&quot;&quot;</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proc</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">glob</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
				<span class="sd">&#39;&#39;&#39;if we don&#39;t find the first skip to the next type&#39;&#39;&#39;</span>
				<span class="k">break</span>

			<span class="k">if</span> <span class="n">glob</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
				<span class="n">file_name</span><span class="o">=</span><span class="n">temp_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
<span class="c1">#				logging.debug(file_name)</span>

                        <span class="n">res</span> <span class="o">=</span> <span class="n">proc_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_scp_wrapper</span><span class="p">,</span> <span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="n">work_dir</span><span class="p">,</span><span class="n">proc_by_node</span><span class="p">[</span><span class="n">proc</span><span class="p">]))</span> 
			<span class="k">if</span> <span class="n">orig_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.save&#39;</span><span class="p">,</span><span class="s1">&#39;.occup&#39;</span><span class="p">,</span><span class="s1">&#39;.update&#39;</span><span class="p">,</span><span class="s1">&#39;.bgfs&#39;</span><span class="p">,]</span> <span class="ow">or</span> <span class="n">first_node_only</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
				<span class="k">break</span>

                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">pass</span>

                <span class="c1">#closes pool for this specific ext type and joins to wait for all procs to finish</span>
                <span class="n">proc_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">proc_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">pass</span>



<span class="k">def</span> <span class="nf">_to_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ext_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.save&#39;</span><span class="p">,</span><span class="s1">&#39;.wfc&#39;</span><span class="p">,</span><span class="s1">&#39;.hub&#39;</span><span class="p">,</span><span class="s1">&#39;.mix&#39;</span><span class="p">,</span><span class="s1">&#39;.occup&#39;</span><span class="p">,</span><span class="s1">&#39;.update&#39;</span><span class="p">,</span><span class="s1">&#39;.bgfs&#39;</span><span class="p">,</span><span class="s1">&#39;.restart&#39;</span><span class="p">,</span><span class="s1">&#39;.restart_k&#39;</span><span class="p">,</span><span class="s1">&#39;.restart_scf&#39;</span><span class="p">,</span><span class="s1">&#39;.ewfcp&#39;</span><span class="p">,</span><span class="s1">&#39;.ewfc&#39;</span><span class="p">,</span><span class="s1">&#39;.ewfcm&#39;</span><span class="p">,</span><span class="s2">&quot;.paw&quot;</span><span class="p">,],</span><span class="n">glob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">first_node_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">localscratchOpt</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;local_scratch&#39;</span><span class="p">)</span>
    <span class="n">localscratchOpt</span><span class="o">=</span><span class="n">localscratchOpt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">localscratchOpt</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>       
        <span class="n">orig_list</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ext_list</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_NODEFILE&#39;</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">nf</span><span class="p">:</span>
                <span class="n">nf_string</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">nf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nf_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]))</span>
	    <span class="k">try</span><span class="p">:</span>
		    <span class="n">temp_dir</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TMPDIR&#39;</span><span class="p">]</span>
	    <span class="k">except</span><span class="p">:</span>
		    <span class="k">return</span>

            <span class="n">work_dir</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>

            <span class="n">prefix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_prefixFromInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

            <span class="n">ext_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ext_list</span><span class="p">]</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                  <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc_by_node</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nf_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">num_procs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">proc_by_node</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_list</span><span class="p">)):</span>
                <span class="n">proc_pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_procs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proc_by_node</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>

			    <span class="k">try</span><span class="p">:</span>
				    <span class="k">if</span> <span class="n">orig_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.paw&quot;</span><span class="p">,</span><span class="s1">&#39;.save&#39;</span><span class="p">,</span><span class="s1">&#39;.occup&#39;</span><span class="p">,</span><span class="s1">&#39;.update&#39;</span><span class="p">,</span><span class="s1">&#39;.bgfs&#39;</span><span class="p">]:</span>
					    <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]))</span>
				    <span class="k">elif</span> <span class="n">orig_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.restart&#39;</span><span class="p">,</span><span class="s1">&#39;.restart_k&#39;</span><span class="p">,</span><span class="s1">&#39;.igk&#39;</span><span class="p">,</span><span class="s1">&#39;.restart_scf&#39;</span><span class="p">]:</span>
					    <span class="k">if</span> <span class="n">proc</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
						    <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]))</span>
					    <span class="k">else</span><span class="p">:</span>
						    <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">],</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
				    <span class="k">else</span><span class="p">:</span>
					    <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">],</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
			    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				    <span class="k">continue</span>

                            <span class="c1">#add transfer to pool</span>
			    <span class="sd">&quot;&quot;&quot;assuming the first file is in the folder we&#39;re executing this from&quot;&quot;&quot;</span>
			    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proc</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">glob</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
				    <span class="sd">&#39;&#39;&#39;if we don&#39;t find the first skip to the nxt type&#39;&#39;&#39;</span>
				    <span class="k">break</span>

			    <span class="k">if</span> <span class="n">glob</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
				<span class="n">file_name</span><span class="o">=</span><span class="n">temp_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ext_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>

			    <span class="n">res</span> <span class="o">=</span> <span class="n">proc_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_scp_wrapper</span><span class="p">,</span> <span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">proc_by_node</span><span class="p">[</span><span class="n">proc</span><span class="p">]))</span> 
			    <span class="k">if</span> <span class="n">orig_list</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.save&#39;</span><span class="p">,</span><span class="s1">&#39;.occup&#39;</span><span class="p">,</span><span class="s1">&#39;.update&#39;</span><span class="p">,</span><span class="s1">&#39;.bgfs&#39;</span><span class="p">,]</span> <span class="ow">or</span> <span class="n">first_node_only</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
				    <span class="k">break</span>
		    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
			    <span class="k">pass</span>

                <span class="c1">#closes pool for this specific ext type and joins to wait for all procs to finish</span>
                <span class="n">proc_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">proc_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_tempdir</span><span class="p">():</span>
    <span class="n">localscratchOpt</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;local_scratch&#39;</span><span class="p">)</span>
    <span class="n">localscratchOpt</span><span class="o">=</span><span class="n">localscratchOpt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">localscratchOpt</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">temp_dir</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TMPDIR&#39;</span><span class="p">]</span>
            <span class="n">temp_dir</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TMPDIR&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">temp_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">temp_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">temp_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span>

    <span class="k">return</span> <span class="n">temp_dir</span>


<span class="k">def</span> <span class="nf">_setup_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="n">localscratchOpt</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;local_scratch&#39;</span><span class="p">)</span>
    <span class="n">localscratchOpt</span><span class="o">=</span><span class="n">localscratchOpt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">localscratchOpt</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>        
        <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_get_tempdir</span><span class="p">()</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;wfcdir&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">))</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;outdir&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>        
        <span class="n">temp_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;wfcdir&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">))</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;outdir&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;setting wfc_dir to local scratch: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">temp_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>


<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## CALC SET FORMATION</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>


<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<div class="viewcode-block" id="build_calcs"><a class="viewcode-back" href="../prep.html#prep.build_calcs">[docs]</a><span class="k">def</span> <span class="nf">build_calcs</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">,</span><span class="n">build_type</span><span class="o">=</span><span class="s1">&#39;product&#39;</span><span class="p">):</span>
        
	<span class="k">if</span> <span class="n">build_type</span> <span class="o">==</span> <span class="s1">&#39;zip&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">chkListLen</span> <span class="o">=</span> <span class="kc">False</span>

             <span class="n">listLen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">PARAM_VARS</span><span class="p">)</span>
             
             <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">PARAM_VARS</span><span class="p">:</span>
                     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">!=</span> <span class="n">listLen</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                             <span class="n">chkListLen</span> <span class="o">=</span> <span class="kc">False</span>
                             <span class="k">break</span>
                     <span class="k">else</span><span class="p">:</span>
                             <span class="n">chkListLen</span> <span class="o">=</span> <span class="kc">True</span>

             <span class="k">if</span> <span class="n">chkListLen</span> <span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                 <span class="sd">&#39;&#39;&#39;allow length of the entries in a zip to all be the&#39;&#39;&#39;</span> 
                 <span class="sd">&#39;&#39;&#39;same or len==1 and just repeat the len==1 items&#39;&#39;&#39;</span>
                 <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">)):</span>
                     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                         <span class="n">PARAM_VARS</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">listLen</span><span class="p">))</span>

                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating calculations by zip mode&#39;</span><span class="p">)</span>
		 <span class="n">outp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*** Creating calculations by zip mode ***</span><span class="se">\n</span><span class="s2">&quot;</span>
		 <span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">outp</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                 <span class="n">CALCS_ITER</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="o">*</span><span class="n">PARAM_VARS</span><span class="p">)</span>

             <span class="k">else</span><span class="p">:</span>
                     <span class="nb">print</span> <span class="s2">&quot;ERROR: Parameter lists are of different lengths.&quot;</span>
                     <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR: Parameter lists are of different lengths on zip build mode. Exiting&quot;</span><span class="p">)</span>
                     <span class="k">raise</span> <span class="ne">SystemExit</span>

        <span class="k">elif</span> <span class="n">build_type</span> <span class="o">==</span> <span class="s1">&#39;product&#39;</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">CALCS_ITER</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">PARAM_VARS</span><span class="p">)</span>

             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating calculations in product mode&#39;</span><span class="p">)</span>
	     <span class="n">outp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*** Creating calculations in product mode ***</span><span class="se">\n</span><span class="s2">&quot;</span>	     
             <span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">outp</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>	     


        <span class="k">else</span><span class="p">:</span>
            
             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ERROR: Unidentified build mode&#39;</span><span class="p">)</span>
             <span class="nb">print</span> <span class="s2">&quot;ERROR: Unidentified build mode&quot;</span>
             <span class="k">raise</span> <span class="ne">SystemExit</span>
	


	<span class="k">return</span> <span class="n">CALCS_ITER</span></div>
	


<div class="viewcode-block" id="scfs"><a class="viewcode-back" href="../prep.html#prep.scfs">[docs]</a><span class="k">def</span> <span class="nf">scfs</span><span class="p">(</span><span class="n">aflowkeys</span><span class="p">,</span><span class="n">allAFLOWpiVars</span><span class="p">,</span> <span class="n">refFile</span><span class="p">,</span><span class="n">pseudodir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">build_type</span><span class="o">=</span><span class="s1">&#39;product&#39;</span><span class="p">,</span><span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Read a reference input file, and construct a set of calculations from the allAFLOWpiVars </span>
<span class="sd">	dictionary defining values for the keywords in the reference input file. This will</span>
<span class="sd">	also create directory within the set directory for every calculation in the set.</span>

<span class="sd">	Arguments:</span>
<span class="sd"> 	      allAFLOWpiVars (dict): a dictionary whose keys correspond to the keywords in the </span>
<span class="sd">	                          reference input file and whose values will be used to </span>
<span class="sd">   			          construct the set of calculations</span>
<span class="sd">  	      refFile (str): a filename as a string, a file object, or a string of the file</span>
<span class="sd">	                      that contains keywords to construct the inputs to the different</span>
<span class="sd">		              calculations in the set</span>
<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      pseudodir (str): path of the directory that contains your Pseudopotential files</span>
<span class="sd">	                        The value in the AFLOWpi config file used will override this.</span>
<span class="sd">	      build_type (str): how to construct the calculation set from allAFLOWpiVars dictionary:</span>
<span class="sd">	                 </span>
<span class="sd">	                      zip | The first calculation takes the first entry from the list of </span>
<span class="sd">			          | each of the keywords. The second calculation takes the second</span>
<span class="sd">			          | and so on. The keywords for all lists in allAFLOWpiVars must be</span>
<span class="sd">			          | the same length for this method.</span>

<span class="sd">			      product | Calculation set is formed via a &quot;cartesian product&quot; with </span>
<span class="sd">			              | the values the list of each keyword combined. (i.e if </span>
<span class="sd">			              | allAFLOWpiVars has one keyword with a list of 5 entires and</span>
<span class="sd">				      | another with 4 and a third with 10, there would be 2000</span>
<span class="sd">			 	      | calculations in the set formed from them via product mode.  </span>


<span class="sd">	</span>
<span class="sd">	Returns:</span>
<span class="sd">              A dictionary of dictionaries containing the set of calculations.</span>
<span class="sd">			 </span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">filterFunction</span><span class="o">=</span><span class="kc">None</span>
	<span class="n">build</span><span class="o">=</span><span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">refFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">refFileObj</span><span class="p">:</span>
                <span class="n">refFile</span> <span class="o">=</span> <span class="n">refFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">refFile</span> <span class="o">=</span> <span class="n">refFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">refFile</span><span class="o">=</span><span class="n">refFile</span>

        <span class="n">workdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;work_dir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">workdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>

        <span class="n">PROJDIR</span><span class="o">=</span><span class="n">aflowkeys</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
        <span class="n">PROJECT</span><span class="o">=</span><span class="n">PROJDIR</span>
        <span class="n">SET</span><span class="o">=</span><span class="n">aflowkeys</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pseudodir</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">pseudodir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;pseudo_dir&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                <span class="n">pseudodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">pseudodir</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pseudodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="n">pseudodir</span><span class="p">))</span>

	<span class="n">inputfile</span> <span class="o">=</span> <span class="n">refFile</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Entering prepAllCalcs&quot;</span><span class="p">)</span>
	<span class="n">PARAM_VARS</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">PARAM_LABELS</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">DICT</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

	<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">allAFLOWpiVars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">PARAM_VARS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="n">PARAM_LABELS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
			
		
	<span class="c1">#converts the values in allvars input from floats or ints to strings for processing with re module</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">)):</span> 
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">PARAM_LABELS</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span><span class="n">inputfile</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
			<span class="nb">print</span> <span class="s1">&#39;INVALID REF INPUT FILE: KEYWORD </span><span class="si">%s</span><span class="s1"> NOT FOUND. EXITING.&#39;</span> <span class="o">%</span> <span class="n">PARAM_LABELS</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
			<span class="k">raise</span> <span class="ne">SystemExit</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

			<span class="k">try</span><span class="p">:</span>
				<span class="n">PARAM_VARS</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">subEntry</span><span class="p">)</span> <span class="k">for</span> <span class="n">subEntry</span> <span class="ow">in</span> <span class="n">PARAM_VARS</span><span class="p">[</span><span class="n">entry</span><span class="p">]])</span>
			<span class="c1">#if the input can&#39;t be converted into a string something in the input for that variable </span>
                        <span class="c1">#is wrong and the framework force exits</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> 
				<span class="nb">print</span> <span class="s2">&quot;ERROR: Type of input for variable </span><span class="si">%s</span><span class="s2"> is invalid. Please check your input.&quot;</span> <span class="o">%</span> <span class="n">PARAM_LABELS</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
				<span class="k">raise</span> <span class="ne">SystemExit</span>
        <span class="k">try</span><span class="p">:</span>
	    <span class="n">CALCS_ITER</span> <span class="o">=</span> <span class="n">build_calcs</span><span class="p">(</span><span class="n">PARAM_VARS</span><span class="p">,</span><span class="n">build_type</span><span class="p">)</span>
            <span class="n">CALCS_TUPLE</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">CALCS_ITER</span><span class="p">)</span>
	    <span class="n">set_size</span> <span class="o">=</span> <span class="s2">&quot;SET SIZE: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">CALCS_TUPLE</span><span class="p">)</span>


            <span class="n">ak</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_PSEUDO_DIR_&#39;</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span>
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ak</span><span class="p">:</span><span class="n">av</span><span class="p">})</span>

            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span><span class="n">av</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>
            <span class="n">ak</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_OUTDIR_&#39;</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span>
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ak</span><span class="p">:</span><span class="n">av</span><span class="p">})</span>
            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span><span class="n">av</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>

            <span class="n">hash_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">calcs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">configFileName</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


	<span class="k">if</span> <span class="n">CALCS_TUPLE</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="n">index</span><span class="o">=</span><span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">CALCS_TUPLE</span><span class="p">:</span>
			<span class="n">inputfile2</span> <span class="o">=</span> <span class="n">inputfile</span>
			<span class="n">D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DICT</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">PARAM_LABELS</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
				<span class="n">D</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
				<span class="n">inputfile2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">inputfile2</span><span class="p">)</span>

                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1">#################################################################################################################### </span>
                            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">r&#39;_AFLOWPI_[A-Z][0-9]*_&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                                
                                <span class="c1">#make sure user isn&#39;t trying to use an equation for atomic species.</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">ur&#39;===[^,\n]*===&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                                    <span class="nb">print</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s2"> is not an acceptable format for species name. Examples of acceptable format are: &#39;Ga&#39;,&quot;O&quot;,&quot;Sn&quot;,&#39;K&#39;..etc&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">v</span>
                                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s2"> is not an acceptable format for species name. Examples of acceptable format are: &#39;Ga&#39;,&quot;O&quot;,&quot;Sn&quot;,&#39;K&#39;..etc&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>


                                <span class="n">ap</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;PSEUDO_&#39;</span>
                                <span class="k">try</span><span class="p">:</span> 
                                        <span class="n">speciesRe</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>
                                        <span class="n">vp</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getPseudofilename</span><span class="p">(</span><span class="n">speciesRe</span><span class="p">,</span><span class="n">pseudodir</span><span class="p">)</span>
                                        
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                                        <span class="nb">print</span> <span class="s1">&#39;Could not get Pseudopotential filename for </span><span class="si">%s</span><span class="s1"> from the directory </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">pseudodir</span><span class="p">)</span>
                                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not get Pseudopotential filename for </span><span class="si">%s</span><span class="s1"> from the directory </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">pseudodir</span><span class="p">))</span>
                                
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">inputfile2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="n">vp</span><span class="p">,</span><span class="n">inputfile2</span><span class="p">)</span>		

                                    <span class="n">am</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;MASS_&#39;</span>
                                    <span class="n">vm</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getAMass</span><span class="p">(</span><span class="n">speciesRe</span><span class="p">)</span>

                                    <span class="n">inputfile2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">am</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">vm</span><span class="p">),</span><span class="n">inputfile2</span><span class="p">)</span>		
                                    

                                    <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">am</span><span class="p">:</span><span class="n">vm</span><span class="p">,</span><span class="n">ap</span><span class="p">:</span><span class="n">vp</span><span class="p">})</span>
                                    <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">:</span><span class="n">configFileName</span><span class="p">})</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1">#####################################################################################################################</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">inputfile2</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_resolveEqualities</span><span class="p">(</span><span class="n">inputfile2</span><span class="p">)</span>
                            <span class="n">inputfile2</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_cleanInputStringSCF</span><span class="p">(</span><span class="n">inputfile2</span><span class="p">,</span><span class="n">convert</span><span class="o">=</span><span class="n">convert</span><span class="p">)</span>                       
                            <span class="n">calc_label</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_hash64String</span><span class="p">(</span><span class="n">inputfile2</span><span class="p">)</span>

                            <span class="n">kp</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span>
			    <span class="n">calc_label</span><span class="o">+=</span><span class="s1">&#39;_01&#39;</span>
                            <span class="n">vp</span> <span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">calc_label</span>
			    <span class="n">prefix</span><span class="o">=</span><span class="n">vp</span>

                            <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">kp</span><span class="p">:</span><span class="n">vp</span><span class="p">})</span>
                            <span class="n">index</span><span class="o">+=</span><span class="mi">1</span>
                            <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">:</span><span class="n">index</span><span class="p">})</span>

                            <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PROJDIR</span><span class="p">,</span> <span class="n">SET</span><span class="p">,</span> <span class="n">D</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">]))})</span>
                            <span class="n">inputStringDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile2</span><span class="p">)</span>
                            <span class="n">inputStringDict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
                            <span class="n">inputfile2</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputStringDict</span><span class="p">)</span>
                            <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;PROJECT&#39;</span><span class="p">:</span><span class="n">aflowkeys</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]})</span>
                            <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;SET&#39;</span><span class="p">:</span><span class="n">aflowkeys</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]})</span>
                            <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;__refFile__&#39;</span><span class="p">:</span><span class="n">refFile</span><span class="p">})</span>
                            <span class="n">D</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">:</span><span class="n">inputfile2</span><span class="p">})</span>
			    <span class="n">D</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                                
                            <span class="k">if</span> <span class="n">calc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">calcs</span><span class="p">[</span><span class="n">calc_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>

                            <span class="n">D</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

	<span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
		<span class="nb">print</span> <span class="s1">&#39;Single calculation: do you need AFLOWpi?&#39;</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Single calculation: do you need AFLOWpi?&#39;</span><span class="p">)</span>

                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_resolveEqualities</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_cleanInputStringSCF</span><span class="p">(</span><span class="n">inputfile</span><span class="p">,</span><span class="n">convert</span><span class="o">=</span><span class="n">convert</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

		<span class="n">calc_label</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_hash64String</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

		<span class="n">kp</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span>
		<span class="n">calc_label</span><span class="o">+=</span><span class="s1">&#39;_01&#39;</span>
		<span class="n">vp</span> <span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">calc_label</span>

		<span class="n">prefix</span><span class="o">=</span><span class="n">vp</span>
		<span class="n">inputStringDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
		<span class="n">inputStringDict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputStringDict</span><span class="p">)</span>

		<span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">kp</span><span class="p">:</span><span class="n">vp</span><span class="p">})</span>
                <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>

		<span class="n">CONFIG_FILE</span><span class="o">=</span><span class="s1">&#39;../AFLOWpi/CONFIG.config&#39;</span>
                <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">:</span><span class="n">CONFIG_FILE</span><span class="p">})</span>
                <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PROJDIR</span><span class="p">,</span> <span class="n">SET</span><span class="p">,</span> <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">]))})</span>

		<span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

		<span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">:</span><span class="n">inputfile</span><span class="p">})</span> 

                <span class="k">if</span> <span class="n">calc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">calcs</span><span class="p">[</span><span class="n">calc_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DICT</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[]</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;__calcVarName__&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;oneCalc&#39;</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;__IDVarName__&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;ID&#39;</span>

        <span class="sd">&#39;&#39;&#39;delete the &quot;!&quot; for the vacancies&#39;&#39;&#39;</span>
        <span class="n">calcsCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">calcsCopy</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">oneCalcCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">oneCalcCopy</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">r&#39;_AFLOWPI_[A-Z]\d*_&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;!&#39;</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">calcs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>


        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">in_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
	    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;outdir&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;./&#39;&quot;</span>
	    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;wfcdir&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;./&#39;&quot;</span>
	    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">in_dict</span><span class="p">)</span>
	    
            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.qsub&#39;</span> <span class="o">%</span> <span class="n">ID</span> 
            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span><span class="mf">40000000000.0</span><span class="p">,</span><span class="s1">&#39;walltime&#39;</span><span class="p">:</span><span class="mi">5000000</span><span class="p">}</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__status__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;Start&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;Complete&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;Restart&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;Error&quot;</span><span class="p">:</span><span class="s1">&#39;None&#39;</span><span class="p">})</span>

        

        <span class="sd">&#39;&#39;&#39;put the initial set of calcs in a log&#39;&#39;&#39;</span>
        <span class="n">calcs</span> <span class="o">=</span> <span class="n">calcs_container</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

	<span class="n">maketree</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span> <span class="n">pseudodir</span><span class="o">=</span><span class="n">pseudodir</span><span class="p">)</span>	
<span class="c1">#        if build==True:</span>
<span class="c1">#	maketree(calcs, pseudodir=pseudodir)	</span>
<span class="c1">#        else:</span>
<span class="c1">#            pass</span>
                
	<span class="k">return</span> <span class="n">calcs</span></div>


<div class="viewcode-block" id="extractvars"><a class="viewcode-back" href="../prep.html#prep.extractvars">[docs]</a><span class="k">def</span> <span class="nf">extractvars</span><span class="p">(</span><span class="n">refFile</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Read refFile and return an empty dictionary with all the keys and None values</span>
<span class="sd">	</span>
<span class="sd">	Arguments:</span>
<span class="sd">     	      refFile (str): filename of the reference input file for the frame</span>

<span class="sd">	Returns:</span>
<span class="sd">	      A dictionary containing the keyword extracted from the reference input file </span>
<span class="sd">	      as keys with None for values..</span>

<span class="sd">	&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">refFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">refFileObj</span><span class="p">:</span>
                <span class="n">refFile</span> <span class="o">=</span> <span class="n">refFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">refFile</span> <span class="o">=</span> <span class="n">refFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">refFile</span><span class="o">=</span><span class="n">refFile</span>
        

	<span class="n">rex1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_.+_&#39;</span><span class="p">)</span>
	<span class="n">lvar</span> <span class="o">=</span> <span class="n">rex1</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">refFile</span><span class="p">)</span>

	<span class="n">allAFLOWpiVars</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lvar</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
			<span class="n">allAFLOWpiVars</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">kk</span><span class="p">:</span><span class="kc">None</span><span class="p">})</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting extractAFLOWpiVars&#39;</span><span class="p">)</span>
        <span class="c1"># we should counsider adding consistency tests to checl that the ref file is good and working.</span>

	<span class="k">return</span> <span class="n">allAFLOWpiVars</span></div>




<div class="viewcode-block" id="calcFromFile"><a class="viewcode-back" href="../prep.html#prep.calcFromFile">[docs]</a><span class="k">def</span> <span class="nf">calcFromFile</span><span class="p">(</span><span class="n">aflowkeys</span><span class="p">,</span><span class="n">fileList</span><span class="p">,</span><span class="n">reffile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pseudodir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">keep_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">clean_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ref_override</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Reads in a string of an QE input file path, a string of an QE input, a file object of a </span>
<span class="sd">	QE input or a list of them and attempts to fill create a calculation from them. If they</span>
<span class="sd">	are missing things such as k_points card, they are automtically generated. </span>


<span class="sd">	Arguments:</span>
<span class="sd">	      aflowkeys (dict): a dictionary generated by AFLOWpi.prep.init</span>
<span class="sd">	      fileList (list): a string of an QE input file path, a string of an QE input, a file </span>
<span class="sd">    	                        object of a QE input or a list of them</span>
<span class="sd">        Keyword Arguments:</span>
<span class="sd">	      reffile (str): a partially filled QE input file used in case the input(s) in fileList</span>
<span class="sd">	                      are missing. i.e. wfc cutoff. If the names of the Pseudopotential files </span>
<span class="sd">			      are not included in the input(s) in fileList, they are chosen depending</span>
<span class="sd">			      on the pseudodir chosen and included when the calculation set is formed.</span>
<span class="sd">	      workdir (str): a string of the workdir path that be used to override what is in the </span>
<span class="sd">	                      config file used when initating the AFLOWpi session</span>
<span class="sd">	      pseudodir (str): a string of the pseudodir path that be used to override what is in </span>
<span class="sd">	                        the config file used when initating the AFLOWpi session</span>


<span class="sd">	&quot;&quot;&quot;</span>

        <span class="n">returnDict</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">index</span><span class="o">=</span><span class="mi">0</span>

	<span class="n">build</span><span class="o">=</span><span class="kc">True</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fileList</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;aString&#39;</span><span class="p">):</span>
            <span class="n">fileList</span><span class="o">=</span><span class="p">[</span><span class="n">fileList</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">inputFile</span> <span class="ow">in</span> <span class="n">fileList</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">holder</span><span class="o">=</span><span class="n">inputFile</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inputFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFileObj</span><span class="p">:</span>
                    <span class="n">inputFile</span> <span class="o">=</span> <span class="n">inputFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
		<span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">holder</span><span class="p">)</span>
		<span class="n">temp_file_hash_name</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">inputFile</span> <span class="o">=</span> <span class="n">inputFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">inputFile</span><span class="o">=</span><span class="n">inputFile</span>

            <span class="sd">&#39;&#39;&#39;try to open the reffile &#39;&#39;&#39;</span>

            <span class="k">if</span> <span class="n">reffile</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reffile</span><span class="p">):</span>
			<span class="n">refFileStr</span><span class="o">=</span><span class="n">reffile</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
                    
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">reffile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFileObj</span><span class="p">:</span>
					<span class="n">refFileStr</span> <span class="o">=</span> <span class="n">inputFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

					<span class="n">refFileStr</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_removeComments</span><span class="p">(</span><span class="n">refFileStr</span><span class="p">)</span>
					<span class="sd">&#39;&#39;&#39;get a dict of the tokenized ref file to fill in the parts missing from the files in filelist&#39;&#39;&#39;</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="nb">print</span> <span class="n">e</span>
				<span class="sd">&#39;&#39;&#39;if it doesn&#39;t work just return a blank dict for the ref file&#39;&#39;&#39;</span>
				<span class="n">refDict</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span> 
		<span class="k">try</span><span class="p">:</span>
		       <span class="n">refDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">refFileStr</span><span class="p">)</span>

		<span class="k">except</span><span class="p">:</span>
		       <span class="n">refDict</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span> 

	    <span class="k">else</span><span class="p">:</span>
		    <span class="sd">&#39;&#39;&#39;if the user doesn&#39;t input a ref file then just return a blank dict&#39;&#39;&#39;</span>
		    <span class="n">refDict</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span> 
			

                    
                    
            <span class="n">inputFile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_removeComments</span><span class="p">(</span><span class="n">inputFile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">workdir</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>            
                <span class="n">workdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;work_dir&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                <span class="n">workdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>


            <span class="n">PROJDIR</span><span class="o">=</span><span class="n">aflowkeys</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
            <span class="n">PROJECT</span><span class="o">=</span><span class="n">PROJDIR</span>
            <span class="n">SET</span><span class="o">=</span><span class="n">aflowkeys</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pseudodir</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">pseudodir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;pseudo_dir&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                    <span class="n">pseudodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">pseudodir</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">pseudodir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">pseudodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="n">pseudodir</span><span class="p">))</span>

            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">inputFile</span>
            <span class="n">configFileName</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>

            <span class="n">DICT</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">counter</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">elementList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">)</span>

            <span class="n">numOfEach</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getAtomNum</span><span class="p">(</span><span class="n">inputfile</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">numOfEachStripped</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getAtomNum</span><span class="p">(</span><span class="n">inputfile</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	    <span class="n">num_map</span><span class="o">=</span><span class="p">{}</span>
	    <span class="n">map_counter</span><span class="o">=</span><span class="mi">1</span>
	    <span class="k">for</span> <span class="n">species</span><span class="p">,</span><span class="n">num</span> <span class="ow">in</span> <span class="n">numOfEachStripped</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		    <span class="n">num_map</span><span class="p">[</span><span class="n">species</span><span class="p">]</span><span class="o">=</span><span class="n">map_counter</span>
		    <span class="n">map_counter</span><span class="o">+=</span><span class="mi">1</span>
	    
            <span class="n">atomicSpeciesList</span><span class="o">=</span><span class="p">[]</span>
	    <span class="n">element_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">species</span><span class="p">,</span><span class="n">num</span> <span class="ow">in</span> <span class="n">numOfEach</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">strippedSpecies</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;0123456789&quot;</span><span class="p">)</span>
                    <span class="n">numSpecies</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span>

		    <span class="n">counterIndex</span><span class="o">=</span><span class="n">counter</span><span class="o">/</span><span class="mi">26</span>

		    <span class="n">AFLOWpi_name</span> <span class="o">=</span> <span class="n">element_list</span><span class="p">[</span><span class="n">num_map</span><span class="p">[</span><span class="n">strippedSpecies</span><span class="p">]]</span><span class="o">+</span><span class="n">numSpecies</span>
                    <span class="n">aSpec</span><span class="o">=</span><span class="s1">&#39;_AFLOWPI_</span><span class="si">%s</span><span class="s1">_&#39;</span> <span class="o">%</span> <span class="n">AFLOWpi_name</span>

                    <span class="n">vSpec</span><span class="o">=</span><span class="n">strippedSpecies</span>
                    <span class="n">vp</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getPseudofilename</span><span class="p">(</span><span class="n">strippedSpecies</span><span class="p">,</span><span class="n">pseudodir</span><span class="p">)</span>            
                    <span class="n">ap</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_</span><span class="si">%s</span><span class="s1">PSEUDO_&#39;</span> <span class="o">%</span> <span class="n">AFLOWpi_name</span>
                    <span class="n">am</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_</span><span class="si">%s</span><span class="s1">MASS_&#39;</span> <span class="o">%</span> <span class="n">AFLOWpi_name</span>
                    <span class="n">vm</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getAMass</span><span class="p">(</span><span class="n">strippedSpecies</span><span class="p">)</span>        
                    <span class="n">atomicSpeciesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">species</span><span class="p">,</span><span class="n">vm</span><span class="p">,</span><span class="n">vp</span><span class="p">))</span>
                    
                    <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">am</span><span class="p">:</span><span class="n">vm</span><span class="p">,</span><span class="n">ap</span><span class="p">:</span><span class="n">vp</span><span class="p">,</span><span class="n">aSpec</span><span class="p">:</span><span class="n">species</span><span class="p">})</span>
                    <span class="n">counter</span><span class="o">+=</span><span class="mi">1</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="nb">print</span> <span class="n">e</span>
			<span class="k">raise</span> <span class="ne">SystemExit</span>


            <span class="n">atomicSpecString</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atomicSpeciesList</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">inputCalc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
	    <span class="c1">#set atomic_species card to blank so it can be filled in later</span>
	    <span class="k">try</span><span class="p">:</span>
		    <span class="k">del</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
	    <span class="k">except</span><span class="p">:</span>
		    <span class="k">pass</span>
                    
	    <span class="n">do_not_replace_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CELLDM(1)&#39;</span><span class="p">,</span><span class="s1">&#39;CELLDM(2)&#39;</span><span class="p">,</span><span class="s1">&#39;CELLDM(3)&#39;</span><span class="p">,</span><span class="s1">&#39;CELLDM(4)&#39;</span><span class="p">,</span><span class="s1">&#39;CELLDM(5)&#39;</span><span class="p">,</span><span class="s1">&#39;CELLDM(6)&#39;</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;COSAB&#39;</span><span class="p">,</span><span class="s1">&#39;COSAC&#39;</span><span class="p">,</span><span class="s1">&#39;COSBC&#39;</span><span class="p">,</span><span class="s1">&#39;IBRAV&#39;</span><span class="p">,</span><span class="s1">&#39;CALCULATION&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">namelist</span><span class="p">,</span><span class="n">entries</span> <span class="ow">in</span> <span class="n">refDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">namelist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="sd">&#39;&#39;&#39;if an input namelist from the ref isn&#39;t in the input file add it &#39;&#39;&#39;</span>
                        <span class="n">inputCalc</span><span class="p">[</span><span class="n">namelist</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">variable</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">entries</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="c1">#replace entries in input from ref input when both in ref and input</span>
                        <span class="c1">#only if we have the ref_override flag set to True.</span>
                        <span class="k">if</span> <span class="n">ref_override</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">do_not_replace_list</span><span class="p">:</span>
					<span class="sd">&#39;&#39;&#39;if a variable from the namelist in the ref isn&#39;t in the input file add it&#39;&#39;&#39;</span>
					<span class="n">inputCalc</span><span class="p">[</span><span class="n">namelist</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
			<span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="p">[</span><span class="n">namelist</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="sd">&#39;&#39;&#39;don&#39;t replace the celldm and A,B,C in the input files with ones from ref&#39;&#39;&#39;</span>
					<span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">do_not_replace_list</span><span class="p">:</span>
					     <span class="n">inputCalc</span><span class="p">[</span><span class="n">namelist</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="s1">&#39;ATOMIC_SPECIES&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;__content__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">atomicSpecString</span>

	    <span class="k">if</span> <span class="s1">&#39;&amp;system&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
		    <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
	    <span class="k">if</span> <span class="s1">&#39;nat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
		    <span class="n">nat</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numOfEach</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
		    <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;nat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nat</span>
	    <span class="k">if</span> <span class="s1">&#39;ntyp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
		    <span class="n">ntyp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numOfEach</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
		    <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ntyp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ntyp</span>

            <span class="k">if</span> <span class="s1">&#39;&amp;control&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;PSEUDO_DIR&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;./&#39;&quot;</span>
            <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;outdir&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;./&#39;&quot;</span>
	    <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;wfcdir&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;./&#39;&quot;</span>

            <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;restart_mode&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;from_scratch&#39;&quot;</span>
	    
            <span class="k">if</span> <span class="s1">&#39;&amp;electrons&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;electrons&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;diagonalization&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&quot;david&quot;&#39;</span>
                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;mixing_mode&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&quot;plain&quot;&#39;</span>
                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;mixing_beta&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span>
                <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;conv_thr&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;1.0d-8&#39;</span>
		

		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="s1">&#39;&amp;system&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>				
				<span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
			<span class="k">if</span> <span class="s1">&#39;ecutwfc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="n">ecutwfc</span> <span class="o">=</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">]</span>
				<span class="n">ecutrho</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ecutwfc</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>
				<span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ecutrho</span>
			
			
		<span class="k">except</span><span class="p">:</span> 
                        <span class="n">ecutwfc</span><span class="o">=</span><span class="s1">&#39;200&#39;</span>
                        <span class="n">ecutrho</span><span class="o">=</span><span class="s1">&#39;800&#39;</span>
                
                        <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_ECUTW_&#39;</span><span class="p">:</span><span class="n">ecutwfc</span><span class="p">})</span>
                        <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_ECUTR_&#39;</span><span class="p">:</span><span class="n">ecutrho</span><span class="p">})</span>



            <span class="n">inputCalc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_orderSplitInput</span><span class="p">(</span><span class="n">inputCalc</span><span class="p">)</span>
            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputCalc</span><span class="p">)</span>

	    <span class="n">CONFIG_FILE</span><span class="o">=</span><span class="s1">&#39;../AFLOWpi/CONFIG.config&#39;</span>
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">:</span><span class="n">CONFIG_FILE</span><span class="p">})</span>

            <span class="n">ak</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_PSEUDO_DIR_&#39;</span>
            <span class="n">av</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ak</span><span class="p">:</span><span class="n">av</span><span class="p">})</span>
            <span class="n">ak</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_OUTDIR_&#39;</span>
            <span class="n">av</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ak</span><span class="p">:</span><span class="n">av</span><span class="p">})</span>
            <span class="n">index</span><span class="o">+=</span><span class="mi">1</span>


            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;__content__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;if we don&#39;t have a kpoints card make a generic one based on lattice vecs and MP Grid&#39;&#39;&#39;</span>

                        <span class="n">cellParamMatrix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">getCellMatrixFromInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

                        <span class="n">inputCalc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>


                        <span class="n">kpointString</span><span class="o">=</span><span class="n">getMPGrid</span><span class="p">(</span><span class="n">cellParamMatrix</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">kpointString</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
				<span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{gamma}</span><span class="s1">&#39;</span>
				<span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
				<span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{automatic}</span><span class="s1">&#39;</span>
				<span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">kpointString</span>

                        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputCalc</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                

	    <span class="k">if</span> <span class="n">clean_input</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
		    <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_cleanInputStringSCF</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>                            



            <span class="sd">&#39;&#39;&#39;make the ID&#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
		<span class="n">chain_ind</span><span class="o">=</span><span class="mi">1</span>
		<span class="n">ext</span> <span class="o">=</span><span class="s1">&#39;_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">chain_ind</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>
                <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            


            <span class="n">calc_label</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_hash64String</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span><span class="o">+</span><span class="n">ext</span>
	    <span class="k">if</span> <span class="n">keep_name</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
		    <span class="k">try</span><span class="p">:</span>
			    <span class="n">calc_label</span><span class="o">=</span><span class="n">temp_file_hash_name</span><span class="o">+</span><span class="n">ext</span>
		    <span class="k">except</span><span class="p">:</span>
			    <span class="k">pass</span>
            <span class="n">kp</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span>

            <span class="n">vp</span> <span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">calc_label</span>
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">kp</span><span class="p">:</span><span class="n">vp</span><span class="p">})</span>

            <span class="n">inputCalc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

            <span class="n">inputCalc</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">vp</span><span class="p">)</span>


            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputCalc</span><span class="p">)</span>


            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>

            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>


            
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">:</span><span class="n">index</span><span class="p">})</span>
	    <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>

	    <span class="k">if</span> <span class="n">clean_input</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
		    <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_cleanInputStringSCF</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>                            


            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">:</span><span class="n">inputfile</span><span class="p">})</span>
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;__refFile__&#39;</span><span class="p">:</span><span class="n">inputfile</span><span class="p">})</span>
            <span class="n">DICT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PROJDIR</span><span class="p">,</span> <span class="n">SET</span><span class="p">,</span> <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">]))})</span>
            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.qsub&#39;</span> <span class="o">%</span> <span class="n">calc_label</span>
            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;__calcVarName__&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;oneCalc&#39;</span>
            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;PROJECT&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">PROJECT</span>
            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;SET&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">SET</span>
            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;__IDVarName__&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;ID&#39;</span>
            <span class="n">DICT</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;Start&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;Complete&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;Restart&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;Error&quot;</span><span class="p">:</span><span class="s1">&#39;None&#39;</span><span class="p">})</span>
            <span class="n">dictCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DICT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">calc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">returnDict</span><span class="p">:</span>
                <span class="n">returnDict</span><span class="p">[</span><span class="n">calc_label</span><span class="p">]</span><span class="o">=</span><span class="n">dictCopy</span>

        

	<span class="n">maketree</span><span class="p">(</span><span class="n">returnDict</span><span class="p">,</span> <span class="n">pseudodir</span><span class="o">=</span><span class="n">pseudodir</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
<span class="c1">#        if build==True:</span>
<span class="c1">#            maketree(returnDict, pseudodir=pseudodir,workdir=workdir)</span>

<span class="c1">#        else:</span>
<span class="c1">#            pass</span>

        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">returnDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">returnDict</span></div>



<div class="viewcode-block" id="getMPGrid"><a class="viewcode-back" href="../prep.html#prep.getMPGrid">[docs]</a><span class="k">def</span> <span class="nf">getMPGrid</span><span class="p">(</span><span class="n">primLatVec</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;just starting on this. going to refine later&#39;&#39;&#39;</span>

        <span class="n">kpointList</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">free2abc</span><span class="p">(</span><span class="n">primLatVec</span><span class="p">,</span><span class="n">cosine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bohr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">kpointList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">200.0</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">))))</span>
        <span class="n">kpointList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">200.0</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">))))</span>
        <span class="n">kpointList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">200.0</span><span class="o">/</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">))))</span>



        <span class="k">if</span> <span class="n">offset</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">kpointList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kpointList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,])</span>


	<span class="k">if</span> <span class="n">kpointList</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
		<span class="k">return</span> <span class="s1">&#39;&#39;</span>
	

        <span class="k">if</span> <span class="n">string</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kpointList</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kpointList</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;2 2 2 1 1 1&#39;</span></div>
        
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## CONFIG UTILS</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>


<span class="k">def</span> <span class="nf">_getConfigFile</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">__config__</span>

<span class="k">def</span> <span class="nf">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">configFile</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">__config__</span>
    <span class="n">__config__</span><span class="o">=</span><span class="n">configFile</span>



<span class="k">def</span> <span class="nf">_config_dict</span><span class="p">(</span><span class="n">configFile</span><span class="p">):</span>
    <span class="n">Config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">Config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>        
    <span class="n">sections</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
	    <span class="n">entries</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
	    <span class="n">config_dict</span><span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
	    <span class="k">for</span> <span class="n">param</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
		    <span class="n">config_dict</span><span class="p">[</span><span class="n">sec</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>

    <span class="k">return</span> <span class="n">config_dict</span>

<span class="k">def</span> <span class="nf">_ConfigSectionMap</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="n">option</span><span class="p">,</span><span class="n">configFile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">index</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">Config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">configFile</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>        

    <span class="n">dict1</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoSectionError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No section in </span><span class="si">%s</span><span class="s1"> called: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">section</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>



    <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">returned_option</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>


        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No section in </span><span class="si">%s</span><span class="s1"> in section </span><span class="si">%s</span><span class="s1"> called: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">section</span><span class="p">,</span><span class="n">option</span><span class="p">))</span>
            <span class="n">returned_option</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
            <span class="n">returned_option</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">section</span><span class="o">=</span><span class="s1">&#39;step_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">returned_option</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">returned_option</span>


<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## INTERFACE</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>


<div class="viewcode-block" id="ConfigSectionMap"><a class="viewcode-back" href="../prep.html#prep.ConfigSectionMap">[docs]</a><span class="k">def</span> <span class="nf">ConfigSectionMap</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="n">option</span><span class="p">,</span><span class="n">configFile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="n">option</span><span class="p">,</span><span class="n">configFile</span><span class="o">=</span><span class="n">configFile</span><span class="p">)</span></div>

<span class="c1">#####################################################################################################################</span>
<div class="viewcode-block" id="init"><a class="viewcode-back" href="../prep.html#prep.init">[docs]</a><span class="k">class</span> <span class="nc">init</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span> <span class="n">SET</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">AUTHOR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">CORRESPONDING</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">SPONSOR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">make_symlink</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">=</span><span class="n">PROJECT</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">=</span><span class="n">SET</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">=</span><span class="n">config</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="o">=</span><span class="n">AUTHOR</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">corresponding</span><span class="o">=</span><span class="n">CORRESPONDING</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sponsor</span><span class="o">=</span><span class="n">SPONSOR</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span>

		<span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gen_logo</span><span class="p">()</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="p">)):</span>
				<span class="nb">print</span> <span class="s1">&#39;CONFIG FILE </span><span class="si">%s</span><span class="s1"> DOES NOT EXIST. CHECK YOUR AFLOWPI SCRIPT...EXITING.&#39;</span>
				<span class="k">raise</span> <span class="ne">SystemExit</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="nb">print</span> <span class="s1">&#39;CONFIG FILE </span><span class="si">%s</span><span class="s1"> DOES NOT EXIST. CHECK YOUR AFLOWPI SCRIPT...EXITING.&#39;</span>
			<span class="k">raise</span> <span class="ne">SystemExit</span>

		<span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__global__config__flag__&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">init__</span><span class="p">(</span><span class="n">PROJECT</span><span class="p">,</span> <span class="n">SET</span><span class="o">=</span><span class="n">SET</span><span class="p">,</span> <span class="n">AUTHOR</span><span class="o">=</span><span class="n">AUTHOR</span><span class="p">,</span> <span class="n">CORRESPONDING</span><span class="o">=</span><span class="n">CORRESPONDING</span><span class="p">,</span> <span class="n">SPONSOR</span><span class="o">=</span><span class="n">SPONSOR</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span><span class="n">make_symlink</span><span class="o">=</span><span class="n">make_symlink</span><span class="p">)</span>

<div class="viewcode-block" id="init.items"><a class="viewcode-back" href="../prep.html#prep.init.items">[docs]</a>        <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>

<div class="viewcode-block" id="init.iteritems"><a class="viewcode-back" href="../prep.html#prep.init.iteritems">[docs]</a>        <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span></div>

<div class="viewcode-block" id="init.keys"><a class="viewcode-back" href="../prep.html#prep.init.keys">[docs]</a>        <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="init.values"><a class="viewcode-back" href="../prep.html#prep.init.values">[docs]</a>        <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

        <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>


	<span class="k">def</span> <span class="nf">__gen_logo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">logo</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="c1">#	    logo+= &#39;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;            ______ _      ______          __&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;           &#39;</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;      /\   |  ____| |    / __ \ \        / /&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;           &#39;</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;     /  \  | |__  | |   | |  | \ \  /\  / /&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;__________  &#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;    / /\ \ |  __| | |   | |  | |\ \/  \/ /&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;|__________| &#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#	    logo+=&#39;%%&#39;   </span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;   / ____ \| |    | |___| |__| | \  /\  /&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;   | |  | |   &#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;  /_/    \_\_|    |______\____/   \/  \/&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;    |_|  |_|   &#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#	    logo+=&#39;%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#	    logo+=&#39;%%                                                       %%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="c1">#	    logo+=&#39;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%&#39;</span>
	    <span class="n">logo</span><span class="o">+=</span><span class="s1">&#39;                                     By Andrew Supka et al.</span><span class="se">\n</span><span class="s1">&#39;</span>

	    <span class="k">return</span> <span class="n">logo</span>





<div class="viewcode-block" id="init.scfs"><a class="viewcode-back" href="../prep.html#prep.init.scfs">[docs]</a>	<span class="k">def</span> <span class="nf">scfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">allAFLOWpiVars</span><span class="p">,</span> <span class="n">refFile</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span><span class="n">pseudodir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">build_type</span><span class="o">=</span><span class="s1">&#39;product&#39;</span><span class="p">,</span><span class="n">convert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A wrapper method to call AFLOWpi.prep.scfs to form the calculation set. This will</span>
<span class="sd">		also create directory within the set directory for every calculation in the set.</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      allAFLOWpiVars (dict): a dictionary whose keys correspond to the keywords in the </span>
<span class="sd">				          reference input file and whose values will be used to </span>
<span class="sd">				          construct the set of calculations</span>
<span class="sd">		      refFile (str): a filename as a string, a file object, or a string of the file</span>
<span class="sd">				      that contains keywords to construct the inputs to the different</span>
<span class="sd">				      calculations in the set</span>
<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      pseudodir (str): path of the directory that contains your Pseudopotential files</span>
<span class="sd">				        The value in the AFLOWpi config file used will override this.</span>
<span class="sd">		      build_type (str): how to construct the calculation set from allAFLOWpiVars dictionary:</span>

<span class="sd">				      zip | The first calculation takes the first entry from the list of </span>
<span class="sd">					  | each of the keywords. The second calculation takes the second</span>
<span class="sd">					  | and so on. The keywords for all lists in allAFLOWpiVars must be</span>
<span class="sd">					  | the same length for this method.</span>

<span class="sd">				      product | Calculation set is formed via a &quot;cartesian product&quot; with </span>
<span class="sd">					      | the values the list of each keyword combined. (i.e if </span>
<span class="sd">					      | allAFLOWpiVars has one keyword with a list of 5 entires and</span>
<span class="sd">					      | another with 4 and a third with 10, there would be 2000</span>
<span class="sd">					      | calculations in the set formed from them via product mode.  </span>




<span class="sd">		Returns:</span>
<span class="sd">		      A dictionary of dictionaries containing the set of calculations.</span>

<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">scfs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">scfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span><span class="n">allAFLOWpiVars</span><span class="p">,</span><span class="n">refFile</span><span class="p">,</span><span class="n">pseudodir</span><span class="o">=</span><span class="n">pseudodir</span><span class="p">,</span>
					 <span class="n">build_type</span><span class="o">=</span><span class="n">build_type</span><span class="p">,</span><span class="n">convert</span><span class="o">=</span><span class="n">convert</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">scfs</span></div>


<div class="viewcode-block" id="init.from_file"><a class="viewcode-back" href="../prep.html#prep.init.from_file">[docs]</a>	<span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileList</span><span class="p">,</span><span class="n">reffile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pseudodir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ref_override</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Reads in a string of an QE input file path, a string of an QE input, a file object of a </span>
<span class="sd">		QE input or a list of them and attempts to fill create a calculation from them. If they</span>
<span class="sd">		are missing things such as k_points card, they are automtically generated. </span>

<span class="sd">		Arguments:</span>
<span class="sd">		      aflowkeys (dict): a dictionary generated by AFLOWpi.prep.init</span>
<span class="sd">		      fileList (str): a string of an QE input file path, a string of an QE input, a file </span>
<span class="sd">				       object of a QE input or a list of them</span>
<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      reffile (str): a partially filled QE input file used in case the input(s) in fileList</span>
<span class="sd">		                      are missing. i.e. wfc cutoff. If the names of the Pseudopotential files </span>
<span class="sd">              			      are not included in the input(s) in fileList, they are chosen depending</span>
<span class="sd">				      on the pseudodir chosen and included when the calculation set is formed.</span>
<span class="sd">		      workdir (str): a string of the workdir path that be used to override what is in the </span>
<span class="sd">				   config file used when initating the AFLOWpi session</span>
<span class="sd">		      pseudodir (str): a string of the pseudodir path that be used to override what is in </span>
<span class="sd">				     the config file used when initating the AFLOWpi session</span>

<span class="sd">		      ref_override (bool): Option to override values in the input file(s) with values in the reference</span>
<span class="sd">		                           input file. If no reference input file is included then this is ignored.</span>
<span class="sd">                                           (Default: True)</span>
<span class="sd">		&quot;&quot;&quot;</span>


		<span class="n">scfs</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">calcFromFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span><span class="n">fileList</span><span class="p">,</span><span class="n">reffile</span><span class="o">=</span><span class="n">reffile</span><span class="p">,</span><span class="n">pseudodir</span><span class="o">=</span><span class="n">pseudodir</span><span class="p">,</span>
					       <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span><span class="n">ref_override</span><span class="o">=</span><span class="n">ref_override</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">calcs_container</span><span class="p">(</span><span class="n">scfs</span><span class="p">)</span></div>

<div class="viewcode-block" id="init.load"><a class="viewcode-back" href="../prep.html#prep.init.load">[docs]</a>	<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Loads the calc logs from a given step</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      step (int): the step of the calculation for whose calclogs are to be loaded</span>
<span class="sd">		</span>
<span class="sd">		Returns:</span>
<span class="sd">		      calcs (dict): the loaded calc logs</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">init_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*** Loading Calculation Set From Step #</span><span class="si">%02d</span><span class="s1"> ***&#39;</span><span class="o">%</span><span class="n">step</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">init_str</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

	
		<span class="c1">#get name of log and load it from the specified step</span>
		<span class="n">loaded_log_name</span><span class="o">=</span><span class="s1">&#39;step_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">step</span>
		<span class="n">loaded_calcs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">loadlogs</span><span class="p">(</span><span class="n">PROJECT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span><span class="n">SET</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">,</span>
						     <span class="n">logname</span><span class="o">=</span><span class="n">loaded_log_name</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

		<span class="c1">#make calcs_container object from loaded dictionary</span>
		<span class="n">loaded_calcs</span> <span class="o">=</span> <span class="n">calcs_container</span><span class="p">(</span><span class="n">loaded_calcs</span><span class="p">)</span>
		<span class="c1">#set the step in the calcs_container object to the step loaded</span>
		<span class="n">loaded_calcs</span><span class="o">.</span><span class="n">step_index</span><span class="o">=</span><span class="n">step</span>
		<span class="c1">#get the previously done workflow</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">loaded_calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
				<span class="n">workflow</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_WORKFLOW_&#39;</span><span class="p">]</span>
				<span class="k">break</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">workflow</span><span class="o">=</span><span class="p">[]</span>

		<span class="c1">#add it to this newly created calcs_container object</span>
		<span class="n">loaded_calcs</span><span class="o">.</span><span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span>

		<span class="c1">#check for last scf-type calc and load from there for additions to workflow</span>
		<span class="k">for</span> <span class="n">progress</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_calcs</span><span class="o">.</span><span class="n">workflow</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">loaded_calcs</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="n">progress</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;relax&#39;</span><span class="p">,</span><span class="s1">&#39;vcrelax&#39;</span><span class="p">,</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="s1">&#39;scfuj&#39;</span><span class="p">,</span><span class="s1">&#39;crawl_min&#39;</span><span class="p">,</span><span class="s1">&#39;converge_smearing&#39;</span><span class="p">]:</span>
				<span class="n">scf_step</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">loadlogs</span><span class="p">(</span><span class="n">PROJECT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span><span class="n">SET</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">,</span><span class="n">logname</span><span class="o">=</span><span class="s1">&#39;step_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">progress</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
				<span class="n">loaded_calcs</span><span class="o">.</span><span class="n">load_index</span><span class="o">=</span><span class="n">progress</span><span class="o">+</span><span class="mi">1</span>
				<span class="n">loaded_calcs</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scf_step</span><span class="p">)</span>


		<span class="k">return</span> <span class="n">loaded_calcs</span></div>

<div class="viewcode-block" id="init.status"><a class="viewcode-back" href="../prep.html#prep.init.status">[docs]</a>	<span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="p">{},</span><span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">negate_status</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Loads the calc logs from a given step</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      step (int): The step of the calculation for whose calclogs are to be loaded.</span>
<span class="sd">              		          If no step is specified then it will default to load calculations</span>
<span class="sd">				  from all steps with the chosen status.</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      status (dict): key,value pairs for status type and their value to filter on.</span>
<span class="sd">		                     i.e. status={&#39;Finished&#39;:False} </span>
<span class="sd">		      negate_status (bool): filter on the opposite of the status filters</span>
<span class="sd">		</span>
<span class="sd">		Returns:</span>
<span class="sd">		      calcs (dict): the loaded calcs for one or more steps with the given status</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">loaded_calcs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">checkStatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span><span class="n">SET</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span><span class="n">negate_status</span><span class="o">=</span><span class="n">negate_status</span><span class="p">)</span>

		<span class="n">full_set</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loaded_calcs</span><span class="p">:</span>
			<span class="n">full_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
		
		<span class="k">return</span> <span class="n">calcs_container</span><span class="p">(</span><span class="n">full_set</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_getLoglevel</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks config file for loggings level. </span>
<span class="sd">    If none specified it defaults to logging.INFO</span>

<span class="sd">    Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          loglevel (logging.loglevel): loglevel object associated with the logging</span>
<span class="sd">	                               level string found in the config file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    

    <span class="n">loglevel</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;log_level&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">loglevel</span><span class="o">==</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span>
        <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
    <span class="k">elif</span> <span class="n">loglevel</span> <span class="o">==</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">:</span>
        <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
    <span class="k">elif</span> <span class="n">loglevel</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
        <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span>
    <span class="k">elif</span> <span class="n">loglevel</span> <span class="o">==</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">:</span>
        <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>

    <span class="k">return</span> <span class="n">loglevel</span>

<span class="c1">####################################################################################################################</span>



<div class="viewcode-block" id="init__"><a class="viewcode-back" href="../prep.html#prep.init__">[docs]</a><span class="k">def</span> <span class="nf">init__</span><span class="p">(</span><span class="n">PROJECT</span><span class="p">,</span> <span class="n">SET</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">AUTHOR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">CORRESPONDING</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">SPONSOR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">make_symlink</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Initializes the frame</span>
<span class="sd">	</span>
<span class="sd">	Arguments:</span>
<span class="sd">	 PROJECT (str): Name of project</span>
<span class="sd">         SET (str): Name of set </span>
<span class="sd">	 author (str): Name of author</span>
<span class="sd">	 CORRESPONDING (str): Name of corresponding </span>
<span class="sd">	 SPONSOR (str): Name of sponsor</span>
<span class="sd">	 </span>
<span class="sd">	e.g. initFrame(&#39;LNTYPE&#39;,&#39;&#39;, &#39;MF&#39;, &#39;marco.fornari@cmich.edu&#39;,&#39;DOD-MURI&#39;). Return the AFLOKEYS dictionary.</span>
<span class="sd">	&quot;&quot;&quot;</span>  
        <span class="n">configFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span><span class="n">config</span><span class="p">))</span>

	<span class="k">if</span> <span class="n">SET</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">set_str</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SET      : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">SET</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">set_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

	<span class="n">init_str</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">*** Initiating AFLOWpi ***&#39;&#39;&#39;</span>

	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;configuration file: </span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
		<span class="nb">print</span> <span class="s1">&#39;configuration file: </span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">config</span>
		<span class="k">raise</span> <span class="ne">SystemExit</span>

	<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">init_str</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	

	<span class="n">init_str</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">CONFIG   : </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">PROJECT  : </span><span class="si">%s%s</span><span class="s1"></span>
<span class="s1">EXEC DIR : </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">set_str</span><span class="p">,</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
	<span class="nb">print</span> <span class="n">init_str</span>

	<span class="n">config_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_config_dict</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>

	<span class="n">config_announce</span> <span class="o">=</span>  <span class="s1">&#39;AFLOWpi Configuration parameters from </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
	<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">config_announce</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">entries</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		<span class="n">sec_header</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="o">%</span><span class="n">sec</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">sec_header</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">param</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">entries</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%-15s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">param</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
	<span class="nb">print</span> 

<span class="c1">#        print &#39;\nReading from Config: %s&#39; % configFile</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__INITIAL_EXECPATH__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__INITIAL__EXECPATH__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">workdir</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">workdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;work_dir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                    <span class="n">workdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
		<span class="nb">print</span> <span class="s2">&quot;work_dir </span><span class="si">%s</span><span class="s2"> does not exist. exiting&quot;</span><span class="o">%</span><span class="n">workdir</span>
		<span class="k">raise</span> <span class="ne">SystemExit</span>

	<span class="k">if</span> <span class="n">make_symlink</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">sym</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="s2">&quot;./</span><span class="si">%s</span><span class="s2">.symlink&quot;</span><span class="o">%</span><span class="n">PROJECT</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">sym</span><span class="o">=</span><span class="s2">&quot;./&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sym</span><span class="o">==</span><span class="s2">&quot;./&quot;</span><span class="p">:</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="s2">&quot;./</span><span class="si">%s</span><span class="s2">.symlink&quot;</span><span class="o">%</span><span class="n">PROJECT</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="s2">&quot;./</span><span class="si">%s</span><span class="s2">.symlink&quot;</span><span class="o">%</span><span class="n">PROJECT</span><span class="p">)</span> <span class="o">==</span> <span class="n">path</span><span class="p">:</span>
					<span class="nb">print</span> <span class="s2">&quot;./</span><span class="si">%s</span><span class="s2">.symlink to </span><span class="si">%s</span><span class="s2"> is broken. Replacing it with new symlink.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
					<span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s2">&quot;./</span><span class="si">%s</span><span class="s2">.symlink&quot;</span><span class="o">%</span><span class="n">PROJECT</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">pass</span>

			<span class="k">try</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s2">&quot;./</span><span class="si">%s</span><span class="s2">.symlink&quot;</span><span class="o">%</span><span class="n">PROJECT</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">pass</span>



	<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">PROJECT</span><span class="p">,</span><span class="n">SET</span><span class="p">)</span>
	<span class="n">AFLOWpidir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">)</span>
<span class="c1">#</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">):</span>
<span class="c1">#                logging.info(&quot;Project exists: %s&quot; %  path)</span>
<span class="c1">#		print &quot;Project exists: &quot;, path</span>
 		<span class="k">pass</span>
	<span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
			<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">AFLOWpidir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">)</span>
		<span class="n">calclogDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">,</span><span class="s1">&#39;calclogs&#39;</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">calclogDir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">):</span>
		<span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">,</span><span class="s1">&#39;LOG.log&#39;</span><span class="p">)</span>
			

		<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y %I:%M:%S %p&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getLoglevel</span><span class="p">())</span>

		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start logging for AFLOWpi for project </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">PROJECT</span><span class="p">,</span> <span class="n">AFLOWpidir</span> <span class="p">)</span>

                <span class="n">loglevel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;log_level&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">loglevel</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loglevel</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;log_level&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Log Level set at: logging.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">loglevel</span><span class="p">)</span>
	
	<span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>


	<span class="n">__aflowkeys__</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">__aflowkeys__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;project&#39;</span><span class="p">:</span><span class="n">PROJECT</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span><span class="n">SET</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">:</span><span class="n">AUTHOR</span><span class="p">,</span> <span class="s1">&#39;corresponding&#39;</span><span class="p">:</span><span class="n">CORRESPONDING</span><span class="p">,</span> <span class="s1">&#39;sponsor&#39;</span><span class="p">:</span><span class="n">SPONSOR</span><span class="p">})</span>
	<span class="n">__aflowkeys__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="n">date</span><span class="p">})</span>

        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpidir</span><span class="p">,</span><span class="s1">&#39;CONFIG.config&#39;</span><span class="p">)</span>        
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_copyConfig</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">dest</span><span class="p">)</span>
	


	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
	
	<span class="k">return</span> <span class="n">__aflowkeys__</span></div>

<span class="k">def</span> <span class="nf">_copyConfig</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">dest</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Copies the config file used to the AFLOWpi directory when AFLOWpi </span>
<span class="sd">    is initiated and resolves relative paths in the config file.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          config (str): location of the config file to be copied to &quot;AFLOWpi&quot; directory</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
            <span class="n">execDirName</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">__file__</span><span class="p">))</span>
            <span class="n">config</span>  <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">execDirName</span><span class="p">,</span><span class="n">config</span><span class="p">))</span>


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">e</span>

    <span class="n">configParse</span>  <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">configParse</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">sectionList</span> <span class="o">=</span> <span class="n">configParse</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>

    <span class="n">configFileDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sectionList</span><span class="p">:</span>
        <span class="n">optionList</span> <span class="o">=</span> <span class="n">configParse</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>        
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">optionList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;pao_dir&#39;</span> <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;pseudo_dir&#39;</span> <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;engine_dir&#39;</span> <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;want_dir&#39;</span> <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;work_dir&#39;</span> <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;engine_dir&#39;</span> <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;job_template&#39;</span><span class="p">:</span>
                <span class="n">possiblePath</span> <span class="o">=</span> <span class="n">configParse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
                <span class="n">possiblePath</span>  <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileDir</span><span class="p">,</span> <span class="n">possiblePath</span><span class="p">))</span>       

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">possiblePath</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">possiblePath</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileDir</span><span class="p">,</span><span class="n">possiblePath</span><span class="p">))</span>            
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="n">e</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">possiblePath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">possiblePath</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;entry in </span><span class="si">%s</span><span class="s1"> in section </span><span class="si">%s</span><span class="s1"> does not exist. check your config file. If you do not need/have this directory then either comment out or delete this entry in your config and run your script again.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">option</span><span class="p">,</span><span class="n">section</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;entry in </span><span class="si">%s</span><span class="s1"> in section </span><span class="si">%s</span><span class="s1"> does not exist. check your config file. If you do not need/have this directory then either comment out or delete this entry in your config and run your script again.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">option</span><span class="p">,</span><span class="n">section</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">SystemExit</span>
                <span class="n">configParse</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">possiblePath</span><span class="p">)</span>                

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configDest</span><span class="p">:</span>
        <span class="n">configParse</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configDest</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<div class="viewcode-block" id="calcs_container"><a class="viewcode-back" href="../prep.html#prep.calcs_container">[docs]</a><span class="k">class</span> <span class="nc">calcs_container</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dictionary</span><span class="p">):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">dictionary</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="o">=</span><span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">first_step</span><span class="o">=</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">=</span><span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">=</span><span class="n">plotter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">split_index</span><span class="o">=</span><span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__getInitInputs</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">=</span><span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">=</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scf_complete</span><span class="o">=</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">=</span><span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">submit_flag</span><span class="o">=</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__add_provenance</span><span class="p">()</span>
		
	<span class="k">def</span> <span class="nf">__add_provenance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">prov_error</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">Properly formatted provenance section is as follows:</span>

<span class="s1">[provenance]</span>
<span class="s1">title = A study of some things about stuff</span>
<span class="s1">author = Andrew Supka; Marco Fornari; Marco Buongiorno Nardelli</span>
<span class="s1">affiliation = Central Michigan University;Central Michigan University; University of North Texas</span>

<span class="s1">parameter values in provenance section can be a single entry or a semi-colon delineated list. </span>
<span class="s1">Lists for each parameter in the provenance section must be the same length. Each entry the list of</span>
<span class="s1">parameters will be grouped. </span>

<span class="s1">eg.)</span>

<span class="s1">Andrew Supka, Central Michigan University</span>
<span class="s1">Marco Fornari, Central Michigan University</span>
<span class="s1">Marco Buongiorno Nardelli, University of North Texas</span>

<span class="s1">EXITING.</span>
<span class="s1">&#39;&#39;&#39;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">title_string</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;provenance&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>		
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">title_string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> 
				<span class="nb">print</span> <span class="s1">&#39;Improperly formatted or absent title parameter in the &quot;provenance&quot; section in config file. &#39;</span>
				<span class="nb">print</span> <span class="s1">&#39;&#39;</span>
				<span class="k">raise</span> <span class="ne">SystemExit</span>

			<span class="n">author_string</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;provenance&#39;</span><span class="p">,</span><span class="s1">&#39;author&#39;</span><span class="p">)</span>		
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">author_string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> 
				<span class="nb">print</span> <span class="s1">&#39;Improperly formatted or absent author parameter in the &quot;provenance&quot; section in config file. &#39;</span>
				<span class="nb">print</span> <span class="n">prov_error</span>
				<span class="k">raise</span> <span class="ne">SystemExit</span>

			<span class="n">author_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">author_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)]</span>

			<span class="n">affil_string</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;provenance&#39;</span><span class="p">,</span><span class="s1">&#39;affiliation&#39;</span><span class="p">)</span>		
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">affil_string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> 
				<span class="nb">print</span> <span class="s1">&#39;Improperly formatted or absent affiliation parameter in the &quot;provenance&quot; section in config file. &#39;</span>
				<span class="nb">print</span> <span class="n">prov_error</span>
				<span class="k">raise</span> <span class="ne">SystemExit</span>

			<span class="n">affil_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">affil_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)]</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">affil_list</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">author_list</span><span class="p">):</span>
				<span class="nb">print</span> 
				<span class="nb">print</span> <span class="s1">&#39;length of semi-colon delimited lists in provenance section of your config file are not the same length.&#39;</span>
				<span class="nb">print</span> <span class="n">prov_error</span>
				<span class="k">raise</span> <span class="ne">SystemExit</span>

			<span class="n">provenance_dict</span><span class="o">=</span><span class="p">{}</span>
			<span class="n">provenance_dict</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">title_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
			<span class="n">provenance_dict</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>



			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">author_list</span><span class="p">)):</span>
				<span class="n">provenance_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;affiliation&#39;</span><span class="p">:</span><span class="n">affil_list</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>

			<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
				<span class="k">if</span> <span class="s1">&#39;provenance&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;provenance&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">provenance_dict</span>

		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="nb">print</span> <span class="n">e</span>
			<span class="k">raise</span> <span class="ne">SystemExit</span>


<div class="viewcode-block" id="calcs_container.increase_step"><a class="viewcode-back" href="../prep.html#prep.calcs_container.increase_step">[docs]</a>	<span class="k">def</span> <span class="nf">increase_step</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
		<span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
		<span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="o">+=</span><span class="mi">1</span>
			<span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_index</span>
			<span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="calcs_container.items"><a class="viewcode-back" href="../prep.html#prep.calcs_container.items">[docs]</a>        <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>

<div class="viewcode-block" id="calcs_container.iteritems"><a class="viewcode-back" href="../prep.html#prep.calcs_container.iteritems">[docs]</a>        <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span></div>

<div class="viewcode-block" id="calcs_container.keys"><a class="viewcode-back" href="../prep.html#prep.calcs_container.keys">[docs]</a>        <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="calcs_container.values"><a class="viewcode-back" href="../prep.html#prep.calcs_container.values">[docs]</a>        <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

        <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">__getInitInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">inputDict</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="n">inputDict</span><span class="p">[</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>

		<span class="k">return</span> <span class="n">inputDict</span>

	
<div class="viewcode-block" id="calcs_container.conventional_cell_input"><a class="viewcode-back" href="../prep.html#prep.calcs_container.conventional_cell_input">[docs]</a>	<span class="k">def</span> <span class="nf">conventional_cell_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="n">conv_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">transform_input_conv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">conv_input</span>
			<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">conv_input</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>		     

			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newIn</span><span class="p">:</span>
				<span class="n">newIn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">conv_input</span><span class="p">)</span>		</div>

<div class="viewcode-block" id="calcs_container.get_initial_inputs"><a class="viewcode-back" href="../prep.html#prep.calcs_container.get_initial_inputs">[docs]</a>	<span class="k">def</span> <span class="nf">get_initial_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">temp_dict</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">temp_dict</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="n">temp_dict</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_inputs</span><span class="p">[</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span></div>

	<span class="k">def</span> <span class="nf">_saveOneCalc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.oneCalc&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">oneCalcPickleFile</span><span class="p">:</span>
			<span class="n">oldOneCalc</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">oneCalcPickleFile</span><span class="p">)</span>    


<div class="viewcode-block" id="calcs_container.resubmit"><a class="viewcode-back" href="../prep.html#prep.calcs_container.resubmit">[docs]</a>	<span class="k">def</span> <span class="nf">resubmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">reset_logs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">resubmit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="calcs_container.scf"><a class="viewcode-back" href="../prep.html#prep.calcs_container.scf">[docs]</a>        <span class="k">def</span> <span class="nf">scf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scf_complete</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">==</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">+=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;scf&quot;&#39;</span><span class="p">)</span><span class="c1">#,change_initial=False)</span>
		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>	</div>


<div class="viewcode-block" id="calcs_container.relax"><a class="viewcode-back" href="../prep.html#prep.calcs_container.relax">[docs]</a>	<span class="k">def</span> <span class="nf">relax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scf_complete</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">==</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;relax&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">+=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;relax&quot;&#39;</span><span class="p">)</span><span class="c1">#,change_initial=False)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Ionic Relaxation&#39;</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>	</div>


<div class="viewcode-block" id="calcs_container.vcrelax"><a class="viewcode-back" href="../prep.html#prep.calcs_container.vcrelax">[docs]</a>	<span class="k">def</span> <span class="nf">vcrelax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scf_complete</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">==</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;vcrelax&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">+=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;vc-relax&quot;&#39;</span><span class="p">)</span><span class="c1">#,change_initial=False)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Variable Cell Relaxation&#39;</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>	</div>
		
<div class="viewcode-block" id="calcs_container.addToAll"><a class="viewcode-back" href="../prep.html#prep.calcs_container.addToAll">[docs]</a>	<span class="k">def</span> <span class="nf">addToAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">block</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">addition</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToBlockWrapper</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">addition</span><span class="p">)</span>    </div>
				
	
<div class="viewcode-block" id="calcs_container.new_step"><a class="viewcode-back" href="../prep.html#prep.calcs_container.new_step">[docs]</a>        <span class="k">def</span> <span class="nf">new_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">new_job</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
			<span class="n">outp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*** Generating Execution Pipeline from Workflow Script ***&quot;</span>
			<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">outp</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="o">+=</span><span class="mi">1</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="n">last_calcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">last_calcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
			
		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span> <span class="o">=</span> <span class="n">writeToScript</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">last_calcs</span><span class="p">,</span><span class="n">from_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_step</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">]</span>
			
		<span class="bp">self</span><span class="o">.</span><span class="n">first_step</span><span class="o">=</span><span class="kc">True</span>

		<span class="sd">&#39;&#39;&#39;update the calc logs&#39;&#39;&#39;</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">updatelogs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="s1">&#39;step_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#		&#39;chooses if the positions and/or structs to update&#39;</span>
<span class="c1">#		if self.split==True:</span>
<span class="c1">#			pre = &#39;split_%02d&#39; % self.step_index</span>
<span class="c1">#			self.int_dict = AFLOWpi.prep.modifyInputPrefixPW(self.int_dict,repr(pre))</span>

<span class="c1">#			self.split=False</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">updateStructs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">update_positions</span><span class="o">=</span><span class="n">update_positions</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="n">update_structure</span><span class="p">)</span>
		<span class="c1">#add workflow to each step</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;_AFLOWPI_WORKFLOW_&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;__chain_index__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_index</span>
		<span class="n">workflow_add_command</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;oneCalc[&#39;_AFLOWPI_WORKFLOW_&#39;]=</span><span class="si">%s</span><span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">workflow_add_command</span><span class="p">)</span>		
				
		<span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="o">=</span><span class="n">plotter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="calcs_container.change_pseudos"><a class="viewcode-back" href="../prep.html#prep.calcs_container.change_pseudos">[docs]</a>	<span class="k">def</span> <span class="nf">change_pseudos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">directory</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
			<span class="n">directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">__file__</span><span class="p">)),</span><span class="n">directory</span><span class="p">)</span>

		
		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span> <span class="o">=</span> <span class="n">changeCalcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;pseudos&#39;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span></div>


<div class="viewcode-block" id="calcs_container.change_input"><a class="viewcode-back" href="../prep.html#prep.calcs_container.change_input">[docs]</a>	<span class="k">def</span> <span class="nf">change_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">namelist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">parameter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">modifyNamelistPW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">namelist</span><span class="p">,</span><span class="n">parameter</span><span class="p">,</span><span class="n">value</span><span class="p">)</span></div>


		
<div class="viewcode-block" id="calcs_container.converge_smearing"><a class="viewcode-back" href="../prep.html#prep.calcs_container.converge_smearing">[docs]</a>	<span class="k">def</span> <span class="nf">converge_smearing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">relax</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">smear_variance</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">num_points</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">smear_type</span><span class="o">=</span><span class="s1">&#39;mp&#39;</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

		<span class="n">rel_low</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">rel_low</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;vc-relax&#39;</span><span class="p">,</span><span class="s1">&#39;relax&#39;</span><span class="p">,</span><span class="s1">&#39;scf&#39;</span><span class="p">]:</span>
			<span class="nb">print</span> <span class="s2">&quot;Invalid option for relax parameter in converge_smearing!&quot;</span>
			<span class="nb">print</span> <span class="s2">&quot;Must be either &#39;vc-relax&#39;,&#39;relax&#39;, or &#39;scf&#39;&quot;</span>
			<span class="nb">print</span> <span class="s2">&quot;EXITING&quot;</span>
			<span class="k">raise</span> <span class="ne">SystemExit</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;converge_smearing&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>

		<span class="n">gen_func</span> <span class="o">=</span> <span class="s2">&quot;AFLOWpi.run._gen_smear_conv_calcs(oneCalc,ID,num_points=</span><span class="si">%s</span><span class="s2">,smear_type=&#39;</span><span class="si">%s</span><span class="s2">&#39;,smear_variance=</span><span class="si">%s</span><span class="s2">,calc_type=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span><span class="n">smear_type</span><span class="p">,</span><span class="n">smear_variance</span><span class="p">,</span><span class="n">relax</span><span class="p">)</span>

		<span class="n">task_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AFLOWpi.run.scf(calc_subset)&#39;</span><span class="p">,]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">prep_split_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">gen_func</span><span class="p">,</span>
							   <span class="n">mult_jobs</span><span class="o">=</span><span class="n">mult_jobs</span><span class="p">,</span>
							   <span class="n">subset_tasks</span><span class="o">=</span><span class="n">task_list</span><span class="p">,</span><span class="n">substep_name</span><span class="o">=</span><span class="s1">&#39;SMEARING&#39;</span><span class="p">,</span><span class="n">keep_file_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
							   <span class="n">clean_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
							   <span class="n">fault_tolerant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



		<span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;oneCalc,ID = AFLOWpi.run._extrapolate_smearing(oneCalc,ID)&#39;&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>		
		<span class="c1">#displays that this step has been added to the workflow. Nothing special but nice to have</span>
		<span class="c1">#this so that the user can verify their workflow is as they expect it to be.</span>
		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Smearing Convergence&#39;</span>

<span class="c1">#		print &#39;\nADDING STEP #%02d: %s&#39;% (self.step_index,calc_type)</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
		



<div class="viewcode-block" id="calcs_container.tight_binding"><a class="viewcode-back" href="../prep.html#prep.calcs_container.tight_binding">[docs]</a>	<span class="k">def</span> <span class="nf">tight_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">proj_thr</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span><span class="n">kp_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">proj_sh</span><span class="o">=</span><span class="mf">5.5</span><span class="p">,</span><span class="n">cond_bands_proj</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scf_complete</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">==</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;PAO-TB&#39;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Generate PAO-TB Hamiltonian&#39;</span>
		<span class="k">if</span> <span class="n">cond_bands</span><span class="p">:</span>
			<span class="n">calc_type</span><span class="o">+=</span><span class="s1">&#39; with occupied and unoccupied states&#39;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">calc_type</span><span class="o">+=</span><span class="s1">&#39; with only occupied states&#39;</span>
			
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span>
<span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">tight_binding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">cond_bands</span><span class="o">=</span><span class="n">cond_bands</span><span class="p">,</span><span class="n">proj_thr</span><span class="o">=</span><span class="n">proj_thr</span><span class="p">,</span><span class="n">kp_factor</span><span class="o">=</span><span class="n">kp_factor</span><span class="p">,</span><span class="n">proj_sh</span><span class="o">=</span><span class="n">proj_sh</span><span class="p">,</span><span class="n">cond_bands_proj</span><span class="o">=</span><span class="n">cond_bands_proj</span><span class="p">)</span></div>

<div class="viewcode-block" id="calcs_container.elastic"><a class="viewcode-back" href="../prep.html#prep.calcs_container.elastic">[docs]</a>	<span class="k">def</span> <span class="nf">elastic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">eta_max</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="n">num_dist</span><span class="o">=</span><span class="mi">10</span><span class="p">,):</span>
		<span class="c1">#flag to determine if we need to recalculate the TB hamiltonian if </span>
		<span class="c1">#the user has chosen to calculate it on a later step in the workflow</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">=</span><span class="kc">False</span>
		<span class="c1">#the type of calculation is added to the workflow list and is used </span>
		<span class="c1">#by AFLOWpi sometimes to find the step number of a specific type of</span>
		<span class="c1">#calculation in the workflow for processing later</span>

		<span class="n">use_stress</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;elastic&#39;</span>
		<span class="c1">#updates the structure and atomic positions from previous steps and</span>
		<span class="c1">#sets up a new ID.py, ID.qsub (if applicable) and ID.in</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="c1">#adds prep_fd to be run to every calculation in the set</span>
		<span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;AFLOWpi.run._prep_elastic(oneCalc,ID,eta_max=</span><span class="si">%s</span><span class="s1">,num_dist=</span><span class="si">%s</span><span class="s1">,use_stress = </span><span class="si">%s</span><span class="s1">,order=</span><span class="si">%s</span><span class="s1">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">eta_max</span><span class="p">,</span><span class="n">num_dist</span><span class="p">,</span><span class="n">use_stress</span><span class="p">,</span><span class="n">order</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>		

		<span class="n">output_move_string</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;AFLOWpi.prep._addToAll(calc_subset,&#39;RUN&#39;,&#39;AFLOWpi.run._copy_qe_out_file(oneCalc,ID)&#39;)&quot;&quot;&quot;</span>
		<span class="n">task_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AFLOWpi.run.scf(calc_subset)&#39;</span><span class="p">,</span><span class="n">output_move_string</span><span class="p">]</span>

<span class="c1">#		if with_u:</span>
<span class="c1">#			task_list=[&#39;calc_subset=AFLOWpi.scfuj.scfprep(calc_subset)&#39;,&#39;AFLOWpi.scfuj.run(calc_subset)&#39;,output_move_string]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">prep_split_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="s1">&#39;AFLOWpi.run._grab_elastic_generated_inputs(oneCalc,ID)&#39;</span><span class="p">,</span>
							   <span class="n">mult_jobs</span><span class="o">=</span><span class="n">mult_jobs</span><span class="p">,</span>
							   <span class="n">subset_tasks</span><span class="o">=</span><span class="n">task_list</span><span class="p">,</span><span class="n">substep_name</span><span class="o">=</span><span class="s1">&#39;ELASTIC&#39;</span><span class="p">,</span><span class="n">keep_file_names</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
							   <span class="n">clean_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

		<span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;AFLOWpi.run._pp_elastic(oneCalc,ID)&#39;&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>		

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Elastic Constants&#39;</span>

<span class="c1">#		print &#39;\nADDING STEP #%02d: %s&#39;% (self.step_index,calc_type)</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="calcs_container.thermal"><a class="viewcode-back" href="../prep.html#prep.calcs_container.thermal">[docs]</a>	<span class="k">def</span> <span class="nf">thermal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delta_volume</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span><span class="n">nrx1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">field_cycles</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">LOTO</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">hydrostatic_expansion</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="n">workf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span>

		<span class="c1">#check to see if phonon was already done and the structure hasn&#39;t changed since</span>
		<span class="c1">#if structure has changed redo first set of phonons if it hasn&#39;t then skip doing</span>
		<span class="c1">#it and just do the volume increase and the phonons at larger vol</span>
		<span class="n">do_first_phon</span><span class="o">=</span><span class="kc">False</span>

		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">workf</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;relax&#39;</span><span class="p">,</span><span class="s1">&#39;vcrelax&#39;</span><span class="p">]:</span>
				<span class="n">do_first_phon</span><span class="o">=</span><span class="kc">True</span>
				<span class="k">break</span>
			<span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="s1">&#39;phonon&#39;</span><span class="p">:</span>
				<span class="k">break</span>

		<span class="k">if</span> <span class="n">do_first_phon</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">phonon</span><span class="p">(</span><span class="n">nrx1</span><span class="o">=</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="n">de</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="n">mult_jobs</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="n">disp_sym</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="n">atom_sym</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="n">field_strength</span><span class="p">,</span><span class="n">field_cycles</span><span class="o">=</span><span class="n">field_cycles</span><span class="p">,</span><span class="n">LOTO</span><span class="o">=</span><span class="n">LOTO</span><span class="p">)</span>
			<span class="nb">print</span> <span class="s1">&#39;&#39;&#39;                 NOTE: Phonon calculation at initial volume not completed or</span>
<span class="s1">                 structure will change between Initial and volume expanded phonon </span>
<span class="s1">                 calculation. Initial phonon at regular volume will be calculated.&#39;&#39;&#39;</span>

		<span class="c1">#do relaxation with expanded volume</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;thermal&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Atomic position relaxation calculation at expanded volume.&#39;</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

		<span class="c1">#hydrostatic_expansion: True  - keep lattice vector ratio and angles</span>
		<span class="c1">#                                between them fixed between V and V&#39;</span>
		<span class="c1">#                       False - allow ratio between lattice vectors and angles </span>
		<span class="c1">#                               between them to change but keep the V&#39; fixed</span>
		<span class="k">if</span> <span class="n">hydrostatic_expansion</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;relax&quot;&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;vc-relax&quot;&#39;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;cell&#39;</span><span class="p">,</span><span class="s1">&#39;cell_dofree&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;shape&quot;&#39;</span><span class="p">)</span>

		<span class="c1">#reset the last entry in the workflow because the relax is with increased volume</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;thermal_relax&#39;</span>

		<span class="c1">#run the relax</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>	
		<span class="c1">#add the command to change the celldm(1) by cube root of</span>
		<span class="c1">#1.00+percent and add the &#39;_vol&#39; to the end of the QE prefix</span>
		<span class="n">delta_volume</span><span class="o">+=</span><span class="mf">1.0</span>
		<span class="n">delta_celldm1</span><span class="o">=</span><span class="n">delta_volume</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
		<span class="n">loadModString</span><span class="o">=</span><span class="s1">&#39;oneCalc,ID = AFLOWpi.retr._increase_celldm1(oneCalc,ID,</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">delta_celldm1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>				

		<span class="c1">#increasing the index to make sure the previous step gets loaded </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">+=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">phonon</span><span class="p">(</span><span class="n">nrx1</span><span class="o">=</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="n">de</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="n">mult_jobs</span><span class="p">,</span><span class="n">LOTO</span><span class="o">=</span><span class="n">LOTO</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="n">field_strength</span><span class="p">,</span><span class="n">field_cycles</span><span class="o">=</span><span class="n">field_cycles</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="n">disp_sym</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="n">atom_sym</span><span class="p">,)</span>

		<span class="c1">#fixing the loading index to make sure the previous step won&#39;t get loaded later</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">-=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

		<span class="c1">#reset the last entry in the workflow because the second phonon calc wont have LOTO</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;thermal&#39;</span>
		
		<span class="c1">#fixing the workflow written in _&lt;ID&gt;.py </span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;_AFLOWPI_WORKFLOW_&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span>
		<span class="n">workflow_add_command</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;oneCalc[&#39;_AFLOWPI_WORKFLOW_&#39;]=</span><span class="si">%s</span><span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">workflow_add_command</span><span class="p">)</span>		

		<span class="c1">#adding post processing for thermal stuff</span>
		<span class="n">workflow_add_command</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;AFLOWpi.retr._therm_pp(oneCalc,ID)&#39;&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">workflow_add_command</span><span class="p">)</span>	

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Expanded Volume Phonon for Thermal Conductivity and Gruneisen Parameter&#39;</span>
		<span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>



<div class="viewcode-block" id="calcs_container.phonon"><a class="viewcode-back" href="../prep.html#prep.calcs_container.phonon">[docs]</a>	<span class="k">def</span> <span class="nf">phonon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nrx1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.003</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">LOTO</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="mf">0.003</span><span class="p">,</span><span class="n">field_cycles</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">proj_phDOS</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="c1">#disable raman for this release</span>
		<span class="n">raman</span><span class="o">=</span><span class="kc">False</span>
		<span class="c1">#flag to determine if we need to recalculate the TB hamiltonian if </span>
		<span class="c1">#the user has chosen to calculate it on a later step in the workflow</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">=</span><span class="kc">False</span>
		<span class="c1">#the type of calculation is added to the workflow list and is used </span>
		<span class="c1">#by AFLOWpi sometimes to find the step number of a specific type of</span>
		<span class="c1">#calculation in the workflow for processing later</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;phonon&#39;</span>
		<span class="c1">#updates the structure and atomic positions from previous steps and</span>
		<span class="c1">#sets up a new ID.py, ID.qsub (if applicable) and ID.in</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="c1">#adds prep_fd to be run to every calculation in the set</span>
		<span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;AFLOWpi.run.prep_fd(__submitNodeName__,oneCalc,ID,nrx1=</span><span class="si">%i</span><span class="s1">,nrx2=</span><span class="si">%i</span><span class="s1">,nrx3=</span><span class="si">%i</span><span class="s1">,innx=</span><span class="si">%i</span><span class="s1">,de=</span><span class="si">%f</span><span class="s1">,atom_sym=</span><span class="si">%s</span><span class="s1">,disp_sym=</span><span class="si">%s</span><span class="s1">,proj_phDOS=</span><span class="si">%s</span><span class="s1">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="p">,</span><span class="n">atom_sym</span><span class="p">,</span><span class="n">disp_sym</span><span class="p">,</span><span class="n">proj_phDOS</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>		
		<span class="c1">#adds the command to pull the forces from the calculations in the subset</span>
		<span class="c1">#after they&#39;ve finished. All tasks that are to be performed on the subset</span>
		<span class="c1">#need to take a dictionary of dictionaries called &quot;calc_subset&quot; which is </span>
		<span class="c1">#generated from the list of files or strings representing inputs to the </span>
		<span class="c1">#calculation engine in AFLOWpi.prep.prep_split_step.</span>
		<span class="n">force_pull_string</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;AFLOWpi.prep._addToAll(calc_subset,&#39;RUN&#39;,&#39;AFLOWpi.run._pull_forces(oneCalc,ID)&#39;)&quot;&quot;&quot;</span>
		<span class="c1">#adds the command to run the FD phonon calculations with pw.x and to add the command</span>
		<span class="c1">#to run finite fields calculations for raman to the calculations in the subset</span>
		<span class="k">if</span> <span class="n">raman</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
			<span class="n">LOTO</span><span class="o">=</span><span class="kc">True</span>
			<span class="n">task_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AFLOWpi.run.scf(calc_subset)&#39;</span><span class="p">,</span>
				   <span class="s1">&#39;AFLOWpi.run._setup_raman(calc_subset,oneCalc,ID,field_strength=</span><span class="si">%s</span><span class="s1">,field_cycles=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">field_strength</span><span class="p">,</span><span class="n">field_cycles</span><span class="p">),</span><span class="n">force_pull_string</span><span class="p">,]</span>
		<span class="c1">#adds the command to run the FD phonon calculations with pw.x and to add the command</span>
		<span class="c1">#to run finite fields calculations for eps_inf and Z* to the calculations in the subset</span>
		<span class="k">elif</span> <span class="n">LOTO</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
			<span class="n">task_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AFLOWpi.run.scf(calc_subset)&#39;</span><span class="p">,</span>
				   <span class="s1">&#39;AFLOWpi.run._setup_raman(calc_subset,oneCalc,ID,for_type=&quot;born&quot;,field_strength=</span><span class="si">%s</span><span class="s1">,field_cycles=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">field_strength</span><span class="p">,</span><span class="n">field_cycles</span><span class="p">),</span><span class="n">force_pull_string</span><span class="p">,]</span>
                <span class="c1">#adds the command to run the FD phonon calculations with pw.x</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">task_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AFLOWpi.run.scf(calc_subset)&#39;</span><span class="p">,</span><span class="n">force_pull_string</span><span class="p">,]</span>
		<span class="c1">#add the command to the ID.py that will generate the subset FD_PHONON and perform</span>
		<span class="c1">#the tasks in task_list. The flags for mult_jobs (parallel cluster jobs) is passed</span>
		<span class="c1">#into this function and that option will be written to the ID.py</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">prep_split_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="s1">&#39;AFLOWpi.run._one_phon(oneCalc,ID)&#39;</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="n">mult_jobs</span><span class="p">,</span>
							   <span class="n">subset_tasks</span><span class="o">=</span><span class="n">task_list</span><span class="p">,</span><span class="n">substep_name</span><span class="o">=</span><span class="s1">&#39;FD_PHONON&#39;</span><span class="p">,</span><span class="n">keep_file_names</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
							   <span class="n">clean_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="c1">#after all the calculations in the subset have finshed we do some kind of postprocessing </span>
		<span class="c1">#routine(s) to extract/process data</span>
		<span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;AFLOWpi.run._pp_phonon(__submitNodeName__,oneCalc,ID,de=</span><span class="si">%s</span><span class="s1">,raman=</span><span class="si">%s</span><span class="s1">,LOTO=</span><span class="si">%s</span><span class="s1">,field_strength=</span><span class="si">%s</span><span class="s1">,project_phDOS=</span><span class="si">%s</span><span class="s1">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">de</span><span class="p">,</span><span class="n">raman</span><span class="p">,</span><span class="n">LOTO</span><span class="p">,</span><span class="n">field_strength</span><span class="p">,</span><span class="n">proj_phDOS</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addToAll</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>		
		<span class="c1">#displays that this step has been added to the workflow. Nothing special but nice to have</span>
		<span class="c1">#this so that the user can verify their workflow is as they expect it to be.</span>
		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Phonon&#39;</span>
		<span class="k">if</span> <span class="n">raman</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
			<span class="n">calc_type</span><span class="o">+=</span><span class="s1">&#39; with Raman scattering&#39;</span>
<span class="c1">#		print &#39;\nADDING STEP #%02d: %s&#39;% (self.step_index,calc_type)</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>




<div class="viewcode-block" id="calcs_container.acbn0"><a class="viewcode-back" href="../prep.html#prep.calcs_container.acbn0">[docs]</a>	<span class="k">def</span> <span class="nf">acbn0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">nIters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">paodir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">relax</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">mixing</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span><span class="n">kp_mult</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.scfuj.scfPrep and AFLOWpi.scfuj.run in the high level </span>
<span class="sd">		user interface. Adds a new step to the workflow.</span>
<span class="sd">		</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the _calcs_container object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      thresh (float): threshold for self consistent hubbard U convergence</span>
<span class="sd">		      niters (int): max number of iterations of the acbn0 cycle</span>
<span class="sd">		      paodir (string): the path of the PAO directory. This will override </span>
<span class="sd">		                        an entry of the paodir in the AFLOWpi config file </span>
<span class="sd">		                        used for the session</span>
<span class="sd">		      mixing (float): the amount of the previous acbn0 U iteration to mix into</span>
<span class="sd">                                      the current (only needed when there is U val oscillation)</span>
<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>		
		<span class="n">rel_low</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">rel_low</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;vc-relax&#39;</span><span class="p">,</span><span class="s1">&#39;relax&#39;</span><span class="p">,</span><span class="s1">&#39;scf&#39;</span><span class="p">]:</span>
			<span class="nb">print</span> <span class="s2">&quot;Invalid option for relax parameter in acbn0!&quot;</span>
			<span class="nb">print</span> <span class="s2">&quot;Must be either &#39;vc-relax&#39;,&#39;relax&#39;, or &#39;scf&#39;&quot;</span>
			<span class="nb">print</span> <span class="s2">&quot;EXITING&quot;</span>
			<span class="k">raise</span> <span class="ne">SystemExit</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">scf_complete</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">+=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;scfuj&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="n">relax</span><span class="p">)</span>


		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">scfprep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">paodir</span><span class="o">=</span><span class="n">paodir</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">uThresh</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span> <span class="n">nIters</span><span class="o">=</span><span class="n">nIters</span><span class="p">,</span><span class="n">mixing</span><span class="o">=</span><span class="n">mixing</span><span class="p">,</span><span class="n">kp_mult</span><span class="o">=</span><span class="n">kp_mult</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;ACBN0 Self-Consistent Hubbard U&#39;</span>
<span class="c1">#		print &#39;\nADDING STEP #%02d: %s&#39;% (self.step_index,calc_type)</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="calcs_container.crawl_min"><a class="viewcode-back" href="../prep.html#prep.calcs_container.crawl_min">[docs]</a>	<span class="k">def</span> <span class="nf">crawl_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">grid_density</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">initial_variance</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">final_minimization</span><span class="o">=</span><span class="s1">&#39;relax&#39;</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.pseudo.crawlingMinimization in the high level user interface.</span>
<span class="sd">		Adds a new step to the workflow.</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the _calcs_container object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      mult_jobs (bool): if True split the individual scf jobs into separate cluster jobs </span>
<span class="sd">		                     if False run them serially</span>
<span class="sd">		      grid_density (int): controls the number of calculations to generate for the minimization</span>
<span class="sd">		                           num_{calcs}=grid_density^{num_{parameters}-num_{constraints}}</span>
<span class="sd">		      initial_variance (float): amount to vary the values of the parameters from the initial</span>
<span class="sd">		                                 value. i.e. (0.02 = +/-2% variance)</span>
<span class="sd">		      thresh (float): threshold for $\DeltaX$ of the lattice parameters between brute force</span>
<span class="sd">		                  minimization iterations.</span>
<span class="sd">           	      constraint (list): a list or tuple containing two entry long list or tuples with</span>
<span class="sd">  	                                  the first being the constraint type and the second the free </span>
<span class="sd">				          parameter in params that its constraining for example in a </span>
<span class="sd">				          orthorhombic cell: constraint=([&quot;volume&quot;,&#39;c&#39;],) allows for A and B</span>
<span class="sd">				          to move freely but C is such that it keeps the cell volume the same</span>
<span class="sd">				          in all calculations generated by the input oneCalc calculation.		 </span>
<span class="sd">		      final_minimization (str): calculation to be run at the end of the brute force minimization</span>
<span class="sd">		                                 options include &quot;scf&quot;, &quot;relax&quot;, and &quot;vcrelax&quot;</span>
<span class="sd">				     </span>

<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">scf_complete</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">==</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">+=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;crawl_min&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">pseudo</span><span class="o">.</span><span class="n">crawlingMinimization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="n">mult_jobs</span><span class="p">,</span><span class="n">grid_density</span><span class="o">=</span><span class="n">grid_density</span><span class="p">,</span><span class="n">initial_variance</span><span class="o">=</span><span class="n">initial_variance</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Crawling brute force cell optimization&#39;</span>
<span class="c1">#		print &#39;\nADDING STEP #%02d: %s&#39;% (self.step_index,calc_type)</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="calcs_container.evCurve_min"><a class="viewcode-back" href="../prep.html#prep.calcs_container.evCurve_min">[docs]</a>        <span class="k">def</span> <span class="nf">evCurve_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pThresh</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">final_minimization</span><span class="o">=</span><span class="s1">&#39;relax&#39;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scf_complete</span><span class="o">=</span><span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;evCurve_min&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">+=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">evCurveMinimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">pThresh</span><span class="o">=</span><span class="n">pThresh</span><span class="p">,</span><span class="n">final_minimization</span><span class="o">=</span><span class="n">final_minimization</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="calcs_container.dos"><a class="viewcode-back" href="../prep.html#prep.calcs_container.dos">[docs]</a>        <span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kpFactor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">project</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">n_conduction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.prep.doss in the high level user interface.</span>
<span class="sd">		Adds a new step to the workflow.</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the _calcs_container object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      kpFactor (float): factor to which the k-point grid is made denser in each direction</span>
<span class="sd">		      project (bool): if True: do the projected DOS after completing the DOS</span>

<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">=</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;dos&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">doss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">kpFactor</span><span class="o">=</span><span class="n">kpFactor</span><span class="p">,</span><span class="n">n_conduction</span><span class="o">=</span><span class="n">n_conduction</span><span class="p">)</span>
		<span class="n">postfix</span> <span class="o">=</span> <span class="n">ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;exec_postfix&#39;</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;npool&#39;</span><span class="p">,</span><span class="n">postfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;nk&#39;</span><span class="p">,</span><span class="n">postfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;wf_collect&#39;</span><span class="p">,</span><span class="s1">&#39;.TRUE.&#39;</span><span class="p">)</span><span class="c1">#,change_initial=False)		</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">dos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>	

		<span class="k">if</span> <span class="n">project</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">pdos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Density of States&#39;</span>
		<span class="k">if</span> <span class="n">project</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
			<span class="n">calc_type</span><span class="o">+=</span><span class="s1">&#39; with atomic projection&#39;</span>
<span class="c1">#		print &#39;\nADDING STEP #%02d: %s&#39;% (self.step_index,calc_type)</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="calcs_container.bands"><a class="viewcode-back" href="../prep.html#prep.calcs_container.bands">[docs]</a>        <span class="k">def</span> <span class="nf">bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nk</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">n_conduction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to write call AFLOWpi.prep.bands for calculating the Electronic Band</span>
<span class="sd">		Structure. </span>

<span class="sd">		Arguments:</span>
<span class="sd">		      calcs (dict): a dictionary of dicionaries representing the set of calculations</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      dk (float): the density in the Brillouin zone of the k point sampling along the</span>
<span class="sd">	                           entirety of the path between high symmetry points.</span>
<span class="sd">		      nk (int): the approximate number of sampling points  in the Brillouin Zone along</span>
<span class="sd"> 	                         the entirety of the path between high symmetry points. Points are </span>
<span class="sd">			         chosen so that they are equidistant along the entirety of the path.</span>
<span class="sd">			         The actual number of points will be slightly different than the </span>
<span class="sd">			         inputted value of nk. nk!=None will override any value for dk.</span>

<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tight_banding</span><span class="o">=</span><span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;bands&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

		<span class="n">postfix</span> <span class="o">=</span> <span class="n">ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;exec_postfix&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;npool&#39;</span><span class="p">,</span><span class="n">postfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;nk&#39;</span><span class="p">,</span><span class="n">postfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">change_input</span><span class="p">(</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;wf_collect&#39;</span><span class="p">,</span><span class="s1">&#39;.TRUE.&#39;</span><span class="p">)</span><span class="c1">#,change_initial=False)		</span>
	
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">dk</span><span class="o">=</span><span class="n">dk</span><span class="p">,</span><span class="n">nk</span><span class="o">=</span><span class="n">nk</span><span class="p">,</span><span class="n">n_conduction</span><span class="o">=</span><span class="n">n_conduction</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">bands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Electronic Band Structure&#39;</span>
<span class="c1">#		print &#39;\nADDING STEP #%02d: %s&#39;% (self.step_index,calc_type)</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="calcs_container.pseudo_test_brute"><a class="viewcode-back" href="../prep.html#prep.calcs_container.pseudo_test_brute">[docs]</a>	<span class="k">def</span> <span class="nf">pseudo_test_brute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ecutwfc</span><span class="p">,</span><span class="n">dual</span><span class="o">=</span><span class="p">[],</span><span class="n">sampling</span><span class="o">=</span><span class="p">[],</span><span class="n">conv_thresh</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">initial_relax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
			      <span class="n">min_thresh</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">initial_variance</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">grid_density</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


		<span class="bp">self</span><span class="o">.</span><span class="n">load_index</span><span class="o">+=</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;brute_pseudotest&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">new_step</span><span class="p">(</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">)</span>		

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">pseudo</span><span class="o">.</span><span class="n">brute_test</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dict</span><span class="p">,</span><span class="n">ecutwfc</span><span class="p">,</span><span class="n">dual</span><span class="o">=</span><span class="n">dual</span><span class="p">,</span><span class="n">sampling</span><span class="o">=</span><span class="n">sampling</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">conv_thresh</span><span class="p">,</span><span class="n">initial_variance</span><span class="o">=</span><span class="n">initial_variance</span><span class="p">,</span><span class="n">grid_density</span><span class="o">=</span><span class="n">grid_density</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="n">mult_jobs</span><span class="p">,)</span>
		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Brute Force Pseudotesting&#39;</span>
<span class="c1">#		print &#39;\nADDING STEP #%02d: %s&#39;% (self.step_index,calc_type)</span>
		<span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ADDING STEP #</span><span class="si">%02d</span><span class="s1">: &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_index</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;GREEN&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">calc_type</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
	

	<span class="k">def</span> <span class="nf">_addToInit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">block</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">addition</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">addToBlockWrapper</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">addition</span><span class="p">)</span>    

<div class="viewcode-block" id="calcs_container.submit"><a class="viewcode-back" href="../prep.html#prep.calcs_container.submit">[docs]</a>	<span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_flag</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">init_calcs</span><span class="o">=</span><span class="n">initial_calcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>				

			<span class="k">except</span><span class="p">:</span>
				<span class="nb">print</span> <span class="s1">&#39;Must add at least one step to workflow. Exiting&#39;</span>
				<span class="k">raise</span> <span class="ne">SystemExit</span>

			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">addatexit__</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">submitFirstCalcs__</span><span class="p">,</span><span class="n">init_calcs</span><span class="p">,)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">submit_flag</span><span class="o">=</span><span class="kc">True</span></div></div>

<div class="viewcode-block" id="plotter"><a class="viewcode-back" href="../prep.html#prep.plotter">[docs]</a><span class="k">class</span> <span class="nc">plotter</span><span class="p">:</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	Class for adding common plotting functions from AFLOWpi.plot module to the high level user </span>
<span class="sd">	interface. </span>

<span class="sd">	&#39;&#39;&#39;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">calcs</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="o">=</span><span class="n">calcs</span>
	

	<span class="c1"># def gruneisen(self,runlocal=False,with_phonons,postfix=&#39;&#39;,with_phonons=False):</span>

	<span class="c1"># 	if runlocal==True:</span>
	<span class="c1"># 		for ID,oneCalc in self.int_dict.iteritems():</span>
	<span class="c1"># 			AFLOWpi.plot.__plot_gruneisen(oneCalc,ID,postfix=postfix,with_phonons=with_phonons)</span>
	<span class="c1"># 	else:</span>
	<span class="c1"># 		loadModString = &#39;AFLOWpi.plot.__plot_gruneisen(oneCalc,ID,postfix=%s,with_phonons=%s)&#39;%(postfix,with_phonons)</span>
	<span class="c1"># 		AFLOWpi.prep._addToAll(calcs,block=&#39;PREPROCESSING&#39;,addition=loadModString)</span>

	<span class="c1"># def thermal_conductivity(self,runlocal=False,temperature=[300.0,800.0],postfix=&#39;&#39;):</span>

	<span class="c1"># 	if runlocal==True:</span>
	<span class="c1"># 		for ID,oneCalc in self.int_dict.iteritems():</span>
	<span class="c1"># 			AFLOWpi.plot.__plot_thermal_conductivity(oneCalc,ID,postfix=postfix,temperature=temperature)</span>
	<span class="c1"># 	else:</span>
	<span class="c1"># 		loadModString = &#39;AFLOWpi.plot.__plot_thermal_conductivity(oneCalc,ID,postfix=%s,temperature=%s)&#39;%(postfix,temperature)</span>
	<span class="c1"># 		AFLOWpi.prep._addToAll(calcs,block=&#39;PREPROCESSING&#39;,addition=loadModString)</span>


<div class="viewcode-block" id="plotter.opdos"><a class="viewcode-back" href="../prep.html#prep.plotter.opdos">[docs]</a>	<span class="k">def</span> <span class="nf">opdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.plot.opdos in the high level user interface.</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the plotter object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      yLim (list): a tuple or list of the range of energy around the fermi/Highest</span>
<span class="sd">		                    occupied level energy that is to be included in the plot.</span>
<span class="sd">		      LSDA (bool): Plot the up and down of a spin polarized orbital projected DOS</span>
<span class="sd">		                    calculation.</span>
<span class="sd">		      runlocal (bool): a flag to choose whether or not to run the wrapped function now</span>
<span class="sd">               	                        or write it to the _ID.py to run during the workflow</span>
<span class="sd">		      postfix (string): a string of an optional postfix to the plot filename for every</span>
<span class="sd">		                         calculation.</span>

<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">opdos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="n">yLim</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="n">runlocal</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="n">postfix</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Plot Orbital Projected DOS&#39;</span>
		<span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="plotter.phonon"><a class="viewcode-back" href="../prep.html#prep.plotter.phonon">[docs]</a>	<span class="k">def</span> <span class="nf">phonon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">THz</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">phonon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="n">runlocal</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="n">postfix</span><span class="p">,</span><span class="n">THz</span><span class="o">=</span><span class="n">THz</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Plot Phonon Bands and DOS&#39;</span>

		<span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span>		</div>

<div class="viewcode-block" id="plotter.bands"><a class="viewcode-back" href="../prep.html#prep.plotter.bands">[docs]</a>	<span class="k">def</span> <span class="nf">bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="n">DOSPlot</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.plot.bands in the high level user interface.</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the plotter object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      yLim (list): a tuple or list of the range of energy around the fermi/Highest</span>
<span class="sd">		                occupied level energy that is to be included in the plot.</span>
<span class="sd">		      DOSPlot (str): a string that flags for the option to have either a DOS plot</span>
<span class="sd">		                   share the Y-axis of the band structure plot. </span>

<span class="sd">				   Options include:</span>
<span class="sd">				   &quot;&quot;      | A blank string (default) will cause No Density of</span>
<span class="sd">				           | States plotted alongside the Band Structure</span>

<span class="sd">				   &quot;APDOS&quot; | Atom Projected Density of States</span>
<span class="sd">				   &quot;DOS&quot;   | Normal Density of States</span>

<span class="sd">				   </span>
<span class="sd">		      </span>
<span class="sd">		      LSDA (bool): Plot the up and down of a spin polarized orbital projected DOS</span>
<span class="sd">		                calculation.</span>
<span class="sd">		      runlocal (bool): a flag to choose whether or not to run the wrapped function now</span>
<span class="sd">               	                    or write it to the _ID.py to run during the workflow</span>
<span class="sd">		      postfix (str): a string of an optional postfix to the plot filename for every</span>
<span class="sd">		                   calculation.</span>

<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="n">yLim</span><span class="p">,</span><span class="n">DOSPlot</span><span class="o">=</span><span class="n">DOSPlot</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="n">runlocal</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="n">postfix</span><span class="p">)</span>

		<span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;Plot Electronic Band Structure&#39;</span>
		<span class="k">if</span> <span class="n">DOSPlot</span><span class="o">==</span><span class="s1">&#39;DOS&#39;</span><span class="p">:</span>
			<span class="n">calc_type</span><span class="o">+=</span><span class="s1">&#39; with Density of States&#39;</span>
		<span class="k">if</span> <span class="n">DOSPlot</span><span class="o">==</span><span class="s1">&#39;APDOS&#39;</span><span class="p">:</span>
			<span class="n">calc_type</span><span class="o">+=</span><span class="s1">&#39; with Atom Projected Density of States&#39;</span>
		<span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="plotter.dos"><a class="viewcode-back" href="../prep.html#prep.plotter.dos">[docs]</a>	<span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Wrapper method to call AFLOWpi.plot.dos in the high level user interface.</span>

<span class="sd">		Arguments:</span>
<span class="sd">		      self: the plotter object</span>

<span class="sd">		Keyword Arguments:</span>
<span class="sd">		      yLim (list): a tuple or list of the range of energy around the fermi/Highest</span>
<span class="sd">		                    occupied level energy that is to be included in the plot.</span>
<span class="sd">		      LSDA (bool): Plot the up and down of a spin polarized DOS</span>
<span class="sd">		                    calculation.</span>
<span class="sd">		      runlocal (bool): a flag to choose whether or not to run the wrapped function now</span>
<span class="sd">               	                 or write it to the _ID.py to run during the workflow</span>
<span class="sd">		      postfix (str): a string of an optional postfix to the plot filename for every</span>
<span class="sd">		                      calculation.</span>

<span class="sd">		Returns:</span>
<span class="sd">		      None</span>

<span class="sd">		&#39;&#39;&#39;</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">dos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcs</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="n">yLim</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="n">runlocal</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="n">postfix</span><span class="p">)</span>

		<span class="n">calc_type</span> <span class="o">=</span><span class="s1">&#39;Plot Density of States&#39;</span>
		<span class="nb">print</span> <span class="s1">&#39;                 </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">calc_type</span><span class="p">)</span></div></div>





<span class="c1">####################################################################################################################</span>
<span class="c1">####################################################################################################################</span>
<span class="c1">##MODIFY QE INPUT</span>
<span class="c1">####################################################################################################################</span>
<span class="c1">####################################################################################################################</span>

<span class="k">def</span> <span class="nf">_num_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">mult</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    attempt to find the number of kohn-sham orbitals after the scf calculation to find</span>
<span class="sd">    the value of the &quot;nbnd&quot; parameter in the &quot;&amp;system&quot; namelist of QE input files.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>

<span class="sd">    Returns:</span>
<span class="sd">          The value for the nbnd parameter in QE nscf calculations</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">old_ID</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">oldFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">old_ID</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">oldFile</span><span class="p">):</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">oldFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfileObj</span><span class="p">:</span>
				<span class="n">outfile</span><span class="o">=</span><span class="n">outfileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


				<span class="n">match1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;number of electrons\s*=\s*([.0-9]*)&#39;</span><span class="p">,</span><span class="n">outfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">break</span>

	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="k">continue</span>

    <span class="k">if</span> <span class="n">mult</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
	    <span class="n">nbnd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.75</span><span class="o">*</span><span class="n">match1</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
	    <span class="n">nbnd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">match1</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s1">&#39;Number of bands to be Calculated: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">nbnd</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of bands to be Calculated </span><span class="si">%s</span><span class="s1">: &#39;</span><span class="o">%</span> <span class="n">nbnd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nbnd</span>


<div class="viewcode-block" id="doss"><a class="viewcode-back" href="../prep.html#prep.doss">[docs]</a><span class="k">def</span> <span class="nf">doss</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">kpFactor</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">n_conduction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	Wrapper function to write the functio n AFLOWpi.prep._oneDoss to the _ID.py</span>

<span class="sd">	Arguments:</span>
<span class="sd">	     calcs (dict): a dictionary of dicionaries representing the set of calculations </span>

<span class="sd">	Keyword Arguments:</span>
<span class="sd">	     kpFactor (float): the factor to which we make each direction in the kpoint grid denser</span>
<span class="sd">	      </span>
<span class="sd">	Returns:</span>
<span class="sd">	      The identical &quot;calcs&quot; input variable</span>

<span class="sd">	&#39;&#39;&#39;</span>

	<span class="n">loadModString</span> <span class="o">=</span> <span class="s1">&#39;AFLOWpi.prep._oneDoss(oneCalc,ID,kpFactor=</span><span class="si">%s</span><span class="s1">,n_conduction=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">kpFactor</span><span class="p">,</span><span class="n">n_conduction</span><span class="p">)</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>
	<span class="sd">&#39;&#39;&#39;get the fermi level from here&#39;&#39;&#39;</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;POSTPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="s1">&#39;AFLOWpi.retr._writeEfermi(oneCalc,ID)&#39;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">calcs</span></div>


<span class="kn">import</span> <span class="nn">math</span>
<span class="nd">@newstepWrapper</span><span class="p">(</span><span class="n">_check_lock</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_oneDoss</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">kpFactor</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">n_conduction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Converts an scf calculation to an nscf for calculating DOS.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          kpFactor (float): the factor to which we make each direction in the kpoint grid denser</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">          the one calculation dictionary object with oneCalc[&#39;_AFLOWPI_INPUT_&#39;] converted to a </span>
<span class="sd">	  DOS nscf calcuation.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _oneDoss&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">=</span><span class="n">oneCalc</span>

        <span class="n">f</span><span class="o">=</span><span class="n">ID</span>
	<span class="n">output_calcs</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
        

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="n">inputDict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
    <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;nscf&#39;&quot;</span>
    
    <span class="k">if</span> <span class="n">n_conduction</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
	    <span class="n">nbnd</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_num_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
	    <span class="n">nbnd</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_num_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">mult</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="n">n_conduction</span>

    <span class="k">try</span><span class="p">:</span>
	    <span class="sd">&#39;&#39;&#39;adds nbnd to input file&#39;&#39;&#39;</span>
	    <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;nbnd&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">nbnd</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">scfFileString</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
	<span class="n">mod</span> <span class="o">=</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
	<span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">()&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">mod</span><span class="o">==</span><span class="s1">&#39;GAMMA&#39;</span><span class="p">:</span>
		<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;2 2 2 0 0 0&#39;</span>
		<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{automatic}</span><span class="s1">&#39;</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">scfKPointString</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">k_points</span><span class="p">(</span><span class="n">scfFileString</span><span class="p">)</span>
		<span class="n">scfKPointSplit</span> <span class="o">=</span> <span class="n">scfKPointString</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
		<span class="n">scfKPointSplit</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scfKPointString</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
		<span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">):</span>
		    <span class="n">scfKPointSplit</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]</span><span class="o">*</span><span class="n">kpFactor</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
		<span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">)):</span>
		    <span class="n">scfKPointSplit</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0 &#39;</span>
		<span class="n">newKPointString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">)</span>

		<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newKPointString</span>
		<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{automatic}</span><span class="s1">&#39;</span>

        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>                    
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
	    
        <span class="n">a</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
        <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">output_calcs</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">output_calcs</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
        <span class="sd">&#39;&#39;&#39;set prev to current ID so we can check if we&#39;ve already done the transform&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output_calcs</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">output_calcs</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _oneDoss&#39;</span><span class="p">)</span>                                              
    <span class="k">return</span> <span class="n">output_calcs</span><span class="p">,</span><span class="n">ID</span>


<div class="viewcode-block" id="modifyInputPrefixPW"><a class="viewcode-back" href="../prep.html#prep.modifyInputPrefixPW">[docs]</a><span class="k">def</span> <span class="nf">modifyInputPrefixPW</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">pre</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Wrapper function that is used to write a function to the _ID.py</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>
	
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="s2">&quot;oneCalc,ID = AFLOWpi.prep._modifyInputPrefixPW(oneCalc,ID)&quot;</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">calcs</span></div>

<span class="kn">import</span> <span class="nn">__main__</span>

<span class="k">def</span> <span class="nf">_modifyInputPrefixPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Assigns the new prefix to a the calculation inputs in the form _ID</span>
<span class="sd">	</span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">	  ID (str): The ID string for the particular calculation and the value of the the</span>
<span class="sd">                  prefix without the leading &quot;_&quot; in front.</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">	  </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>

	    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
	    <span class="n">new_prefix</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span>
	    <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">new_prefix</span><span class="p">)</span>
	    <span class="n">inputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
	    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">inputString</span>
	    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_prefix</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
	    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newIn</span><span class="p">:</span>
		    <span class="n">newIn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
			
			
			
    
<div class="viewcode-block" id="modifyNamelistPW"><a class="viewcode-back" href="../prep.html#prep.modifyNamelistPW">[docs]</a><span class="k">def</span> <span class="nf">modifyNamelistPW</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">namelist</span><span class="p">,</span><span class="n">parameter</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Wrapper function that is used to write the function AFLOWpi.prep._modifyNameListPW </span>
<span class="sd">    to the _ID.py. If the value is intended to be a string in the QE input file, it must</span>
<span class="sd">    be dually quoted i.e. value=&quot;&#39;scf&#39;&quot; will become &#39;scf&#39; in the input file.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations </span>
<span class="sd">          namelist (str): a string of the fortran namelist that the parameter is in</span>
<span class="sd">          parameter (str): a string of the parameter name</span>
<span class="sd">          value: the value of that parameter </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          runlocal (bool): a flag to choose whether or not to run the wrapped function now</span>
<span class="sd">	                or write it to the _ID.py to run during the workflow.</span>

<span class="sd">    Returns:</span>
<span class="sd">          Either the identical set of calculations if runlocal == False or the set of</span>
<span class="sd">          calculations with the parameter&#39;s value changed in their oneCalc[&#39;_AFLOWPI_INPUT_&#39;]</span>
<span class="sd">          if runlocal==True</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">value</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
	    <span class="n">del_value</span><span class="o">=</span><span class="kc">True</span>
	    <span class="k">if</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
		    <span class="k">try</span><span class="p">:</span>
			    <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
		    <span class="k">except</span><span class="p">:</span>
			    <span class="k">pass</span>
	    
	    <span class="n">del_value</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
	    <span class="n">del_value</span><span class="o">=</span><span class="kc">True</span>



    <span class="k">if</span> <span class="n">runlocal</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
	    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		    <span class="n">temp</span><span class="p">,</span><span class="n">temp_ID</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">namelist</span><span class="p">,</span><span class="n">parameter</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">del_value</span><span class="o">=</span><span class="n">del_value</span><span class="p">)</span>
		    <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span><span class="n">temp</span>

    <span class="k">else</span><span class="p">:</span>
	    <span class="n">addit</span><span class="o">=</span><span class="s2">&quot;oneCalc,ID = AFLOWpi.prep._modifyNamelistPW(oneCalc,ID,&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;&#39;&#39;</span><span class="si">%s</span><span class="s2">&#39;&#39;&#39;,del_value=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span><span class="n">parameter</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">del_value</span><span class="p">)</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">addit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calcs</span></div>


<span class="k">def</span> <span class="nf">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">namelist</span><span class="p">,</span><span class="n">parameter</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">del_value</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Wrapper function that is used to write the function AFLOWpi.prep._modifyNameListPW </span>
<span class="sd">    to the _ID.py. If the value is intended to be a string in the QE input file, it must</span>
<span class="sd">    be dually quoted i.e. value=&quot;&#39;scf&#39;&quot; will become &#39;scf&#39; in the input file. If the value</span>
<span class="sd">    is equal to None (without quotes) it will remove that parameter from the namelist.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>
<span class="sd">          namelist (str): a string of the fortran namelist that the parameter is in</span>
<span class="sd">          parameter (str): a string of the parameter name</span>
<span class="sd">          value: the value of that parameter </span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc object representing the calculation but with the paramater&#39;s value</span>
<span class="sd">          changed or added in oneCalc[&#39;_AFLOWPI_INPUT_&#39;] and the same ID as the input to </span>
<span class="sd">	  the function.</span>
<span class="sd">          </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">del_value</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">del</span> <span class="n">inputDict</span><span class="p">[</span><span class="n">namelist</span><span class="p">][</span><span class="n">parameter</span><span class="p">]</span>
	        <span class="k">except</span><span class="p">:</span>
			<span class="k">pass</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">inputDict</span><span class="p">[</span><span class="n">namelist</span><span class="p">][</span><span class="n">parameter</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
	 
        <span class="n">inputString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">inputString</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newIn</span><span class="p">:</span>
            <span class="n">newIn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;namelist </span><span class="si">%s</span><span class="s1"> and/or parameter </span><span class="si">%s</span><span class="s1"> do not exist in input file.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namelist</span><span class="p">,</span><span class="n">parameter</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>



<div class="viewcode-block" id="lockAtomMovement"><a class="viewcode-back" href="../prep.html#prep.lockAtomMovement">[docs]</a><span class="k">def</span> <span class="nf">lockAtomMovement</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Wrapper function that writes the function AFLOWpi.prep._freezeAtoms to the _ID.py</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;oneCalc = AFLOWpi.prep._freezeAtoms(oneCalc,ID) &#39;&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="unlockAtomMovement"><a class="viewcode-back" href="../prep.html#prep.unlockAtomMovement">[docs]</a><span class="k">def</span> <span class="nf">unlockAtomMovement</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Wrapper function that writes the function AFLOWpi.prep._unfreezeAtoms to the _ID.py</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;oneCalc = AFLOWpi.prep._unfreezeAtoms(oneCalc,ID)&#39;&#39;&#39;</span><span class="p">)</span></div>
            
            

<span class="k">def</span> <span class="nf">_freezeAtoms</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Modifies a QE input file to have all the atom movement flags in the ATOMIC_POSITIONS </span>
<span class="sd">    card be set to 0 which means they cannot move during a ionic or variable cell relax</span>
<span class="sd">    calculation.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>


<span class="sd">    Returns:</span>
<span class="sd">          oneCalc object representing the calculation but with the flags for atom</span>
<span class="sd">	  movement all set to 0.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    <span class="n">atomPos</span> <span class="o">=</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
    <span class="n">positions</span><span class="p">,</span><span class="n">flags</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">atomPos</span><span class="p">)</span>
    <span class="n">flagArray</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))):</span>
        <span class="n">flagArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; 0 0 0&#39;</span><span class="p">)</span>

    <span class="n">frozenFlags</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flagArray</span><span class="p">)</span>

    <span class="n">newPosString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">attachPosFlags</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">frozenFlags</span><span class="p">)</span>
    <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newPosString</span>

    <span class="n">newInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newInput</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFile</span><span class="p">:</span>
        <span class="n">inputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newInput</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">oneCalc</span>

<span class="k">def</span> <span class="nf">_unfreezeAtoms</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Modifies a QE input file to have all the atom movement flags in the ATOMIC_POSITIONS </span>
<span class="sd">    card be set to 1 which means they are allowed to move during a ionic or variable cell</span>
<span class="sd">    relax calculation which is default in QE.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>


<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): object representing the calculation but with the flags for atom</span>
<span class="sd">	  movement all set to 1.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    <span class="n">atomPos</span> <span class="o">=</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
    <span class="n">positions</span><span class="p">,</span><span class="n">flags</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">atomPos</span><span class="p">)</span>
    <span class="n">flagArray</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))):</span>
        <span class="n">flagArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; 1 1 1&#39;</span><span class="p">)</span>

    <span class="n">frozenFlags</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flagArray</span><span class="p">)</span>

    <span class="n">newPosString</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">attachPosFlags</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">frozenFlags</span><span class="p">)</span>
    <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newPosString</span>

    <span class="n">newInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newInput</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFile</span><span class="p">:</span>
        <span class="n">inputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newInput</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">oneCalc</span>




<div class="viewcode-block" id="changeCalcs"><a class="viewcode-back" href="../prep.html#prep.changeCalcs">[docs]</a><span class="k">def</span> <span class="nf">changeCalcs</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Wrapper function that writes the function AFLOWpi.prep._changeCalcs to the _ID.py</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  keyword (str): a string which signifies the type of change that is to be made</span>
<span class="sd">	  value: the value of the choice.</span>

<span class="sd">    Returns:</span>
<span class="sd">          The identical set of calculations as the input to this function</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">loadModString</span> <span class="o">=</span> <span class="s2">&quot;oneCalc,ID = AFLOWpi.prep._oneChangeCalcs(oneCalc,ID,keyword=&#39;</span><span class="si">%s</span><span class="s2">&#39;,value=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calcs</span></div>


<div class="viewcode-block" id="updateStructs"><a class="viewcode-back" href="../prep.html#prep.updateStructs">[docs]</a><span class="k">def</span> <span class="nf">updateStructs</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Wrapper function that writes the function AFLOWpi.prep._oneUpdateStructs to the _ID.py</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): a dictionary of dicionaries representing the set of calculations</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  update_structure (bool): if True update the cell parameter if possible from the</span>
<span class="sd">	                        output of previous calculations in the workflow.</span>
<span class="sd">	  update_positions (bool): if True update the atomic positions if possible from the</span>
<span class="sd">	                        output of previous calculations in the workflow.</span>

<span class="sd">    Returns:</span>
<span class="sd">          The identical set of calculations as the input to this function</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">loadModString</span> <span class="o">=</span><span class="s2">&quot;oneCalc,ID = AFLOWpi.prep._oneUpdateStructs(oneCalc,ID,update_structure=</span><span class="si">%s</span><span class="s2">,update_positions=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">update_structure</span><span class="p">,</span><span class="n">update_positions</span><span class="p">)</span>

    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="n">addition</span><span class="o">=</span><span class="n">loadModString</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calcs</span></div>




<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>    
<span class="nd">@newstepWrapper</span><span class="p">(</span><span class="n">_check_lock</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_oneUpdateStructs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">update_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">override_lock</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Attempts to read output files from previous steps in the workflow and update the input file of</span>
<span class="sd">    the current step with updated cell parameters and/or atomic positions that were calculated in</span>
<span class="sd">    previous steps. </span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  update_structure (bool): if True update the cell parameter if possible from the</span>
<span class="sd">	                        output of previous calculations in the workflow.</span>
<span class="sd">	  update_positions (bool): if True update the atomic positions if possible from the</span>
<span class="sd">	                        output of previous calculations in the workflow.</span>

<span class="sd">	  </span>
<span class="sd">	  override_lock (bool): &lt;DEFUNCT OPTION: CONSIDER FOR REMOVAL&gt;</span>
<span class="sd">	                         override the _check_lock function wrapped around _oneUpdateStructs</span>

<span class="sd">    Returns:</span>
<span class="sd">          calculations with their cell parameters and/or atomic positions updated from the last </span>
<span class="sd">	  variable cell or ionic relaxation calculation. If there is none previously then the</span>
<span class="sd">	  parameters and position remain the same.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _oneUpdateStructs&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">=</span><span class="n">oneCalc</span>
        <span class="n">f</span><span class="o">=</span><span class="n">ID</span>
        <span class="n">output_calcs</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
        <span class="n">inputDict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prevOut</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]):</span>
            <span class="n">oldFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">prevOut</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">oldFile</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">outputfile</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">oldFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">cellParaRE</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="s1">&#39;regex&#39;</span><span class="p">)</span>
                <span class="n">cellPara</span> <span class="o">=</span> <span class="n">cellParaRE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outputfile</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellPara</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cellPara</span><span class="o">=</span><span class="n">cellPara</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1">#Get alat</span>
                    <span class="n">alatRE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;alat=\s*(\d+.\d+)&#39;</span><span class="p">)</span>
                    <span class="n">alatSearch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(?:CELL_PARAMETERS)\s*.*alat[\D]*([0-9.]*)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
                    <span class="n">alatFind</span> <span class="o">=</span> <span class="n">alatSearch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outputfile</span><span class="p">)</span>
		    <span class="k">try</span><span class="p">:</span>
			    <span class="n">alat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">alatFind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		    <span class="k">except</span><span class="p">:</span>
			    <span class="n">alat</span><span class="o">=</span><span class="mf">1.0</span>
                    <span class="c1">#Get ibrav</span>
                    <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ibrav</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ibrav&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">ibrav</span><span class="o">=</span><span class="mi">0</span>
                    <span class="c1">#Make cell parameter matrix</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">splitPara</span> <span class="o">=</span> <span class="n">cellPara</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitPara</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span>

		    <span class="k">if</span> <span class="s1">&#39;CELL_PARAMETERS&#39;</span> <span class="ow">in</span> <span class="n">splitInput</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			    <span class="k">if</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
				    <span class="n">alat</span><span class="o">=</span><span class="mf">1.0</span>

		    <span class="n">cellParaMatrix</span> <span class="o">=</span> <span class="n">alat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

                    <span class="c1">#Update cell dimensions according to ibrav and alat</span>
                    <span class="n">ibravDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_free2celldm</span><span class="p">(</span><span class="n">cellParaMatrix</span><span class="p">,</span><span class="n">ibrav</span><span class="o">=</span><span class="n">ibrav</span><span class="p">)</span>                    
                    <span class="n">ibravDict</span><span class="p">[</span><span class="s1">&#39;ibrav&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ibrav</span>

                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">prevOut</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]):</span>
            <span class="n">oldFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">prevOut</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">oldFile</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">outputfile</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">oldFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atmPos</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">atomic_positions</span><span class="p">(</span><span class="n">outputfile</span><span class="p">)</span>


                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atmPos</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>   
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_structure</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
		    <span class="k">if</span> <span class="s1">&#39;CELL_PARAMETERS&#39;</span> <span class="ow">in</span> <span class="n">splitInput</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			    <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_cellMatrixToString</span><span class="p">(</span><span class="n">cellParaMatrix</span><span class="p">)</span>
		    <span class="k">else</span><span class="p">:</span>
			    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ibravDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>	
				    <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_positions</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atmPos</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">atom_pos_input</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
                    <span class="n">fakeFlags</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">atom_pos_input</span><span class="p">)</span>
                    <span class="n">atmPos</span><span class="p">,</span><span class="n">outputflags</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">atmPos</span><span class="p">)</span>
                    <span class="n">atmPos</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">attachPosFlags</span><span class="p">(</span><span class="n">atmPos</span><span class="p">,</span><span class="n">flags</span><span class="p">)</span>
                    <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">atmPos</span>        
                    <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{crystal}</span><span class="s1">&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Update CELL_PARAMETERS and ATOMIC_POSITIONS from vc-relax or relax output&#39;&#39;&#39;</span>
        <span class="n">output_calcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">output_calcs</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _oneUpdateStructs&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;written funny because output needs to be oneCalc,ID&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newIn</span><span class="p">:</span>
		    <span class="n">newIn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_calcs</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_calcs</span><span class="p">,</span><span class="n">ID</span>


<span class="nd">@newstepWrapper</span><span class="p">(</span><span class="n">_check_lock</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_oneChangeCalcs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ############</span>
<span class="sd">    ##OBSOLETE##</span>
<span class="sd">    ############</span>
<span class="sd">    Changes a PWSCF calculation&#39;s input depending on the option chosen for input variable </span>
<span class="sd">    &quot;keyword&quot;. </span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          keyword (str): the type of change that is to be made to the input file. </span>
<span class="sd">	              Options: &quot;calculation&quot;,&quot;ecutwfc&quot;,&quot;pseudos&quot;,&quot;kpoints&quot;</span>

<span class="sd">	  value: the value of the choice.</span>
<span class="sd">	             Options with possible values:</span>

<span class="sd">      	             &quot;calculation&quot; | &#39;scf&#39;,&#39;vc-relax&#39; or &#39;relax&#39;</span>
<span class="sd">		     &quot;ecutwfc&quot;     | integer value</span>
<span class="sd">		     &quot;pseudos&quot;     | a string of a local directory containing PP files</span>
<span class="sd">		     &quot;kpoints&quot;     | a string containing some kind of list of k points</span>

<span class="sd">		      </span>
<span class="sd">		    </span>
<span class="sd">    Returns:</span>
<span class="sd">          returns oneCalc with oneCalc[&#39;_AFLOWPI_INPUT_&#39;] modified in some way depending on </span>
<span class="sd">	  the option chosen for &quot;keyword&quot; and the ID label for calculation at that step</span>
<span class="sd">	  in the workflow.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        have to keep the index for tracking purposes between _&lt;ID&gt;.py scripts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _oneChangeCalcs&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">=</span><span class="n">oneCalc</span>
	<span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">f</span><span class="o">=</span><span class="n">ID</span>



        <span class="n">output_calcs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
        <span class="n">oldFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">oldFile</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TEMP FILE DOES NOT EXIST FOR _oneChangeCalcs...EXITING&#39;</span><span class="p">)</span>


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>

	<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">value</span><span class="p">))</span>
	<span class="nb">print</span> <span class="s2">&quot;Updating </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;calculation&#39;</span><span class="p">:</span>
	        <span class="sd">&#39;&#39;&#39;we need to change calculation to vc-relax&#39;&#39;&#39;</span>
	        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>

		<span class="c1">#Change calculation type</span>
                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
                <span class="n">inputDict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>                    
                <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
                <span class="n">inputfile</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>


	<span class="k">elif</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;kpoints&#39;</span><span class="p">:</span>
		<span class="n">replaceKpts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;K_POINTS.*?\n(\d+\s\d+\s\d+)&quot;</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
                <span class="c1">#Change kpoint grid</span>
                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">replaceKpts</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;K_POINTS </span><span class="si">{automatic}</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">value</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>

	<span class="k">elif</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;ecutwfc&#39;</span><span class="p">:</span>
		<span class="n">replaceRegEx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;ecutwfc\s*?=.*?\n&quot;</span><span class="p">)</span>
                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
                <span class="c1">#Change energy cutoff</span>
                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">replaceRegEx</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;ecutwfc = </span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">value</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">r&quot;ecutrho&quot;</span><span class="p">,</span><span class="n">inputfile</span><span class="p">):</span>
			<span class="n">replaceRegEx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;ecutrho\s*?=.*?\n&quot;</span><span class="p">)</span>
			<span class="c1">#Change density cutoff</span>
			<span class="n">inputfile</span> <span class="o">=</span> <span class="n">replaceRegEx</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;ecutrho = </span><span class="si">%f</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="mf">4.0</span><span class="p">),</span><span class="n">inputfile</span><span class="p">)</span>

	<span class="k">elif</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;pseudos&#39;</span><span class="p">:</span>
		<span class="n">inputfile</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
		<span class="n">new_pseudodir</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        	        <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">r&#39;_AFLOWPI_[A-Z][0-9]*_&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                                <span class="n">speciesRe</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>

                                <span class="n">vp</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getPseudofilename</span><span class="p">(</span><span class="n">speciesRe</span><span class="p">,</span><span class="n">new_pseudodir</span><span class="p">)</span>

                                <span class="k">try</span><span class="p">:</span>
                                        <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_pseudodir</span><span class="p">,</span><span class="n">vp</span><span class="p">)</span>
                                	<span class="n">b</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">vp</span><span class="p">)</span>
                                	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
	                                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cannot find pseudopotential files in </span><span class="si">%s</span><span class="s1"> ...Exiting&#39;</span> <span class="o">%</span> <span class="n">new_pseudodir</span><span class="p">)</span>
                                        <span class="nb">print</span> <span class="s1">&#39;cannot find correct PAO files in </span><span class="si">%s</span><span class="s1"> ...Exiting&#39;</span> <span class="o">%</span> <span class="n">new_pseudodir</span>
                                        <span class="k">raise</span> <span class="ne">SystemExit</span>
                          
                                <span class="c1">#Replace PP name in inputfile                 </span>
                                <span class="n">ppLineRE</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.*\s+\S*\.UPF&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">)</span> <span class="c1"># v is element symbol</span>
                                <span class="n">ppLine</span> <span class="o">=</span> <span class="n">ppLineRE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                                <span class="n">replacePpRE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\S*\.UPF&quot;</span><span class="p">)</span>
                                <span class="n">replacePp</span> <span class="o">=</span> <span class="n">replacePpRE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="n">ppLine</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">ppLineRE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">replacePp</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>

	<span class="k">else</span><span class="p">:</span>
		<span class="n">replaceRegEx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;</span><span class="si">%s</span><span class="s2">\s*?=.*?\n&quot;</span><span class="o">%</span><span class="n">keyword</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
                <span class="c1">#Change value of keyword</span>
                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">replaceRegEx</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">value</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">e</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="n">calc_label</span> <span class="o">=</span> <span class="n">ID</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">calc_label</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
	
        <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">output_calcs</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">output_calcs</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
        <span class="sd">&#39;&#39;&#39;set prev to current ID so that we can check if we have already transformed&#39;&#39;&#39;</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _oneChangeCalcs&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_calcs</span><span class="p">,</span><span class="n">calc_label</span>




<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">## MISC</span>
<span class="c1">#####################################################################################################################</span>
<span class="c1">#####################################################################################################################</span>


<div class="viewcode-block" id="varyCellParams"><a class="viewcode-back" href="../prep.html#prep.varyCellParams">[docs]</a><span class="k">def</span> <span class="nf">varyCellParams</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="p">(),</span><span class="n">amount</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span><span class="n">steps</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Forms and returns a set of calcs with varied cell params must be in A,B,C, </span>
<span class="sd">    and, in degrees,alpha,beta,gamma and then returns it.</span>


<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>


<span class="sd">    Keyword Arguments:</span>
<span class="sd">          param (tuple): the params assoc. with the amount and step. i.e. (&#39;celldm(1)&#39;,&#39;celldm(3))</span>
<span class="sd">          amount (float): percentage amount to be varied up and down. i.e (0.04,0.02,0.01)</span>
<span class="sd">          steps  (int): how many steps to within each range. i.e (4,5,7) </span>
<span class="sd">          constraint (list): a list or tuple containing two entry long list or tuples with</span>
<span class="sd">  	                  the first being the constraint type and the second the free </span>
<span class="sd">			  parameter in params that its constraining for example in a </span>
<span class="sd">			  orthorhombic cell: constraint=([&quot;volume&quot;,&#39;c&#39;],) allows for A and B</span>
<span class="sd">			  to move freely but C is such that it keeps the cell volume the same</span>
<span class="sd">			  in all calculations generated by the input oneCalc calculation.</span>

<span class="sd">    Returns:</span>
<span class="sd">          A dictionary of dictionaries representing a new calculation set</span>
<span class="sd">			  			  </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">oneCalc</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>

    <span class="n">constraint_type_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">constraint_var_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="n">constraint</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;if the length of the first entry in constraints isn&#39;t a   &#39;&#39;&#39;</span>
            <span class="sd">&#39;&#39;&#39;[constraint,parameter] combination then put it in an array&#39;&#39;&#39;</span>            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">constraint</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">constraint</span><span class="p">),]</span>

            <span class="k">for</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
                <span class="n">constraint_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">constraint_var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">e</span>
            <span class="n">constraint_type</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">constraint_var</span> <span class="o">=</span><span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">constraint_type</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">constraint_var</span> <span class="o">=</span><span class="kc">None</span>


    <span class="n">inputList</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    <span class="n">paramDict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">param</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">param</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">namelist</span><span class="p">,</span><span class="n">paramlist</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="n">namelist</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">r&#39;celldm.*&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="n">paramDict</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">r&#39;ibrav.*&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="n">paramDict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;cosine&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;degrees&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">abcList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
    <span class="n">abcDict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">abcRes</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">celldm2abc</span><span class="p">(</span><span class="o">**</span><span class="n">paramDict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abcRes</span><span class="p">)):</span>
        <span class="n">abcDict</span><span class="p">[</span><span class="n">abcList</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">=</span><span class="n">abcRes</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    
    <span class="n">ibrav</span><span class="o">=</span><span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;ibrav&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">changeList</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">changeList</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">7</span> <span class="ow">or</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">changeList</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">8</span> <span class="ow">or</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">9</span> <span class="ow">or</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">10</span> <span class="ow">or</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">11</span><span class="p">:</span>
        <span class="n">changeList</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">12</span> <span class="ow">or</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">13</span><span class="p">:</span>
        <span class="n">changeList</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ibrav</span><span class="o">==</span><span class="mi">14</span><span class="p">:</span>
        <span class="n">changeList</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>


    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">numCalc</span><span class="o">=</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>    
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">changeList</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">constraint</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">numCalc</span><span class="o">&gt;</span><span class="mi">1000</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;number of unconstrained variable=</span><span class="si">%s</span><span class="s1">. number of calcs to be generated=</span><span class="si">%s</span><span class="s1">. This exceeds the limit set at 1000 in AFLOWpi. If you would like to ignore the limit you can modify numCalc variable in AFLOWpi.prep.varyCellParams.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">changeList</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">constraint</span><span class="p">),</span><span class="n">numCalc</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">newDict</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">abcDict</span><span class="p">)</span>
        <span class="n">newDict</span><span class="p">[</span><span class="s1">&#39;ibrav&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ibrav</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">abcVol</span><span class="p">(</span><span class="o">**</span><span class="n">newDict</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">ibrav</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>
		<span class="n">vol</span><span class="o">*=</span><span class="mi">3</span>
	<span class="k">if</span> <span class="n">ibrav</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">]:</span>
		<span class="n">vol</span><span class="o">*=</span><span class="mi">2</span>
	<span class="k">if</span> <span class="n">ibrav</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">]:</span>
		<span class="n">vol</span><span class="o">*=</span><span class="mi">4</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">productList</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="ow">in</span> <span class="n">changeList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constraint_var_list</span><span class="p">:</span>

                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">abcDict</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">amount</span><span class="p">[</span><span class="n">item</span><span class="p">]),</span><span class="n">abcDict</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">amount</span><span class="p">[</span><span class="n">item</span><span class="p">]),</span><span class="n">steps</span><span class="p">[</span><span class="n">item</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="n">modifierList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">productList</span><span class="p">))</span>
    <span class="n">param</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">changeList</span><span class="p">]</span>


    <span class="n">modifierDictList</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">tempDict</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">({</span><span class="s1">&#39;ibrav&#39;</span><span class="p">:</span><span class="n">ibrav</span><span class="p">})</span>
    


    <span class="n">tempCelldmDict</span><span class="o">=</span><span class="p">{}</span>   
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">modifierList</span><span class="p">:</span>
        <span class="n">counter</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>


            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constraint_var_list</span><span class="p">:</span>
                <span class="n">tempDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
                <span class="n">counter</span><span class="o">+=</span><span class="mi">1</span>



        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraint_type_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">some_param</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">some_param</span><span class="p">]</span> <span class="ow">in</span> <span class="n">constraint_var_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">constraint_type_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
			    <span class="n">tempDict</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">some_param</span><span class="p">]]</span><span class="o">=</span><span class="n">newDict</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">some_param</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraint_type_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">some_param</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">some_param</span><span class="p">]</span> <span class="ow">in</span> <span class="n">constraint_var_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">constraint_type_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;volume&#39;</span><span class="p">:</span>
                        <span class="n">volDiv</span><span class="o">=</span><span class="mi">1</span>
                        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">tempDict</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="k">if</span> <span class="n">parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constraint_var_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span><span class="s1">&#39;gamma&#39;</span><span class="p">]:</span>
                                    <span class="n">volDiv</span><span class="o">*=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">value</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]:</span>
                                    <span class="n">volDiv</span><span class="o">*=</span><span class="n">value</span>


                        <span class="n">remaining</span> <span class="o">=</span> <span class="n">vol</span><span class="o">/</span><span class="n">volDiv</span>
                        
                        <span class="k">if</span> <span class="n">constraint_var_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span><span class="s1">&#39;gamma&#39;</span><span class="p">]:</span>
                            <span class="n">remaining</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>

                        <span class="n">tempDict</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">some_param</span><span class="p">]]</span><span class="o">=</span><span class="n">remaining</span>

        <span class="n">tempCelldmTuple</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">abc2celldm</span><span class="p">(</span><span class="o">**</span><span class="n">tempDict</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tempCelldmTuple</span><span class="p">)):</span>
            <span class="n">tempCelldmDict</span><span class="p">[</span><span class="s1">&#39;celldm(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">=</span><span class="n">tempCelldmTuple</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>


        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tempCelldmDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">tempCelldmDict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">inputList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">))</span>


    <span class="k">return</span> <span class="n">inputList</span></div>


        
<span class="k">def</span> <span class="nf">_incrementFileValue</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;uValue&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ##########################</span>
<span class="sd">    ###NEEDS GENERALIZATION###</span>
<span class="sd">    ##########################</span>
<span class="sd">    adds +1 to the value of a variable defined in the _ID.py files</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          varName (str): a string of the name of the variable that is to be incremented</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>    
    <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">fileName</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
            <span class="n">inputFileText</span> <span class="o">=</span> <span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="n">URegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;uValue = (.+)&#39;</span><span class="p">)</span>
            <span class="n">uValue</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">URegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">inputFileText</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">uValue</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">uValueString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uValue</span><span class="p">)</span>
            <span class="n">URegex2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;uValue = .+&#39;</span><span class="p">)</span>
            <span class="n">newinputfile</span> <span class="o">=</span> <span class="n">URegex2</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;uValue = &#39;</span> <span class="o">+</span> <span class="n">uValueString</span><span class="p">,</span><span class="n">inputFileText</span><span class="p">)</span>
        

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfileObj</span><span class="p">:</span>
            <span class="n">outfileObj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newinputfile</span><span class="p">)</span>
        

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">_modifyVarVal</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;uValue&#39;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Modifies the value of a variable defined in the _ID.py files</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          varName (str): a string of the name of the variable that is to be changed</span>
<span class="sd">	  value: the value to change it to in the _ID.py</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>    

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _modifyVarVal&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>    
    <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">fileName</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
            <span class="n">inputFileText</span> <span class="o">=</span> <span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


        <span class="n">URegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;</span><span class="si">%s</span><span class="s1"> = (.+)&#39;</span> <span class="o">%</span> <span class="n">varName</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">uValueString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">uValueString</span> <span class="o">=</span> <span class="n">value</span>
            
        <span class="n">URegex2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;</span><span class="si">%s</span><span class="s1">\s*=\s*.+&#39;</span> <span class="o">%</span> <span class="n">varName</span><span class="p">)</span>
        <span class="n">newinputfile</span> <span class="o">=</span> <span class="n">URegex2</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varName</span><span class="p">,</span><span class="n">uValueString</span><span class="p">),</span><span class="n">inputFileText</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfileObj</span><span class="p">:</span>
            <span class="n">outfileObj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newinputfile</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _modifyVarVal&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_write_scratch_meta_data_file</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Not used. Delete possibly</span>

<span class="sd">    &#39;&#39;&#39;</span>	
    <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_get_tempdir</span><span class="p">()</span>
    <span class="n">file_list</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">info_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">file_path_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>

	    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
		<span class="n">file_path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">file_name</span><span class="p">))</span>



    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_path_list</span><span class="p">:</span>
	    <span class="n">mode</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">nlink</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">ctime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
	    <span class="n">info_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">file_name</span><span class="p">,</span><span class="n">mode</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">nlink</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">ctime</span><span class="p">]])</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_local_scratch_meta_data.temp&#39;</span><span class="p">),</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_file</span><span class="p">:</span>
	    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">info_list</span><span class="p">:</span>
		    <span class="n">write_string</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
		    <span class="n">meta_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_string</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_check_restart</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Not used. Delete possibly</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
	
	<span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="askAFLOWpiVars"><a class="viewcode-back" href="../prep.html#prep.askAFLOWpiVars">[docs]</a><span class="k">def</span> <span class="nf">askAFLOWpiVars</span><span class="p">(</span><span class="n">refAFLOWpiVars</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Cycle on the keys of the refAFLOWpiVars dictionary and ask to define them</span>

<span class="sd">	Arguments:</span>
<span class="sd">	      refAFLOWpiVars (dict): the variables in the ref files that you need to input to run the calculation</span>

<span class="sd">	Returns:</span>
<span class="sd">	      None</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">refAFLOWpiVars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">a</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;define &#39;</span><span class="o">+</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
				<span class="n">refAFLOWpiVars</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">a</span><span class="p">})</span>	
				<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">:</span> 
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;Must be a tuple&quot;</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">pass</span></div>

                        


<span class="k">def</span> <span class="nf">_passGlobalVar</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ############</span>
<span class="sd">    ##OBSOLETE##</span>
<span class="sd">    ############</span>
<span class="sd">    Used to define the value of a global variable in this module&#39;s global namesapce </span>
<span class="sd">    usually from another module.</span>
<span class="sd">	</span>
<span class="sd">    Arguments:</span>
<span class="sd">          varname (str): name of the global variable</span>
<span class="sd">	  value: value of the global variable</span>
<span class="sd">       </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">globals</span><span class="p">()[</span><span class="n">varname</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>


<span class="kn">import</span> <span class="nn">string</span>
<span class="k">def</span> <span class="nf">_forceSubmitNodeIP</span><span class="p">(</span><span class="n">nodeName</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ############</span>
<span class="sd">    ##OBSOLETE##</span>
<span class="sd">    ############</span>
<span class="sd">    Creates the global variable __submitNodeName__ and gives it the value of nodeName</span>


<span class="sd">    Arguments:</span>
<span class="sd">          nodeName (str): a string containing the name of the submit node</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">global</span> <span class="n">__submitNodeName__</span>
    <span class="n">__submitNodeName__</span> <span class="o">=</span> <span class="n">nodeName</span>


<span class="k">def</span> <span class="nf">_announcePrint</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A debugging tool used to accentuate a string os it can be easily picked out from stdout</span>

<span class="sd">    Arguments:</span>
<span class="sd">          string (str): a string</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s1">&#39;#####################################################################################&#39;</span>
    <span class="nb">print</span> <span class="n">string</span>
    <span class="nb">print</span> <span class="s1">&#39;#####################################################################################&#39;</span>



<div class="viewcode-block" id="generateAnotherCalc"><a class="viewcode-back" href="../prep.html#prep.generateAnotherCalc">[docs]</a><span class="k">def</span> <span class="nf">generateAnotherCalc</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ############</span>
<span class="sd">    ##OBSOLETE##</span>
<span class="sd">    ############</span>
<span class="sd">    Modify the calculation in each subdir and update the master dictionary</span>

<span class="sd">    Arguments:</span>
<span class="sd">          old (str): string to replace</span>
<span class="sd">          new (str): replacement string</span>
<span class="sd">          calcs (dict): dictionary of dictionaries of calculations</span>

<span class="sd">    Returns:</span>
<span class="sd">          A new set of calculations with a new ID of the hash of the new input strings</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_calcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
    <span class="n">output_calcs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">new_calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">subdir</span> <span class="o">=</span> <span class="n">new_calcs</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
		<span class="n">inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
		<span class="n">inputfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>
		<span class="n">calc_label</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_hash64String</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

		<span class="n">a</span> <span class="o">=</span> <span class="n">calc_label</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
		<span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
		<span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
		<span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

		<span class="n">output_calcs</span><span class="p">[</span><span class="n">calc_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_calcs</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
		<span class="n">output_calcs</span><span class="p">[</span><span class="n">calc_label</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
			
	<span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">new_calcs</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">output_calcs</span></div>

<span class="c1">####################################################################################################################</span>

<div class="viewcode-block" id="modifyCalcs"><a class="viewcode-back" href="../prep.html#prep.modifyCalcs">[docs]</a><span class="k">def</span> <span class="nf">modifyCalcs</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">calcs</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	############</span>
<span class="sd">	##OBSOLETE##</span>
<span class="sd">	############</span>
<span class="sd">	Modify the calculation in each subdir and update the master dictionary</span>
<span class="sd">	</span>
<span class="sd">	Arguments:</span>
<span class="sd">	 old   (str) : string to replace</span>
<span class="sd">	 new   (str) : replacement string</span>
<span class="sd">	 calcs (dict): dictionary of dictionaries of calculations</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">new_calcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
	<span class="n">output_calcs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
	
	<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">new_calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">subdir</span> <span class="o">=</span> <span class="n">new_calcs</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
			<span class="n">inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="n">inputfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>
			<span class="n">calc_label</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_hash64String</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
			
			<span class="n">a</span> <span class="o">=</span> <span class="n">calc_label</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
			<span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
			<span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
			<span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

			<span class="n">output_calcs</span><span class="p">[</span><span class="n">calc_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_calcs</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
			<span class="n">output_calcs</span><span class="p">[</span><span class="n">calc_label</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>

		<span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">new_calcs</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>

	<span class="k">return</span> <span class="n">output_calcs</span></div>

<span class="c1">#####################################################################################################################</span>



<span class="kn">import</span> <span class="nn">atexit</span>

<div class="viewcode-block" id="line_prepender"><a class="viewcode-back" href="../prep.html#prep.line_prepender">[docs]</a><span class="k">def</span> <span class="nf">line_prepender</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">new_text</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    prepends a file with a new line containing the contents of the string new_text.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          filename (str): string of the filename that is to be prepended</span>
<span class="sd">	  new_text (str): a string that is one line long to be prepended to the file</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">content</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>
<span class="c1">############################################################################################################</span>



<span class="c1">############################################################################################################</span>


<span class="k">def</span> <span class="nf">_findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Looks for a string via a regular expression inside one of the command blocks in the _ID.py.</span>
<span class="sd">    Used to check before writing something as to avoid unintentionally having it written it twice.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): a dictionary containing properties about the AFLOWpi calculation</span>
<span class="sd">          ID (str): ID string for the particular calculation and step</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          block (str): a string of the name of the command block in the _ID.py to look in.</span>
<span class="sd">	  string (str): the string to search for which can be in plain text or as a regex.</span>

<span class="sd">    Returns:</span>
<span class="sd">          True if the regex finds the pattern or False if it does not</span>
<span class="sd">          </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>    
    <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">fileName</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
            <span class="n">inputFileText</span> <span class="o">=</span> <span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">isolatedString</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%s</span><span class="s1">_BLOCK&#39;</span> <span class="o">%</span> <span class="n">block</span><span class="p">,</span><span class="n">inputFileText</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">isolatedString</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#END_</span><span class="si">%s</span><span class="s1">_BLOCK&#39;</span> <span class="o">%</span> <span class="n">block</span><span class="p">,</span><span class="n">inputFileText</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">isolatedString</span><span class="o">=</span><span class="n">inptFileText</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="n">isolatedString</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span>    
    
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_calcsFromCalcList</span><span class="p">(</span><span class="n">calcList</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ############</span>
<span class="sd">    ##OBSOLETE##</span>
<span class="sd">    ############</span>
<span class="sd">    Takes a list of dictionaries representing a calculation and turns the</span>
<span class="sd">    list of dictionaries into a dictionary of dictionaries</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcList (list): a list of dictionaries</span>

<span class="sd">    Returns:</span>
<span class="sd">          A dictionary of dictionaries</span>
<span class="sd">   </span>
<span class="sd">    &#39;&#39;&#39;</span>
 
    <span class="n">largeSet</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">calcs</span> <span class="ow">in</span> <span class="n">calcList</span><span class="p">:</span>
        <span class="n">calcCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
        <span class="n">largeSet</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">largeSet</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">calcs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">largeSet</span>


<span class="c1">####################################################################################################################</span>
<span class="c1">###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ####</span>
<span class="c1">####################################################################################################################</span>



<span class="c1"># def useFunc(calcs,func=None,args=(),kwargs={},newStep=False):</span>
    
<span class="c1">#     sm=[]</span>
<span class="c1">#     badList=[&#39;__builtin__&#39;,&#39;__builtins__&#39;,&#39;_sh&#39;]</span>
<span class="c1">#     for var in dir(__main__):</span>
<span class="c1">#         try:</span>
<span class="c1">#             if inspect.ismodule(eval(&#39;__main__.%s&#39;%var)):</span>
<span class="c1">#                 if var not in badList:</span>
<span class="c1">#                     sm.append(&#39;try:\n\timport %s\nexcept Exception,e:\n\tAFLOWpi.run._fancy_error_log(e)&#39;%var)</span>
<span class="c1">#         except Exception,e:</span>
<span class="c1">#             AFLOWpi.run._fancy_error_log(e)</span>

<span class="c1">#     loadModString= &#39;\n&#39;.join([&#39;%s&#39;%x for x in sm])</span>
    
<span class="c1">#     funcLines=[&#39;\t%s&#39;%x for x in inspect.getsourcelines(func)[0]]</span>
<span class="c1"># #    print funcLines[0].split(&#39;,&#39;)</span>
<span class="c1">#     print inspect.getargspec(func)</span>
<span class="c1">#     funcStr=&#39;try:\n&#39;</span>
<span class="c1">#     funcStr+=&#39;&#39;.join(funcLines)</span>
<span class="c1">#     funcStr+=&#39;\nexcept Exception,e:\n\tAFLOWpi.run._fancy_error_log(e)&#39;</span>

<span class="c1"># #    print funcStr</span>
<span class="c1">#     callStr=&#39;try:\n\t&#39;</span>

<span class="c1">#     callStr+=&#39;oneCalc = &#39;</span>
<span class="c1">#     callStr+=&#39;%s(&#39;%func.__name__</span>
<span class="c1">#     argStr=&#39;,&#39;.join([&#39;%s&#39;%repr(x) for x in args])+&#39;,&#39;</span>
<span class="c1">#     kwargStr=&#39;,&#39;.join([&#39;%s=%s&#39;%(x[0],repr(x[1])) for x in kwargs.items()])</span>
<span class="c1">#     callStr+=argStr</span>
<span class="c1">#     callStr+=kwargStr</span>
<span class="c1">#     callStr+=&#39;)\nexcept Exception,e:\n\tAFLOWpi.run._fancy_error_log(e)&#39;</span>
<span class="c1"># #    print callStr</span>
<span class="c1">#     print args</span>

    
<span class="c1">#     if newStep:</span>
<span class="c1">#         new_calcs = writeToScript(func.__name__,calcs)</span>

<span class="c1">#         AFLOWpi.prep._addToAll(new_calcs,block=&#39;IMPORT&#39;,addition=loadModString)</span>
<span class="c1">#         AFLOWpi.prep._addToAll(new_calcs,block=&#39;IMPORT&#39;,addition=funcStr)</span>

<span class="c1">#         return new_calcs</span>

<span class="c1">####################################################################################################################</span>
<span class="c1">###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ####</span>
<span class="c1">####################################################################################################################</span>





<span class="c1">#################################################################################################################</span>














<span class="c1"># def _loadAllCalcs(fileList):</span>
<span class="c1">#     newCalcs = collections.OrderedDict()</span>
<span class="c1">#     for item in fileList:</span>
<span class="c1">#         folder = os.path.dirname(item)</span>
<span class="c1">#         splitList=item.split(&#39;/&#39;)</span>
<span class="c1">#         calcID=splitList[-1][1:]</span>

<span class="c1">#         calcID=re.sub(&#39;.py&#39;,&#39;&#39;,calcID)</span>

<span class="c1">#         oneCalc = AFLOWpi.prep._loadOneCalc(folder,calcID)</span>
<span class="c1">#         newCalcs[calcID]=oneCalc</span>
    

<span class="c1">#     return newCalcs</span>


	<span class="c1">##########################################################################################</span>
	<span class="c1">###NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED ###</span>
	<span class="c1">##########################################################################################</span>








<span class="c1">#########################################################################################################################</span>
<span class="c1">#########################################################################################################################</span>
<span class="c1">#########################################################################################################################</span>
<span class="c1">######################################################################################################################### </span>




<span class="c1">####################################################################################################################</span>
<span class="c1">###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ####</span>
<span class="c1">####################################################################################################################</span>


<span class="c1">############################################################################################################</span>
<span class="c1">#import AFLOWpi.pseudo as PT</span>


<span class="c1">####################################################################################################################</span>
<span class="c1">###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ###NOT FINISHED ####</span>
<span class="c1">####################################################################################################################</span>


<span class="c1">#     &#39;&#39;&#39;keep trying to save the calc to the calclog. if an error occurs because the file is already open by another job then wait 1 second and try again&#39;&#39;&#39;</span>
<span class="c1">#     while True:</span>
<span class="c1">#         try:</span>
            
<span class="c1">#             output = shelve.open(filename)</span>
<span class="c1">#             calcSave = copy.deepcopy(oneCalc)</span>
<span class="c1">#             output[ID]=calcSave</span>
<span class="c1">#             break </span>
<span class="c1">#         except Exception,e:</span>
<span class="c1">#             AFLOWpi.run._fancy_error_log(e)</span>
<span class="c1">#             time.sleep(1)</span>
<span class="c1">#             pass</span>

<span class="c1">#     logging.debug(&#39;exiting AFLOWpi.prep._updatelos&#39;)</span>




<span class="c1">#</span>

<span class="c1"># def _swapPositions(symMatrix,order=[1,2,3]):</span>
<span class="c1">#     &#39;&#39;&#39;reorganize the atomic_positions to fit with the change in the cell vectors&#39;&#39;&#39;</span>


<span class="c1">#     temp=[]</span>
<span class="c1">#     tempPos=[]</span>

    
<span class="c1">#     &#39;&#39;&#39;transpose so we can switch the vertical vectors easier&#39;&#39;&#39;</span>
<span class="c1">#     transposedPositions=symMatrix.T</span>
<span class="c1">#     returnMatrix = copy.deepcopy(transposedPositions)</span>

<span class="c1">#     returnMatrix[0] = numpy.copy(transposedPositions[order[0]-1])</span>
<span class="c1">#     returnMatrix[1] = numpy.copy(transposedPositions[order[1]-1])</span>
<span class="c1">#     returnMatrix[2] = numpy.copy(transposedPositions[order[2]-1])</span>
        
<span class="c1">#     &#39;&#39;&#39;transpose the positions again so they&#39;re back to normal&#39;&#39;&#39;</span>
<span class="c1">#     return returnMatrix.T</span>

<span class="c1"># def _aflow2pw(inputString):</span>


<span class="c1">#     inputDict = AFLOWpi.retr._splitInput(inputString)</span>
<span class="c1">#     try:</span>
<span class="c1"># 	    cell=AFLOWpi.retr._cellStringToMatrix(inputDict[&#39;CELL_PARAMETERS&#39;][&#39;__content__&#39;])</span>
	    
<span class="c1">#     except:</span>
<span class="c1"># 	    &#39;&#39;&#39;if there&#39;s no cell_positions card don&#39;t worry about the convention&#39;&#39;&#39;</span>
<span class="c1"># 	    return inputString</span>

<span class="c1">#     positionMatrix = AFLOWpi.retr._getPositions(inputString)</span>
<span class="c1">#     labels = AFLOWpi.retr._getPosLabels(inputString)</span>
<span class="c1">#     pos,flag = AFLOWpi.retr.detachPosFlags(AFLOWpi.qe.regex.atomic_positions(inputString))</span>


<span class="c1">#     ibrav=AFLOWpi.retr.getIbravFromVectors(cell)</span>

<span class="c1">#     if ibrav==13:</span>
<span class="c1">#         CONV_MCLC=numpy.array([</span>
<span class="c1">#                 [1.0,  0.0,  0.0,],</span>
<span class="c1">#                 [0.0,  0.0,  1.0,],</span>
<span class="c1">#                 [0.0,  1.0,  0.0,],</span>
<span class="c1">#                 ])</span>
<span class="c1">#         cell=CONV_MCLC.dot(cell)</span>
<span class="c1">#         cell=AFLOWpi.retr._prim2ConvVec(cell)</span>



<span class="c1">#         a = numpy.sqrt(cell[0].dot(cell[0].T)).getA()[0][0]</span>
<span class="c1">#         b = numpy.sqrt(cell[1].dot(cell[1].T)).getA()[0][0]</span>
<span class="c1">#         c = numpy.sqrt(cell[2].dot(cell[2].T)).getA()[0][0]</span>
<span class="c1">#         alpha = numpy.arccos(cell[1].dot(cell[2].T).getA()[0][0]/(b*c))*180.0/numpy.pi</span>
<span class="c1">#         beta  = numpy.arccos(cell[0].dot(cell[2].T).getA()[0][0]/(a*c))*180.0/numpy.pi</span>
<span class="c1">#         gamma = numpy.arccos(cell[0].dot(cell[1].T).getA()[0][0]/(a*b))*180.0/numpy.pi</span>

<span class="c1"># 	b_temp=b</span>
<span class="c1"># 	c_temp=c</span>
<span class="c1"># 	b=b_temp</span>
<span class="c1"># 	c=c_temp</span>
	

<span class="c1"># 	alpha_temp=alpha</span>
<span class="c1"># 	beta_temp=beta</span>
<span class="c1"># 	gamma_temp=gamma</span>



<span class="c1"># #	a=b_temp</span>
<span class="c1"># #	b=a_temp</span>
<span class="c1"># #	c=c_temp</span>
<span class="c1"># 	alpha=alpha_temp</span>
<span class="c1"># 	beta=beta_temp</span>
<span class="c1"># 	gamma=gamma_temp</span>


	
<span class="c1">#         MCLC_fixed=AFLOWpi.retr.abc2free(a,b,c,alpha=alpha,beta=beta,gamma=gamma,ibrav=ibrav)</span>
<span class="c1">#         MCLC_fixed=AFLOWpi.retr._cellStringToMatrix(MCLC_fixed)</span>

<span class="c1"># 	positionMatrix=__swapPositions(positionMatrix,order=[1,3,2])</span>


<span class="c1"># 	pos=AFLOWpi.retr._joinMatrixLabels(labels,positionMatrix)</span>
<span class="c1"># 	pos=AFLOWpi.retr.attachPosFlags(pos,flag)</span>
<span class="c1"># 	MCLC_fixed= AFLOWpi.retr._cellMatrixToString(MCLC_fixed)</span>
	



<span class="c1"># 	inputDict[&#39;CELL_PARAMETERS&#39;][&#39;__content__&#39;]=MCLC_fixed</span>
<span class="c1"># 	inputDict[&#39;ATOMIC_POSITIONS&#39;][&#39;__content__&#39;]=pos</span>

<span class="c1"># 	inputString=AFLOWpi.retr._joinInput(inputDict)</span>

<span class="c1">#     if int(ibrav)==4:</span>
<span class="c1"># 	    trans=numpy.array([</span>
<span class="c1"># 			    [ 1.,  1.,  0.,],</span>
<span class="c1"># 			    [-1.,  0.,  0.,],</span>
<span class="c1"># 			    [ 0.,  0.,  1.,],</span>
<span class="c1"># 			    ])</span>
<span class="c1"># 	    cell=trans.dot(cell)</span>
<span class="c1"># 	    cell= AFLOWpi.retr._cellMatrixToString(cell)</span>
<span class="c1"># 	    inputDict[&#39;CELL_PARAMETERS&#39;][&#39;__content__&#39;]=cell</span>
<span class="c1"># 	    inputString=AFLOWpi.retr._joinInput(inputDict)</span>

    

<span class="c1">#     return inputString</span>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Andrew Supka.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>