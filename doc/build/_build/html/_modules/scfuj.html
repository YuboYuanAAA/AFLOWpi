<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>scfuj &mdash; AFLOWpi  documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="AFLOWpi  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          AFLOWpi</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../plot.html">plot module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prep.html">prep module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pseudo.html">pseudo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../retr.html">retr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run.html">run module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scfuj.html">scfuj module</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for scfuj</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">copy</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">math</span> 


<div class="viewcode-block" id="chk_species"><a class="viewcode-back" href="../scfuj.html#scfuj.chk_species">[docs]</a><span class="k">def</span> <span class="nf">chk_species</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
    
    <span class="n">species_Nms</span> <span class="o">=</span> <span class="p">{</span><span class="c1">#d elements</span>
                        <span class="s1">&#39;Ti&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>  <span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Zn&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Zr&#39;</span><span class="p">,</span> <span class="s1">&#39;Nb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mo&#39;</span><span class="p">,</span> <span class="s1">&#39;Tc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ru&#39;</span><span class="p">,</span> <span class="s1">&#39;Rh&#39;</span><span class="p">,</span> <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;Cd&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Hf&#39;</span><span class="p">,</span> <span class="s1">&#39;Ta&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>  <span class="s1">&#39;Re&#39;</span><span class="p">,</span> <span class="s1">&#39;Os&#39;</span><span class="p">,</span> <span class="s1">&#39;Ir&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">,</span> <span class="s1">&#39;Hg&#39;</span><span class="p">,</span><span class="s1">&#39;Sc&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Ga&#39;</span><span class="p">,</span> <span class="s1">&#39;In&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span>
                       <span class="c1">#p elements</span>
                        <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span><span class="s1">&#39;Sn&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span><span class="s1">&#39;Si&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Ge&#39;</span><span class="p">,</span><span class="s1">&#39;As&#39;</span><span class="p">,</span><span class="s1">&#39;Br&#39;</span><span class="p">,</span><span class="s1">&#39;Sb&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Tl&#39;</span><span class="p">,</span><span class="s1">&#39;Pb&#39;</span><span class="p">,</span><span class="s1">&#39;Bi&#39;</span><span class="p">,</span><span class="s1">&#39;Po&#39;</span><span class="p">,</span><span class="s1">&#39;At&#39;</span><span class="p">,</span><span class="s1">&#39;Ba&#39;</span><span class="p">,</span>
                       <span class="c1">#s elements</span>
                        <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;Sr&#39;</span><span class="p">,</span><span class="s1">&#39;Mg&#39;</span><span class="p">,</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span><span class="s1">&#39;Be&#39;</span><span class="p">,</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s1">&#39;Ca&#39;</span><span class="p">,</span><span class="s1">&#39;Rb&#39;</span><span class="p">,</span><span class="s1">&#39;Cs&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">species_Nms</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span> 
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span> 
	

	

<span class="c1">###################################################################################################################################################</span>
</div>
<span class="k">def</span> <span class="nf">__getPAOfilename</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span><span class="n">PAOdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the pseudopotential filename for the specific atomic species in input</span>
<span class="sd">        </span>
<span class="sd">        Arguments:</span>
<span class="sd">         - atom -- a string designating the atomic species you want the pseudofile name for</span>
<span class="sd">        </span>
<span class="sd">        Keyword Arguments:</span>
<span class="sd">         - pseudodir -- the path of the directory containing pseudofiles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">PAOdir</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">PAOdir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;paodir&#39;</span><span class="p">)</span>        
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">PAOdir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                <span class="n">PAOdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">PAOdir</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">PAOdir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">paodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="n">paodir</span><span class="p">))</span>


        <span class="n">atom0</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">atom1</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">atom0</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">species</span><span class="o">=</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">atom0</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">atom0</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="o">+</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">atom1</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">atom1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
        <span class="n">regexFromConfig</span><span class="o">=</span><span class="s2">&quot;re.compile(r&#39;^&#39;+species+&#39;[._-]&#39;, re.I)&quot;</span>
        <span class="n">rex1</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">regexFromConfig</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">PAOdir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rex1</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
			<span class="n">PAOfilename</span> <span class="o">=</span> <span class="n">l</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting getPAOfilename&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">PAOfilename</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;!&#39;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Missing PAO File&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting getPAOfilename&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="c1">###################################################################################################################################################</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="kn">as</span> <span class="nn">it</span>
<span class="kn">import</span> <span class="nn">copy</span> 


<span class="c1">#def scfprep(allAFLOWpiVars,refFile,pseudodir=None,paodir=None,build_type=&#39;product&#39;):</span>
<div class="viewcode-block" id="scfprep"><a class="viewcode-back" href="../scfuj.html#scfuj.scfprep">[docs]</a><span class="k">def</span> <span class="nf">scfprep</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">paodir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">output_calcs</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="s1">&#39;oneCalc,ID = AFLOWpi.scfuj.__oneScfprep(oneCalc,ID)&#39;</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">output_calcs</span>
</div>
<span class="k">def</span> <span class="nf">__oneScfprep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">paodir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Read a ref file (str), the dictionary defining the calculations, and the dictionary with the aflowkeys Create the dir </span>
<span class="sd">        tree for the run and return a dictionary dictAllcalcs with all the calculations. Store the dictionary in a log file</span>

<span class="sd">        Arguments:</span>
<span class="sd">         - allAFLOWpiVars -- all the variables that you want to make a list of combinations of calculations from</span>
<span class="sd">         - refFile    -- string that contains the input ref file file path</span>
<span class="sd">        Keyword Arguments:</span>
<span class="sd">         - pseudodir  -- path of the directory that contains your Pseudopotential files</span>
<span class="sd">         - paodir     -- path of the directory that contains pseudo atomic orbital files for the respective pseudo-potentials</span>
<span class="sd">	 - calcs      -- Dictionary of dictionaries of calculations - this can be empty if it is the initial acbn0 run.</span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;SCFUJ Iteration&#39;</span> <span class="ow">in</span>  <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

        <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">):</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span>
<span class="c1">#            break</span>
        
	<span class="n">output_oneCalc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">paodir</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
		<span class="n">paodir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;paodir&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">paodir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                    <span class="n">paodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">paodir</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">paodir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">paodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="n">paodir</span><span class="p">))</span>
	
        <span class="n">oneCalc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>



        <span class="c1">#Modify inputfile to include Hubbard parameters</span>
        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
        <span class="c1">#check if u vals are already in input and start with those.</span>



        <span class="c1">#Assign initial U values</span>
<span class="c1">#        species=list(set(AFLOWpi.retr.__getPosLabels(inputfile)))</span>

        <span class="n">species</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+).*UPF&quot;</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>
        <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

        <span class="n">Uvals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)):</span>
            <span class="k">if</span> <span class="s1">&#39;Hubbard_U(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">isp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">startingUval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;Hubbard_U(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">isp</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>

                <span class="n">Uvals</span><span class="p">[</span><span class="n">species</span><span class="p">[</span><span class="n">isp</span><span class="p">]]</span> <span class="o">=</span> <span class="n">startingUval</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">Uvals</span><span class="p">[</span><span class="n">species</span><span class="p">[</span><span class="n">isp</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.001</span>	


	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyVarVal</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;uValue&#39;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">Uvals</span><span class="p">)</span>
        <span class="n">new_calc</span> <span class="o">=</span> <span class="n">updateUvals</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">Uvals</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span>

        <span class="n">new_inputfile</span> <span class="o">=</span> <span class="n">new_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
        <span class="n">calc_label</span> <span class="o">=</span> <span class="n">ID</span>

        <span class="n">output_onecalc</span> <span class="o">=</span> <span class="n">new_calc</span>
        <span class="n">output_oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_inputfile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output_oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;SCFUJ Iteration&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

	

	<span class="c1">#adding config file location to the calculations</span>
	<span class="n">configFile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>

        <span class="n">maketree</span><span class="p">(</span><span class="n">output_oneCalc</span><span class="p">,</span><span class="n">calc_label</span><span class="p">,</span> <span class="n">paodir</span><span class="o">=</span><span class="n">paodir</span><span class="p">)</span>


        <span class="sd">&quot;&quot;&quot;Generate a new uValLog.log file to wipe away if there is an old one&quot;&quot;&quot;</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_uValLog.log&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uValLogFile</span><span class="p">:</span>
            <span class="n">uValLogFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        
	<span class="k">return</span> <span class="n">output_oneCalc</span><span class="p">,</span><span class="n">calc_label</span>

<div class="viewcode-block" id="updateUvals"><a class="viewcode-back" href="../scfuj.html#scfuj.updateUvals">[docs]</a><span class="k">def</span> <span class="nf">updateUvals</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span> <span class="n">Uvals</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Modify scf input file to do a lda+u calculation.</span>
<span class="sd">	</span>
<span class="sd">	Arguments:</span>
<span class="sd">	 - oneCalc      -- Dictionary of one calculation </span>
<span class="sd">	 - Uvals	-- Dictionary of Uvals</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">inputfile</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
		<span class="c1">#Get species</span>
<span class="c1">#                species=list(set(AFLOWpi.retr.__getPosLabels(inputfile)))</span>
		<span class="n">species</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+).*UPF&quot;</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>

                <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;lda_plus_u&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;.TRUE.&#39;</span>
                <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)):</span>
                    <span class="n">hub_entry</span> <span class="o">=</span> <span class="s1">&#39;Hubbard_U(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">isp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">hub_entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uvals</span><span class="p">[</span><span class="n">species</span><span class="p">[</span><span class="n">isp</span><span class="p">]]</span>
         	<span class="c1">#Update inputfile</span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>

	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


	<span class="k">return</span> <span class="n">oneCalc</span>


<span class="c1">###################################################################################################################################################</span></div>
<span class="kn">import</span> <span class="nn">shutil</span>
<div class="viewcode-block" id="maketree"><a class="viewcode-back" href="../scfuj.html#scfuj.maketree">[docs]</a><span class="k">def</span> <span class="nf">maketree</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span> <span class="n">paodir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the directoy tree and place in the input file there</span>
<span class="sd">        </span>
<span class="sd">        Arguments:</span>
<span class="sd">         - calcs -- Dictionary of dictionaries of calculations</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">         - pseudodir   -- path of pseudopotential files directory </span>
<span class="sd">	 - paodir	- path of pseudoatomic orbital basis set</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="c1">#        for ID,oneCalc in calcs.iteritems():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scfujInfileObj</span><span class="p">:</span>
            <span class="n">scfujInfileObj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

        <span class="sd">&#39;&#39;&#39;save the calc just in case so it&#39;s updated witht he scfuj U value info in the input file as well as _AFLOWPI_INPUT_&#39;&#39;&#39;</span>

<span class="c1">#        if AFLOWpi.prep.__findInBlock(oneCalc,ID,&#39;LOADCALC&#39;,&#39;&#39;&#39;oneCalc = AFLOWpi.prep.__loadOneCalc(&#39;%s&#39;,&#39;%s&#39;)&#39;&#39;&#39; % (oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],ID) )==False:</span>

<span class="c1">#            AFLOWpi.prep.__addToBlock(oneCalc,ID,&#39;LOADCALC&#39;,&#39;&#39;&#39;try:</span>
<span class="c1">#   oneCalc = AFLOWpi.prep.__loadOneCalc(&#39;%s&#39;,&#39;%s&#39;)</span>
<span class="c1">#except:</span>
<span class="c1">#   pass</span>
<span class="c1">#&#39;&#39;&#39; % (oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],ID) )            </span>


	<span class="c1">#Get wanT directory from config file and copy bands.x from it to tre</span>
	<span class="n">wantdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;wantdir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">wantdir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">wantdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">wantdir</span><span class="p">)</span>

	<span class="n">wantBandsExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wantdir</span><span class="p">,</span><span class="s1">&#39;bands.x&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wantBandsExec</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;WanT bands executable not found. Check your config file to make sure wantdir path is correct and that bands.x is in that directory..Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;WanT bands executable not found. Check your config file to make sure wantdir path is correct and that bands.x is in that directory..Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>


	<span class="n">wantdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;wantdir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">wantdir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">wantdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">wantdir</span><span class="p">)</span>

	<span class="n">espressodir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;enginedir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">espressodir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">espressodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">espressodir</span><span class="p">)</span>

	<span class="n">pdosExec</span> <span class="o">=</span> <span class="s1">&#39;projwfc.x&#39;</span>
	<span class="n">pdosExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">espressodir</span><span class="p">,</span><span class="n">pdosExec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pdosExec</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;ProjectWFC executable not found. Check your config file to make sure enginedir path is correct and that projwfc.x is in that directory..Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ProjectWFC executable not found. Check your config file to make sure enginedir path is correct and that projwfc.x is in that directory..Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
	<span class="n">dosExec</span> <span class="o">=</span> <span class="s1">&#39;dos.x&#39;</span>
	<span class="n">dosExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">espressodir</span><span class="p">,</span><span class="n">dosExec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dosExec</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;DOS executable not found. Check your config file to make sure enginedir path is correct and that dos.x is in that directory..Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;DOS executable not found. Check your config file to make sure enginedir path is correct and that dos.x is in that directory..Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
	<span class="n">scfExec</span> <span class="o">=</span> <span class="s1">&#39;pw.x&#39;</span>
	<span class="n">scfExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">espressodir</span><span class="p">,</span><span class="n">scfExec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">scfExec</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;SCF executable not found. Check your config file to make sure enginedir path is correct and that pw.x is in that directory..Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;SCF executable not found. Check your config file to make sure enginedir path is correct and that pw.x is in that directory..Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
            


	<span class="k">try</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">wantBandsExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">rename</span><span class="o">=</span><span class="s1">&#39;want_bands.x&#39;</span><span class="p">)</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">pdosExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">dosExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">scfExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">wantBandsExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">rename</span><span class="o">=</span><span class="s1">&#39;want_bands.x&#39;</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">pdosExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">dosExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">scfExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1">##############################################################################################################</span>
	<span class="c1">#move acbn0.py to dir tree</span>
	<span class="n">acbn0Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;scfuj&#39;</span><span class="p">,</span><span class="s1">&#39;acbn0_support&#39;</span><span class="p">,</span> <span class="s1">&#39;acbn0.py&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">acbn0Path</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">acbn0Path</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

	<span class="c1">#move integs.pyc to dir tree</span>
	<span class="n">integPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;scfuj&#39;</span><span class="p">,</span><span class="s1">&#39;acbn0_support&#39;</span><span class="p">,</span> <span class="s1">&#39;integs.py&#39;</span><span class="p">)</span>	
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">integPath</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">integPath</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>

	<span class="c1">#move integs.pyc to dir tree</span>
	<span class="n">pyintsPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;scfuj&#39;</span><span class="p">,</span><span class="s1">&#39;acbn0_support&#39;</span><span class="p">,</span> <span class="s1">&#39;pyints.py&#39;</span><span class="p">)</span>	
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">pyintsPath</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">pyintsPath</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>



        <span class="n">moleculePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;scfuj&#39;</span><span class="p">,</span><span class="s1">&#39;acbn0_support&#39;</span><span class="p">,</span> <span class="s1">&#39;Molecule.py&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">moleculePath</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

	<span class="k">else</span><span class="p">:</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">moleculePath</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>

<span class="c1">############################################################################################################</span>
	<span class="c1">#Get paodir from config file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">paodir</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
		<span class="n">paodir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;paodir&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">paodir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
                    <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                    <span class="n">paodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">paodir</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">paodir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">paodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="n">paodir</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
<span class="c1">#                    print &#39;Can not find PAO file. Exiting&#39;</span>
<span class="c1">#                    logging.error(&#39;Can not find PAO file. Exiting&#39;)</span>
<span class="c1">#                    raise SystemExit</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">print</span> <span class="s1">&#39;Can not find PAO file. Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Can not find PAO file. Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>




        <span class="c1">#Copy PAO files </span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">work_dir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">r&#39;_AFLOWPI_[A-Z][0-9]*_&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                            <span class="n">vp</span> <span class="o">=</span> <span class="n">__getPAOfilename</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">),</span><span class="n">paodir</span><span class="p">)</span>		


                            <span class="k">try</span><span class="p">:</span>
                                    <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paodir</span><span class="p">,</span><span class="n">vp</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="s1">&#39;!&#39;</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cannot find correct PAO files in </span><span class="si">%s</span><span class="s1"> ...Exiting&#39;</span> <span class="o">%</span> <span class="n">paodir</span><span class="p">)</span>
                                <span class="k">print</span> <span class="s1">&#39;cannot find correct PAO files in </span><span class="si">%s</span><span class="s1"> ...Exiting&#39;</span> <span class="o">%</span> <span class="n">paodir</span>
                                <span class="k">raise</span> <span class="ne">SystemExit</span>

                            <span class="n">newPAOFileNm</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_basis.py&quot;</span><span class="p">)</span>
                            <span class="k">print</span> <span class="s1">&#39;Copying &#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s1">&#39; to &#39;</span><span class="o">+</span> <span class="n">newPAOFileNm</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Copying &#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s1">&#39; to &#39;</span><span class="o">+</span> <span class="n">newPAOFileNm</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copypseudos&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">newPAOFileNm</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -fr </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">newPAOFileNm</span><span class="p">)</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">newPAOFileNm</span><span class="p">)</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;cant copy PAO!&#39;</span><span class="p">)</span>
                                            <span class="k">raise</span> <span class="ne">SystemExit</span>
                            <span class="k">else</span><span class="p">:</span>
<span class="c1">#                                    print a</span>
<span class="c1">#                                    print newPAOFileNm</span>

                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newPAOFileNm</span><span class="p">):</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newPAOFileNm</span><span class="p">)</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -fr </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">newPAOFileNm</span><span class="p">)</span>
                                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newPAOFileNm</span><span class="p">)</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="sd">&#39;&#39;&#39;save the inital list of things to exec so first iteration it will run through&#39;&#39;&#39;</span>

<span class="c1">#        oneCalc[&#39;__runList__&#39;]=[]</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">oneCalc</span>
</div>
<div class="viewcode-block" id="nscf_nosym_noinv"><a class="viewcode-back" href="../scfuj.html#scfuj.nscf_nosym_noinv">[docs]</a><span class="k">def</span> <span class="nf">nscf_nosym_noinv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">kpFactor</span><span class="o">=</span><span class="mf">1.50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the ncsf input to each subdir and update the master dictionary</span>
<span class="sd">        </span>
<span class="sd">        Arguments:</span>
<span class="sd">         - calc_copy -- dictionary of one calculation</span>
<span class="sd">         - kpFactor -- multiplicative factor for kpoints from SCF to DOS (default: 2)</span>
<span class="sd">        &quot;&quot;&quot;</span>

	<span class="n">calc_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="n">subdir</span> <span class="o">=</span> <span class="n">calc_copy</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">inputfile</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
                <span class="sd">&#39;&#39;&#39;we need nscf and not bands because we need output for HOMO&#39;&#39;&#39;</span>
<span class="c1">#                inputDict=AFLOWpi.retr.__splitInput(inputfile)</span>

<span class="c1">#                inputfile=AFLOWpi.retr.__joinInput(inputDict)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>
                <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>

                        <span class="k">for</span> <span class="n">ID_old</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">a</span> <span class="o">=</span> <span class="n">ID_old</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>
                                <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                                <span class="n">match1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">r&#39;Kohn-Sham states=&#39;</span><span class="p">,</span><span class="n">outfile</span><span class="p">)</span>
                                <span class="n">m1</span> <span class="o">=</span> <span class="n">match1</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                                <span class="n">m2</span> <span class="o">=</span> <span class="n">m1</span> <span class="o">+</span> <span class="mi">15</span>
                                <span class="n">nbnd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">outfile</span><span class="p">[</span><span class="n">m1</span><span class="p">:</span><span class="n">m2</span><span class="p">]))</span>
<span class="c1">#                                splitInput[&#39;&amp;system&#39;][&#39;nbnd&#39;]=&#39;%s&#39;% nbnd                        </span>
                                <span class="k">print</span> <span class="s1">&#39;Number of bands to be Calculated </span><span class="si">%s</span><span class="s1">: &#39;</span><span class="o">%</span> <span class="n">nbnd</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of bands to be Calculated </span><span class="si">%s</span><span class="s1">: &#39;</span><span class="o">%</span> <span class="n">nbnd</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                                <span class="k">pass</span>

			<span class="sd">&#39;&#39;&#39;checks to see if nbnd has already been added to the file - in any case add/replace nbnd&#39;&#39;&#39;</span>
			<span class="sd">&#39;&#39;&#39;Add nosym = .true. and noinv = .true. to file &#39;&#39;&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;nosym&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;.true.&#39;</span>
                            <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;noinv&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;.true.&#39;</span>

                            <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&quot;nscf&quot;&#39;</span>
                            <span class="n">inputfile</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)</span>
                            <span class="sd">&#39;&#39;&#39;writes an input for band_plot.x to process the correct number of bands calculated&#39;&#39;&#39;</span>
                        
                            
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                <span class="k">print</span> <span class="n">e</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s1">&#39;SCF outputfile not found: nbnd is default&#39;</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;SCF outputfile not found: nbnd is default&#39;</span><span class="p">)</span>
                        <span class="k">pass</span>
                <span class="sd">&#39;&#39;&#39;checks to see if &quot;crystal_b&quot; has already been substituted for &quot;automatic&quot;&#39;&#39;&#39;</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;{}()&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mod</span><span class="o">==</span><span class="s1">&#39;GAMMA&#39;</span><span class="p">:</span>
                        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;2 2 2 0 0 0&#39;</span>
                        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;{automatic}&#39;</span>
                        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">splitInput</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                        <span class="n">scfKPointString</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
			<span class="n">scfKPointSplit</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scfKPointString</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

                        <span class="n">before_kpf</span><span class="o">=</span><span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">scfKPointSplit</span> <span class="p">)</span>
                        <span class="n">scaling_kpf</span><span class="o">=</span><span class="n">before_kpf</span><span class="o">/</span><span class="mf">150.0</span>
                        <span class="k">if</span> <span class="n">scaling_kpf</span><span class="o">&gt;</span><span class="mf">1.0</span><span class="p">:</span>
                            <span class="n">kpFactor</span><span class="o">=</span><span class="mi">1</span>

                            
                            

			<span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">):</span>
				<span class="n">scfKPointSplit</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]</span><span class="o">*</span><span class="n">kpFactor</span><span class="p">)))</span>
			<span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">)):</span>
				<span class="n">scfKPointSplit</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

			<span class="n">newKPointString</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">)</span>

                        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newKPointString</span>
                        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;{automatic}&#39;</span>
                        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


		<span class="n">calc_label</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_nscf&quot;</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">output_calc</span> <span class="o">=</span> <span class="n">calc_copy</span>
                <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">calc_copy</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>

                
        <span class="k">return</span> <span class="n">output_calc</span><span class="p">,</span><span class="n">calc_label</span>

</div>
<div class="viewcode-block" id="projwfc"><a class="viewcode-back" href="../scfuj.html#scfuj.projwfc">[docs]</a><span class="k">def</span> <span class="nf">projwfc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	Run projwfc on each calculation</span>

<span class="sd">	Arguments:</span>
<span class="sd">	 - oneCalc -- dictionary of a single calculation</span>

<span class="sd">	&#39;&#39;&#39;</span>

        <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__get_tempdir</span><span class="p">()</span>
	<span class="n">calc_copy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
        <span class="n">output_calc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
        
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__prefixFromInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>


                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>

                    <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>
                

		<span class="n">inputfile</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&amp;PROJWFC</span>
<span class="s2">  prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">  filpdos=&#39;./</span><span class="si">%s</span><span class="s2">_acbn0&#39;</span>
<span class="s2">  outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">  lwrite_overlaps=.TRUE.</span>
<span class="s2">  lbinary_data  = .TRUE.</span>
<span class="s2">/</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">)</span>

		<span class="n">calc_label</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s1">&#39;_pdos&#39;</span>		

                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">output_calc</span><span class="p">[</span><span class="n">calc_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_copy</span>
                <span class="n">output_calc</span><span class="p">[</span><span class="n">calc_label</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>


        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>
	
	<span class="k">return</span> <span class="n">output_calc</span><span class="p">[</span><span class="n">calc_label</span><span class="p">],</span> <span class="n">calc_label</span>


<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
</div>
<div class="viewcode-block" id="WanT_bands"><a class="viewcode-back" href="../scfuj.html#scfuj.WanT_bands">[docs]</a><span class="k">def</span> <span class="nf">WanT_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">eShift</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">nbnd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Make input files for  WanT bands calculation</span>

<span class="sd">		Arguments:</span>
<span class="sd">        	 - calc_copy -- dictionary of dictionaries of calculations</span>
<span class="sd">	&#39;&#39;&#39;</span>
	<span class="n">output_calc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__get_tempdir</span><span class="p">()</span>
	<span class="n">calc_copy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
	<span class="n">subdir</span> <span class="o">=</span> <span class="n">calc_copy</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
	<span class="n">nspin</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">chkSpinCalc</span><span class="p">(</span><span class="n">calc_copy</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

	<span class="c1">### GET KPATH for respective symmetry #####</span>
	<span class="n">special_points</span><span class="p">,</span> <span class="n">band_path</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getHighSymPoints</span><span class="p">(</span><span class="n">calc_copy</span><span class="p">)</span>
	<span class="n">lblList</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">kpathStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">band_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">):</span>
                <span class="n">lblList</span> <span class="o">+=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lblList</span><span class="p">:</span>
                <span class="n">kpathStr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%.5f</span><span class="se">\t</span><span class="si">%.5f</span><span class="se">\t</span><span class="si">%.5f</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">special_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">special_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">special_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
	<span class="c1">############################################ </span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__prefixFromInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>
                
        <span class="k">if</span> <span class="n">temp_dir</span><span class="o">!=</span><span class="s1">&#39;./&#39;</span><span class="p">:</span>
            <span class="n">subdir</span><span class="o">=</span><span class="n">temp_dir</span>

<span class="c1">#        if nbnd!=None:</span>
<span class="c1">#            nbnd_string = &#39;atmproj_nbnd    = %s&#39; % nbnd</span>
<span class="c1">#        else:</span>
        <span class="n">nbnd_string</span><span class="o">=</span> <span class="s1">&#39;&#39;</span>


	<span class="n">inputfile</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; &amp;INPUT							  </span>
<span class="s2">prefix 		= &#39;</span><span class="si">%s</span><span class="s2">&#39; 		  	                        </span>
<span class="s2">postfix 	= </span><span class="se">\&#39;</span><span class="s2">_WanT</span><span class="se">\&#39;</span><span class="s2">		        </span>
<span class="s2">work_dir	= </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">		 </span>
<span class="s2">datafile_dft	= </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.save/atomic_proj.dat</span><span class="se">\&#39;</span><span class="s2">	 </span>
<span class="s2">nkpts_in        = </span><span class="si">%d</span><span class="s2">                 </span>
<span class="s2">nkpts_max	= 1000		 </span>
<span class="s2">do_orthoovp	= .FALSE.</span>
<span class="s2">atmproj_sh      = </span><span class="si">%f</span><span class="s2">                         </span>
<span class="si">%s</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lblList</span><span class="p">),</span><span class="n">eShift</span><span class="p">,</span><span class="n">nbnd_string</span><span class="p">)</span>
<span class="c1">#&quot;&quot;&quot;%(prefix,subdir,subdir,prefix,len(special_points),eShift,nbnd_string)</span>


	<span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout	= &#39;</span><span class="si">%s</span><span class="s2">_bands_want.dat&#39;</span><span class="se">\n</span><span class="s2">/</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ID</span>
		<span class="c1"># Insert k-path </span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="n">kpathStr</span>

		<span class="n">calc_label</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_bands&quot;</span>
		
	        <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
	        <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	        <span class="n">output_calc</span> <span class="o">=</span> <span class="n">calc_copy</span>
	        <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>

		<span class="n">single_output_calc</span> <span class="o">=</span> <span class="p">{</span><span class="n">calc_label</span><span class="p">:</span><span class="n">output_calc</span><span class="p">}</span>

		<span class="k">return</span> <span class="n">single_output_calc</span>

	<span class="k">else</span><span class="p">:</span>
		<span class="n">inputfile1</span> <span class="o">=</span> <span class="n">inputfile</span>
		<span class="c1">#Create two input files for spin-up and spin-down components.</span>
		<span class="n">inputfile</span> <span class="o">+=</span>  <span class="s2">&quot;&quot;&quot;fileout	= &#39;</span><span class="si">%s</span><span class="s2">_bands_want_up.dat&#39;  </span><span class="se">\n</span><span class="s2">spin_component	  =    &quot;up&quot;</span><span class="se">\n</span><span class="s2">/</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="n">ID</span>
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;fileout	= &#39;</span><span class="si">%s</span><span class="s2">_bands_want_down.dat&#39;</span><span class="se">\n</span><span class="s2">spin_component   =    &quot;down&quot;</span><span class="se">\n</span><span class="s2">/</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="n">ID</span>
		<span class="c1">#Insert k-path</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="n">kpathStr</span>
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="n">kpathStr</span>

                <span class="n">calc_label_up</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_bands_up&quot;</span> 
                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label_up</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">output_calc_up</span><span class="o">=</span> <span class="n">calc_copy</span>
                <span class="n">output_calc_up</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>


                <span class="n">calc_label_down</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_bands_down&quot;</span> 
                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label_down</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile1</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">output_calc_down</span> <span class="o">=</span> <span class="n">calc_copy</span>
                <span class="n">output_calc_down</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>


		<span class="n">output_calc</span> <span class="o">=</span> <span class="p">{</span><span class="n">calc_label_up</span><span class="p">:</span><span class="n">output_calc_up</span><span class="p">,</span> <span class="n">calc_label_down</span><span class="p">:</span><span class="n">output_calc_down</span><span class="p">}</span>		
		<span class="k">return</span> <span class="n">output_calc</span>


<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>

<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
</div>
<div class="viewcode-block" id="chkSpinCalc"><a class="viewcode-back" href="../scfuj.html#scfuj.chkSpinCalc">[docs]</a><span class="k">def</span> <span class="nf">chkSpinCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Check whether an calculation is spin polarized or not.</span>
<span class="sd">	</span>
<span class="sd">		Arguments:</span>
<span class="sd">		</span>
<span class="sd">		--oneCalc : dictionary of a single calculation.</span>

<span class="sd">	&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nspin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;nspin&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">nspin</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="n">oneCalcID</span> <span class="o">=</span> <span class="n">ID</span><span class="c1">#oneCalc[&#39;_AFLOWPI_PREFIX_&#39;][1:]</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
        <span class="n">scfOutput</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">oneCalcID</span>

        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;(spin.*)\n&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">ID_old</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">ID_old</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin_obj</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">fin_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">1</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>


	
</div>
<div class="viewcode-block" id="evCurveMinimize"><a class="viewcode-back" href="../scfuj.html#scfuj.evCurveMinimize">[docs]</a><span class="k">def</span> <span class="nf">evCurveMinimize</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">pThresh</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">final_minimization</span> <span class="o">=</span> <span class="s1">&#39;vc-relax&#39;</span><span class="p">):</span>

	<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		<span class="n">execString</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">newOneCalc = AFLOWpi.scfuj. __oneMinimizeCalcs(oneCalc, ID, pThresh=</span><span class="si">%f</span><span class="s1">)</span>
<span class="s1">AFLOWpi.prep.__saveOneCalc(oneCalc,ID)</span>
<span class="s1">	&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pThresh</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span> <span class="n">execString</span><span class="p">)</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__skeletonRun</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
	<span class="c1">#if final_minimization != None:</span>
<span class="c1">#		calcs = AFLOWpi.prep.changeCalcs(calcs, &#39;calculation&#39;, final_minimization)</span>
<span class="c1">#		AFLOWpi.run.scf(calcs)</span>
<span class="c1">#		calcs = AFLOWpi.prep.changeCalcs(calcs, &#39;calculation&#39;, &#39;scf&#39;)</span>
<span class="c1">#	AFLOWpi.run.scf(calcs)</span>

	<span class="k">return</span> <span class="n">calcs</span>
</div>
<span class="k">def</span> <span class="nf">__oneMinimizeCalcs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">pThresh</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Get equilibrium volume using evfit to Murnaghan&#39;s EOS with 5 volumes in +/-20% of input volume</span>
<span class="sd">	&#39;&#39;&#39;</span>

	<span class="kn">import</span> <span class="nn">__main__</span>

	<span class="n">__submitNodeName__</span> <span class="o">=</span>  <span class="n">__main__</span><span class="o">.</span> <span class="n">__submitNodeName__</span>
	<span class="n">execPrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
	<span class="n">execPostfix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
	<span class="k">if</span> <span class="n">config</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;forced config </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
	    <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span>

	<span class="k">else</span><span class="p">:</span>
	    <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
	
	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;espresso&#39;</span>
	

	<span class="k">def</span> <span class="nf">runCalcList</span><span class="p">(</span><span class="n">alatList</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">newCalc</span><span class="p">):</span>

		<span class="n">S</span><span class="o">=</span><span class="s2">&quot;Begin running calculations for lat para &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alatList</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
		<span class="n">engList</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">stressList</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alatList</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
				<span class="n">inputfile</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>

				<span class="n">inputfile</span> <span class="o">=</span> <span class="n">celldmRE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;celldm(1)=</span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>
				<span class="n">newCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">inputfile</span>

				<span class="n">a</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span> 
				<span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
				<span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
				<span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			
					
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">newCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>		
				
				<span class="n">outFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
				<span class="n">outFileString</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
				<span class="n">energyRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(?:(?:(?:(?:\!\s+)total)|(?:Final)) en\w+\s*=\s+(.+?)Ry)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
				<span class="n">finalEnergy</span><span class="o">=</span><span class="n">energyRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)</span>
				<span class="n">stressRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;P=\s*(.*)\n&#39;</span><span class="p">)</span>
				<span class="n">finalStress</span> <span class="o">=</span> <span class="n">stressRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)</span>
				

				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalEnergy</span><span class="p">):</span>
					<span class="n">energy</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">finalEnergy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span> <span class="n">engList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
					<span class="n">stress</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">finalStress</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>	<span class="n">stressList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stress</span><span class="p">)</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;E-V curve point: </span><span class="si">%f</span><span class="s2"> a.u. </span><span class="si">%f</span><span class="s2"> Ry&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
					<span class="k">print</span> <span class="s2">&quot;E-V curve point: </span><span class="si">%f</span><span class="s2"> a.u. </span><span class="si">%f</span><span class="s2"> Ry&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>	
				<span class="k">else</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR: E-V curve at celldm(1) = </span><span class="si">%f</span><span class="s2"> FAILED&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
					<span class="k">raise</span> <span class="ne">SystemExit</span>

			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
	                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

		<span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stressList</span><span class="p">,</span> <span class="n">engList</span><span class="p">,</span> <span class="n">alatList</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">turningPts</span><span class="p">(</span><span class="n">tmplst</span><span class="p">):</span>
                <span class="n">lstarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmplst</span><span class="p">)</span>
                <span class="n">de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lstarr</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">npts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">de</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">de</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> turning points found in E-V curve&quot;</span><span class="o">%</span><span class="n">npts</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">npts</span>


        <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
	<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span>
	
        <span class="n">newCalc</span> <span class="o">=</span> <span class="n">oneCalc</span>
	<span class="n">inputfile</span> <span class="o">=</span> <span class="n">newCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>


	<span class="n">ibravRE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;ibrav.*?(\d+)&quot;</span><span class="p">)</span>
        <span class="n">ibrav</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ibravRE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span> 	

	

	<span class="k">if</span> <span class="n">ibrav</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ibrav</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">ibrav</span> <span class="o">==</span><span class="mi">3</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entering structural optimization via 5 point E-V curve&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">celldmRE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;celldm\(1\).*?=.*?([0-9]*\.?[0-9]+),?&#39;</span><span class="p">)</span>	
			<span class="n">celldm1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">celldmRE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
			<span class="c1">#Get list of lattice parameters in the range 70% V0 to 130% V0</span>
			<span class="n">alatList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="n">celldm1</span><span class="o">**</span><span class="mi">3</span><span class="o">*.</span><span class="mi">7</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),(</span><span class="n">celldm1</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mf">1.3</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="p">((</span><span class="n">celldm1</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mf">1.2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">celldm1</span><span class="o">**</span><span class="mi">3</span><span class="o">*.</span><span class="mi">8</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span><span class="o">/</span><span class="mi">5</span><span class="p">))</span>
			<span class="c1">#Get first set of datapoints for E-V curve</span>
			<span class="n">dataList</span> <span class="o">=</span> <span class="n">runCalcList</span><span class="p">(</span><span class="n">alatList</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">newCalc</span><span class="p">)</span>
			
                        <span class="c1">#Check whether a turning point is reached in E-V curve</span>
                        <span class="n">tmpList</span> <span class="o">=</span> <span class="n">dataList</span>

                        <span class="n">nTurnPts</span> <span class="o">=</span> <span class="n">turningPts</span><span class="p">(</span><span class="n">tmpList</span><span class="p">)</span> 

                        <span class="c1">#Sort on stress</span>
                        <span class="n">tmpList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="c1">#tmpfout = file(&quot;tmpEV.txt&quot;,&#39;a&#39;)</span>
			<span class="k">while</span> <span class="n">nTurnPts</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                                
                         <span class="c1">#       for i in tmpList:</span>
                         <span class="c1">#               tmpfout.write(&quot;%f\t %f\t %f\n&quot;%(i[2], i[1], i[0]))</span>
                         <span class="c1">#       tmpfout.close()</span>

				<span class="c1">#Check if volume expansion or compression is needed to arrive at V0</span>
				<span class="k">if</span> <span class="n">tmpList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pThresh</span><span class="p">:</span>
					<span class="n">celldm1</span> <span class="o">=</span> <span class="n">dataList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">1.1</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">celldm1</span> <span class="o">=</span> <span class="n">dataList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">0.9</span>

				<span class="c1">#Get list of lattice parameters in the range 70% V0 to 130% V0</span>
				<span class="n">alatList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="n">celldm1</span><span class="o">**</span><span class="mi">3</span><span class="o">*.</span><span class="mi">7</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),(</span><span class="n">celldm1</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mf">1.3</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="p">((</span><span class="n">celldm1</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mf">1.2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">celldm1</span><span class="o">**</span><span class="mi">3</span><span class="o">*.</span><span class="mi">8</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span><span class="o">/</span><span class="mi">5</span><span class="p">))</span>
				<span class="c1">#Get new set of points</span>
				<span class="n">newdataList</span> <span class="o">=</span> <span class="n">runCalcList</span><span class="p">(</span><span class="n">alatList</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">newCalc</span><span class="p">)</span>
				<span class="c1">#Add to old set of points to make curve better</span>
				<span class="n">dataList</span> <span class="o">=</span> <span class="n">dataList</span> <span class="o">+</span> <span class="n">newdataList</span>
                                <span class="c1">#Find the number of turning points</span>
                                <span class="n">nTurnPts</span> <span class="o">=</span> <span class="n">turningPts</span><span class="p">(</span><span class="n">dataList</span><span class="p">)</span>

				<span class="n">tmpList</span> <span class="o">=</span> <span class="n">newdataList</span>                               
                                <span class="n">tmpList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				

                        <span class="n">evinFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_evx.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
                        <span class="n">evoutFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_evx.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
                        <span class="n">fout</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">evinFile</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
			<span class="n">dataList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="c1">#Write data to file</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dataList</span><span class="p">:</span>
                                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="se">\t</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

			<span class="n">engineDir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;prep&quot;</span><span class="p">,</span><span class="s2">&quot;enginedir&quot;</span><span class="p">)</span>
			<span class="n">evfitPath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="s1">&#39;ev.x&#39;</span><span class="p">)</span>
			<span class="n">evfitString</span> <span class="o">=</span> <span class="s2">&quot;cat&lt;&lt;! | </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">au</span><span class="se">\n</span><span class="s2">sc</span><span class="se">\n</span><span class="s2">4</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">evfitPath</span><span class="p">,</span><span class="n">evinFile</span><span class="p">,</span><span class="n">evoutFile</span><span class="p">)</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting fitting E-V curve with Murnaghan&#39;s EOS&quot;</span><span class="p">)</span>
			<span class="k">print</span> <span class="s2">&quot;Starting Fitting E-V curve with Murnaghan&#39;s EOS&quot;</span>
			<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">evfitString</span><span class="p">)</span>
			<span class="n">evoutFileString</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">evoutFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished fitting E-V curve with Murnaghan&#39;s EOS&quot;</span><span class="p">)</span>
			<span class="k">print</span> <span class="s2">&quot;Finished Fitting E-V curve with Murnaghan&#39;s EOS&quot;</span>
			
			<span class="n">a0regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;a0.*?=.*?([0-9]*\.?[0-9]+)\s*a\.u\.&#39;</span><span class="p">)</span>
			<span class="n">a0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a0regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">evoutFileString</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">inputfile</span> <span class="o">=</span> <span class="n">celldmRE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;celldm(1)=</span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">a0</span><span class="p">,</span><span class="n">inputfile</span><span class="p">)</span>
			<span class="n">newCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">inputfile</span>
			
		        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOADCALC&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;oneCalc = AFLOWpi.prep.__loadOneCalc(&#39;</span><span class="si">%s</span><span class="s1">&#39;,&#39;</span><span class="si">%s</span><span class="s1">&#39;)&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">ID</span><span class="p">))</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
		            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;LOADCALC&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;oneCalc = AFLOWpi.prep.__loadOneCalc(&#39;</span><span class="si">%s</span><span class="s1">&#39;,&#39;</span><span class="si">%s</span><span class="s1">&#39;)&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">ID</span><span class="p">)</span> <span class="p">)</span>
		        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">newCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
 
			<span class="c1">#Save new inputfile</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span>
			<span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
			<span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
			<span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">newCalc</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">print</span> <span class="s2">&quot;Minimization for ibrav = </span><span class="si">%d</span><span class="s2"> not implemented&quot;</span> <span class="o">%</span><span class="n">ibrav</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Minimization for ibrav = </span><span class="si">%d</span><span class="s2"> not implemented&quot;</span><span class="o">%</span><span class="n">ibrav</span><span class="p">)</span>
		<span class="k">raise</span> <span class="ne">SystemExit</span>
<div class="viewcode-block" id="acbn0"><a class="viewcode-back" href="../scfuj.html#scfuj.acbn0">[docs]</a><span class="k">def</span> <span class="nf">acbn0</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">projCalcID</span><span class="p">,</span><span class="n">byAtom</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>



<span class="sd">        &#39;&#39;&#39;</span>

	<span class="n">oneCalcID</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projCalcID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="c1">#oneCalc[&#39;_AFLOWPI_PREFIX_&#39;][1:]	</span>
	<span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>	
	<span class="n">nspin</span> <span class="o">=</span> <span class="n">chkSpinCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">oneCalcID</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">get_orbital</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>

                <span class="c1">#d elements</span>
                <span class="n">trM_Nms</span> <span class="o">=</span><span class="p">{</span> <span class="s1">&#39;Ti&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>  <span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Zn&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Zr&#39;</span><span class="p">,</span> <span class="s1">&#39;Nb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mo&#39;</span><span class="p">,</span> <span class="s1">&#39;Tc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ru&#39;</span><span class="p">,</span> <span class="s1">&#39;Rh&#39;</span><span class="p">,</span> <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;Cd&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Hf&#39;</span><span class="p">,</span> <span class="s1">&#39;Ta&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>  <span class="s1">&#39;Re&#39;</span><span class="p">,</span> <span class="s1">&#39;Os&#39;</span><span class="p">,</span> <span class="s1">&#39;Ir&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">,</span> <span class="s1">&#39;Hg&#39;</span><span class="p">,</span><span class="s1">&#39;Sc&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Ga&#39;</span><span class="p">,</span> <span class="s1">&#39;In&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">}</span>

                <span class="c1">#p elements</span>
                <span class="n">pElm_Nms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span><span class="s1">&#39;Sn&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span><span class="s1">&#39;Si&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Ge&#39;</span><span class="p">,</span><span class="s1">&#39;As&#39;</span><span class="p">,</span><span class="s1">&#39;Br&#39;</span><span class="p">,</span><span class="s1">&#39;Sb&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Tl&#39;</span><span class="p">,</span><span class="s1">&#39;Pb&#39;</span><span class="p">,</span><span class="s1">&#39;Bi&#39;</span><span class="p">,</span><span class="s1">&#39;Po&#39;</span><span class="p">,</span><span class="s1">&#39;At&#39;</span><span class="p">,</span> <span class="s1">&#39;Ba&#39;</span><span class="p">}</span>

                <span class="c1">#s elements</span>
                <span class="n">sElm_Nms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;Sr&#39;</span><span class="p">,</span><span class="s1">&#39;Mg&#39;</span><span class="p">,</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span><span class="s1">&#39;Be&#39;</span><span class="p">,</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s1">&#39;Ca&#39;</span><span class="p">,</span><span class="s1">&#39;Rb&#39;</span><span class="p">,</span><span class="s1">&#39;Cs&#39;</span><span class="p">}</span>


	
		<span class="k">if</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">trM_Nms</span><span class="p">:</span> <span class="k">return</span> <span class="mi">2</span>
		<span class="k">elif</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">pElm_Nms</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
		<span class="k">elif</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">sElm_Nms</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
		
	
	<span class="k">def</span> <span class="nf">gen_input</span><span class="p">(</span><span class="n">oneCalcID</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span><span class="n">nspin</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="c1">#Get cell parameters, arranged as a single string in pattern a1i, a1j, a1k, a2i, a2j, a2k, a3i, a3j, a3k</span>
			<span class="n">a</span><span class="p">,</span><span class="n">cell</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getCellParams</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">oneCalcID</span><span class="p">)</span>
                        <span class="sd">&quot;&quot;&quot;THINK OF A BETTER WAY TO CHECK THIS&quot;&quot;&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">getA</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">2.0</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">getA</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                                <span class="n">cellParaMatrix</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="n">cell</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">cellParaMatrix</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">cell</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                            <span class="k">print</span> <span class="n">e</span>
                        <span class="n">l</span><span class="o">=</span><span class="n">cellParaMatrix</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
			<span class="n">cellParaStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="sd">&quot;&quot;&quot;THINK OF A BETTER WAY TO CHECK THIS&quot;&quot;&quot;</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
				<span class="n">cellParaStr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span><span class="n">cellParaStr</span> <span class="o">+=</span> <span class="s1">&#39; ,&#39;</span>

			<span class="c1">#Get atomic positions in cartesian coordinates, in a single string in pattern x1,y1,z1, x2, y2, z2, ..., xn, yn, zn</span>
			<span class="n">scfOutput</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">oneCalcID</span>
			<span class="n">fin</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">scfOutput</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
			<span class="n">lines</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

			<span class="n">atmPosRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;positions \(alat units\)\n((?:.*\w*\s*tau\(.*\)\s=.*\(.*\)\n)+)&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span> 
			<span class="n">lines1</span> <span class="o">=</span> <span class="n">atmPosRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lines</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">atmPosRegex1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;.*=.*\((.*)\)\n+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

			<span class="n">atmPos</span> <span class="o">=</span> <span class="n">atmPosRegex1</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lines1</span><span class="p">)</span>
			<span class="n">atmPosList</span> <span class="o">=</span> <span class="p">[]</span>

			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atmPos</span><span class="p">:</span><span class="n">atmPosList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
			<span class="n">atmPosStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atmPosList</span><span class="p">)):</span>
			<span class="k">try</span><span class="p">:</span>
		<span class="c1">#Convert fractional atomic coordinates to cartesian coordinates using the lattice vectors (cell parameters)</span>
				<span class="n">atmPosStr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atmPosList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atmPosList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
					<span class="n">atmPosStr</span> <span class="o">+=</span> <span class="s1">&#39; ,&#39;</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>       
			<span class="k">try</span><span class="p">:</span>
				<span class="c1">#Get the list of atom labels arranged as a single string</span>
				<span class="n">atmLblRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;\d+\s+(\w+).*=.*\n+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
				<span class="n">atmLbls</span> <span class="o">=</span> <span class="n">atmLblRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lines1</span><span class="p">)</span>

				<span class="c1">#Strip digits from atom lables</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atmLbls</span><span class="p">)):</span><span class="n">atmLbls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">atmLbls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">)</span>

				<span class="n">atmLblsStr</span><span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">atmLbls</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
				<span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atmLblsStr</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

				<span class="c1">#Get the list of atom species</span>
				<span class="n">atmSpRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;atomic species   valence    mass     pseudopotential\n(?:.*\(.*\)\n)+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
				<span class="n">atmSpList</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">atmSpStrList</span> <span class="o">=</span> <span class="n">atmSpRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lines</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atmSpStrList</span><span class="p">:</span><span class="n">atmSpList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

				<span class="c1">#Get list of orbitals</span>
				<span class="n">projOut</span> <span class="o">=</span> <span class="n">projCalcID</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span>
				<span class="n">fin</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">projOut</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
				<span class="n">proj_lines</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

				<span class="n">inFileList</span> <span class="o">=</span> <span class="p">[]</span>

			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


                <span class="c1">#in the case we want the eff_U from each atom we make a list of the site numbers</span>
                <span class="c1">#and use a slightly different regex to get the l numbers</span>
                <span class="k">if</span> <span class="n">byAtom</span><span class="p">:</span>
                    <span class="n">atmSpList</span><span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">atmPosList</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

		<span class="c1">#For each atomic species</span>
		<span class="k">for</span> <span class="n">atmSp</span> <span class="ow">in</span> <span class="n">atmSpList</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating acbn0 inpufile for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">atmSp</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="c1">#Get orbital type to apply Hubbard correction</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">atmSp</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__scfuj_label_mapping__&#39;</span><span class="p">][</span><span class="n">atmSp</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="n">ql</span> <span class="o">=</span> <span class="n">get_orbital</span><span class="p">(</span><span class="n">atmSp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">))</span>
<span class="c1">#                                print &#39;ql&#39;,ql</span>
                                <span class="k">if</span> <span class="n">byAtom</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>

       				<span class="c1">#Get list of all orbitals of type ql of the same species</span>
                                    <span class="n">eqOrbRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;state #\s*(\d*): atom.*\(</span><span class="si">%s</span><span class="s2">.*\).*\(l=</span><span class="si">%d</span><span class="s2">.*\)\n&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">atmSp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">),</span><span class="n">ql</span><span class="p">),</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="c1">#                                    eqOrbRegex = re.compile(r&quot;state #\s*(\d*): atom.*\(%s.*\).*\(l=%d.*\)\n&quot;%(atmSp,ql),re.MULTILINE)</span>
                                    
                                    <span class="n">eqOrbList</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">eqOrbRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">proj_lines</span><span class="p">)))</span>
                                    <span class="n">red_basis</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eqOrbList</span><span class="p">]</span>

				<span class="c1">#Get ones relevant for hubbard center</span>
                                    <span class="n">eqOrbRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;state #\s*(\d*): atom.*</span><span class="si">%s</span><span class="s2">.*l=</span><span class="si">%d</span><span class="s2">.*\)\n&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">atmSp</span><span class="p">,</span><span class="n">ql</span><span class="p">),</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>

                                    <span class="n">getSpecByAtomRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;state #\s*(?:\d*): atom\s*</span><span class="si">%s</span><span class="s2">\s*\(([a-zA-Z]+)&quot;</span><span class="o">%</span><span class="n">atmSp</span><span class="p">)</span>
                                    <span class="n">speciesFromNum</span> <span class="o">=</span> <span class="n">getSpecByAtomRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">proj_lines</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">ql</span> <span class="o">=</span> <span class="n">get_orbital</span><span class="p">(</span><span class="n">speciesFromNum</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">))</span>

                                    <span class="c1">#Get list of all orbitals of type ql of the same atom</span>
                                    <span class="n">eqOrbRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;state #\s*(\d*): atom.*</span><span class="si">%s</span><span class="s2">.*l=</span><span class="si">%d</span><span class="s2">.*\n&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">speciesFromNum</span><span class="p">,</span><span class="n">ql</span><span class="p">),</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>          
<span class="c1">#                                    eqOrbRegex = re.compile(r&quot;state #\s*(\d*): atom.*%s.*l=%d.*\n&quot;%(speciesFromNum.strip(&#39;0123456789&#39;),ql),re.MULTILINE)          </span>


                                    <span class="n">eqOrbList</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">eqOrbRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">proj_lines</span><span class="p">)))</span>
                                    <span class="n">red_basis</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eqOrbList</span><span class="p">]</span>

				<span class="c1">#Get ones relevant for hubbard center</span>
                                    <span class="n">eqOrbRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;state #\s*(\d*): atom\s*</span><span class="si">%s</span><span class="s2">.*\s*\(\s*l=</span><span class="si">%d</span><span class="s2">.*\n&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">atmSp</span><span class="p">,</span><span class="n">ql</span><span class="p">),</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>          
                              

				<span class="n">eqOrbList</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">eqOrbRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">proj_lines</span><span class="p">)))</span><span class="c1">#;print eqOrbList</span>

				<span class="n">red_basis_for2e</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eqOrbList</span><span class="p">]</span>
				<span class="c1">#Get list of orbitals of type l for one atom of the species</span>
				<span class="n">red_basis_2e</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="n">red_basis_2e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">red_basis_for2e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">red_basis_for2e</span><span class="p">)):</span>
					<span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">red_basis_for2e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="n">red_basis_for2e</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">red_basis_2e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">red_basis_for2e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span><span class="k">break</span>

				<span class="c1">#Create input file for respective species</span>
				<span class="n">infnm</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">oneCalcID</span> <span class="o">+</span> <span class="s2">&quot;_acbn0_infile_</span><span class="si">%s</span><span class="s2">.txt&quot;</span><span class="o">%</span><span class="n">atmSp</span>
				<span class="n">fout</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">infnm</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
				<span class="n">S</span> <span class="o">=</span> <span class="s2">&quot;latvects = &quot;</span> <span class="o">+</span> <span class="n">cellParaStr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>   
				<span class="n">S</span> <span class="o">=</span> <span class="s2">&quot;coords = &quot;</span> <span class="o">+</span> <span class="n">atmPosStr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="n">S</span> <span class="o">=</span> <span class="s2">&quot;atlabels = &quot;</span> <span class="o">+</span> <span class="n">atmLblsStr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;nspin = </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nspin</span><span class="p">)</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;fpath = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">subdir</span><span class="p">)</span>
				<span class="n">outfnm</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">oneCalcID</span> <span class="o">+</span> <span class="s2">&quot;_acbn0_outfile_</span><span class="si">%s</span><span class="s2">.txt&quot;</span><span class="o">%</span><span class="n">atmSp</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;outfile = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">outfnm</span><span class="p">)</span>
				<span class="n">S</span> <span class="o">=</span> <span class="s2">&quot;reduced_basis_dm = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">red_basis</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="n">S</span> <span class="o">=</span> <span class="s2">&quot;reduced_basis_2e = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">red_basis_2e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

				<span class="c1">#Add filename to acbn0 run list</span>
				<span class="n">inFileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">infnm</span><span class="p">)</span>

			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">inFileList</span>
			

	<span class="k">def</span> <span class="nf">run_acbn0</span><span class="p">(</span><span class="n">inputFiles</span><span class="p">):</span>
			
		<span class="k">for</span> <span class="n">infnm</span> <span class="ow">in</span> <span class="n">inputFiles</span><span class="p">:</span>
			
			<span class="n">cmd</span><span class="o">=</span><span class="s2">&quot;python </span><span class="si">%s</span><span class="s2">/acbn0.py </span><span class="si">%s</span><span class="s2"> &gt; /dev/null&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">infnm</span><span class="p">))</span>	
			<span class="k">print</span> <span class="s2">&quot;Starting python acbn0.py </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">infnm</span><span class="p">))</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting python acbn0.py </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">infnm</span><span class="p">)))</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
		
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
			<span class="k">print</span> <span class="s2">&quot;Finished python acbn0.py </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">infnm</span><span class="p">))</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished python acbn0.py </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">infnm</span><span class="p">)))</span>
	<span class="n">acbn0_inFileList</span> <span class="o">=</span> <span class="n">gen_input</span><span class="p">(</span><span class="n">oneCalcID</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span><span class="n">nspin</span><span class="p">)</span>	
	<span class="n">run_acbn0</span><span class="p">(</span><span class="n">acbn0_inFileList</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getU_frmACBN0out"><a class="viewcode-back" href="../scfuj.html#scfuj.getU_frmACBN0out">[docs]</a><span class="k">def</span> <span class="nf">getU_frmACBN0out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">byAtom</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">oneCalcID</span> <span class="o">=</span> <span class="n">ID</span><span class="c1">#oneCalc[&#39;_AFLOWPI_PREFIX_&#39;][1:] </span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span> 

	<span class="c1">#Get species</span>
	<span class="n">inputfile</span> <span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">byAtom</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="n">species</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getPosLabels</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)))</span>
            <span class="n">uvalLogName</span><span class="o">=</span><span class="s1">&#39;_uValLog.log&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
            <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;nat&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">uvalLogName</span><span class="o">=</span><span class="s1">&#39;_uValLog_byAtom.log&#39;</span>
        
	<span class="n">Uvals</span> <span class="o">=</span> <span class="p">{}</span>
                
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="n">species</span><span class="p">:</span>
        	<span class="c1">#Check for acbn0 output in the work directory</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">acbn0_outFile</span> <span class="o">=</span> <span class="n">subdir</span> <span class="o">+</span> <span class="s2">&quot;/_&quot;</span> <span class="o">+</span> <span class="n">oneCalcID</span> <span class="o">+</span> <span class="s2">&quot;_acbn0_outfile_&quot;</span> <span class="o">+</span> <span class="n">isp</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">acbn0_outFile</span><span class="p">):</span>
				<span class="c1">#Get U value from acbn0 output</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">acbn0_outFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
					<span class="n">acbn0_Uval</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;U_eff\s*=\s*([-]*\d+.\d+)&quot;</span><span class="p">,</span><span class="n">lines</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

					<span class="n">Uvals</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acbn0_Uval</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
					<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
					<span class="k">print</span> <span class="n">e</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Uvals</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>

		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">uvalLogName</span><span class="p">))):</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">uvalLogName</span><span class="p">)),</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uValLog</span><span class="p">:</span>
				<span class="n">uValLog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Uvals</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">uvalLogName</span><span class="p">)),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uValLog</span><span class="p">:</span>
				<span class="n">uValLog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Uvals</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">Uvals</span>

</div>
<div class="viewcode-block" id="run"><a class="viewcode-back" href="../scfuj.html#scfuj.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">uThresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nIters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">mixing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>

    <span class="n">temp_calcs</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
	    <span class="n">uThreshDict</span><span class="o">=</span><span class="p">{}</span>
	    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">r&#39;_AFLOWPI_[A-Z][0-9]*_&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                    
                    <span class="n">uThreshDict</span><span class="p">[</span><span class="n">oneCalc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span><span class="o">=</span><span class="n">uThresh</span>
            
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            in the chance that the input file to the frame already has</span>
<span class="sd">            U vals for the species set the initial uvaldict to those </span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">splitInput</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
                <span class="n">spec_order</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">isolated_spec</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spec_order</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">isolated_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>                  
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isolated_spec</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">initial_U</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;Hubbard_U(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                        <span class="n">uThreshDict</span><span class="p">[</span><span class="n">isolated_spec</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">initial_U</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">e</span>

	    <span class="n">loopblock</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>

<span class="s1">uValue = </span><span class="si">%s</span><span class="s1"></span>

<span class="s1">oneCalc, newUvals = AFLOWpi.scfuj.__run(__submitNodeName__,oneCalc,ID,config=configFile,mixing=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">print &quot;New U values &quot;, str(newUvals).strip(&#39;{}&#39;)</span>
<span class="s1">logging.info(&#39;newUvals = {0}&#39;.format(newUvals))</span>
<span class="s1">for key in uValue.keys():</span>

<span class="s1">    try:</span>
<span class="s1">        if abs(uValue[key]-newUvals[key]) &gt; </span><span class="si">%s</span><span class="s1"> and oneCalc[&#39;_SCFUJ_LoopCount_&#39;] != </span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">           logging.info(&quot;scfuj did not converge, starting next iteration&quot;)</span>
<span class="s1">           print &quot;scfuj did not converge, starting next iteration&quot;</span>
<span class="s1">           AFLOWpi.run.__submitJob(ID,oneCalc,__submitNodeName__)</span>
<span class="s1">           sys.exit(0)</span>

<span class="s1">        elif abs(uValue[key]-newUvals[key]) &gt; </span><span class="si">%s</span><span class="s1"> and oneCalc[&#39;_SCFUJ_LoopCount_&#39;] == </span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">           logging.info(&quot;Maximum no. of iterations reached. scfuj did not converge&quot;)</span>
<span class="s1">           print &quot;Maximum no. of iterations reached. scfuj did not converge&quot;</span>
<span class="s1">           sys.exit(0)</span>

<span class="s1">        else:</span>
<span class="s1">           AFLOWpi.scfuj.__get_ham_xml(oneCalc,ID)</span>


<span class="s1">    except Exception,e:</span>
<span class="s1">        AFLOWpi.run._fancy_error_log(e)</span>
<span class="s1">logging.info(&#39;Completed scfuj convergence for final U values = {0}&#39;.format(newUvals))</span>
<span class="s1">print &#39;Completed scfuj convergence for final U values = &#39;,str(newUvals).strip(&#39;{}&#39;)</span>

<span class="s1">&#39;&#39;&#39;</span>  <span class="o">%</span> <span class="p">(</span><span class="n">uThreshDict</span><span class="p">,</span><span class="n">mixing</span><span class="p">,</span><span class="n">uThresh</span><span class="p">,</span><span class="n">nIters</span><span class="p">,</span><span class="n">uThresh</span><span class="p">,</span><span class="n">nIters</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;uValue&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">loopblock</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__findInBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;import sys&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s1">&#39;import sys</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__skeletonRun</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>


</div>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="c1"># def __assignLabels(oneCalc,ID,positions_only=False):</span>

<span class="c1">#     oneCalcOrig=copy.deepcopy(oneCalc)</span>
<span class="c1">#     oneCalc = AFLOWpi.prep.__loadOneCalc(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],oneCalc[&#39;_AFLOWPI_PREFIX_&#39;][1:])</span>
    
<span class="c1">#     inputFileString = oneCalc[&#39;_AFLOWPI_INPUT_&#39;]</span>

<span class="c1">#     availableLetters =  list(string.ascii_uppercase+string.digits)</span>
<span class="c1">#     availableFirstLetters =  list(string.ascii_uppercase)</span>

<span class="c1">#     countNames = [&#39;&#39;.join(x) for x in list(itertools.product(availableLetters,availableLetters))]</span>
<span class="c1">#     inputCalc = AFLOWpi.retr.__splitInput(inputFileString)</span>
<span class="c1">#     labels = AFLOWpi.retr.__getPosLabels(inputFileString)</span>
    
<span class="c1">#     speciesString = inputCalc[&#39;ATOMIC_SPECIES&#39;][&#39;__content__&#39;]</span>
<span class="c1">#     speciesStringSplit=[x for x in speciesString.split(&#39;\n&#39;) if len(x.strip())!=0]</span>
<span class="c1">#     speciesList = sorted(list(set(AFLOWpi.retr.__getPosLabels(inputFileString))))</span>
<span class="c1">#     speciesMapping=OrderedDict()</span>

<span class="c1">#     for items in range(len(speciesList)):</span>
<span class="c1">#         speciesMapping[speciesList[items]]=[availableFirstLetters[items],0,[]]</span>

    
<span class="c1">#     labelMapping=OrderedDict()</span>
<span class="c1">#     positionString = inputCalc[&#39;ATOMIC_POSITIONS&#39;][&#39;__content__&#39;]</span>
<span class="c1">#     positionStringSplit = [x for x in positionString.split(&#39;\n&#39;) if len(x.strip())!=0]</span>

<span class="c1">#     for position in range(len(positionStringSplit)):</span>
<span class="c1">#         posSplit=positionStringSplit[position].split()</span>
<span class="c1">#         species=posSplit[0].strip()</span>
<span class="c1">#         count = speciesMapping[species][1]</span>
<span class="c1">#         newLabel = speciesMapping[species][0]+countNames[count]</span>
        
<span class="c1">#         labelMapping[newLabel]=species</span>
<span class="c1">#         speciesMapping[species][2].append(newLabel)</span>
<span class="c1">#         positionStringSplit[position]=re.sub(species,newLabel,positionStringSplit[position])</span>
<span class="c1">#         speciesMapping[species][1]+=1</span>



<span class="c1">#     positionStringNew = &#39;\n&#39;.join(positionStringSplit)</span>

<span class="c1">#     inputCalc[&#39;ATOMIC_POSITIONS&#39;][&#39;__content__&#39;]=positionStringNew</span>

<span class="c1">#     newSpeciesStringList=[]</span>
<span class="c1">#     for item1 in range(len(speciesStringSplit)):</span>
<span class="c1">#         splitSpecies = speciesStringSplit[item1].split()</span>
<span class="c1">#         species = splitSpecies[0].strip()</span>
<span class="c1">#         mapList = speciesMapping[species][2]</span>

<span class="c1">#         for items in mapList:</span>
            
<span class="c1">#             newSpeciesEntry = speciesStringSplit[item1].split()</span>
<span class="c1">#             newSpeciesEntry[0]=items</span>
<span class="c1">#             newSpeciesStringList.append(&#39; &#39;.join(newSpeciesEntry))</span>

<span class="c1">#     newSpeciesString = &#39;\n&#39;.join(newSpeciesStringList)</span>
<span class="c1">#     newNTYP = len(newSpeciesStringList)</span>
<span class="c1">#     inputCalc[&#39;ATOMIC_SPECIES&#39;][&#39;__content__&#39;] = newSpeciesString</span>
<span class="c1">#     inputCalc[&#39;&amp;system&#39;][&#39;ntyp&#39;] = &#39;%s&#39; % newNTYP</span>
<span class="c1">#     newInputString=AFLOWpi.retr.__joinInput(inputCalc)</span>

<span class="c1">#     oneCalc[&#39;_AFLOWPI_INPUT_&#39;] = newInputString</span>



<span class="c1">#     oneCalc[&#39;__scfuj_label_mapping__&#39;]=labelMapping</span>
<span class="c1">#     oneCalcOrig[&#39;__scfuj_label_mapping__&#39;]=labelMapping</span>

<span class="c1">#     with open(os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;%s.in&#39; % oneCalc[&#39;_AFLOWPI_PREFIX_&#39;][1:]),&#39;w&#39;) as inputFile:</span>
<span class="c1">#         inputFile.write(oneCalc[&#39;_AFLOWPI_INPUT_&#39;])</span>
<span class="c1">#     with open(os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;%s.in&#39; % ID),&#39;w&#39;) as inputFile:</span>
<span class="c1">#         inputFile.write(oneCalc[&#39;_AFLOWPI_INPUT_&#39;])</span>

<span class="c1"># #        AFLOWpi.prep.__saveOneCalc(oneCalc,oneCalc[&#39;_AFLOWPI_PREFIX_&#39;][1:])</span>
<span class="c1">#         AFLOWpi.prep.__saveOneCalc(oneCalc,ID)</span>

<span class="c1">#     oneCalcOrig[&#39;_AFLOWPI_INPUT_&#39;]=newInputString</span>
<span class="c1">#     return oneCalcOrig</span>


<span class="k">def</span> <span class="nf">__run</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">mixing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
	<span class="n">execPrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
	<span class="n">execPostfix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">oneCalcID</span> <span class="o">=</span> <span class="n">ID</span>


        <span class="k">def</span> <span class="nf">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.out&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">errorList</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;from (.*) : error #.*\n&#39;</span><span class="p">,</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errorList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>        
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2">.out -- ABORTING ACBN0 LOOP&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">print</span> <span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2">.out -- ABORTING ACBN0 LOOP&quot;</span><span class="o">%</span><span class="n">ID</span>                    
                <span class="k">raise</span> <span class="ne">SystemExit</span>



        <span class="k">if</span> <span class="s1">&#39;__runList__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>

            
	<span class="k">if</span> <span class="n">config</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;forced config </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span>

	<span class="k">else</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;espresso&#39;</span>


        <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
	<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span>

        <span class="k">if</span> <span class="s1">&#39;scf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">npool</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__get_pool_num</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>        

                <span class="k">if</span> <span class="n">npool</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;npool[s]*\s*(?:\d*)&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">execPostfixPrime</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;npool[s]*\s*(?:\d*)&#39;</span><span class="p">,</span><span class="s1">&#39;npool </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">npool</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">execPostfixPrime</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="c1">##################################################################################################################</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>


            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            

            <span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="o">=</span> <span class="n">nscf_nosym_noinv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>	



        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;if we are restarting from a job killed from going walltime </span>
<span class="sd">            try to load ID_nscf and if we can&#39;t then just make a new one&#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nscf_ID</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_nscf&#39;</span> <span class="o">%</span> <span class="n">ID</span>
                <span class="n">nscf_calc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">nscf_ID</span><span class="p">)</span>                
                <span class="sd">&#39;&#39;&#39;we have to make sure nscf step has the correct walltime and start time if it&#39;s a restart&#39;&#39;&#39;</span>
                <span class="n">nscf_calc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="o">=</span> <span class="n">nscf_nosym_noinv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>	

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



<span class="c1">##################################################################################################################</span>
        <span class="k">if</span> <span class="s1">&#39;nscf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>


            <span class="k">try</span><span class="p">:</span>
                <span class="n">npool</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__get_pool_num</span><span class="p">(</span><span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">)</span>        

                <span class="k">if</span> <span class="n">npool</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;npool\s*(?:\d+)&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">execPostfixPrime</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;npool\s*(?:\d+)&#39;</span><span class="p">,</span><span class="s1">&#39;npool </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">npool</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">execPostfixPrime</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

            <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">nscf_ID</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nscf&#39;</span><span class="p">)</span>
	
<span class="c1">##################################################################################################################</span>
        <span class="n">pdos_calc</span><span class="p">,</span><span class="n">pdos_ID</span> <span class="o">=</span> <span class="n">projwfc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;northo&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">):</span>
            <span class="n">execPostfix</span><span class="o">+=</span><span class="s1">&#39; -northo 1&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;pdos&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>
            <span class="n">pdosPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;enginedir&#39;</span><span class="p">),</span><span class="s1">&#39;projwfc.x&#39;</span><span class="p">)</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">pdos_calc</span><span class="p">,</span><span class="n">pdos_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="s1">&#39;projwfc.x&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="n">pdosPath</span><span class="p">)</span>
<span class="c1">#############</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pdos&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">pdos_ID</span><span class="p">)</span>

	<span class="n">eFermi</span><span class="o">=</span><span class="mf">0.0</span>

	<span class="n">eFermi</span><span class="o">=</span><span class="mf">10.0</span>

        <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">nscf_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
        
<span class="c1">#        nbnd = int(splitInput[&#39;&amp;system&#39;][&#39;nbnd&#39;])</span>

        
        <span class="k">if</span> <span class="s1">&#39;bands&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>
            <span class="n">want_dict</span> <span class="o">=</span> <span class="n">WanT_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">eShift</span><span class="o">=</span><span class="n">eFermi</span><span class="p">,</span><span class="n">nbnd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">want_ID</span><span class="p">,</span><span class="n">want_calc</span> <span class="ow">in</span> <span class="n">want_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">want_calc</span><span class="p">,</span><span class="n">want_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./want_bands.x&#39;</span> <span class="p">)</span>

            
            <span class="sd">&#39;&#39;&#39;in case we&#39;re working in local scratch&#39;&#39;&#39;</span>            
<span class="c1">#           AFLOWpi.prep.__from_local_scratch(oneCalc,ID,ext_list=[&#39;ham&#39;,&#39;wan&#39;,&#39;space&#39;])</span>

            <span class="k">for</span> <span class="n">want_ID</span><span class="p">,</span><span class="n">want_calc</span> <span class="ow">in</span> <span class="n">want_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">want_ID</span><span class="p">)</span>


            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bands&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Will need to be filled in for the executable name with whatever wanT executable is called </span>
<span class="sd">            and that executable needs to be moved to the calculation directory tree before this is called</span>
<span class="sd">            &#39;&#39;&#39;</span>

<span class="c1">############</span>
<span class="c1">##################################################################################################################</span>

        <span class="c1">#Get new U values from acbn0.py </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acbn0</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span> <span class="n">pdos_ID</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>

<span class="c1">#        acbn0(oneCalc, pdos_ID,byAtom=True)</span>
<span class="c1">#        getU_frmACBN0out(oneCalc,ID,byAtom=True)</span>
        <span class="n">newUvals</span> <span class="o">=</span> <span class="n">getU_frmACBN0out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="c1">#slight to help with oscillation</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">old_U</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_UVALS_&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">old_U</span> <span class="o">=</span> <span class="n">newUvals</span>

        <span class="n">mixing</span><span class="o">=</span><span class="mf">0.10</span>
        <span class="k">for</span> <span class="n">spec</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">old_U</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">newUvals</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">=</span><span class="n">mixing</span><span class="o">*</span><span class="n">old_U</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">mixing</span><span class="p">)</span><span class="o">*</span><span class="n">newUvals</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>


        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_UVALS_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newUvals</span>

        <span class="c1">#Update Uvals</span>
        <span class="n">oneCalc</span> <span class="o">=</span> <span class="n">updateUvals</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span> <span class="n">newUvals</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span>
	<span class="c1">#update Uvals in _&lt;ID&gt;.py</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyVarVal</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;uValue&#39;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">newUvals</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span>
        
	<span class="n">inputfile</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
        <span class="k">with</span>  <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_inputfile</span><span class="p">:</span>
		<span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;make sure the input is set to &#39;from_scratch&#39;&#39;&#39;</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;restart_mode&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;from_scratch&#39;&quot;</span><span class="p">)</span>

	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	return the new uVals to the main script where the </span>
<span class="sd">        conditional statement will decide to rerun with </span>
<span class="sd">        the new U vals as input or keep going on with the </span>
<span class="sd">        rest of the script.</span>
<span class="sd">	&#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39;save one calc with the full list so next iteration it runs everything fresh&#39;&#39;&#39;</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_SCFUJ_LoopCount_&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_SCFUJ_LoopCount_&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span>

        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;SCFUJ Iteration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_SCFUJ_LoopCount_&#39;</span><span class="p">]</span>

<span class="c1">#        try:</span>
<span class="c1">#            &#39;&#39;&#39;check for uval oscillation and if it&#39;s happening end the loop&#39;&#39;&#39;</span>
<span class="c1">#            if checkOscillation(ID,new_oneCalc)==True:</span>
<span class="c1">#                new_oneCalc[&#39;__status__&#39;][&#39;Error&#39;]=&#39;U Value Oscillation&#39;</span>
<span class="c1">#                AFLOWpi.prep.__saveOneCalc(new_OneCalc,ID)</span>
<span class="c1">#                raise SystemExit</span>
<span class="c1">#        except Exception,e:</span>
<span class="c1">#            AFLOWpi.run._fancy_error_log(e)</span>
            


        <span class="sd">&#39;&#39;&#39;remove all the extra .oneCalc and input files files generated to start fresh&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nscf&#39;</span><span class="p">,</span><span class="s1">&#39;pdos&#39;</span><span class="p">,</span><span class="s1">&#39;WanT_bands&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;./_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.oneCalc&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">stage</span><span class="p">))</span>
<span class="c1">#                os.remove(&#39;./%s_%s.in&#39;%(ID,stage))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__oneUpdateStructs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">override_lock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">__bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">yLim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;acbn0_TB&#39;</span><span class="p">,</span><span class="n">tight_banding</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>


        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span> <span class="n">newUvals</span>


<span class="k">def</span> <span class="nf">__get_ham_xml</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="n">tempdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span> <span class="n">__get_tempdir</span><span class="p">()</span>

    <span class="n">wantdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;wantdir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">wantdir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
        <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
        <span class="n">wantdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">wantdir</span><span class="p">)</span>

    <span class="n">iotk_exe</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wantdir</span><span class="p">,</span><span class="s1">&#39;iotk&#39;</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">iotk_exe</span>
    <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39; --iotk-exe </span><span class="si">%s</span><span class="s1">.x&#39;</span> <span class="o">%</span> <span class="n">iotk_exe</span>
    <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39; convert </span><span class="si">%s</span><span class="s1">/*.ham ./RHAM_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.xml&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tempdir</span><span class="p">,</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getStoicName</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">),</span><span class="n">ID</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<div class="viewcode-block" id="checkOscillation"><a class="viewcode-back" href="../scfuj.html#scfuj.checkOscillation">[docs]</a><span class="k">def</span> <span class="nf">checkOscillation</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">uThresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_uValLog.log&#39;</span><span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uValLogFile</span><span class="p">:</span>
        <span class="n">uValLogString</span><span class="o">=</span><span class="n">uValLogFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">iterationList</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">uValLogString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">iterationDictList</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">fileString</span> <span class="ow">in</span> <span class="n">iterationList</span><span class="p">:</span>
            <span class="n">iterationDictList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">fileString</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterationDictList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">iterationDictList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">bySpecies</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iterationDictList</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">U</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)):</span>
            <span class="n">uVal</span> <span class="o">=</span> <span class="n">iterationDictList</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">species</span><span class="p">[</span><span class="n">U</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bySpecies</span><span class="p">[</span><span class="n">species</span><span class="p">[</span><span class="n">U</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uVal</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">bySpecies</span><span class="p">[</span><span class="n">species</span><span class="p">[</span><span class="n">U</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="n">uVal</span><span class="p">]</span>
<span class="c1">#    if bySpecies</span>

    <span class="n">bySpeciesDiff</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>            
    <span class="k">for</span> <span class="n">species</span><span class="p">,</span><span class="n">uVals</span> <span class="ow">in</span> <span class="n">bySpecies</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bySpeciesDiff</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uVals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">uVals</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">bySpeciesDiff</span><span class="p">[</span><span class="n">species</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">species</span><span class="p">,</span><span class="n">diff</span> <span class="ow">in</span> <span class="n">bySpeciesDiff</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">diff</span><span class="o">!=</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">diff</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>





<span class="c1">############</span>
<span class="c1">##################################################################################################################</span>

        
<span class="c1"># def orderTest(diff):</span>
<span class="c1">#     for i in range(len(diff)-1):</span>
<span class="c1">#         if diff[i] &lt; diff[i+1] and diff[i+1] &gt; 0.1:</span>
<span class="c1">#             return False</span>
<span class="c1">#     return True</span>

<span class="c1"># def convTest(Diff=[],uThresh = 0.001):</span>
<span class="c1">#         for i in Diff:</span>
<span class="c1">#             if orderTest(i[-3:]) == False:</span>
<span class="c1">#                 return False, False</span>
<span class="c1">#             elif orderTest(i[-3:]) and i[-1] &gt; uThresh:</span>
<span class="c1">#                 return True, False</span>
<span class="c1">#             elif orderTest(i[-3:])== False and i[-1] &lt; uThresh:</span>
<span class="c1">#                 return False,True</span>
<span class="c1">#         return True, True</span>
</div>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span> 
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>

<div class="viewcode-block" id="transport_prep"><a class="viewcode-back" href="../scfuj.html#scfuj.transport_prep">[docs]</a><span class="k">def</span> <span class="nf">transport_prep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets up the environment do do scf-&gt;nscf-&gt;projwfc to get overlap for transport calcs</span>
<span class="sd">        &quot;&quot;&quot;</span>


	<span class="n">wantdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;wantdir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">wantdir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">wantdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">wantdir</span><span class="p">)</span>

	<span class="n">wantBandsExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wantdir</span><span class="p">,</span><span class="s1">&#39;bands.x&#39;</span><span class="p">)</span>
	<span class="n">wantDOSExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wantdir</span><span class="p">,</span><span class="s1">&#39;dos.x&#39;</span><span class="p">)</span>
	<span class="n">wantEpsilonExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wantdir</span><span class="p">,</span><span class="s1">&#39;epsilon.x&#39;</span><span class="p">)</span>



        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wantBandsExec</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;WanT bands executable not found. Check your config file to make sure wantdir path is correct and that bands.x is in that directory..Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;WanT bands executable not found. Check your config file to make sure wantdir path is correct and that bands.x is in that directory..Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>


	<span class="n">wantdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;wantdir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">wantdir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">wantdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">wantdir</span><span class="p">)</span>

	<span class="n">espressodir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;enginedir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">espressodir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">espressodir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">espressodir</span><span class="p">)</span>

	<span class="n">pdosExec</span> <span class="o">=</span> <span class="s1">&#39;projwfc.x&#39;</span>
	<span class="n">pdosExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">espressodir</span><span class="p">,</span><span class="n">pdosExec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pdosExec</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;ProjectWFC executable not found. Check your config file to make sure enginedir path is correct and that projwfc.x is in that directory..Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ProjectWFC executable not found. Check your config file to make sure enginedir path is correct and that projwfc.x is in that directory..Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
	<span class="n">dosExec</span> <span class="o">=</span> <span class="s1">&#39;dos.x&#39;</span>
	<span class="n">dosExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">espressodir</span><span class="p">,</span><span class="n">dosExec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dosExec</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;DOS executable not found. Check your config file to make sure enginedir path is correct and that dos.x is in that directory..Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;DOS executable not found. Check your config file to make sure enginedir path is correct and that dos.x is in that directory..Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
	<span class="n">scfExec</span> <span class="o">=</span> <span class="s1">&#39;pw.x&#39;</span>
	<span class="n">scfExec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">espressodir</span><span class="p">,</span><span class="n">scfExec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">scfExec</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;SCF executable not found. Check your config file to make sure enginedir path is correct and that pw.x is in that directory..Exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;SCF executable not found. Check your config file to make sure enginedir path is correct and that pw.x is in that directory..Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
        


	<span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">wantBandsExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">rename</span><span class="o">=</span><span class="s1">&#39;want_bands.x&#39;</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">pdosExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">dosExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">scfExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">wantBandsExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">rename</span><span class="o">=</span><span class="s1">&#39;want_bands.x&#39;</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">pdosExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">dosExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">scfExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="c1">###copy epsilon.x</span>
	<span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">wantEpsilonExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">rename</span><span class="o">=</span><span class="s1">&#39;want_epsilon.x&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">wantEpsilonExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">rename</span><span class="o">=</span><span class="s1">&#39;want_epsilon.x&#39;</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="c1">###copy WanT dos.x</span>
	<span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">wantDOSExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">rename</span><span class="o">=</span><span class="s1">&#39;want_dos.x&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">wantDOSExec</span><span class="p">,{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">rename</span><span class="o">=</span><span class="s1">&#39;want_dos.x&#39;</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>




</div>
<div class="viewcode-block" id="WanT_dos"><a class="viewcode-back" href="../scfuj.html#scfuj.WanT_dos">[docs]</a><span class="k">def</span> <span class="nf">WanT_dos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">eShift</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span><span class="n">energy_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">]):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Make input files for  WanT bands calculation</span>

<span class="sd">		Arguments:</span>
<span class="sd">        	 - calc_copy -- dictionary of dictionaries of calculations</span>
<span class="sd">	&#39;&#39;&#39;</span>
	<span class="n">output_calc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__get_tempdir</span><span class="p">()</span>
	<span class="n">calc_copy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
	<span class="n">subdir</span> <span class="o">=</span> <span class="n">calc_copy</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
	<span class="n">nspin</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">chkSpinCalc</span><span class="p">(</span><span class="n">calc_copy</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__prefixFromInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>
                
        <span class="k">if</span> <span class="n">temp_dir</span><span class="o">!=</span><span class="s1">&#39;./&#39;</span><span class="p">:</span>
            <span class="n">subdir</span><span class="o">=</span><span class="n">temp_dir</span>


	<span class="n">nbnds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__num_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">))</span>
		       

        <span class="c1">###############################</span>
        <span class="c1">###############################</span>
        <span class="c1">#hardcode for now </span>
        <span class="c1">#hardcode for now </span>
	<span class="n">temp_ev</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span><span class="o">/</span><span class="mf">11604.505</span>
        <span class="n">nk1</span>   <span class="o">=</span>  <span class="mi">40</span>
        <span class="n">nk2</span>   <span class="o">=</span>  <span class="mi">40</span>
        <span class="n">nk3</span>   <span class="o">=</span>  <span class="mi">40</span>
        <span class="n">emin</span>  <span class="o">=</span>  <span class="n">energy_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">emax</span>  <span class="o">=</span>  <span class="n">energy_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nbnd</span>  <span class="o">=</span>  <span class="n">nbnds</span>
        <span class="n">delta</span> <span class="o">=</span>  <span class="mf">0.2</span>
        <span class="n">ne</span>    <span class="o">=</span>  <span class="mi">2000</span>
        <span class="c1">#hardcode for now </span>
        <span class="c1">#hardcode for now </span>
        <span class="c1">###############################</span>
        <span class="c1">###############################</span>
	<span class="n">inputfile</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; &amp;INPUT							  </span>
<span class="s2">prefix 		= &#39;</span><span class="si">%s</span><span class="s2">&#39; 		  	                        </span>
<span class="s2">postfix 	= </span><span class="se">\&#39;</span><span class="s2">_WanT</span><span class="se">\&#39;</span><span class="s2">		        </span>
<span class="s2">work_dir	= </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">		 </span>
<span class="s2">datafile_dft	= </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.save/atomic_proj.dat</span><span class="se">\&#39;</span><span class="s2">	 </span>
<span class="s2">nk(1)           = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">nk(2)           = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">nk(3)           = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">emin            = </span><span class="si">%f</span><span class="s2"></span>
<span class="s2">emax            = </span><span class="si">%f</span><span class="s2"></span>
<span class="s2">temperature     = </span><span class="si">%f</span><span class="s2"></span>
<span class="s2">atmproj_nbnd    = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">ne              = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">delta           = </span><span class="si">%f</span><span class="s2"></span>
<span class="s2">!projdos         = .TRUE.</span>
<span class="s2">do_orthoovp	= .TRUE.</span>
<span class="s2">atmproj_sh      = </span><span class="si">%f</span><span class="s2">                         </span>
<span class="s2">do_boltzmann_conductivity = .TRUE.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">nk1</span><span class="p">,</span><span class="n">nk2</span><span class="p">,</span><span class="n">nk3</span><span class="p">,</span><span class="n">emin</span><span class="p">,</span><span class="n">emax</span><span class="p">,</span><span class="n">temp_ev</span><span class="p">,</span><span class="n">nbnd</span><span class="p">,</span><span class="n">ne</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">eShift</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout	      = &#39;</span><span class="si">%s</span><span class="s2">_WanT_dos_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout2        = &#39;</span><span class="si">%s</span><span class="s2">_WanT_cond_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout3        = &#39;</span><span class="si">%s</span><span class="s2">_WanT_seebeck_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout4        = &#39;</span><span class="si">%s</span><span class="s2">_WanT_sigma_seebeck_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout5        = &#39;</span><span class="si">%s</span><span class="s2">_WanT_kappa_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>		
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout6        = &#39;</span><span class="si">%s</span><span class="s2">_WanT_ZetaT_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">/ </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="c1"># Insert k-path </span>
<span class="c1">#		inputfile += kpathStr</span>

		

		<span class="n">calc_label</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_dos&quot;</span>
		
	        <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
	        <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	        <span class="n">output_calc</span> <span class="o">=</span> <span class="n">calc_copy</span>
	        <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>

		<span class="n">single_output_calc</span> <span class="o">=</span> <span class="p">{</span><span class="n">calc_label</span><span class="p">:</span><span class="n">output_calc</span><span class="p">}</span>

		<span class="k">return</span> <span class="n">single_output_calc</span>

	<span class="k">else</span><span class="p">:</span>
		<span class="n">inputfile1</span> <span class="o">=</span> <span class="n">inputfile</span>

		<span class="c1">#Create two input files for spin-up and spin-down components.</span>
		<span class="n">inputfile</span> <span class="o">+=</span>  <span class="s2">&quot;&quot;&quot;fileout = &#39;</span><span class="si">%s</span><span class="s2">_WanT_dos_up_</span><span class="si">%s</span><span class="s2">K.dat&#39;   </span><span class="se">\n</span><span class="s2">spin_component	= &quot;up&quot;  </span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>  <span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout2  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_cond_up_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout3  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_seebeck_up_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout4  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_sigma_seebeck_up_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout5  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_kappa_up_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>		
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout6  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_ZetaT_up_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2"> / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>

		<span class="n">inputfile1</span> <span class="o">+=</span>  <span class="s2">&quot;&quot;&quot;fileout = &#39;</span><span class="si">%s</span><span class="s2">_WanT_dos_down_</span><span class="si">%s</span><span class="s2">K.dat&#39;   </span><span class="se">\n</span><span class="s2">spin_component	= &quot;down&quot;  </span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>  <span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;fileout2  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_cond_down_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;fileout3  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_seebeck_down_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;fileout4  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_sigma_seebeck_down_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;fileout5  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_kappa_down_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>		
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;fileout6  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_ZetaT_down_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2"> / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>




		<span class="c1">#Insert k-path</span>
<span class="c1">#		inputfile += kpathStr</span>
<span class="c1">#		inputfile1 += kpathStr</span>

                <span class="n">calc_label_up</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_dos_up&quot;</span> 
                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label_up</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">output_calc_up</span><span class="o">=</span> <span class="n">calc_copy</span>
                <span class="n">output_calc_up</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>


                <span class="n">calc_label_down</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_dos_down&quot;</span> 
                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label_down</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile1</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">output_calc_down</span> <span class="o">=</span> <span class="n">calc_copy</span>
                <span class="n">output_calc_down</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>


		<span class="n">output_calc</span> <span class="o">=</span> <span class="p">{</span><span class="n">calc_label_up</span><span class="p">:</span><span class="n">output_calc_up</span><span class="p">,</span> <span class="n">calc_label_down</span><span class="p">:</span><span class="n">output_calc_down</span><span class="p">}</span>		
		<span class="k">return</span> <span class="n">output_calc</span>


<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
<span class="c1">###############################################################################################################################</span>
</div>
<div class="viewcode-block" id="WanT_epsilon"><a class="viewcode-back" href="../scfuj.html#scfuj.WanT_epsilon">[docs]</a><span class="k">def</span> <span class="nf">WanT_epsilon</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">eShift</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span><span class="n">energy_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">12.5</span><span class="p">]):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Make input files for  WanT bands calculation</span>

<span class="sd">		Arguments:</span>
<span class="sd">        	 - calc_copy -- dictionary of dictionaries of calculations</span>
<span class="sd">	&#39;&#39;&#39;</span>
	<span class="n">output_calc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__get_tempdir</span><span class="p">()</span>
	<span class="n">calc_copy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
	<span class="n">subdir</span> <span class="o">=</span> <span class="n">calc_copy</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
	<span class="n">nspin</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">chkSpinCalc</span><span class="p">(</span><span class="n">calc_copy</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__prefixFromInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>
                
        <span class="k">if</span> <span class="n">temp_dir</span><span class="o">!=</span><span class="s1">&#39;./&#39;</span><span class="p">:</span>
            <span class="n">subdir</span><span class="o">=</span><span class="n">temp_dir</span>

	<span class="n">nbnds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__num_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">))</span>

        <span class="c1">###############################</span>
        <span class="c1">###############################</span>
        <span class="c1">#hardcode for now </span>
        <span class="c1">#hardcode for now </span>
	<span class="n">temp_ev</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span><span class="o">/</span><span class="mf">11604.505</span>
        <span class="n">nk1</span>   <span class="o">=</span>  <span class="mi">40</span>
        <span class="n">nk2</span>   <span class="o">=</span>  <span class="mi">40</span>
        <span class="n">nk3</span>   <span class="o">=</span>  <span class="mi">40</span>
        <span class="n">emin</span>  <span class="o">=</span>  <span class="n">energy_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">emax</span>  <span class="o">=</span>  <span class="n">energy_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nbnd</span>  <span class="o">=</span>  <span class="n">nbnds</span>
        <span class="n">delta</span> <span class="o">=</span>  <span class="mf">0.2</span>
        <span class="n">ne</span>    <span class="o">=</span>  <span class="mi">1000</span>
        <span class="c1">#hardcode for now </span>
        <span class="c1">#hardcode for now </span>
        <span class="c1">###############################</span>
        <span class="c1">###############################</span>
	<span class="n">inputfile</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; &amp;INPUT							  </span>
<span class="s2">prefix 		= &#39;</span><span class="si">%s</span><span class="s2">&#39; 		  	                        </span>
<span class="s2">postfix 	= </span><span class="se">\&#39;</span><span class="s2">_WanT</span><span class="se">\&#39;</span><span class="s2">		        </span>
<span class="s2">work_dir	= </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">		 </span>
<span class="s2">datafile_dft	= </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.save/atomic_proj.dat</span><span class="se">\&#39;</span><span class="s2">	 </span>
<span class="s2">nk(1)           = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">nk(2)           = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">nk(3)           = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">emin            = </span><span class="si">%f</span><span class="s2"></span>
<span class="s2">emax            = </span><span class="si">%f</span><span class="s2"></span>
<span class="s2">temperature     = </span><span class="si">%f</span><span class="s2"></span>
<span class="s2">atmproj_nbnd    = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">ne              = </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">delta           = </span><span class="si">%f</span><span class="s2"></span>
<span class="s2">do_orthoovp	= .TRUE.</span>
<span class="s2">atmproj_sh      = </span><span class="si">%f</span><span class="s2">                         </span>

<span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span><span class="n">subdir</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">nk1</span><span class="p">,</span><span class="n">nk2</span><span class="p">,</span><span class="n">nk3</span><span class="p">,</span><span class="n">emin</span><span class="p">,</span><span class="n">emax</span><span class="p">,</span><span class="n">temp_ev</span><span class="p">,</span><span class="n">nbnd</span><span class="p">,</span><span class="n">ne</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">eShift</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout	      = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_imag_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout2	      = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_real_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout3	      = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_eels_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">/ </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="c1"># Insert k-path </span>
<span class="c1">#		inputfile += kpathStr</span>

		<span class="n">calc_label</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_epsilon&quot;</span>
		
	        <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
	        <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	        <span class="n">output_calc</span> <span class="o">=</span> <span class="n">calc_copy</span>
	        <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>

		<span class="n">single_output_calc</span> <span class="o">=</span> <span class="p">{</span><span class="n">calc_label</span><span class="p">:</span><span class="n">output_calc</span><span class="p">}</span>

		<span class="k">return</span> <span class="n">single_output_calc</span>

	<span class="k">else</span><span class="p">:</span>
		<span class="n">inputfile1</span> <span class="o">=</span> <span class="n">inputfile</span>
		<span class="c1">#Create two input files for spin-up and spin-down components.</span>

		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;fileout = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_imag_up_</span><span class="si">%s</span><span class="s2">K.dat&#39; </span><span class="se">\n</span><span class="s2">spin_component	= &quot;up&quot;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>  <span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout2  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_real_up_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile</span> <span class="o">+=</span> <span class="s2">&quot;fileout3  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_eels_up_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">/ </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>


		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;fileout = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_imag_down_</span><span class="si">%s</span><span class="s2">K.dat&#39; </span><span class="se">\n</span><span class="s2">spin_component	= &quot;down&quot;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>  <span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;fileout2  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_real_down_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>
		<span class="n">inputfile1</span> <span class="o">+=</span> <span class="s2">&quot;fileout3  = &#39;</span><span class="si">%s</span><span class="s2">_WanT_epsilon_eels_down_</span><span class="si">%s</span><span class="s2">K.dat&#39;</span><span class="se">\n</span><span class="s2">/ </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span>



		<span class="c1">#Insert k-path</span>
<span class="c1">#		inputfile += kpathStr</span>
<span class="c1">#		inputfile1 += kpathStr</span>

                <span class="n">calc_label_up</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_epsilon_up&quot;</span> 
                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label_up</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">output_calc_up</span><span class="o">=</span> <span class="n">calc_copy</span>
                <span class="n">output_calc_up</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>


                <span class="n">calc_label_down</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;_WanT_epsilon_down&quot;</span> 
                <span class="n">a</span> <span class="o">=</span> <span class="n">calc_label_down</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
                <span class="n">new_inputfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">new_inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputfile1</span><span class="p">)</span>
	        <span class="n">new_inputfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">output_calc_down</span> <span class="o">=</span> <span class="n">calc_copy</span>
                <span class="n">output_calc_down</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">output_calc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>


		<span class="n">output_calc</span> <span class="o">=</span> <span class="p">{</span><span class="n">calc_label_up</span><span class="p">:</span><span class="n">output_calc_up</span><span class="p">,</span> <span class="n">calc_label_down</span><span class="p">:</span><span class="n">output_calc_down</span><span class="p">}</span>		
		<span class="k">return</span> <span class="n">output_calc</span>



</div>
<div class="viewcode-block" id="run_transport"><a class="viewcode-back" href="../scfuj.html#scfuj.run_transport">[docs]</a><span class="k">def</span> <span class="nf">run_transport</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">run_scf</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">run_transport_prep</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">run_bands</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">epsilon</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>

	<span class="n">execPrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
	<span class="n">execPostfix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">oneCalcID</span> <span class="o">=</span> <span class="n">ID</span>

        <span class="k">def</span> <span class="nf">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.out&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">errorList</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;from (.*) : error #.*\n&#39;</span><span class="p">,</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errorList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;zmat_hdiag&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">errorList</span><span class="p">:</span>        
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2">.out -- ABORTING ACBN0 LOOP&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">print</span> <span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2">.out -- ABORTING ACBN0 LOOP&quot;</span><span class="o">%</span><span class="n">ID</span>                    
                <span class="k">raise</span> <span class="ne">SystemExit</span>






        <span class="k">if</span> <span class="s1">&#39;__runList__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
<span class="c1">#            if run_scf==False:</span>
<span class="c1">#                oneCalc[&#39;__runList__&#39;]=[&#39;scf&#39;]</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">run_transport_prep</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
			<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="s1">&#39;nscf&#39;</span><span class="p">,</span><span class="s1">&#39;pdos&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">run_bands</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
			<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bands&#39;</span><span class="p">)</span>
	    
        
        <span class="n">config</span><span class="o">=</span><span class="bp">None</span>
	<span class="k">if</span> <span class="n">config</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;forced config </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span>

	<span class="k">else</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


	<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;espresso&#39;</span>


        <span class="n">subdir</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
	<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span>

        <span class="k">if</span> <span class="s1">&#39;scf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">npool</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__get_pool_num</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>        

                <span class="k">if</span> <span class="n">npool</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;npool[s]*\s*(?:\d*)&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">execPostfixPrime</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;npool[s]*\s*(?:\d*)&#39;</span><span class="p">,</span><span class="s1">&#39;npool </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">npool</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span>
              <span class="c1">#          logging.debug(execPostfixPrime)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="c1">##################################################################################################################</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>


            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">nscf_nosym_noinv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>	

        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;if we are restarting from a job killed from going walltime </span>
<span class="sd">            try to load ID_nscf and if we can&#39;t then just make a new one&#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nscf_ID</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_nscf&#39;</span> <span class="o">%</span> <span class="n">ID</span>
                <span class="n">nscf_calc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">nscf_ID</span><span class="p">)</span>                
                <span class="sd">&#39;&#39;&#39;we have to make sure nscf step has the correct walltime and start time if it&#39;s a restart&#39;&#39;&#39;</span>
                <span class="n">nscf_calc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">nscf_nosym_noinv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>	

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="c1">##################################################################################################################</span>
        <span class="k">if</span> <span class="s1">&#39;nscf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">npool</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__get_pool_num</span><span class="p">(</span><span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">)</span>        

                <span class="k">if</span> <span class="n">npool</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;npool\s*(?:\d+)&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">execPostfixPrime</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;npool\s*(?:\d+)&#39;</span><span class="p">,</span><span class="s1">&#39;npool </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">npool</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">execPostfixPrime</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



	    
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">nscf_calc</span><span class="p">,</span><span class="n">nscf_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
	    
            <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">nscf_ID</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nscf&#39;</span><span class="p">)</span>
	    <span class="n">nscf_calc</span>
<span class="c1">##################################################################################################################</span>
        <span class="n">pdos_calc</span><span class="p">,</span><span class="n">pdos_ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">projwfc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;northo&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">):</span>
            <span class="n">execPostfix</span><span class="o">+=</span><span class="s1">&#39; -northo 1&#39;</span>


	


        <span class="k">if</span> <span class="s1">&#39;pdos&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>
            <span class="n">pdosPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;enginedir&#39;</span><span class="p">),</span><span class="s1">&#39;projwfc.x&#39;</span><span class="p">)</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">pdos_calc</span><span class="p">,</span><span class="n">pdos_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="s1">&#39;projwfc.x&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="n">pdosPath</span><span class="p">)</span>
<span class="c1">#############</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pdos&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">pdos_ID</span><span class="p">)</span>


        <span class="k">if</span> <span class="s1">&#39;bands&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>
            <span class="n">want_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">WanT_bands</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">want_ID</span><span class="p">,</span><span class="n">want_calc</span> <span class="ow">in</span> <span class="n">want_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">want_calc</span><span class="p">,</span><span class="n">want_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./want_bands.x&#39;</span> <span class="p">)</span>

            
            <span class="sd">&#39;&#39;&#39;in case we&#39;re working in local scratch&#39;&#39;&#39;</span>            
<span class="c1">#           AFLOWpi.prep.__from_local_scratch(oneCalc,ID,ext_list=[&#39;ham&#39;,&#39;wan&#39;,&#39;space&#39;])</span>

            <span class="k">for</span> <span class="n">want_ID</span><span class="p">,</span><span class="n">want_calc</span> <span class="ow">in</span> <span class="n">want_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">want_ID</span><span class="p">)</span>


            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bands&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Will need to be filled in for the executable name with whatever wanT executable is called </span>
<span class="sd">            and that executable needs to be moved to the calculation directory tree before this is called</span>
<span class="sd">            &#39;&#39;&#39;</span>


        <span class="k">if</span> <span class="s1">&#39;want_dos&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>
            <span class="n">want_dos_calc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">WanT_dos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">want_dos_ID</span><span class="p">,</span><span class="n">want_dos</span> <span class="ow">in</span> <span class="n">want_dos_calc</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">want_dos</span><span class="p">,</span><span class="n">want_dos_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./want_dos.x&#39;</span> <span class="p">)</span>

            
            <span class="sd">&#39;&#39;&#39;in case we&#39;re working in local scratch&#39;&#39;&#39;</span>            
<span class="c1">#           AFLOWpi.prep.__from_local_scratch(oneCalc,ID,ext_list=[&#39;ham&#39;,&#39;wan&#39;,&#39;space&#39;])</span>

            <span class="k">for</span> <span class="n">want_dos_ID</span><span class="p">,</span><span class="n">want_dos</span> <span class="ow">in</span> <span class="n">want_dos_calc</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">want_dos_ID</span><span class="p">)</span>


            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;want_dos&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>


        <span class="k">if</span> <span class="s1">&#39;want_epsilon&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]:</span>
            <span class="n">want_epsilon_calc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">WanT_epsilon</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">want_epsilon_ID</span><span class="p">,</span><span class="n">want_epsilon</span> <span class="ow">in</span> <span class="n">want_epsilon_calc</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">want_epsilon</span><span class="p">,</span><span class="n">want_epsilon_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./want_epsilon.x&#39;</span> <span class="p">)</span>

            
            <span class="sd">&#39;&#39;&#39;in case we&#39;re working in local scratch&#39;&#39;&#39;</span>            
<span class="c1">#           AFLOWpi.prep.__from_local_scratch(oneCalc,ID,ext_list=[&#39;ham&#39;,&#39;wan&#39;,&#39;space&#39;])</span>

            <span class="k">for</span> <span class="n">want_epsilon_ID</span><span class="p">,</span><span class="n">want_epsilon</span> <span class="ow">in</span> <span class="n">want_epsilon_calc</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">abortIFRuntimeError</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">want_epsilon_ID</span><span class="p">)</span>


            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;want_epsilon&#39;</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>


            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Will need to be filled in for the executable name with whatever wanT executable is called </span>
<span class="sd">            and that executable needs to be moved to the calculation directory tree before this is called</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="c1">#save and exit</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            
            <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
</pre></div></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Andrew Supka.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>