<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>run &mdash; AFLOWpi  documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="AFLOWpi  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          AFLOWpi</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../plot.html">plot module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prep.html">prep module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pseudo.html">pseudo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../retr.html">retr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run.html">run module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scfuj.html">scfuj module</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for run</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span> 

<span class="k">def</span> <span class="nf">__collect_fd_field_forces</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the forces to be saved to files for</span>
<span class="sd">    parsing by fd_ifc.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         for_type (str): type of file to pull from in FD_PHONON dir (choices are &#39;raman&#39;, &#39;born&#39;, &#39;epol&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">         force_out_str (str) a string of the contents of the file</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;raman&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;force&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;born&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;force&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;epol&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;epol&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">force_out_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">force_file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;./FD_PHONON/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">val_type</span><span class="p">,</span><span class="n">index</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">force_file_path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">force_file</span><span class="p">:</span>
                <span class="n">force_str</span><span class="o">=</span><span class="n">force_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">force_out_str</span><span class="o">+=</span><span class="n">force_str</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">force_out_str</span>

<span class="k">def</span> <span class="nf">__pull_polarization</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the forces to be saved to files for</span>
<span class="sd">    parsing by fd_ifc.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         None</span>

<span class="sd">    Returns:</span>
<span class="sd">         None </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
        <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    
    <span class="n">e_pol_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Electronic Dipole on Cartesian axes\s*</span><span class="se">\n</span><span class="s1">((?:\W*[123]\s*.*</span><span class="se">\n</span><span class="s1">)+)&#39;</span><span class="p">)</span>
    <span class="n">e_ion_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Ionic Dipole on Cartesian axes\s*</span><span class="se">\n</span><span class="s1">((?:\W*[123]\s*.*</span><span class="se">\n</span><span class="s1">)+)&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ele_block</span><span class="o">=</span><span class="n">e_pol_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ion_block</span><span class="o">=</span><span class="n">e_ion_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>



    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">e_pol_split</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ele_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_ion_split</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ion_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
    
    
    <span class="n">e_tot_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_pol_split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e_pol_split</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">e_pol_split</span><span class="p">[</span><span class="mi">2</span><span class="p">],]</span>

    <span class="n">epol_out_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="n">epol_out_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%18.12f%18.12f%18.12f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">e_tot_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">e_tot_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">e_tot_split</span><span class="p">[</span><span class="mi">2</span><span class="p">]),)</span>

    <span class="n">force_postfix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">force_postfix</span><span class="o">=</span><span class="n">force_postfix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="s1">&#39;epol.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">force_postfix</span><span class="p">),</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
        <span class="n">out_file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">epol_out_string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__pull_eps_out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the eps_0 to be saved to files for</span>
<span class="sd">    use by matdyn.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         None</span>

<span class="sd">    Returns:</span>
<span class="sd">         eps_string (str): string of the eps</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">eps_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">eps_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Dielectric tensor</span><span class="se">\n</span><span class="s1">.*</span><span class="se">\n</span><span class="s1">([0-9\s.-]*)&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_epol.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
            <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">eps_string</span><span class="o">=</span><span class="n">eps_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eps_string</span>

<span class="k">def</span> <span class="nf">__pull_born_out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the born effective charges to be saved </span>
<span class="sd">    to files for use by matdyn.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         None</span>

<span class="sd">    Returns:</span>
<span class="sd">         born_string (str) string of the born eff. charges</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">born_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">born_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;atom\s*\d*</span><span class="se">\n</span><span class="s1">(?:([-.0-9\s]+)+)&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_born.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
            <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">born_charges</span><span class="o">=</span><span class="n">born_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">born_charges</span><span class="p">)):</span>
            <span class="n">num_index</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">born_string</span><span class="o">+=</span><span class="s1">&#39;         </span><span class="si">%s</span><span class="s1">    </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">num_index</span>
            <span class="n">born_string</span><span class="o">+=</span><span class="n">born_charges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">born_string</span>

<span class="k">def</span> <span class="nf">__gen_fd_input</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.003</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the input files for the finite field calcs from the input file string in oneCalc</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         for_type (str): which type of FD input do we want to generate files for. &#39;raman&#39;,&#39;born&#39;,&#39;eps&#39;</span>
<span class="sd">         de (float): applied electric field strength</span>

<span class="sd">    Returns:</span>
<span class="sd">         None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;raman&#39;</span><span class="p">:</span>
        <span class="n">card</span><span class="o">=</span><span class="s1">&#39;RAMAN_TENSOR&#39;</span>
        <span class="n">input_name_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span>
        <span class="n">npol</span><span class="o">=</span><span class="mi">4</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;born&#39;</span><span class="p">:</span>
        <span class="n">card</span><span class="o">=</span><span class="s1">&#39;BORN_CHARGES&#39;</span>        
        <span class="n">input_name_type</span><span class="o">=</span><span class="s1">&#39;zeu&#39;</span>
        <span class="n">npol</span><span class="o">=</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;epol&#39;</span><span class="p">:</span>
        <span class="n">card</span><span class="o">=</span><span class="s1">&#39;DIELECTRIC_TENSOR&#39;</span>
        <span class="n">input_name_type</span><span class="o">=</span><span class="s1">&#39;eps&#39;</span>
        <span class="n">npol</span><span class="o">=</span><span class="mi">2</span>


    <span class="n">header</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;&amp;inputfd</span>
<span class="s1">   prefix=&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
<span class="s1">   de_</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">   npol_</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">/</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">],</span><span class="n">input_name_type</span><span class="p">,</span><span class="n">de</span><span class="p">,</span><span class="n">input_name_type</span><span class="p">,</span><span class="n">npol</span><span class="p">)</span>



    <span class="n">header</span><span class="o">+=</span><span class="n">card</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">forces</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__collect_fd_field_forces</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="n">for_type</span><span class="p">)</span>
    <span class="n">header</span><span class="o">+=</span><span class="n">forces</span>
    
    <span class="n">finite_field_input</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finite_field_input</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">force_file</span><span class="p">:</span>
        <span class="n">force_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__swap_scf_inputs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Swaps the value of oneCalc[&#39;_AFLOWPI_INPUT_&#39;] in oneCalc to the finite field input</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_by_ID_obj</span><span class="p">:</span>
            <span class="n">input_string</span> <span class="o">=</span> <span class="n">in_by_ID_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">input_string</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">oneCalc</span>

<span class="k">def</span> <span class="nf">__setup_raman</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">,</span><span class="n">orig_oneCalc</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">nberrycyc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the input files and the command to run the finite field calculations.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calc_subset (dict): dictionary of dictionaries of the FD_PHONON calculations </span>
<span class="sd">          orig_oneCalc (dict): oneCalc of one calculation the main calc set</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         feild_strength (float): applied electric field strength</span>
<span class="sd">         nberrycyc (int) number of berry phase cycles</span>
<span class="sd">         for_type (str): which type of FD input do we want to generate files for. &#39;raman&#39;,&#39;born&#39;,&#39;eps&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">         None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_string</span><span class="o">=</span><span class="n">orig_oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
    <span class="n">subset_keys</span> <span class="o">=</span> <span class="n">calc_subset</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">in_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>
    <span class="c1">#if possibly a metal don&#39;t do LOTO</span>
    <span class="k">if</span> <span class="s1">&#39;degauss&#39;</span> <span class="ow">in</span> <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span>
    <span class="c1">#copy for when we append finite field calcs to the calclog</span>
    <span class="n">calc_subset_extended</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;raman&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;force&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;born&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;force&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;epol&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;epol&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">num_calcs</span><span class="o">=</span><span class="mi">19</span>
    <span class="n">subset_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>        
        <span class="n">fd_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__field_factory</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="n">field_strength</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="n">for_type</span><span class="p">,</span><span class="n">nberrycyc</span><span class="o">=</span><span class="n">nberrycyc</span><span class="p">,</span><span class="n">dir_index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

        <span class="n">subset_key_index</span><span class="o">=</span><span class="n">index</span><span class="o">%</span><span class="n">subset_size</span>

        <span class="n">ID</span> <span class="o">=</span> <span class="n">subset_keys</span><span class="p">[</span><span class="n">subset_key_index</span><span class="p">]</span>
        <span class="n">oneCalc</span><span class="o">=</span><span class="n">calc_subset</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
        
        <span class="n">FD_ID</span><span class="o">=</span><span class="s1">&#39;finite_field.</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">index</span>
        <span class="n">file_path_fd_field_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">FD_ID</span><span class="p">)</span>
    
        <span class="k">print</span> <span class="n">ID</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path_fd_field_in</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd_in_obj</span><span class="p">:</span>
            <span class="n">fd_in_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd_input</span><span class="p">)</span>


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;oneCalc = AFLOWpi.run.__swap_scf_inputs(oneCalc,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">FD_ID</span><span class="p">)</span>       
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;AFLOWpi.prep.__to_local_scratch(oneCalc,&#39;</span><span class="si">%s</span><span class="s1">&#39;)&#39;&#39;&#39;</span><span class="o">%</span><span class="n">FD_ID</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">alt_ID</span><span class="o">=</span><span class="n">FD_ID</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;-northo 1&#39;</span><span class="p">)</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;AFLOWpi.run.__pull_forces(oneCalc,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">FD_ID</span><span class="p">)</span>       
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;AFLOWpi.run.__pull_polarization(oneCalc,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">FD_ID</span><span class="p">)</span>       


        <span class="c1"># add finite field to calcs for calclog</span>
        <span class="n">oneCalc_FD</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
        <span class="n">oneCalc_FD</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fd_input</span>
        <span class="n">calc_subset_extended</span><span class="p">[</span><span class="n">FD_ID</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc_FD</span>

    <span class="c1">#update the calclogs to include FD_fields so when all phonon supercell</span>
    <span class="c1">#are finished but not finite fields the main script doesn&#39;t try to run</span>
    <span class="n">chain_index</span><span class="o">=</span><span class="n">orig_oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>

<span class="c1">#FIX THIS</span>
<span class="c1">#FIX THIS</span>
    <span class="n">chain_logname</span><span class="o">=</span><span class="s1">&#39;step_01&#39;</span>
<span class="c1">###    chain_logname=&#39;step_%02d&#39;% chain_index</span>
<span class="c1">#FIX THIS</span>
<span class="c1">#FIX THIS</span>

    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">updatelogs</span><span class="p">(</span><span class="n">calc_subset_extended</span><span class="p">,</span><span class="n">chain_logname</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__field_factory</span><span class="p">(</span><span class="n">input_str</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span><span class="p">,</span><span class="n">nberrycyc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">dir_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modifies the QE pwscf input for the finite field calc of a given index</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">         input_str (str): string of QE pwscf input file</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         feild_strength (float): applied electric field strength</span>
<span class="sd">         nberrycyc (int) number of berry phase cycles</span>
<span class="sd">         for_type (str): which type of FD input do we want to generate files for. &#39;raman&#39;,&#39;born&#39;,&#39;eps&#39;</span>
<span class="sd">         dir_index (int): index of the finite field direction to choose</span>

<span class="sd">    Returns:</span>
<span class="sd">         new_input (str): the modified input string</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;eps&#39;</span> <span class="ow">or</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;born&#39;</span><span class="p">:</span>
        <span class="n">field_dir</span><span class="o">=</span><span class="p">[[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># 0</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -x</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  x</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -y</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  y</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -z</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],]</span>  <span class="c1">#  z</span>
    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;raman&#39;</span><span class="p">:</span>
        <span class="n">field_dir</span><span class="o">=</span><span class="p">[[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># 0</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -x</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  x</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -y</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  y</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -z</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  z</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -x-y</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  xy</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  x-y </span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -xy</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -x-z</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  xz</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  x-z</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -xz</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -y-z</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  yz</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  y-z</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],]</span>  <span class="c1">#  -yz</span>


    <span class="n">in_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;lelfield&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;.TRUE.&#39;</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;scf&#39;&quot;</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;nberrycyc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nberrycyc</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;tprnfor&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;.TRUE.&#39;</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;_finite_field.</span><span class="si">%02d</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">dir_index</span>

    <span class="n">input_list</span><span class="o">=</span><span class="p">[]</span>

<span class="c1">#    for i in range(len(field_dir)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_dir</span><span class="p">[</span><span class="n">dir_index</span><span class="p">])):</span>
        <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;efield_cart(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">=</span><span class="n">field_dir</span><span class="p">[</span><span class="n">dir_index</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">field_strength</span>

    <span class="n">new_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">in_dict</span><span class="p">)</span>

        
    <span class="k">return</span> <span class="n">new_input</span>

<span class="c1">#from __future__ import print_function</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span>


<span class="k">def</span> <span class="nf">__phonon_band_path</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets path for the cell between High Symmetry points in Brillouin Zone</span>
<span class="sd">    and returns for to be part of matdyn.x input for the phonon dispersion</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          path (str): Path between High Symmetry points in Brillouin Zone</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dk</span><span class="o">=</span><span class="mf">0.001</span>
    <span class="n">nk</span><span class="o">=</span><span class="mi">4000</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getPath</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;scale the k points in the path list so they&#39;re as close to nk as possible&#39;&#39;&#39;</span>
    <span class="n">splitPath</span> <span class="o">=</span>  <span class="p">[[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">total</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">entries</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">total</span><span class="p">)):</span>
	    <span class="k">if</span> <span class="n">total</span><span class="p">[</span><span class="n">entries</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
		    <span class="n">total</span><span class="p">[</span><span class="n">entries</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">total</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="n">scaleFactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

    <span class="n">dk_prime</span> <span class="o">=</span> <span class="n">dk</span><span class="o">/</span><span class="n">scaleFactor</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getPath</span><span class="p">(</span><span class="n">dk_prime</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">__pull_forces</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the forces to be saved to files for</span>
<span class="sd">    parsing by fd_ifc.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         None</span>

<span class="sd">    Returns:</span>
<span class="sd">         None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
        <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    

    <span class="n">force_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Forces acting on atoms.*\n\n((?:.*force\s*=\s*[-0-9.]+\s*[-0-9.]+\s*[-0-9.]+\s*)+\n)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">force_block</span><span class="o">=</span><span class="n">force_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">force_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">force_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">force_out_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">force_split</span><span class="p">:</span>
        <span class="n">force_out_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%18.12f%18.12f%18.12f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]),)</span>

    <span class="n">force_postfix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">force_postfix</span><span class="o">=</span><span class="n">force_postfix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="s1">&#39;force.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">force_postfix</span><span class="p">),</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
        <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">force_out_string</span><span class="p">)</span>



<span class="kn">import</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">__pp_phonon</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">LOTO</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">raman</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the executables for the post processing of the force</span>
<span class="sd">    data generated by the scf calculations created by fd.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
	    <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            
    <span class="c1">#run fd_ifc</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fd_ifc&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./fd_ifc.x&#39;</span> <span class="p">)</span> 

    <span class="c1"># get ifc file for matdyn</span>
    <span class="n">header_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;FD_PHONON&#39;</span><span class="p">,</span><span class="s1">&#39;header.txt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">header_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">header_fileobj</span><span class="p">:</span>
        <span class="n">header_string</span><span class="o">=</span><span class="n">header_fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        


    <span class="k">if</span> <span class="n">raman</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
        <span class="n">field_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;epol&#39;</span><span class="p">,</span><span class="s1">&#39;born&#39;</span><span class="p">,</span><span class="s1">&#39;raman&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">LOTO</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
        <span class="n">field_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;epol&#39;</span><span class="p">,</span><span class="s1">&#39;born&#39;</span><span class="p">,]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field_list</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__gen_fd_input</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="n">field</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="n">field_strength</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">field</span><span class="p">),</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./fd_ef.x&#39;</span> <span class="p">)</span>


            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>            

<span class="c1">#######################################################################</span>
        <span class="k">if</span> <span class="n">raman</span><span class="o">==</span><span class="bp">True</span> <span class="ow">or</span> <span class="n">LOTO</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
            <span class="n">epol_string</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__pull_eps_out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">born_charge_string</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__pull_born_out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="n">LOTO_REPLACE</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;T</span>

<span class="s1">    </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">    </span><span class="si">%s</span><span class="s1"></span>

<span class="s1">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epol_string</span><span class="p">,</span><span class="n">born_charge_string</span><span class="p">)</span>


            <span class="n">header_string</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;F</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">LOTO_REPLACE</span><span class="p">,</span><span class="n">header_string</span><span class="p">)</span>
<span class="c1">########################################################################</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        
    
    <span class="n">ifc_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;PHONON_ifc.fc&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ifc_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifc_fileobj</span><span class="p">:</span>
        <span class="n">ifc_string</span><span class="o">=</span><span class="n">ifc_fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">for_matdyn</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.fc&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">for_matdyn</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mat_dyn_in_fileobj</span><span class="p">:</span>
        <span class="n">mat_dyn_in_fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_string</span><span class="p">)</span>
        <span class="n">mat_dyn_in_fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ifc_string</span><span class="p">)</span>


    <span class="c1">#run matdyn for bands</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_matdyn_phBand&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./matdyn.x&#39;</span> <span class="p">)</span>

    <span class="c1">#run matdyn for dos</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_matdyn_phDOS&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./matdyn.x&#39;</span> <span class="p">)</span>
    
    <span class="c1">#remove the fd.x output files in case we do another phonon calc</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="n">globpath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;FD_PHONON&#39;</span><span class="p">)</span>
	    <span class="n">phil</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">globpath</span><span class="o">+</span><span class="s1">&#39;/displaced*.in&#39;</span><span class="p">)</span>
	    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">phil</span><span class="p">:</span>
		    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<div class="viewcode-block" id="write_fdx_template"><a class="viewcode-back" href="../run.html#run.write_fdx_template">[docs]</a><span class="k">def</span> <span class="nf">write_fdx_template</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nrx1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates input files for fd.x, fd_ifc.x, and matdyn.x for the finite</span>
<span class="sd">    difference phonon calculations. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          nrx1 (int): supercell size for first primitive lattice vector</span>
<span class="sd">	  nrx2 (int): supercell size for second primitive lattice vector</span>
<span class="sd">	  nrx3 (int): supercell size for third primitive lattice vector</span>
<span class="sd">	  innx (int): how many differernt shifts in each direction for </span>
<span class="sd">                      finite difference phonon calculation</span>
<span class="sd">	  de (float): amount to shift the atoms for finite differences</span>

<span class="sd">    Returns:</span>
<span class="sd">          None          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">atom_sym</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
        <span class="n">noatsym</span><span class="o">=</span><span class="s1">&#39;.false.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">noatsym</span><span class="o">=</span><span class="s1">&#39;.true.&#39;</span>
    <span class="k">if</span> <span class="n">disp_sym</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
        <span class="n">nodispsym</span><span class="o">=</span><span class="s1">&#39;.false.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodispsym</span><span class="o">=</span><span class="s1">&#39;.true.&#39;</span>

    <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__get_tempdir</span><span class="p">()</span>

    <span class="n">fd_template</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;!fd_prefix     Prefix of the preceding pw.x run</span>
<span class="s1">!fd_outdir     Outdir of the preceding pw.x run</span>
<span class="s1">!fd_outfile    Prefix for the generated macrocell input files</span>
<span class="s1">!fd_outdir_dir Directory for the generated macrocell input files</span>
<span class="s1">!nrx1,2,3      Number of unitcell repetitions along the lattice vectors</span>
<span class="s1">!              (for the generation of the macrocell)</span>
<span class="s1">!de            Cartesian displacement for the atoms, in Angs.</span>
<span class="s1">!</span>
<span class="s1">&amp;inputfd</span>
<span class="s1"> fd_prefix      = &#39;</span><span class="si">%s</span><span class="s1">&#39; </span>
<span class="s1"> fd_outdir      = &#39;./&#39;</span>
<span class="s1"> fd_outfile     = &#39;displaced&#39;</span>
<span class="s1"> fd_outfile_dir = &#39;./FD_PHONON&#39;</span>
<span class="s1"> noatsym        = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1"> nodispsym      = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1"> nrx1           = </span><span class="si">%i</span><span class="s1"></span>
<span class="s1"> nrx2           = </span><span class="si">%i</span><span class="s1"></span>
<span class="s1"> nrx3           = </span><span class="si">%i</span><span class="s1"></span>
<span class="s1"> innx           = </span><span class="si">%i</span><span class="s1"></span>
<span class="s1"> de             = </span><span class="si">%f</span><span class="s1"></span>
<span class="s1">/</span>

<span class="s1">!The following namelist is for additional flexibility</span>
<span class="s1">!1. Each string (everything between a pair of single quotation marks)</span>
<span class="s1">!   will be pasted verbatim to the generated input files.</span>
<span class="s1">!   Within the corresponding namelist</span>
<span class="s1">!2. Mind not using single quotation marks within strings</span>
<span class="s1">!3. Mind keeping &quot;system2&quot; instead of &quot;system&quot;. Fortran conflict</span>
<span class="s1">!   within the corresponding</span>
<span class="s1">!4. Asterisks (*) inside the &quot;kpoints&quot; string represent change of line</span>
<span class="s1">!</span>
<span class="s1">&amp;verbatim</span>
<span class="s1"> control =</span>
<span class="s1">&#39;</span>
<span class="s1">&#39;</span>

<span class="s1"> electrons =</span>
<span class="s1">&#39;</span>
<span class="s1">&#39;</span>

<span class="s1"> system2 =</span>
<span class="s1">&#39;</span>
<span class="s1">&#39;</span>

<span class="s1"> kpoints =</span>
<span class="s1">&#39;</span>
<span class="s1">&#39;</span>
<span class="s1">/</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">],</span><span class="n">noatsym</span><span class="p">,</span><span class="n">nodispsym</span><span class="p">,</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="p">)</span>
    <span class="n">FD_in_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fd.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FD_in_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd_in_file</span><span class="p">:</span>
        <span class="n">fd_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd_template</span><span class="p">)</span>



    <span class="n">fd_ifc_template</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;&amp;input</span>
<span class="s1">      prefix=&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
<span class="s1">!      outdir=&#39;./&#39;</span>
<span class="s1">      nrx1=</span><span class="si">%i</span><span class="s1">,</span>
<span class="s1">      nrx2=</span><span class="si">%i</span><span class="s1">,</span>
<span class="s1">      nrx3=</span><span class="si">%i</span><span class="s1">,</span>
<span class="s1">      innx=</span><span class="si">%i</span><span class="s1">,</span>
<span class="s1">      de=</span><span class="si">%f</span><span class="s1">,</span>
<span class="s1">      file_force=&#39;./FD_PHONON/force&#39;,</span>
<span class="s1">      file_out=&#39;./PHONON_ifc&#39;</span>
<span class="s1">      noatsym        = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">      nodispsym      = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">      verbose=.true.</span>
<span class="s1">      hex=.false.</span>
<span class="s1">    /</span>
<span class="s1">     &#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">],</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="p">,</span><span class="n">noatsym</span><span class="p">,</span><span class="n">nodispsym</span><span class="p">)</span>

    <span class="n">FD_ifc_in_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fd_ifc.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FD_ifc_in_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd_ifc_in_file</span><span class="p">:</span>
        <span class="n">fd_ifc_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd_ifc_template</span><span class="p">)</span>




    <span class="n">inputDict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

    <span class="n">masses</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">species_string</span> <span class="o">=</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
    
    <span class="n">split_species_string</span> <span class="o">=</span> <span class="n">species_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">split_species_string</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">amass_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masses</span><span class="p">)):</span>
        <span class="n">amass_str</span><span class="o">+=</span><span class="s1">&#39;   amass(</span><span class="si">%d</span><span class="s1">) = </span><span class="si">%f</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">masses</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>


    <span class="n">ph_band_path</span><span class="o">=</span><span class="n">__phonon_band_path</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>



    <span class="n">matdyn_template</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"> &amp;input</span>
<span class="s1">   asr=&#39;crystal&#39;,</span>
<span class="si">%s</span><span class="s1"></span>
<span class="s1">   flvec=&#39;</span><span class="si">%s</span><span class="s1">.modes&#39;</span>
<span class="s1">   flfrc=&#39;</span><span class="si">%s</span><span class="s1">.fc&#39;,</span>
<span class="s1">   flfrq=&#39;</span><span class="si">%s</span><span class="s1">.phBAND&#39;, </span>
<span class="s1">   fldyn=&#39;</span><span class="si">%s</span><span class="s1">.dyn&#39;,</span>
<span class="s1">   fleig=&#39;</span><span class="si">%s</span><span class="s1">.eig&#39;,</span>
<span class="s1">!   l1=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   l2=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   l3=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">   nosym=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">   fd=.true.</span>
<span class="s1">   na_ifc=.true.</span>
<span class="s1">   q_in_band_form=.true.,</span>
<span class="s1"> /</span>
<span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">amass_str</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">noatsym</span><span class="p">,</span><span class="n">ph_band_path</span><span class="p">)</span>
    <span class="n">matdyn_in_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_matdyn_phBand.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">matdyn_in_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">matdyn_in_file</span><span class="p">:</span>
        <span class="n">matdyn_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">matdyn_template</span><span class="p">)</span>


    <span class="n">kgrid</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">kpt_str</span>  <span class="o">=</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>    
    <span class="n">kpt_ints</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kpt_str</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kpt_ints</span><span class="p">)):</span>
        <span class="n">kgrid</span><span class="o">+=</span><span class="s1">&#39;   nk</span><span class="si">%d</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">kpt_ints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">matdyn_dos_template</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"> &amp;input</span>
<span class="s1">   asr=&#39;crystal&#39;,</span>
<span class="si">%s</span><span class="s1"></span>
<span class="s1">   fd=.true.</span>
<span class="s1">   na_ifc=.true.</span>
<span class="s1">   fldos=&#39;</span><span class="si">%s</span><span class="s1">.phdos&#39;</span>
<span class="s1">   flfrc=&#39;</span><span class="si">%s</span><span class="s1">.fc&#39;,</span>
<span class="s1">   flfrq=&#39;</span><span class="si">%s</span><span class="s1">.phDOS&#39;, </span>
<span class="s1">   nosym=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">!   l1=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   l2=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   l3=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">   dos=.true.,</span>

<span class="si">%s</span><span class="s1">   </span>
<span class="s1"> /</span>

<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">amass_str</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">noatsym</span><span class="p">,</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">kgrid</span><span class="p">)</span>
    <span class="n">matdyn_in_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_matdyn_phDOS.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">matdyn_in_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">matdyn_in_file</span><span class="p">:</span>
        <span class="n">matdyn_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">matdyn_dos_template</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="clean_cell_params"><a class="viewcode-back" href="../run.html#run.clean_cell_params">[docs]</a><span class="k">def</span> <span class="nf">clean_cell_params</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the atomic shifts in a supercell from fd.x</span>
<span class="sd">    outputted pw.x input files to correct for formatting</span>
<span class="sd">    issues when they are imported to AFLOWpi</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          output (str): pw.x input files generated by fd.x</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          output (str): pw.x input files generated by fd.x (cleaned by AFLOWpi)</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="n">output</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># signifies start of shifts in supercell</span>
        <span class="k">if</span> <span class="s1">&#39;CELL_PARAMETERS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">output</span><span class="o">+=</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># use same iterator so we don&#39;t have to store an index</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">output</span><span class="o">+=</span><span class="s1">&#39;CELL_PARAMETERS {angstrom}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>    
	    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
		    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.0001</span><span class="p">:</span>
			    <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
			    

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">output</span><span class="o">+=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>


    <span class="k">return</span> <span class="n">output</span>

</div>
<div class="viewcode-block" id="prep_fd"><a class="viewcode-back" href="../run.html#run.prep_fd">[docs]</a><span class="k">def</span> <span class="nf">prep_fd</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nrx1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates input files for fd.x, fd_ifc.x, and matdyn.x for the finite</span>
<span class="sd">    difference phonon calculations. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          nrx1 (int): supercell size for first primitive lattice vector</span>
<span class="sd">	  nrx2 (int): supercell size for second primitive lattice vector</span>
<span class="sd">	  nrx3 (int): supercell size for third primitive lattice vector</span>
<span class="sd">	  innx (int): how many differernt shifts in each direction for </span>
<span class="sd">                      finite difference phonon calculation</span>
<span class="sd">	  de (float): amount to shift the atoms for finite differences</span>

<span class="sd">    Returns:</span>
<span class="sd">          None          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#copy fd.x to the directories</span>
    <span class="n">engineDir</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;prep&quot;</span><span class="p">,</span><span class="s1">&#39;enginedir&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fd_exec</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fd.x&#39;</span><span class="p">,</span><span class="s1">&#39;fd_ifc.x&#39;</span><span class="p">,</span><span class="s1">&#39;fd_ef.x&#39;</span><span class="p">,</span><span class="s1">&#39;matdyn.x&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">fd_exec</span><span class="p">),{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">fd_exec</span><span class="p">),{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">write_fdx_template</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nrx1</span><span class="o">=</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="n">de</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="n">atom_sym</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="n">disp_sym</span><span class="p">)</span>
    


    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fd&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./fd.x&#39;</span> <span class="p">)</span>    


    <span class="n">ocd</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="n">globpath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ocd</span><span class="p">,</span><span class="s1">&#39;FD_PHONON&#39;</span><span class="p">)</span>

    <span class="n">phil</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">globpath</span><span class="o">+</span><span class="s1">&#39;/displaced*.in&#39;</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">phil</span><span class="p">:</span>
        <span class="n">fdfo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">fdfos</span> <span class="o">=</span> <span class="n">fdfo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fdfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">NC</span><span class="o">=</span><span class="n">clean_cell_params</span><span class="p">(</span><span class="n">fdfos</span><span class="p">)</span>
        <span class="n">fdfo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fdfo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">NC</span><span class="p">)</span>
        <span class="n">fdfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
<span class="c1">#    return fd_pwscf_in</span>
    <span class="c1"># pass repr of input_ to ensure it&#39;s fully quoted</span>
<span class="c1">#    cmd = &#39;fd.x &lt; {0!r}&#39;.format(input_)</span>

<span class="c1">#    run = monitor(&#39;./fd_files&#39;)(subprocess.check_output)</span>

<span class="c1">#    changed, output = run(cmd, shell=True, universal_newlines=True)</span>

<span class="c1">#    return changed, output</span>



<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#     paths, output = fd(&#39;fd.in&#39;)</span>

<span class="c1">#     for path in paths:</span>
        
<span class="c1">#         with open(path) as f:</span>
            
<span class="c1">#             params = cell_params(f.read())</span>

<span class="c1"># if params:</span>
<span class="c1">#     print(path, params)</span>



<span class="c1">#    return fd_template</span>
<span class="c1"># def monitor(dirpath):</span>
<span class="c1">#     &quot;&quot;&quot;Decorator that monitors `dirpath` non-recursively and returns a set of files changed by the decorated function.&quot;&quot;&quot;</span>

<span class="c1">#     # avoid issues with relative paths</span>
<span class="c1">#     abspath = os.path.abspath(dirpath)</span>

<span class="c1">#     # mappable callable to again avoid issues with relative paths for changed files</span>
<span class="c1">#     joiner = lambda f: os.path.join(abspath, f)</span>

<span class="c1">#     def wrapper(func):</span>
<span class="c1">#         @functools.wraps(func)</span>

<span class="c1"># def wrapped(*args, **kwargs):</span>
<span class="c1">#     try:</span>
<span class="c1">#         # time of last access</span>
<span class="c1">#         before = {f: os.path.getmtime(f) for f in map(joiner, os.listdir(abspath))}</span>

<span class="c1">#     # dirpath does not exist yet, any files added must be from function call</span>
<span class="c1">#     except os.error:</span>
<span class="c1">#         before = {}</span>

<span class="c1">#     result = func(*args, **kwargs)</span>

<span class="c1">#     # use sets to avoid implying that files were changed in a specific order</span>
<span class="c1">#     try:</span>
<span class="c1">#         # new files won&#39;t be in before dict</span>
<span class="c1">#         changed = {f for f in map(joiner, os.listdir(abspath)) if not (os.path.getmtime(f) == before.get(f))}</span>

<span class="c1">#     # dirpath still does not exist, best not to raise an error</span>
<span class="c1">#     except os.error:</span>
<span class="c1">#         changed = set()</span>
    
<span class="c1">#     return changed, result</span>

<span class="c1"># return wrapped</span>

<span class="c1"># return wrapper</span>
</div>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">logging</span> 
<span class="kn">import</span> <span class="nn">re</span> 
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="c1">#import AFLOWpi.prep</span>
<span class="kn">import</span> <span class="nn">sys</span>                                                                     
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">__main__</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">!=</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">engineDict</span><span class="o">=</span><span class="p">{}</span>

<span class="k">def</span> <span class="nf">__exitClean</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the terminate 15 signal is received exit with 0 exit code</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          signal (signal.SIGNAL): *nix signal</span>
<span class="sd">          frame (frame): Inspect frame</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;got the signal to exit cleanly. Exiting.&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__recordDeath</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the 15 signal to terminate the process is sent. </span>
<span class="sd">    Record it in oneCalc[&#39;__status__&#39;][&#39;Error&#39;]</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          signal (signal.SIGNAL): *nix signal</span>
<span class="sd">          frame (frame): Inspect frame</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Job Killed.&#39;</span><span class="p">)</span>

    <span class="n">index</span><span class="o">=</span><span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;__TEMP__INDEX__COUNTER__&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INDEX_&#39;</span><span class="p">])</span><span class="o">==</span><span class="n">index</span><span class="p">:</span>
        <span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;Killed&quot;</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__main__</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
    
<div class="viewcode-block" id="cleanup"><a class="viewcode-back" href="../run.html#run.cleanup">[docs]</a><span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes all files a calculation set&#39;s  directory</span>
<span class="sd">    tree that are prepended with &#39;_&#39;</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations                </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CLEANUP&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">import os</span><span class="se">\n</span><span class="s1">os.system(&quot;rm -rf </span><span class="si">%s</span><span class="s1">/_*&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="addatexit__"><a class="viewcode-back" href="../run.html#run.addatexit__">[docs]</a><span class="k">def</span> <span class="nf">addatexit__</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to add function to be run at exit</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          command (func): function to be run</span>
<span class="sd">          *args: arguments for command</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          **kwargs: Keyword arguments for command</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="s1">&#39;__atexitList&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#######################################</span>
        <span class="nd">@atexit.register</span>
        <span class="k">def</span> <span class="nf">__runatexitList</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">__atexitList</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="o">*</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">**</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">global</span> <span class="n">__atexitList</span>
        <span class="n">__atexitList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">__atexitList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">command</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">kwargs</span><span class="p">))</span>



</div>
<span class="k">def</span> <span class="nf">__colorize_message</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Colorizes text. Used for colorizing the logging</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          string (str): A string of text</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          level (str): Specific colors are chosen for logging message type</span>

<span class="sd">    Returns:</span>
<span class="sd">          levelname_color (str): Colorized version of the string input</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">BLACK</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="n">MAGENTA</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">WHITE</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

    <span class="n">RESET_SEQ</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
    <span class="n">COLOR_SEQ</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1;</span><span class="si">%d</span><span class="s2">m&quot;</span>
    <span class="n">BOLD_SEQ</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1m&quot;</span>

    <span class="n">COLORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;WARNING&#39;</span><span class="p">:</span> <span class="n">YELLOW</span><span class="p">,</span>
        <span class="s1">&#39;INFO&#39;</span><span class="p">:</span> <span class="n">WHITE</span><span class="p">,</span>
        <span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span> <span class="n">BLUE</span><span class="p">,</span>
        <span class="s1">&#39;CRITICAL&#39;</span><span class="p">:</span> <span class="n">YELLOW</span><span class="p">,</span>
        <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span> <span class="n">RED</span>
        
    <span class="p">}</span>



    
    <span class="n">levelname</span><span class="o">=</span><span class="n">level</span>
    <span class="k">if</span> <span class="n">show_level</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
        <span class="n">levelname_color</span> <span class="o">=</span> <span class="n">COLOR_SEQ</span> <span class="o">%</span> <span class="p">(</span><span class="mi">30</span> <span class="o">+</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">levelname</span><span class="p">])</span> <span class="o">+</span> <span class="n">levelname</span> <span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span><span class="n">string</span><span class="o">+</span> <span class="n">RESET_SEQ</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">levelname_color</span> <span class="o">=</span> <span class="n">COLOR_SEQ</span> <span class="o">%</span> <span class="p">(</span><span class="mi">30</span> <span class="o">+</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">levelname</span><span class="p">])</span> <span class="o">+</span> <span class="n">string</span><span class="o">+</span> <span class="n">RESET_SEQ</span>
    <span class="k">return</span> <span class="n">levelname_color</span>







<span class="k">def</span> <span class="nf">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logs an error and prints it out on the stdout if logging=debug in the config file used</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          e (str): string of the error </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="c1">#    e = __colorize_message(e)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">__colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%&#39;</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
    <span class="n">errorList</span> <span class="o">=</span>  <span class="n">traceback</span><span class="o">.</span><span class="n">format_list</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:])[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">errorMSG</span> <span class="ow">in</span> <span class="n">errorList</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">__colorize_message</span><span class="p">(</span><span class="n">errorMSG</span><span class="p">))</span>     
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">__colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%&#39;</span><span class="p">))</span>       

        
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;loglevel&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">for</span> <span class="n">errorMSG</span> <span class="ow">in</span> <span class="n">errorList</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">errorMSG</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>

        <span class="k">print</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%&#39;</span>



    


<span class="k">def</span>  <span class="nf">__getEnginePath</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the name of the executable file for the ab initio engine</span>
<span class="sd">    for a given type of calculation.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          engine (str): Ab initio engine being used</span>
<span class="sd">          calcType (str): Type of calculation to be done</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          execPath (str): the name of the executable for that engine for that calcType</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;espresso&#39;</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bands&#39;</span><span class="p">:[</span><span class="s1">&#39;./bands.x&#39;</span><span class="p">],</span>

                  <span class="s1">&#39;pdos&#39;</span><span class="p">:[</span><span class="s1">&#39;./projwfc.x&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;dos&#39;</span><span class="p">:[</span><span class="s1">&#39;./dos.x&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;scf&#39;</span><span class="p">:[</span><span class="s1">&#39;./pw.x&#39;</span><span class="p">],}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">execPath</span><span class="o">=</span><span class="n">execDict</span><span class="p">[</span><span class="n">calcType</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
<span class="c1">#        print &#39;Can not find executable path. May not be implemented Returning Blank String&#39;</span>
 <span class="c1">#       logging.debug(&#39;Can not find executable path. May not be implemented. Returning Blank String&#39;)</span>
        <span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">execPath</span>

<span class="c1">################################################################################################################</span>

<span class="c1">################################################################################################################</span>
<span class="k">def</span>  <span class="nf">__getExecutable</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the name of the executable file for the ab initio engine</span>
<span class="sd">    for a given type of calculation.</span>

<span class="sd">    OBSOLETE. NEEDS REMOVAL. AFLOWpi.run.__getEnginePath is almost identical </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          engine (str): Ab initio engine being used</span>
<span class="sd">          calcType (str): Type of calculation to be done</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          executable (str): the name of the executable for that engine for that calcType</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;espresso&#39;</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scf&#39;</span><span class="p">:</span><span class="s1">&#39;pw.x&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;dos&#39;</span><span class="p">:</span><span class="s1">&#39;dos.x&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;pdos&#39;</span><span class="p">:</span><span class="s1">&#39;projwfc.x&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="s1">&#39;bands.x&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;emr&#39;</span><span class="p">:</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;nmr&#39;</span><span class="p">:</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;hyperfine&#39;</span><span class="p">:</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;gvectors&#39;</span><span class="p">:</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">,</span>
                  <span class="p">}</span>

    <span class="k">elif</span> <span class="n">engine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;want&#39;</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span><span class="s1">&#39;bands.x&#39;</span><span class="p">,}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">executable</span><span class="o">=</span><span class="n">execDict</span><span class="p">[</span><span class="n">calcType</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1">#        print &#39;Can not find executable path. May not be implemented Returning Blank String&#39;</span>
<span class="c1">#        logging.debug(&#39;Can not find executable path. May not be implemented. Returning Blank String&#39;)</span>
        <span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">executable</span>




<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">pipes</span>
<span class="c1">################################################################################################################</span>

<span class="c1">################################################################################################################</span>

<span class="c1"># def __fixconverge(ID,folder):</span>
<span class="c1">#     logging.debug(&#39;entering __fixconverge&#39;)</span>
<span class="c1">#     logging.warning(&#39;problem converging %s/%s.in&#39; % (folder,ID))</span>
<span class="c1">#     logging.debug(&#39;exiting __fixconverge&#39;) </span>


<span class="c1">################################################################################################################</span>


<span class="c1"># def __resubmit(ID,oneCalc,__submitNodeName__,queue,calcName):</span>

<span class="c1">#         def tryAgain():</span>
<span class="c1">#             __resubmit(ID,oneCalc,__submitNodeName__,queue,calcName)</span>

<span class="c1">#         signal.signal(signal.SIGTERM, tryAgain)	</span>
<span class="c1">#         try:</span>

<span class="c1">#             IDsplit = ID.split(&#39;_&#39;)[0]</span>
<span class="c1">#         except:</span>
<span class="c1">#             IDsplit=ID</span>

<span class="c1">#         newqsubFileName = os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;_%s.qsub&#39; % ID)</span>

<span class="c1">#         print &#39;resubmitting %s&#39; % calcName</span>
<span class="c1">#         command = &quot;ssh -o StrictHostKeyChecking=no %s &#39;qsub %s -N %s %s&#39;&quot; % (__submitNodeName__,queue,calcName,newqsubFileName)</span>

<span class="c1">#         try:</span>
<span class="c1">#             subprocess.check_call(command,stdout=subprocess.PIPE,shell=True)            </span>
<span class="c1">#             sys.exit(0)</span>


<span class="c1">#             print &#39;resubmission of %s successful&#39; % calcName</span>

<span class="c1">#         except Exception,e:</span>
<span class="c1">#             AFLOWpi.run._fancy_error_log(e)</span>
<span class="c1">#             __resubmit(IDsplit,oneCalc,__submitNodeName__,queue,calcName)</span>


<span class="c1">################################################################################################################</span>

<div class="viewcode-block" id="generateSubRef"><a class="viewcode-back" href="../run.html#run.generateSubRef">[docs]</a><span class="k">def</span> <span class="nf">generateSubRef</span><span class="p">(</span><span class="n">qsubRefFileString</span><span class="p">,</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in the reference cluster submission file specified in &quot;jobreffile&quot;</span>
<span class="sd">    in the config used. Tries to insert a few parameters.</span>

<span class="sd">    OBSOLETE PLANNED FOR REMOVAL</span>

<span class="sd">    Arguments:</span>
<span class="sd">          qsubRefFileString (str): string of the &quot;reference&quot; cluster submission file</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          clusterTypeDict (dict): string cluster submission file</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering generateSubRef&#39;</span><span class="p">)</span>
    <span class="n">clusterTypeDict</span><span class="o">=</span><span class="p">{}</span>

    <span class="n">calcName</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__get_qsub_name</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>

    <span class="n">stderrFileNm</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_Cluster_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.stderr&#39;</span><span class="p">)</span>
    <span class="n">stdoutFileNm</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_Cluster_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.stdout&#39;</span><span class="p">)</span>

    <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_CALCNM_&#39;</span><span class="p">,</span><span class="n">calcName</span><span class="p">,</span><span class="n">qsubRefFileString</span><span class="p">)</span>
    <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_STDOUT_&#39;</span><span class="p">,</span><span class="n">stdoutFileNm</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
    <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_STDERR_&#39;</span><span class="p">,</span><span class="n">stderrFileNm</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>

    <span class="n">clusterTypeDict</span><span class="p">[</span><span class="s1">&#39;qsubRef&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">qsubRef</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting generateSubRef&#39;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">clusterTypeDict</span>



<span class="c1">#############################################################################################################</span>

<span class="c1">#########################################################################################################################</span></div>
<div class="viewcode-block" id="emr"><a class="viewcode-back" href="../run.html#run.emr">[docs]</a><span class="k">def</span> <span class="nf">emr</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up GIPAW EMR calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>

<span class="sd">    Returns:</span>
<span class="sd">          None </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;emr&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">gipawdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;gipawdir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">gipawExLoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gipawdir</span><span class="p">,</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file. EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;emr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;emr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="hyperfine"><a class="viewcode-back" href="../run.html#run.hyperfine">[docs]</a><span class="k">def</span> <span class="nf">hyperfine</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">isotope</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up GIPAW hyperfine calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">gipawdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;gipawdir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">gipawExLoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gipawdir</span><span class="p">,</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file. EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="nmr"><a class="viewcode-back" href="../run.html#run.nmr">[docs]</a><span class="k">def</span> <span class="nf">nmr</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up GIPAW NMR calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations               </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;nmr&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">gipawdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;gipawdir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">gipawExLoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gipawdir</span><span class="p">,</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file. EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">)</span>



    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;nmr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;nmr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



</div>
<div class="viewcode-block" id="gvectors"><a class="viewcode-back" href="../run.html#run.gvectors">[docs]</a><span class="k">def</span> <span class="nf">gvectors</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up GIPAW gvectors calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>


<span class="sd">    Returns:</span>
<span class="sd">          None          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;gvectors&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">gipawdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;gipawdir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">gipawExLoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gipawdir</span><span class="p">,</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file. EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;gvectors&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;gvectors&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>




<span class="c1">#########################################################################################################################</span>



<span class="c1">#############################################################################################################</span></div>
<span class="k">def</span> <span class="nf">__skeletonRun</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up a custom calculation. Inputs and oneCalc calculation</span>
<span class="sd">    dictionary must be created before calling this.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="scf"><a class="viewcode-back" href="../run.html#run.scf">[docs]</a><span class="k">def</span> <span class="nf">scf</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up self-consitent calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations              </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>

<span class="sd">    Returns:</span>
<span class="sd">          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="dos"><a class="viewcode-back" href="../run.html#run.dos">[docs]</a><span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up DOS nscf calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL    </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;dos&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;dos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;dos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="pdos"><a class="viewcode-back" href="../run.html#run.pdos">[docs]</a><span class="k">def</span> <span class="nf">pdos</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up DOS projection calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations                    </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;pdos&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;pdos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;pdos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="bands"><a class="viewcode-back" href="../run.html#run.bands">[docs]</a><span class="k">def</span> <span class="nf">bands</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up Electronic Band Structure calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span>
    
    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;bands&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;bands&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi.run.__PW_bands_fix(oneCalc,ID)&#39;</span><span class="p">)</span>


<span class="c1">#############################################################################################################</span>

<span class="c1">#############################################################################################################</span>
</div>
<div class="viewcode-block" id="testOne"><a class="viewcode-back" href="../run.html#run.testOne">[docs]</a><span class="k">def</span> <span class="nf">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run all the calculation in the dictionary with a specific engine</span>
<span class="sd">    </span>
<span class="sd">        Arguments:</span>
<span class="sd">               calcs (dict): Dictionary of dictionaries of calculations</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">	       engine (str): executable that you are calling to run the calculations</span>
<span class="sd">               execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                                 (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">               execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                                  (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>

<span class="sd">        Returns:</span>
<span class="sd">               None          </span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#############################################################################################################</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering testOne&#39;</span><span class="p">)</span>


                
            <span class="k">if</span> <span class="n">execPrefix</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">execPostfix</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

            
            <span class="k">if</span> <span class="n">calcType</span><span class="o">==</span><span class="s1">&#39;bands&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;pool&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span>

            <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span>

            <span class="n">engineDir</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;prep&quot;</span><span class="p">,</span><span class="s1">&#39;enginedir&#39;</span><span class="p">)</span>	
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">engineDir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                <span class="n">engineDir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">engineDir</span><span class="p">)</span>



            <span class="k">try</span><span class="p">:</span>
                <span class="n">enginePath</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__getEnginePath</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">enginePath</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="n">files</span><span class="p">))</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not found. Check your config file to make sure enginedir path is correct and that </span><span class="si">%s</span><span class="s1"> is in that directory..Exiting&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">files</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not found. Check your config file to make sure enginedir path is correct and that </span><span class="si">%s</span><span class="s1"> is in that directory..Exiting&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">files</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">SystemExit</span>

                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copyexecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="n">files</span><span class="p">)),</span><span class="n">calcs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="n">files</span><span class="p">)),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">files</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">files</span><span class="p">))</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="n">files</span><span class="p">)),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">files</span><span class="p">))</span>

            <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">())][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;LOG.log&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        
        <span class="c1">#############################################################################################################</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">calcsCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
            <span class="n">newCalcs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

                <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
                <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;calcType&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcType</span>                

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="c1">#############################################################################################################</span>
        <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clusterType</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">clusterType</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;firstCalcList&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">holdFlag</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
<span class="c1">#                global firstCalcList</span>
<span class="c1">#                firstCalcList = True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">baseID</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1">#splitIndexInt = int(splitIndex) </span>
                        <span class="n">splitIndexInt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__TEMP__INDEX__COUNTER__&#39;</span><span class="p">])</span>
                        <span class="n">prev_ID</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%.02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">baseID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">splitIndexInt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">prev_ID</span><span class="o">=</span><span class="n">ID</span>
                        <span class="k">pass</span>                   

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">prev_ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">)):</span>
                        <span class="k">pass</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prev_ID</span><span class="o">=</span><span class="n">ID</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="c1">#                __addatexit(submitFirstCalcs__,calcs)</span>
            <span class="k">elif</span> <span class="n">firstCalcList</span><span class="o">!=</span><span class="bp">False</span><span class="p">:</span>
                <span class="k">pass</span>


            <span class="n">firstCalcList</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting testOne&#39;</span><span class="p">)</span>


        <span class="c1">#############################################################################################################</span></div>
<div class="viewcode-block" id="reset_logs"><a class="viewcode-back" href="../run.html#run.reset_logs">[docs]</a><span class="k">def</span> <span class="nf">reset_logs</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes log files from AFLOWpi directory</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">log_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.oneCalc&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>            
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="resubmit"><a class="viewcode-back" href="../run.html#run.resubmit">[docs]</a><span class="k">def</span> <span class="nf">resubmit</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stages loaded calculation set to be resubmitted on a cluster</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None    </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">addatexit__</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">submitFirstCalcs__</span><span class="p">,</span><span class="n">calcs</span><span class="p">)</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span>

</div>
<span class="k">def</span> <span class="nf">__get_qsub_name</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes path of the cluster submission file and forms a name for the submission</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          path (str): path of the cluster job submission file</span>
<span class="sd">          </span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          calcName (str): name of the calculation used with the submission</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
<span class="c1">#    if c_name[-2].strip==&#39;&#39;:</span>
<span class="c1">#        try:</span>
<span class="c1">#            calc_name=&#39;_&#39;.join([c_name[-3],c_name[-1]])</span>
<span class="c1">#        except:</span>
<span class="c1">#            calcName = &#39;_&#39;.join(c_name[-2:])</span>
<span class="c1">#    else:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">calcName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">calcName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">calcName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">calcName</span><span class="o">=</span><span class="n">calcName</span><span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span> 

    <span class="k">return</span> <span class="n">calcName</span>



<span class="kn">import</span> <span class="nn">datetime</span>
<span class="k">def</span> <span class="nf">__qsubGen</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the cluster job submission file</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          qsubFileString (str): string of cluster submission file</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ENTERING __qsubGen&#39;</span><span class="p">)</span>

    <span class="n">calcName</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__get_qsub_name</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>

    <span class="n">execFileString</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>

    <span class="n">tmpdir_envar</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="n">ls_option</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;localscratch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ls_option</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;localscratchdir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tmpdir</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">tmpdir_envar</span><span class="o">=</span><span class="s2">&quot;export TMPDIR=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">tmpdir</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">qsubFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.qsub&#39;</span><span class="p">))</span>
        <span class="n">prevQsubString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clusterType</span><span class="o">==</span><span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
            <span class="n">qsubRefFileName</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;jobreffile&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">qsubRefFileName</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                <span class="n">qsubRefFileName</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">qsubRefFileName</span><span class="p">)</span>        
            <span class="n">qsubRefString</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">qsubRefFileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">generateSubRef</span><span class="p">(</span><span class="n">qsubRefString</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)[</span><span class="s1">&#39;qsubRef&#39;</span><span class="p">]</span>
            <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">remove_blank_lines</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">qsubFilename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">qsubFile</span><span class="p">:</span>
                <span class="n">qsubSub</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span><span class="si">%s</span><span class="s1">cd </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">python </span><span class="si">%s</span><span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpdir_envar</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">)))</span>


                <span class="c1">#redirect the -e, -o or -oe to the directory for that job</span>
                <span class="n">dash_e_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;#PBS\s+-e\s+.*\n&#39;</span><span class="p">)</span>
                <span class="n">dash_o_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;#PBS\s+-o\s+.*\n&#39;</span><span class="p">)</span>
                <span class="n">dash_oe_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;#PBS\s+-oe\s+.*\n&#39;</span><span class="p">)</span>

                <span class="n">stderr_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_Cluster_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.stderr&#39;</span><span class="p">)</span>
                <span class="n">stdout_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_Cluster_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.stdout&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dash_e_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)):</span>
                    <span class="n">qsubRef</span><span class="o">=</span><span class="n">dash_e_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -e </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">stderr_name</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qsubRef</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -e </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">stderr_name</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dash_o_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)):</span>
                    <span class="n">qsubRef</span><span class="o">=</span><span class="n">dash_o_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -o </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">stdout_name</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qsubRef</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -o </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">stdout_name</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dash_oe_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)):</span>
                    <span class="n">qsubRef</span><span class="o">=</span><span class="n">dash_oe_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="c1">#put the name of the AFLOWpi job in the  PBS submit script</span>

                <span class="n">name_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;\s*#PBS.*-[nN].*\n&#39;</span><span class="p">)</span>
                <span class="n">calcNameString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -N </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">calcName</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)):</span>
                    <span class="n">qsubRef</span><span class="o">=</span><span class="n">name_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">calcNameString</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qsubRef</span><span class="o">=</span><span class="n">calcNameString</span><span class="o">+</span><span class="n">qsubRef</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_QSUB_&#39;</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)):</span>
                    <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_QSUB_&#39;</span><span class="p">,</span><span class="n">qsubSub</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qsubRef</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">qsubSub</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>


                <span class="n">qsubFileString</span><span class="o">=</span><span class="n">qsubRef</span>
                <span class="n">qsubFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">qsubFileString</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            record the walltime requested and whether or not user is using stepsasjobs=false</span>
<span class="sd">            in a file so that if we need to do a restart we can figure out how much time we </span>
<span class="sd">            have left to run for the initial submission with stepsasjobs=false</span>
<span class="sd">            &#39;&#39;&#39;</span>
<span class="c1">#            walltime=__getWalltime(oneCalc,ID)</span>
<span class="c1">#            stepsasjobs = AFLOWpi.prep.__ConfigSectionMap(&quot;cluster&quot;,&#39;stepsasjobs&#39;).strip().upper()</span>
<span class="c1">#            if stepsasjobs.lower() != &#39;false&#39;:</span>
<span class="c1">#                stepsasjobs=&#39;true&#39;</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">qsubFileString</span>


<span class="c1">#############################################################################################################</span>
<span class="k">def</span> <span class="nf">__testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stages the first the first step in a calculation workflow of a calc set to be submitted</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">    	  engine (str): executable that you are calling to run the calculations          </span>
<span class="sd"> 	  execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)</span>
<span class="sd">	  execPostfix (str): commands to go after the executable when run</span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          calcType (str): used to pull the engine post processing executable to the calc dir</span>
<span class="sd">                          and to write the postprocessing input file if needed      </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">execPrefix</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">execPostfix</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering __testOne&#39;</span><span class="p">)</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">configFile</span>
        <span class="n">configFile</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">execPrefix</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">execPostfix</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">engineDir</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;prep&quot;</span><span class="p">,</span><span class="s1">&#39;enginedir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">engineDir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">engineDir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">engineDir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>


    <span class="n">ri</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
    <span class="n">ro</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span> 

    <span class="n">rd</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="n">configFile</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span>



    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __testOne&#39;</span><span class="p">)</span>


<span class="c1">#############################################################################################################</span>

<span class="k">def</span> <span class="nf">__submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Submits a step of a calculation&#39;s pipeline to be run</span>
<span class="sd">    </span>
<span class="sd">    Arguments:          </span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          sajOverride (bool): Overrides stepsasjobs=False in the config file used</span>
<span class="sd">          forceOneJob (bool): Overrides stepsasjobs=True in the config file used</span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering __submitJob&#39;</span><span class="p">)</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="k">print</span> 
<span class="c1">#    try:</span>
<span class="c1">#        ID = __get_index_from_pp_step(oneCalc,ID)</span>
<span class="c1">#    except:</span>
<span class="c1">#        pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">stepsAsJobs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;stepsasjobs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">clusterType</span><span class="o">=</span><span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusterType</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">clusterType</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
        <span class="k">elif</span> <span class="n">clusterType</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">clusterType</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sets the cluster type to none if:</span>
<span class="sd">    1. the clusterType is PBS,</span>
<span class="sd">    2. the user has the flag stepsasjobs=false in their config file</span>
<span class="sd">    3. the job is being submitted from somewhere other than the submission node (i.e. one of the compute nodes)</span>

<span class="sd">    This will cause the first job (step in the calc chain) to be submitted to the cluster and all subsequent</span>
<span class="sd">    jobs will be run on the compute nodes as if it was the local machine. (so the calc chain is just one job</span>
<span class="sd">    on the cluster)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="o">==</span> <span class="n">__submitNodeName__</span> <span class="ow">and</span> <span class="n">stepsAsJobs</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;Submitting steps as one cluster job per calculation chain.&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Submitting steps as one cluster job per calculation chain.&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="o">!=</span> <span class="n">__submitNodeName__</span> <span class="ow">and</span> <span class="n">stepsAsJobs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">forceOneJob</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sajOverride</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">clusterType</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="c1">###########################################################################################</span>

    <span class="k">if</span> <span class="n">ID</span> <span class="o">==</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ID</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>

<span class="c1">#    global execFileString</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#for calc subset...</span>
        <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]:</span>
            <span class="c1">#submit the cluster submission </span>
            <span class="n">submit_ID</span><span class="o">=</span><span class="n">__main__</span><span class="o">.</span><span class="n">ID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">submit_ID</span><span class="o">=</span><span class="n">ID</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
<span class="c1">#        AFLOWpi.run._fancy_error_log(e)</span>
        <span class="n">submit_ID</span><span class="o">=</span><span class="n">ID</span>

    <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;SLURM&#39;</span><span class="p">]:</span>
        <span class="sd">&#39;&#39;&#39;transfer the .save folder from local scratch if the option is being used&#39;&#39;&#39;</span>
<span class="c1">#        AFLOWpi.prep.__from_local_scratch(oneCalc,ID,ext_list=[&#39;save&#39;,&#39;occup&#39;])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39;set parent processID to 0 so they&#39;ll be different when the script starts&#39;&#39;&#39;</span>

                <span class="n">submitCommand</span><span class="o">=</span><span class="s1">&#39;qsub&#39;</span>
                <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
                    <span class="n">submitCommand</span><span class="o">=</span><span class="s1">&#39;sbatch&#39;</span>
                
                

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1">#            qsubFilename = oneCalc[&#39;__qsubFileName__&#39;]</span>
            
            
            <span class="n">qsubFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">submit_ID</span><span class="o">+</span><span class="s1">&#39;.qsub&#39;</span><span class="p">))</span>

            <span class="n">calcName</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__get_qsub_name</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>

            <span class="n">queue</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;queue&quot;</span><span class="p">)</span> <span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">queue</span> <span class="o">=</span> <span class="s1">&#39;-q </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;queue&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            
            <span class="n">command</span>  <span class="o">=</span> <span class="s2">&quot;ssh -o StrictHostKeyChecking=no </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> -N </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">submitCommand</span><span class="p">,</span><span class="n">queue</span><span class="p">,</span><span class="n">calcName</span><span class="p">,</span><span class="n">qsubFilename</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span>  <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>               

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;submitted </span><span class="si">%s</span><span class="s1"> to the queue&#39;</span> <span class="o">%</span> <span class="n">submit_ID</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;ssh -o StrictHostKeyChecking=no </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">submitCommand</span><span class="p">,</span><span class="n">qsubFilename</span><span class="p">)</span>
                <span class="n">job</span> <span class="o">=</span>  <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>               

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">baseID</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">baseID</span> <span class="o">=</span> <span class="n">ID</span>
                    <span class="n">qsubFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">baseID</span><span class="o">+</span><span class="s1">&#39;.qsub&#39;</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ssh -o StrictHostKeyChecking=no </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> -N </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">submitCommand</span><span class="p">,</span><span class="n">queue</span><span class="p">,</span><span class="n">calcName</span><span class="p">,</span><span class="n">qsubFilename</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">e</span>
                    <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
<span class="c1">#            globals()[&#39;execFileString&#39;] = os.path.abspath(os.path.join(folder,&#39;_&#39;+ID+&#39;.py&#39;))</span>
            <span class="n">execFileString</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
            

            <span class="nb">execfile</span><span class="p">(</span><span class="n">execFileString</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Got Keyboard Exit signal, exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Got Keyboard Exit signal, exiting&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __submitJob&#39;</span><span class="p">)</span>



<span class="c1">##############################################################################################</span>
<span class="kn">import</span> <span class="nn">__main__</span>
<div class="viewcode-block" id="submitFirstCalcs__"><a class="viewcode-back" href="../run.html#run.submitFirstCalcs__">[docs]</a><span class="k">def</span> <span class="nf">submitFirstCalcs__</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Submits the first step of a calculation&#39;s pipeline</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering __submitFirstCalcs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;__submitNodeName__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">__submitNodeName__</span>
        <span class="n">__submitNodeName__</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">__submitNodeName__</span><span class="o">=</span><span class="n">__main__</span><span class="o">.</span><span class="n">__submitNodeName__</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sending from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">__submitNodeName__</span><span class="p">)</span>
    
<span class="c1">#    if &#39;__submit__flag__&#39; not in globals().keys():</span>
<span class="c1">#        logging.debug(&#39;exiting __submitFirstCalcs without submitting&#39;)</span>
<span class="c1">#        return</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;Submitting Jobs&#39;</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">__submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __submitFirstCalcs&#39;</span><span class="p">)</span>        

</div>
<div class="viewcode-block" id="submit"><a class="viewcode-back" href="../run.html#run.submit">[docs]</a><span class="k">def</span> <span class="nf">submit</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sets global __submit__flag__ so calculations will start when user script completes</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__submit__flag__&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>

<span class="c1">#####################################################################################################################</span></div>
<span class="k">def</span> <span class="nf">__restartPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If pw.x ends becuause it hit max_seconds. set the input to restart the calculation</span>
<span class="sd">    and resubmit the job</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          a (float): Time that has passed since calculation has started</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#mod input so it will not start from scratch next submission            </span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entering AFLOWpi.run.__restartPW&#39;</span><span class="p">)</span>
    <span class="c1">#    limiter=0.9</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltime</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> 
<span class="c1">#    try:</span>
<span class="c1">#        inFileString = AFLOWpi.retr.__writeInputFromOutputString(oneCalc,ID)</span>
<span class="c1">#    except:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFileObj</span><span class="p">:</span>
        <span class="n">inFileString</span><span class="o">=</span> <span class="n">inputFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inFileString</span><span class="p">)</span>
    <span class="c1">#bring wfc,hub, or any other files needed from local scratch if need be</span>
    <span class="n">walltimeSec</span><span class="o">=</span><span class="mi">90000000000</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltimeSec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;if we can&#39;t find max_seconds in the input we just exit.&#39;&#39;&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not pwscf. Exiting AFLOWpi.run.__restartPW&#39;</span><span class="p">)</span>
        <span class="k">return</span>
<span class="c1">#        sys.exit(0)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;see if calc reached it&#39;s end.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="n">walltimeSec</span><span class="p">:</span>
            <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
            <span class="sd">&quot;&quot;&quot;if it did then set to restart the calc&quot;&quot;&quot;</span>

            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;restart_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;restart&#39;&quot;</span>
            <span class="sd">&#39;&#39;&#39; if the calc never had the time to start then just restart it from scratch&#39;&#39;&#39;</span>

            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">walltimeSec</span><span class="p">)</span>

            <span class="n">restartInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;write the new input file with the restarting&#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">restartInput</span><span class="p">)</span>                  
            <span class="sd">&#39;&#39;&#39;save to _&lt;ID&gt;.oneCalc&#39;&#39;&#39;</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restartInput</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;now resubmit&quot;&quot;&quot;</span>
            <span class="n">resubmitID</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1">#pull from local scratch before restarting</span>

            <span class="c1">#resubmit</span>
            <span class="sd">&#39;&#39;&#39;if we&#39;re at within 15 seconds of the end of walltime. don&#39;t submit and let restartScript do it&#39;&#39;&#39;</span>

            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

<span class="c1">#            AFLOWpi.prep.__from_local_scratch(oneCalc,ID)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">resubmitID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>                             
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Restart Job Submitted. Exiting AFLOWpi.run.__restartPW&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;and exit cleanly.&#39;&#39;&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Job completed in time. No need for restart. Exiting AFLOWpi.run.__restartPW&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__restartGIPAW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If pw.x ends becuause it hit max_seconds. set the input to restart the calculation</span>
<span class="sd">    and resubmit the job</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          a (float): Time that has passed since calculation has started</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFileObj</span><span class="p">:</span>
        <span class="n">inFileString</span><span class="o">=</span> <span class="n">inputFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inFileString</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltimeSec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;if we can&#39;t find max_seconds in the input we just exit.&#39;&#39;&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;see if calc reached it&#39;s end.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="n">walltimeSec</span><span class="p">:</span>
            <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
            <span class="sd">&quot;&quot;&quot;if it did then set to restart the calc&quot;&quot;&quot;</span>

            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inputgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;restart_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;restart&#39;&quot;</span>
            <span class="sd">&#39;&#39;&#39; if the calc never had the time to start then </span>
<span class="sd">                just restart it from scratch&#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inputgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;10&#39;</span><span class="p">:</span>
                    <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inpitgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;restart_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;from_scratch&#39;&quot;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">walltimeSec</span><span class="p">)</span>
            <span class="n">restartInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;write the new input file with the restarting&#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">restartInput</span><span class="p">)</span>                  
            <span class="sd">&#39;&#39;&#39;save to _&lt;ID&gt;.oneCalc&#39;&#39;&#39;</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restartInput</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;now resubmit&quot;&quot;&quot;</span>
            <span class="n">resubmitID</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="n">__submitJob</span><span class="p">(</span><span class="n">resubmitID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>                 
            <span class="sd">&quot;&quot;&quot;give it a bit of time to get the resubmission through&quot;&quot;&quot;</span>
<span class="c1">#            time.sleep(10)</span>
            <span class="sd">&#39;&#39;&#39;and exit cleanly.&#39;&#39;&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



<span class="c1">################################################################################################################</span>
<span class="k">def</span> <span class="nf">__getWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the walltime requested from the cluster submission script</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          walltime (int) amount of time requested</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">cluster_type</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">],</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">qsubfileObj</span><span class="p">:</span>
            <span class="n">qsubFileString</span> <span class="o">=</span> <span class="n">qsubfileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">50000000</span>

    <span class="k">if</span> <span class="n">cluster_type</span><span class="o">==</span><span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
        <span class="n">walltime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;walltime\s*=\s*([0-9:]*)&quot;</span><span class="p">,</span><span class="n">qsubFileString</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cluster_type</span><span class="o">==</span><span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
        <span class="n">walltime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;--time\s*=\s*([0-9:]*)&quot;</span><span class="p">,</span><span class="n">qsubFileString</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">splitW</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">walltime</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitW</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">splitW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitW</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">splitW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitW</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">splitW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitW</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">splitW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">walltime</span>


<span class="k">def</span> <span class="nf">__generic_restart_check</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to see if walltime limit is almost up. If it is within the buffer of time</span>
<span class="sd">    The job is resubmitted.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltime</span><span class="p">,</span><span class="n">startTime</span><span class="o">=</span><span class="n">__grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>    
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>
    <span class="n">from_config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;restart_buffer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">from_config</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">from_config</span><span class="p">)</span>
<span class="c1">#    if percent_timer&lt;1.0:</span>
<span class="c1">#        percent_timer=1.0-percent_timer</span>

    
    <span class="k">if</span> <span class="n">percent_timer</span><span class="o">&lt;</span><span class="mf">1.0</span><span class="p">:</span>
        <span class="n">num_secs</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">*</span><span class="n">percent_timer</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_secs</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">-</span><span class="n">percent_timer</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">timediff</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">timediff</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">runTime</span> <span class="o">=</span> <span class="n">num_secs</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TIMEDIFF = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">timediff</span><span class="p">)</span>      
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RUNTIME = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">runTime</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;num_secs = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">num_secs</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;percent_timer = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">percent_timer</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;STARTTIME = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">startTime</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;WALLTIME = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">walltime</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;if local scratch is being used don&#39;t run any steps if we&#39;re over 90% walltime&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">num_secs</span><span class="o">&lt;</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;set runTime to 0.0 make sure it trips the next if statement&#39;&#39;&#39;</span>
            <span class="n">runTime</span><span class="o">=</span><span class="mf">0.0</span>
            

    <span class="k">if</span> <span class="p">(</span><span class="n">runTime</span><span class="o">-</span><span class="mf">60.0</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">:</span>
        <span class="n">ID</span> <span class="o">=</span> <span class="n">__get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;if there&#39;s not enough time to do anything so resubmit before anything runs&#39;&#39;&#39;</span>
        <span class="sd">&#39;&#39;&#39;make sure the scratch is copied back&#39;&#39;&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job only has 60 seconds left. attempting to copy from local scratch if needed and resubmit job&#39;</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;force a new job&#39;&#39;&#39;</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>                 
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not enough time to start next step. Restarting&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        



<span class="k">def</span> <span class="nf">__setupRestartPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up pw.x input with max_seconds to it will cleanly exit if it</span>
<span class="sd">    doesn&#39;t finish within the time limit of the cluster submission </span>
<span class="sd">    walltime requested.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>




    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltime</span><span class="p">,</span><span class="n">startTime</span><span class="o">=</span><span class="n">__grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;if no walltime log in oneCalc (running local mode)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

    <span class="sd">&#39;&#39;&#39;set buffer to time before walltime to stop the job&#39;&#39;&#39;</span>
    <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>
    <span class="n">from_config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;restart_buffer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">from_config</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">from_config</span><span class="p">)</span>


        
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
        <span class="n">inputStr</span><span class="o">=</span><span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="sd">&#39;&#39;&#39;try to split input to include max time if it doesn&#39;t work stop and return&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inputStr</span><span class="p">)</span>
        <span class="n">calc_type</span><span class="o">=</span><span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;calculation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; &#39;`&quot; &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    <span class="sd">&#39;&#39;&#39;ibef calc type was found (i.e. not post processing) try to include max_seconds&#39;&#39;&#39;</span>
    <span class="n">typeList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span><span class="s1">&#39;nscf&#39;</span><span class="p">,</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="s1">&#39;vc-relax&#39;</span><span class="p">,</span><span class="s1">&#39;relax&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">timediff</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">timediff</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">if</span> <span class="n">calc_type</span> <span class="ow">in</span> <span class="n">typeList</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_sec</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">*</span><span class="n">percent_timer</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">percent_timer</span><span class="o">&gt;</span><span class="mf">1.0</span><span class="p">:</span>
                <span class="n">max_sec</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">-</span><span class="n">percent_timer</span><span class="p">))</span>
            <span class="k">if</span>  <span class="n">timediff</span><span class="o">&lt;</span><span class="p">(</span><span class="n">walltime</span><span class="o">*</span><span class="n">percent_timer</span><span class="p">):</span>
                <span class="n">runTime</span> <span class="o">=</span> <span class="n">max_sec</span><span class="o">-</span><span class="n">timediff</span>                
                <span class="sd">&#39;&#39;&#39;if script has already been running is small take the difference between walltime </span>
<span class="sd">                and time script has been running. leave 10% of walltime to do cleanup.&#39;&#39;&#39;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">runTime</span><span class="o">-</span><span class="mf">60.0</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.0</span> <span class="ow">or</span> <span class="n">timediff</span><span class="o">&gt;</span><span class="n">max_sec</span><span class="p">:</span>
                    <span class="sd">&#39;&#39;&#39;if there&#39;s not enough time to do anything so resubmit before anything runs&#39;&#39;&#39;</span>
                    <span class="sd">&#39;&#39;&#39;make sure the scratch is copied back&#39;&#39;&#39;</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Not enough time to start non-post processing calc. copying files from local scratch if needed and restarting&#39;</span><span class="p">)</span>

                    <span class="n">ID</span> <span class="o">=</span> <span class="n">__get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                    <span class="sd">&#39;&#39;&#39;force a new job&#39;&#39;&#39;</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>                 
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not enough time to start pwscf. Restarting&#39;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        
            
            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">runTime</span><span class="p">)</span>
            <span class="n">restartInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">restartInput</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restartInput</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;if option to restart doesnt exist in the input of </span><span class="si">%s</span><span class="s1"> this will be thrown&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>



<span class="k">def</span> <span class="nf">__setupRestartGIPAW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up GIPAW input with max_seconds to it will cleanly exit if it</span>
<span class="sd">    doesn&#39;t finish within the time limit of the cluster submission </span>
<span class="sd">    walltime requested.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltime</span><span class="p">,</span><span class="n">startTime</span><span class="o">=</span><span class="n">__grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    
    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">startTime</span>



    <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;restarttimer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">percent_timer</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>




    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
        <span class="n">inputStr</span><span class="o">=</span><span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="sd">&#39;&#39;&#39;try to split input to include max time if it doesn&#39;t work stop and return&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">inputStr</span><span class="p">)</span>
        <span class="n">calc_type</span><span class="o">=</span><span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inputgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;calculation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; &#39;`&quot; &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    <span class="sd">&#39;&#39;&#39;ibef calc type was found (i.e. not post processing) try to include max_seconds&#39;&#39;&#39;</span>
    <span class="n">typeList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;emr&#39;</span><span class="p">,</span><span class="s1">&#39;efg&#39;</span><span class="p">,</span><span class="s1">&#39;g_vectors&#39;</span><span class="p">,</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">calc_type</span> <span class="ow">in</span> <span class="n">typeList</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timediff</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">timediff</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">runTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">*</span><span class="n">percent_timer</span><span class="o">-</span><span class="n">timediff</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">timediff</span><span class="o">&lt;</span><span class="p">(</span><span class="n">walltime</span><span class="o">*</span><span class="n">percent_timer</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;if script has already been running is small take the difference between walltime </span>
<span class="sd">                and time script has been running. leave 10% of walltime to do cleanup.&#39;&#39;&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39;if there&#39;s not enough time to do anything so resubmit before anything runs&#39;&#39;&#39;</span>
                <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="bp">False</span>
            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inputgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">runTime</span>
            <span class="n">restartInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">restartInput</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restartInput</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;if option to restart doesnt exist in the input of </span><span class="si">%s</span><span class="s1"> this will be thrown&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>




<span class="k">def</span> <span class="nf">__writeWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">walltimeDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the walltimeDict to disk ( _&lt;ID&gt;.oneCalc )</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          walltimeDict (dict): saves the walltime log to oneCalc and then to disk</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">walltimeDict</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">__readWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    reads walltime log from oneCalc</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          walltimeLog (dict): dictionary containing start time for AFLOWpi as well</span>
<span class="sd">                              as the requested walltime for the cluster job </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span>






<span class="kn">import</span> <span class="nn">__main__</span>
<span class="k">def</span> <span class="nf">__grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    find the start time of current step in chain and record that into the walltime file</span>
<span class="sd">    </span>
<span class="sd">    Arguments:          </span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          walltimeStart (int): walltime requested</span>
<span class="sd">          startTime (int): start time of the script</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>        
        <span class="n">output</span> <span class="o">=</span> <span class="n">__readWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

<span class="c1">#        AFLOWpi.run._fancy_error_log(e)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__writeWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>


        <span class="sd">&#39;&#39;&#39;grab the first walltime in case stepsasjobs==false for all jobs in chain&#39;&#39;&#39;</span>

        <span class="n">walltimeStart</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]</span>    
        <span class="n">startTime</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;startTime Test: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">startTime</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="mi">40000000</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">walltimeStart</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">startTime</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__setStartTime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If this python script is the first to run in for AFLOWpi in a cluster job then</span>
<span class="sd">    the start time will be recorded and stored in the oneCalc object with the key  </span>
<span class="sd">    &quot;__walltime_dict__&quot; and the values for the start time of the script and the </span>
<span class="sd">    requested walltime. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:          </span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          walltimeStart (int): walltime requested</span>
<span class="sd">          startTime (int): start time of the script</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">oneCalc</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">walltime_dict</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">walltime_dict</span><span class="o">=</span><span class="p">{}</span>
    

        <span class="k">if</span>  <span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="sd">&#39;&#39;&#39;only move from local scratch if this script is starting fresh&#39;&#39;&#39;</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__to_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            
            <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">__main__</span><span class="o">.</span><span class="n">__CLOCK__</span>
            <span class="n">walltime_dict</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__getWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>         

            <span class="n">walltime_dict</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">__main__</span><span class="o">.</span><span class="n">__CLOCK__</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__writeWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">walltime_dict</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span> 
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">walltime_dict</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">walltime_dict</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">40000000000.0</span>         
            <span class="n">walltime_dict</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__writeWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">walltime_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">oneCalc</span>


<span class="k">def</span> <span class="nf">__restartScript</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">PID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    special script started when the _&lt;ID&gt;.py script starts. reads the walltime in the qsub file and </span>
<span class="sd">    resubmits and then exits if the time ran gets within 1 minute of the walltime requested. </span>
<span class="sd">    Used for when the script is on the post processing stages and may happen to get killed by</span>
<span class="sd">    the cluster daemon.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="sd">&#39;&#39;&#39;keep trying to find oneCalc and ID from &#39;&#39;&#39;</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;main processess running on PID: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">PID</span><span class="p">)</span>
    <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;restarttimer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">percent_timer</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>

    <span class="n">walltime</span><span class="p">,</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">__grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBLAL_CLOCK__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">startTime</span>
    
    <span class="n">walltime</span>  <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span>
<span class="c1">#    __main__.__GLOBAL_CLOCK__=float(startTime)</span>
<span class="c1">#    globals()[&#39;__GLOBAL_CLOCK__&#39;]=startTime</span>
    
    <span class="n">__submitNodeName__</span><span class="o">=</span><span class="n">__main__</span><span class="o">.</span><span class="n">__submitNodeName__</span>

    <span class="n">stepsasjobs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;stepsasjobs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">stepsasjobs</span><span class="o">==</span><span class="s1">&#39;false&#39;</span> <span class="ow">or</span> <span class="n">stepsasjobs</span><span class="o">==</span><span class="s1">&#39;f&#39;</span><span class="p">:</span>
        <span class="n">stepsasjobsBool</span><span class="o">=</span><span class="bp">False</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;stepsasjobs set to false in config file. reading in start time from oneCalc&#39;</span><span class="p">)</span>

    <span class="n">currentTime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;walltime in seconds: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">walltime</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting monitoring thread for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>
    <span class="n">remainingTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">currentTime</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;time since start for _&lt;ID&gt;.py = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>  <span class="n">currentTime</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;current time till ending _&lt;ID&gt;.py = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>  <span class="n">remainingTime</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;restart script and exit immediately if it&#39;s about to be killed by the cluster&#39;&#39;&#39;</span>
    <span class="k">while</span> <span class="n">walltime</span><span class="o">-</span><span class="n">currentTime</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;update time to reflect current time&#39;&#39;&#39;</span>        
        <span class="n">currentTime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span><span class="p">]</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if we&#39;ve moved into another step with stepsasjobs==false then we don&#39;t </span>
<span class="sd">        need the restartScript from this step anymore so we should exit the thread</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__TEMP__INDEX__COUNTER__&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]:</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;check to see if main script is running..if not it&#39;s </span>
<span class="sd">           not then something went wrong in the main script and this should also exit&#39;&#39;&#39;</span>

            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">PID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;main script did not exit cleanly. killing __restartScript subprocess&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s1">&#39;main script did not exit cleanly. killing __restartScript subprocess&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job not completed in time. Restarting from that step.&#39;</span><span class="p">)</span>

    <span class="n">oneCalc</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Resubmission successful. Waiting 5 seconds then ending main script&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;after the job is submitted wait ten seconds to exit the script&#39;&#39;&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;and exit gracefully&#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;telling main process to stop&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">PID</span><span class="p">,</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">)</span> 
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="c1">##################################################################################################################</span>
<span class="k">def</span> <span class="nf">__convert_fortran_double</span><span class="p">(</span><span class="n">fort_double_string</span><span class="p">,</span><span class="n">string_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    find the start time of current step in chain and record that into the walltime file</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          fort_double_string (str): Fortran double in string form</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          string_output (bool): Output a string or a float</span>

<span class="sd">    Returns:</span>
<span class="sd">          fort_double_string (float): the fotran double in float form or string</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fort_double_string</span><span class="o">=</span><span class="n">fort_double_string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">fort_double_list</span><span class="o">=</span><span class="n">fort_double_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">fort_double_list</span><span class="o">=</span><span class="n">fort_double_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fort_double_string</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fort_double_string</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">mult</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="nb">int</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">base</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">retr_float</span><span class="o">=</span><span class="n">base</span><span class="o">*</span><span class="n">mult</span>
        <span class="k">if</span> <span class="n">string_output</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">retr_float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">retr_float</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
        <span class="k">print</span> <span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fort_double_string</span>

<span class="c1"># def __lower_mixing(oneCalc,ID):</span>


<span class="c1">#     inputDict=AFLOWpi.retr.__splitInput(oneCalc[&#39;_AFLOWPI_INPUT_&#39;])</span>
<span class="c1">#     try:</span>
<span class="c1">#         if &#39;&amp;electrons&#39; not in inputDict.keys():</span>
<span class="c1">#             inputDict[&#39;&amp;electrons&#39;]=collections.OrderedDict()</span>
<span class="c1">#         old_beta=&#39;0.7d0&#39;</span>
<span class="c1">#         if &#39;mixing_beta&#39; in inputDict[&#39;&amp;electrons&#39;].keys():</span>
<span class="c1">#             old_beta=inputDict[&#39;&amp;electrons&#39;][&#39;mixing_beta&#39;]</span>

<span class="c1">#         old_beta_float=__convert_fortran_double(old_beta)</span>
<span class="c1">#         new_beta_float=old_beta_float-0.2</span>
<span class="c1">#         if new_beta_float&gt;0.09:</span>
<span class="c1">#             inputDict[&#39;&amp;electrons&#39;][&#39;mixing_beta&#39;]=str(new_beta_float)</span>
<span class="c1">#             inputString=AFLOWpi.retr.__splitInput(inputDict)</span>
<span class="c1">#             oneCalc[&#39;_AFLOWPI_INPUT_&#39;]=inputString</span>

<span class="c1">#             outFileName = os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],ID+&#39;.in&#39;)</span>
<span class="c1">#             with open(outFileName,&#39;w&#39;) as outFile:</span>
<span class="c1">#                 outFile.write(inputString)</span>
<span class="c1">#     except:</span>
<span class="c1">#         pass</span>
<span class="c1">#     AFLOWpi.prep.__saveOneCalc(oneCalc,ID)</span>
    
<span class="c1">#     return oneCalc,ID</span>
    

<span class="k">def</span> <span class="nf">__get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEFUNCT. CANDIDATE FOR REMOVAL</span>
<span class="sd">    </span>
<span class="sd">    Arguments: </span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation         </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None  </span>

<span class="sd">    Returns:</span>
<span class="sd">          ID (str): Returns the input ID</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ID</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">index</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span><span class="n">index</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ID</span>


<span class="k">def</span> <span class="nf">__PW_bands_fix</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accounts for the occational problem of the bands.x output being </span>
<span class="sd">    improperly formatted for AFLOWpi to parse later.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">rd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;fix bands.out where you have large numbers butting up against each other ex.) -113.345-112.567 </span>
<span class="sd">        and split the two numbers up for processing with band_plot.x or else you&#39;ll get an error&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_band_data.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileinput</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_band_data.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileoutput</span><span class="p">:</span>
                <span class="n">correctedText</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;(\d)([-][\d])&#39;</span><span class="p">,</span><span class="s1">r&#39;\1 \2&#39;</span><span class="p">,</span><span class="nb">input</span><span class="p">)</span>
                <span class="n">fileoutput</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">correctedText</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="c1">##### make the bands.xmgr now that band_plot.x is gone</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_band_data.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bands_out_file</span><span class="p">:</span>
            <span class="n">bands_out_lines</span> <span class="o">=</span> <span class="n">bands_out_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">indent_re</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;      &#39;</span><span class="p">)</span>
        <span class="n">total</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">path_vals</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">k_val</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">total_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bands_out_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">indent_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dist</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span><span class="o">-</span><span class="n">total_path_length</span>
                    <span class="n">path_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_val</span><span class="p">)</span>
                    <span class="n">total_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>            
                    <span class="n">total</span><span class="o">+=</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

                    <span class="n">k_val</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">total_path_length</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">k_val</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()]))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">path_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_val</span><span class="p">)</span>
        <span class="n">total_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
        <span class="n">path_vals</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">path_vals</span><span class="p">)</span>
        <span class="n">output_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">path_vals</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">print_list</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)):</span>
                <span class="n">output_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%12.7f</span><span class="s1"> </span><span class="si">%12.5f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">total_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">item</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">output_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_bands.xmgr&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bands_out_file</span><span class="p">:</span>
            <span class="n">bands_out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_string</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>




<span class="k">def</span> <span class="nf">__vcrelax_error_restart</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restarts if vc-relax calculation fails</span>

<span class="sd">    BROKEN/NOT NEEDED POSSIBLY DELETE</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">error_regex_list</span><span class="o">=</span><span class="p">[]</span>


    <span class="n">submit_ID</span> <span class="o">=</span> <span class="n">__get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>        
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__check_restart</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
            <span class="n">oneCalc</span><span class="p">,</span><span class="n">submit_ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;restart_mode&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;from_scratch&#39;&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFileObj</span><span class="p">:</span>
        <span class="n">outFileString</span> <span class="o">=</span> <span class="n">outFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">re_error</span> <span class="ow">in</span>  <span class="n">error_regex_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                        <span class="n">oneCalcBase</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">submit_ID</span><span class="p">)</span>
                        <span class="n">oneCalcBase</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalcBase</span><span class="p">,</span><span class="n">submit_ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">submit_ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                

<span class="k">def</span> <span class="nf">__io_error_restart</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restarts if I/O error encountered</span>

<span class="sd">    BROKEN/NOT NEEDED POSSIBLY DELETE</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;restart_mode&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;from_scratch&#39;&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">error_regex_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Error in routine diropn&#39;</span><span class="p">))</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Error in routine davcio&#39;</span><span class="p">))</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Error in routine pw_readfile&#39;</span><span class="p">))</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Error in routine seqopn&#39;</span><span class="p">))</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;kpt grid not Monkhorst-Pack&#39;</span><span class="p">))</span>
    <span class="n">submit_ID</span> <span class="o">=</span> <span class="n">__get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFileObj</span><span class="p">:</span>
        <span class="n">outFileString</span> <span class="o">=</span> <span class="n">outFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">re_error</span> <span class="ow">in</span>  <span class="n">error_regex_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Error in routine pw_readfile&#39;</span> <span class="ow">or</span> <span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kpt grid not Monkhorst-Pack&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">oneCalcBase</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">submit_ID</span><span class="p">)</span>
                        <span class="n">oneCalcBase</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalcBase</span><span class="p">,</span><span class="n">submit_ID</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Trying again...&quot;</span><span class="o">%</span><span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">oneCalcBase</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">submit_ID</span><span class="p">)</span>

                        
                    <span class="n">restart_num</span> <span class="o">=</span> <span class="n">oneCalcBase</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span>
                    <span class="n">oneCalcBase</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restart_num</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restart_num</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">restart_num</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
                        <span class="n">oneCalcBase</span><span class="p">[</span><span class="s2">&quot;__execCounter__&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s2">&quot;__execCounter__&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">restart_num</span><span class="o">&gt;</span><span class="mi">15</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalcBase</span><span class="p">,</span><span class="n">submit_ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">submit_ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">##################################################################################################################</span>

<span class="k">def</span> <span class="nf">__qe__pre_run</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs the pre-run checks and restarts the cluster job if needed. </span>
<span class="sd">    On local mode this gets skipped</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          calcType (str): type of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">rd</span> <span class="o">=</span><span class="s1">&#39;./&#39;</span>

    <span class="k">if</span> <span class="n">calcType</span><span class="o">==</span><span class="s1">&#39;scf&#39;</span><span class="p">:</span>    
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__setup_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;SLURM&#39;</span><span class="p">]:</span>


            <span class="c1">#         #if it&#39;s scf/nscf setup local scratch</span>
            <span class="c1">#         #if it&#39;s a restart files will be transferred to nodes</span>

            <span class="c1"># else:</span>
            <span class="c1">#         try:</span>

            <span class="c1">#             #if it&#39;s post processing pull the files from the local scratch</span>
            <span class="c1">#             pass</span>

            <span class="c1">#         except Exception,e:</span>
            <span class="c1">#             AFLOWpi.run._fancy_error_log(e)</span>

            <span class="sd">&#39;&#39;&#39;if there&#39;s 60 seconds or less left exit immediately and don&#39;t start a new job&#39;&#39;&#39;</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__generic_restart_check</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">calcType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]:</span>    
                <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__setupRestartPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span>



            <span class="k">if</span> <span class="n">calcType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;emr&#39;</span><span class="p">,</span><span class="s1">&#39;nmr&#39;</span><span class="p">,</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">,</span><span class="s1">&#39;gvectors&#39;</span><span class="p">]:</span>
                <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">restartBool</span> <span class="o">=</span> <span class="n">__setupRestartGIPAW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>




    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;scf&#39;</span> <span class="ow">and</span> <span class="n">calcType</span><span class="o">!=</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;custom&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.in&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">calcType</span><span class="p">),</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">PPInput</span><span class="p">:</span>
                    <span class="n">PPInput</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">__makeInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

<span class="c1">###############################################################################################################</span>

<span class="k">def</span> <span class="nf">__oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">nextCalc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">nextConf</span><span class="o">=</span><span class="bp">None</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a single calculation in the dictionary with a specific engine</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>

<span class="sd">	  oneCalc (dict): dictionary of the calculation</span>
<span class="sd">          ID (str): Identifying hash of the calculation</span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations          </span>
<span class="sd"> 	  execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)</span>
<span class="sd">	  execPostfix (str): commands to go after the executable when run</span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          calcType (str): used to pull the engine post processing executable to the calc dir</span>
<span class="sd">                          and to write the postprocessing input file if needed</span>
<span class="sd">          executable (str): if the executable has already been copied to the calc&#39;s directory</span>
<span class="sd">                            then use this to run the input &lt;ID&gt;.in</span>
<span class="sd">          execPath (str): path of the executable if needed</span>
<span class="sd">          nextCalc (str): DEFUNCT</span>
<span class="sd">          nextConf (str): DEFUNCT</span>

<span class="sd">          </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering __oneRun&#39;</span><span class="p">)</span>


    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>

    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">])</span>
    <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;save the status of the calcs&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;__status__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Start&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Complete&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">False</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="c1"># &#39;&#39;&#39;set the completed status to false in the case of a looping set of calcs&#39;&#39;&#39;</span>
    <span class="c1"># </span>





    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">rd</span> <span class="o">=</span><span class="s1">&#39;./&#39;</span>

    <span class="sd">&#39;&#39;&#39;do the setup&#39;&#39;&#39;</span>

    <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__qe__pre_run</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">engine</span><span class="p">)</span>


<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
        <span class="c1">########################################################################################################</span>





       <span class="c1">########################################################################################################</span>


       <span class="c1">########################################################################################################</span>



<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;scf&#39;</span> <span class="ow">and</span> <span class="n">calcType</span><span class="o">!=</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">calcType</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
            <span class="n">ro</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">calcType</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
            <span class="n">ro</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>




        <span class="k">if</span> <span class="n">execPath</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="n">executable</span> <span class="o">=</span> <span class="n">__getExecutable</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">)</span>

            <span class="n">executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">executable</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execPath</span> <span class="o">=</span> <span class="n">execPath</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">engine</span><span class="p">)):</span>
            <span class="n">command</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &lt; </span><span class="si">%s</span><span class="s1">  &gt;  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPath</span><span class="p">,</span><span class="n">executable</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">ro</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &lt; </span><span class="si">%s</span><span class="s1">  &gt;  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPath</span><span class="p">,</span><span class="n">executable</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">ro</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1">###############################################################################################################      </span>
    <span class="k">try</span><span class="p">:</span>	
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">home</span><span class="p">))</span>
        <span class="k">print</span> <span class="s2">&quot;starting </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">home</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;SLURM&#39;</span><span class="p">]:</span>
            <span class="n">job</span> <span class="o">=</span>  <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">cwd</span><span class="o">=</span><span class="n">rd</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">job</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>               

                

<span class="c1">#                typeList = [&#39;band]</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################     </span>
            <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;SLURM&#39;</span><span class="p">]:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__restartPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span> 

            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
<span class="c1">#                    print job.returncode</span>
                    <span class="k">if</span> <span class="n">calcType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]:</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">calcType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;emr&#39;</span><span class="p">,</span><span class="s1">&#39;nmr&#39;</span><span class="p">,</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">,</span><span class="s1">&#39;gvectors&#39;</span><span class="p">]:</span>
                        <span class="n">__restartGIPAW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
               <span class="c1"># __io_error_restart(ID,oneCalc,__submitNodeName__)</span>



            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">255</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> returned exit code: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;None&#39;</span><span class="p">:</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;Exited Status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Exit Status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Exited Status </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mi">1</span> 
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>                                


                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;FAILED TO CONVERGE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">:</span>				
                <span class="c1">#empty text file is created in the AFLOWpi folder</span>
                <span class="c1">#is created and the keys of the failed to converge</span>
                <span class="c1">#calculations is written in the file</span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;QE ERR </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
       <span class="c1">###############################################################################################################</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;finished </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">rd</span><span class="p">))</span>
        <span class="k">print</span> <span class="s2">&quot;finished </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">rd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;savedir&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__moveToSavedir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">ro</span><span class="p">))</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__moveToSavedir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">ri</span><span class="p">))</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/*</span><span class="si">%s</span><span class="s1">*.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__moveToSavedir</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">pdf</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/*</span><span class="si">%s</span><span class="s1">*.pdf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;STARTING DATA&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="n">ID</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RECORDING DATA&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">getCellOutput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
       <span class="c1">###############################################################################################################</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;Got Keyboard Exit signal, exiting&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Got Keyboard Exit signal, exiting&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;ERROR! &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR! &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;ERROR! &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR! &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;exit code==1&quot;</span>


        <span class="c1">##############################################################################################################</span>

<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
<span class="c1">#################################################################################################################      </span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">home</span><span class="p">)</span>		



    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Complete&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __oneRun&#39;</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">__onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">alt_ID</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares one calculation run an engine executable</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          engine (str): executable that you are calling to run the calculations (default=&#39;pw.x&#39;)          </span>
<span class="sd">          execPrefix (str): commands to go before the executable when run (ex. mpiexec nice -n 19 &lt;executable&gt;) </span>
<span class="sd">                            (default = None)</span>
<span class="sd">          execPostfix (str): commands to go after the executable when run (ex. &lt;execPrefix&gt; &lt;executable&gt; -npool 12 )</span>
<span class="sd">                             (default = None)</span>
<span class="sd">          calcType (str): used to prep for a particular type of calc (i.e. &#39;scf&#39;,&#39;pdos&#39;..etc) </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering __onePrep&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">execPrefix</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">execPrefix</span> <span class="o">==</span>  <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execprefix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">execPostfix</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">execPostfix</span> <span class="o">==</span>  <span class="s1">&#39;&#39;</span><span class="p">:</span>

        <span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;execpostfix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="n">folder</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>


    <span class="sd">&quot;&quot;&quot;run projwfc.x on all the folders&quot;&quot;&quot;</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">rd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;dos.out is the output from dos.x as designated within dos.in&quot;&quot;&quot;</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alt_ID</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">write_ID</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write_ID</span><span class="o">=</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">alt_ID</span>

        <span class="n">execString</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">execString</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;if oneCalc[&#39;__execCounter__&#39;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">        AFLOWpi.run.__oneRun&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span>

        <span class="n">execString</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;(__submitNodeName__,oneCalc,</span><span class="si">%s</span><span class="s1">,execPrefix=&#39;</span><span class="si">%s</span><span class="s1">&#39;,execPostfix=&#39;</span><span class="si">%s</span><span class="s1">&#39;,engine=&#39;</span><span class="si">%s</span><span class="s1">&#39;,calcType=&#39;</span><span class="si">%s</span><span class="s1">&#39;)</span>
<span class="s1">        oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">        AFLOWpi.prep.__saveOneCalc(oneCalc,ID)</span>
<span class="s1">        &#39;&#39;&#39;</span>  <span class="o">%</span> <span class="p">(</span><span class="n">write_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">)</span>

        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">execFileString</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ID: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">execString</span><span class="p">)</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __onePrep&#39;</span><span class="p">)</span>
<span class="c1">################################################################################################################</span>

<span class="c1">################################################################################################################</span>
<span class="k">def</span> <span class="nf">__makeInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the input file for postprocessing calculations</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): Dictionary of one of the calculations          </span>
<span class="sd">          engine (str): Particular engine executable being used for the postprocessing step </span>
<span class="sd">                        that you are calling to run the calculations (default=&#39;pw.x&#39;)          </span>
<span class="sd">          calcType (str): Type of PP calculation to be done</span>
<span class="sd">          </span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">          ID (str): ID hash for the calculation. Needed for the filename (&lt;ID&gt;_&lt;calcType&gt;.in)</span>

<span class="sd">    Returns:</span>
<span class="sd">          stringDict (str): Input string of the PP step</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__prefixFromInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>

    <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__get_tempdir</span><span class="p">()</span>
    <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> 
    <span class="n">calcType</span><span class="o">=</span><span class="n">calcType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;espresso&#39;</span><span class="p">:</span>
        <span class="n">bandsInput</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
        <span class="n">nbnd</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;scf&#39;</span><span class="p">:</span>
            <span class="n">bandsInput</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbnd</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nbnd</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;nbnd\s*=\s*([0-9]+)&#39;</span><span class="p">,</span><span class="n">bandsInput</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">nbnd</span><span class="o">=</span><span class="s1">&#39;30&#39;</span>

        <span class="n">stringDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dos&#39;</span><span class="p">:</span>
                        <span class="sd">&quot;&quot;&quot; &amp;dos</span>
<span class="sd">       prefix=&#39;%s&#39;</span>
<span class="sd">       outdir=&#39;%s&#39;</span>
<span class="sd">       fildos=&#39;%s_dos.dat&#39;</span>

<span class="sd">      /</span>
<span class="sd">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">ID</span><span class="p">),</span>
                            <span class="s1">&#39;pdos&#39;</span><span class="p">:</span><span class="s2">&quot;&quot;&quot;  &amp;projwfc</span>
<span class="s2">       prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">    !  DeltaE=0.03</span>
<span class="s2">!       Emax=20</span>
<span class="s2">!       Emin=-20</span>
<span class="s2">       outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>

<span class="s2">    !    kresolveddos=.true.</span>
<span class="s2">       filpdos=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>

<span class="s2">      / </span>
<span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">ID</span><span class="p">),</span>

                    <span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="s2">&quot;&quot;&quot; &amp;bands</span>
<span class="s2">     prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">     outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">     filband=&#39;./</span><span class="si">%s</span><span class="s2">_band_data.out&#39;</span>
<span class="s2"> /</span>
<span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">ID</span><span class="p">),</span>


                    <span class="s1">&#39;scf&#39;</span><span class="p">:</span>
                        <span class="s1">&#39;None&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nmr&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;&amp;inputgipaw</span>
<span class="sd">  job = &#39;nmr&#39;</span>
<span class="sd">  prefix=&#39;%s&#39;</span>

<span class="sd">/</span>
<span class="sd">&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">prefix</span><span class="p">,</span>
                    <span class="s1">&#39;g_tensor&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;&amp;inputgipaw</span>
<span class="sd">  job = &#39;g_tensor&#39;</span>
<span class="sd">  prefix=&#39;%s&#39;</span>

<span class="sd">/&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">prefix</span><span class="p">,</span>

                    <span class="s1">&#39;emr&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;&amp;inputgipaw</span>
<span class="sd">  job = &#39;efg&#39;</span>
<span class="sd">  prefix=&#39;%s&#39;</span>
<span class="sd">                    </span>
<span class="sd">/</span>

<span class="sd">&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">prefix</span><span class="p">,</span>
                    <span class="s1">&#39;hyperfine&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;&amp;inputgipaw</span>
<span class="sd">  job = &#39;hyperfine&#39;</span>
<span class="sd">  prefix=&#39;%s&#39;</span>
<span class="sd">  hfi_output_unit = &#39;MHz&#39;</span>
<span class="sd">/</span>
<span class="sd">&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">prefix</span><span class="p">,</span>


                            <span class="p">}</span>

        

    <span class="k">return</span> <span class="n">stringDict</span><span class="p">[</span><span class="n">calcType</span><span class="p">]</span>
      
<span class="c1">################################################################################################################        </span>
<span class="c1">################################################################################################################</span>
 
        
            


                 

        
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Andrew Supka.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>