

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>run &mdash; AFLOWpi  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="AFLOWpi  documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> AFLOWpi
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plot.html">plot module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prep.html">prep module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pseudo.html">pseudo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../retr.html">retr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run.html">run module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scfuj.html">scfuj module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AFLOWpi</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>run</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for run</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">logging</span> 
<span class="kn">import</span> <span class="nn">re</span> 
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>                                                                     
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">__main__</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">pipes</span>


<span class="k">if</span> <span class="n">__name__</span><span class="o">!=</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">engineDict</span><span class="o">=</span><span class="p">{}</span>

<span class="k">def</span> <span class="nf">_exitClean</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the terminate 15 signal is received exit with 0 exit code</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          signal (signal.SIGNAL): *nix signal</span>
<span class="sd">          frame (frame): Inspect frame</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;got the signal to exit cleanly. Exiting.&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_recordDeath</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the 15 signal to terminate the process is sent. </span>
<span class="sd">    Record it in oneCalc[&#39;__status__&#39;][&#39;Error&#39;]</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          signal (signal.SIGNAL): *nix signal</span>
<span class="sd">          frame (frame): Inspect frame</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Job Killed.&#39;</span><span class="p">)</span>

<span class="c1">#    index=globals()[&quot;__TEMP__INDEX__COUNTER__&quot;]</span>
    <span class="k">try</span><span class="p">:</span>
<span class="c1">#        if int(__main__.oneCalc[&#39;_AFLOWPI_INDEX_&#39;])==index:</span>
            <span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;Killed&quot;</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__main__</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<div class="viewcode-block" id="cleanup"><a class="viewcode-back" href="../run.html#run.cleanup">[docs]</a><span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes all files a calculation set&#39;s  directory</span>
<span class="sd">    tree that are prepended with &#39;_&#39;</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations                </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;CLEANUP&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">import os</span><span class="se">\n</span><span class="s1">os.system(&quot;rm -rf </span><span class="si">%s</span><span class="s1">/_*&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="addatexit__"><a class="viewcode-back" href="../run.html#run.addatexit__">[docs]</a><span class="k">def</span> <span class="nf">addatexit__</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to add function to be run at exit</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          command (func): function to be run</span>
<span class="sd">          *args: arguments for command</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          **kwargs: Keyword arguments for command</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="s1">&#39;__atexitList&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#######################################</span>
        <span class="nd">@atexit</span><span class="o">.</span><span class="n">register</span>
        <span class="k">def</span> <span class="nf">_runatexitList</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">__atexitList</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="o">*</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">**</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">global</span> <span class="n">__atexitList</span>
        <span class="n">__atexitList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">__atexitList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">command</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">kwargs</span><span class="p">))</span></div>




<span class="k">def</span> <span class="nf">_colorize_message</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Colorizes text. Used for colorizing the logging</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          string (str): A string of text</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          level (str): Specific colors are chosen for logging message type</span>

<span class="sd">    Returns:</span>
<span class="sd">          levelname_color (str): Colorized version of the string input</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">BLACK</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="n">MAGENTA</span><span class="p">,</span> <span class="n">CYAN</span><span class="p">,</span> <span class="n">WHITE</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

    <span class="n">RESET_SEQ</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
    <span class="n">COLOR_SEQ</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1;</span><span class="si">%d</span><span class="s2">m&quot;</span>
    <span class="n">BOLD_SEQ</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1m&quot;</span>

    <span class="n">COLORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;WARNING&#39;</span><span class="p">:</span> <span class="n">YELLOW</span><span class="p">,</span>
        <span class="s1">&#39;INFO&#39;</span><span class="p">:</span> <span class="n">WHITE</span><span class="p">,</span>
        <span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span> <span class="n">BLUE</span><span class="p">,</span>
        <span class="s1">&#39;CRITICAL&#39;</span><span class="p">:</span> <span class="n">YELLOW</span><span class="p">,</span>
        <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span> <span class="n">RED</span><span class="p">,</span>
        <span class="s1">&#39;GREEN&#39;</span><span class="p">:</span> <span class="n">GREEN</span>        <span class="p">,</span>
    <span class="p">}</span>


    <span class="n">levelname</span><span class="o">=</span><span class="n">level</span>
    <span class="k">if</span> <span class="n">show_level</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">levelname_color</span> <span class="o">=</span> <span class="n">COLOR_SEQ</span> <span class="o">%</span> <span class="p">(</span><span class="mi">30</span> <span class="o">+</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">levelname</span><span class="p">])</span> <span class="o">+</span> <span class="n">levelname</span> <span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span><span class="n">string</span><span class="o">+</span> <span class="n">RESET_SEQ</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">levelname_color</span> <span class="o">=</span> <span class="n">COLOR_SEQ</span> <span class="o">%</span> <span class="p">(</span><span class="mi">30</span> <span class="o">+</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">levelname</span><span class="p">])</span> <span class="o">+</span> <span class="n">string</span><span class="o">+</span> <span class="n">RESET_SEQ</span>
    <span class="k">return</span> <span class="n">levelname_color</span>


<span class="k">def</span> <span class="nf">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logs an error and prints it out on the stdout if logging=debug in the config file used</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          e (str): string of the error </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%&#39;</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
    <span class="n">errorList</span> <span class="o">=</span>  <span class="n">traceback</span><span class="o">.</span><span class="n">format_list</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:])[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">errorMSG</span> <span class="ow">in</span> <span class="n">errorList</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">errorMSG</span><span class="p">))</span>     
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%&#39;</span><span class="p">))</span>       

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;log_level&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>
                <span class="k">for</span> <span class="n">errorMSG</span> <span class="ow">in</span> <span class="n">errorList</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="n">errorMSG</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>

            <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%DEBUG</span><span class="si">%%</span><span class="s1">%&#39;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">_getEnginePath</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the name of the executable file for the ab initio engine</span>
<span class="sd">    for a given type of calculation.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          engine (str): Ab initio engine being used</span>
<span class="sd">          calcType (str): Type of calculation to be done</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          execPath (str): the name of the executable for that engine for that calcType</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;espresso&#39;</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bands&#39;</span><span class="p">:[</span><span class="s1">&#39;./bands.x&#39;</span><span class="p">],</span>

                  <span class="s1">&#39;pdos&#39;</span><span class="p">:[</span><span class="s1">&#39;./projwfc.x&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;dos&#39;</span><span class="p">:[</span><span class="s1">&#39;./dos.x&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;scf&#39;</span><span class="p">:[</span><span class="s1">&#39;./pw.x&#39;</span><span class="p">],}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">execPath</span><span class="o">=</span><span class="n">execDict</span><span class="p">[</span><span class="n">calcType</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">execPath</span>

<span class="c1">################################################################################################################</span>

<span class="c1">################################################################################################################</span>
<span class="k">def</span> <span class="nf">_getExecutable</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the name of the executable file for the ab initio engine</span>
<span class="sd">    for a given type of calculation.</span>

<span class="sd">    OBSOLETE. NEEDS REMOVAL. AFLOWpi.run._getEnginePath is almost identical </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          engine (str): Ab initio engine being used</span>
<span class="sd">          calcType (str): Type of calculation to be done</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          executable (str): the name of the executable for that engine for that calcType</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;espresso&#39;</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scf&#39;</span><span class="p">:</span><span class="s1">&#39;pw.x&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;dos&#39;</span><span class="p">:</span><span class="s1">&#39;dos.x&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;pdos&#39;</span><span class="p">:</span><span class="s1">&#39;projwfc.x&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="s1">&#39;bands.x&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;emr&#39;</span><span class="p">:</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;nmr&#39;</span><span class="p">:</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;hyperfine&#39;</span><span class="p">:</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;gvectors&#39;</span><span class="p">:</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">,</span>
                  <span class="p">}</span>

    <span class="k">elif</span> <span class="n">engine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;want&#39;</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span><span class="s1">&#39;bands.x&#39;</span><span class="p">,}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">execDict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">executable</span><span class="o">=</span><span class="n">execDict</span><span class="p">[</span><span class="n">calcType</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">executable</span>



<div class="viewcode-block" id="generateSubRef"><a class="viewcode-back" href="../run.html#run.generateSubRef">[docs]</a><span class="k">def</span> <span class="nf">generateSubRef</span><span class="p">(</span><span class="n">qsubRefFileString</span><span class="p">,</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in the reference cluster submission file specified in &quot;jobreffile&quot;</span>
<span class="sd">    in the config used. Tries to insert a few parameters.</span>

<span class="sd">    OBSOLETE PLANNED FOR REMOVAL</span>

<span class="sd">    Arguments:</span>
<span class="sd">          qsubRefFileString (str): string of the &quot;reference&quot; cluster submission file</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          clusterTypeDict (dict): string cluster submission file</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering generateSubRef&#39;</span><span class="p">)</span>
    <span class="n">clusterTypeDict</span><span class="o">=</span><span class="p">{}</span>

    <span class="n">calcName</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_qsub_name</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>

    <span class="n">stderrFileNm</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_cluster&#39;</span><span class="o">+</span><span class="s1">&#39;.stderr&#39;</span><span class="p">)</span>
    <span class="n">stdoutFileNm</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_cluster&#39;</span><span class="o">+</span><span class="s1">&#39;.stdout&#39;</span><span class="p">)</span>

    <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_CALCNM_&#39;</span><span class="p">,</span><span class="n">calcName</span><span class="p">,</span><span class="n">qsubRefFileString</span><span class="p">)</span>
    <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_STDOUT_&#39;</span><span class="p">,</span><span class="n">stdoutFileNm</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
    <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_STDERR_&#39;</span><span class="p">,</span><span class="n">stderrFileNm</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>

    <span class="n">clusterTypeDict</span><span class="p">[</span><span class="s1">&#39;qsubRef&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">qsubRef</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting generateSubRef&#39;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">clusterTypeDict</span></div>



<span class="c1">#############################################################################################################</span>

<span class="c1">#############################################################################################################</span>
<div class="viewcode-block" id="emr"><a class="viewcode-back" href="../run.html#run.emr">[docs]</a><span class="k">def</span> <span class="nf">emr</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up GIPAW EMR calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>

<span class="sd">    Returns:</span>
<span class="sd">          None </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span> <span class="s1">&#39;EMR NOT IMPLEMENTED&#39;</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span>


    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;emr&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">gipawdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;gipaw_dir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copy_execs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">gipawExLoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gipawdir</span><span class="p">,</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file. EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;emr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;emr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="hyperfine"><a class="viewcode-back" href="../run.html#run.hyperfine">[docs]</a><span class="k">def</span> <span class="nf">hyperfine</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">isotope</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up GIPAW hyperfine calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span> <span class="s1">&#39;HYPERFINE NOT IMPLEMENTED&#39;</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span>


    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">gipawdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;gipaw_dir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copy_execs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">gipawExLoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gipawdir</span><span class="p">,</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file. EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="nmr"><a class="viewcode-back" href="../run.html#run.nmr">[docs]</a><span class="k">def</span> <span class="nf">nmr</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up GIPAW NMR calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations               </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span> <span class="s1">&#39;NMR NOT IMPLEMENTED&#39;</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;nmr&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">gipawdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;gipaw_dir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copy_execs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">gipawExLoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gipawdir</span><span class="p">,</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file. EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">)</span>



    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;nmr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;nmr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>




<div class="viewcode-block" id="gvectors"><a class="viewcode-back" href="../run.html#run.gvectors">[docs]</a><span class="k">def</span> <span class="nf">gvectors</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up GIPAW gvectors calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>


<span class="sd">    Returns:</span>
<span class="sd">          None          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span> <span class="s1">&#39;GVECTORS NOT IMPLEMENTED&#39;</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;gvectors&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">gipawdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;gipaw_dir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copy_execs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symlink</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">gipawExLoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gipawdir</span><span class="p">,</span><span class="s1">&#39;gipaw.x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file. EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;ERROR: gipaw not found in </span><span class="si">%s</span><span class="s1"> please check your config file EXITING&#39;</span> <span class="o">%</span> <span class="n">gipawdir</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">gipawExLoc</span><span class="p">,</span> <span class="n">calcs</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;gvectors&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;gvectors&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<span class="c1">#############################################################################################################</span>
<span class="c1">#############################################################################################################</span>
<span class="k">def</span> <span class="nf">_skeletonRun</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up a custom calculation. Inputs and oneCalc calculation</span>
<span class="sd">    dictionary must be created before calling this.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="scf"><a class="viewcode-back" href="../run.html#run.scf">[docs]</a><span class="k">def</span> <span class="nf">scf</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exit_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up self-consitent calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations              </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                             (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>

<span class="sd">    Returns:</span>
<span class="sd">          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">exit_on_error</span><span class="o">=</span><span class="n">exit_on_error</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="dos"><a class="viewcode-back" href="../run.html#run.dos">[docs]</a><span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up DOS nscf calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL    </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;dos&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;dos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;dos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdos"><a class="viewcode-back" href="../run.html#run.pdos">[docs]</a><span class="k">def</span> <span class="nf">pdos</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up DOS projection calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations                    </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;pdos&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;pdos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;pdos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="bands"><a class="viewcode-back" href="../run.html#run.bands">[docs]</a><span class="k">def</span> <span class="nf">bands</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to set up Electronic Band Structure calculation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations</span>
<span class="sd">          execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">          execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          holdFlag (bool): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          config (str): DEFUNCT. NEEDS REMOVAL</span>
<span class="sd">          </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span>
    
    <span class="n">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="n">holdFlag</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
<span class="c1">#        try:</span>
<span class="c1">#            AFLOWpi.run._onePrep(oneCalc,ID,execPrefix=execPrefix,execPostfix=&#39; &#39;,engine=&#39;espresso&#39;,calcType=&#39;bands&#39;)</span>
<span class="c1">#        except Exception,e:</span>
<span class="c1">#            AFLOWpi.run._fancy_error_log(e)</span>
<span class="c1">#        try:</span>
<span class="c1">#            AFLOWpi.run._testOne(ID,oneCalc,execPrefix=execPrefix,execPostfix=&#39;&#39;,engine=&#39;espresso&#39;,calcType=&#39;bands&#39;)</span>
<span class="c1">#        except Exception,e:</span>
<span class="c1">#            AFLOWpi.run._fancy_error_log(e)</span>

        <span class="n">bands_pp_run_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;if oneCalc[&#39;__execCounter__&#39;] &lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">        AFLOWpi.run._bands_pp(__submitNodeName__,oneCalc,ID)</span>
<span class="s1">        oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">        AFLOWpi.prep._saveOneCalc(oneCalc,ID)</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">bands_pp_run_string</span><span class="p">)</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span></div>

<span class="c1">#############################################################################################################</span>

<span class="c1">#############################################################################################################</span>

<div class="viewcode-block" id="testOne"><a class="viewcode-back" href="../run.html#run.testOne">[docs]</a><span class="k">def</span> <span class="nf">testOne</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">holdFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run all the calculation in the dictionary with a specific engine</span>
<span class="sd">    </span>
<span class="sd">        Arguments:</span>
<span class="sd">               calcs (dict): Dictionary of dictionaries of calculations</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">	       engine (str): executable that you are calling to run the calculations</span>
<span class="sd">               execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                                 (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)          </span>
<span class="sd">               execPostfix (str): commands to go after the executable when run </span>
<span class="sd">                                  (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>

<span class="sd">        Returns:</span>
<span class="sd">               None          </span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#############################################################################################################</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering testOne&#39;</span><span class="p">)</span>


                
            <span class="k">if</span> <span class="n">execPrefix</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">execPostfix</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            
            <span class="k">if</span> <span class="n">calcType</span><span class="o">==</span><span class="s1">&#39;bands&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;pool&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39; &#39;</span>

            <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s1">&#39;engine&#39;</span><span class="p">)</span>

            <span class="n">engineDir</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;prep&quot;</span><span class="p">,</span><span class="s1">&#39;engine_dir&#39;</span><span class="p">)</span>	
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">engineDir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                <span class="n">engineDir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">engineDir</span><span class="p">)</span>



            <span class="k">try</span><span class="p">:</span>
                <span class="n">enginePath</span> <span class="o">=</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_getEnginePath</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">enginePath</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="n">files</span><span class="p">))</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not found. Check your config file to make sure engine_dir path is correct and that </span><span class="si">%s</span><span class="s1"> is in that directory..Exiting&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">files</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not found. Check your config file to make sure engine_dir path is correct and that </span><span class="si">%s</span><span class="s1"> is in that directory..Exiting&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">files</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">SystemExit</span>

                <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copy_execs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="n">files</span><span class="p">)),</span><span class="n">calcs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="n">files</span><span class="p">)),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">files</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">files</span><span class="p">))</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="n">files</span><span class="p">)),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">files</span><span class="p">))</span>

            <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">())][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;LOG.log&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        
        <span class="c1">#############################################################################################################</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">calcsCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
            <span class="n">newCalcs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">CONFIG_FILE</span><span class="o">=</span><span class="s1">&#39;../AFLOWpi/CONFIG.config&#39;</span>
                <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_CONFIG_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">CONFIG_FILE</span>
                <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;calcType&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcType</span>                

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="c1">#############################################################################################################</span>
        <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clusterType</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">clusterType</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;firstCalcList&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">holdFlag</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">baseID</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">splitIndexInt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__TEMP__INDEX__COUNTER__&#39;</span><span class="p">])</span>
                        <span class="n">prev_ID</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%.02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">baseID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">splitIndexInt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">prev_ID</span><span class="o">=</span><span class="n">ID</span>
                        <span class="k">pass</span>                   

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">prev_ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">)):</span>
                        <span class="k">pass</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prev_ID</span><span class="o">=</span><span class="n">ID</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">firstCalcList</span><span class="o">!=</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">pass</span>


            <span class="n">firstCalcList</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting testOne&#39;</span><span class="p">)</span></div>


        <span class="c1">#############################################################################################################</span>
<div class="viewcode-block" id="reset_logs"><a class="viewcode-back" href="../run.html#run.reset_logs">[docs]</a><span class="k">def</span> <span class="nf">reset_logs</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes log files from AFLOWpi directory</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">log_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.oneCalc&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>            
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span></div>



<div class="viewcode-block" id="resubmit"><a class="viewcode-back" href="../run.html#run.resubmit">[docs]</a><span class="k">def</span> <span class="nf">resubmit</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stages loaded calculation set to be resubmitted on a cluster</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None    </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">addatexit__</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">submitFirstCalcs__</span><span class="p">,</span><span class="n">calcs</span><span class="p">)</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_get_qsub_name</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes path of the cluster submission file and forms a name for the submission</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          path (str): path of the cluster job submission file</span>
<span class="sd">          </span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          calcName (str): name of the calculation used with the submission</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">calcName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">calcName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">calcName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">calcName</span><span class="o">=</span><span class="n">calcName</span><span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span> 

    <span class="k">return</span> <span class="n">calcName</span>


<span class="c1">#</span>

<span class="k">def</span> <span class="nf">_qsubGen</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the cluster job submission file</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          qsubFileString (str): string of cluster submission file</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ENTERING _qsubGen&#39;</span><span class="p">)</span>
    <span class="n">calcName</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_qsub_name</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>
    <span class="n">execFileString</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
    <span class="n">tmpdir_envar</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">ls_option</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;local_scratch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ls_option</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;local_scratch_dir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tmpdir</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">tmpdir_envar</span><span class="o">=</span><span class="s2">&quot;export TMPDIR=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">tmpdir</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">qsubFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.qsub&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
        <span class="n">prevQsubString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">clusterType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;UGE&#39;</span><span class="p">]:</span>
            <span class="n">qsubRefFileName</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s1">&#39;job_template&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">qsubRefFileName</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
                <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
                <span class="n">qsubRefFileName</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">qsubRefFileName</span><span class="p">)</span>        
            <span class="n">qsubRefString</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">qsubRefFileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">generateSubRef</span><span class="p">(</span><span class="n">qsubRefString</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)[</span><span class="s1">&#39;qsubRef&#39;</span><span class="p">]</span>
            <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">remove_blank_lines</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)</span>



            <span class="c1">#put the name of the AFLOWpi job in the  PBS submit script</span>
            <span class="k">if</span> <span class="n">clusterType</span><span class="o">==</span><span class="s1">&#39;UGE&#39;</span><span class="p">:</span>
                <span class="n">name_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;\s*#$.*-[nN].*\n&#39;</span><span class="p">)</span>
                <span class="n">calcNameString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#$ -N </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">calcName</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;\s*#PBS.*-[nN].*\n&#39;</span><span class="p">)</span>
                <span class="n">calcNameString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -N </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">calcName</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)):</span>
                <span class="n">qsubRef</span><span class="o">=</span><span class="n">name_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">calcNameString</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qsubRef</span><span class="o">=</span><span class="n">calcNameString</span><span class="o">+</span><span class="n">qsubRef</span>


        <span class="c1">#not sure if this will work on UGE so we&#39;ll leave it only for PBS</span>
        <span class="k">if</span> <span class="n">clusterType</span><span class="o">==</span><span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
                <span class="n">dash_e_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;#PBS\s+-e\s+.*\n&#39;</span><span class="p">)</span>
                <span class="n">dash_o_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;#PBS\s+-o\s+.*\n&#39;</span><span class="p">)</span>
                <span class="n">dash_oe_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;#PBS\s+-oe\s+.*\n&#39;</span><span class="p">)</span>
                <span class="n">stderr_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_cluster&#39;</span><span class="o">+</span><span class="s1">&#39;.stderr&#39;</span><span class="p">)</span>
                <span class="n">stdout_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_cluster&#39;</span><span class="o">+</span><span class="s1">&#39;.stdout&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dash_e_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)):</span>
                    <span class="n">qsubRef</span><span class="o">=</span><span class="n">dash_e_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -e </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">stderr_name</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qsubRef</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -e </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">stderr_name</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dash_o_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)):</span>
                    <span class="n">qsubRef</span><span class="o">=</span><span class="n">dash_o_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -o </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">stdout_name</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qsubRef</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#PBS -o </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">stdout_name</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dash_oe_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qsubRef</span><span class="p">)):</span>
                    <span class="n">qsubRef</span><span class="o">=</span><span class="n">dash_oe_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>




        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">qsubFilename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">qsubFile</span><span class="p">:</span>
            <span class="n">qsubSub</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span><span class="si">%s</span><span class="s1">cd </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">python </span><span class="si">%s</span><span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpdir_envar</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
            <span class="c1">#redirect the -e, -o or -oe to the directory for that job</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_QSUB_&#39;</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)):</span>
                <span class="n">qsubRef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_QSUB_&#39;</span><span class="p">,</span><span class="n">qsubSub</span><span class="p">,</span><span class="n">qsubRef</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qsubRef</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">qsubSub</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">qsubFileString</span><span class="o">=</span><span class="n">qsubRef</span>
            <span class="n">qsubFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">qsubFileString</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">qsubFileString</span>



    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>



<span class="c1">#############################################################################################################</span>
<span class="k">def</span> <span class="nf">_testOne</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stages the first the first step in a calculation workflow of a calc set to be submitted</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">    	  engine (str): executable that you are calling to run the calculations          </span>
<span class="sd"> 	  execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)</span>
<span class="sd">	  execPostfix (str): commands to go after the executable when run</span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          calcType (str): used to pull the engine post processing executable to the calc dir</span>
<span class="sd">                          and to write the postprocessing input file if needed      </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">execPrefix</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">execPostfix</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _testOne&#39;</span><span class="p">)</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">configFile</span>
        <span class="n">configFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;../AFLOWpi/CONFIG.config&#39;</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">execPrefix</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">execPostfix</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">engineDir</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;prep&quot;</span><span class="p">,</span><span class="s1">&#39;engine_dir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">engineDir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_getConfigFile</span><span class="p">()</span>
            <span class="n">configFileLocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">)</span>
            <span class="n">engineDir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configFileLocation</span><span class="p">,</span> <span class="n">engineDir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>


    <span class="n">ri</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
    <span class="n">ro</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span> 

    <span class="n">rd</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="n">configFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;../AFLOWpi/CONFIG.config&#39;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _testOne&#39;</span><span class="p">)</span>

<span class="c1">#############################################################################################################</span>


<span class="k">def</span> <span class="nf">_submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Submits a step of a calculation&#39;s pipeline to be run</span>
<span class="sd">    </span>
<span class="sd">    Arguments:          </span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          sajOverride (bool): Overrides stepsasjobs=False in the config file used</span>
<span class="sd">          forceOneJob (bool): Overrides stepsasjobs=True in the config file used</span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _submitJob&#39;</span><span class="p">)</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusterType</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">clusterType</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
        <span class="k">elif</span> <span class="n">clusterType</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">clusterType</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">stepsAsJobs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;steps_as_jobs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sets the cluster type to none if:</span>
<span class="sd">    1. the clusterType is PBS,</span>
<span class="sd">    2. the user has the flag stepsasjobs=false in their config file</span>
<span class="sd">    3. the job is being submitted from somewhere other than the submission node (i.e. one of the compute nodes)</span>

<span class="sd">    This will cause the first job (step in the calc chain) to be submitted to the cluster and all subsequent</span>
<span class="sd">    jobs will be run on the compute nodes as if it was the local machine. (so the calc chain is just one job</span>
<span class="sd">    on the cluster)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="o">==</span> <span class="n">__submitNodeName__</span> <span class="ow">and</span> <span class="n">stepsAsJobs</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Submitting steps as one cluster job per calculation chain.&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Submitting steps as one cluster job per calculation chain.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="o">!=</span> <span class="n">__submitNodeName__</span> <span class="ow">and</span> <span class="n">stepsAsJobs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">forceOneJob</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sajOverride</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">clusterType</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="c1">###########################################################################################</span>

    <span class="k">if</span> <span class="n">ID</span> <span class="o">==</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ID</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">copyback_level</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;copyback_every_step&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">copyback_level</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#for calc subset...</span>
        <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]:</span>
            <span class="c1">#submit the cluster submission </span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.qsub&#39;</span><span class="p">))):</span>
                <span class="n">submit_ID</span><span class="o">=</span><span class="n">ID</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">submit_ID</span><span class="o">=</span><span class="n">__main__</span><span class="o">.</span><span class="n">ID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">submit_ID</span><span class="o">=</span><span class="n">ID</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">submit_ID</span><span class="o">=</span><span class="n">ID</span>

    <span class="n">submit_ID</span><span class="o">=</span><span class="n">ID</span>

    <span class="n">cluster_daemon</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">cluster_daemon_option</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;daemon&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cluster_daemon_option</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">cluster_daemon</span><span class="o">=</span><span class="kc">True</span>
        
    <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;SLURM&#39;</span><span class="p">,</span><span class="s1">&#39;UGE&#39;</span><span class="p">]:</span>
        <span class="sd">&#39;&#39;&#39;if we&#39;re using a daemon then write the .submit file and return&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">cluster_daemon</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">cluster_submit_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">submit_ID</span><span class="o">+</span><span class="s1">&#39;.submit&#39;</span><span class="p">))</span>            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cluster_submit_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cluster_submit_file_obj</span><span class="p">:</span>
                <span class="n">cluster_submit_file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">submit_ID</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1">#if we&#39;re not copying back every step we need to copy back here for a</span>
        <span class="c1">#new cluster job submission to make sure we have the files to restart</span>
        <span class="k">if</span> <span class="n">copyback_level</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="n">additional_flags</span><span class="o">=</span><span class="s2">&quot;&quot;</span> 
<span class="c1">#        if clusterType.upper() in [&#39;PBS&#39;,&#39;SLURM&#39;]:</span>
<span class="c1">#            additional_flags=&quot;&quot; </span>
        
            
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">submitCommand</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_cluster_submit_command</span><span class="p">()</span>
                
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            
            <span class="n">qsubFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">submit_ID</span><span class="o">+</span><span class="s1">&#39;.qsub&#39;</span><span class="p">))</span>

            <span class="n">calcName</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_qsub_name</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>

            <span class="n">queue</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;queue&quot;</span><span class="p">)</span> <span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">queue</span> <span class="o">=</span> <span class="s1">&#39;-q </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span>  <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;queue&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            
            <span class="n">command</span>  <span class="o">=</span> <span class="s2">&quot;ssh -o StrictHostKeyChecking=no </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> -N </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">submitCommand</span><span class="p">,</span><span class="n">queue</span><span class="p">,</span><span class="n">calcName</span><span class="p">,</span><span class="n">qsubFilename</span><span class="p">,</span><span class="n">additional_flags</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span>  <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>               

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;submitted </span><span class="si">%s</span><span class="s1"> to the queue&#39;</span> <span class="o">%</span> <span class="n">submit_ID</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to submit job with no -N option&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;ssh -o StrictHostKeyChecking=no </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">submitCommand</span><span class="p">,</span><span class="n">qsubFilename</span><span class="p">,</span><span class="n">additional_flags</span><span class="p">)</span>
                <span class="n">job</span> <span class="o">=</span>  <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>               

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to submit job without ssh and -N option&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">baseID</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">baseID</span> <span class="o">=</span> <span class="n">ID</span>
                    <span class="n">qsubFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">baseID</span><span class="o">+</span><span class="s1">&#39;.qsub&#39;</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ssh -o StrictHostKeyChecking=no </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> -N </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">submitCommand</span><span class="p">,</span><span class="n">queue</span><span class="p">,</span><span class="n">calcName</span><span class="p">,</span><span class="n">qsubFilename</span><span class="p">,</span><span class="n">additional_flags</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to submit job without ssh and -N option&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">baseID</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">baseID</span> <span class="o">=</span> <span class="n">ID</span>
                        <span class="n">qsubFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">baseID</span><span class="o">+</span><span class="s1">&#39;.qsub&#39;</span><span class="p">))</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">submitCommand</span><span class="p">,</span><span class="n">queue</span><span class="p">,</span><span class="n">qsubFilename</span><span class="p">,</span><span class="n">additional_flags</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to submit job without ssh and -N option&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">submitCommand</span><span class="p">,</span><span class="n">queue</span><span class="p">,</span><span class="n">qsubFilename</span><span class="p">,</span><span class="n">additional_flags</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">execFileString</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
            
            <span class="n">execfile</span><span class="p">(</span><span class="n">execFileString</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Got Keyboard Exit signal, exiting&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Got Keyboard Exit signal, exiting&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _submitJob&#39;</span><span class="p">)</span>


<span class="c1">##############################################################################################</span>

<div class="viewcode-block" id="submitFirstCalcs__"><a class="viewcode-back" href="../run.html#run.submitFirstCalcs__">[docs]</a><span class="k">def</span> <span class="nf">submitFirstCalcs__</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Submits the first step of a calculation&#39;s pipeline</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of dictionaries of calculations          </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cluster_daemon_option</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;daemon&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cluster_daemon_option</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_generate_submission_daemon_script</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering submitFirstCalcs__&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;__submitNodeName__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">__submitNodeName__</span>
        <span class="n">__submitNodeName__</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">__submitNodeName__</span><span class="o">=</span><span class="n">__main__</span><span class="o">.</span><span class="n">__submitNodeName__</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sending from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">__submitNodeName__</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">submit_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*** Submitting Workflow ***</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">submit_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*** Starting Workflow ***</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="nb">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_colorize_message</span><span class="p">(</span><span class="n">submit_message</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting submitFirstCalcs__&#39;</span><span class="p">)</span>        </div>


<div class="viewcode-block" id="submit"><a class="viewcode-back" href="../run.html#run.submit">[docs]</a><span class="k">def</span> <span class="nf">submit</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sets global __submit__flag__ so calculations will start when user script completes</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__submit__flag__&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span></div>

<span class="c1">#####################################################################################################################</span>
<span class="k">def</span> <span class="nf">_restartPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If pw.x ends becuause it hit max_seconds. set the input to restart the calculation</span>
<span class="sd">    and resubmit the job</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          a (float): Time that has passed since calculation has started</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#mod input so it will not start from scratch next submission            </span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entering AFLOWpi.run._restartPW&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltime</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> 

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFileObj</span><span class="p">:</span>
        <span class="n">inFileString</span><span class="o">=</span> <span class="n">inputFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    <span class="c1">#bring wfc,hub, or any other files needed from local scratch if need be</span>
    <span class="n">walltimeSec</span><span class="o">=</span><span class="mi">90000000000</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltimeSec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;if we can&#39;t find max_seconds in the input we just exit.&#39;&#39;&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not pwscf. Exiting AFLOWpi.run._restartPW&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;see if calc reached it&#39;s end.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="n">walltimeSec</span><span class="p">:</span>
            <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
            <span class="sd">&quot;&quot;&quot;if it did then set to restart the calc&quot;&quot;&quot;</span>

            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;restart_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;restart&#39;&quot;</span>
            <span class="sd">&#39;&#39;&#39; if the calc never had the time to start then just restart it from scratch&#39;&#39;&#39;</span>

            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">walltimeSec</span><span class="p">)</span>

            <span class="n">restartInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;write the new input file with the restarting&#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">restartInput</span><span class="p">)</span>                  
            <span class="sd">&#39;&#39;&#39;save to _&lt;ID&gt;.oneCalc&#39;&#39;&#39;</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restartInput</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;now resubmit&quot;&quot;&quot;</span>
            <span class="n">resubmitID</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>

            <span class="c1">#resubmit</span>
            <span class="sd">&#39;&#39;&#39;if we&#39;re at within 15 seconds of the end of walltime. don&#39;t submit and let restartScript do it&#39;&#39;&#39;</span>

            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">resubmitID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                             
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Restart Job Submitted. Exiting AFLOWpi.run._restartPW&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;and exit cleanly.&#39;&#39;&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Job completed in time. No need for restart. Exiting AFLOWpi.run._restartPW&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_restartGIPAW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If pw.x ends becuause it hit max_seconds. set the input to restart the calculation</span>
<span class="sd">    and resubmit the job</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          a (float): Time that has passed since calculation has started</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFileObj</span><span class="p">:</span>
        <span class="n">inFileString</span><span class="o">=</span> <span class="n">inputFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltimeSec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;if we can&#39;t find max_seconds in the input we just exit.&#39;&#39;&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;see if calc reached it&#39;s end.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="n">walltimeSec</span><span class="p">:</span>
            <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
            <span class="sd">&quot;&quot;&quot;if it did then set to restart the calc&quot;&quot;&quot;</span>

            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inputgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;restart_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;restart&#39;&quot;</span>
            <span class="sd">&#39;&#39;&#39; if the calc never had the time to start then </span>
<span class="sd">                just restart it from scratch&#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inputgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;10&#39;</span><span class="p">:</span>
                    <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inpitgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;restart_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;from_scratch&#39;&quot;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">walltimeSec</span><span class="p">)</span>
            <span class="n">restartInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;write the new input file with the restarting&#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">restartInput</span><span class="p">)</span>                  
            <span class="sd">&#39;&#39;&#39;save to _&lt;ID&gt;.oneCalc&#39;&#39;&#39;</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restartInput</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;now resubmit&quot;&quot;&quot;</span>
            <span class="n">resubmitID</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>

            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">resubmitID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                 
            <span class="sd">&#39;&#39;&#39;and exit cleanly.&#39;&#39;&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



<span class="c1">################################################################################################################</span>
<span class="k">def</span> <span class="nf">_getWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the walltime requested from the cluster submission script</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          walltime (int) amount of time requested</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">cluster_type</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">],</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">qsubfileObj</span><span class="p">:</span>
            <span class="n">qsubFileString</span> <span class="o">=</span> <span class="n">qsubfileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">50000000</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cluster_type</span><span class="o">==</span><span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
            <span class="n">walltime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;walltime\s*=\s*([0-9:]*)&quot;</span><span class="p">,</span><span class="n">qsubFileString</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">cluster_type</span><span class="o">==</span><span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
            <span class="n">walltime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;--time\s*=\s*([0-9:]*)&quot;</span><span class="p">,</span><span class="n">qsubFileString</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">walltime</span><span class="o">=</span><span class="s1">&#39;3000:00:00&#39;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="s1">&#39;3000:00:00&#39;</span>

    <span class="n">splitW</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">walltime</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitW</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">splitW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitW</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">splitW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitW</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">splitW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">splitW</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitW</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">splitW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">walltime</span>


<span class="k">def</span> <span class="nf">_generic_restart_check</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to see if walltime limit is almost up. If it is within the buffer of time</span>
<span class="sd">    The job is resubmitted.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltime</span><span class="p">,</span><span class="n">startTime</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>    
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>
    <span class="n">from_config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;restart_buffer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">from_config</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">from_config</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">percent_timer</span><span class="o">&lt;</span><span class="mf">1.0</span><span class="p">:</span>
        <span class="n">num_secs</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">*</span><span class="n">percent_timer</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_secs</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">-</span><span class="n">percent_timer</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">timediff</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">timediff</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">runTime</span> <span class="o">=</span> <span class="n">num_secs</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TIMEDIFF = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">timediff</span><span class="p">)</span>      
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RUNTIME = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">runTime</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;num_secs = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">num_secs</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;percent_timer = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">percent_timer</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;STARTTIME = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">startTime</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;WALLTIME = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">walltime</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;if local scratch is being used don&#39;t run any steps if we&#39;re over 90% walltime&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">num_secs</span><span class="o">&lt;</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;set runTime to 0.0 make sure it trips the next if statement&#39;&#39;&#39;</span>
            <span class="n">runTime</span><span class="o">=</span><span class="mf">0.0</span>
            
    <span class="n">resubmitID</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">runTime</span><span class="o">-</span><span class="mf">60.0</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">:</span>
        <span class="n">ID</span> <span class="o">=</span> <span class="n">__get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;if there&#39;s not enough time to do anything so resubmit before anything runs&#39;&#39;&#39;</span>
        <span class="sd">&#39;&#39;&#39;make sure the scratch is copied back&#39;&#39;&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job only has 60 seconds left. attempting to copy from local scratch if needed and resubmit job&#39;</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;force a new job&#39;&#39;&#39;</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">resubmitID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                 
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not enough time to start next step. Restarting&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        



<span class="k">def</span> <span class="nf">_setupRestartPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up pw.x input with max_seconds to it will cleanly exit if it</span>
<span class="sd">    doesn&#39;t finish within the time limit of the cluster submission </span>
<span class="sd">    walltime requested.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltime</span><span class="p">,</span><span class="n">startTime</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;if no walltime log in oneCalc (running local mode)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

    <span class="sd">&#39;&#39;&#39;set buffer to time before walltime to stop the job&#39;&#39;&#39;</span>
    <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>
    <span class="n">from_config</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;restart_buffer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">from_config</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">from_config</span><span class="p">)</span>


        
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
        <span class="n">inputStr</span><span class="o">=</span><span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="sd">&#39;&#39;&#39;try to split input to include max time if it doesn&#39;t work stop and return&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputStr</span><span class="p">)</span>
        <span class="n">calc_type</span><span class="o">=</span><span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;calculation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; &#39;`&quot; &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    <span class="sd">&#39;&#39;&#39;ibef calc type was found (i.e. not post processing) try to include max_seconds&#39;&#39;&#39;</span>
    <span class="n">typeList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span><span class="s1">&#39;nscf&#39;</span><span class="p">,</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span><span class="s1">&#39;vc-relax&#39;</span><span class="p">,</span><span class="s1">&#39;relax&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">timediff</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">timediff</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">if</span> <span class="n">calc_type</span> <span class="ow">in</span> <span class="n">typeList</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_sec</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">*</span><span class="n">percent_timer</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">percent_timer</span><span class="o">&gt;</span><span class="mf">1.0</span><span class="p">:</span>
                <span class="n">max_sec</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">-</span><span class="n">percent_timer</span><span class="p">))</span>
            <span class="k">if</span>  <span class="n">timediff</span><span class="o">&lt;</span><span class="p">(</span><span class="n">walltime</span><span class="o">*</span><span class="n">percent_timer</span><span class="p">):</span>
                <span class="n">runTime</span> <span class="o">=</span> <span class="n">max_sec</span><span class="o">-</span><span class="n">timediff</span>                
                <span class="sd">&#39;&#39;&#39;if script has already been running is small take the difference between walltime </span>
<span class="sd">                and time script has been running. leave 10% of walltime to do cleanup.&#39;&#39;&#39;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">runTime</span><span class="o">-</span><span class="mf">60.0</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.0</span> <span class="ow">or</span> <span class="n">timediff</span><span class="o">&gt;</span><span class="n">max_sec</span><span class="p">:</span>
                    <span class="sd">&#39;&#39;&#39;if there&#39;s not enough time to do anything so resubmit before anything runs&#39;&#39;&#39;</span>
                    <span class="sd">&#39;&#39;&#39;make sure the scratch is copied back&#39;&#39;&#39;</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Not enough time to start non-post processing calc. copying files from local scratch if needed and restarting&#39;</span><span class="p">)</span>
                    <span class="n">resubmitID</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__qsubFileName__&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">ID</span> <span class="o">=</span> <span class="n">__get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                    <span class="sd">&#39;&#39;&#39;force a new job&#39;&#39;&#39;</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">resubmitID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                 
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not enough time to start pwscf. Restarting&#39;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        
            
            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;control&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">runTime</span><span class="p">)</span>
            <span class="n">restartInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">restartInput</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restartInput</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;if option to restart doesnt exist in the input of </span><span class="si">%s</span><span class="s1"> this will be thrown&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>



<span class="k">def</span> <span class="nf">_setupRestartGIPAW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up GIPAW input with max_seconds to it will cleanly exit if it</span>
<span class="sd">    doesn&#39;t finish within the time limit of the cluster submission </span>
<span class="sd">    walltime requested.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">walltime</span><span class="p">,</span><span class="n">startTime</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    
    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">startTime</span>

    <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;restart_buffer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">percent_timer</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
        <span class="n">inputStr</span><span class="o">=</span><span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="sd">&#39;&#39;&#39;try to split input to include max time if it doesn&#39;t work stop and return&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputStr</span><span class="p">)</span>
        <span class="n">calc_type</span><span class="o">=</span><span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inputgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;calculation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; &#39;`&quot; &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    <span class="sd">&#39;&#39;&#39;ibef calc type was found (i.e. not post processing) try to include max_seconds&#39;&#39;&#39;</span>
    <span class="n">typeList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;emr&#39;</span><span class="p">,</span><span class="s1">&#39;efg&#39;</span><span class="p">,</span><span class="s1">&#39;g_vectors&#39;</span><span class="p">,</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">calc_type</span> <span class="ow">in</span> <span class="n">typeList</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timediff</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">timediff</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">runTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">*</span><span class="n">percent_timer</span><span class="o">-</span><span class="n">timediff</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">timediff</span><span class="o">&lt;</span><span class="p">(</span><span class="n">walltime</span><span class="o">*</span><span class="n">percent_timer</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;if script has already been running is small take the difference between walltime </span>
<span class="sd">                and time script has been running. leave 10% of walltime to do cleanup.&#39;&#39;&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39;if there&#39;s not enough time to do anything so resubmit before anything runs&#39;&#39;&#39;</span>
                <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="kc">False</span>
            <span class="n">inputDict</span><span class="p">[</span><span class="s2">&quot;&amp;inputgipaw&quot;</span><span class="p">][</span><span class="s2">&quot;max_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">runTime</span>
            <span class="n">restartInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
                <span class="n">inputfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">restartInput</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restartInput</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;if option to restart doesnt exist in the input of </span><span class="si">%s</span><span class="s1"> this will be thrown&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>




<span class="k">def</span> <span class="nf">_writeWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">walltimeDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the walltimeDict to disk ( _&lt;ID&gt;.oneCalc )</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          walltimeDict (dict): saves the walltime log to oneCalc and then to disk</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">walltimeDict</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">_readWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    reads walltime log from oneCalc</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          walltimeLog (dict): dictionary containing start time for AFLOWpi as well</span>
<span class="sd">                              as the requested walltime for the cluster job </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span>



<span class="k">def</span> <span class="nf">_grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    find the start time of current step in chain and record that into the walltime file</span>
<span class="sd">    </span>
<span class="sd">    Arguments:          </span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          walltimeStart (int): walltime requested</span>
<span class="sd">          startTime (int): start time of the script</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>        
        <span class="n">output</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_readWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_writeWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;grab the first walltime in case stepsasjobs==false for all jobs in chain&#39;&#39;&#39;</span>
        <span class="n">walltimeStart</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]</span>    
        <span class="n">startTime</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;startTime Test: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">startTime</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="mi">40000000</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">walltimeStart</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">startTime</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_setStartTime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__CLOCK__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If this python script is the first to run in for AFLOWpi in a cluster job then</span>
<span class="sd">    the start time will be recorded and stored in the oneCalc object with the key  </span>
<span class="sd">    &quot;__walltime_dict__&quot; and the values for the start time of the script and the </span>
<span class="sd">    requested walltime. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:          </span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          walltimeStart (int): walltime requested</span>
<span class="sd">          startTime (int): start time of the script</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<span class="c1">#    if AFLOWpi.prep._ConfigSectionMap(&quot;cluster&quot;,&quot;type&quot;).lower()==&#39;&#39;:</span>
<span class="c1">#        return oneCalc</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">walltime_dict</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">walltime_dict</span><span class="o">=</span><span class="p">{}</span>

        <span class="k">if</span>  <span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="sd">&#39;&#39;&#39;only move from local scratch if this script is starting fresh&#39;&#39;&#39;</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_to_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">__CLOCK__</span>
            <span class="n">walltime_dict</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_getWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>         
            <span class="n">walltime_dict</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">__CLOCK__</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_writeWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">walltime_dict</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> 

            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">walltime_dict</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">walltime_dict</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">40000000000.0</span>         
            <span class="n">walltime_dict</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_writeWalltimeLog</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">walltime_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">oneCalc</span>


<span class="k">def</span> <span class="nf">_restartScript</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">PID</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    special script started when the _&lt;ID&gt;.py script starts. reads the walltime in the qsub file and </span>
<span class="sd">    resubmits and then exits if the time ran gets within 1 minute of the walltime requested. </span>
<span class="sd">    Used for when the script is on the post processing stages and may happen to get killed by</span>
<span class="sd">    the cluster daemon.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="sd">&#39;&#39;&#39;keep trying to find oneCalc and ID from &#39;&#39;&#39;</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;main processess running on PID: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">PID</span><span class="p">)</span>
    <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;restart_buffer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">percent_timer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">percent_timer</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">percent_timer</span><span class="o">=</span><span class="mf">0.90</span>

    <span class="n">walltime</span><span class="p">,</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBLAL_CLOCK__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">startTime</span>
    
    <span class="n">walltime</span>  <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span>
    
    <span class="n">__submitNodeName__</span><span class="o">=</span><span class="n">__main__</span><span class="o">.</span><span class="n">__submitNodeName__</span>

    <span class="n">stepsasjobs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;steps_as_jobs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">stepsasjobs</span><span class="o">==</span><span class="s1">&#39;false&#39;</span> <span class="ow">or</span> <span class="n">stepsasjobs</span><span class="o">==</span><span class="s1">&#39;f&#39;</span><span class="p">:</span>
        <span class="n">stepsasjobsBool</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;stepsasjobs set to false in config file. reading in start time from oneCalc&#39;</span><span class="p">)</span>


    <span class="n">currentTime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;walltime in seconds: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">walltime</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting monitoring thread for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>
    <span class="n">remainingTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">currentTime</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;time since start for _&lt;ID&gt;.py = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>  <span class="n">currentTime</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;current time till ending _&lt;ID&gt;.py = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>  <span class="n">remainingTime</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;restart script and exit immediately if it&#39;s about to be killed by the cluster&#39;&#39;&#39;</span>
    <span class="k">while</span> <span class="n">walltime</span><span class="o">-</span><span class="n">currentTime</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;update time to reflect current time&#39;&#39;&#39;</span>        
        <span class="n">currentTime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__GLOBAL_CLOCK__&#39;</span><span class="p">]</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if we&#39;ve moved into another step with stepsasjobs==false then we don&#39;t </span>
<span class="sd">        need the restartScript from this step anymore so we should exit the thread</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__TEMP__INDEX__COUNTER__&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]:</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;check to see if main script is running..if not it&#39;s </span>
<span class="sd">           not then something went wrong in the main script and this should also exit&#39;&#39;&#39;</span>

            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">PID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;main script did not exit cleanly. killing __restartScript subprocess&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;main script did not exit cleanly. killing __restartScript subprocess&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job not completed in time. Restarting from that step.&#39;</span><span class="p">)</span>

    <span class="n">oneCalc</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Resubmission successful. Waiting 5 seconds then ending main script&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;after the job is submitted wait ten seconds to exit the script&#39;&#39;&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;and exit gracefully&#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;telling main process to stop&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">PID</span><span class="p">,</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">)</span> 
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="c1">##################################################################################################################</span>
<span class="k">def</span> <span class="nf">_convert_fortran_double</span><span class="p">(</span><span class="n">fort_double_string</span><span class="p">,</span><span class="n">string_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    find the start time of current step in chain and record that into the walltime file</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          fort_double_string (str): Fortran double in string form</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          string_output (bool): Output a string or a float</span>

<span class="sd">    Returns:</span>
<span class="sd">          fort_double_string (float): the fotran double in float form or string</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fort_double_string</span><span class="o">=</span><span class="n">fort_double_string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">fort_double_list</span><span class="o">=</span><span class="n">fort_double_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">fort_double_list</span><span class="o">=</span><span class="n">fort_double_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fort_double_string</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fort_double_string</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">mult</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="nb">int</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">base</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fort_double_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">retr_float</span><span class="o">=</span><span class="n">base</span><span class="o">*</span><span class="n">mult</span>
        <span class="k">if</span> <span class="n">string_output</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">retr_float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">retr_float</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">e</span>
        <span class="nb">print</span> <span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not convert fortran float string to numpy float&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fort_double_string</span>




<span class="k">def</span> <span class="nf">_get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEFUNCT. CANDIDATE FOR REMOVAL</span>
<span class="sd">    </span>
<span class="sd">    Arguments: </span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation         </span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None  </span>

<span class="sd">    Returns:</span>
<span class="sd">          ID (str): Returns the input ID</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ID</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">index</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span><span class="n">index</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ID</span>


<span class="k">def</span> <span class="nf">_PW_bands_fix</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accounts for the occational problem of the bands.x output being </span>
<span class="sd">    improperly formatted for AFLOWpi to parse later.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">rd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;fix bands.out where you have large numbers butting up against each other ex.) -113.345-112.567 </span>
<span class="sd">        and split the two numbers up for processing with band_plot.x or else you&#39;ll get an error&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_band_data.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileinput</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_band_data.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileoutput</span><span class="p">:</span>
                <span class="n">correctedText</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;(\d)([-][\d])&#39;</span><span class="p">,</span><span class="s1">r&#39;\1 \2&#39;</span><span class="p">,</span><span class="nb">input</span><span class="p">)</span>
                <span class="n">fileoutput</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">correctedText</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="c1">##### make the bands.xmgr now that band_plot.x is gone</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_band_data.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bands_out_file</span><span class="p">:</span>
            <span class="n">bands_out_lines</span> <span class="o">=</span> <span class="n">bands_out_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">indent_re</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;      &#39;</span><span class="p">)</span>
        <span class="n">total</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">path_vals</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">k_val</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">total_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bands_out_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">indent_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dist</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span><span class="o">-</span><span class="n">total_path_length</span>
                    <span class="n">path_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_val</span><span class="p">)</span>
                    <span class="n">total_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>            
                    <span class="n">total</span><span class="o">+=</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

                    <span class="n">k_val</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">total_path_length</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">k_val</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()]))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">path_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_val</span><span class="p">)</span>
        <span class="n">total_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
        <span class="n">path_vals</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">path_vals</span><span class="p">)</span>
        <span class="n">output_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">path_vals</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">print_list</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)):</span>
                <span class="n">output_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%12.7f</span><span class="s1"> </span><span class="si">%12.5f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">total_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">item</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">output_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_bands.xmgr&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bands_out_file</span><span class="p">:</span>
            <span class="n">bands_out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_string</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>




<span class="k">def</span> <span class="nf">_vcrelax_error_restart</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restarts if vc-relax calculation fails</span>

<span class="sd">    BROKEN/NOT NEEDED POSSIBLY DELETE</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">error_regex_list</span><span class="o">=</span><span class="p">[]</span>


    <span class="n">submit_ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>        
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_check_restart</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
            <span class="n">oneCalc</span><span class="p">,</span><span class="n">submit_ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;restart_mode&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;from_scratch&#39;&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFileObj</span><span class="p">:</span>
        <span class="n">outFileString</span> <span class="o">=</span> <span class="n">outFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">re_error</span> <span class="ow">in</span>  <span class="n">error_regex_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                        <span class="n">oneCalcBase</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">submit_ID</span><span class="p">)</span>
                        <span class="n">oneCalcBase</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalcBase</span><span class="p">,</span><span class="n">submit_ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">submit_ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                

<span class="k">def</span> <span class="nf">_io_error_restart</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restarts if I/O error encountered</span>

<span class="sd">    BROKEN/NOT NEEDED POSSIBLY DELETE</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">,</span><span class="s1">&#39;restart_mode&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;from_scratch&#39;&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">error_regex_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Error in routine diropn&#39;</span><span class="p">))</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Error in routine davcio&#39;</span><span class="p">))</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Error in routine pw_readfile&#39;</span><span class="p">))</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Error in routine seqopn&#39;</span><span class="p">))</span>
    <span class="n">error_regex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;kpt grid not Monkhorst-Pack&#39;</span><span class="p">))</span>
    <span class="n">submit_ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_index_from_pp_step</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span> <span class="n">ID</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFileObj</span><span class="p">:</span>
        <span class="n">outFileString</span> <span class="o">=</span> <span class="n">outFileObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">re_error</span> <span class="ow">in</span>  <span class="n">error_regex_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Error in routine pw_readfile&#39;</span> <span class="ow">or</span> <span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kpt grid not Monkhorst-Pack&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">oneCalcBase</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">submit_ID</span><span class="p">)</span>
                        <span class="n">oneCalcBase</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__runList__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalcBase</span><span class="p">,</span><span class="n">submit_ID</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Trying again...&quot;</span><span class="o">%</span><span class="n">re_error</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">oneCalcBase</span> <span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_loadOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">submit_ID</span><span class="p">)</span>

                    <span class="n">restart_num</span> <span class="o">=</span> <span class="n">oneCalcBase</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span>
                    <span class="n">oneCalcBase</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restart_num</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Restart&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">restart_num</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">restart_num</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
                        <span class="n">oneCalcBase</span><span class="p">[</span><span class="s2">&quot;__execCounter__&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s2">&quot;__execCounter__&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">restart_num</span><span class="o">&gt;</span><span class="mi">15</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalcBase</span><span class="p">,</span><span class="n">submit_ID</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_submitJob</span><span class="p">(</span><span class="n">submit_ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">##################################################################################################################</span>

<span class="k">def</span> <span class="nf">_qe__pre_run</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs the pre-run checks and restarts the cluster job if needed. </span>
<span class="sd">    On local mode this gets skipped</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>
<span class="sd">          calcType (str): type of calculation</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">rd</span> <span class="o">=</span><span class="s1">&#39;./&#39;</span>

    <span class="k">if</span> <span class="n">calcType</span><span class="o">==</span><span class="s1">&#39;scf&#39;</span><span class="p">:</span>    
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_setup_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;SLURM&#39;</span><span class="p">,</span><span class="s1">&#39;UGE&#39;</span><span class="p">]:</span>
            <span class="sd">&#39;&#39;&#39;if there&#39;s 60 seconds or less left exit immediately and don&#39;t start a new job&#39;&#39;&#39;</span>

            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_generic_restart_check</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">calcType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]:</span>    
                <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_setupRestartPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span>



            <span class="k">if</span> <span class="n">calcType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;emr&#39;</span><span class="p">,</span><span class="s1">&#39;nmr&#39;</span><span class="p">,</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">,</span><span class="s1">&#39;gvectors&#39;</span><span class="p">]:</span>
                <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">restartBool</span> <span class="o">=</span> <span class="n">__setupRestartGIPAW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>




    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;scf&#39;</span> <span class="ow">and</span> <span class="n">calcType</span><span class="o">!=</span><span class="kc">None</span> <span class="ow">and</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;custom&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.in&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">calcType</span><span class="p">),</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">PPInput</span><span class="p">:</span>
                    <span class="n">PPInput</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_makeInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>


<span class="c1">###############################################################################################################</span>

<span class="k">def</span> <span class="nf">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nextCalc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nextConf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exit_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a single calculation in the dictionary with a specific engine</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>

<span class="sd">	  oneCalc (dict): dictionary of the calculation</span>
<span class="sd">          ID (str): Identifying hash of the calculation</span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">	  engine (str): executable that you are calling to run the calculations          </span>
<span class="sd"> 	  execPrefix (str): commands to go before the executable when run </span>
<span class="sd">                            (ex. mpiexec nice -n 19 &lt;executable&gt;) (default = None)</span>
<span class="sd">	  execPostfix (str): commands to go after the executable when run</span>
<span class="sd">                            (ex. &lt;execPrefix&gt; &lt;executable&gt; -ndiag 12 -nimage 2) (default = None)</span>
<span class="sd">          calcType (str): used to pull the engine post processing executable to the calc dir</span>
<span class="sd">                          and to write the postprocessing input file if needed</span>
<span class="sd">          executable (str): if the executable has already been copied to the calc&#39;s directory</span>
<span class="sd">                            then use this to run the input &lt;ID&gt;.in</span>
<span class="sd">          execPath (str): path of the executable if needed</span>
<span class="sd">          nextCalc (str): DEFUNCT</span>
<span class="sd">          nextConf (str): DEFUNCT</span>

<span class="sd">          </span>
<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _oneRun&#39;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_forceGlobalConfigFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;../AFLOWpi/CONFIG.config&#39;</span><span class="p">))</span>

    <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;save the status of the calcs&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;__status__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="c1"># &#39;&#39;&#39;set the completed status to false in the case of a looping set of calcs&#39;&#39;&#39;</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">rd</span> <span class="o">=</span><span class="s1">&#39;./&#39;</span>

    <span class="sd">&#39;&#39;&#39;do the setup&#39;&#39;&#39;</span>

    <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_qe__pre_run</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">engine</span><span class="p">)</span>


<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################      </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;scf&#39;</span> <span class="ow">and</span> <span class="n">calcType</span><span class="o">!=</span><span class="kc">None</span> <span class="ow">and</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">calcType</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
            <span class="n">ro</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">calcType</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span>
            <span class="n">ro</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>


        <span class="k">if</span> <span class="n">execPath</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="n">executable</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_getExecutable</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">)</span>

            <span class="n">executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">executable</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execPath</span> <span class="o">=</span> <span class="n">execPath</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">engine</span><span class="p">)):</span>
            <span class="n">command</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &lt; </span><span class="si">%s</span><span class="s1">  &gt;  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPath</span><span class="p">,</span><span class="n">executable</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">ro</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &lt; </span><span class="si">%s</span><span class="s1">  &gt;  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPath</span><span class="p">,</span><span class="n">executable</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">ro</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1">###############################################################################################################      </span>
    <span class="k">try</span><span class="p">:</span>	
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">home</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s1">&#39;in </span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">home</span>
        <span class="nb">print</span> <span class="s2">&quot;starting </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">command</span>

        <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;SLURM&#39;</span><span class="p">,</span><span class="s1">&#39;UGE&#39;</span><span class="p">]:</span>
            <span class="n">job</span> <span class="o">=</span>  <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cwd</span><span class="o">=</span><span class="n">rd</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">job</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>               

<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################    </span>
<span class="c1">#################################################################################################################    </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################    </span>
<span class="c1">#################################################################################################################    </span>
<span class="c1">#################################################################################################################     </span>
            <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PBS&#39;</span><span class="p">,</span><span class="s1">&#39;SLURM&#39;</span><span class="p">,</span><span class="s1">&#39;UGE&#39;</span><span class="p">]:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_restartPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span> 

            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">calcType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]:</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">calcType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;emr&#39;</span><span class="p">,</span><span class="s1">&#39;nmr&#39;</span><span class="p">,</span><span class="s1">&#39;hyperfine&#39;</span><span class="p">,</span><span class="s1">&#39;gvectors&#39;</span><span class="p">]:</span>
                        <span class="n">__restartGIPAW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">255</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> returned exit code: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;None&#39;</span><span class="p">:</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;Exited Status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Exit Status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Exited Status </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mi">1</span> 
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>                                
                <span class="k">if</span> <span class="n">exit_on_error</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">err_msg</span><span class="o">=</span><span class="s1">&#39;Encountered Error in execution of </span><span class="si">%s</span><span class="s1"> during step #</span><span class="si">%02d</span><span class="s1"> Exiting&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;FAILED TO CONVERGE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exit_on_error</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">err_msg</span><span class="o">=</span><span class="s1">&#39;Encountered Error in execution of </span><span class="si">%s</span><span class="s1"> during step #</span><span class="si">%02d</span><span class="s1"> Exiting&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">:</span>				
                <span class="c1">#empty text file is created in the AFLOWpi folder</span>
                <span class="c1">#is created and the keys of the failed to converge</span>
                <span class="c1">#calculations is written in the file</span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;QE ERR </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">returncode</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exit_on_error</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">err_msg</span><span class="o">=</span><span class="s1">&#39;Encountered Error in execution of </span><span class="si">%s</span><span class="s1"> during step #</span><span class="si">%02d</span><span class="s1"> Exiting&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################      </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################      </span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;finished </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">rd</span><span class="p">))</span>
        <span class="nb">print</span> <span class="s2">&quot;finished </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;save_dir&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_moveToSavedir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">ro</span><span class="p">))</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_moveToSavedir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">ri</span><span class="p">))</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/*</span><span class="si">%s</span><span class="s1">*.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_moveToSavedir</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">pdf</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/*</span><span class="si">%s</span><span class="s1">*.pdf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;STARTING DATA&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="n">ID</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RECORDING DATA&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">getCellOutput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
<span class="c1">###############################################################################################################</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Got Keyboard Exit signal, exiting&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Got Keyboard Exit signal, exiting&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR! &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR! &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR! &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR! &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;exit code==1&quot;</span>

<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">###CONSIDER MOVING OUTSIDE</span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################     </span>
<span class="c1">#################################################################################################################      </span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">home</span><span class="p">)</span>		




    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _oneRun&#39;</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">_onePrep</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">alt_ID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exit_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares one calculation run an engine executable</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          engine (str): executable that you are calling to run the calculations (default=&#39;pw.x&#39;)          </span>
<span class="sd">          execPrefix (str): commands to go before the executable when run (ex. mpiexec nice -n 19 &lt;executable&gt;) </span>
<span class="sd">                            (default = None)</span>
<span class="sd">          execPostfix (str): commands to go after the executable when run (ex. &lt;execPrefix&gt; &lt;executable&gt; -npool 12 )</span>
<span class="sd">                             (default = None)</span>
<span class="sd">          calcType (str): used to prep for a particular type of calc (i.e. &#39;scf&#39;,&#39;pdos&#39;..etc) </span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering _onePrep&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">execPrefix</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">execPrefix</span> <span class="o">==</span>  <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">execPostfix</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">execPostfix</span> <span class="o">==</span>  <span class="s1">&#39;&#39;</span><span class="p">:</span>

        <span class="n">execPostfix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_postfix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="n">folder</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>


    <span class="sd">&quot;&quot;&quot;run projwfc.x on all the folders&quot;&quot;&quot;</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">rd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;dos.out is the output from dos.x as designated within dos.in&quot;&quot;&quot;</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alt_ID</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">write_ID</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write_ID</span><span class="o">=</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">alt_ID</span>

        <span class="n">execString</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">execString</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;if oneCalc[&#39;__execCounter__&#39;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">        AFLOWpi.run._oneRun&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span>

        <span class="n">execString</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;(__submitNodeName__,oneCalc,</span><span class="si">%s</span><span class="s1">,execPrefix=&#39;</span><span class="si">%s</span><span class="s1">&#39;,execPostfix=&#39;</span><span class="si">%s</span><span class="s1">&#39;,engine=&#39;</span><span class="si">%s</span><span class="s1">&#39;,calcType=&#39;</span><span class="si">%s</span><span class="s1">&#39;,exit_on_error=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">        oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s1">        AFLOWpi.prep._saveOneCalc(oneCalc,ID)</span>
<span class="s1">        &#39;&#39;&#39;</span>  <span class="o">%</span> <span class="p">(</span><span class="n">write_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="p">,</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">exit_on_error</span><span class="p">)</span>

        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">execFileString</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ID: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">execString</span><span class="p">)</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">e</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting _onePrep&#39;</span><span class="p">)</span>
<span class="c1">################################################################################################################</span>

<span class="c1">################################################################################################################</span>

<span class="k">def</span> <span class="nf">_bands_pp</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    
    <span class="n">nspin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">scfuj</span><span class="o">.</span><span class="n">chkSpinCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">))</span>
    <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nspin</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;bands_up&#39;</span><span class="p">,</span><span class="n">ID</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;bands_dn&#39;</span><span class="p">,</span><span class="n">ID</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;bands_up&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="s1">&#39;bands.x&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./bands.x&#39;</span><span class="p">)</span>		


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_PW_bands_fix</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_up&#39;</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;bands_dn&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="s1">&#39;bands.x&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./bands.x&#39;</span><span class="p">)</span>		


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_PW_bands_fix</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_dn&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="n">execPrefix</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span><span class="n">executable</span><span class="o">=</span><span class="s1">&#39;bands.x&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./bands.x&#39;</span><span class="p">)</span>		

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_PW_bands_fix</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    


<span class="k">def</span> <span class="nf">_makeInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">engine</span><span class="p">,</span><span class="n">calcType</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the input file for postprocessing calculations</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): Dictionary of one of the calculations          </span>
<span class="sd">          engine (str): Particular engine executable being used for the postprocessing step </span>
<span class="sd">                        that you are calling to run the calculations (default=&#39;pw.x&#39;)          </span>
<span class="sd">          calcType (str): Type of PP calculation to be done</span>
<span class="sd">          </span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">          ID (str): ID hash for the calculation. Needed for the filename (&lt;ID&gt;_&lt;calcType&gt;.in)</span>

<span class="sd">    Returns:</span>
<span class="sd">          stringDict (str): Input string of the PP step</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>



    


    <span class="k">try</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_prefixFromInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>

    <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_get_tempdir</span><span class="p">()</span>
    <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> 
    <span class="n">calcType</span><span class="o">=</span><span class="n">calcType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">engine</span><span class="o">==</span><span class="s1">&#39;espresso&#39;</span><span class="p">:</span>
        <span class="n">bandsInput</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
        <span class="n">nbnd</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">calcType</span><span class="o">!=</span><span class="s1">&#39;scf&#39;</span><span class="p">:</span>
            <span class="n">bandsInput</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbnd</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nbnd</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;nbnd\s*=\s*([0-9]+)&#39;</span><span class="p">,</span><span class="n">bandsInput</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">nbnd</span><span class="o">=</span><span class="s1">&#39;30&#39;</span>

        <span class="n">stringDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dos&#39;</span><span class="p">:</span>
                        <span class="sd">&quot;&quot;&quot; &amp;dos</span>
<span class="sd">       prefix=&#39;%s&#39;</span>
<span class="sd">       outdir=&#39;%s&#39;</span>
<span class="sd">       DeltaE=0.05</span>
<span class="sd">       degauss=0.01</span>
<span class="sd">       fildos=&#39;%s_dos.dat&#39;</span>

<span class="sd">      /</span>
<span class="sd">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">ID</span><span class="p">),</span>
                            <span class="s1">&#39;pdos&#39;</span><span class="p">:</span><span class="s2">&quot;&quot;&quot;  &amp;projwfc</span>
<span class="s2">       prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">       DeltaE=0.05</span>
<span class="s2">!       Emax=20</span>
<span class="s2">!       Emin=-20</span>
<span class="s2">       outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">       degauss=0.001</span>
<span class="s2">    !    kresolveddos=.true.</span>
<span class="s2">       filpdos=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>

<span class="s2">      / </span>
<span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">ID</span><span class="p">),</span>

                    <span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="s2">&quot;&quot;&quot; &amp;bands</span>
<span class="s2">     prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">     outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">     filband=&#39;./</span><span class="si">%s</span><span class="s2">_band_data.out&#39;</span>
<span class="s2"> /</span>
<span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">ID</span><span class="p">),</span>

                    <span class="s1">&#39;bands_dn&#39;</span><span class="p">:</span><span class="s2">&quot;&quot;&quot; &amp;bands</span>
<span class="s2">     prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">     outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">     spin_component=2</span>
<span class="s2">     filband=&#39;./</span><span class="si">%s</span><span class="s2">_dn_band_data.out&#39;</span>
<span class="s2"> /</span>
<span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">ID</span><span class="p">),</span>

                    <span class="s1">&#39;bands_up&#39;</span><span class="p">:</span><span class="s2">&quot;&quot;&quot; &amp;bands</span>
<span class="s2">     prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">     outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">     spin_component=1</span>
<span class="s2">     filband=&#39;./</span><span class="si">%s</span><span class="s2">_up_band_data.out&#39;</span>
<span class="s2"> /</span>
<span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">temp_dir</span><span class="p">,</span><span class="n">ID</span><span class="p">),</span>



                    <span class="s1">&#39;scf&#39;</span><span class="p">:</span>
                        <span class="s1">&#39;None&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nmr&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;&amp;inputgipaw</span>
<span class="sd">  job = &#39;nmr&#39;</span>
<span class="sd">  prefix=&#39;%s&#39;</span>

<span class="sd">/</span>
<span class="sd">&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">prefix</span><span class="p">,</span>
                    <span class="s1">&#39;g_tensor&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;&amp;inputgipaw</span>
<span class="sd">  job = &#39;g_tensor&#39;</span>
<span class="sd">  prefix=&#39;%s&#39;</span>

<span class="sd">/&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">prefix</span><span class="p">,</span>

                    <span class="s1">&#39;emr&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;&amp;inputgipaw</span>
<span class="sd">  job = &#39;efg&#39;</span>
<span class="sd">  prefix=&#39;%s&#39;</span>
<span class="sd">                    </span>
<span class="sd">/</span>

<span class="sd">&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">prefix</span><span class="p">,</span>
                    <span class="s1">&#39;hyperfine&#39;</span><span class="p">:</span>
                        <span class="sd">&#39;&#39;&#39;&amp;inputgipaw</span>
<span class="sd">  job = &#39;hyperfine&#39;</span>
<span class="sd">  prefix=&#39;%s&#39;</span>
<span class="sd">  hfi_output_unit = &#39;MHz&#39;</span>
<span class="sd">/</span>
<span class="sd">&#39;&#39;&#39;</span> <span class="o">%</span><span class="n">prefix</span><span class="p">,</span>


                            <span class="p">}</span>

        

    <span class="k">return</span> <span class="n">stringDict</span><span class="p">[</span><span class="n">calcType</span><span class="p">]</span>
      
<span class="c1">################################################################################################################        </span>
<span class="c1">################################################################################################################</span>
 
        
            
<span class="c1">################################################################################################################</span>

<span class="c1">################################################################################################################</span>

<span class="c1"># def _fixconverge(ID,folder):</span>
<span class="c1">#     logging.debug(&#39;entering __fixconverge&#39;)</span>
<span class="c1">#     logging.warning(&#39;problem converging %s/%s.in&#39; % (folder,ID))</span>
<span class="c1">#     logging.debug(&#39;exiting __fixconverge&#39;) </span>


<span class="c1">################################################################################################################</span>


<span class="c1"># def _resubmit(ID,oneCalc,__submitNodeName__,queue,calcName):</span>

<span class="c1">#         def tryAgain():</span>
<span class="c1">#             __resubmit(ID,oneCalc,__submitNodeName__,queue,calcName)</span>

<span class="c1">#         signal.signal(signal.SIGTERM, tryAgain)	</span>
<span class="c1">#         try:</span>

<span class="c1">#             IDsplit = ID.split(&#39;_&#39;)[0]</span>
<span class="c1">#         except:</span>
<span class="c1">#             IDsplit=ID</span>

<span class="c1">#         newqsubFileName = os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;_%s.qsub&#39; % ID)</span>

<span class="c1">#         print &#39;resubmitting %s&#39; % calcName</span>
<span class="c1">#         command = &quot;ssh -o StrictHostKeyChecking=no %s &#39;qsub %s -N %s %s&#39;&quot; % (__submitNodeName__,queue,calcName,newqsubFileName)</span>

<span class="c1">#         try:</span>
<span class="c1">#             subprocess.check_call(command,stdout=subprocess.PIPE,shell=True)            </span>
<span class="c1">#             sys.exit(0)</span>


<span class="c1">#             print &#39;resubmission of %s successful&#39; % calcName</span>

<span class="c1">#         except Exception,e:</span>
<span class="c1">#             AFLOWpi.run._fancy_error_log(e)</span>
<span class="c1">#             __resubmit(IDsplit,oneCalc,__submitNodeName__,queue,calcName)</span>


<span class="c1">################################################################################################################</span>



<span class="c1"># def _lower_mixing(oneCalc,ID):</span>


<span class="c1">#     inputDict=AFLOWpi.retr._splitInput(oneCalc[&#39;_AFLOWPI_INPUT_&#39;])</span>
<span class="c1">#     try:</span>
<span class="c1">#         if &#39;&amp;electrons&#39; not in inputDict.keys():</span>
<span class="c1">#             inputDict[&#39;&amp;electrons&#39;]=collections.OrderedDict()</span>
<span class="c1">#         old_beta=&#39;0.7d0&#39;</span>
<span class="c1">#         if &#39;mixing_beta&#39; in inputDict[&#39;&amp;electrons&#39;].keys():</span>
<span class="c1">#             old_beta=inputDict[&#39;&amp;electrons&#39;][&#39;mixing_beta&#39;]</span>

<span class="c1">#         old_beta_float=__convert_fortran_double(old_beta)</span>
<span class="c1">#         new_beta_float=old_beta_float-0.2</span>
<span class="c1">#         if new_beta_float&gt;0.09:</span>
<span class="c1">#             inputDict[&#39;&amp;electrons&#39;][&#39;mixing_beta&#39;]=str(new_beta_float)</span>
<span class="c1">#             inputString=AFLOWpi.retr._splitInput(inputDict)</span>
<span class="c1">#             oneCalc[&#39;_AFLOWPI_INPUT_&#39;]=inputString</span>

<span class="c1">#             outFileName = os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],ID+&#39;.in&#39;)</span>
<span class="c1">#             with open(outFileName,&#39;w&#39;) as outFile:</span>
<span class="c1">#                 outFile.write(inputString)</span>
<span class="c1">#     except:</span>
<span class="c1">#         pass</span>
<span class="c1">#     AFLOWpi.prep._saveOneCalc(oneCalc,ID)</span>
    
<span class="c1">#     return oneCalc,ID</span>
    

<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> 


<span class="k">def</span> <span class="nf">_grab_elastic_generated_inputs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="n">glob_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;Structures_ESPRESSO&#39;</span><span class="p">)</span>
    <span class="n">input_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_path</span><span class="o">+</span><span class="s1">&#39;/*.in&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">input_files</span>

<span class="k">def</span> <span class="nf">_prep_elastic</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">eta_max</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="n">num_dist</span><span class="o">=</span><span class="mi">49</span><span class="p">,</span><span class="n">use_stress</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]:</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;ElaStic_PW.in&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">split_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">detachPosFlags</span><span class="p">(</span><span class="n">split_input</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">split_input</span><span class="p">[</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pos</span>

    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">split_input</span><span class="p">)</span>
    
    <span class="n">write_in</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
    <span class="n">elastic_qe_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;ElaStic_PW.in&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">elastic_qe_in</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">eqfo</span><span class="p">:</span>
        <span class="n">eqfo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_in</span><span class="p">)</span>

    <span class="n">elastic_ID</span> <span class="o">=</span> <span class="n">ID</span><span class="o">+</span><span class="s1">&#39;_ElaStic&#39;</span>

    <span class="k">if</span> <span class="n">use_stress</span><span class="p">:</span>
        <span class="n">calc_meth</span><span class="o">=</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">calc_meth</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">elastic_in_string</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span><span class="si">%s</span><span class="s1"></span>
<span class="si">%s</span><span class="s1"></span>
<span class="si">%s</span><span class="s1"></span>
<span class="si">%s</span><span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">calc_meth</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">eta_max</span><span class="p">,</span><span class="n">num_dist</span><span class="p">)</span>

    <span class="n">elastic_in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">elastic_ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">elastic_in_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">eifo</span><span class="p">:</span>
        <span class="n">eifo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">elastic_in_string</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;ElaStic_Setup_ESPRESSO&lt;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">elastic_in_file</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_copy_qe_out_file</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="n">stripped_step_ID</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dist_num</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">orig_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="n">new_path</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../../</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dist_num</span><span class="p">,</span><span class="n">stripped_step_ID</span><span class="p">),</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">stripped_step_ID</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">orig_path</span><span class="p">,</span><span class="n">new_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_grab_el_plot_data</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="n">fit_data_by_order</span><span class="o">=</span><span class="p">{}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dfo</span><span class="p">:</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">per_fit_order</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;#.*(\d+).*</span><span class="se">\n</span><span class="s1">((?:[-0-9.\s]*</span><span class="se">\n</span><span class="s1">)*)&#39;</span><span class="p">,</span><span class="n">dfs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">order</span><span class="p">,</span><span class="n">fit_data</span> <span class="ow">in</span> <span class="n">per_fit_order</span><span class="p">:</span>
        <span class="n">fit_array</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fit_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">to_float</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_float</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">fit_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_float</span><span class="p">)</span>

        <span class="n">fit_data_by_order</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">=</span><span class="n">fit_array</span>

    <span class="k">return</span> <span class="n">fit_data_by_order</span>

<span class="k">def</span> <span class="nf">_find_flat_region</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">val</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#Sort the data into two arrays. one for eta and one for the values</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">eta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1">#set the max variance from one step to the next for the plateau region.</span>
    <span class="c1">#if the variance from one step to the next is greater than the value</span>
    <span class="c1">#below then that is considered the end of the plateau.</span>
    <span class="n">variance</span><span class="o">=</span><span class="mf">10.0</span>

    <span class="n">plateau_index</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1">#reverse the order or eta and values to start with lowest eta first</span>
    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">eta</span><span class="p">)]</span>

    <span class="c1">#find difference between one point and the next</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">found</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grad</span><span class="p">)):</span>
        <span class="c1">#if we find a values between one eta and the next is less than</span>
        <span class="c1">#our designated variance threshold then start looking for the end</span>
        <span class="c1">#if it. If we haven&#39;t found a plateau and the variance is greater</span>
        <span class="c1">#than the threshold keep looking for the plateau. If we have found</span>
        <span class="c1">#the plateau and we find the end of it then record the index of the</span>
        <span class="c1">#end of the plateau and use the eta at that index as our max eta</span>
        <span class="k">if</span> <span class="n">grad</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">&lt;</span><span class="n">variance</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">found</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">found</span><span class="o">=</span><span class="kc">True</span>

            <span class="n">plateau_index</span><span class="o">=</span><span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">found</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="nb">print</span> <span class="s1">&#39;plateau ends at index:&#39;</span><span class="p">,</span><span class="n">plateau_index</span>

    <span class="k">return</span> <span class="n">eta</span><span class="p">[</span><span class="n">plateau_index</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_pp_elastic</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">use_stress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">res_analyze</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">result_input_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">result_output_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">use_stress</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;ElaStic_Analyze_Stress&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">res_analyze</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_Result_Stress_2nd&#39;</span>
            <span class="n">result_input_file</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_2nd.in&#39;</span>
            <span class="n">result_output_file</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_2nd.out&#39;</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">res_analyze</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_Result_Stress_3rd&#39;</span>
            <span class="n">result_input_file</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_3rd.in&#39;</span>
            <span class="n">result_output_file</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_3rd.out&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;ElaStic_Analyze_Energy&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">res_analyze</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_Result_Energy_2nd&#39;</span>
            <span class="n">result_input_file</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_2nd.in&#39;</span>
            <span class="n">result_output_file</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_2nd.out&#39;</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">res_analyze</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_Result_Energy_3rd&#39;</span>
            <span class="n">result_input_file</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_3rd.in&#39;</span>
            <span class="n">result_output_file</span> <span class="o">=</span> <span class="s1">&#39;ElaStic_3rd.out&#39;</span>



    <span class="n">svs_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;Stress-vs-Strain&#39;</span><span class="p">)</span>

    <span class="n">fit_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">svs_folder</span><span class="o">+</span><span class="s1">&#39;/*_d1S.dat&#39;</span><span class="p">)</span>


    <span class="n">files_sep_dist</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">results_input_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">fit_files</span><span class="p">:</span>
        <span class="n">distortion_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files_sep_dist</span><span class="p">[</span><span class="n">distortion_ID</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">files_sep_dist</span><span class="p">[</span><span class="n">distortion_ID</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">data_file</span><span class="p">]</span>
    
    
    <span class="k">for</span> <span class="n">distortion_ID</span><span class="p">,</span><span class="n">fit_files</span> <span class="ow">in</span> <span class="n">files_sep_dist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">order_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">m_eta_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">fit_files</span><span class="p">:</span>
            <span class="n">distortion_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fit_data</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_grab_el_plot_data</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
            <span class="c1">#set a global max eta for all fittings</span>
            <span class="n">global_max_eta</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="c1">#set the order of the polynomial to fit to.</span>
            <span class="n">poly_fit_choice</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">use_stress</span><span class="p">:</span>
                <span class="n">fit_index</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fit_index</span><span class="o">=</span><span class="mi">2</span>
            <span class="c1">#iterate through all orders of poly fit data</span>
            <span class="k">for</span> <span class="n">poly_order</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="n">fit_data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c1">#find max eta for one order of poly fit</span>
                <span class="n">max_eta</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_find_flat_region</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="c1">#check if the max eta is greater or equal to the current global</span>
                <span class="c1">#max eta. If the value is equal then prefer a higher order</span>
                <span class="c1">#polynomial fit to a lower one.</span>
                <span class="k">if</span> <span class="n">max_eta</span><span class="o">&gt;=</span><span class="n">global_max_eta</span><span class="p">:</span>
                    <span class="n">global_max_eta</span><span class="o">=</span><span class="n">max_eta</span>
                    <span class="n">fit_index</span><span class="o">=</span><span class="n">poly_order</span>
            <span class="c1">#append the values for max eta and poly fit order </span>
            <span class="c1">#to a list to later be used to create the the ElaStic_2nd.in</span>
            <span class="c1">#file.</span>
            <span class="n">order_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit_index</span><span class="p">)</span>
            <span class="n">m_eta_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_max_eta</span><span class="p">)</span>
        <span class="c1">#write the entry in the file</span>
        <span class="n">results_input_str</span><span class="o">+=</span><span class="n">distortion_ID</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">m_eta_list</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">results_input_str</span><span class="o">+=</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">distortion_ID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">order_list</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="c1">#write the input for ElaStic_Result_Stress_2nd</span>
    <span class="n">res_input</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">result_input_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">res_input</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rifo</span><span class="p">:</span>
        <span class="n">rifo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">results_input_str</span><span class="p">)</span>

    <span class="c1">#run ElaStic_Result_Stress_2nd or whatever result analyzer code</span>
    <span class="c1">#that is to be run.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">res_analyze</span><span class="p">)</span>
    <span class="c1">#move results to file with unique name</span>
    <span class="n">res_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">result_output_file</span><span class="p">)</span>
    <span class="n">new_res_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_elastic.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">res_output</span><span class="p">,</span><span class="n">new_res_output</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span> 

<span class="k">def</span> <span class="nf">_collect_fd_field_forces</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the forces to be saved to files for</span>
<span class="sd">    parsing by fd_ifc.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         for_type (str): type of file to pull from in FD_PHONON dir (choices are &#39;raman&#39;, &#39;born&#39;, &#39;epol&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">         force_out_str (str) a string of the contents of the file</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;raman&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;force&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;born&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;force&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;epol&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;epol&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">force_out_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">force_file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;./FD_PHONON/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">val_type</span><span class="p">,</span><span class="n">index</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">force_file_path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">force_file</span><span class="p">:</span>
                <span class="n">force_str</span><span class="o">=</span><span class="n">force_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">force_out_str</span><span class="o">+=</span><span class="n">force_str</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">force_out_str</span>

<span class="k">def</span> <span class="nf">_pull_polarization</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the forces to be saved to files for</span>
<span class="sd">    parsing by fd_ifc.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         None</span>

<span class="sd">    Returns:</span>
<span class="sd">         None </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
        <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    
    <span class="n">e_pol_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Electronic Dipole on Cartesian axes\s*</span><span class="se">\n</span><span class="s1">((?:\W*[123]\s*.*</span><span class="se">\n</span><span class="s1">)+)&#39;</span><span class="p">)</span>
    <span class="n">e_ion_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Ionic Dipole on Cartesian axes\s*</span><span class="se">\n</span><span class="s1">((?:\W*[123]\s*.*</span><span class="se">\n</span><span class="s1">)+)&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ele_block</span><span class="o">=</span><span class="n">e_pol_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ion_block</span><span class="o">=</span><span class="n">e_ion_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>



    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">e_pol_split</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ele_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_ion_split</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ion_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
    
    
    <span class="n">e_tot_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_pol_split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e_pol_split</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">e_pol_split</span><span class="p">[</span><span class="mi">2</span><span class="p">],]</span>

    <span class="n">epol_out_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="n">epol_out_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%25.15e%25.15e%25.15e</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">e_tot_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">e_tot_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">e_tot_split</span><span class="p">[</span><span class="mi">2</span><span class="p">]),)</span>

    <span class="n">force_postfix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">force_postfix</span><span class="o">=</span><span class="n">force_postfix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="s1">&#39;epol.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">force_postfix</span><span class="p">),</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
        <span class="n">out_file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">epol_out_string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_pull_eps_out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the eps_0 to be saved to files for</span>
<span class="sd">    use by matdyn.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         None</span>

<span class="sd">    Returns:</span>
<span class="sd">         eps_string (str): string of the eps</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">eps_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">eps_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Dielectric tensor</span><span class="se">\n</span><span class="s1">.*</span><span class="se">\n</span><span class="s1">\s*([0-9\s.-]*)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_epol.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
            <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">eps_string</span><span class="o">=</span><span class="n">eps_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eps_string</span>

<span class="k">def</span> <span class="nf">_pull_born_out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the born effective charges to be saved </span>
<span class="sd">    to files for use by matdyn.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         None</span>

<span class="sd">    Returns:</span>
<span class="sd">         born_string (str) string of the born eff. charges</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">born_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">born_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;atom\s*\d*</span><span class="se">\n</span><span class="s1">(?:([-.0-9\s]+)+)&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_born.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
            <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">born_charges</span><span class="o">=</span><span class="n">born_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">born_charges</span><span class="p">)):</span>
            <span class="n">num_index</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">born_string</span><span class="o">+=</span><span class="s1">&#39;         </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">num_index</span>
            <span class="n">born_string</span><span class="o">+=</span><span class="n">born_charges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">born_string</span>

<span class="k">def</span> <span class="nf">_gen_fd_input</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.003</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the input files for the finite field calcs from the input file string in oneCalc</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         for_type (str): which type of FD input do we want to generate files for. &#39;raman&#39;,&#39;born&#39;,&#39;eps&#39;</span>
<span class="sd">         de (float): applied electric field strength</span>

<span class="sd">    Returns:</span>
<span class="sd">         None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;raman&#39;</span><span class="p">:</span>
        <span class="n">card</span><span class="o">=</span><span class="s1">&#39;RAMAN_TENSOR&#39;</span>
        <span class="n">input_name_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span>
        <span class="n">npol</span><span class="o">=</span><span class="mi">4</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;born&#39;</span><span class="p">:</span>
        <span class="n">card</span><span class="o">=</span><span class="s1">&#39;BORN_CHARGES&#39;</span>        
        <span class="n">input_name_type</span><span class="o">=</span><span class="s1">&#39;zeu&#39;</span>
        <span class="n">npol</span><span class="o">=</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;epol&#39;</span><span class="p">:</span>
        <span class="n">card</span><span class="o">=</span><span class="s1">&#39;DIELECTRIC_TENSOR&#39;</span>
        <span class="n">input_name_type</span><span class="o">=</span><span class="s1">&#39;eps&#39;</span>
        <span class="n">npol</span><span class="o">=</span><span class="mi">2</span>


    <span class="n">header</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;&amp;inputfd</span>
<span class="s1">   prefix=&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
<span class="s1">   de_</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">   npol_</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">/</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">],</span><span class="n">input_name_type</span><span class="p">,</span><span class="n">de</span><span class="p">,</span><span class="n">input_name_type</span><span class="p">,</span><span class="n">npol</span><span class="p">)</span>



    <span class="n">header</span><span class="o">+=</span><span class="n">card</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">forces</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_collect_fd_field_forces</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="n">for_type</span><span class="p">)</span>
    <span class="n">header</span><span class="o">+=</span><span class="n">forces</span>
    
    <span class="n">finite_field_input</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finite_field_input</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">force_file</span><span class="p">:</span>
        <span class="n">force_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_swap_scf_inputs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Swaps the value of oneCalc[&#39;_AFLOWPI_INPUT_&#39;] in oneCalc to the finite field input</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_by_ID_obj</span><span class="p">:</span>
            <span class="n">input_string</span> <span class="o">=</span> <span class="n">in_by_ID_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">input_string</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">oneCalc</span>

<span class="k">def</span> <span class="nf">_setup_raman</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">,</span><span class="n">orig_oneCalc</span><span class="p">,</span><span class="n">orig_ID</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">field_cycles</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the input files and the command to run the finite field calculations.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          calc_subset (dict): dictionary of dictionaries of the FD_PHONON calculations </span>
<span class="sd">          orig_oneCalc (dict): oneCalc of one calculation the main calc set</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         feild_strength (float): applied electric field strength</span>
<span class="sd">         field_cycles (int) number of berry phase cycles</span>
<span class="sd">         for_type (str): which type of FD input do we want to generate files for. &#39;raman&#39;,&#39;born&#39;,&#39;eps&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">         None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_string</span><span class="o">=</span><span class="n">orig_oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span>
    <span class="n">subset_keys</span> <span class="o">=</span> <span class="n">calc_subset</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">in_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>

    <span class="c1">#if possibly a metal don&#39;t do LOTO</span>

    <span class="k">if</span> <span class="s1">&#39;degauss&#39;</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bandgap_type</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">gap_type</span><span class="p">(</span><span class="n">orig_oneCalc</span><span class="p">,</span><span class="n">orig_ID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bandgap_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;p-type&#39;</span><span class="p">,</span><span class="s1">&#39;n-type&#39;</span><span class="p">,</span><span class="s1">&#39;insulator&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;degauss&#39;</span> <span class="ow">in</span> <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;degauss&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="s2">&quot;occupations&quot;</span> <span class="ow">in</span> <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">val</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;occupations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">==</span><span class="s2">&quot;smearing&quot;</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;occupations&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">input_string</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">in_dict</span><span class="p">)</span>


    <span class="c1">#copy for when we append finite field calcs to the calclog</span>
    <span class="n">calc_subset_extended</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;raman&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;force&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;born&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;force&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;epol&#39;</span><span class="p">:</span>
        <span class="n">val_type</span><span class="o">=</span><span class="s1">&#39;epol&#39;</span>
        <span class="n">num</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">num_calcs</span><span class="o">=</span><span class="mi">19</span>
    <span class="n">subset_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">calc_subset</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)):</span>        
        <span class="n">fd_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_field_factory</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="n">field_strength</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="n">for_type</span><span class="p">,</span><span class="n">field_cycles</span><span class="o">=</span><span class="n">field_cycles</span><span class="p">,</span><span class="n">dir_index</span><span class="o">=</span><span class="n">num</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

        <span class="n">subset_key_index</span><span class="o">=</span><span class="n">num</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">%</span><span class="n">subset_size</span>
        <span class="n">exec_counter_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="o">/</span><span class="n">subset_size</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">ID</span> <span class="o">=</span> <span class="n">subset_keys</span><span class="p">[</span><span class="n">subset_key_index</span><span class="p">]</span>
        <span class="n">oneCalc</span><span class="o">=</span><span class="n">calc_subset</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>

        <span class="c1">#set prefix in finite field input to that of the FD phonon calc&#39;s input</span>
        <span class="n">split_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">fd_input</span><span class="p">)</span>
        <span class="n">split_input</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="n">calc_subset</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>
        <span class="n">fd_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">split_input</span><span class="p">)</span>

        <span class="n">FD_ID</span><span class="o">=</span><span class="s1">&#39;finite_field.</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">num</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">file_path_fd_field_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span><span class="o">%</span><span class="n">FD_ID</span><span class="p">)</span>
    

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path_fd_field_in</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd_in_obj</span><span class="p">:</span>
            <span class="n">fd_in_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd_input</span><span class="p">)</span>


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;oneCalc_ff = AFLOWpi.run._swap_scf_inputs(oneCalc,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">FD_ID</span><span class="p">)</span>       
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;&#39;AFLOWpi.prep._to_local_scratch(oneCalc_ff,&#39;</span><span class="si">%s</span><span class="s1">&#39;)&#39;&#39;&#39;</span><span class="o">%</span><span class="n">FD_ID</span><span class="p">)</span>


        <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>
        <span class="n">run_command</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;if oneCalc[&#39;__execCounter__&#39;]&lt;=</span><span class="si">%s</span><span class="s2">:</span>
<span class="s2">        AFLOWpi.run._oneRun(__submitNodeName__,oneCalc,&#39;</span><span class="si">%s</span><span class="s2">&#39;,execPrefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;,execPostfix=&#39;-northo 1&#39;,engine=&#39;espresso&#39;,calcType=&#39;scf&#39;,exit_on_error=True)</span>
<span class="s2">        oneCalc[&#39;__execCounter__&#39;]+=1</span>
<span class="s2">        AFLOWpi.prep._saveOneCalc(oneCalc,ID)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exec_counter_index</span><span class="p">),</span><span class="n">FD_ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="p">)</span>

        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="n">run_command</span><span class="p">)</span>       

<span class="c1">#        AFLOWpi.run._onePrep(oneCalc,ID,engine=&#39;espresso&#39;,calcType=&#39;scf&#39;,execPrefix=execPrefix,execPostfix=&#39; -northo 1 &#39;,alt_ID=FD_ID,)</span>


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;AFLOWpi.run._pull_forces(oneCalc_ff,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">FD_ID</span><span class="p">)</span>       
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;&quot;AFLOWpi.run._pull_polarization(oneCalc_ff,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">FD_ID</span><span class="p">)</span>       


        <span class="c1"># add finite field to calcs for calclog</span>
        <span class="n">oneCalc_FD</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
        <span class="n">oneCalc_FD</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fd_input</span>
        <span class="n">calc_subset_extended</span><span class="p">[</span><span class="n">FD_ID</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc_FD</span>

    <span class="c1">#update the calclogs to include FD_fields so when all phonon supercell</span>
    <span class="c1">#are finished but not finite fields the main script doesn&#39;t try to run</span>
    <span class="n">chain_index</span><span class="o">=</span><span class="n">orig_oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>

<span class="c1">#FIX THIS</span>
<span class="c1">#FIX THIS</span>
    <span class="n">chain_logname</span><span class="o">=</span><span class="s1">&#39;step_01&#39;</span>
<span class="c1">###    chain_logname=&#39;step_%02d&#39;% chain_index</span>
<span class="c1">#FIX THIS</span>
<span class="c1">#FIX THIS</span>

<span class="c1">#    AFLOWpi.prep.updatelogs(calc_subset_extended,chain_logname,runlocal=True)</span>

<span class="k">def</span> <span class="nf">_field_factory</span><span class="p">(</span><span class="n">input_str</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="s1">&#39;raman&#39;</span><span class="p">,</span><span class="n">field_cycles</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">dir_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modifies the QE pwscf input for the finite field calc of a given index</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">         input_str (str): string of QE pwscf input file</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         feild_strength (float): applied electric field strength</span>
<span class="sd">         field_cycles (int) number of berry phase cycles</span>
<span class="sd">         for_type (str): which type of FD input do we want to generate files for. &#39;raman&#39;,&#39;born&#39;,&#39;eps&#39;</span>
<span class="sd">         dir_index (int): index of the finite field direction to choose</span>

<span class="sd">    Returns:</span>
<span class="sd">         new_input (str): the modified input string</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;eps&#39;</span> <span class="ow">or</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;born&#39;</span><span class="p">:</span>
        <span class="n">field_dir</span><span class="o">=</span><span class="p">[[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># 0</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -x</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  x</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -y</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  y</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -z</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],]</span>  <span class="c1">#  z</span>
    <span class="k">if</span> <span class="n">for_type</span><span class="o">==</span><span class="s1">&#39;raman&#39;</span><span class="p">:</span>
        <span class="n">field_dir</span><span class="o">=</span><span class="p">[[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># 0</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -x</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  x</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -y</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  y</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -z</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  z</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -x-y</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  xy</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1">#  x-y </span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,],</span>  <span class="c1"># -xy</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -x-z</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  xz</span>
                   <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  x-z</span>
                   <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -xz</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1"># -y-z</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  yz</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,],</span>  <span class="c1">#  y-z</span>
                   <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,],]</span>  <span class="c1">#  -yz</span>


    <span class="n">in_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;lelfield&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;.TRUE.&#39;</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;scf&#39;&quot;</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;nberrycyc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">field_cycles</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;tprnfor&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;.TRUE.&#39;</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;_finite_field.</span><span class="si">%02d</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">dir_index</span>

    <span class="n">input_list</span><span class="o">=</span><span class="p">[]</span>

<span class="c1">#    for i in range(len(field_dir)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_dir</span><span class="p">[</span><span class="n">dir_index</span><span class="p">])):</span>
        <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;efield_cart(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">=</span><span class="n">field_dir</span><span class="p">[</span><span class="n">dir_index</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">field_strength</span>

    <span class="n">new_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">in_dict</span><span class="p">)</span>

        
    <span class="k">return</span> <span class="n">new_input</span>

<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">numpy</span> 
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;PDF&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>


<span class="k">def</span> <span class="nf">_gen_smear_conv_calcs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">num_points</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">smear_type</span><span class="o">=</span><span class="s1">&#39;mp&#39;</span><span class="p">,</span><span class="n">smear_variance</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">):</span>

    <span class="n">input_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s2">&quot;_AFLOWPI_INPUT_&quot;</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">initial_degauss</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;degauss&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">initial_degauss</span> <span class="o">=</span> <span class="s1">&#39;0.01&#39;</span>

        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;occupations&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&quot;smearing&quot;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;smearing&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;smearing&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="n">smear_type</span>

    <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;degauss&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">initial_degauss</span>

    <span class="n">fl_degauss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">initial_degauss</span><span class="p">)</span>
    <span class="n">ub_degauss</span> <span class="o">=</span> <span class="n">fl_degauss</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">smear_variance</span><span class="p">)</span>
    <span class="n">lb_degauss</span> <span class="o">=</span> <span class="n">fl_degauss</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">smear_variance</span><span class="p">)</span>
    
    <span class="n">ub_degauss</span> <span class="o">=</span> <span class="n">fl_degauss</span><span class="o">*</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="n">lb_degauss</span> <span class="o">=</span> <span class="n">fl_degauss</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ub_degauss</span> <span class="o">=</span> <span class="n">fl_degauss</span><span class="o">+</span><span class="mf">0.005</span>
    <span class="n">lb_degauss</span> <span class="o">=</span> <span class="n">fl_degauss</span><span class="o">-</span><span class="mf">0.005</span>
    <span class="n">degauss_vals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lb_degauss</span><span class="p">,</span><span class="n">ub_degauss</span><span class="p">,</span><span class="n">num_points</span><span class="p">)</span>


    <span class="n">input_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">degauss_vals</span><span class="p">:</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;degauss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">calc_type</span>
        <span class="n">one_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>

        <span class="n">input_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">input_files</span>



<span class="k">def</span> <span class="nf">_extrapolate_smearing</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>

    <span class="n">folder</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="n">calc_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s1">&#39;SMEARING&#39;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;calclogs&#39;</span><span class="p">,</span><span class="s1">&#39;step_01.log&#39;</span><span class="p">)</span>

    <span class="n">calcs</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_load_log_from_filename</span><span class="p">(</span><span class="n">calc_log</span><span class="p">)</span>

    <span class="n">de_set</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">smear_vals</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">calcs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">grabEnergyOut</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

        <span class="n">oc_in_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
        <span class="n">smear_type</span> <span class="o">=</span> <span class="n">oc_in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;smearing&#39;</span><span class="p">]</span>
        <span class="n">smear_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">oc_in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;degauss&#39;</span><span class="p">])</span>
        <span class="n">en</span>         <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;Energy&#39;</span><span class="p">])</span>
<span class="c1">#        force=AFLOWpi.retr.getForce(v,k,string=False)</span>
        <span class="k">if</span> <span class="n">en</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="c1">#            de_set.append(force)</span>
            <span class="n">de_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">en</span><span class="p">)</span>
            <span class="n">smear_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smear_val</span><span class="p">)</span>


    <span class="n">de_set</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">de_set</span><span class="p">)</span>
    <span class="c1">#CHECK THIS</span>
    <span class="n">smear_vals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">smear_vals</span><span class="p">)</span>
<span class="c1">#    (x_0,x_1) = </span>
<span class="c1">#    de_set=numpy.abs(de_set)</span>
    <span class="n">max_de</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">smear_vals</span><span class="p">)</span>
    <span class="n">min_de</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">smear_vals</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">min_de</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">min_end</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="n">min_de</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_end</span><span class="o">=-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">min_de</span>

    <span class="k">if</span> <span class="n">max_de</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">max_end</span><span class="o">=-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">max_de</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_end</span><span class="o">=</span> <span class="n">max_de</span><span class="o">*</span><span class="mf">2.0</span>

    <span class="n">extrap_smear</span><span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">max_end</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
<span class="c1">#    interp_en = interp_en.tolist()</span>
<span class="c1">#    interp_en.append(0.0)</span>
<span class="c1">#    interp_en = numpy.asarray(interp_en)</span>

    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">smear_vals</span><span class="p">,</span><span class="n">de_set</span><span class="p">,]</span>

<span class="c1">#    extrap_smear = numpy.polyval(numpy.polyfit(en_set,smear_vals,2),interp_en)</span>

<span class="c1">#    en_data_diff=numpy.abs(numpy.gradient(params[1]))</span>
<span class="c1">#    en_data_diff=numpy.gradient(params[1])</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fit_en</span> <span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span><span class="n">extrap_smear</span><span class="p">)</span>
<span class="c1">#    en_deriv = numpy.polyfit(params[0],en_data_diff,1)</span>
<span class="c1">#    print fit</span>
    <span class="n">en_deriv</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">polyder</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="c1">#    en_deriv=fit</span>

    <span class="nb">print</span> <span class="n">en_deriv</span>
<span class="c1">#    en_deriv=fit.deriv()</span>
<span class="c1">#    fir1d= numpy.polyfit(params[0],params[1],1)</span>
    <span class="n">interp_en</span> <span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">en_deriv</span><span class="p">,</span><span class="n">extrap_smear</span><span class="p">)</span>

<span class="c1">#    interp_en = en_deriv(extrap_smear)</span>
<span class="c1">#    at_zero = en_deriv[0]</span>
    <span class="n">at_zero</span><span class="o">=</span><span class="n">en_deriv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">en_deriv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span> <span class="n">at_zero</span>
    <span class="nb">print</span> <span class="n">de_set</span>
<span class="c1">#    print en_data_diff</span>
    <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">at_zero</span><span class="o">&lt;</span><span class="mf">0.001</span><span class="p">:</span>
        <span class="c1">#if we don&#39;t need smearing get rid of it.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;degauss&#39;</span><span class="p">,</span><span class="n">at_zero</span><span class="p">,</span><span class="n">del_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#CHECK THIS!!!!</span>
            <span class="n">smu</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;occupations&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">smu</span> <span class="o">==</span> <span class="s1">&#39;smearing&#39;</span><span class="p">:</span>
                <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;occupations&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;smearing&quot;&#39;</span><span class="p">,</span><span class="n">del_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;smearing&#39;</span><span class="p">,</span><span class="n">smear_type</span><span class="p">,</span><span class="n">del_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="k">pass</span>
        

    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#if we need smearing</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;degauss&#39;</span><span class="p">,</span><span class="n">at_zero</span><span class="p">,</span><span class="n">del_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;occupations&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;smearing&quot;&#39;</span><span class="p">,</span><span class="n">del_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;smearing&#39;</span><span class="p">,</span><span class="n">smear_type</span><span class="p">,</span><span class="n">del_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="n">return_input</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">return_input</span>


    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;font&quot;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;serif&quot;</span><span class="p">)</span>      <span class="c1">#to set the font type</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;font&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>             <span class="c1">#to set the font size</span>

    <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">smear_vals</span><span class="p">,</span><span class="n">de_set</span><span class="p">,</span><span class="s2">&quot;b.&quot;</span><span class="p">)</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">extrap_smear</span><span class="p">,</span><span class="n">fit_en</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="c1">#    matplotlib.pyplot.plot(smear_vals,en_data_diff,&quot;b.&quot;)</span>
<span class="c1">#    matplotlib.pyplot.plot(extrap_smear,interp_en,&quot;r&quot;)</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;|$\Delta$E|&quot;</span><span class="p">)</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;degauss (Ry)&quot;</span><span class="p">)</span>
    <span class="n">subdir</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="n">fileplot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;SMEARING_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getStoicName</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">ID</span><span class="p">))</span>

    <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileplot</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>



<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span> 

<span class="k">def</span> <span class="nf">_get_cluster_submit_command</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;set parent processID to 0 so they&#39;ll be different when the script starts&#39;&#39;&#39;</span>
    <span class="n">clusterType</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">submitCommand</span><span class="o">=</span><span class="s1">&#39;qsub&#39;</span>
    <span class="k">if</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
        <span class="n">submitCommand</span><span class="o">=</span><span class="s1">&#39;sbatch&#39;</span>  
    <span class="k">elif</span> <span class="n">clusterType</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;UGE&#39;</span><span class="p">:</span>
            <span class="n">submitCommand</span><span class="o">=</span><span class="s1">&#39;qsub&#39;</span>


    <span class="k">return</span> <span class="n">submitCommand</span>
                    
<span class="k">def</span> <span class="nf">_check_and_submit</span><span class="p">(</span><span class="n">submit_file</span><span class="p">,</span><span class="n">sub_command</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">submit_file</span><span class="p">):</span>
        <span class="n">qf</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">u&#39;.submit&#39;</span><span class="p">,</span><span class="s1">u&#39;.qsub&#39;</span><span class="p">,</span><span class="n">submit_file</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sub_command</span><span class="p">,</span><span class="n">qf</span><span class="p">))</span>
        <span class="n">directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">submit_file</span><span class="p">)</span>
        <span class="n">ID</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">submit_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./submitted.log&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">submitted_log_file</span><span class="p">:</span>
                <span class="n">submitted_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./submitted.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">submitted_log_file</span><span class="p">:</span>
                <span class="n">submitted_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Daemon submitted </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">directory</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">submit_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_generate_submission_daemon_script</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="n">workdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;work_dir&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">project</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;PROJECT&#39;</span><span class="p">]</span>
        <span class="n">calc_set</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;SET&#39;</span><span class="p">]</span>
        <span class="k">break</span>
    <span class="n">configFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">project</span><span class="p">,</span><span class="n">calc_set</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;CONFIG.config&#39;</span><span class="p">)</span>
    <span class="n">submit_daemon_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">project</span><span class="p">,</span><span class="n">calc_set</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;submission_daemon&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">submit_daemon_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">submit_daemon_dir</span><span class="p">)</span>

    <span class="n">daemon_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">submit_daemon_dir</span><span class="p">,</span><span class="s1">&#39;submit_daemon.py&#39;</span><span class="p">)</span>

    <span class="n">daemon_file_string</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">import AFLOWpi</span>
<span class="s1">import logging</span>
<span class="s1">import time</span>

<span class="s1">logging.basicConfig(filename=&#39;../LOG.log&#39;,format=&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;, datefmt=&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y %I:%M:%S %p&#39;,level=logging.DEBUG)</span>
<span class="s1">configFile=&#39;&#39;&#39;</span>

    <span class="n">daemon_file_string</span><span class="o">+=</span><span class="nb">repr</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>
    <span class="n">daemon_file_string</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">AFLOWpi.prep._forceGlobalConfigFile(configFile)</span>
<span class="s1">AFLOWpi.run._run_submission_check()</span>
<span class="s1">AFLOWpi.run._restart_submission_daemon(&#39;submit_daemon.py&#39;)&#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s1">&#39;generating daemon script in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">daemon_file_name</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">daemon_file_name</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">daemon_file_object</span><span class="p">:</span>
        <span class="n">daemon_file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">daemon_file_string</span><span class="p">)</span>


    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_start_submission_daemon</span><span class="p">(</span><span class="n">daemon_file_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_start_submission_daemon</span><span class="p">(</span><span class="n">daemon_file_name</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;starting daemon script: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">daemon_file_name</span>    
    <span class="n">cur_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">daemon_file_name</span><span class="p">))</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;nohup python ./submit_daemon.py  &amp;&#39;</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cur_dir</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;daemon script started&#39;</span>

<span class="k">def</span> <span class="nf">_restart_submission_daemon</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;nohup python ./</span><span class="si">%s</span><span class="s1"> &amp;&#39;</span><span class="o">%</span><span class="n">file_name</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">_submit_log_append</span><span class="p">(</span><span class="n">addition_list</span><span class="p">,</span><span class="n">logname</span><span class="o">=</span><span class="s1">&#39;./log_list.log&#39;</span><span class="p">):</span>
    <span class="n">daemon_submission_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">logname</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">daemon_submission_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">daemon_submission_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logname</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logname</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_list_obj</span><span class="p">:</span>
            <span class="n">log_list_string</span> <span class="o">=</span> <span class="n">log_list_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">logs</span><span class="o">=</span><span class="n">log_list_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logs</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">logs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">addition_list</span><span class="p">)</span>
    <span class="n">logs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">logs</span><span class="p">))</span>
    <span class="n">log_list_string</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_list_obj</span><span class="p">:</span>
        <span class="n">log_list_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_list_string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_run_submission_check</span><span class="p">():</span>
    <span class="n">calc_list</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_load_submit_log</span><span class="p">()</span>
    
    <span class="n">need_submitting</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_check_statuses</span><span class="p">(</span><span class="n">calc_list</span><span class="p">)</span>

    <span class="n">sub_command</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_cluster_submit_command</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">submit_file</span> <span class="ow">in</span> <span class="n">need_submitting</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_check_and_submit</span><span class="p">(</span><span class="n">submit_file</span><span class="p">,</span><span class="n">sub_command</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_submit_log</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./log_list.log&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_list_obj</span><span class="p">:</span>
        <span class="n">log_list_string</span> <span class="o">=</span> <span class="n">log_list_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    
    <span class="n">logs</span><span class="o">=</span><span class="n">log_list_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">calc_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">logs</span><span class="p">):</span>
        <span class="n">calc_step</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_potential_sub_locs</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">calc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_step</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">calc_list</span>

<span class="k">def</span> <span class="nf">_get_potential_sub_locs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_file_obj</span><span class="p">:</span>
        <span class="n">log_file_str</span> <span class="o">=</span> <span class="n">log_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">oneCalc_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">log_file_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
    <span class="n">calcs</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">oneCalc_file</span> <span class="ow">in</span> <span class="n">oneCalc_locs</span><span class="p">:</span>
        <span class="n">ID</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">oneCalc_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">oneCalc_file</span><span class="p">):</span>
            <span class="n">oneCalc</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_loadOneCalc</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">:</span><span class="n">folder</span><span class="p">}</span>
            
    <span class="k">return</span> <span class="n">calcs</span>


<span class="k">def</span> <span class="nf">_check_statuses</span><span class="p">(</span><span class="n">calc_list</span><span class="p">):</span>

    <span class="n">keep_alive</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">chain_status</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">submission_check_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">calc_list_by_chain</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_sort_by_chain</span><span class="p">(</span><span class="n">calc_list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">calc_list_by_chain</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">calc_list_by_chain</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">completed</span><span class="o">=</span><span class="n">chain</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Complete&#39;</span><span class="p">]</span>
                <span class="n">error</span><span class="o">=</span><span class="n">chain</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">completed</span><span class="o">!=</span><span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">error</span><span class="o">!=</span><span class="s1">&#39;None&#39;</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">keep_alive</span><span class="o">=</span><span class="kc">True</span>
                        <span class="n">dir_name</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
                        <span class="n">check_submit_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.submit&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
                        <span class="n">submission_check_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_submit_file</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">dir_name</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
                <span class="n">check_submit_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.submit&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">submission_check_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_submit_file</span><span class="p">)</span>
                <span class="n">keep_alive</span><span class="o">=</span><span class="kc">True</span>

    <span class="sd">&#39;&#39;&#39;check the calc_list log again just in case it got updated while the daemon was sleeping&#39;&#39;&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">calc_list_new</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_load_submit_log</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">calc_list_new</span><span class="o">!=</span><span class="n">calc_list</span><span class="p">:</span>
        <span class="n">keep_alive</span><span class="o">=</span><span class="kc">True</span>

    <span class="k">if</span> <span class="n">keep_alive</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All calculations in set are finished. Stopping daemon&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;All calculations in set are finished. Stopping daemon&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">submission_check_list</span>


<span class="k">def</span> <span class="nf">_sort_by_chain</span><span class="p">(</span><span class="n">calc_list</span><span class="p">):</span>
    <span class="n">by_chain</span><span class="o">=</span><span class="p">{}</span>

    <span class="k">for</span> <span class="n">calc_set</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calc_set</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>        
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_01&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">by_chain</span><span class="p">[</span><span class="n">prefix</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">by_chain</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">by_chain</span><span class="p">[</span><span class="n">prefix</span><span class="p">][</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span>

    <span class="k">return</span> <span class="n">by_chain</span>

<span class="kn">import</span> <span class="nn">AFLOWpi</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="k">def</span> <span class="nf">_one_phon</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/FD_PHONON&#39;</span><span class="o">+</span><span class="s1">&#39;/displaced*.in&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_phonon_band_path</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nk</span><span class="o">=</span><span class="mi">400</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets path for the cell between High Symmetry points in Brillouin Zone</span>
<span class="sd">    and returns for to be part of matdyn.x input for the phonon dispersion</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          path (str): Path between High Symmetry points in Brillouin Zone</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dk</span><span class="o">=</span><span class="mf">0.0001</span>
    <span class="n">nk</span><span class="o">=</span><span class="mi">10000</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;scale the k points in the path list so they&#39;re as close to nk as possible&#39;&#39;&#39;</span>
<span class="c1">#    splitPath =  [[x.split()[3],int(x.split()[-1])] for x in  path.split(&#39;\n&#39;)[1:] if len(x)!=0]</span>
    <span class="n">total</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">entries</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">total</span><span class="p">)):</span>
	    <span class="k">if</span> <span class="n">total</span><span class="p">[</span><span class="n">entries</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
		    <span class="n">total</span><span class="p">[</span><span class="n">entries</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">total</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="n">scaleFactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

    <span class="n">dk_prime</span> <span class="o">=</span> <span class="n">dk</span><span class="o">/</span><span class="n">scaleFactor</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="n">dk_prime</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">_pull_forces</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs at the end of the scf calculations for the Finite Difference phonon</span>
<span class="sd">    calculations. It uses regex to pull the forces to be saved to files for</span>
<span class="sd">    parsing by fd_ifc.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">         None</span>

<span class="sd">    Returns:</span>
<span class="sd">         None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
        <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    

    <span class="n">force_regex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;Forces acting on atoms.*\n\n((?:.*force\s*=\s*[-0-9.]+\s*[-0-9.]+\s*[-0-9.]+\s*)+\n)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">force_block</span><span class="o">=</span><span class="n">force_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out_string</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">force_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">force_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">force_out_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">force_split</span><span class="p">:</span>
        <span class="n">force_out_string</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%22.18s%22.18s%22.18s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],)</span>

    <span class="n">force_postfix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">force_postfix</span><span class="o">=</span><span class="n">force_postfix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]),</span><span class="s1">&#39;force.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">force_postfix</span><span class="p">),</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_obj</span><span class="p">:</span>
        <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">force_out_string</span><span class="p">)</span>




<span class="k">def</span> <span class="nf">_pp_phonon</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">LOTO</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">raman</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">field_strength</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">project_phDOS</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the executables for the post processing of the force</span>
<span class="sd">    data generated by the scf calculations created by fd.x</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

        

    <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
	    <span class="n">execPrefix</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="s2">&quot;exec_prefix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            
    <span class="c1">#run fd_ifc</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fd_ifc&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./fd_ifc.x&#39;</span> <span class="p">)</span> 

    <span class="c1"># get ifc file for matdyn</span>
    <span class="n">header_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;FD_PHONON&#39;</span><span class="p">,</span><span class="s1">&#39;header.txt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">header_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">header_fileobj</span><span class="p">:</span>
        <span class="n">header_string</span><span class="o">=</span><span class="n">header_fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        


    <span class="k">if</span> <span class="n">raman</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">field_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;epol&#39;</span><span class="p">,</span><span class="s1">&#39;born&#39;</span><span class="p">,</span><span class="s1">&#39;raman&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">LOTO</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">field_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;epol&#39;</span><span class="p">,</span><span class="s1">&#39;born&#39;</span><span class="p">,]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field_list</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">epol_list</span><span class="o">=</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;./FD_PHONON/epol.*&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epol_list</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_gen_fd_input</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_type</span><span class="o">=</span><span class="n">field</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="n">field_strength</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">field</span><span class="p">),</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./fd_ef.x&#39;</span> <span class="p">)</span>


            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>            

<span class="c1">#######################################################################</span>
        <span class="k">if</span> <span class="n">raman</span><span class="o">==</span><span class="kc">True</span> <span class="ow">or</span> <span class="n">LOTO</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">epol_string</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_pull_eps_out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">born_charge_string</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_pull_born_out</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

            <span class="n">LOTO_REPLACE</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;T</span>

<span class="s1">    </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">    </span><span class="si">%s</span><span class="s1"></span>

<span class="s1">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epol_string</span><span class="p">,</span><span class="n">born_charge_string</span><span class="p">)</span>


            <span class="n">header_string</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;F</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">LOTO_REPLACE</span><span class="p">,</span><span class="n">header_string</span><span class="p">)</span>
<span class="c1">########################################################################</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="n">ifc_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_ifc.fc&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ifc_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifc_fileobj</span><span class="p">:</span>
        <span class="n">ifc_string</span><span class="o">=</span><span class="n">ifc_fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">for_matdyn</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.fc&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">for_matdyn</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mat_dyn_in_fileobj</span><span class="p">:</span>
        <span class="n">mat_dyn_in_fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_string</span><span class="p">)</span>
        <span class="n">mat_dyn_in_fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ifc_string</span><span class="p">)</span>


    <span class="c1">#run matdyn for bands</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_matdyn_phBand&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./matdyn.x&#39;</span> <span class="p">)</span>

    <span class="c1">#run matdyn for dos</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_matdyn_phDOS&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./matdyn.x&#39;</span> <span class="p">)</span>


    <span class="k">if</span> <span class="n">project_phDOS</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_project_phDOS</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span> 
            <span class="n">appdos_fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.eig.ap&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_sum_aproj_phDOS</span><span class="p">(</span><span class="n">appdos_fn</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
    	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="c1">#remove the fd.x output files in case we do another phonon calc</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="n">globpath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;FD_PHONON&#39;</span><span class="p">)</span>
	    <span class="n">phil</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">globpath</span><span class="o">+</span><span class="s1">&#39;/displaced*.in&#39;</span><span class="p">)</span>
	    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">phil</span><span class="p">:</span>
		    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<div class="viewcode-block" id="write_fdx_template"><a class="viewcode-back" href="../run.html#run.write_fdx_template">[docs]</a><span class="k">def</span> <span class="nf">write_fdx_template</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nrx1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">proj_phDOS</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates input files for fd.x, fd_ifc.x, and matdyn.x for the finite</span>
<span class="sd">    difference phonon calculations. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          nrx1 (int): supercell size for first primitive lattice vector</span>
<span class="sd">	  nrx2 (int): supercell size for second primitive lattice vector</span>
<span class="sd">	  nrx3 (int): supercell size for third primitive lattice vector</span>
<span class="sd">	  innx (int): how many differernt shifts in each direction for </span>
<span class="sd">                      finite difference phonon calculation</span>
<span class="sd">	  de (float): amount to shift the atoms for finite differences</span>

<span class="sd">    Returns:</span>
<span class="sd">          None          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">atom_sym</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">noatsym</span><span class="o">=</span><span class="s1">&#39;.false.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">noatsym</span><span class="o">=</span><span class="s1">&#39;.true.&#39;</span>
    <span class="k">if</span> <span class="n">disp_sym</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">nodispsym</span><span class="o">=</span><span class="s1">&#39;.false.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodispsym</span><span class="o">=</span><span class="s1">&#39;.true.&#39;</span>

    <span class="n">temp_dir</span><span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_get_tempdir</span><span class="p">()</span>

    <span class="n">fd_template</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;!fd_prefix     Prefix of the preceding pw.x run</span>
<span class="s1">!fd_outdir     Outdir of the preceding pw.x run</span>
<span class="s1">!fd_outfile    Prefix for the generated macrocell input files</span>
<span class="s1">!fd_outdir_dir Directory for the generated macrocell input files</span>
<span class="s1">!nrx1,2,3      Number of unitcell repetitions along the lattice vectors</span>
<span class="s1">!              (for the generation of the macrocell)</span>
<span class="s1">!de            Cartesian displacement for the atoms, in Angs.</span>
<span class="s1">!</span>
<span class="s1">&amp;inputfd</span>
<span class="s1"> fd_prefix      = &#39;</span><span class="si">%s</span><span class="s1">&#39; </span>
<span class="s1"> fd_outdir      = &#39;./&#39;</span>
<span class="s1"> fd_outfile     = &#39;displaced&#39;</span>
<span class="s1"> fd_outfile_dir = &#39;./FD_PHONON&#39;</span>
<span class="s1"> noatsym        = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1"> nodispsym      = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1"> nrx1           = </span><span class="si">%i</span><span class="s1"></span>
<span class="s1"> nrx2           = </span><span class="si">%i</span><span class="s1"></span>
<span class="s1"> nrx3           = </span><span class="si">%i</span><span class="s1"></span>
<span class="s1"> innx           = </span><span class="si">%i</span><span class="s1"></span>
<span class="s1"> de             = </span><span class="si">%f</span><span class="s1"></span>
<span class="s1">/</span>

<span class="s1">!The following namelist is for additional flexibility</span>
<span class="s1">!1. Each string (everything between a pair of single quotation marks)</span>
<span class="s1">!   will be pasted verbatim to the generated input files.</span>
<span class="s1">!   Within the corresponding namelist</span>
<span class="s1">!2. Mind not using single quotation marks within strings</span>
<span class="s1">!3. Mind keeping &quot;system2&quot; instead of &quot;system&quot;. Fortran conflict</span>
<span class="s1">!   within the corresponding</span>
<span class="s1">!4. Asterisks (*) inside the &quot;kpoints&quot; string represent change of line</span>
<span class="s1">!</span>
<span class="s1">&amp;verbatim</span>
<span class="s1"> control =</span>
<span class="s1">&#39;</span>
<span class="s1">&#39;</span>

<span class="s1"> electrons =</span>
<span class="s1">&#39;</span>
<span class="s1">&#39;</span>

<span class="s1"> system2 =</span>
<span class="s1">&#39;</span>
<span class="s1">&#39;</span>

<span class="s1"> kpoints =</span>
<span class="s1">&#39;</span>
<span class="s1">&#39;</span>
<span class="s1">/</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">],</span><span class="n">noatsym</span><span class="p">,</span><span class="n">nodispsym</span><span class="p">,</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="p">)</span>
    <span class="n">FD_in_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fd.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FD_in_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd_in_file</span><span class="p">:</span>
        <span class="n">fd_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd_template</span><span class="p">)</span>



    <span class="n">fd_ifc_template</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;&amp;input</span>
<span class="s1">      prefix=&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
<span class="s1">!      outdir=&#39;./&#39;</span>
<span class="s1">      nrx1=</span><span class="si">%i</span><span class="s1">,</span>
<span class="s1">      nrx2=</span><span class="si">%i</span><span class="s1">,</span>
<span class="s1">      nrx3=</span><span class="si">%i</span><span class="s1">,</span>
<span class="s1">      innx=</span><span class="si">%i</span><span class="s1">,</span>
<span class="s1">      de=</span><span class="si">%f</span><span class="s1">,</span>
<span class="s1">      file_force=&#39;./FD_PHONON/force&#39;,</span>
<span class="s1">      file_out=&#39;./</span><span class="si">%s</span><span class="s1">_ifc&#39;</span>
<span class="s1">      noatsym        = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">      nodispsym      = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">      verbose=.true.</span>
<span class="s1">      hex=.false.</span>
<span class="s1">    /</span>
<span class="s1">     &#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREFIX_&#39;</span><span class="p">],</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">noatsym</span><span class="p">,</span><span class="n">nodispsym</span><span class="p">)</span>

    <span class="n">FD_ifc_in_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fd_ifc.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FD_ifc_in_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd_ifc_in_file</span><span class="p">:</span>
        <span class="n">fd_ifc_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd_ifc_template</span><span class="p">)</span>




    <span class="n">inputDict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

    <span class="n">masses</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">species_string</span> <span class="o">=</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;ATOMIC_SPECIES&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
    
    <span class="n">split_species_string</span> <span class="o">=</span> <span class="n">species_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">split_species_string</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">amass_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masses</span><span class="p">)):</span>
        <span class="n">amass_str</span><span class="o">+=</span><span class="s1">&#39;   amass(</span><span class="si">%d</span><span class="s1">) = </span><span class="si">%f</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">masses</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>


    <span class="n">ph_band_path</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_phonon_band_path</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>



    <span class="n">matdyn_template</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"> &amp;input</span>
<span class="s1">   asr=&#39;crystal&#39;,</span>
<span class="si">%s</span><span class="s1"></span>
<span class="s1">   flvec=&#39;</span><span class="si">%s</span><span class="s1">.phBAND.modes&#39;</span>
<span class="s1">   flfrc=&#39;</span><span class="si">%s</span><span class="s1">.fc&#39;,</span>
<span class="s1">   flfrq=&#39;</span><span class="si">%s</span><span class="s1">.phBAND&#39;, </span>
<span class="s1">   fldyn=&#39;</span><span class="si">%s</span><span class="s1">.phBAND.dyn&#39;,</span>
<span class="s1">   fleig=&#39;</span><span class="si">%s</span><span class="s1">.phBAND.eig&#39;,</span>
<span class="s1">!   l1=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   l2=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   l3=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   nosym=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">   q_in_cryst_coord = .true. </span>
<span class="s1">   fd=.true.</span>
<span class="s1">   na_ifc=.true.</span>
<span class="s1">   q_in_band_form=.true.,</span>
<span class="s1">   eigen_similarity=.true.</span>

<span class="s1"> /</span>
<span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">amass_str</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">noatsym</span><span class="p">,</span><span class="n">ph_band_path</span><span class="p">)</span>
    <span class="n">matdyn_in_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_matdyn_phBand.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">matdyn_in_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">matdyn_in_file</span><span class="p">:</span>
        <span class="n">matdyn_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">matdyn_template</span><span class="p">)</span>


    <span class="n">kgrid</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">kpt_str</span>  <span class="o">=</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>    
    <span class="n">kpt_ints</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kpt_str</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kpt_ints</span><span class="p">)):</span>
        <span class="n">kgrid</span><span class="o">+=</span><span class="s1">&#39;   nk</span><span class="si">%d</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">kpt_ints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>


    <span class="c1">#don&#39;t use sym q point reduction if projecting so that all weights are the same</span>
    <span class="k">if</span> <span class="n">proj_phDOS</span><span class="p">:</span>
        <span class="n">for_proj_phDOS</span><span class="o">=</span><span class="s1">&#39;.TRUE.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">for_proj_phDOS</span><span class="o">=</span><span class="s1">&#39;.FALSE.&#39;</span>

    <span class="n">matdyn_dos_template</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"> &amp;input</span>
<span class="s1">   asr=&#39;crystal&#39;,</span>
<span class="si">%s</span><span class="s1"></span>
<span class="s1">   fd=.true.</span>
<span class="s1">   na_ifc=.true.</span>
<span class="s1">   fldos=&#39;</span><span class="si">%s</span><span class="s1">.phdos&#39;</span>
<span class="s1">   flfrc=&#39;</span><span class="si">%s</span><span class="s1">.fc&#39;,</span>
<span class="s1">   flfrq=&#39;</span><span class="si">%s</span><span class="s1">.phDOS&#39;, </span>
<span class="s1">   fleig=&#39;</span><span class="si">%s</span><span class="s1">.phDOS.eig&#39;</span>
<span class="s1">   fldyn=&#39;</span><span class="si">%s</span><span class="s1">.phDOS.dyn&#39;</span>
<span class="s1">   flvec=&#39;</span><span class="si">%s</span><span class="s1">.phDOS.modes&#39;</span>
<span class="s1">   nosym=</span><span class="si">%s</span><span class="s1"></span>
<span class="s1">!   l1=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   l2=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">!   l3=</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">   dos=.true.,</span>
<span class="s1">   eigen_similarity=.false.</span>
<span class="si">%s</span><span class="s1">   </span>
<span class="s1"> /</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">amass_str</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">for_proj_phDOS</span><span class="p">,</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,</span><span class="n">kgrid</span><span class="p">)</span>
    <span class="n">matdyn_in_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_matdyn_phDOS.in&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">matdyn_in_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">matdyn_in_file</span><span class="p">:</span>
        <span class="n">matdyn_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">matdyn_dos_template</span><span class="p">)</span></div>



<div class="viewcode-block" id="clean_cell_params"><a class="viewcode-back" href="../run.html#run.clean_cell_params">[docs]</a><span class="k">def</span> <span class="nf">clean_cell_params</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the atomic shifts in a supercell from fd.x</span>
<span class="sd">    outputted pw.x input files to correct for formatting</span>
<span class="sd">    issues when they are imported to AFLOWpi</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          output (str): pw.x input files generated by fd.x</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    Returns:</span>
<span class="sd">          output (str): pw.x input files generated by fd.x (cleaned by AFLOWpi)</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="n">output</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># signifies start of shifts in supercell</span>
        <span class="k">if</span> <span class="s1">&#39;CELL_PARAMETERS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">output</span><span class="o">+=</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># use same iterator so we don&#39;t have to store an index</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">output</span><span class="o">+=</span><span class="s1">&#39;CELL_PARAMETERS </span><span class="si">{angstrom}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>    
	    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
		    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.0001</span><span class="p">:</span>
			    <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
			    

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">output</span><span class="o">+=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>


    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="prep_fd"><a class="viewcode-back" href="../run.html#run.prep_fd">[docs]</a><span class="k">def</span> <span class="nf">prep_fd</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nrx1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">proj_phDOS</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates input files for fd.x, fd_ifc.x, and matdyn.x for the finite</span>
<span class="sd">    difference phonon calculations. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">          __submitNodeName__ (str): String of hostname that cluster jobs should be submitted from</span>
<span class="sd">          oneCalc (dict): dictionary of one of the calculations</span>
<span class="sd">          ID (str): ID of calculation</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          nrx1 (int): supercell size for first primitive lattice vector</span>
<span class="sd">	  nrx2 (int): supercell size for second primitive lattice vector</span>
<span class="sd">	  nrx3 (int): supercell size for third primitive lattice vector</span>
<span class="sd">	  innx (int): how many differernt shifts in each direction for </span>
<span class="sd">                      finite difference phonon calculation</span>
<span class="sd">	  de (float): amount to shift the atoms for finite differences</span>

<span class="sd">    Returns:</span>
<span class="sd">          None          </span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    if ID in oneCalc[&quot;prev&quot;]:</span>
<span class="c1">#        return</span>

    <span class="c1">#copy fd.x to the directories</span>
    <span class="n">engineDir</span>  <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s2">&quot;prep&quot;</span><span class="p">,</span><span class="s1">&#39;engine_dir&#39;</span><span class="p">)</span>
    <span class="c1"># make sure the .save directory is copied back from local scratch</span>
    <span class="c1"># if that option is being used</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ext_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.save&#39;</span><span class="p">])</span>
    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_from_local_scratch</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ext_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.occup&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">fd_exec</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fd.x&#39;</span><span class="p">,</span><span class="s1">&#39;fd_ifc.x&#39;</span><span class="p">,</span><span class="s1">&#39;fd_ef.x&#39;</span><span class="p">,</span><span class="s1">&#39;matdyn.x&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">_ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;copy_execs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">fd_exec</span><span class="p">),{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engineDir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">fd_exec</span><span class="p">),{</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">},</span><span class="n">symlink</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">write_fdx_template</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">nrx1</span><span class="o">=</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="o">=</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="o">=</span><span class="n">nrx3</span><span class="p">,</span><span class="n">innx</span><span class="o">=</span><span class="n">innx</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="n">de</span><span class="p">,</span><span class="n">atom_sym</span><span class="o">=</span><span class="n">atom_sym</span><span class="p">,</span><span class="n">disp_sym</span><span class="o">=</span><span class="n">disp_sym</span><span class="p">,</span><span class="n">proj_phDOS</span><span class="o">=</span><span class="n">proj_phDOS</span><span class="p">)</span>
    


    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_oneRun</span><span class="p">(</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_fd&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">,</span><span class="n">execPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">execPostfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;espresso&#39;</span><span class="p">,</span><span class="n">calcType</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span><span class="n">execPath</span><span class="o">=</span><span class="s1">&#39;./fd.x&#39;</span> <span class="p">)</span>    


    <span class="n">ocd</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>
    <span class="n">globpath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ocd</span><span class="p">,</span><span class="s1">&#39;FD_PHONON&#39;</span><span class="p">)</span>

    <span class="n">phil</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">globpath</span><span class="o">+</span><span class="s1">&#39;/displaced*.in&#39;</span><span class="p">)</span>



    <span class="n">infile</span><span class="o">=</span>    <span class="n">reduce_kpoints</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s2">&quot;_AFLOWPI_INPUT_&quot;</span><span class="p">],[</span><span class="n">nrx1</span><span class="p">,</span><span class="n">nrx2</span><span class="p">,</span><span class="n">nrx3</span><span class="p">,])</span>
    <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">kpoints</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span>

    <span class="n">KPS</span><span class="o">=</span><span class="s2">&quot;K_POINTS </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="n">kpoints</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">phil</span><span class="p">:</span>
        <span class="n">fdfo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">fdfos</span> <span class="o">=</span> <span class="n">fdfo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fdfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">NC</span><span class="o">=</span><span class="n">clean_cell_params</span><span class="p">(</span><span class="n">fdfos</span><span class="p">)</span>

        <span class="n">NC</span><span class="o">+=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">KPS</span>
        <span class="n">fdfo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fdfo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">NC</span><span class="p">)</span>
        <span class="n">fdfo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="reduce_kpoints"><a class="viewcode-back" href="../run.html#run.reduce_kpoints">[docs]</a><span class="k">def</span> <span class="nf">reduce_kpoints</span><span class="p">(</span><span class="n">inputfile</span><span class="p">,</span><span class="n">factor</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>    
                    <span class="n">splitInput</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">()&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mod</span><span class="o">==</span><span class="s1">&#39;GAMMA&#39;</span><span class="p">:</span>
                        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">splitInput</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_splitInput</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>
                        <span class="n">scfKPointString</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
			<span class="n">scfKPointSplit</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scfKPointString</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>


                            
                            

			<span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">):</span>
				<span class="n">scfKPointSplit</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">[</span><span class="n">kpoint</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">factor</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]))))</span>


                        <span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                        <span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                        <span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>

			<span class="n">newKPointString</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scfKPointSplit</span><span class="p">)</span>
                        <span class="n">new_mod</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{automatic}</span><span class="s1">&#39;</span>
                        <span class="k">if</span> <span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">scfKPointSplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;1&quot;</span><span class="p">:</span>
                            <span class="n">newKPointString</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                            <span class="n">new_mod</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{gamma}</span><span class="s2">&quot;</span>

                        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newKPointString</span>
                        <span class="n">splitInput</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__modifier__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_mod</span>
                        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_joinInput</span><span class="p">(</span><span class="n">splitInput</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">inputfile</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_project_phDOS</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="n">fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.phDOS.eig&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
        <span class="n">fs</span><span class="o">=</span><span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">q_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;q\s*=(.*)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">fs</span><span class="p">)]</span>
    <span class="n">num_q</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_list</span><span class="p">)</span>

    <span class="n">re_qp</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;freq.*=.*=\s*([-.0-9]+).*</span><span class="se">\n</span><span class="s2">((?:\s*\(\s*[-.0-9]+\s*[-.0-9]+\s*[-.0-9]+\s*[-.0-9]+\s*[-.0-9]+\s*[-.0-9]+\s*\)\s*</span><span class="se">\n</span><span class="s2">)+)&quot;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">qs</span><span class="o">=</span><span class="n">re_qp</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">by_eig</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
        <span class="n">eig</span><span class="o">=</span><span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">eig</span><span class="p">]</span>
        <span class="n">eig_val</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
    <span class="c1">#        x=numpy.complex(l[0],l[1])</span>
    <span class="c1">#        y=numpy.complex(l[2],l[3])</span>
    <span class="c1">#        z=numpy.complex(l[4],l[5])</span>
            <span class="n">x</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">2.0</span><span class="o">+</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">y</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mf">2.0</span><span class="o">+</span><span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">z</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mf">2.0</span><span class="o">+</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">eig_val</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
        <span class="n">by_eig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eig_val</span><span class="p">)</span>
    <span class="c1">#by_eig=numpy.array(by_eig)</span>
    <span class="c1">#num_q = by_eig.shape[0]</span>
    <span class="c1">#num_eig = (by_eig.shape[1]-1)/3</span>

    <span class="n">by_atom</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">by_eig</span><span class="p">)):</span>
        <span class="n">each_freq</span><span class="o">=</span><span class="p">[</span><span class="n">by_eig</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">by_eig</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
            <span class="n">each_freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">by_eig</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">by_eig</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">by_eig</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">by_atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_freq</span><span class="p">)</span>
    <span class="n">by_atom</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">by_atom</span><span class="p">)</span>
    <span class="n">eig_per_q</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">by_atom</span><span class="p">)</span><span class="o">/</span><span class="n">num_q</span>

    <span class="n">appdos_fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.eig.ap&quot;</span><span class="o">%</span><span class="n">ID</span><span class="p">)</span>


    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">appdos_fn</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
        <span class="n">labs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">_getPosLabels</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
        <span class="n">ip</span><span class="o">=</span><span class="s1">&#39;      q1          q2          q3            freq &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labs</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">by_atom</span><span class="p">)):</span>
            <span class="n">ip</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%32s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">q_list</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">eig_per_q</span><span class="p">]</span>

            <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%16.10f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">by_atom</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="n">ip</span><span class="o">+=</span><span class="n">j</span>
            <span class="n">ip</span><span class="o">+=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_sum_aproj_phDOS</span><span class="p">(</span><span class="n">appdos_fn</span><span class="p">,</span><span class="n">de</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>

    <span class="n">kpts</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">summed_weights</span><span class="p">,</span><span class="n">species</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_get_ph_weights</span><span class="p">(</span><span class="n">appdos_fn</span><span class="p">)</span>

    <span class="n">data_min</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">1.2</span>
    <span class="n">data_max</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">1.2</span>

    <span class="n">num_bins</span><span class="o">=</span><span class="p">(</span><span class="n">data_max</span><span class="o">-</span><span class="n">data_min</span><span class="p">)</span><span class="o">/</span><span class="n">de</span>
    <span class="n">new_bins</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span> <span class="n">data_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#do a new array for the bins with density,total,then a col for each species</span>
    <span class="n">dos_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">new_bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">total_phDOS</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">new_bins</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">dos_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_phDOS</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#    dos_data[:,1] = total_phDOS[0]</span>
    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">projected_phDOS</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">new_bins</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">summed_weights</span><span class="p">[:,</span><span class="n">spec</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dos_data</span><span class="p">[:,</span><span class="n">spec</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">projected_phDOS</span>
        <span class="n">dos_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">projected_phDOS</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">appdos_fn</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;aphdos&#39;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;freq&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">21</span><span class="p">))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Total&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">21</span><span class="p">))</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">species</span><span class="p">])</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dos_data</span><span class="p">:</span>
            <span class="n">to_write</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">tolist</span><span class="p">())])</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_write</span><span class="p">)</span>
<span class="c1">#        for col_of_spec in col:</span>
            
<span class="c1">#        weights[spec]=</span>



<span class="k">def</span> <span class="nf">_get_ph_weights</span><span class="p">(</span><span class="n">appdos_fn</span><span class="p">):</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">appdos_fn</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">at_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">:]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">kpts</span><span class="o">=</span><span class="n">data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:]</span>

    <span class="n">species</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">at_labels</span><span class="p">))</span>

    <span class="n">col_of_each_spec</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">species</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at_labels</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">==</span><span class="n">at_labels</span><span class="p">[</span><span class="n">ind</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">col_of_each_spec</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">col_of_each_spec</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>



    <span class="n">num_entries</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_spec</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
    <span class="n">summed_weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_entries</span><span class="p">,</span><span class="n">num_spec</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">summed_weights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">col_of_each_spec</span><span class="p">[</span><span class="n">species</span><span class="p">[</span><span class="n">spec</span><span class="p">]]</span>

        
        <span class="k">for</span> <span class="n">spec_col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>        
            
            <span class="n">summed_weights</span><span class="p">[:,</span><span class="n">spec</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">data</span><span class="p">[:,</span><span class="n">spec_col</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">kpts</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">summed_weights</span><span class="p">,</span><span class="n">species</span>

</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Andrew Supka.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>