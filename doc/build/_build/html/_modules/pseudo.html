<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pseudo &mdash; AFLOWpi  documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="AFLOWpi  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          AFLOWpi</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../plot.html">plot module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prep.html">prep module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pseudo.html">pseudo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../retr.html">retr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run.html">run module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scfuj.html">scfuj module</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for pseudo</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span> <span class="nn">AFLOWpi.prep</span> 
<span class="kn">import</span> <span class="nn">AFLOWpi.run</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="kn">as</span> <span class="nn">it</span>
<span class="kn">import</span> <span class="nn">copy</span> 
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">pylab</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ast</span>

<span class="k">def</span> <span class="nf">__passGlobalVar</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">varname</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>


<span class="c1">#def __shift_curoffs(oneCalc,ID):</span>
<span class="c1">#    return oneCalc,ID</span>

<div class="viewcode-block" id="brute_test"><a class="viewcode-back" href="../pseudo.html#pseudo.brute_test">[docs]</a><span class="k">def</span> <span class="nf">brute_test</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">ecutwfc</span><span class="p">,</span><span class="n">dual</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sampling</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">initial_variance</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">grid_density</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">conv_thresh</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;relax&#39;</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="c1">#set sampling and dual list from input if no variance provided</span>
        <span class="k">if</span> <span class="n">sampling</span><span class="o">==</span><span class="bp">None</span> <span class="ow">or</span> <span class="n">dual</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">in_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
            <span class="n">sampling</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">],</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">dual</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">dual_from_input</span><span class="o">=</span><span class="mi">4</span>
            <span class="n">wfc_cut</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">])</span> 
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rho_cut</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">])</span> 
                <span class="n">dual_from_input</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rho_cut</span><span class="o">/</span><span class="n">wfc_cut</span><span class="p">)</span>
                <span class="n">dual</span> <span class="o">=</span> <span class="p">[</span><span class="n">dual_from_input</span><span class="p">,</span> <span class="p">]</span>                
            <span class="k">except</span><span class="p">:</span>
                <span class="n">dual</span> <span class="o">=</span> <span class="p">[</span><span class="n">dual_from_input</span><span class="p">,</span> <span class="p">]</span>         


        <span class="c1">#list of the selected cutoff and sampling</span>
<span class="c1">#        oneCalc[&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;]=sorted(ecutwfc)</span>
<span class="c1">#        oneCalc[&#39;_AFLOWPI_PPTEST_SAMPLING_&#39;]=sorted(sampling)</span>
<span class="c1">#        oneCalc[&#39;_AFLOWPI_PPTEST_DUAL_&#39;]=sorted(dual)</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_PREV_&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>

        <span class="c1">#tracker for the sampling and cutoff</span>


        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;PREPROCESSING&#39;</span><span class="p">,</span><span class="s1">&#39;oneCalc,ID=AFLOWpi.pseudo.__set_cutoffs(oneCalc,ID,ecutwfc=</span><span class="si">%s</span><span class="s1">,dual=</span><span class="si">%s</span><span class="s1">,sampling=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ecutwfc</span><span class="p">,</span><span class="n">dual</span><span class="p">,</span><span class="n">sampling</span><span class="p">))</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s1">&#39;oneCalc,ID=AFLOWpi.pseudo.__check_test_conv(oneCalc,ID,</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">thresh</span><span class="p">)</span>

    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">pseudo</span><span class="o">.</span><span class="n">crawlingMinimization</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span><span class="n">initial_variance</span><span class="o">=</span><span class="n">initial_variance</span><span class="p">,</span><span class="n">grid_density</span><span class="o">=</span><span class="n">grid_density</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="n">mult_jobs</span><span class="p">,</span><span class="n">final_minimization</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">__set_cutoffs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ecutwfc</span><span class="o">=</span><span class="p">[],</span><span class="n">dual</span><span class="o">=</span><span class="p">[],</span><span class="n">sampling</span><span class="o">=</span><span class="p">[]):</span>
    <span class="k">if</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">int_samp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sampling</span><span class="p">])</span>
        <span class="n">sampling</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">int_samp</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">in_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">first_sampling</span> <span class="o">=</span> <span class="n">sampling</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">first_sampling</span><span class="o">=</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
        <span class="n">sampling</span><span class="o">=</span><span class="p">[</span><span class="n">first_sampling</span><span class="p">]</span>
    <span class="n">first_ecutwfc</span> <span class="o">=</span> <span class="n">ecutwfc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">first_dual</span> <span class="o">=</span> <span class="n">dual</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_rho</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">])</span>
            <span class="n">first_dual</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">first_rho</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">first_ecutwfc</span><span class="p">))</span>
            <span class="n">dual</span><span class="o">=</span><span class="p">[</span><span class="n">first_dual</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">first_dual</span><span class="o">=</span><span class="mi">4</span>
            <span class="n">dual</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>


    <span class="n">first_ecutrho</span><span class="o">=</span><span class="n">first_dual</span><span class="o">*</span><span class="n">first_ecutwfc</span>
    

    <span class="c1">#remove first entry in each list</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ecutwfc</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ecutwfc</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">int_samp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sampling</span><span class="p">])</span>
        <span class="n">sampling</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">int_samp</span><span class="p">]</span>        
        
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sampling</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="c1">#        int_samp = sorted([[map(int,i.split())]  for i in sampling])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dual</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dual</span><span class="p">)</span>
    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ecutwfc</span><span class="p">))]</span>
    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sampling</span><span class="p">))]</span>
    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dual</span><span class="p">))]</span>
    

    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">first_ecutwfc</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">first_ecutrho</span>
    <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">first_sampling</span>

    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">in_dict</span><span class="p">)</span>
    <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">,</span><span class="n">first_ecutwfc</span><span class="p">)</span>
    <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">,</span><span class="n">first_ecutrho</span><span class="p">)</span>
    <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">,</span><span class="s1">&#39;__content__&#39;</span><span class="p">,</span><span class="n">first_sampling</span><span class="p">)</span>    

    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

<span class="k">def</span> <span class="nf">__get_crawl_params</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>

    <span class="n">new_params</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="n">param_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_A_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_B_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_C_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_ALPHA_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_BETA_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_GAMMA_&#39;</span><span class="p">,]</span>
    <span class="n">param_dict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_list</span><span class="p">)):</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="n">param_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">new_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">param_dict</span>
<span class="c1">#    for k,v in sys_dict.iteritems():</span>
<span class="c1">#        print k, v</span>

<span class="k">def</span> <span class="nf">__record__thresh</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
        <span class="n">crawl_params</span><span class="o">=</span><span class="n">__get_crawl_params</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">pp_test_log_name</span> <span class="o">=</span> <span class="s1">&#39;_PSEUDO_TEST_LOG.log&#39;</span>


        <span class="n">in_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

        <span class="n">ecutwfc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">])</span>
        <span class="n">ecutrho</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">])</span>
        <span class="n">dual</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ecutrho</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ecutwfc</span><span class="p">))</span>
        <span class="n">sampling</span><span class="o">=</span> <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
        
        <span class="n">ibrav</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ibrav&#39;</span><span class="p">])</span>
        
        <span class="n">log_params</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">ibrav</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">log_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span><span class="n">crawl_params</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_A_&#39;</span><span class="p">]}</span>


        <span class="n">log_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">:</span><span class="n">dual</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_ECUTWFC_&#39;</span><span class="p">:</span><span class="n">ecutwfc</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_KPOINTS_&#39;</span><span class="p">:</span><span class="n">sampling</span><span class="p">})</span>



        <span class="n">subdir</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">pp_test_log_name</span><span class="p">))):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">pp_test_log_name</span><span class="p">)),</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uValLog</span><span class="p">:</span>
                <span class="n">uValLog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">log_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">pp_test_log_name</span><span class="p">)),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uValLog</span><span class="p">:</span>
                <span class="n">uValLog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">log_params</span><span class="p">)</span>        


<span class="k">def</span> <span class="nf">__go_plot</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">cutoff_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_PSEUDO_TEST_LOG.log&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conv_file_obj</span><span class="p">:</span>             
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">conv_file_obj</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>                                                         
                <span class="n">cutoff_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>





            <span class="k">if</span> <span class="n">plot</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Pseudoptential Testing for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getStoicName</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;PSEUDOTEST_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getStoicName</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="n">ID</span><span class="p">)</span>

                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">pseudo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cutoff_list</span><span class="p">,</span><span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;_AFLOWPI_ECUTWFC_&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="k">def</span> <span class="nf">__check_test_conv</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">thresh</span><span class="p">):</span>

<span class="c1">#    if oneCalc[]</span>
<span class="c1">#    oneCalc[&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;]</span>
    <span class="c1">#get new vals</span>


    


    <span class="n">crawl_params</span><span class="o">=</span><span class="n">__get_crawl_params</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
<span class="c1">#        print oneCalc[&#39;_AFLOWPI_PREV_PARAM_&#39;]</span>
<span class="c1">#        print </span>
<span class="c1">#        print crawl_params</span>


        <span class="n">in_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
        <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;relax&#39;&quot;</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">in_dict</span><span class="p">)</span>



        <span class="n">num_wfc_cut</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">])</span>
        <span class="n">num_dual_cut</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_&#39;</span><span class="p">])</span>
        <span class="n">num_sampling_cut</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">num_wfc_cut</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">limiter</span><span class="o">=</span><span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limiter</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">num_wfc_cut</span><span class="p">)</span>
        
        <span class="n">p_l</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_A_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_B_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_C_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_ALPHA_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_BETA_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_GAMMA_&#39;</span><span class="p">,]</span>
        <span class="n">conv</span><span class="o">=</span><span class="bp">True</span>


        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">p_l</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">limiter</span><span class="p">):</span>


                    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">-</span><span class="n">crawl_params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span><span class="o">&gt;</span><span class="n">thresh</span><span class="p">:</span>
                    
                        <span class="n">conv</span><span class="o">=</span><span class="bp">False</span>

                        <span class="k">try</span><span class="p">:</span>
                               <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crawl_params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                               <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">crawl_params</span><span class="p">[</span><span class="n">param</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crawl_params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">crawl_params</span><span class="p">[</span><span class="n">param</span><span class="p">]]</span>
                <span class="n">conv</span><span class="o">=</span><span class="bp">False</span>


<span class="c1">#       for param in p_l:</span>
<span class="c1">#           oneCalc[&#39;_AFLOWPI_PREV_PARAM_&#39;][param]=crawl_params[param]</span>
        
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__CRAWL_CHECK__&#39;</span><span class="p">]</span>    
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">pseudo</span><span class="o">.</span><span class="n">__record__thresh</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

        <span class="n">printout_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span> 
        <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;CONVERGED?: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">conv</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__colorize_message</span><span class="p">(</span><span class="n">printout_str</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">printout_str</span>




            



        <span class="k">if</span> <span class="n">conv</span><span class="o">==</span><span class="bp">True</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;</span><span class="p">]:</span>
            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">__go_plot</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">in_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pick</span><span class="o">=-</span><span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pick</span><span class="o">=-</span><span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nu_ecutwfc</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">][</span><span class="n">pick</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">nu_ecutwfc</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nu_ecutwfc</span> <span class="o">=</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">old_ecutwfc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">])</span>
            <span class="n">old_ecutrho</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">])</span>
            <span class="n">nu_dual</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">old_ecutrho</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">old_ecutwfc</span><span class="p">))</span>
            <span class="n">nu_sampling</span><span class="o">=</span> <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>
            <span class="n">nu_ecutrho</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">dual</span><span class="p">)</span><span class="o">*</span><span class="n">nu_ecutwfc</span>

            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">,</span><span class="n">nu_ecutwfc</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">,</span><span class="n">nu_ecutrho</span><span class="p">)</span>
            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">,</span><span class="s1">&#39;__content__&#39;</span><span class="p">,</span><span class="n">nu_sampling</span><span class="p">)</span>
            
            <span class="n">printout_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span> 
            <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;Converged Parameters for </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getStoicName</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;ECUTWFC: : </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nu_ecutwfc</span>
            <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;DUAL     : </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nu_dual</span>
            <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;SAMPLING : </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nu_sampling</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__colorize_message</span><span class="p">(</span><span class="n">printout_str</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">printout_str</span>
            <span class="k">print</span> 
            

            <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

        <span class="k">elif</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">conv</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pseudotesting convergence not achieved. Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#if converged but dual and sampling to check still shift those and keep ecutwfc the same</span>
            
            <span class="k">if</span> <span class="n">conv</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;</span><span class="p">]:</span>
                    <span class="n">shift_type</span><span class="o">=</span><span class="s1">&#39;dual&#39;</span>
                
                <span class="k">elif</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;</span><span class="p">]:</span>
                    <span class="n">shift_type</span><span class="o">=</span><span class="s1">&#39;sampling&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;this should not happen&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shift_type</span><span class="o">=</span><span class="s1">&#39;ecutwfc&#39;</span>

            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">pseudo</span><span class="o">.</span><span class="n">__shift_cutoffs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">shift_type</span><span class="o">=</span><span class="n">shift_type</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__CRAWL_CHECK__&#39;</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__gridMin_iteration__&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>

        <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>

<span class="k">def</span> <span class="nf">__shift_cutoffs</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">shift_type</span><span class="o">=</span><span class="s1">&#39;wfc&#39;</span><span class="p">):</span>
    <span class="k">print</span> 

    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_SHIFT_TYPE&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">shift_type</span>
    

    <span class="n">printout_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">shift_type</span><span class="o">==</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">])):</span>

                <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">new_ecutwfc</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_ecutwfc</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">]</span>

            <span class="n">ecutw</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">]</span>
            <span class="n">ecutr</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">]</span>
            
            <span class="n">dual</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ecutr</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ecutw</span><span class="p">)</span>

            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">,</span><span class="n">new_ecutwfc</span><span class="p">)</span>    
            <span class="n">new_ecutr</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">new_ecutwfc</span><span class="o">*</span><span class="n">dual</span><span class="p">)</span>

            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">,</span><span class="n">new_ecutr</span><span class="p">)</span>    
            <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;Shifting wavefunction energy cutoff</span><span class="se">\n</span><span class="s1">&#39;</span>
            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
    <span class="k">if</span> <span class="n">shift_type</span><span class="o">==</span><span class="s1">&#39;dual&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">]]</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;</span><span class="p">])):</span>

                <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">new_dual</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_DUAL_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">INDEX</span><span class="o">=</span><span class="n">i</span>
                    <span class="k">break</span>

<span class="c1">#            oneCalc[&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;]=[x for x in reversed(oneCalc[&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;][:INDEX+1])]</span>

            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">]]</span>
            <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">del</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">]</span>

            <span class="n">new_ecutwfc</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">,</span><span class="n">new_ecutwfc</span><span class="p">)</span>    
<span class="c1">#            new_ecutr=int(new_ecutwfc*dual)</span>
            <span class="n">new_ecutrho</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">new_ecutwfc</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">new_dual</span><span class="p">))</span>


            <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">,</span><span class="n">new_ecutrho</span><span class="p">)</span>

            <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;Shifting dual</span><span class="se">\n</span><span class="s1">&#39;</span>


            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>

            <span class="k">print</span> <span class="n">e</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
            <span class="k">pass</span> 
    <span class="k">if</span> <span class="n">shift_type</span><span class="o">==</span><span class="s1">&#39;sampling&#39;</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;</span><span class="p">])):</span>

                <span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">new_sampling</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_SAMPLING_&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">INDEX</span><span class="o">=</span><span class="n">i</span>
                    <span class="k">break</span>
                <span class="c1">#else:</span>
                <span class="c1">#    return oneCalc,ID</span>
                <span class="c1">#    new_sampling=AFLOWpi.retr.__splitInput(oneCalc[&#39;_AFLOWPI_INPUT_&#39;])[&#39;K_POINTS&#39;][&#39;__content__&#39;]</span>
        <span class="k">except</span><span class="p">:</span>

            <span class="k">print</span> <span class="n">e</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
        


<span class="c1">#        oneCalc[&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;]=[x for x in reversed(oneCalc[&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;][:INDEX+1])]</span>
        
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">]]</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        
        <span class="k">del</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">]</span>
        
        <span class="n">ecutwfc</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PPTEST_ECUTWFC_&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">,</span><span class="s1">&#39;__content__&#39;</span><span class="p">,</span><span class="n">new_sampling</span><span class="p">)</span>    
        <span class="n">ecutw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">])</span>
        <span class="n">ecutr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">])</span>
        <span class="n">dual</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ecutr</span><span class="o">/</span><span class="n">ecutw</span><span class="p">)</span>
        <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;Shifting sampling</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">,</span><span class="n">ecutwfc</span><span class="p">)</span>    
        <span class="n">new_ecutrho</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ecutwfc</span><span class="o">*</span><span class="n">dual</span><span class="p">)</span>
        <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PREV_PARAM_&#39;</span><span class="p">]</span>
        <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__modifyNamelistPW</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">,</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">,</span><span class="n">new_ecutrho</span><span class="p">)</span>    

    

<span class="c1">#    try:</span>
<span class="c1">#        new_sampling=oneCalc[&#39;_AFLOWPI_PPTEST_SAMPLING_&#39;].pop(0)</span>
<span class="c1">#    except:</span>
<span class="c1">#        pass</span>
<span class="c1">#    try:</span>
<span class="c1">#        new_dual=oneCalc[&#39;_AFLOWPI_PPTEST_DUAL_&#39;].pop(0)</span>
<span class="c1">#    except:</span>
<span class="c1">#        pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">in_dict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>

        <span class="n">nu_ecutwfc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutwfc&#39;</span><span class="p">])</span>
        <span class="n">nu_ecutrho</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ecutrho&#39;</span><span class="p">])</span>
        <span class="n">nu_dual</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nu_ecutrho</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nu_ecutwfc</span><span class="p">))</span>
        <span class="n">nu_sampling</span><span class="o">=</span> <span class="n">in_dict</span><span class="p">[</span><span class="s1">&#39;K_POINTS&#39;</span><span class="p">][</span><span class="s1">&#39;__content__&#39;</span><span class="p">]</span>


        <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;New testing Parameters for </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__getStoicName</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;ECUTWFC: : </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nu_ecutwfc</span>
        <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;DUAL     : </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nu_dual</span>
        <span class="n">printout_str</span><span class="o">+=</span><span class="s1">&#39;SAMPLING : </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nu_sampling</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__colorize_message</span><span class="p">(</span><span class="n">printout_str</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span><span class="n">show_level</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">printout_str</span>


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
    
    <span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>
    <span class="c1">#tracker for the sampling and cutoff</span>
<span class="c1">#    oneCalc[&#39;_AFLOWPI_PPTEST_ECUTWFC_TRACKER_&#39;][]</span>
<span class="c1">#    oneCalc[&#39;_AFLOWPI_PPTEST_SAMPLING_TRACKER_&#39;][]</span>
<span class="c1">#    oneCalc[&#39;_AFLOWPI_PPTEST_DUAL_TRACKER_&#39;][]</span>
    


<span class="c1"># def scfs(aflowkeys,allAFLOWpiVars, reffile,dual=None,pseudodir=None,build=True):</span>

<span class="c1"># 	&#39;&#39;&#39;</span>
<span class="c1"># 	Wrapper function for scfs calculations that calls __scfsWrapped for the different dual values (the scaling of the ecutrho)</span>

<span class="c1"># 	Arguments:</span>
<span class="c1"># 	 - allAFLOWpiVars -- all the variables that you want to make a list of combinations of calculations from</span>
<span class="c1"># 	 - reffile    -- string that contains the input ref file file path</span>
	
<span class="c1"># 	Keyword Arguments:</span>
<span class="c1"># 	 - pseudodir  -- path of the directory that contains your Pseudopotential files</span>
<span class="c1"># 	 - dual       -- list of scaling of rho cutoff to wavefunction cutoff values</span>
<span class="c1"># 	&#39;&#39;&#39;</span>
<span class="c1"># 	allCalcs=OrderedDict()</span>
<span class="c1"># 	slimmedAFLOWpiVars=copy.deepcopy(allAFLOWpiVars)</span>
<span class="c1"># 	split=[]</span>
<span class="c1"># 	aflowkeysSlimmed=[]</span>
<span class="c1"># 	config=AFLOWpi.prep.__getConfigFile()</span>
<span class="c1"># 	workdir = AFLOWpi.prep.__ConfigSectionMap(&#39;prep&#39;,&#39;workdir&#39;)					</span>

<span class="c1"># 	if dual!=None:</span>
<span class="c1"># 		for rs in range(len(dual)): #run __scfWrapped for all of the values in dual</span>
<span class="c1"># 			for kpoint in range(len(allAFLOWpiVars[&#39;_AFLOWPI_KPOINTS_&#39;])):</span>
<span class="c1"># 				slimmedAFLOWpiVars[&#39;_AFLOWPI_KPOINTS_&#39;]=(allAFLOWpiVars[&#39;_AFLOWPI_KPOINTS_&#39;][kpoint],)</span>
<span class="c1"># 				for entry in range(len(allAFLOWpiVars[&#39;_AFLOWPI_ECUTW_&#39;])):</span>
<span class="c1"># 					aflowkeysSlimmed=aflowkeys</span>
<span class="c1"># 					slimmedAFLOWpiVars[&#39;_AFLOWPI_ECUTW_&#39;]=(allAFLOWpiVars[&#39;_AFLOWPI_ECUTW_&#39;][entry],)</span>
<span class="c1"># 					slimmedAFLOWpiVars[&#39;_AFLOWPI_ECUTR_&#39;]=(str(int(slimmedAFLOWpiVars[&#39;_AFLOWPI_ECUTW_&#39;][0])*dual[rs]),)</span>

<span class="c1"># 					KPOINTS = slimmedAFLOWpiVars[&#39;_AFLOWPI_KPOINTS_&#39;][0]</span>
<span class="c1"># 					WFCCUT = str(slimmedAFLOWpiVars[&#39;_AFLOWPI_ECUTW_&#39;][0])</span>
<span class="c1"># 					DUAL = str(dual[rs])</span>
<span class="c1"># 					try:</span>
<span class="c1"># 						splitK = KPOINTS.split()</span>
<span class="c1"># 					except Exception,e:</span>
<span class="c1"># 						pass</span>
<span class="c1"># 					try:</span>
<span class="c1"># 						joinedK = &#39;&#39;.join(splitK[:3])</span>
<span class="c1"># 					except Exception,e:</span>
<span class="c1"># 						joinedK = &#39;&#39;.join(splitK)</span>

							
						
<span class="c1"># 					folderAddition = &#39;K%sD%sW%s&#39; % (joinedK,DUAL,WFCCUT)</span>

<span class="c1"># 					calcs = OrderedDict(AFLOWpi.prep.scfs(aflowkeys,slimmedAFLOWpiVars, reffile,pseudodir=pseudodir,build=False))</span>

<span class="c1"># 					for ID,oneCalc in calcs.iteritems():</span>
<span class="c1"># 						ar = &#39;_AFLOWPI_DUAL_&#39; </span>
<span class="c1"># 						vr = dual[rs]</span>
<span class="c1"># 						oneCalc[ar]=vr</span>
<span class="c1"># 						baseDir=os.path.dirname(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;])</span>
<span class="c1"># 						&quot;&quot;&quot;create the extra folders to separate the KPoints+dual/WFCCUT combos&quot;&quot;&quot;</span>

<span class="c1"># 						folderAdditionWithIndex =  &#39;%s_%s&#39; % (folderAddition,oneCalc[&#39;_AFLOWPI_INDEX_&#39;])</span>
<span class="c1"># 						if not os.path.exists(os.path.join(baseDir,folderAdditionWithIndex)):</span>
<span class="c1"># 							os.mkdir(os.path.join(baseDir,folderAdditionWithIndex))</span>

<span class="c1"># 						&quot;&quot;&quot;put it all together and set _AFLOWPI_FOLDER_ to that new path&quot;&quot;&quot;</span>
<span class="c1"># 						based = os.path.basename(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;])</span>
<span class="c1"># 						newAFLOWpiDir = os.path.join(baseDir,folderAdditionWithIndex)</span>
<span class="c1"># 						oneCalc[&#39;_AFLOWPI_FOLDER_&#39;]=newAFLOWpiDir</span>
<span class="c1">#                                                 try:</span>
<span class="c1">#                                                     oneCalc[&#39;__qsubFileName__&#39;]=os.path.join(newAFLOWpiDir,&quot;_%s.qsub&quot;%ID)                                  </span>
<span class="c1">#                                                 except:</span>
<span class="c1">#                                                     pass</span>



<span class="c1"># 					allCalcs=OrderedDict(allCalcs.items()+calcs.items())</span>
					


<span class="c1"># 	if build==True:</span>
<span class="c1"># 		AFLOWpi.prep.maketree(allCalcs)</span>



<span class="c1"># 	return allCalcs</span>



<span class="k">def</span> <span class="nf">__getCutOffs</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Looks through a random &#39;sample&#39; calculations in the dictionary of dictionaries of calculations</span>
<span class="sd">    to see which cutoff variables are defined in the set of calculations and returns a list of</span>
<span class="sd">    those cutoffs</span>

<span class="sd">    Arguments:</span>
<span class="sd">     - calcs -- Dictionary of dictionaries of calculations</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sampleDict</span> <span class="o">=</span> <span class="n">calcs</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">calcs</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
    <span class="n">key</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="k">if</span> <span class="s1">&#39;_AFLOWPI_KPOINTS_&#39;</span> <span class="ow">in</span> <span class="n">sampleDict</span><span class="p">:</span>
		<span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_KPOINTS_&#39;</span><span class="p">)</span>
	    <span class="k">if</span> <span class="s1">&#39;_AFLOWPI_ECUTR_&#39;</span>  <span class="ow">in</span> <span class="n">sampleDict</span><span class="p">:</span> 
		<span class="k">if</span> <span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sampleDict</span><span class="p">:</span>
			<span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_ECUTR_&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">)</span>
	    <span class="k">if</span> <span class="s1">&#39;_AFLOWPI_ECUTW_&#39;</span> <span class="ow">in</span> <span class="n">sampleDict</span><span class="p">:</span>
		<span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_ECUTW_&#39;</span><span class="p">)</span>

	    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
		    <span class="k">return</span> <span class="p">[]</span>
	    <span class="k">return</span> <span class="n">key</span>
    <span class="k">except</span><span class="p">:</span>
	    <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">__splitCalcs</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">splitVars</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	splits a set of calculations by keyword and its respective values and</span>
<span class="sd">	returns the split set of calculations as a list of the split set.</span>

<span class="sd">	Arguments:</span>
<span class="sd">	      calcs (dict): dictionary of dictionary of calculations that is to be split</span>

<span class="sd">	Keyword Arguments:</span>
<span class="sd">	      splitVars (list): a list or tuple of strings of AFLOWpi variable(s) in the</span>
<span class="sd">                                set of calculations that you want to split the set on</span>

<span class="sd">        Returns:</span>
<span class="sd">              splitCalcList (list): a list of dictionaries of dictionaries</span>

<span class="sd">	&#39;&#39;&#39;</span>

	<span class="k">if</span> <span class="n">splitVars</span><span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitVars</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">splitVars</span><span class="o">==</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
		<span class="k">return</span> <span class="p">[</span><span class="n">calcs</span><span class="p">]</span>

	<span class="n">key</span><span class="o">=</span><span class="p">[]</span>
	<span class="n">value</span><span class="o">=</span><span class="p">[]</span>
	<span class="n">calcsCopy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
	<span class="n">sampleDict</span> <span class="o">=</span> <span class="n">calcsCopy</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">calcsCopy</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>   
	<span class="k">if</span> <span class="n">sampleDict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">splitVars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_ECUTR_&#39;</span><span class="p">)</span>
			<span class="n">splitVars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="k">pass</span>

	<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">splitVars</span><span class="p">:</span>
	    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">sampleDict</span><span class="p">:</span>
		<span class="n">inAllCalcs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcsCopy</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> <span class="c1">#cycles through all the calculations</span>
		    <span class="n">inAllCalcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="c1">#makes a list of all the values for all your calcs</span>
		<span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

		<span class="n">listCalcs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inAllCalcs</span><span class="p">))</span>

		<span class="n">sortedListCalcs</span><span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">listCalcs</span><span class="p">)</span>
		<span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sortedListCalcs</span><span class="p">))</span> <span class="c1">#a list tuples containing the unique values of the variables you are splitting on in your calcs </span>


	<span class="n">keyTuple</span>   <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
	<span class="n">valueTuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="n">cutoffTuple</span> <span class="o">=</span>  <span class="nb">tuple</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">valueTuple</span><span class="p">))</span>
	<span class="n">constrList</span><span class="o">=</span><span class="p">[]</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cutoffTuple</span><span class="p">:</span>
	    <span class="n">constraintDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
	    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">keyTuple</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="n">constraintDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
	    <span class="n">constrList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraintDict</span><span class="p">)</span>

	<span class="n">splitCalcList</span><span class="o">=</span><span class="p">[]</span>
	<span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constrList</span><span class="p">:</span>
	    <span class="n">splitOn</span> <span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>

	    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcsCopy</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">constraint</span> <span class="k">if</span> <span class="n">constraint</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">oneCalc</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraint</span><span class="p">):</span> <span class="c1">#fancy way of looping &#39;if&#39; statements</span>
		    <span class="n">splitOn</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ID</span><span class="p">:</span><span class="n">oneCalc</span><span class="p">})</span>

	    <span class="n">splitOnCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">splitOn</span><span class="p">)</span>
	    <span class="n">splitCalcList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitOnCopy</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">splitCalcList</span>

	    

<span class="k">def</span> <span class="nf">__grabEnergyOut</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &lt;CONSIDER MOVING TO retr.py&gt;</span>
<span class="sd">    Goes in every subdirectory of the calculation and searches for the final energy of the calculation</span>
<span class="sd">    and returns a new copy of the input dictionary that includes the final energy.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of Dictionaries of the calculations.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          None</span>

<span class="sd">    MASTER_ENERGY (dict): Dictionary for the calc set with the energy added to each calc in the set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">MASTER_ENERGY</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
    <span class="n">energyRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(?:(?:(?:(?:\!\s+)total)|(?:Final)) en\w+\s*=\s+(.+?)Ry)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
<span class="c1">#		print os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;%s.out&#39; % ID)</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)):</span>
		    <span class="k">with</span> <span class="nb">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFile</span><span class="p">:</span>
			<span class="n">outFileString</span><span class="o">=</span><span class="n">outFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="c1">#searches for either total energy or final energy in the scf output and adds it to the output dictionary</span>
			<span class="n">finalEnergy</span><span class="o">=</span><span class="n">energyRegex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">outFileString</span><span class="p">)</span>

			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalEnergy</span><span class="p">):</span>
			    <span class="n">energyFloat</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">finalEnergy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

			    <span class="n">MASTER_ENERGY</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;Energy&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">energyFloat</span>
			<span class="k">else</span><span class="p">:</span> <span class="c1">#if the energy can not be found the test entry is deleted from the output dictionary</span>
			    <span class="n">outCalcPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
			    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;could not get energy. check output file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outCalcPath</span><span class="p">)</span>
			    <span class="k">print</span> <span class="s1">&#39;could not get energy. check output file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outCalcPath</span>
                            <span class="n">MASTER_ENERGY</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;Energy&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                            <span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;Energy&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
<span class="c1">#			    del MASTER_ENERGY[ID] </span>
<span class="c1">#			    del calcs[ID]</span>
		<span class="k">else</span><span class="p">:</span>
                    <span class="n">MASTER_ENERGY</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;Energy&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
<span class="c1">#		    del MASTER_ENERGY[ID]            </span>
	<span class="k">except</span><span class="p">:</span>
		<span class="n">outCalcPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.out&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;could not get energy. check output file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outCalcPath</span><span class="p">)</span>
		<span class="k">print</span> <span class="s1">&#39;could not get energy. check output file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outCalcPath</span>
    <span class="k">return</span> <span class="n">MASTER_ENERGY</span>





<span class="c1">#########################################################################################################</span>
<span class="k">try</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">scipy</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">differential_evolution</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="o">*</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="k">pass</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ones</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">zeros</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">triu_indices</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">diag_indices</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">dot</span>
<span class="c1">#########################################################################################################</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">griddata</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">map_coordinates</span><span class="p">,</span><span class="n">spline_filter</span>
<span class="k">def</span> <span class="nf">__cubicInterpolation</span><span class="p">(</span><span class="n">variable_array</span><span class="p">,</span><span class="n">solution_array</span><span class="p">):</span>

	<span class="sd">&#39;&#39;&#39;try to convert a numpy array into a list if</span>
<span class="sd">	this fails assume that the inputs are lists&#39;&#39;&#39;</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">variable_array</span><span class="o">=</span><span class="n">variable_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="n">solution_array</span><span class="o">=</span><span class="n">solution_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not convert variable_array or solution_array into a list in AFLOWpi.pseudo.__cubicInterpolation. Possibly they are already lists?&#39;</span><span class="p">)</span>

	<span class="sd">&#39;&#39;&#39;make a unique sorted list for our grid from the data points&#39;&#39;&#39;</span>
	<span class="n">sortedVariableArray</span><span class="o">=</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variable_array</span><span class="p">]</span>
	<span class="n">insidePad</span><span class="o">=</span><span class="p">[]</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	for every entry in the range of a variable </span>
<span class="sd">	(excluding the end and beginning of the range)</span>
<span class="sd">	insert a value in between them that&#39;s the average of the two.)</span>
<span class="sd">	&#39;&#39;&#39;</span>
	<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sortedVariableArray</span><span class="p">)):</span>
		<span class="n">tempPad</span><span class="o">=</span><span class="p">[]</span>
		<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sortedVariableArray</span><span class="p">[</span><span class="n">var</span><span class="p">])):</span>
			<span class="n">even</span> <span class="o">=</span> <span class="n">sortedVariableArray</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>			
			<span class="k">try</span><span class="p">:</span>
				<span class="n">odd</span><span class="o">=</span><span class="p">(</span><span class="n">sortedVariableArray</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">sortedVariableArray</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>
				<span class="n">tempPad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">even</span><span class="p">)</span>
				<span class="n">tempPad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">odd</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">tempPad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">even</span><span class="p">)</span>
		
		<span class="n">insidePad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tempPad</span><span class="p">))</span>
	<span class="sd">&#39;&#39;&#39;cartesian product to recreate our new M*(M[N]*2-1) long list&#39;&#39;&#39;</span>
	<span class="n">variableListPadded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">insidePad</span><span class="p">))</span>
	<span class="n">paddedGrid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">insidePad</span><span class="p">))</span>
	<span class="n">mapCoordVars</span><span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">paddedGrid</span><span class="p">)</span>
 	<span class="n">paddedGrid</span> <span class="o">=</span>  <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">paddedGrid</span><span class="p">)</span>
	<span class="n">variable_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">variable_array</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
	<span class="sd">&#39;&#39;&#39;mask bad energy values from the calculations&#39;&#39;&#39;</span>
	<span class="n">energyMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">solution_array</span><span class="p">)</span>	
	<span class="n">energyMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">energyMatrix</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>

<span class="c1">#	reshapeDataParam=numpy.array([len(x) for x in sortedVariableArray])</span>
<span class="c1">#	reshapeDataParam2=numpy.array([len(x)*2-1 for x in sortedVariableArray])</span>
<span class="c1">#	energyMatrixReshape=numpy.reshape(energyMatrix,reshapeDataParam)</span>
<span class="c1">#	numpy.set_printoptions(linewidth=250)</span>
	
	<span class="n">grid_z0</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">variable_array</span><span class="p">,</span> <span class="n">energyMatrix</span><span class="p">,</span><span class="n">paddedGrid</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        
	<span class="k">return</span> <span class="n">paddedGrid</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">grid_z0</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


<span class="kn">import</span> <span class="nn">scipy</span>
<span class="k">def</span> <span class="nf">__cubicInterpolation_onePoint</span><span class="p">(</span><span class="n">point</span><span class="p">,</span><span class="n">variable_array</span><span class="p">,</span><span class="n">solution_array</span><span class="p">):</span>

	<span class="sd">&#39;&#39;&#39;try to convert a numpy array into a list if</span>
<span class="sd">	this fails assume that the inputs are lists&#39;&#39;&#39;</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">variable_array</span><span class="o">=</span><span class="n">variable_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="n">solution_array</span><span class="o">=</span><span class="n">solution_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not convert variable_array or solution_array into a list in AFLOWpi.pseudo.__cubicInterpolation. Possibly they are already lists?&#39;</span><span class="p">)</span>

	<span class="sd">&#39;&#39;&#39;make a unique sorted list for our grid from the data points&#39;&#39;&#39;</span>
	<span class="n">sortedVariableArray</span><span class="o">=</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variable_array</span><span class="p">]</span>
        <span class="n">insidePad</span><span class="o">=</span><span class="p">[]</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	for every entry in the range of a variable </span>
<span class="sd">	(excluding the end and beginning of the range)</span>
<span class="sd">	insert a value in between them that&#39;s the average of the two.)</span>
<span class="sd">	&#39;&#39;&#39;</span>

	<span class="sd">&#39;&#39;&#39;cartesian product to recreate our new M*(M[N]*2-1) long list&#39;&#39;&#39;</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">energyMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">solution_array</span><span class="p">)</span>	
		<span class="n">energyMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">energyMatrix</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>



		<span class="sd">&#39;&#39;&#39;round all the values of the variable_array to account for precision errors&#39;&#39;&#39;</span>

		<span class="n">variable_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">variable_array</span><span class="p">)</span>

		<span class="n">sortedVariableArray</span><span class="o">=</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variable_array</span><span class="p">]</span>
<span class="c1">#		reshapeDataParam=#</span>
<span class="c1">#		energyMatrixReshape=numpy.reshape(energyMatrix,reshapeDataParam).T</span>



<span class="c1">#		variable_array=numpy.around(variable_array,decimals=6)</span>


<span class="c1">#		print reshapeDataParam</span>


<span class="c1">#		energyMatrix=numpy.reshape(energyMatrixReshape,len(energyMatrix))</span>
	<span class="c1">#	gg=numpy.array((1,),dtype=numpy.float64)</span>
	<span class="c1">#	gg=numpy.zeros(1, dtype=float, order=&#39;C&#39;)</span>






		<span class="n">gg</span><span class="o">=</span><span class="p">[]</span>
	<span class="c1"># 	for x in range(len(variable_array[0])):</span>
	<span class="c1"># 		gg.append([variable_array[0][x],energyMatrixReshape[x]])</span>
	<span class="c1"># 	energyMatrixReshape=numpy.asarray(gg)</span>

	<span class="c1"># 	print energyMatrixReshape.T</span>
	<span class="c1">#	print point</span>

		<span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>


<span class="c1">#		print energyMatrix</span>


		<span class="k">if</span> <span class="n">variable_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
			<span class="n">point</span><span class="o">.</span><span class="n">T</span>
<span class="c1">#			energyMatrix=numpy.reshape(energyMatrix,(1,len(energyMatrix)))</span>

		<span class="k">if</span> <span class="n">variable_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
			<span class="n">variable_array</span><span class="o">=</span><span class="n">variable_array</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#		print variable_array</span>
<span class="c1">#		print  variable_array.shape</span>

<span class="c1">#		rbfi = scipy.interpolate.Rbf(variable_array,energyMatrix,function=&#39;multiquadric&#39;)</span>
	<span class="c1">#	print rbfi</span>
	<span class="c1">#	print </span>
	<span class="c1">#	grid_z0 = map_coordinates(energyMatrixReshape, [point],order=5)</span>
	<span class="c1">#	print grid_z0</span>
	<span class="c1">#	grid_z0 = (variable_array, energyMatrix,point, method=&#39;linear&#39;)</span>


		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
			<span class="n">method</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span>
                        
		<span class="k">else</span><span class="p">:</span>
			<span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>


                <span class="k">if</span> <span class="n">variable_array</span><span class="o">.</span><span class="n">shape</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">f2</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">variable_array</span><span class="p">,</span><span class="n">solution_array</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                    <span class="n">sol</span> <span class="o">=</span> <span class="n">f2</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">variable_array</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">f2</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">variable_array</span><span class="p">,</span><span class="n">solution_array</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                    <span class="n">sol</span> <span class="o">=</span> <span class="n">f2</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
		    <span class="n">sol</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">variable_array</span><span class="p">,</span> <span class="n">energyMatrix</span><span class="p">,</span><span class="n">point</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>


<span class="c1">#		sol = rbi(point)</span>

		<span class="k">try</span><span class="p">:</span>
                        
			<span class="k">return</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">sol</span>

	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="k">raise</span> <span class="ne">SystemExit</span>

<span class="k">def</span> <span class="nf">__getMatrices</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="c1">#    print &#39;entering __getMatrices&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering __getMatrices&#39;</span><span class="p">)</span>

    <span class="n">totalList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">energyList</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># pulls energy values from the dictionary of dictionaries of calculations and creates a list of them</span>
    <span class="n">orderedMaster</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">orderedMaster</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">energyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;Energy&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">variables</span> <span class="ow">in</span> <span class="n">fitVars</span><span class="p">:</span>
        <span class="n">varValueList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">orderedMaster</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">varValueList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="n">variables</span><span class="p">]))</span>
	<span class="n">totalList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varValueList</span><span class="p">)</span>
        
    
    
    <span class="n">energyMatrix</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">energyList</span><span class="p">)</span>
    

    <span class="n">variableList</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">totalList</span><span class="p">))</span>

<span class="c1">#    print &#39;exiting __getMatrices&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __getMatrices&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">energyMatrix</span><span class="p">,</span><span class="n">variableList</span>


<span class="k">def</span> <span class="nf">__getMin</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">bulk_modulus</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">minimize_var</span><span class="o">=</span><span class="s2">&quot;Energy&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    calculates the minimum energy value from the fit variables you supply. </span>
<span class="sd">    Only picks out the energy values that satisfy the cutoff/kpoint values </span>
<span class="sd">    for one combination of them that you are testing </span>
<span class="sd">    (i.e. would calculate the minimum energy from calculations that satisfy </span>
<span class="sd">    {_AFLOWPI_KPOINTS_ = &#39;4 4 4 1 1 1&#39;, _AFLOWPI_ECUTW_ = 20}  </span>

<span class="sd">    Arguments:</span>
<span class="sd">          calcs (dict): Dictionary of Dictionaries of the calculations.</span>
<span class="sd">    Keyword Arguments</span>
<span class="sd">          fitVars (list): a tuple of the independent variables you want to make the </span>
<span class="sd">                          fit and find the min energy for</span>
<span class="sd">          options (dict): additional options passed to L-BFGS-B minimization </span>
<span class="sd">                          (see scipy documentation for scipy.optimize.minimize </span>
<span class="sd">                          for more details)</span>

<span class="sd">    Returns:</span>
<span class="sd">         minEnergy (float): the minimum energy of the fit</span>
<span class="sd">         outDict (dict): dictionary containing fit information</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">fitFunction</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">*</span><span class="n">p</span><span class="p">):</span>     
	    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>

		    <span class="k">return</span> 
	    <span class="k">try</span><span class="p">:</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>



		<span class="n">f0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">M</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
		<span class="n">D</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
		<span class="n">iu</span> <span class="o">=</span> <span class="n">triu_indices</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
		<span class="n">M</span><span class="p">[</span><span class="n">iu</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">diag_indices</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
		<span class="n">D</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>

		<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="o">-</span><span class="n">D</span> <span class="o">+</span> <span class="n">M</span><span class="o">.</span><span class="n">T</span>
		<span class="n">l</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span>  <span class="n">f0</span><span class="o">+</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">x0</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">z</span><span class="o">-</span><span class="n">x0</span><span class="p">))</span>
		<span class="c1"># print di</span>
		<span class="c1"># print D</span>
		<span class="c1"># print M</span>
		<span class="c1"># print array(l(x))</span>
		<span class="c1"># print f0</span>
		<span class="c1"># print p</span>
		<span class="c1"># print n</span>
		<span class="c1"># print x0</span>
		<span class="c1"># print M</span>
		<span class="c1"># print D</span>
		<span class="c1"># print iu</span>
		<span class="c1"># print M</span>
		<span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
	    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		    <span class="k">return</span> 


    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    generic form of the taylor expansion for n-dim </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">fitForm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">*</span><span class="n">p</span><span class="p">):</span>     
        <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">iu</span> <span class="o">=</span> <span class="n">triu_indices</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[</span><span class="n">iu</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">diag_indices</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">D</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="o">-</span><span class="n">D</span> <span class="o">+</span> <span class="n">M</span><span class="o">.</span><span class="n">T</span>
        <span class="n">l</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span>  <span class="n">f0</span> <span class="o">+</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">x0</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">z</span><span class="o">-</span><span class="n">x0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering __getMin&#39;</span><span class="p">)</span>

    <span class="n">totalList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">energyList</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># pulls energy values from the dictionary of dictionaries of calculations and creates a list of them</span>
    <span class="n">orderedMaster</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">orderedMaster</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">energyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="n">minimize_var</span><span class="p">])</span>
    

<span class="c1">#    for variables in fitVars: #cycling through the independent variables you are fitting with to prep the data for the fit</span>
        
     
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    cycles through all the calculations in your dictionary of dictionaries</span>
<span class="sd">    and checks if the calculation satisfies the cutoff/kpoint combination</span>
<span class="sd">    that you want to find the minimum for. It preps the data for the </span>
<span class="sd">    minimum energy calculation</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="k">for</span> <span class="n">variables</span> <span class="ow">in</span> <span class="n">fitVars</span><span class="p">:</span>
        <span class="n">varValueList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">orderedMaster</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">varValueList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="n">variables</span><span class="p">]))</span>
	<span class="n">totalList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varValueList</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span> 
	    
<span class="c1">#	    totalList,energyList = __cubicInterpolation_onePoint(totalList,energyList,x)</span>
	    <span class="n">variableList</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">totalList</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>


	    <span class="n">energyMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energyList</span><span class="p">)</span>


	    <span class="sd">&#39;&#39;&#39;mask the bad energy values from failed calcs&#39;&#39;&#39;</span>
	    <span class="n">energyMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">energyMatrix</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
	    <span class="c1">#chooses the median value for each of the fitting variables as starting points for the minimization</span>



    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">     fits a curve which is a n-dim second order taylor expansion to the gridded data set</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">variableList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">n</span><span class="o">+</span> <span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> 

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    gets bounds of the data set for the bounded BFGS minimization and then</span>
<span class="sd">    finds the minimum value of the fitted function</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ystart</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variableList</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
    
    <span class="n">fitBounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="o">+</span><span class="mf">0.00000001</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="o">-</span><span class="mf">0.00000001</span><span class="p">])</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variableList</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="n">pop</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">fitForm</span><span class="p">,</span><span class="n">variableList</span><span class="p">,</span><span class="n">energyMatrix</span><span class="p">,</span><span class="n">guess</span><span class="p">,</span><span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
            
	    <span class="k">try</span><span class="p">:</span>
		    <span class="n">pop</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">fitForm</span><span class="p">,</span><span class="n">variableList</span><span class="p">,</span><span class="n">energyMatrix</span><span class="p">,</span><span class="n">guess</span><span class="p">,</span><span class="n">maxfev</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
	    <span class="k">except</span><span class="p">:</span>
		    <span class="k">try</span><span class="p">:</span>
			    <span class="n">pop</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">fitForm</span><span class="p">,</span><span class="n">variableList</span><span class="p">,</span><span class="n">energyMatrix</span><span class="p">,</span><span class="n">guess</span><span class="p">,</span><span class="n">maxfev</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span>
		    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="k">try</span><span class="p">:</span>
	    <span class="n">pop</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span> 
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>



    <span class="k">try</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;minimizing using differential evolution&#39;</span><span class="p">)</span>

        <span class="n">fitMin</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">__cubicInterpolation_onePoint</span><span class="p">,</span><span class="n">ystart</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">variableList</span><span class="p">,</span><span class="n">energyMatrix</span><span class="p">),</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">fitBounds</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s1">&#39;gtol&#39;</span><span class="p">:</span><span class="mf">0.00000001</span><span class="p">,</span><span class="s1">&#39;eps&#39;</span><span class="p">:</span><span class="mf">0.000000001</span><span class="p">},)</span> 
<span class="c1">#</span>

  <span class="c1">#      fitMin = minimize(fitFunction,ystart,args=(pop),method=&#39;L-BFGS-B&#39;,bounds=fitBounds,tol=0.00001,options={&#39;disp&#39;:False})</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span> 
<span class="c1">#            AFLOWpi.run._fancy_error_log(e)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;minimizing using bfgs&#39;</span><span class="p">)</span>
	    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

	    <span class="k">try</span><span class="p">:</span>

<span class="c1">#</span>
                <span class="n">fitMin</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">__cubicInterpolation_onePoint</span><span class="p">,</span><span class="n">ystart</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">variableList</span><span class="p">,</span><span class="n">energyMatrix</span><span class="p">),</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">fitBounds</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">},</span><span class="n">gtol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span> 


	    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span> 
<span class="c1">#		    AFLOWpi.run._fancy_error_log(e)</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fitMin</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">fitFunction</span><span class="p">,</span><span class="n">fitBounds</span><span class="p">,</span><span class="n">popsize</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">pop</span><span class="p">),</span><span class="n">disp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> 	    
                        

		    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
			    <span class="k">try</span><span class="p">:</span>
                                <span class="n">fitMin</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">__cubicInterpolation_onePoint</span><span class="p">,</span><span class="n">fitBounds</span><span class="p">,</span><span class="n">popsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">variableList</span><span class="p">,</span><span class="n">energyMatrix</span><span class="p">),</span><span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="c1">#                                fitMin = scipy.optimize.differential_evolution(__cubicInterpolation_onePoint,fitBounds,popsize=100,args=(variableList,energyMatrix),disp=True,tol=0.00001,maxiter=50) </span>
			    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                <span class="k">pass</span>


    <span class="k">if</span> <span class="n">bulk_modulus</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
	    <span class="k">try</span><span class="p">:</span>
		    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../AFLOWpi/bulk_modulus.dat&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bulk_mod_file</span><span class="p">:</span>
			    <span class="n">bulk_mod_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">repr</span><span class="p">(</span><span class="n">pop</span><span class="p">))</span>
			    
			    <span class="n">bulk_mod_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

	    
	    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		    

<span class="c1">#    print fitMin1</span>
<span class="c1">#    if options!=None:</span>
<span class="c1">#	        fitMin = minimize(fitFunction,ystart,args=(pop),method=&#39;L-BFGS-B&#39;,bounds=fitBounds,options=options,disp=True)</span>
 <span class="c1">#   else:</span>


    <span class="n">minEnergy</span><span class="o">=</span><span class="n">fitMin</span><span class="o">.</span><span class="n">fun</span>

    <span class="n">blankDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">outDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">blankDict</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    puts the results from the fitting and minimization in a dictionary</span>
<span class="sd">    and returns it to be further processed</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __getMin&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitMin</span><span class="o">.</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">outDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">=</span><span class="n">fitMin</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>




    <span class="k">return</span> <span class="n">minEnergy</span><span class="p">,</span><span class="n">outDict</span>



<div class="viewcode-block" id="getMinimization"><a class="viewcode-back" href="../pseudo.html#pseudo.getMinimization">[docs]</a><span class="k">def</span>  <span class="nf">getMinimization</span><span class="p">(</span><span class="n">origCalcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">runlocal</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">minimize_var</span><span class="o">=</span><span class="s2">&quot;Energy&quot;</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">runlocal</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">__getMinimization</span><span class="p">(</span><span class="n">origCalcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="n">fitVars</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span><span class="n">minimize_var</span><span class="o">=</span><span class="n">minimize_var</span><span class="p">)</span>
	<span class="c1">##########################################################################################</span>
	<span class="c1">###NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED ###</span>
	<span class="c1">##########################################################################################</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">         center = AFLOWpi.pseudo.__getCenter(calcs,fitVars=</span><span class="si">%s</span><span class="s1">,options=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">         </span>

<span class="s1">         AFLOWpi.pseudo.plot(resultList,xaxis=&#39;&#39;,xtitle=None,ytitle=None,title=None,rename=None)</span>

<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitVars</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">runAfterAllDone</span><span class="p">(</span><span class="n">origCalcs</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="n">faultTolerant</span><span class="p">)</span>
	
	<span class="c1">##########################################################################################</span>
	<span class="c1">###NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED NOT COMPLETED ###</span>
	<span class="c1">##########################################################################################</span>

</div>
<div class="viewcode-block" id="crawlingMinimization"><a class="viewcode-back" href="../pseudo.html#pseudo.crawlingMinimization">[docs]</a><span class="k">def</span>  <span class="nf">crawlingMinimization</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">initial_variance</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">grid_density</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">final_minimization</span><span class="o">=</span><span class="s1">&#39;relax&#39;</span><span class="p">,):</span>


        <span class="n">constraintString</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
        <span class="k">if</span> <span class="n">constraint</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">constraintString</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">):</span>


                
                    <span class="n">constraintString</span><span class="o">=</span><span class="s1">&#39;(&#39;</span>
                    <span class="n">constraintString</span><span class="o">+=</span><span class="s1">&#39;(&quot;</span><span class="si">%s</span><span class="s1">&quot;,&quot;</span><span class="si">%s</span><span class="s1">&quot;),&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">constraintString</span><span class="o">+=</span><span class="s1">&#39;)&#39;</span>


            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>

                    <span class="k">print</span> <span class="s1">&#39;constraint list not formatted properly. must be in form constraint=((&quot;constraint1&quot;,&quot;parameter_constrained1&quot;),(&quot;constraint2&quot;,&quot;parameter_constrained2&quot;),) ....exiting&#39;</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;constraint list not formatted properly. must be in form constraint=((&quot;constraint1&quot;,&quot;parameter_constrained1&quot;),(&quot;constraint2&quot;,&quot;parameter_constrained2&quot;),) ....exiting&#39;</span><span class="p">)</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">SystemExit</span>

	<span class="n">fitVars</span><span class="o">=</span><span class="bp">None</span>

<span class="c1">#	if final_minimization==None:</span>
<span class="c1">#		final_minimization=&#39;scf&#39;</span>
	<span class="k">if</span> <span class="n">mult_jobs</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
		<span class="n">exit_command</span><span class="o">=</span><span class="s1">&#39;sys.exit(0)&#39;</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">exit_command</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
	<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__splitCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

		<span class="n">execString</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;if oneCalc[&#39;__execCounter__&#39;]&lt;=</span><span class="si">%s</span><span class="s1">:</span>
<span class="s1">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span>
		<span class="n">execString</span><span class="o">+=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">     oneCalc,ID = AFLOWpi.pseudo.__crawlingMinimization(oneCalc,ID,fitVars=</span><span class="si">%s</span><span class="s1">,faultTolerant=</span><span class="si">%s</span><span class="s1">,constraint=</span><span class="si">%s</span><span class="s1">,thresh=</span><span class="si">%s</span><span class="s1">,initial_variance=</span><span class="si">%s</span><span class="s1">,steps=</span><span class="si">%s</span><span class="s1">,mult_jobs=</span><span class="si">%s</span><span class="s1">)</span>

<span class="s1">     import sys</span>
<span class="s1">     </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitVars</span><span class="p">,</span><span class="n">faultTolerant</span><span class="p">,</span><span class="n">constraintString</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">initial_variance</span><span class="p">,</span><span class="n">grid_density</span><span class="p">,</span><span class="n">mult_jobs</span><span class="p">,</span><span class="n">exit_command</span><span class="p">)</span>  

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToBlock</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span> <span class="n">execString</span><span class="p">)</span>
<span class="c1">#		AFLOWpi.prep.__saveOneCalc(oneCalc,ID)</span>
	<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__skeletonRun</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">final_minimization</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;vc-relax&#39;</span><span class="p">,</span><span class="s1">&#39;relax&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">final_minimization</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
		<span class="n">final_minimization</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span>


        <span class="k">if</span> <span class="n">final_minimization</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__skeletonRun</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToAll</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="s1">&#39;RUN&#39;</span><span class="p">,</span><span class="s2">&quot;oneCalc,ID = AFLOWpi.prep.__modifyNamelistPW(oneCalc,ID,&#39;&amp;control&#39;,&#39;calculation&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span><span class="n">final_minimization</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounterBkgrd__&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">calcs</span>




<span class="c1">###############################################################################################################</span>

<span class="c1">###############################################################################################################</span>

<span class="c1">########################################################################################################################################################################################################################################</span>

</div>
<span class="k">def</span>  <span class="nf">__crawlingMinimization</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">initial_variance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span><span class="n">steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

	<span class="sd">&#39;&#39;&#39;this is a check to see if we&#39;re restarting when mult_jobs==True&#39;&#39;&#39;</span>
	<span class="n">checkBool</span><span class="o">=</span><span class="bp">False</span>
	<span class="k">if</span> <span class="s1">&#39;__CRAWL_CHECK__&#39;</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__CRAWL_CHECK__&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ID</span><span class="p">:</span>
			<span class="n">checkBool</span><span class="o">=</span><span class="bp">True</span>


	<span class="n">chain_index</span><span class="o">=</span><span class="mi">1</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">chain_index</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">]</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__passGlobalVar</span><span class="p">(</span><span class="s1">&#39;__TEMP__INDEX__COUNTER__&#39;</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__chain_index__&#39;</span><span class="p">])</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
	
	<span class="n">chain_logname</span><span class="o">=</span><span class="s1">&#39;step_</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">chain_index</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">checkBool</span><span class="p">:</span>
		<span class="n">assocInputVars</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">refFileDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">pass</span>

		<span class="n">constraint_type_list</span><span class="o">=</span><span class="p">[]</span>
		<span class="n">constraint_var_list</span><span class="o">=</span><span class="p">[]</span>
		<span class="k">if</span> <span class="n">constraint</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="sd">&#39;&#39;&#39;if the length of the first entry in constraints isn&#39;t a   &#39;&#39;&#39;</span>
				<span class="sd">&#39;&#39;&#39;[constraint,parameter] combination then put it in an array&#39;&#39;&#39;</span>

				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
					<span class="n">constraint</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">constraint</span><span class="p">),]</span>

				<span class="k">for</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
					<span class="n">constraint_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
					<span class="n">constraint_var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			    <span class="k">print</span> <span class="n">e</span>
			    <span class="n">constraint_type</span><span class="o">=</span><span class="bp">None</span>
			    <span class="n">constraint_var</span> <span class="o">=</span><span class="bp">None</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">constraint_type</span><span class="o">=</span><span class="bp">None</span>
			<span class="n">constraint_var</span> <span class="o">=</span><span class="bp">None</span>


		<span class="n">centValList</span><span class="o">=</span><span class="p">[]</span>
		<span class="n">paramList</span><span class="o">=</span><span class="p">[]</span>
		<span class="k">if</span> <span class="s1">&#39;celldm(1)&#39;</span> <span class="ow">in</span> <span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">paramList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
			<span class="n">centValList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="s1">&#39;celldm(2)&#39;</span> <span class="ow">in</span> <span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">paramList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
			<span class="n">centValList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(2)&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="s1">&#39;celldm(3)&#39;</span> <span class="ow">in</span> <span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">paramList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
			<span class="n">centValList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(3)&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="s1">&#39;celldm(4)&#39;</span> <span class="ow">in</span> <span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">paramList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">)</span>
			<span class="n">centValList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(4)&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="s1">&#39;celldm(5)&#39;</span> <span class="ow">in</span> <span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">paramList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
			<span class="n">centValList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(5)&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="s1">&#39;celldm(6)&#39;</span> <span class="ow">in</span> <span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">paramList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">)</span>
			<span class="n">centValList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refFileDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(6)&#39;</span><span class="p">])</span>



		<span class="n">stepList</span><span class="o">=</span><span class="p">[</span><span class="n">steps</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paramList</span><span class="p">))]</span>
		<span class="n">amountList</span><span class="o">=</span><span class="p">[</span><span class="n">initial_variance</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paramList</span><span class="p">))]</span>



		<span class="n">variedCalcs</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">varyCellParams</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="n">paramList</span><span class="p">,</span><span class="n">amount</span><span class="o">=</span><span class="n">amountList</span><span class="p">,</span><span class="n">steps</span><span class="o">=</span><span class="n">stepList</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span><span class="p">)</span>


		<span class="k">for</span> <span class="n">ID_new</span><span class="p">,</span><span class="n">oneCalc_new</span> <span class="ow">in</span> <span class="n">variedCalcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="n">cdmDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span>
			<span class="n">refDictDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;__refFile__&#39;</span><span class="p">])</span>
			<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">paramList</span><span class="p">:</span>

				<span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;A&#39;</span><span class="p">:</span>
					<span class="n">val</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cdmDict</span><span class="p">[</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">])</span>
					<span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
					<span class="n">refDictDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span>
				<span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cdmDict</span><span class="p">[</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">cdmDict</span><span class="p">[</span><span class="s1">&#39;celldm(2)&#39;</span><span class="p">])</span>
					<span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
					<span class="n">refDictDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(2)&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span>
				<span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cdmDict</span><span class="p">[</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">cdmDict</span><span class="p">[</span><span class="s1">&#39;celldm(3)&#39;</span><span class="p">])</span>
					<span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
					<span class="n">refDictDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(3)&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span>
				<span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cdmDict</span><span class="p">[</span><span class="s1">&#39;celldm(4)&#39;</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
					<span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
					<span class="n">refDictDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(4)&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span>
				<span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;beta&#39;</span><span class="p">:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cdmDict</span><span class="p">[</span><span class="s1">&#39;celldm(5)&#39;</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
					<span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
					<span class="n">refDictDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(5)&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span>
				<span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cdmDict</span><span class="p">[</span><span class="s1">&#39;celldm(6)&#39;</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
					<span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
					<span class="n">refDictDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(6)&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span>



			<span class="n">oneCalc_new</span><span class="p">[</span><span class="s1">&#39;__refFile__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">refDictDict</span><span class="p">)</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc_new</span><span class="p">,</span><span class="n">ID_new</span><span class="p">)</span>


		<span class="n">fitVars</span><span class="o">=</span><span class="p">[]</span>
		<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">paramList</span><span class="p">:</span>
			<span class="n">fitVars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span><span class="p">)</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">updatelogs</span><span class="p">(</span><span class="n">variedCalcs</span><span class="p">,</span><span class="n">logname</span><span class="o">=</span><span class="n">chain_logname</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">constraint</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
				<span class="n">constraintString</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">constraintString</span><span class="o">=</span><span class="s1">&#39;(&#39;</span>
				<span class="k">for</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraint_type_list</span><span class="p">)):</span>
					<span class="n">constraintString</span><span class="o">+=</span><span class="s1">&#39;(&quot;</span><span class="si">%s</span><span class="s1">&quot;,&quot;</span><span class="si">%s</span><span class="s1">&quot;),&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">constraint_type_list</span><span class="p">[</span><span class="n">constraints</span><span class="p">],</span><span class="n">constraint_var_list</span><span class="p">[</span><span class="n">constraints</span><span class="p">])</span>
				<span class="n">constraintString</span><span class="o">+=</span><span class="s1">&#39;)&#39;</span>

		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
			<span class="n">constraintString</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>

		<span class="n">outFile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;.in&#39;</span><span class="p">)</span>
		<span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">         completeBool=AFLOWpi.pseudo.__shiftGrid(calcs,&#39;</span><span class="si">%s</span><span class="s1">&#39;,fitVars=</span><span class="si">%s</span><span class="s1">,options=</span><span class="si">%s</span><span class="s1">,constraint=</span><span class="si">%s</span><span class="s1">,thresh=</span><span class="si">%s</span><span class="s1">,mult_jobs=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">	 if completeBool:</span>
<span class="s1">	    workdir = AFLOWpi.prep.__ConfigSectionMap(&#39;prep&#39;,&#39;workdir&#39;)</span>
<span class="s1">	    mainOneCalc = AFLOWpi.prep.__loadOneCalc(workdir,&#39;</span><span class="si">%s</span><span class="s1">&#39;)</span>
<span class="s1">	    AFLOWpi.run.__submitJob(&#39;</span><span class="si">%s</span><span class="s1">&#39;,mainOneCalc,__submitNodeName__)</span>

<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outFile</span><span class="p">,</span><span class="n">fitVars</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">constraintString</span><span class="p">,</span><span class="n">thresh</span><span class="p">,</span><span class="n">mult_jobs</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>

		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">runAfterAllDone</span><span class="p">(</span><span class="n">variedCalcs</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">faultTolerant</span><span class="o">=</span><span class="n">faultTolerant</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="n">variedCalcs</span><span class="p">)</span>


		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		We don&#39;t need the wfc files or .save dir for the qe calcs so we remove them at the end of each calc.</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToAll</span><span class="p">(</span><span class="n">variedCalcs</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s1">&#39;import shutil&#39;</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToAll</span><span class="p">(</span><span class="n">variedCalcs</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s1">&#39;import os&#39;</span><span class="p">)</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToAll</span><span class="p">(</span><span class="n">variedCalcs</span><span class="p">,</span><span class="s1">&#39;IMPORT&#39;</span><span class="p">,</span><span class="s1">&#39;import glob&#39;</span><span class="p">)</span>
		<span class="n">cleanupString</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;number=1</span>
<span class="s2">while True:</span>
<span class="s2">    try:  </span>
<span class="s2">        wfcFile = os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;_</span><span class="si">%s</span><span class="s2">.wfc</span><span class="si">%d</span><span class="s2">&#39;%(ID,number))     </span>
<span class="s2">        os.remove(wfcFile)</span>
<span class="s2">        number+=1</span>
<span class="s2">    except Exception,e:</span>
<span class="s2">        break</span>
<span class="s2">try:</span>
<span class="s2">    shutil.rmtree(os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;_</span><span class="si">%s</span><span class="s2">.save&#39;%ID))</span>
<span class="s2">except Exception,e:</span>
<span class="s2">    pass</span>
<span class="s2">&quot;&quot;&quot;</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__addToAll</span><span class="p">(</span><span class="n">variedCalcs</span><span class="p">,</span><span class="s1">&#39;CLEANUP&#39;</span><span class="p">,</span><span class="n">cleanupString</span><span class="p">)</span>



	<span class="k">else</span><span class="p">:</span>
		<span class="sd">&#39;&#39;&#39;in the case where mult_jobs==False and we had to restart we don&#39;t want to remake the grid we want to load the old one&#39;&#39;&#39;</span>
		<span class="n">gridConfigFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;GRID_MIN&#39;</span><span class="p">,</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;CONFIG.config&#39;</span><span class="p">)</span>


		<span class="n">variedCalcs</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">loadlogs</span><span class="p">(</span><span class="s1">&#39;GRID_MIN&#39;</span><span class="p">,</span><span class="n">logname</span><span class="o">=</span><span class="n">chain_logname</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="n">gridConfigFile</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;skipped making the calcs&#39;</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;skipped making the calcs&#39;</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;skipped making the calcs&#39;</span><span class="p">)</span>

	<span class="sd">&#39;&#39;&#39;if we are submitting the grid calc jobs separately or one big job&#39;&#39;&#39;</span>
	<span class="k">if</span> <span class="n">mult_jobs</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
		<span class="n">oneJobBool</span><span class="o">=</span><span class="bp">False</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">oneJobBool</span><span class="o">=</span><span class="bp">True</span>
		<span class="k">for</span> <span class="n">ID_new</span><span class="p">,</span><span class="n">oneCalc_new</span> <span class="ow">in</span> <span class="n">variedCalcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">variedCalcs</span><span class="p">[</span><span class="n">ID_new</span><span class="p">][</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">][</span><span class="s1">&#39;walltime&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">5000000000.0</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">variedCalcs</span><span class="p">[</span><span class="n">ID_new</span><span class="p">][</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
                        <span class="n">variedCalcs</span><span class="p">[</span><span class="n">ID_new</span><span class="p">][</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">][</span><span class="s1">&#39;walltime&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">5000000000.0</span>
                    <span class="n">variedCalcs</span><span class="p">[</span><span class="n">ID_new</span><span class="p">][</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">variedCalcs</span><span class="p">[</span><span class="n">ID_new</span><span class="p">],</span><span class="n">ID_new</span><span class="p">)</span>


	<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__CRAWL_CHECK__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ID</span>

<span class="c1">#        AFLOWpi.prep.__saveOneCalc(__main__.oneCalc,ID)</span>
        <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>


	<span class="sd">&#39;&#39;&#39;if we&#39;re almost at the end of the walltime don&#39;t try to submit&#39;&#39;&#39;</span>
<span class="c1">#	walltime,startScript=AFLOWpi.run.__grabWalltime(__main__.oneCalc,__main__.ID)</span>
	<span class="n">walltime</span><span class="p">,</span><span class="n">startScript</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__grabWalltime</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startScript</span><span class="p">)</span><span class="o">&gt;</span><span class="n">walltime</span><span class="o">*</span><span class="mf">0.90</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">mult_jobs</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
<span class="c1">#			AFLOWpi.run.__submitJob(__main__.ID,__main__.oneCalc,__main__.__submitNodeName__,sajOverride=True)</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span><span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>			

	<span class="sd">&#39;&#39;&#39;submit in reverse order because calcs later in the orderedDict are more likely&#39;&#39;&#39;</span>
	<span class="sd">&#39;&#39;&#39;to be larger cells than those at the beginning&#39;&#39;&#39;</span>		
	<span class="k">try</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">ID_new</span><span class="p">,</span><span class="n">oneCalc_new</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">variedCalcs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sub_node_name</span> <span class="o">=</span> <span class="n">__main__</span><span class="o">.</span><span class="n">__submitNodeName__</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sub_node_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">ID_new</span><span class="p">,</span><span class="n">oneCalc_new</span><span class="p">,</span><span class="n">sub_node_name</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="n">oneJobBool</span><span class="p">)</span>
        
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;prev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">sub_node_name</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>




	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	exit the script if we&#39;re running mult_jobs==True and let the separate jobs restart the </span>
<span class="sd">	script that is running __crawling minimization once they&#39;re all done. it will skip over </span>
<span class="sd">	__crawlingMinimization when it restarts.</span>
<span class="sd">	&#39;&#39;&#39;</span>


	<span class="k">return</span> <span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span>


<span class="k">def</span>  <span class="nf">__getCenter</span><span class="p">(</span><span class="n">origCalcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">return_energy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
	<span class="n">minDict</span><span class="o">=</span><span class="n">__getMinimization</span><span class="p">(</span><span class="n">origCalcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="n">fitVars</span><span class="p">,</span><span class="n">return_energy</span><span class="o">=</span><span class="n">return_energy</span><span class="p">)</span> 
	<span class="n">returnDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">fitVars</span><span class="p">:</span>
		<span class="n">returnDict</span><span class="p">[</span><span class="n">items</span><span class="p">]</span><span class="o">=</span><span class="n">minDict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">items</span><span class="p">]</span>
	<span class="k">if</span> <span class="n">return_energy</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">minEnergy</span> <span class="o">=</span> <span class="n">minDict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Energy&#39;</span><span class="p">]</span>

			<span class="k">return</span> <span class="n">returnDict</span><span class="p">,</span><span class="n">minEnergy</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">returnDict</span> 
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">returnDict</span> 

<span class="kn">import</span> <span class="nn">__main__</span>
<span class="k">def</span> <span class="nf">__medE</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
	<span class="n">calcs</span> <span class="o">=</span> <span class="n">__grabEnergyOut</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>
	<span class="n">energyList</span><span class="o">=</span><span class="p">[]</span>
	<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		<span class="n">energyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;Energy&#39;</span><span class="p">]))</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">energyList</span><span class="p">)[(</span><span class="nb">len</span><span class="p">(</span><span class="n">energyList</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">sorted</span><span class="p">(</span><span class="n">energyList</span><span class="p">)[(</span><span class="nb">len</span><span class="p">(</span><span class="n">energyList</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span><span class="o">/</span><span class="mi">2</span>



<span class="k">def</span> <span class="nf">__genetic</span><span class="p">(</span><span class="n">calcs</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">medE</span> <span class="o">=</span> <span class="n">__medE</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

		<span class="n">survivors</span><span class="o">=</span><span class="p">{}</span>
		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;Energy&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="n">medE</span><span class="p">:</span>
				<span class="n">survivors</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span>

		

		<span class="n">next_gen</span><span class="o">=</span><span class="p">{}</span>
		<span class="n">survivorsList</span> <span class="o">=</span> <span class="n">survivors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">survivorsList</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
			<span class="n">choice1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">survivorsList</span><span class="p">)</span>
			<span class="n">survivorsList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">choice1</span><span class="p">)</span>
			<span class="n">choice2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">survivorsList</span><span class="p">)</span>
			<span class="n">survivorsList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">choice2</span><span class="p">)</span>
			<span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">choice1</span><span class="p">,</span><span class="n">choice2</span><span class="p">])</span>

 <span class="c1">#		for ID,oneCalc in survivors.iteritems()</span>
				
<span class="c1">#			if </span>
			
          <span class="c1"># 	inputDict = AFLOWpi.retr.__splitInput(oneCalc[&#39;_AFLOWPI_INPUT_&#39;])[&#39;&amp;system&#39;]</span>
		<span class="c1"># 	list1 = [{param:val} for param,val in inputDict.iteritems() if re.match(r&#39;celldm&#39;,param)]</span>
		<span class="c1"># 	resultDict={}</span>
		<span class="c1"># 	for item in list1:</span>
		<span class="c1"># 		resultDict.update(item)</span>


			
		<span class="c1"># stepList=[steps for x in range(len(paramList))]</span>
		<span class="c1"># amountList=[amount for x in range(len(paramList))]</span>
		
 		<span class="c1"># variedCalcs=AFLOWpi.prep.varyCellParams(oneCalc,ID,param=paramList,amount=amountList,steps=stepList)</span>
		<span class="c1"># pass</span>
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


		




<span class="k">def</span> <span class="nf">__shiftGrid</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">outFile</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">constraint</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">mult_jobs</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;sleep for anywhere from 0 to 10 seconds&#39;&#39;&#39;</span>
	<span class="n">time</span><span class="o">.</span><span class="n">sleep</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
	<span class="sd">&#39;&#39;&#39;if file semaphore exists, another process is working on submitting the grid so exit&#39;&#39;&#39;</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;entering __shiftGrid&#39;</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">),</span><span class="s1">&#39;GRID.SEMAPHORE&#39;</span><span class="p">)):</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;found GRID.SEMAPHORE. exiting __shiftGrid&#39;</span><span class="p">)</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	
	<span class="k">else</span><span class="p">:</span>
		<span class="sd">&#39;&#39;&#39;if the file semaphore doesn&#39;t exist, place one and then, go ahead and shift grid&#39;&#39;&#39;</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">),</span><span class="s1">&#39;GRID.SEMAPHORE&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">semaphoreFileObj</span><span class="p">:</span>
			<span class="n">semaphoreFileObj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TRUE&#39;</span><span class="p">)</span>


	<span class="k">try</span><span class="p">:</span>

		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		in case we&#39;re 90% of the way through the walltime we don&#39;t want to risk the job possibly </span>
<span class="sd">		getting killed half while it&#39;s submitting the jobs for the next iteration because it could </span>
<span class="sd">		lead to double submission and a and a whole world of hurt</span>
<span class="sd">		&#39;&#39;&#39;</span>



<span class="c1">#		calcs[__main__.ID][&#39;__walltime_dict__&#39;][__main__.ID][&#39;walltime&#39;]</span>
		


		<span class="k">if</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
			<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">			in case we&#39;re 90% of the way through the walltime we don&#39;t want to risk the job possibly </span>
<span class="sd">			getting killed half while it&#39;s submitting the jobs for the next iteration because it could </span>
<span class="sd">			lead to double submission and a and a whole world of hurt</span>
<span class="sd">			&#39;&#39;&#39;</span>



	<span class="c1">#		calcs[__main__.ID][&#39;__walltime_dict__&#39;][__main__.ID][&#39;walltime&#39;]</span>
			
			<span class="k">if</span> <span class="n">mult_jobs</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
				<span class="n">walltime</span><span class="p">,</span><span class="n">startScript</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__grabWalltime</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__main__</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startScript</span><span class="p">)</span><span class="o">&gt;</span><span class="n">walltime</span><span class="o">*</span><span class="mf">0.90</span><span class="p">:</span>
					<span class="sd">&#39;&#39;&#39;in this case just resubmit this job&#39;&#39;&#39;</span>
					<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span><span class="n">__main__</span><span class="o">.</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">__main__</span><span class="o">.</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
					<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">),</span><span class="s1">&#39;GRID.SEMAPHORE&#39;</span><span class="p">))</span>		     
					<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>			

					<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;quitting1&#39;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>

				<span class="sd">&#39;&#39;&#39;in this case we need to find our way back to the calc that spawned the original </span>
<span class="sd">				grid and restart that. it&#39;ll start back up and on it&#39;s first job it&#39;ll start up </span>
<span class="sd">				where this script left off but will have the time to do it.&#39;&#39;&#39;</span>

                                
				<span class="n">main_ID</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outFile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">workdir</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__ConfigSectionMap</span><span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span><span class="s1">&#39;workdir&#39;</span><span class="p">)</span>
				<span class="n">mainOneCalc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__loadOneCalc</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">main_ID</span><span class="p">)</span>
				<span class="n">startScript</span><span class="o">=</span><span class="n">mainOneCalc</span><span class="p">[</span><span class="s1">&#39;__walltime_dict__&#39;</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
				<span class="n">walltime</span><span class="p">,</span><span class="n">startScript</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__grabWalltime</span><span class="p">(</span><span class="n">mainOneCalc</span><span class="p">,</span><span class="n">main_ID</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startScript</span><span class="p">)</span><span class="o">&gt;</span><span class="n">walltime</span><span class="o">*</span><span class="mf">0.90</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;quitting2&#39;</span><span class="p">)</span>
					<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">main_ID</span><span class="p">,</span><span class="n">mainOneCalc</span><span class="p">,</span><span class="n">__main__</span><span class="o">.</span><span class="n">__submitNodeName__</span><span class="p">,</span><span class="n">sajOverride</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

					<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">),</span><span class="s1">&#39;GRID.SEMAPHORE&#39;</span><span class="p">))</span>	      
					<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>			


	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


	<span class="k">try</span><span class="p">:</span>





		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span>  <span class="nb">type</span><span class="p">(</span><span class="nb">list</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]))</span> <span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="n">fitVars</span><span class="p">)</span> <span class="ow">or</span>  <span class="nb">type</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]))</span> <span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="n">fitVars</span><span class="p">):</span>
				<span class="n">fitVars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">fitVars</span><span class="p">,)</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="n">calcs</span> <span class="o">=</span> <span class="n">__grabEnergyOut</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

		<span class="n">constraint_type_list</span><span class="o">=</span><span class="p">[]</span>
		<span class="n">constraint_var_list</span><span class="o">=</span><span class="p">[]</span>
		<span class="k">if</span> <span class="n">constraint</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="sd">&#39;&#39;&#39;if the length of the first entry in constraints isn&#39;t a   &#39;&#39;&#39;</span>
				<span class="sd">&#39;&#39;&#39;[constraint,parameter] combination then put it in an array&#39;&#39;&#39;</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
					<span class="n">constraint</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">constraint</span><span class="p">),]</span>
				<span class="k">for</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
					<span class="n">constraint_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
					<span class="k">if</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;ALPHA&#39;</span><span class="p">,</span><span class="s1">&#39;BETA&#39;</span><span class="p">,</span><span class="s1">&#39;GAMMA&#39;</span><span class="p">]:</span>
						<span class="n">constraint_var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_PARAM_&#39;</span><span class="o">+</span><span class="n">constraints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;constraint: </span><span class="si">%s</span><span class="s1"> not valid. not including in minimization&#39;</span> <span class="o">%</span> <span class="n">constraints</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			    <span class="k">print</span> <span class="n">e</span>
			    <span class="n">constraint_type</span><span class="o">=</span><span class="bp">None</span>
			    <span class="n">constraint_var</span> <span class="o">=</span><span class="bp">None</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">constraint_type</span><span class="o">=</span><span class="bp">None</span>
			<span class="n">constraint_var</span> <span class="o">=</span><span class="bp">None</span>

		<span class="sd">&#39;&#39;&#39;remove the constrained variables from the minimization&#39;&#39;&#39;</span>
		<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">constraint_var_list</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">fitVars</span><span class="p">:</span>
				<span class="n">fitVars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

		

		<span class="n">minEVal</span><span class="p">,</span><span class="n">minEnergy</span> <span class="o">=</span> <span class="n">__getCenter</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="n">fitVars</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span><span class="n">return_energy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="k">if</span> <span class="s1">&#39;__minEnergy__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__minEnergy__&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">minEnergy</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__minEnergy__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minEnergy</span><span class="p">)</span>

		<span class="n">energy</span><span class="p">,</span><span class="n">varMatrix</span> <span class="o">=</span>  <span class="n">__getMatrices</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="n">fitVars</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>		

		<span class="n">gridDistanceDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>

		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitVars</span><span class="p">)):</span>
			<span class="n">gridDistanceDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">entry</span><span class="p">]]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">varMatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">entry</span><span class="p">]</span><span class="o">-</span><span class="n">varMatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">entry</span><span class="p">])</span>

		<span class="n">medianDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">minDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">maxDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>

		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">calcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="n">mainGridDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">]))</span>
			<span class="k">if</span> <span class="s1">&#39;__gridMin_iteration__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__gridMin_iteration__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
				<span class="n">iteration</span><span class="o">=</span><span class="mi">1</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__gridMin_iteration__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__gridMin_iteration__&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
				<span class="n">iteration</span><span class="o">=</span><span class="n">calcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__gridMin_iteration__&#39;</span><span class="p">]</span>

			<span class="n">allVars</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">extractvars</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__refFile__&#39;</span><span class="p">])</span>
			<span class="n">refFile</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;__refFile__&#39;</span><span class="p">]</span>
			<span class="k">break</span>
		<span class="sd">&#39;&#39;&#39;get min and max bounds for each variable in our combination space&#39;&#39;&#39;</span>
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitVars</span><span class="p">)):</span>
			<span class="sd">&#39;&#39;&#39;for average the median is not in the center of the grid so we use mean&#39;&#39;&#39;</span>
			<span class="n">medianDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">varMatrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
			<span class="n">minDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">varMatrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
			<span class="n">maxDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">varMatrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
			
		<span class="sd">&#39;&#39;&#39;check to see if value of minimum is within 1% of the bounds of each variable in our combination space&#39;&#39;&#39;</span>
	
		<span class="n">close2MinList</span><span class="o">=</span><span class="p">[]</span>
		<span class="n">close2MaxList</span><span class="o">=</span><span class="p">[]</span>

		<span class="k">for</span> <span class="n">fitVar</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">minEVal</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> 
			<span class="sd">&#39;&#39;&#39;if we found the min to be within 2.5% an edge we need to reposition&#39;&#39;&#39;</span>
			<span class="n">gFuncMin</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">medianDict</span><span class="p">[</span><span class="n">fitVar</span><span class="p">]</span><span class="o">-</span><span class="n">minDict</span><span class="p">[</span><span class="n">fitVar</span><span class="p">])</span>
			<span class="n">gFuncMax</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">medianDict</span><span class="p">[</span><span class="n">fitVar</span><span class="p">]</span><span class="o">-</span><span class="n">maxDict</span><span class="p">[</span><span class="n">fitVar</span><span class="p">])</span>
			<span class="n">close2MinList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">minEVal</span><span class="p">[</span><span class="n">fitVar</span><span class="p">])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">minDict</span><span class="p">[</span><span class="n">fitVar</span><span class="p">]))</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="o">*</span><span class="n">gFuncMin</span><span class="p">)</span>
			<span class="n">close2MaxList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">minEVal</span><span class="p">[</span><span class="n">fitVar</span><span class="p">])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">maxDict</span><span class="p">[</span><span class="n">fitVar</span><span class="p">]))</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="o">*</span><span class="n">gFuncMax</span><span class="p">)</span>


		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		now that we know if we&#39;re close edges we can shift the grid of test points centered around 1.95x</span>
<span class="sd">		the distance from the starting center point of the grid to where the minimization got stuck at</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="n">shiftCenter</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;close2MinList </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">close2MinList</span><span class="p">)</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;close2MaxList </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">close2MaxList</span><span class="p">)</span>


		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitVars</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">close2MinList</span><span class="p">[</span><span class="n">item</span><span class="p">]:</span>
				<span class="sd">&#39;&#39;&#39;if it&#39;s at the min bound shift should make the center go down&#39;&#39;&#39;</span>
				<span class="n">shiftCenter</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">medianDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">-</span><span class="n">minDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]])</span>
			<span class="k">elif</span> <span class="n">close2MaxList</span><span class="p">[</span><span class="n">item</span><span class="p">]:</span>
				<span class="sd">&#39;&#39;&#39;if it&#39;s at the max bound shift should make the center go up&#39;&#39;&#39;</span>
				<span class="n">shiftCenter</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span> <span class="o">=</span>  <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">medianDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">-</span><span class="n">maxDict</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">shiftCenter</span><span class="p">[</span><span class="n">fitVars</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span><span class="o">=</span><span class="mi">0</span>


		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		identify the variables assiciated with the fitVars by looking at the reference file</span>
<span class="sd">		(this isn&#39;t the best way to do this but works for the case of celldm)</span>
<span class="sd">		if needed it&#39;ll be made more robust in the future</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="n">assocInputVars</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">refFileDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">refFile</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">pass</span>
		
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">refFileDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">fitVars</span><span class="p">:</span>
					<span class="n">assocInputVars</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>

		<span class="sd">&#39;&#39;&#39;now we can generate the shifted set from the old set&#39;&#39;&#39;</span>
		<span class="n">shiftedCalcs</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

		<span class="sd">&#39;&#39;&#39;check to see if our old min is close to the new min&#39;&#39;&#39;</span>
		<span class="n">quit_bool</span><span class="o">=</span><span class="bp">True</span>
		<span class="n">centerShiftDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fitVars</span><span class="p">:</span>
			<span class="n">centerShift</span><span class="o">=</span><span class="n">medianDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">-</span><span class="n">minEVal</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
			<span class="n">centerShiftDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="n">centerShift</span>
			<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">centerShift</span><span class="p">)</span><span class="o">&gt;</span><span class="n">thresh</span><span class="p">:</span>
				<span class="n">quit_bool</span><span class="o">=</span><span class="bp">False</span>
		<span class="sd">&#39;&#39;&#39;write out the hessian for bulk modulus if we&#39;re done minimizing&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="n">quit_bool</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">__getMin</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="n">fitVars</span><span class="p">,</span><span class="n">bulk_modulus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
				

		<span class="n">shiftType</span><span class="o">=</span><span class="s1">&#39;shift&#39;</span>
		<span class="k">if</span> <span class="bp">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">close2MaxList</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">close2MinList</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">quit_bool</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
				<span class="n">shiftType</span><span class="o">=</span><span class="s1">&#39;shrink&#39;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">shiftType</span><span class="o">=</span><span class="s1">&#39;finish&#39;</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">),</span><span class="s1">&#39;GridEnergyLog.log&#39;</span><span class="p">),</span><span class="s1">&#39;a+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{:=^31}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{:=^31}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;iteration </span><span class="si">%02d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">iteration</span><span class="p">))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{:=^31}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="c1">#			myfile.write(&#39;----------------------------------\n&#39;)</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{:&lt;30}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Status |   </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">shiftType</span><span class="o">.</span><span class="n">upper</span><span class="p">())))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Energy |&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{: 19.12f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">minEnergy</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">print</span> <span class="n">minEnergy</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; Ry|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="c1">#			myfile.write(&#39;\n&#39;)</span>


			<span class="n">paramsPrint</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">minEVal</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;--------&#39;</span><span class="p">)</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-----------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">paramsPrint</span><span class="p">))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Param  | &#39;</span><span class="p">)</span>

			<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paramsPrint</span><span class="p">)):</span>
				<span class="k">if</span> <span class="n">paramsPrint</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">]:</span>
					<span class="n">paramsPrint</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39; (Bohr)&#39;</span>

				<span class="k">if</span> <span class="n">paramsPrint</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ALPHA&#39;</span><span class="p">,</span><span class="s1">&#39;BETA&#39;</span><span class="p">,</span><span class="s1">&#39;GAMMA&#39;</span><span class="p">]:</span>
					<span class="n">paramsPrint</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39; (Deg.)&#39;</span>
				<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{0:*^18}   |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramsPrint</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;--------&#39;</span><span class="p">)</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-----------------------&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">paramsPrint</span><span class="p">))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Median |  &#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">minEVal</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
				<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; {: 16.11f}   |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">medianDict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Min Val|  &#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">minEVal</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
				<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; {: 16.11f}   |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">minEVal</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Delta  |  &#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">minEVal</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
				<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; {: 16.11f}   |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">centerShiftDict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)))</span>
			<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>



		<span class="n">calcs</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">grabEnergyOut</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>

		<span class="n">fileNameStr</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mainGridDir</span><span class="p">,</span><span class="s1">&#39;energyLandscape_iteration_</span><span class="si">%02d</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileNameStr</span><span class="p">):</span>
			<span class="n">filenameStr</span><span class="o">=</span><span class="s1">&#39;./energyLandscape_iteration_</span><span class="si">%02d</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="n">iteration</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitVars</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
				<span class="n">xTitle</span><span class="o">=</span><span class="n">fitVars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
				<span class="n">xTitle</span><span class="o">+=</span><span class="s1">&#39; (Bohr)&#39;</span>
				<span class="n">yTitle</span><span class="o">=</span><span class="n">fitVars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
				<span class="n">yTitle</span><span class="o">+=</span><span class="s1">&#39; (Bohr)&#39;</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">interpolatePlot</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fitVars</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xaxisTitle</span><span class="o">=</span><span class="n">xTitle</span><span class="p">,</span><span class="n">yaxisTitle</span><span class="o">=</span><span class="n">yTitle</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileNameStr</span><span class="p">,</span><span class="n">circle_min</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">text_min</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">vhline_min</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">delta_min</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>		

				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">interpolatePlot1D</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xaxisTitle</span><span class="o">=</span><span class="n">xTitle</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="s1">&#39;X_&#39;</span><span class="o">+</span><span class="n">fileNameStr</span><span class="p">,</span><span class="n">circle_min</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">interpolatePlot1D</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xaxisTitle</span><span class="o">=</span><span class="n">xTitle</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="s1">&#39;Y_&#39;</span><span class="o">+</span><span class="n">fileNameStr</span><span class="p">,</span><span class="n">circle_min</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitVars</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
				<span class="n">xTitle</span><span class="o">=</span><span class="n">fitVars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">interpolatePlot1D</span><span class="p">(</span><span class="n">calcs</span><span class="p">,</span><span class="n">fitVars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xaxisTitle</span><span class="o">=</span><span class="n">xTitle</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileNameStr</span><span class="p">,</span><span class="n">circle_min</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 

		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

		<span class="sd">&#39;&#39;&#39;if we find the min in the bounds this is how much we&#39;ll shrink the grid by&#39;&#39;&#39;</span>
		<span class="n">shrinkVarDict</span><span class="o">=</span><span class="p">{}</span>
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fitVars</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">shrinkVarDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">centerShiftDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">medianDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">-</span><span class="n">maxDict</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
				<span class="k">if</span> <span class="n">shrinkVarDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.75</span><span class="p">:</span>
					<span class="sd">&#39;&#39;&#39;put a limit so if shift is very small</span>
<span class="sd">					we don&#39;t scale down 1000x or something&#39;&#39;&#39;</span>
					<span class="n">shrinkVarDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="mf">0.75</span>

			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
				<span class="n">shrinkVarDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="mf">0.49</span>


                <span class="n">ibrav</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">shiftedCalcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="n">inputDict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
                        <span class="n">ibrav</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;ibrav&#39;</span><span class="p">])</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                    <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

		<span class="sd">&#39;&#39;&#39;if the old min is close to the new min we won&#39;t resubmit and instead   &#39;&#39;&#39;</span>
		<span class="sd">&#39;&#39;&#39;and instead we will look copy the results back to the parent directory &#39;&#39;&#39;</span>


		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">shiftedCalcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fitVars</span><span class="p">:</span>

				<span class="sd">&#39;&#39;&#39;if it&#39;s not close to any bounds we want to generate </span>
<span class="sd">				an input file with the optimal coordinates&#39;&#39;&#39;</span>



				<span class="k">if</span> <span class="bp">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">close2MaxList</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">close2MinList</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;minimum found within grid bounds. shifting </span><span class="si">%s</span><span class="s1"> by </span><span class="si">%s</span><span class="s1"> and shrinking grid&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">centerShiftDict</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="sd">&#39;&#39;&#39;if we don&#39;t find it in the bounds we&#39;ve already shifted so stay with the</span>
<span class="sd">					   same size grid just shifted&#39;&#39;&#39;</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;minimum not found within grid bounds. shifting </span><span class="si">%s</span><span class="s1"> by </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">centerShiftDict</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
					
				<span class="sd">&#39;&#39;&#39;just set all of the calcs to the min (we won&#39;t end up saving</span>
<span class="sd">				   these inputs. because of quit_bool the calcs will make an output</span>
<span class="sd">				   file in the parent directory with the params of the first calc in the</span>
<span class="sd">				   loop (which will then have the min params in it)&#39;&#39;&#39;</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">quit_bool</span><span class="p">:</span>
					<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">					shrink grid by shifting all points closer to new center scale the</span>
<span class="sd">					shrinking by how much we&#39;ve shifted compared to grid width</span>
<span class="sd">					&#39;&#39;&#39;</span>
					<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="n">item</span><span class="p">]</span><span class="o">-</span><span class="n">centerShiftDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
					<span class="n">shrinkPrint</span><span class="o">=</span><span class="mf">1.0</span><span class="o">-</span><span class="n">shrinkVarDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;shrink factor for </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">shrinkPrint</span><span class="p">))</span>

					<span class="n">centDist</span><span class="o">=</span><span class="p">(</span><span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="n">item</span><span class="p">]</span><span class="o">-</span><span class="n">minEVal</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
					<span class="n">scaledCentDist</span><span class="o">=</span><span class="n">centDist</span><span class="o">*</span><span class="n">shrinkVarDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;before: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="n">item</span><span class="p">])</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;center: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">minEVal</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
					<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="n">item</span><span class="p">]</span><span class="o">-=</span><span class="n">scaledCentDist</span>
					<span class="sd">&#39;&#39;&#39;round the numbers to 9 decimal places so we can reform for plotting&#39;&#39;&#39;</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;after: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="n">item</span><span class="p">])</span>


				<span class="k">else</span><span class="p">:</span>
					<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="n">minEVal</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>				       

						

			<span class="k">if</span> <span class="n">constraint</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraint_type_list</span><span class="p">)):</span>
					<span class="k">if</span> <span class="n">constraint_type_list</span><span class="p">[</span><span class="n">constr</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;volume&#39;</span><span class="p">:</span>
						<span class="sd">&quot;&quot;&quot;NEED TO BE GENERALIZED NEED TO BE GENERALIZED NEED TO BE GENERALIZED&quot;&quot;&quot;</span>
						<span class="n">vol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">getCellVolume</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">ID</span><span class="p">))</span>

						<span class="sd">&quot;&quot;&quot;NEED TO BE GENERALIZED NEED TO BE GENERALIZED NEED TO BE GENERALIZED&quot;&quot;&quot;</span>
						<span class="n">constr_var</span> <span class="o">=</span> <span class="n">constraint_var_list</span><span class="p">[</span><span class="n">constr</span><span class="p">]</span>

						<span class="n">volDiv</span><span class="o">=</span><span class="mi">1</span>
						<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">]:</span>
							<span class="k">try</span><span class="p">:</span>
								<span class="n">param_name</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span>
								<span class="k">if</span> <span class="n">param_name</span><span class="o">!=</span><span class="n">constr_var</span><span class="p">:</span>
									<span class="n">volDiv</span><span class="o">*=</span><span class="n">oneCalc</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> 
							<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
								<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

						<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ALPHA&#39;</span><span class="p">,</span><span class="s1">&#39;BETA&#39;</span><span class="p">,</span><span class="s1">&#39;GAMMA&#39;</span><span class="p">,]:</span>
							<span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">oneCalc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
								<span class="n">param_name</span> <span class="o">=</span> <span class="s1">&#39;_AFLOWPI_PARAM_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="o">%</span><span class="n">param</span>
								<span class="k">if</span> <span class="n">param_name</span><span class="o">!=</span><span class="n">constr_var</span><span class="p">:</span>
									<span class="n">temp_angle_param</span><span class="o">=</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> 
									<span class="n">volDiv</span><span class="o">*=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">temp_angle_param</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">))</span>
						<span class="n">remainder</span><span class="o">=</span><span class="n">vol</span><span class="o">/</span><span class="n">volDiv</span>

						<span class="k">if</span> <span class="n">constr_var</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_ALPHA_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_BETA_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_GAMMA_&#39;</span><span class="p">,]:</span>
							<span class="n">oneCalc</span><span class="p">[</span><span class="n">constr_var</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">180.0</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">constr_var</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_A_&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_B&#39;</span><span class="p">,</span><span class="s1">&#39;_AFLOWPI_PARAM_C_&#39;</span><span class="p">,]:</span>
							<span class="n">oneCalc</span><span class="p">[</span><span class="n">constr_var</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span><span class="o">=</span><span class="n">remainder</span>


		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">shiftedCalcs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

			
			<span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
			<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;control&#39;</span><span class="p">][</span><span class="s1">&#39;restart_mode&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&#39;from_scratch&#39;&quot;</span>
						

			<span class="sd">&#39;&#39;&#39;convert A,B,C,alpha,beta,gamma to celldm&#39;&#39;&#39;</span>
			<span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

					<span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">:</span>
						<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(1)&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_A_&#39;</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="s1">&#39;celldm(2)&#39;</span><span class="p">:</span>
						<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(2)&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_B_&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_A_&#39;</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="s1">&#39;celldm(3)&#39;</span><span class="p">:</span>
						<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(3)&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_C_&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_A_&#39;</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="s1">&#39;celldm(4)&#39;</span><span class="p">:</span>
						<span class="n">newcelldm</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_ALPHA_&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
						<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(4)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcelldm</span>

					<span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="s1">&#39;celldm(5)&#39;</span><span class="p">:</span>
						<span class="n">newcelldm</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_BETA_&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
						<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(5)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcelldm</span>

					<span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="s1">&#39;celldm(6)&#39;</span><span class="p">:</span>
						<span class="n">newcelldm</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_PARAM_GAMMA_&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
						<span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="s1">&#39;celldm(6)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcelldm</span>

			<span class="k">if</span> <span class="n">quit_bool</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span><span class="c1"># in close2MaxList or True in close2MinList:</span>
				
				<span class="n">newInputStr</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
				<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newInputStr</span>


				<span class="sd">&#39;&#39;&#39;set the status of this calc set to not started or completed&#39;&#39;&#39;</span>
				<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__status__&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
				<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s2">&quot;Start&quot;</span><span class="p">]</span><span class="o">=</span><span class="bp">False</span>
				<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s2">&quot;Complete&quot;</span><span class="p">]</span><span class="o">=</span><span class="bp">False</span>
				<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s2">&quot;Restart&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
				<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__status__&#39;</span><span class="p">][</span><span class="s2">&quot;Error&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;None&quot;</span>
				<span class="sd">&#39;&#39;&#39;set the execCounter to 0 so when these calcs get resubmitted they&#39;ll run fresh&#39;&#39;&#39;</span>
				<span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">][</span><span class="s1">&#39;__execCounter__&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
<span class="c1">#				for var in range(len(fitVars)):</span>
<span class="c1">#					shiftedCalcs[ID][fitVars[var]]=float(shiftedCalcs[ID][fitVars[var]])+float(shiftCenter[fitVars[var]])</span>
				<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">shiftedCalcs</span><span class="p">[</span><span class="n">ID</span><span class="p">],</span><span class="n">ID</span><span class="p">)</span>



				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">ID</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outInfileObj</span><span class="p">:</span>
					<span class="n">outInfileObj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newInputStr</span><span class="p">)</span>
				<span class="sd">&#39;&#39;&#39;since we shifted the vals in the input file we have to make sure we shift the vals in oneCalc&#39;&#39;&#39;</span>
				

				
			<span class="k">else</span><span class="p">:</span>
				<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">				if we found the minimum was not on the border of the grid we save</span>
<span class="sd">				a copy of the input with the minimized parameters in the AFLOWpi folder</span>
<span class="sd">				and then quit because we don&#39;t have to submit anymore jobs.</span>
<span class="sd">				&#39;&#39;&#39;</span>

<span class="c1">#				cellParamMatrix = AFLOWpi.retr.getCellMatrixFromInput(newInputStr)</span>
				<span class="sd">&#39;&#39;&#39;we need alat to scale matrix down like it is in espresso output&#39;&#39;&#39;</span>
<span class="c1">#				alat = float(inputDict[&#39;&amp;system&#39;][&#39;celldm(1)&#39;])</span>
<span class="c1">#				cellParamMatrix/=alat</span>
<span class="c1">#				matrixString = AFLOWpi.retr.__cellMatrixToString(cellParamMatrix)</span>
<span class="c1">#				inputDict[&#39;CELL_PARAMETERS&#39;]=OrderedDict()</span>
<span class="c1">#				inputDict[&#39;CELL_PARAMETERS&#39;][&#39;__content__&#39;]=matrixString</span>
				<span class="sd">&#39;&#39;&#39;format like espresso output&#39;&#39;&#39;</span>
<span class="c1">#				inputDict[&#39;CELL_PARAMETERS&#39;][&#39;__modifier__&#39;]=&#39;(alat = %f)&#39; % alat</span>
<span class="c1">#				atomPOS = inputDict[&#39;ATOMIC_POSITIONS&#39;][&#39;__content__&#39;]</span>
<span class="c1">#				detachedPos,flags=AFLOWpi.retr.detachPosFlags(atomPOS)</span>
<span class="c1">#				inputDict[&#39;ATOMIC_POSITIONS&#39;][&#39;__content__&#39;]=detachedPos</span>
				<span class="n">newInputStr</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">inputDict</span><span class="p">)</span>
                                <span class="n">inputDict</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">newInputStr</span><span class="p">)</span>
                                
                                <span class="n">outFile_split</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">outFile</span><span class="p">))</span>
                                <span class="n">dest_ID</span><span class="o">=</span><span class="n">outFile_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">dest_calc</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__loadOneCalc</span><span class="p">(</span><span class="n">outFile_split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">outFile_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

                                <span class="n">dest_calc_dict</span><span class="o">=</span><span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__splitInput</span><span class="p">(</span><span class="n">dest_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inputDict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                                    <span class="n">dest_calc_dict</span><span class="p">[</span><span class="s1">&#39;&amp;system&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>

				<span class="n">newInputStr</span> <span class="o">=</span> <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">retr</span><span class="o">.</span><span class="n">__joinInput</span><span class="p">(</span><span class="n">dest_calc_dict</span><span class="p">)</span>
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outInfileObj</span><span class="p">:</span>
					<span class="n">outInfileObj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newInputStr</span><span class="p">)</span>
                                

                                <span class="n">dest_calc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_INPUT_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newInputStr</span>
                                <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__saveOneCalc</span><span class="p">(</span><span class="n">dest_calc</span><span class="p">,</span><span class="n">dest_ID</span><span class="p">)</span>

				<span class="sd">&#39;&#39;&#39;remove file semaphore&#39;&#39;&#39;</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">),</span><span class="s1">&#39;GRID.SEMAPHORE&#39;</span><span class="p">))</span>
				<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
					<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

				
				<span class="k">if</span> <span class="n">mult_jobs</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
					<span class="k">return</span> <span class="bp">True</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">oldConfig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">)),</span><span class="s1">&#39;AFLOWpi&#39;</span><span class="p">,</span><span class="s1">&#39;CONFIG.config&#39;</span><span class="p">)</span>
					<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">prep</span><span class="o">.</span><span class="n">__forceGlobalConfigFile</span><span class="p">(</span><span class="n">oldConfig</span><span class="p">)</span>
					<span class="k">return</span> <span class="bp">False</span>

				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __shiftGrid&#39;</span><span class="p">)</span>
				


		<span class="sd">&#39;&#39;&#39;if we didn&#39;t find the minimum we submit the shifted grid to run&#39;&#39;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sub_node_name</span> <span class="o">=</span> <span class="n">__main__</span><span class="o">.</span><span class="n">__submitNodeName__</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">sub_node_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
		<span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__submitNodeName__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_node_name</span>

		<span class="sd">&#39;&#39;&#39;remove file semaphore&#39;&#39;&#39;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">),</span><span class="s1">&#39;GRID.SEMAPHORE&#39;</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

		<span class="sd">&#39;&#39;&#39;if we are submitting the grid calc jobs separately or one big job&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="n">mult_jobs</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
                    <span class="n">oneJobBool</span><span class="o">=</span><span class="bp">False</span>
		<span class="k">else</span><span class="p">:</span>
                    <span class="n">oneJobBool</span><span class="o">=</span><span class="bp">True</span>

		
		
		<span class="sd">&#39;&#39;&#39;clear out all wfc and .save scratch fromt he dirs&#39;&#39;&#39;</span>
		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">shiftedCalcs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
			<span class="n">number</span><span class="o">=</span><span class="mi">1</span>
			<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>  
					<span class="n">wfcFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.wfc</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">number</span><span class="p">))</span>     
					<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">wfcFile</span><span class="p">)</span>
					<span class="n">number</span><span class="o">+=</span><span class="mi">1</span>
				<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
					<span class="k">break</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_FOLDER_&#39;</span><span class="p">],</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.save&#39;</span><span class="o">%</span><span class="n">ID</span><span class="p">))</span>
			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
				<span class="k">pass</span>


		<span class="sd">&#39;&#39;&#39;submit in reverse order because calcs later in the orderedDict are more likely&#39;&#39;&#39;</span>
		<span class="sd">&#39;&#39;&#39;to be larger cells than those at the beginning&#39;&#39;&#39;</span>

		<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">shiftedCalcs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">__submitJob</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span><span class="p">,</span><span class="n">sub_node_name</span><span class="p">,</span><span class="n">forceOneJob</span><span class="o">=</span><span class="n">oneJobBool</span><span class="p">)</span>
			<span class="c1"># try:</span>
			<span class="c1"># 	fileList = glob.glob(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;]+&#39;./_*wfc*&#39;)</span>

			<span class="c1"># 	logging.debug(&#39;FILELIST %s&#39; %fileList)</span>
			<span class="c1"># 	for fileName in fileList:</span>
			<span class="c1"># 		try:</span>
			<span class="c1"># 			os.system(&#39;rm  %s&#39; %fileName )</span>


			<span class="c1"># 		except Exception,e:</span>
			<span class="c1"># 			AFLOWpi.run._fancy_error_log(e)</span>

			<span class="c1"># 	shutil.rmtree(os.path.join(oneCalc[&#39;_AFLOWPI_FOLDER_&#39;],&#39;_%s.save&#39;%ID))</span>

			<span class="c1"># except Exception,e:</span>
			<span class="c1"># 	AFLOWpi.run._fancy_error_log(e)</span>

		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;exiting __shiftGrid&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">False</span>



	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outFile</span><span class="p">),</span><span class="s1">&#39;GRID.SEMAPHORE&#39;</span><span class="p">))</span>
			<span class="k">raise</span> <span class="ne">SystemExit</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
			<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
			<span class="k">raise</span> <span class="ne">SystemExit</span>

		


<span class="k">def</span>  <span class="nf">__getMinimization</span><span class="p">(</span><span class="n">origCalcs</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">return_energy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">minimize_var</span><span class="o">=</span><span class="s2">&quot;Energy&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Looks through the dictionary of dictionaries that you supply it and finds the minimum energy</span>
<span class="sd">    for the different cutoff/kpoint choices. outputs a list of dictionaries with the information</span>
<span class="sd">    about the cutoffs and the value of the variables that gives you a minimum energy.</span>

<span class="sd">    Arguments:</span>
<span class="sd">          origCalcs (list): a list of Dictionary of Dictionaries of the calculations.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          fitVars (list): tuple of variables that you want to minimize energy with respect to.</span>
<span class="sd">          options (dict): additional options passed to L-BFGS-B minimization </span>
<span class="sd">                          (see scipy documentation for scipy.optimize.minimize for more details)</span>
<span class="sd">          return_energy (bool): If true add the min energy to the resultList list for each</span>
<span class="sd">          minimize_var (str): which key to minimize on in oneCalc</span>

<span class="sd">    Returns:</span>
<span class="sd">          resultList (list): list if minumum energies and the parameters of the set that they </span>
<span class="sd">                             correspond to.</span>
<span class="sd">                         </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
	    <span class="n">key</span> <span class="o">=</span> <span class="n">__getCutOffs</span><span class="p">(</span><span class="n">origCalcs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
	    <span class="n">key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">manyCalcs</span><span class="o">=</span><span class="n">__splitCalcs</span><span class="p">(</span><span class="n">origCalcs</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>

<span class="c1">#    print &quot;Entering getMinimization&quot;</span>
    <span class="k">if</span> <span class="n">fitVars</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;ERROR: You need to specify variables for the fit and minimization&#39;</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ERROR: You need to specify variables for the fit and minimization&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">resultList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">calcs</span> <span class="ow">in</span> <span class="n">manyCalcs</span><span class="p">:</span>
<span class="c1">#        key = __getCutOffs(calcs)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        actually grabs your energy from each of the calculations</span>
<span class="sd">        and puts it into a dictionary of dictionaries containing </span>
<span class="sd">        all the parameters we will need to calculate the minimum</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">energyDict</span> <span class="o">=</span> <span class="n">__grabEnergyOut</span><span class="p">(</span><span class="n">calcs</span><span class="p">)</span>


	<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">energyDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
		<span class="n">sampleDict</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
		<span class="k">break</span>
        <span class="n">resultDict</span><span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>       

	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	checks to see if you are scaling ecutrho to ecutwfc via the &#39;_AFLOWPI_DUAL_&#39; variable</span>
<span class="sd">	&#39;&#39;&#39;</span>

	<span class="k">for</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">cutoff</span><span class="o">==</span><span class="s1">&#39;_AFLOWPI_ECUTR_&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sampleDict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">):</span>
				<span class="n">resultDict</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sampleDict</span><span class="p">[</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">resultDict</span><span class="p">[</span><span class="n">cutoff</span><span class="p">]</span><span class="o">=</span><span class="n">sampleDict</span><span class="p">[</span><span class="n">cutoff</span><span class="p">]</span>

	<span class="n">energyMatrix</span><span class="p">,</span><span class="n">varMatrices</span> <span class="o">=</span> <span class="n">__getMatrices</span><span class="p">(</span><span class="n">energyDict</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="n">fitVars</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">minEnergy</span><span class="p">,</span><span class="n">minValue</span> <span class="o">=</span> <span class="n">__getMin</span><span class="p">(</span><span class="n">energyDict</span><span class="p">,</span><span class="n">fitVars</span><span class="o">=</span><span class="n">fitVars</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span><span class="n">minimize_var</span><span class="o">=</span><span class="n">minimize_var</span><span class="p">)</span>
		<span class="n">minValue</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">resultDict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="o">+</span> <span class="n">minValue</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
		
		<span class="k">if</span> <span class="n">return_energy</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
			<span class="n">minValue</span><span class="p">[</span><span class="s1">&#39;Energy&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">minEnergy</span>
		<span class="n">resultList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minValue</span><span class="p">)</span> 
	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="n">AFLOWpi</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">_fancy_error_log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="k">pass</span>

    
<span class="c1">#    print &quot;Exiting getMinimization&quot;</span>
    <span class="k">return</span> <span class="n">resultList</span>
            

<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>

<span class="k">def</span> <span class="nf">__plotOne</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span><span class="n">labs</span><span class="p">,</span><span class="n">fig</span><span class="p">,</span><span class="n">entry</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">xaxis</span><span class="p">,</span><span class="n">pltTitle</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">entryNum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">maxs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">mins</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	takes in a list of dictionaries of dictionaries of calculations and generates</span>
<span class="sd">	a plot with the x axis being some value in the list &#39;key&#39; and splits the calculations</span>
<span class="sd">	and plots them with each plot being a unique combination of the items in key that are not	</span>
<span class="sd">&#39;xaxis&#39;</span>
<span class="sd">	Arguments:</span>
<span class="sd">	      entry (list): list of dictionaries of dictionaries of calculations</span>
<span class="sd">	      key (list): a list of cutoff variables used in the calculations</span>
<span class="sd">   	      xaxis (str): the cutoff that you choose to be the x axis in your plots</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">	      plotTitle -- title of the plots (default: None)</span>
<span class="sd">	&#39;&#39;&#39;</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	takes a dictionary which is called renamed whose keys are the current variable names </span>
<span class="sd">	and the values are what you want to replace them with. this allows to customize axis </span>
<span class="sd">	labels on the plot</span>
<span class="sd">	&quot;&quot;&quot;</span>
	
	<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;PSEUDOTEST&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">entryNum</span><span class="p">)</span>
<span class="c1">#	for cutoff in range(len(key)):</span>
<span class="c1">#		if key[cutoff]==&#39;_AFLOWPI_KPOINTS_&#39;:</span>
<span class="c1">#			filename+=&#39;_%s&#39; % (&#39;-&#39;.join(entry[0][key[cutoff]].split()[:3]))</span>
<span class="c1">#		else:</span>
<span class="c1">#			filename+=&#39;_%s&#39; % str(entry[0][key[cutoff]])</span>
	<span class="n">lineName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
	<span class="k">for</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">lineName</span><span class="o">+=</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">cutoff</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cutoff</span><span class="p">])</span>
<span class="c1">#	print lineName</span>

	<span class="k">if</span> <span class="n">pltTitle</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
		<span class="n">pltTitle</span><span class="o">=</span><span class="n">filename</span>
	
	<span class="k">if</span> <span class="n">rename</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">oneCalc</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
			<span class="n">entryCopy</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">oneCalc</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">ID</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">entryCopy</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">oneCalc</span><span class="p">[</span><span class="n">rename</span><span class="p">[</span><span class="n">ID</span><span class="p">]]</span><span class="o">=</span><span class="n">value</span>
					<span class="k">del</span> <span class="n">oneCalc</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				
				<span class="n">key</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">=</span><span class="n">rename</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="n">ID</span><span class="p">]]</span>
				
		<span class="k">if</span> <span class="n">xaxis</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">xaxis</span><span class="o">=</span><span class="n">rename</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span>
				
		
        <span class="k">for</span> <span class="n">oneSet</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
		<span class="n">fitVarList</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">oneSet</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">xaxis</span><span class="p">:</span>
					<span class="n">fitVarList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        
	
                
        <span class="n">color_cycle</span><span class="o">=</span><span class="p">[</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,]</span>
	<span class="n">minMaxList</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitVarList</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>  
		  <span class="n">minMaxList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">fitVarList</span><span class="p">[</span><span class="n">var</span><span class="p">]])</span>

	<span class="n">maxY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">minMaxList</span><span class="p">)</span>
	<span class="n">minY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minMaxList</span><span class="p">)</span>
	<span class="n">rangeY</span><span class="o">=</span><span class="n">maxY</span><span class="o">-</span><span class="n">minY</span>

	<span class="n">maxY</span><span class="o">+=</span><span class="mf">1.1</span><span class="o">*</span><span class="n">rangeY</span>
	<span class="n">minY</span><span class="o">-=</span><span class="mf">1.1</span><span class="o">*</span><span class="n">rangeY</span>


        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitVarList</span><span class="p">)):</span>

            <span class="n">varYaxis</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">varXaxis</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>  
                <span class="n">varXaxis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]))</span>
                <span class="n">varYaxis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">fitVarList</span><span class="p">[</span><span class="n">var</span><span class="p">]])</span>

	    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitVarList</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">var</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
 
	    <span class="n">lns</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">varXaxis</span><span class="p">,</span><span class="n">varYaxis</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color_cycle</span><span class="p">[</span><span class="n">entryNum</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">color_cycle</span><span class="p">)],</span><span class="n">label</span><span class="o">=</span><span class="n">lineName</span><span class="p">)</span>
	    <span class="k">if</span> <span class="n">var</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
		    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">r&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pltTitle</span><span class="p">)</span>

            <span class="n">rangeY</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">maxs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">-</span><span class="n">mins</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">rangeY</span> <span class="o">&lt;</span> <span class="mf">0.50</span><span class="p">:</span>
                <span class="n">rangeY</span><span class="o">=</span><span class="mf">0.1</span>
            <span class="k">if</span> <span class="n">maxs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">maxs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">-=</span><span class="n">rangeY</span><span class="o">*-</span><span class="mf">0.49</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">-=</span><span class="n">rangeY</span><span class="o">*-</span><span class="mf">0.49</span>
            
            <span class="k">if</span> <span class="n">mins</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">mins</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">-=</span><span class="n">rangeY</span><span class="o">*-</span><span class="mf">0.49</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mins</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">-=</span><span class="n">rangeY</span><span class="o">*</span><span class="mf">0.49</span>
            

	    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">mins</span><span class="p">[</span><span class="n">var</span><span class="p">],</span><span class="n">maxs</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
	    <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lns</span><span class="p">)</span>
	    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">fitVarList</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>                
	    <span class="k">if</span> <span class="n">var</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">fitVarList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
		    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>		

<span class="c1">#	    labs = [l.get_label() for l in lns]</span>
	    <span class="n">labs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineName</span><span class="p">)</span>
<span class="c1">#	    print plots</span>
	    <span class="k">if</span> <span class="n">var</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
		    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
	
	<span class="n">boxColors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;darkkhaki&#39;</span><span class="p">,</span><span class="s1">&#39;royalblue&#39;</span><span class="p">]</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="n">key</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
		<span class="k">pass</span>

       
	<span class="n">resDir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
<span class="c1">#	if not os.path.exists(resDir):</span>
<span class="c1">#		os.mkdir(resDir)</span>
	
<span class="c1">#	plt.savefig(os.path.join(resDir,&#39;%s.pdf&#39; % filename),bbox_inches=&#39;tight&#39;)</span>
	<span class="k">return</span> <span class="n">labs</span><span class="p">,</span><span class="n">plots</span>
	    
<div class="viewcode-block" id="plot"><a class="viewcode-back" href="../pseudo.html#pseudo.plot">[docs]</a><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">resultList</span><span class="p">,</span><span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">xtitle</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ytitle</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    takes in a list of dictionaries of dictionaries of calculations and generates</span>
<span class="sd">    a plot with the x axis being some value in the list &#39;key&#39; and splits the calculations</span>
<span class="sd">    and plots them with each plot being a unique combination of the items in key that are not</span>
<span class="sd">    &#39;xaxis&#39;</span>

<span class="sd">    Arguments:</span>
<span class="sd">          resultList (list): list of dictionaries of dictionaries of calculations</span>
<span class="sd">          xaxis (str): the keyword in oneCalc that you choose to be the x axis in your plots</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">          xtitle (str): title of the x axis of the plot (default: None)</span>
<span class="sd">          ytitle (str): title of the y axis of the plot (default: None)</span>
<span class="sd">          plotTitle (str): title of the plots (default: None)</span>
<span class="sd">          rename (dict): a mapping of the names of the keywords of whose</span>
<span class="sd">                         values used to generate the plot to some other name.</span>
<span class="sd">                         ex. {&#39; _AFLOWPI_ECUTW_&#39;:&#39;wavefunction cutoff&#39;}</span>
<span class="sd">          file_name (str): use this instead of &quot;PT_RESULTS.pdf&quot; as filename of plot</span>

<span class="sd">    Returns:</span>
<span class="sd">          None</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="k">print</span> <span class="s2">&quot;Entering generatePlot&quot;</span>
    <span class="n">resultListDict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="p">[</span><span class="n">resultListDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span><span class="n">resultList</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resultList</span><span class="p">))]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">__getCutOffs</span><span class="p">(</span><span class="n">resultListDict</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">resultList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">):</span>
	    <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_AFLOWPI_DUAL_&#39;</span><span class="p">)</span>
    
    <span class="n">value</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">splittingForPlot</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">if</span> <span class="n">entry</span> <span class="o">!=</span> <span class="n">xaxis</span><span class="p">])</span>    
    
    <span class="n">splitResults</span> <span class="o">=</span>  <span class="n">__splitCalcs</span><span class="p">(</span><span class="n">resultListDict</span><span class="p">,</span><span class="n">splitVars</span><span class="o">=</span><span class="n">splittingForPlot</span><span class="p">)</span>
<span class="c1">#    print splittingForPlot</span>
<span class="c1">#    print splittingForPlot</span>
<span class="c1">#    print splittingForPlot</span>
    <span class="n">calcsFix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    converts the dictionary of dictionaries back into a list of dictionaries</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">splitResults</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">xaxis</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">xaxis</span><span class="p">])</span>

        <span class="n">calcsFix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    plots the list of dictionaries that have been split on the cutoffs</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">entryNum</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
    <span class="n">labs</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">plots</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">color_cycle</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span>

    <span class="n">lim_dict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">calcsFix</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="n">xaxis</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">splittingForPlot</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lim_dict</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">lim_dict</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">max_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">min_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">lim_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        
        <span class="n">max_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">min_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">calcsFix</span><span class="p">:</span>

        <span class="n">entrySorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">cutoff</span><span class="p">]</span> <span class="k">for</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span>


<span class="c1">#        if title==None:</span>

        <span class="n">labs</span><span class="p">,</span><span class="n">plots</span> <span class="o">=</span> <span class="n">__plotOne</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span><span class="n">labs</span><span class="p">,</span><span class="n">fig</span><span class="p">,</span><span class="n">entrySorted</span><span class="p">,</span><span class="n">splittingForPlot</span><span class="p">,</span><span class="n">xaxis</span><span class="p">,</span><span class="n">pltTitle</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="n">rename</span><span class="p">,</span><span class="n">entryNum</span><span class="o">=</span><span class="n">entryNum</span><span class="p">,</span><span class="n">maxs</span><span class="o">=</span><span class="n">max_list</span><span class="p">,</span><span class="n">mins</span><span class="o">=</span><span class="n">min_list</span><span class="p">)</span>

        
<span class="c1">#	print labs</span>
<span class="c1">#	plt.figtext(0.10, 0.98-0.035*entryNum, labs[entryNum], </span>
<span class="c1">#		    backgroundcolor=color_cycle[((entryNum+1)%len(color_cycle))-1], color=&#39;black&#39;, weight=&#39;roman&#39;,</span>
<span class="c1">#		    size=&#39;large&#39;)</span>
        <span class="n">entryNum</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">file_name</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;PT_Results&#39;</span>
    
    <span class="n">resDir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resDir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">),</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    
    <span class="k">print</span> <span class="s2">&quot;Exiting generatePlot&quot;</span>
</pre></div></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Andrew Supka.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>